CREATE PROCEDURE "informix".admsp_diver_consul(
parm_tipo smallint,
parm_subtipo smallint,
parm_letras char(3),
parm_num integer,
parm_axo smallint)
returning  integer,		-- id_convenio
	char(50),		-- nombre
	char(70),		-- calle,exterior e interior
	char(10),		-- inciso
	money(10,2),	-- cantidad total
	money(10,2),	-- pago inicial
	money(10,2),	-- pago parcial
	money(10,2),	-- pago final
	smallint,		-- total parcial
	smallint,		-- parc. restantes
	smallint,		-- parc a pagar
	date,		-- fecha inicio
	char(60),		-- desc. tipo
	char(60),		-- desc. subtipo
	smallint,		-- estatus
	char(60),		-- mensaje
	char(30),		-- referencia
	char(250),	-- anuncios
	char(250),	-- Observaciones
	date;		-- fecha vencimiento convenio
define v_tipo smallint;
define v_subtipo smallint;
define v_id_conv_resto integer;
define v_nombre char(50);
define v_calle char(50);
define v_num_exterior integer;
define v_num_interior integer;
define v_inciso char(20);
define v_cantidad_total money(10,2);
define v_cantidad_inicio money(10,2);
define v_pago_parcial money(10,2);
define v_pago_final money(10,2);
define v_fecha_inicio date;
define v_totparc smallint;
define v_restan smallint;
define v_papagar smallint;
define v_domicilio char(70);
define v_estatus smallint;
define v_mensaje char(60);
define v_vig char(1);
define v_desc_tipo char(60);
define v_desc_stipo char(60);
define v_referencia char(30);
define v_anuncios char(250);
define v_observ char(250);
define v_mod smallint;
define v_ref char(30);
define v_add char(20);
define v_fecha_venc date;
let v_referencia='';
let v_observ='';
let v_anuncios='';
let v_desc_tipo='';
let v_desc_stipo='';
let v_estatus=0; 
let v_mensaje='PUEDE COBRARSE';
let v_domicilio='';
let v_papagar=0;
let v_restan=0;
let v_id_conv_resto=0;
let v_nombre='';
let v_inciso='';
let v_cantidad_total=0;
let v_cantidad_inicio=0;
let v_pago_parcial=0;
let v_pago_final=0;
let v_totparc=0;
let v_fecha_inicio=null;
let v_fecha_venc=null;
if not exists(select * from ta_17_conv_diverso where tipo=parm_tipo and subtipo=parm_subtipo and letras_exp=parm_letras
            and numero_exp=parm_num and axo_exp=parm_axo) then
   let v_estatus=3;
   let v_mensaje='NO EXISTE CONVENIO';
else
foreach
select a.tipo,a.subtipo,b.id_conv_resto,b.nombre,b.calle,b.num_exterior,b.num_interior,b.inciso,b.cantidad_total,
b.cantidad_inicio,b.pago_parcial,b.pago_final,b.fecha_inicio,(b.total_pagos+1),b.vigencia,c.descripcion,d.desc_subtipo,b.fecha_venc into v_tipo,v_subtipo,v_id_conv_resto,v_nombre,
v_calle,v_num_exterior,v_num_interior,v_inciso,v_cantidad_total,v_cantidad_inicio,v_pago_parcial,v_pago_final,v_fecha_inicio,v_totparc,v_vig,v_desc_tipo,v_desc_stipo,v_fecha_venc
from ta_17_conv_diverso a, ta_17_conv_d_resto b, ta_17_tipos c,ta_17_subtipo_conv d
where a.tipo=parm_tipo  and a.subtipo=parm_subtipo and letras_exp=parm_letras
and numero_exp=parm_num  and axo_exp=parm_axo
and b.tipo=a.tipo
and b.id_conv_diver=a.id_conv_diver
and c.tipo=a.tipo
and d.tipo=a.tipo
and d.subtipo=a.subtipo
group by a.tipo,a.subtipo,b.id_conv_resto,b.nombre,b.calle,b.num_exterior,b.num_interior,b.inciso,b.cantidad_total,
b.cantidad_inicio,b.pago_parcial,b.pago_final,b.fecha_inicio,14,b.vigencia,c.descripcion,d.desc_subtipo,b.fecha_venc
if exists(select a.id_conv_resto,a.cantidad_total,sum(b.importe) 
from ta_17_conv_d_resto a,ta_17_adeudos_div b
where a.id_conv_resto=v_id_conv_resto and a.vigencia='A' and clave_pago='P'
and b.id_conv_resto=a.id_conv_resto
group by a.id_conv_resto,a.cantidad_total
having sum(b.importe)=a.cantidad_total) then
   let v_estatus=1;
   let v_mensaje='CONVENIO SIN ADEUDO, VERIFICAR VIGENCIA';
else
if (v_tipo=2) or (v_tipo>=4) then
   let v_estatus=1;
   let v_mensaje='NO COBRAR SOLO LICENCIAS Y/O PREDIAL';
else
if (v_tipo=3) and  (v_subtipo=3) then
   let v_estatus=1;
   let v_mensaje='NO COBRAR SOLO LICENCIAS Y/O PREDIAL';
else
if v_vig='B' then
   let v_estatus=1;
   let v_mensaje='CONVENIO DE BAJA';
else
if v_vig='P' then
   let v_estatus=2;
   let v_mensaje='CONVENIO PAGADO';
else
   if v_num_interior>0 then
      let v_domicilio=trim(v_calle)||' EXT. '||v_num_exterior||' INT. '||v_num_interior;
   else
      let v_domicilio=trim(v_calle)||' EXT. '||v_num_exterior;
   end if;
   foreach
   select min(pago_parcial) into v_papagar
   from ta_17_adeudos_div where id_conv_resto=v_id_conv_resto and clave_pago is null
   end foreach;
   let v_restan=v_totparc-v_papagar;
end if;
end if;
end if;
end if;
end if;
end foreach;
foreach
   select a.modulo,a.referencia,(b.axo_desde||'-'||b.mes_desde||' HASTA '||b.axo_hasta||'-'||b.mes_hasta) into v_mod,v_ref,v_add 
       from ta_17_referencia a, ta_17_adeudos_div b
       where a.id_conv_resto=v_id_conv_resto and b.id_conv_resto=a.id_conv_resto and b.pago_parcial=v_papagar
       order by a.modulo,a.referencia 
   if v_mod=5 then
      let v_referencia=v_ref;
      let v_anuncios=v_add;
   else
   if v_mod=9 then
      let v_referencia=v_ref;
   else
      let v_anuncios=(trim(v_anuncios)||trim(v_ref)||",");
   end if;
   end if;
end foreach;
if v_tipo=3 then
   let v_anuncios=substr(v_anuncios, 1, length(v_anuncios)-1); 
end if;
end if;
return v_id_conv_resto,v_nombre,v_domicilio,v_inciso,v_cantidad_total,v_cantidad_inicio,v_pago_parcial,v_pago_final,
v_totparc,v_restan,v_papagar,v_fecha_inicio,v_desc_tipo,v_desc_stipo,v_estatus,v_mensaje,v_referencia,v_anuncios,v_observ,v_fecha_venc;
end procedure;

CREATE PROCEDURE "informix".admsp_diver_deuda(
parm_id_convenio smallint,
parm_apagar smallint)
returning  	smallint,		-- tipo
	smallint,		-- subtipo
	smallint,		-- parcialidad
	money(10,2),	-- importe parcial
	money(10,2),	-- importe recargos (parcialidad vencida)
	integer,		-- cuenta de recargos (parcialidad vencida)
	money(10,2),	-- importe de intereses
	integer,		-- cuenta de intereses
	money(10,2),	-- importe impuesto
	integer,		-- cuenta de impuesto
	date;		-- fecha vencimiento de parcialidad	
define v_tipo smallint;
define v_subtipo smallint;
define v_parcial smallint;
define v_impparc money(10,2);
define v_imprecparc money(10,2);
define v_ctarecparc integer;
define v_impinteres money(10,2);
define v_ctainteres integer;
define v_impuesto money(10,2);
define v_ctaimpuesto integer;
define v_fecha_venc date;
define v_impdesg money(10,2);
define v_ctadesg integer;
define v_cveparc char(1);
define v_imppag money(10,2);
define v_sdoinsoluto money(10,2);
define v_cantidad_total money(10,2);
define v_alo smallint;
define v_mes smallint;
define v_porc decimal(5,2);
define v_porcrec decimal(6,3);
define  v_rubro integer;
let v_rubro=0;
let v_ctarecparc=0;
let v_imprecparc=0;
let v_impinteres=0;
let v_ctainteres=0;
let v_porc=0;
foreach
select b.tipo,b.subtipo,c.pago_parcial,cve_parcialidad,c.importe,c.fecha_venc,d.importe,d.cuenta_apl,a.cantidad_total into
v_tipo,v_subtipo,v_parcial,v_cveparc,v_impparc,v_fecha_venc,v_impdesg,v_ctadesg,v_cantidad_total
from ta_17_conv_d_resto a,ta_17_conv_diverso b,ta_17_adeudos_div c,ta_17_desg_parcial d
where a.id_conv_resto=parm_id_convenio
and b.tipo=a.tipo
and b.id_conv_diver=a.id_conv_diver
and c.id_conv_resto=a.id_conv_resto
and c.pago_parcial=parm_apagar
and c.clave_pago is null
and d.id_adeudo=c.id_adeudo
if v_cveparc='I' then
   let v_impinteres=0;
   let v_ctainteres=0;
else
  foreach
  select sum(importe) into v_imppag
  from ta_17_adeudos_div
  where id_conv_resto=parm_id_convenio
  and pago_parcial<parm_apagar
  end foreach;
  let v_sdoinsoluto=v_cantidad_total-v_imppag;
  if  year(v_fecha_venc)=year(today) then
      let v_alo=year(today);
      if  month(v_fecha_venc)>=month(today) then
          let v_mes=month(today);
      else
          let v_mes=month(v_fecha_venc);
      end if;
  else
      let v_alo=year(v_fecha_venc);
      let v_mes=month(v_fecha_venc);
  end if;
  foreach
  select porcentaje into v_porc from ta_12_intereses where axo=v_alo and mes=v_mes
  end foreach;
  let v_impinteres=(v_sdoinsoluto*v_porc)/100;
  if v_impinteres > 0 then
     let v_impinteres=trunc(v_impinteres*100)/100;
  end if;
  let v_ctainteres=46579;
-- cambio de cuenta 30/05/2008
--  let v_ctainteres=23415;
end if;
if today > v_fecha_venc then
   if  day(today)>day(v_fecha_venc) then
       foreach
       select sum(porcentaje_parcial) into v_porcrec from ta_13_recargosrcm
               where ( (axo>year(v_fecha_venc)  or (mes>=month(v_fecha_venc)  and axo =year(v_fecha_venc))) and
               (axo<year(today)  or (mes<=month(today) and axo =year(today))) )
       end foreach;
   else
       foreach
       select sum(porcentaje_parcial) into v_porcrec from ta_13_recargosrcm
               where ( (axo>year(v_fecha_venc)  or (mes>=month(v_fecha_venc)  and axo =year(v_fecha_venc))) and
               (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) )
       end foreach;
   end if;   
   let v_imprecparc=((v_impparc+v_impinteres)*v_porcrec)/100;
   if v_imprecparc>0 then
      let v_imprecparc=trunc(v_imprecparc*100)/100;
      let v_ctarecparc=46201;
   end if;
end if;

---  para predial
if  v_tipo=1 then
    if  v_subtipo=1 then
        let v_ctadesg=100100000+v_ctadesg;
    else
        let v_ctadesg=100200000+v_ctadesg;
    end if;
end if;

--- para licencias
if  v_tipo=3 then
    foreach
    select rubro into v_rubro from ta_17_referencia where id_conv_resto=parm_id_convenio
    end foreach
    let v_ctadesg=(v_rubro*100000)+v_ctadesg;
end if;
return  v_tipo,v_subtipo,v_parcial,v_impparc,v_imprecparc,v_ctarecparc,v_impinteres,v_ctainteres,v_impdesg,v_ctadesg,v_fecha_venc
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".admsp_diver_pago(
parm_id_convenio 		integer,
parm_fecha_pago 		date,
parm_id_rec 		smallint,
parm_caja 		char(2),
parm_operacion 		integer,
parm_parcialidad 		smallint,
parm_totparc 		smallint,
parm_impparcial 		money(10,2),
parm_imprecparc 		money(10,2),
parm_impinteres 		money(10,2),
parm_id_usuario 		char(10),
parm_movimiento 		char(1),
parm_cveadmin		integer)

returning  			integer,    --  id pago 
			smallint;	-- estatus parametro de salida 

define idpago		integer;
define estatus 		smallint;
define v_cve_venc 		smallint;

let estatus=0;
let idpago=0;

if parm_imprecparc=0 then
   let v_cve_venc=1;
else
   let v_cve_venc=2;
end if;

if parm_movimiento='P' then
   begin
      on exception
           let estatus=1;
      end exception;

           --falta agregar los intereses y cveadmin, cuando se altere la tabla de pagos
           -- inserta pago en tabla de convenios
           insert into ta_17_conv_pagos values (0,parm_id_convenio,parm_fecha_pago,parm_id_rec,parm_caja,parm_operacion,parm_parcialidad,parm_totparc,
				       parm_impparcial,parm_imprecparc,v_cve_venc,0,0,335,current); 
           let idpago=dbinfo("sqlca.sqlerrd1");

           -- afecta como pagado el adeudo
           update ta_17_adeudos_div set clave_pago="P" where id_conv_resto=parm_id_convenio and pago_parcial=parm_parcialidad;

           -- inserta pago en tabla de admin
           insert into pagos_admin values(parm_id_convenio,parm_parcialidad,parm_totparc,parm_impparcial,null,parm_imprecparc,parm_impinteres,
                                                                                 parm_cveadmin,idpago,parm_fecha_pago,parm_id_rec,parm_caja,parm_operacion,"V",18,parm_id_usuario);

           -- si es ultima parcialidad afecta como pagado el convenio en convenios diversos 
           if   parm_parcialidad=parm_totparc then
	update ta_17_conv_d_resto set vigencia="P",id_usuario=335,fecha_actual=current where id_conv_resto=parm_id_convenio;
	--update convenios set vigencia="P" where id_conv_diver=parm_id_convenio;
           end if;
   end;
end if;

if parm_movimiento='C' then
   begin
      on exception
           let estatus=1;
      end exception;

           let idpago=2;  -- significa que todo fue pagado correctamente
           -- borra el pago en convenios
           delete from ta_17_conv_pagos where fecha_pago=parm_fecha_pago and oficina_pago=parm_id_rec and caja_pago=parm_caja and operacion_pago=parm_operacion and 				                                                                       id_conv_resto=parm_id_convenio;

           -- afecta el adeudo como vigente
           update ta_17_adeudos_div set clave_pago=null where id_conv_resto=parm_id_convenio and pago_parcial=parm_parcialidad;

           -- afecta como cancelado en tabla de admin
           update pagos_admin set estado="C" where id_recibo=parm_cveadmin and estado="V";

           -- si es ultima parcialidad afecta el convenio como vigente y en predial
           if   parm_parcialidad=parm_totparc then
	update ta_17_conv_d_resto set vigencia="A",id_usuario=335,fecha_actual=current where id_conv_resto=parm_id_convenio;
	--update convenios set vigencia="A" where id_conv_diver=parm_id_convenio;
           end if;
   end;
end if;

--execute procedure catastro_gdl@catastro2_tcp:admSP_Diver_PreLic(parm_id_convenio,parm_fecha_pago,parm_id_rec,parm_caja,parm_operacion,parm_parcialid ad,parm_totparc,
--				                      parm_impparcial,parm_id_usuario,parm_movimiento);

return idpago,estatus;
end procedure;

CREATE PROCEDURE "informix".admsp_diver_tipos()

returning	smallint,		-- tipo
	char(60),		-- descripcion de tipo
	smallint,		-- subtipo
	char(60);		-- descripcion de subtipo

define 	v_tipo		smallint;
define	v_desctipo	char(50);
define	v_subtipo		smallint;
define	v_descsubt	char(50);

foreach
select a.tipo,b.descripcion,a.subtipo,a.desc_subtipo into v_tipo,v_desctipo,v_subtipo,v_descsubt 
from ta_17_subtipo_conv a,ta_17_tipos b
where a.tipo in (1,3)
and a.subtipo<>3
and b.tipo=a.tipo
order by a.tipo,a.subtipo

return  v_tipo,v_desctipo,v_subtipo,v_descsubt
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".admsp_social_consu(
parm_col 		smallint,
parm_calle 	smallint,
parm_fol 		integer)

returning  integer,		-- id-convenio
	char(60),		-- nombre
	char(50),		-- calle
	char(11),		-- numero
	char(30),		-- tipo
	date,		-- fecha firma
	smallint,		-- plazo
	smallint,		-- parc. resto
	smallint,		-- parc. a pagar
	char(1),		-- cve. parcial
	money(10,2),	-- imp. parcial
	integer,		-- cta. ingreso de obra
	money(10,2),	-- recargos  cuando vence contrato
	integer,		-- cta. recargos cuando vence contratro
	money(10,2),	-- recargos conveniados en parc.
	integer,		-- cta. recargos conveniados en parc.
	char(60),		-- Servicio / Obra
	char(60),		-- Nombre colonia
	smallint,		-- estatus
	char(60),		-- mensaje
	money(10,2),	-- cantidad_total
	money(10,2);	-- importe parcial total (con recargos conveniados si los tiene )

define v_id_convenio 	integer;
define v_nombre 		char(60);
define v_desc_calle 	char(50);
define v_numero 		char(11);
define v_pago_total 	money(10,2);
define v_pago_inicial 	money(10,2);
define v_pago_quincenal 	money(10,2);
define v_fecha_venc 	date;
define v_plazo 		smallint;
define v_cuenta_ingreso 	integer;
define v_desc_tip 		char(30);
define v_desc_col 		char(30);
define v_desc_serv 	char(60);
define v_vigencia 		char(1);
define v_imppagos 		money(10,2);
define v_numpagos 	smallint;
define v_impdescuento 	money(10,2);
define v_clave_historia 	smallint;
define v_axo 		smallint;
define v_cve_descuento 	smallint;
define v_pagos_dev 	money(10,2);
define v_rec_conv 		money(10,2);
define v_rec_parc 		money(10,2);
define v_id_conv_dev 	integer;
define v_dif20desc 		money(10,2);
define v_pagos_real 	money(10,2);
define v_saldo_real 		money(10,2);
define v_parc_resto 	smallint;
define v_parc_apagar 	smallint;
define v_cve_parc 		char(1);
define v_cta_rec 		integer;
define v_estatus 		smallint;
define v_mensaje 		char(60);
define v_impparc 		money(10,2);
define v_imp1 		money(10,2);
define v_imp2 		money(10,2);
define v_imp3 		money(10,2);
define v_porc 		decimal(10,3);
define v_req 		smallint;
define v_pagos_desc 	money(10,2);
define v_rec_dsol 		money(10,2);
define v_rec_cont		money(10,2);
define v_pagos_parc 	smallint;
define v_impsrec 		money(10,2);
define v_cta_recparc 	integer;
define v_idregistro		integer;
define v_oficio		integer;
define v_observ		varchar(200);
define v_porcdr		smallint;
define v_firma		date;

let v_porcdr=0;
let v_rec_parc=0;
let v_cta_recparc=0;
let v_impsrec=0;
let v_rec_dsol = 0;
let v_pagos_desc=0;
let v_req=0;
let v_porc=0;
let v_imp1=0;
let v_imp2=0;
let v_imp3=0; 
let v_parc_resto=0;
let v_parc_apagar=0;
let v_cta_rec=0;
let v_dif20desc =0;
let v_pagos_real =0;
let v_saldo_real=0;
let v_mensaje='';
let v_estatus=0;
let v_mensaje='PUEDE COBRARSE';
let v_rec_conv=0;
let v_impparc=0;
let v_parc_resto=0;
let v_parc_apagar=0;
let v_cve_parc=0;
let v_desc_serv='';
let v_plazo=0;
let v_cuenta_ingreso=0;
let v_fecha_venc=null;
let v_desc_tip='';
let v_desc_calle='';
let v_numero=0;
let v_nombre=0;
let v_id_convenio=0;
let v_rec_cont=0;
let v_desc_col='';
let v_pago_total=0;

if not exists(select * from ta_17_convenios where colonia=parm_col and calle=parm_calle and folio=parm_fol) then
   let v_estatus=5;
   let v_mensaje='NO EXISTE CONVENIO';
else
foreach		
select 	a.id_convenio,a.nombre,a.desc_calle,a.numero,a.pago_total,a.pago_inicial,a.pago_quincenal,a.fecha_vencimiento,b.plazo,
	b.cuenta_ingreso,e.descripcion,d.descripcion,c.descripcion,a.vigencia,sum(f.importe),count(f.id_convenio),
	sum(f.cve_descuento),a.clave_historia,sum(f.cve_descuento),b.axo_obra,a.recargos_conv,a.pagos_parciales,a.fecha_firma 
into	v_id_convenio,v_nombre,v_desc_calle,v_numero,v_pago_total,v_pago_inicial,v_pago_quincenal,v_fecha_venc,v_plazo,
	v_cuenta_ingreso,v_desc_tip,v_desc_col,v_desc_serv,v_vigencia,v_imppagos,v_numpagos,
	v_impdescuento,v_clave_historia,v_cve_descuento,v_axo,v_rec_dsol,v_pagos_parc,v_firma
from 	ta_17_convenios a,ta_17_calles b,ta_17_servicios c,ta_17_colonias d,ta_17_tipos e,outer (ta_17_pagos f)
where 	a.colonia=parm_col
	and a.calle=parm_calle
	and a.folio=parm_fol
	and b.colonia=a.colonia
	and b.calle=a.calle
	and c.servicio=b.servicio
	and d.colonia=a.colonia
	and e.tipo=b.tipo
	and f.id_convenio=a.id_convenio
group by 	a.id_convenio,a.nombre,a.desc_calle,a.numero,a.pago_total,a.pago_inicial,a.pago_quincenal,a.fecha_vencimiento,b.plazo,
	b.cuenta_ingreso,e.descripcion,d.descripcion,c.descripcion,a.vigencia,a.clave_historia,b.axo_obra,a.recargos_conv,a.pagos_parciales,a.fecha_firma
if v_vigencia='C' then
   let v_estatus=1;
   let v_mensaje='CONVENIO CANCELADO';
else
   if (parm_col=92) and (parm_calle=1) then
      let v_cuenta_ingreso=(2*100000)+v_cuenta_ingreso;
   end if;
   if (parm_col=5) and (parm_calle=2) then
      let v_cuenta_ingreso=(1*100000)+v_cuenta_ingreso;
   end if;
   if v_imppagos is null then
      let v_imppagos=0;
   end if;
   if v_numpagos is null then
      let v_numpagos=0;
   end if;
   if v_impdescuento is null then
      let v_impdescuento=0;
   end if;
   let v_pagos_dev=0;
   let v_rec_conv=0;
   if v_clave_historia=2 then
      foreach
      select sum(importe) 
      into 	v_pagos_desc from ta_17_convenios x,ta_17_pagos z 
      where	 x.id_convenio=v_id_convenio 
	and z.id_convenio=x.id_convenio 
	and x.clave_historia=2  
	and z.fecha_pago>=x.fecha_firma 
      end foreach;
      if v_pagos_desc is null then
         let v_pagos_desc=0;
      end if;
      let  v_imppagos=v_pagos_desc;
      let  v_plazo=v_pagos_parc;  
      foreach
      select sum(importe_cta) 
      into 	v_rec_conv from ta_17_convenios h,ta_17_pagos f,ta_12_importes g  
      where h.id_convenio=v_id_convenio 
	and f.id_convenio=h.id_convenio 
	and h.clave_historia=2  
	and f.fecha_pago>=h.fecha_firma 
                and f.fecha_pago<=h.fecha_vencimiento -- se incremento el 16/01/2009
      	and g.fecing=f.fecha_pago 
	and g.recing=f.oficina_pago 
	and g.cajing=f.caja_pago and 
      	g.opcaja=f.operacion_pago 
	and g.cta_aplicacion=46210 
      end foreach;
      if  v_rec_conv is null then
          let v_rec_conv=0;
      end if;
      let v_imppagos=v_imppagos+v_rec_conv;
   end if ;
   foreach
   select 	id_convenio,sum(importe) into v_id_conv_dev,v_pagos_dev
   from 	ta_17_devoluciones 
   where 	id_convenio=v_id_convenio
   group by id_convenio
   end foreach;
   if (v_numpagos =1 and v_cve_descuento=20) or (v_axo <1995 and v_cve_descuento=20 ) then
      if v_pagos_dev >0 then
         let v_dif20desc =0;
      else
         let v_dif20desc=v_pago_total - v_imppagos;
      end if;
   else
      let v_dif20desc=0;
   end if;  
   let v_pagos_real =((v_imppagos-v_pagos_dev)+v_dif20desc);
   let v_saldo_real=(v_pago_total-v_pagos_real);
   if v_saldo_real < 0 then
      let v_estatus=3;
      let v_mensaje='CONVENIO CON SALDO DE '||v_saldo_real||' A FAVOR'; 
   else
   if v_saldo_real=0 then
     let v_estatus=2;
     let v_mensaje='CONVENIO PAGADO'; 
   else
   if (v_saldo_real>0) and (v_numpagos=0) then
      if v_clave_historia=2 then
         let v_impparc=v_pago_quincenal;
         let v_cve_parc='P';
      else	
         let v_impparc=v_pago_inicial;
         let v_cve_parc='I';
      end if;
      let v_parc_apagar=1;
      let v_parc_resto=(v_plazo-v_parc_apagar);
   else
--      let v_imp1= (v_saldo_real-v_pago_inicial);
      if  v_clave_historia=2 then
          let v_imp1= (v_pagos_real-v_pago_quincenal);
      else
          let v_imp1= (v_pagos_real-v_pago_inicial);
      end if;
      if  v_imp1 < 0 then
          if  v_clave_historia=2 then
              let v_impparc=v_pago_quincenal;
              let v_cve_parc='P';
          else
              let v_impparc=v_pago_inicial;
              let v_cve_parc='I';
          end if; 
          let v_parc_apagar=1;
          let v_parc_resto=(v_plazo-v_parc_apagar);
      else
      if  v_imp1 = 0 then
          let v_impparc=v_pago_quincenal;
          let v_parc_apagar=2;
          let v_parc_resto=(v_plazo-v_parc_apagar);
          let v_cve_parc='P';
      else
          let v_imp2 = ( v_imp1/v_pago_quincenal);
          if  v_imp2 <= 0 then
              let v_impparc=v_pago_quincenal;
              if v_clave_historia=2 then
                 let v_parc_apagar=1;
              else
                 let v_parc_apagar=1+1;
              end if;
              let v_parc_resto=(v_plazo-v_parc_apagar);
              let v_cve_parc='P';
          else
--              if v_clave_historia=2 then
--                 let v_imp3=(v_plazo-v_imp2);
--              else
                 let v_imp3=(v_plazo-(v_imp2+1));
--              end if;
              if  v_imp3  >= 1 then
                  let v_impparc=v_pago_quincenal;
--                  if v_clave_historia=2 then
--                     let v_parc_apagar=(v_imp2+1);
--                  else
                     let v_parc_apagar=(v_imp2+2);
--                  end if;
                  let v_parc_resto=(v_plazo-v_parc_apagar);
                  let v_cve_parc='P';
              else
                  if  v_imp3 < 1 then
                      let v_estatus=4;
                      let v_mensaje='EL SALDO '||v_saldo_real||' ES MENOR AL PARCIAL COBRAR POR DIVERSOS';
                  end if;
              end if;
          end if;
     end if;
     end if;
   end if;
   end if;
   end if; 
   if today > v_fecha_venc then
      if  day(today)>day(v_fecha_venc) then
          foreach
          select sum(porcentaje_parcial) into v_porc from ta_13_recargosrcm
          where ( (axo>year(v_fecha_venc)  or (mes>=month(v_fecha_venc)  and axo =year(v_fecha_venc))) and
                     (axo<year(today)  or (mes<=month(today) and axo =year(today))) )
          end foreach;
      else
          foreach
          select sum(porcentaje_parcial) into v_porc from ta_13_recargosrcm
          where ( (axo>year(v_fecha_venc)  or (mes>=month(v_fecha_venc)  and axo =year(v_fecha_venc))) and
                     (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) )
          end foreach;
       end if;     
       foreach
      select count(*) into v_req from ta_15_apremios where modulo=17 and control_otr=v_id_convenio
      end foreach;
      if  v_req = 0 then
          if v_porc > 100 then
             let v_rec_cont=(v_impparc*100)/100;
          else
             let v_rec_cont=(v_impparc*v_porc)/100;
          end if;
      else
          if v_porc > 250 then
             let v_rec_cont=(v_impparc*250)/100;
          else
             let v_rec_cont=(v_impparc*v_porc)/100;
          end if;
      end if;
      if v_rec_cont > 0 then
         let v_rec_cont=trunc(v_rec_cont*100)/100;
         let v_cta_rec=(v_cuenta_ingreso*1000)+210;
      end if; 
   end if;

   foreach
   select id_registro,oficio,observaciones,porcentaje into v_idregistro,v_oficio,v_observ,v_porcdr from ta_17_oficios where modulo =17 and id_registro=v_id_convenio and vigencia="A"
   if v_rec_cont > 0 then
      let v_rec_cont= v_rec_cont-((v_rec_cont * v_porcdr)/100);
      if v_rec_cont=0 then
         let v_cta_rec=0;
      end if;
   end if; 
   end foreach;

   if v_clave_historia=2 then
      let v_rec_parc= v_rec_dsol/v_plazo;
      let v_impparc=v_impparc-v_rec_parc;
      if v_rec_dsol>0 then
         let v_cta_recparc=(v_cuenta_ingreso*1000)+210;
      end if;
   end if;
   end if;
end foreach;
end if;
   return  v_id_convenio,v_nombre,v_desc_calle,v_numero,v_desc_tip,v_firma,v_plazo,v_parc_resto,v_parc_apagar,v_cve_parc,v_impparc,v_cuenta_ingreso,v_rec_cont,v_cta_rec,v_rec_parc,v_cta_recparc,v_desc_serv,v_desc_col,v_estatus,v_mensaje,v_pago_total,v_pago_quincenal;
end procedure;

CREATE PROCEDURE "informix".admsp_social_pago(
parm_id_convenio 	integer,
parm_fecha_pago 	date,
parm_id_rec 	smallint,
parm_caja 	char(2),
parm_operacion 	integer,
parm_parcialidad 	smallint,
parm_totparc 	smallint,
parm_cve_parc 	char(1),
parm_impparcial 	money(10,2),
parm_imprecconv 	money(10,2),  -- recargos del contrato
parm_imprecparc 	money(10,2),  -- recargos conveniados en parcialidad
--parm_id_usuario 	integer,
parm_id_usuario 	char(10),
parm_movimiento 	char(1),
parm_colonia 	smallint,
parm_calle 	smallint,
parm_folio 	integer, 
parm_cveadmin	integer)

returning  		integer,    -- id_pago
		smallint;	-- estatus

define estatus 	smallint;
define idpago	integer;

let estatus=0;
let idpago=0;


if parm_movimiento='P' then
   begin
      on exception
           let estatus =1;
      end exception;

            --  falta agregar los recargos conveniados de parcialidad , recargos de contrato vencido y cveadmin, cuando se altere la tabla de pagos
           if not exists(select * from ta_17_pagos where fecha_pago=parm_fecha_pago and oficina_pago=parm_id_rec and caja_pago=parm_caja and operacion_pago=parm_operacion) then        
              insert into ta_17_pagos values (0,parm_id_convenio,parm_fecha_pago,parm_id_rec,parm_caja,parm_operacion,parm_parcialidad,parm_totparc,parm_impparcial,0,0,335,current);
              let idpago=dbinfo("sqlca.sqlerrd1");
           end if;

           -- inserta pago en tabla de admin
           if not exists(select * from pagos_admin where fecha=parm_fecha_pago and reca=parm_id_rec and caja=parm_caja and operacion=parm_operacion) then
              insert into pagos_admin values(parm_id_convenio,parm_parcialidad,parm_totparc,parm_impparcial,parm_imprecparc,parm_imprecconv,null,
                                                                                 parm_cveadmin,idpago,parm_fecha_pago,parm_id_rec,parm_caja,parm_operacion,"V",17);
           end if;
   end;
end if;

if parm_movimiento='C' then
   begin
      on exception
           let estatus=1;
      end exception;
           if exists(select * from ta_17_pagos where fecha_pago=parm_fecha_pago and oficina_pago=parm_id_rec and caja_pago=parm_caja and operacion_pago=parm_operacion) then
               delete from ta_17_pagos where fecha_pago=parm_fecha_pago and oficina_pago=parm_id_rec and caja_pago=parm_caja and operacion_pago=parm_operacion and 					id_convenio=parm_id_convenio;
           end if;

           -- afecta como cancelado en tabla de admin
           if exists(select * from pagos_admin where fecha=parm_fecha_pago and reca=parm_id_rec and caja=parm_caja and operacion=parm_operacion) then
              update pagos_admin set estado='C' where id_recibo=parm_cveadmin and estado='V';
 	let idpago= 1;
           end if;

   end;
end if;

if parm_movimiento='D' then
   begin
      on exception
           let estatus=1;
      end exception;

           insert into admTB_Social_Pdiv values(0,parm_colonia,parm_calle,parm_folio,parm_fecha_pago,parm_id_rec,parm_caja,parm_operacion,parm_parcialidad,parm_totparc,parm_impparcial,
	parm_imprecparc,parm_imprecconv,parm_cveadmin,335,current);
           let idpago=dbinfo("sqlca.sqlerrd1");

           -- inserta pago en tabla de admin
           insert into pagos_admin values(parm_id_convenio,parm_parcialidad,parm_totparc,parm_impparcial,parm_imprecparc,parm_imprecconv,null,
                                                                                 parm_cveadmin,idpago,parm_fecha_pago,parm_id_rec,parm_caja,parm_operacion,"V",17);
   end;
end if;
return idpago,estatus;
end procedure;

CREATE PROCEDURE "informix".con16_f1detade ( p_Mod Char(2), p_Control_contrato Integer)
	returning varchar(255),    -- Concepto
                               Money(12,2);    -- Importe 

{
#  Procedimiento: Con16_F1DetAde
#  Descripcion:  Genera una consulta del detalle de Adeudos con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe generado por la consulta
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago             						Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);



  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 		Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO 	varchar(120);

  define aso_proceso, aso_actual						Integer;
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;


                Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
                foreach
                     Select id_control,   folio,            importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                end foreach;
                       if (v_importe_multa <> 0) or (v_tot_gastos <> 0) then
		return 'Multa del Requerimiento con el folio : ' || v_folio_req , v_importe_multa  with resume;
		return 'Gastos Generados por el Total de Requerimientos : ' , v_tot_gastos  with resume;
                       end if;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' Cuota Normal, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' Exedencias, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;

--     Grabando registro
   if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       Let v_Detalle_T = 'Adeudos del  ' || aso_proceso || '  ';
       if v_Lineas_CN > 0 then
                Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       end if;
       if v_Lineas_EX > 0 then
                Let v_Detalle_T = v_Detalle_T|| '  ' || v_Detalle_EX;
       end if;
       return v_Detalle_T , v_totAdeudos  with resume;
--       if v_TotRecargos > 0 then
--               return ' Recargos ' , v_TotRecargos  with resume;
--       end if;
   end if;

   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
--   Let v_TotRecargos = 0;

  END FOR;
       if v_TotRecargos > 0 then
               return ' Recargos Generados por la Totalidad de Adeudos ' , v_TotRecargos  with resume;
       end if;
       Let v_TotRecargos = 0;

end procedure;

CREATE PROCEDURE "informix".con16_f1detcont ( p_Mod Char(2), p_Control_contrato Integer)
	returning Integer,             -- Status del Porcedimiento 
                                                        -- 0 = Procede con Adeudo 
                                                        -- 1 = No Procede por Req. Pend.  
                                                        -- 2 = No Existe el Contrato  
                                                        -- 3 = No tiene Adeudos vigentes
                               varchar(255),      -- Concepto del Status
                               varchar(255),      -- Nombre
                               varchar(255),      -- Domicilio
                               varchar(255);      -- Observaciones

{
#  Procedimiento: Con16_F1DetCont
#  Descripcion:  Genera una consulta del Contrato con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Status  : Status que guarda el contrato a consulta
#                                       Concepto del Status   : Descripcion del Status
#                                       Nombre : Nombre de la persona Moral o Fisica a quien esta el Contrato
#                                       Domicilio : Domicilio registrado de recoleccion
#                                       Observaciones : Numero de contrato, tipo y cantidad de recoleccion
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}


  define v_Control, v_Ctrol_Aseo, v_Num_Contrato      		Integer;
  define v_Detalle_Apremios 					varchar(120);
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_cantidad_recolec					Integer;
  define v_tipo_recolec					varchar(20);
  define v_Recargos, v_Adeudos, v_Rec_CN, v_Rec_EXE, v_Ade_CN, v_Ade_EXE 				Money(12,2);
  define v_importe_multa, v_importe_gastos, v_totapremio		Money(12,2);

  define v_Aso, v_Mes, v_Mes_x                  				varchar(4);
  define Mes_v, Dia_v					varchar(4);
  define v_Periodo						varchar(9);
  define Aso_Hoy						varchar(4);
  define Mes_Hoy						varchar(2);
  define v_Periodo_1, v_Periodo_2, v_Periodo_3			varchar(7);
  define v_Periodo_CN, v_Periodo_EXE				varchar(7);

  define v_id_control, v_modulo, v_control_otr, v_folio  		Integer;

  define v_aso_mes_pago             Date;
  define v_importe                         Money(12,2);
  define v_exedencias	     Smallint;
  define v_Detalle_CN                  varchar(200);
  define v_Detalle_EX                  varchar(200);
  define v_Detalle_CO                  varchar(200);

  define v_fecha_ini 					Date;
  define v_fecha_inicio					Date;

  define registros, reg_CN, reg_EX, reg_CO			smallint;

  define v_Importe_recargo					Money(12,2);
  define v_Status						Integer;
  Let v_Status = -1;
       Let v_Control = 0;

       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;
  
----------------------EXISTE ?

 If exists(Select * From ta_16_contratos
                where control_contrato = p_Control_contrato ) then

       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, a.aso_mes_oblig
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_fecha_ini
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.control_contrato = p_Control_contrato
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec;

     Let v_totapremio = 0;
     Let v_importe_multa = 0;
     Let v_importe_gastos = 0;

                foreach
                     Select id_control, modulo, control_otr, folio, importe_multa, importe_gastos
                       Into v_id_control, v_modulo, v_control_otr, v_folio, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato and vigencia = "1" and clave_practicado = "P"

                                Let v_totapremio = v_totapremio + v_importe_gastos;
                end foreach;
                                Let v_totapremio = v_totapremio + v_importe_multa;


		-------------------------------------CONSULTA DE CUOTA NORMAL
             		Let v_Ade_CN = 0;
             		Let v_Rec_CN = 0;
             		Let v_importe = 0;
             		Let v_Importe_recargo = 0;
                	foreach
    		Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN) and H.Status_Vigencia = 'V'

                                   Let v_Ade_CN = v_Ade_CN + v_importe;
  
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

     		   		   Let v_Rec_CN = v_Rec_CN + ((v_importe * v_Importe_recargo) / 100);
                	end foreach;
		-------------------------------------CONSULTA DE EXEDENCIAS
             		Let v_Ade_EXE = 0;
             		Let v_Rec_EXE = 0;
             		Let v_importe = 0;
             		Let v_Importe_recargo = 0;
                	foreach
    		Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE) and H.Status_Vigencia = 'V'

                                   Let v_Ade_EXE = v_Ade_EXE + v_importe;
  
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

     		   		   Let v_Rec_EXE = v_Rec_EXE + ((v_importe * v_Importe_recargo) / 100);
                	end foreach;
	       -------------------------------------  SUMA DE ADEUDOS
                   if (v_totapremio = 0) and (v_Ade_CN = 0) and (v_Ade_EXE = 0) then
	        return 3, 'NO TIENE ADEUDOS PENDIENTES DE PAGO', ' ', ' ', ' ';
                   else
                        if (v_totapremio > 0) then
	               return 1, 'TIENE REQUERIMIENTO PENDIENTE DE PAGO', v_nombre, v_domicilio, 'CONTRATO No. : ' || v_Num_Contrato || '   RECOLECCION DE  ' || v_cantidad_recolec || '  ' || v_tipo_recolec ;
                        else
		return 0, 'PROCEDE PAGO DE ADEUDOS PENDIENTES', v_nombre, v_domicilio, 'CONTRATO No. : ' || v_Num_Contrato || '   RECOLECCION DE  ' || v_cantidad_recolec || '  ' || v_tipo_recolec ;
                       end if;

                   end if;

 Else
	return 2, 'NO EXISTE EL CONTRATO', ' ', ' ', ' ';
 End if;

end procedure;

CREATE PROCEDURE "informix".con16_f2detade ( p_Mod Char(2), p_Control_contrato Integer)
	returning varchar(255),    -- Concepto
                               Money(12,2);    -- Importe 

{
#  Procedimiento: Con16_F2DetAde
#  Descripcion:  Genera una consulta del detalle de Adeudos con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar con desglose de recargos por a�o
#  		         Importe : El importe generado por la consulta
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago             						Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);



  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 		Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO 	varchar(120);

  define aso_proceso, aso_actual						Integer;
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;


                Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
                foreach
                     Select id_control,   folio,            importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                end foreach;
                       if (v_importe_multa <> 0) or (v_tot_gastos <> 0) then
		return 'Multa del Requerimiento con el folio : ' || v_folio_req , v_importe_multa  with resume;
		return 'Gastos Generados por el Total de Requerimientos : ' , v_tot_gastos  with resume;
                       end if;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' Cuota Normal, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' Exedencias, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;

--     Grabando registro
   if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       Let v_Detalle_T = 'Adeudos del  ' || aso_proceso || '  ';
       if v_Lineas_CN > 0 then
                Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       end if;
       if v_Lineas_EX > 0 then
                Let v_Detalle_T = v_Detalle_T|| '  ' || v_Detalle_EX;
       end if;
       return v_Detalle_T , v_totAdeudos  with resume;
       if v_TotRecargos > 0 then
               return ' Recargos del  ' || aso_proceso || '  ', v_TotRecargos  with resume;
       end if;
   end if;

   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;

  END FOR;
--       if v_TotRecargos > 0 then
--               return ' Recargos Generados por la Totalidad de Adeudos ' , v_TotRecargos  with resume;
--       end if;
--       Let v_TotRecargos = 0;

end procedure;

CREATE PROCEDURE "informix".con16_f2detcont ( p_Mod Char(2), p_Control_contrato Integer)
	returning Integer,             -- Status del Porcedimiento 
                                                        -- 0 = Procede con Adeudo 
                                                        -- 1 = No Procede por Req. Pend.  
                                                        -- 2 = No Existe el Contrato  
                                                        -- 3 = No tiene Adeudos vigentes
                               varchar(255),      -- Concepto del Status
                               varchar(255),      -- Nombre
                               varchar(255),      -- Domicilio
                               varchar(255);      -- Observaciones

{
#  Procedimiento: Con16_F1DetCont
#  Descripcion:  Genera una consulta del Contrato con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Status  : Status que guarda el contrato a consulta
#                                       Concepto del Status   : Descripcion del Status
#                                       Nombre : Nombre de la persona Moral o Fisica a quien esta el Contrato
#                                       Domicilio : Domicilio registrado de recoleccion
#                                       Observaciones : Numero de contrato, tipo y cantidad de recoleccion
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}


  define v_Control, v_Ctrol_Aseo, v_Num_Contrato      		Integer;
  define v_Detalle_Apremios 					varchar(120);
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_cantidad_recolec					Integer;
  define v_tipo_recolec					varchar(20);
  define v_Recargos, v_Adeudos, v_Rec_CN, v_Rec_EXE, v_Ade_CN, v_Ade_EXE 				Money(12,2);
  define v_importe_multa, v_importe_gastos, v_totapremio		Money(12,2);

  define v_Aso, v_Mes, v_Mes_x                  				varchar(4);
  define Mes_v, Dia_v					varchar(4);
  define v_Periodo						varchar(9);
  define Aso_Hoy						varchar(4);
  define Mes_Hoy						varchar(2);
  define v_Periodo_1, v_Periodo_2, v_Periodo_3			varchar(7);
  define v_Periodo_CN, v_Periodo_EXE				varchar(7);

  define v_id_control, v_modulo, v_control_otr, v_folio  		Integer;

  define v_aso_mes_pago             Date;
  define v_importe                         Money(12,2);
  define v_exedencias	     Smallint;
  define v_Detalle_CN                  varchar(200);
  define v_Detalle_EX                  varchar(200);
  define v_Detalle_CO                  varchar(200);

  define v_fecha_ini 					Date;
  define v_fecha_inicio					Date;

  define registros, reg_CN, reg_EX, reg_CO			smallint;

  define v_Importe_recargo					Money(12,2);
  define v_Status						Integer;
  Let v_Status = -1;
       Let v_Control = 0;

       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;
  
----------------------EXISTE ?

 If exists(Select * From ta_16_contratos
                where control_contrato = p_Control_contrato ) then

       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, a.aso_mes_oblig
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_fecha_ini
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.control_contrato = p_Control_contrato
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec;

     Let v_totapremio = 0;
     Let v_importe_multa = 0;
     Let v_importe_gastos = 0;

                foreach
                     Select id_control, modulo, control_otr, folio, importe_multa, importe_gastos
                       Into v_id_control, v_modulo, v_control_otr, v_folio, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato and vigencia = "1" and clave_practicado = "P"

                                Let v_totapremio = v_totapremio + v_importe_gastos;
                end foreach;
                                Let v_totapremio = v_totapremio + v_importe_multa;


		-------------------------------------CONSULTA DE CUOTA NORMAL
             		Let v_Ade_CN = 0;
             		Let v_Rec_CN = 0;
             		Let v_importe = 0;
             		Let v_Importe_recargo = 0;
                	foreach
    		Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN) and H.Status_Vigencia = 'V'

                                   Let v_Ade_CN = v_Ade_CN + v_importe;
  
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

     		   		   Let v_Rec_CN = v_Rec_CN + ((v_importe * v_Importe_recargo) / 100);
                	end foreach;
		-------------------------------------CONSULTA DE EXEDENCIAS
             		Let v_Ade_EXE = 0;
             		Let v_Rec_EXE = 0;
             		Let v_importe = 0;
             		Let v_Importe_recargo = 0;
                	foreach
    		Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE) and H.Status_Vigencia = 'V'

                                   Let v_Ade_EXE = v_Ade_EXE + v_importe;
  
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

     		   		   Let v_Rec_EXE = v_Rec_EXE + ((v_importe * v_Importe_recargo) / 100);
                	end foreach;
	       -------------------------------------  SUMA DE ADEUDOS
                   if (v_totapremio = 0) and (v_Ade_CN = 0) and (v_Ade_EXE = 0) then
	        return 3, 'NO TIENE ADEUDOS PENDIENTES DE PAGO', ' ', ' ', ' ';
                   else
                        if (v_totapremio > 0) then
	               return 1, 'TIENE REQUERIMIENTO PENDIENTE DE PAGO', v_nombre, v_domicilio, 'CONTRATO No. : ' || v_Num_Contrato || '   RECOLECCION DE  ' || v_cantidad_recolec || '  ' || v_tipo_recolec ;
                        else
		return 0, 'PROCEDE PAGO DE ADEUDOS PENDIENTES', v_nombre, v_domicilio, 'CONTRATO No. : ' || v_Num_Contrato || '   RECOLECCION DE  ' || v_cantidad_recolec || '  ' || v_tipo_recolec ;
                       end if;

                   end if;

 Else
	return 2, 'NO EXISTE EL CONTRATO', ' ', ' ', ' ';
 End if;

end procedure;

CREATE PROCEDURE "informix".con16_f3detcont ( p_Mod Char(2), p_Control_contrato Integer)
	returning Integer,             -- Status del Porcedimiento 
                                                        -- 0 = Procede con Adeudo 
                                                        -- 1 = No Procede por Req. Pend.  
                                                        -- 2 = No Existe el Contrato  
                                                        -- 3 = No tiene Adeudos vigentes
                               varchar(255),      -- Concepto del Status
                               varchar(255),      -- Nombre
                               varchar(255),      -- Domicilio
                               varchar(255);      -- Observaciones

{
#  Procedimiento: Con16_F3DetCont
#  Descripcion:  Genera una consulta del Contrato con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Status  : Status que guarda el contrato a consulta
#                                       Concepto del Status   : Descripcion del Status
#                                       Nombre : Nombre de la persona Moral o Fisica a quien esta el Contrato
#                                       Domicilio : Domicilio registrado de recoleccion
#                                       Observaciones : Numero de contrato, tipo y cantidad de recoleccion
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}


  define v_Control, v_Ctrol_Aseo, v_Num_Contrato, v_id_control, v_modulo, v_control_otr, v_folio	Integer;
  define v_Detalle_Apremios 					varchar(120);
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_cantidad_recolec, v_exedencias, v_Status		Integer;
  define v_tipo_recolec					varchar(20);
  define v_Adeudos, v_importe				Money(12,2);
  define v_importe_multa, v_importe_gastos, v_totapremio		Money(12,2);

  define v_Aso, v_Mes, v_Mes_x, Aso_Hoy, Mes_v, Dia_v		varchar(4);
  define v_Periodo						varchar(9);
  define Mes_Hoy						varchar(2);
  define v_Periodo_CN, v_Periodo_EXE				varchar(7);

  define v_aso_mes_pago, v_fecha_ini, v_fecha_inicio             	Date;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;
  
----------------------EXISTE ?
 Let v_Status = -1;
 Let v_Control = 0;
 If exists(Select * From ta_16_contratos
                where control_contrato = p_Control_contrato ) then

       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, a.aso_mes_oblig
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_fecha_ini
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.control_contrato = p_Control_contrato
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec;

     Let v_totapremio = 0;
     Let v_importe_multa = 0;
     Let v_importe_gastos = 0;

                foreach
                Select id_control, modulo, control_otr, folio, importe_multa, importe_gastos
                Into v_id_control, v_modulo, v_control_otr, v_folio, v_importe_multa, v_importe_gastos 
                from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato and vigencia = "1" and clave_practicado = "P"
                                Let v_totapremio = v_totapremio + v_importe_gastos;
                end foreach;
                                Let v_totapremio = v_totapremio + v_importe_multa;
	-------------------------------------CONSULTA DE CUOTA NORMAL
	Let v_Adeudos = 0;
             	Let v_importe = 0;
                foreach
    	Select h.importe
        	Into v_importe
     	From ta_16_pagos H
     	        	Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		and H.aso_mes_pago <= (v_Periodo_CN) and H.Status_Vigencia = 'V'
                                   	Let v_Adeudos = v_Adeudos + v_importe;
                end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
             	Let v_importe = 0;
                foreach
--    	Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
--        	Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
    	Select h.importe
        	Into v_importe
     	From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
          		 and H.aso_mes_pago <= (v_Periodo_EXE) and H.Status_Vigencia = 'V'
                                   	Let v_Adeudos = v_Adeudos + v_importe;
                end foreach;
      -------------------------------------  SUMA DE ADEUDOS
      if (v_totapremio = 0) and (v_Adeudos = 0) then
	return 3, 'NO TIENE ADEUDOS PENDIENTES DE PAGO', ' ', ' ', ' ';
      else
	if (v_totapremio > 0) then
	        return 1, 'TIENE REQUERIMIENTO PENDIENTE DE PAGO', v_nombre, v_domicilio, 'CONTRATO No. : ' || v_Num_Contrato || '   RECOLECCION DE  ' || v_cantidad_recolec || '  ' || v_tipo_recolec ;
                else
                        return 0, 'PROCEDE PAGO DE ADEUDOS PENDIENTES', v_nombre, v_domicilio, 'CONTRATO No. : ' || v_Num_Contrato || '   RECOLECCION DE  ' || v_cantidad_recolec || '  ' || v_tipo_recolec ;
                end if;
      end if;
 Else
      return 2, 'NO EXISTE EL CONTRATO', ' ', ' ', ' ';
 End if;

end procedure;

CREATE PROCEDURE "informix".prueba()

returning	smallint,
	smallint;

define v_id_rec smallint;
define v_merc   smallint;

foreach
select oficina,num_mercado_nvo into v_id_rec,v_merc  from db_ingresos@catastro2_tcp:ta_11_mercados where id_rec=1
order by oficina,mun_mercado_nvo
return v_id_rec,v_merc
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd16_contratos(p_Ofna  Int)
returning int;
define v_cuantos, v_contador, v_control  Integer;
define v_aso_mes_oblig, v_fecha Date;

let v_contador = 0;
Let v_fecha = mdy(07,31,2010);

foreach
select control_contrato, aso_mes_oblig into v_control, v_aso_mes_oblig
from ta_16_contratos
where ctrol_aseo = 9 and id_Rec = p_Ofna and status_vigencia = 'V' 
and ((fecha_hora_baja is null) or (fecha_hora_baja > v_fecha))

                        if not exists(select * from ta_16_pagos
                           where control_contrato = v_control 
                              and aso_mes_pago between v_aso_mes_oblig and v_fecha 
                              and status_vigencia = 'V') then

                         Let v_contador = v_contador + 1;
                        end if;
end foreach;

 return v_contador;

end procedure;

CREATE PROCEDURE "informix".spd_11_bancopag (
p_idlocal integer,
p_mesdsd smallint,
p_axodsd smallint,
p_meshst smallint,
p_axohst	smallint,
p_fechap date,
p_idrec smallint,
p_caja char(2),
p_oper integer,
p_adeudo money(15,2),
p_gastos money(15,2),
p_descuento money(15,2),
p_merc smallint,
p_iduser integer)

returning	integer,		-- id_pago
	smallint,		-- estado
	char(60),		-- mensaje
	money(15,2),	-- importe
	money(15,2);	--gastos

define v_estado	smallint;
define v_mensaje	char(60);
define v_idpago	integer;
define v_axo	smallint;
define v_periodo	smallint;
define v_importe	money(15,2);
define v_ade	smallint;
define v_pag	smallint;
define v_desc	smallint;
define v_impcalc	money(15,2);
define v_folio	integer;
define v_gastos	money(15,2);
define v_idreq	integer;
define v_totgas        money(15,2);
define v_totimp        money(15,2);
let v_totgas=0;
let v_totimp=0;

-- verifica si existen adeudos

select count(*) into v_ade
from ta_11_adeudo_local 
where id_local=p_idlocal
and ( (axo>p_axodsd  or (periodo>=p_mesdsd  and axo=p_axodsd)) and
         (axo<p_axohst  or  (periodo<=p_meshst and axo=p_axohst))  );
if v_ade=0 then
   select count(*) into v_pag
   from ta_11_pagos_local 
   where id_local=p_idlocal
   and ( (axo>p_axodsd  or (periodo>=p_mesdsd  and axo=p_axodsd)) and
            (axo<p_axohst  or  (periodo<=p_meshst and axo=p_axohst))  );
   if v_pag=0 then
      let v_idpago=0;
      let v_estado=1;
      let v_mensaje='NO EXISTE ADEUDO';
   else
      let v_idpago=0;
      let v_estado=2;
      let v_mensaje='ADEUDO PAGADO, VERIFICA EL DATO';
   end if; 
end if;

foreach
select axo,periodo,importe into	v_axo,v_periodo,v_importe
from ta_11_adeudo_local
where id_local=p_idlocal
and ( (axo>p_axodsd  or (periodo>=p_mesdsd  and axo=p_axodsd)) and
         (axo<p_axohst  or  (periodo<=p_meshst and axo=p_axohst))  )
order by axo,periodo

if p_merc=214  then
   select id_contribuy_renta into v_desc from ta_11_locales where id_local=p_idlocal;
   if v_desc is null then
      let v_desc=0; 
   end if;
   if v_desc>0 then
      let v_impcalc=(v_importe*(100-v_desc))/100;
   else
      let v_impcalc=v_importe;
   end if;
else
   if (p_descuento>0) and (v_axo=p_axohst) and (v_periodo=p_meshst) then
      let v_impcalc=(v_importe*0.90);
   else
      let v_impcalc=v_importe;
   end if; 
end if;

-- graba el mes como pagado
insert into ta_11_pagos_local values (0,p_idlocal,v_axo,v_periodo,p_fechap,p_idrec,p_caja,p_oper,v_impcalc,"BANCO MOVIL",current,p_iduser);
let v_idpago=dbinfo("sqlca.sqlerrd1");
let v_estado=0;
let v_mensaje='PAGO APLICADO';
let v_totimp=v_totimp+v_impcalc;

-- borra el adeudo por mes
delete from ta_11_adeudo_local where id_local=p_idlocal and axo=v_axo and periodo=v_periodo;
end foreach;

-- afecta como pagados los requerimientos vigentes y practicados
foreach
select id_control,folio,importe_gastos into v_idreq,v_folio,v_gastos from ta_15_apremios where modulo=11 and control_otr=p_idlocal and vigencia="1" and clave_practicado="P"

update ta_15_apremios set fecha_pago=p_fechap, recaudadora=p_idrec, caja=p_caja,operacion=p_oper,vigencia="2",clave_mov="P",importe_pago=v_gastos
            where modulo=11 and id_control=v_idreq;
let v_totgas=v_totgas+v_gastos;       
end foreach;
return v_idpago,v_estado,v_mensaje,v_totimp,v_totgas;
end procedure;

CREATE PROCEDURE "informix".spd_11_condonacion (
p_idlocal		integer,
p_idusu		integer,
p_cat		smallint,
p_sec		char(2),
p_cvecuo	smallint,
p_superf		decimal(6,2),
p_clave		char(1))
returning		integer,		-- control
		smallint,		-- axo
		smallint,		-- mes
		money(16,2),	-- renta
		varchar(100),	-- mensaje
		smallint;		-- resultado 0 bien,1 mal
define  acontrol	integer;
define  aaxo	smallint;
define  ames	smallint;
define  arenta	money(16,2);
define  vaxo	smallint;
define  vmes	smallint;
define  vrenta	money(16,2);

let acontrol=0;
let aaxo=0;
let ames=0;
let arenta=0;
let vrenta=0;

if p_clave='A' then

if exists(select * from ta_11_adeudo_local where id_local=p_idlocal
           and ((axo=year(today) and periodo<=month(today)-2) or (axo<year(today)))  ) then
           foreach
           	select  id_local,axo,periodo,importe into acontrol,aaxo,ames,arenta
           	from ta_11_adeudo_local 
           	where id_local=p_idlocal
           	and ((axo=year(today) and periodo<=month(today)-2) or (axo<year(today))) 
           	order by id_local asc,axo asc,periodo asc
           	return acontrol,aaxo,ames,arenta,'EL LOCAL NO ESTA AL CORRIENTE DE PAGOS, NO PUEDES REALIZAR LA CONDONACION DE ADEUDOS',1 with resume;
           end foreach;
else
           if   exists(select * from ta_15_apremios where modulo=11 and control_otr=p_idlocal and vigencia='1' and clave_practicado='P') then
	return acontrol,aaxo,ames,arenta,'EL LOCAL TIENE REQUERIMIENTOS VIGENTES, NO PUEDES REALIZAR LA CONDONACION DE ADEUDOS',1 with resume;
           else
                let vaxo=year(today);
                let vmes=month(today)+1;
                while vmes < 13
                if not exists(select * from ta_11_adeudo_local where id_local=p_idlocal and axo=vaxo and periodo=vmes) then	
	     if not exists(select * from ta_11_pagos_local where id_local=p_idlocal and axo=vaxo and periodo=vmes ) then
	          if not exists(select * from ta_11_ade_loc_canc where id_local=p_idlocal and axo=vaxo and periodo=vmes ) then
	               execute procedure spd_11_calc_renta(year(today),p_cat,p_sec,p_cvecuo,p_superf) into vrenta;
           	               insert into ta_11_adeudo_local values (0,p_idlocal,vaxo,vmes,vrenta,current,p_idusu);
	          end if;
	     end if; 
                end if;
                let vmes=vmes+1;
                end while;
	if not exists(select * from ta_11_adeudo_local where id_local=p_idlocal) then
	   let acontrol=p_idlocal;
	   return acontrol,aaxo,ames,arenta,'EL LOCAL NO TIENE ADEUDOS',0 with resume;
	else
                   foreach
                   select id_local,axo,periodo,importe into acontrol,aaxo,ames,arenta from ta_11_adeudo_local
                   where id_local=p_idlocal
                   and ((axo=year(today) and periodo>=month(today)-1) or (axo<year(today)))
                   return acontrol,aaxo,ames,arenta,'LA CONDONACION DE ADEUDOS SE PUEDE REALIZAR',0 with resume;
                   end foreach;
	end if;
           end if;
end if;  
end if ---- opcion A

if p_clave='B' then
    delete from ta_11_adeudo_local where id_local=p_idlocal and (axo=year(current) and periodo>month(current));
    let acontrol=p_idlocal; 
    return acontrol,aaxo,ames,arenta,'SE BORRARON LOS ADEUDOS MAYORES AL MES ACTUAL',0 with resume;
end if ---- opcion B

end procedure;

CREATE PROCEDURE "informix".spd_11_ctapub_ade(
parm_rec smallint,
parm_axo smallint,
parm_mes smallint)
returning smallint,
               integer,
               money(10,2);
define    v_oficina smallint;
define    v_control integer;
define    v_locales integer;
define    v_adeudo money(10,2);
define    v_adeudo_g money(10,2);
let v_locales=0;
let v_adeudo_g=0;
foreach
    select a.oficina,a.id_local,sum(b.importe) adeudo into v_oficina,v_control,v_adeudo
          from ta_11_locales a,ta_11_adeudo_local b 
          where a.oficina=parm_rec
          and a.vigencia='A'
          and ((b.axo=parm_axo and b.periodo<=parm_mes) or (b.axo<parm_axo))
          and a.id_local=b.id_local
          group by a.oficina,a.id_local
          let v_locales=v_locales+1;
          let v_adeudo_g=v_adeudo_g+v_adeudo;
end foreach;
return v_oficina,v_locales,v_adeudo_g;
end procedure;

CREATE PROCEDURE "informix".spd_11_dif_renta(
--   checa si existen diferencia de renta en base a la fecha de pago
parm_rec smallint,
parm_fpadsd  date,
parm_fpahst   date)
returning  integer,
	smallint,
	smallint,
	date,
	smallint,
	char(1),
	integer,
	money(10,2),
	char(18),
	char(20),
	char(8),
	smallint,
	smallint,
	smallint,
	char(2),
	integer,
	char(1),
	char(1),
	money(10,2);
define  v_id_local integer;
define  v_axo smallint;
define  v_periodo smallint;
define  v_fecha_pago date;
define  v_oficina_pago smallint;
define  v_caja_pago char(1);
define  v_operacion_pago integer;
define  v_importe_pago money(10,2);
define  v_folio char(18);
define  v_fecha_mod char(20);
define  v_usuario char(8);
define  v_oficina smallint;
define  v_num_mercado smallint;
define  v_categoria  smallint;
define  v_seccion  char(2);
define  v_local integer;
define  v_letra_local char(1);
define  v_bloque char(1);
define  v_clave_cuota smallint;
define  v_superficie decimal(8,2);
define  v_importe_cuota money(10,2);
define  v_rentacalc money(10,2);
define  v_renta  money(10,2);
define  v_fecha_descuento date;
define  v_rentadif money(10,2);
let v_renta=0;
let v_rentacalc=0;
let v_rentadif=0;
foreach
   select a.id_local,a.axo,a.periodo,a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,a.importe_pago,a.folio,a.fecha_modificacion||' ',c.usuario,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,b.clave_cuota,b.superficie into v_id_local,v_axo,v_periodo,v_fecha_pago,v_oficina_pago,v_caja_pago,v_operacion_pago,v_importe_pago,v_folio,v_fecha_mod,v_usuario,v_oficina,v_num_mercado,v_categoria,v_seccion,v_local,v_letra_local,v_bloque,v_clave_cuota,v_superficie
   from ta_11_pagos_local a, ta_11_locales b,ta_12_passwords c
   where (a.fecha_pago between parm_fpadsd and parm_fpahst)
   and b.id_local=a.id_local     
   and c.id_usuario=a.id_usuario
   and b.oficina=parm_rec
   order by a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago
   let v_rentacalc=0;
   if v_axo>=2002 then
      foreach
      select importe_cuota into v_importe_cuota from ta_11_cuo_locales
      where axo=v_axo
      and categoria=v_categoria
      and seccion=v_seccion
      and clave_cuota=v_clave_cuota
      if  v_axo=2007 then
          foreach
          select fecha_descuento into v_fecha_descuento from ta_11_fecha_desc
          where mes=v_periodo
          end foreach;
      else
          let v_fecha_descuento=0;
      end if;
      if   v_seccion ='PS' then
           if v_clave_cuota=4 then
              let v_renta=v_superficie*v_importe_cuota; 
           else
              let v_renta=(v_superficie*v_importe_cuota)*30;
           end if;
      else
           let v_renta=v_superficie*v_importe_cuota;
      end if; 
      if  v_fecha_descuento >= v_fecha_pago then
          let v_rentacalc=v_renta-(v_renta*0.10);
      else
          let v_rentacalc=v_renta;
      end if;
      end foreach;
  else
     let v_rentacalc=0;
  end if;
if v_importe_pago<>v_rentacalc then
   let v_rentadif=v_importe_pago-v_rentacalc;
   if (v_rentadif=-0.01) or (v_rentadif=0.01) then
      let v_rentadif=0;
   else
      return v_id_local,v_axo,v_periodo,v_fecha_pago,v_oficina_pago,v_caja_pago,v_operacion_pago,v_importe_pago,v_folio,v_fecha_mod,v_usuario,v_oficina,v_num_mercado,v_categoria,v_seccion,v_local,v_letra_local,v_bloque,v_rentacalc
     with resume;
   end if;
end if;
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_11_kiosco(
parm_ofn smallint,
parm_mer smallint,
parm_cat smallint,
parm_sec char(2),
parm_loc integer,
parm_let char(1),
parm_blq char(1))
returning  smallint,
	integer,
               smallint,
               smallint,
               smallint,
               char(2),
               integer,
               char(1),
               char(1),
               char(30),
               char(30),  
               decimal(7,2),
               money(10,2),
               money(10,2),
               char(30),
               char(60);
define v_pago smallint;
define v_id_local,v_id integer;
define v_oficina,v_ofn smallint;
define v_mercado,v_mer smallint;
define v_categoria,v_cat smallint;
define v_seccion,v_sec char(2);
define v_local,v_loc integer;
define v_letra,v_let char(1); 
define v_bloque,v_blq char(1);
define v_letra1 char(1); 
define v_bloque1 char(1);
define v_nombre char(30);
define v_adicional char(20);
define v_superficie decimal(6,2);
define v_adeudo money(10,2);
define v_recargos money(10,2);
define v_cuantos integer;
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_folios integer;
define v_renta money(10,2);
define v_per smallint;
define v_aid_local integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(10,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(4,2);
define v_vigencia char(1);
define v_partida char(10);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador smallint;
let v_id_local=0;
let v_oficina=0;
let v_mercado=0;
let v_categoria=0;
let v_seccion='';
let v_local=0;
let v_letra='';
let v_bloque='';
let v_nombre='';
let v_adicional='';
let v_superficie=0;
let v_renta=0;
let v_nom_mercado='';
let v_descripcion='';
let v_recargos=0;
let v_contador=0;
if exists(select * from ta_11_locales where oficina=parm_ofn and num_mercado=parm_mer and categoria=parm_cat
            and seccion=parm_sec and local=parm_loc) then
     foreach
     select id_local,oficina,num_mercado,categoria,seccion,local,letra_local,bloque into v_id,v_ofn,v_mer,v_cat,v_sec,v_loc,v_let,v_blq 
                from ta_11_locales where oficina=parm_ofn
	and num_mercado=parm_mer and categoria=parm_cat
	and seccion=parm_sec and local=parm_loc
     if v_let is null then
        let v_letra1='';
     else
        let v_letra1=v_let;
     end if;
     if v_blq is null then
        let v_bloque1='';
     else
        let v_bloque1=v_blq;
     end if;
     if  (v_letra1=trim(parm_let) and v_bloque1=trim(parm_blq)) then
         let v_contador=v_contador+1;
         foreach
         select c.id_local,c.oficina,c.num_mercado,c.categoria,c.seccion,c.local,c.letra_local,c.bloque,c.nombre,c.descripcion_local,c.superficie,
	c.vigencia,nvl(sum(a.importe),0),count(a.id_adeudo_local),e.descripcion,count(b.id_control) into v_id_local,v_oficina,v_mercado,v_categoria,v_seccion,v_local,v_letra,v_bloque,v_nombre,v_adicional,v_superficie,v_vigencia,
v_adeudo,v_cuantos,v_nom_mercado,v_folios
	from ta_11_locales c, outer ta_11_adeudo_local a,ta_11_mercados e,outer ta_15_apremios b
	where c.id_local=v_id
--	where c.oficina=parm_ofn
--	and c.num_mercado=parm_mer
--	and c.categoria=parm_cat
--	and c.seccion=parm_sec
--	and c.local=parm_loc
	and a.id_local=c.id_local
	and ((a.axo=year(today) and a.periodo<=month(today)) or (a.axo<year(today)))
	and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado
	and b.modulo=11 and b.control_otr=c.id_local
	and b.vigencia='1' and b.clave_practicado='P'
	group by c.id_local,c.oficina,c.num_mercado,c.categoria,c.seccion,c.local,c.letra_local,c.bloque,c.nombre,
                               c.descripcion_local,c.superficie,c.vigencia,e.descripcion
                order by c.oficina,c.num_mercado,c.categoria,c.seccion,c.local,c.letra_local,c.bloque
	    let v_per=0;
	    let v_porc=0;
                    if  v_vigencia<>'A' then
                        let v_pago=3;
                        let v_descripcion='BAJA DE LOCAL';
                    else
                    if  v_cuantos > 1 then
                        let v_pago=4;
                        let v_descripcion='LOCAL CON ADEUDO ANTERIOR A MES ACTUAL';
                    else
                    if  v_cuantos=0 then
                        if exists(select * from ta_11_pagos_local where id_local=v_id_local and axo=year(today) and periodo=month(today)) then 	
	            select id_local,axo,periodo,folio into v_id_localp,v_axop,v_periodop,v_partida from ta_11_pagos_local
                                          where id_local=v_id_local
                                          and axo=year(today) and periodo=month(today);
                            if  substr(v_partida, 1, 6)='KIOSCO' then
                                let v_pago=5;
                                let v_descripcion='MENSUALIDAD PAGADA EN '||v_partida;
                            else
                                let v_pago=6;
                                let v_descripcion='MENSUALIDAD PAGADA EN RECAUDADORA';
                            end if;
                        else
                            let v_pago=7;
                            let v_descripcion=' SIN ADEUDO, REALIZAR EL PAGO EN RECAUDADORA';
                        end if;                                    
                    else 
	        foreach
	        select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos into v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
	        from ta_11_adeudo_local a,ta_11_fecha_desc b where id_local=v_id_local
	        and b.mes=a.periodo
	        order by axo,periodo
                          if today>=v_fecha_rec then
                             let v_mes=month(today);
         	             let v_axo=year(today);
	             foreach	
	             select sum(porcentaje_mes) into v_porc from ta_12_recargos 
	                where ( (axo>v_axo or (mes>=v_mes and axo=v_axo)) and
                                (axo<v_axo or (mes<=v_mes and axo=v_axo)))
		let v_recargos=trunc(v_aimporte*v_porc)/100;
	             end foreach;	
      	          else
                          if month(today)=1 then
                             let v_axo=year(today)-1;
                             let v_mes=12; 
                          else
                             let v_axo=year(today);
                             let v_mes=month(today)-1;
                          end if;
                          end if;
	          if v_aaxo=year(today) and v_aperiodo=month(today) then
  	             if today>v_fecha_desc then
      		let v_renta=v_aimporte;
		let v_pago=0;
		if today>=v_fecha_rec then
      		   let v_descripcion='RENTA NORMAL CON RECARGOS';
		else
      		   let v_descripcion='RENTA NORMAL';
		end if;
   	             else
      		let v_renta=v_aimporte-(v_aimporte*.10);
      		let v_descripcion='RENTA CON 10% DE DESC. PRIMEROS 5 DIAS HABILES';
		let v_pago=0;
   	             end if;
	          else
                            let v_pago=4;
                            let v_descripcion='LOCAL CON ADEUDO ANTERIOR A MES ACTUAL';	                  
	          end if;
	        end foreach;
	        if v_folios>0 then
   	           let v_descripcion='LOCAL CON REQUERIMIENTOS PAGAR EN RECAUDADORAS';
	           let v_pago=1;  
	        end if;
                    end if;
                    end if;
                    end if;
         end foreach;
     else
         if  v_contador=0 then
             let v_pago=2;
             let v_descripcion='NO EXISTE LOCAL';
         end if;
         end if;
     end foreach;
else
   let v_pago=2;
   let v_descripcion='NO EXISTE LOCAL';
end if;
return v_pago,v_id_local,v_oficina,v_mercado,v_categoria,v_seccion,v_local,v_letra,v_bloque,v_nombre,v_adicional,
     v_superficie,v_renta,v_recargos,v_nom_mercado,v_descripcion
with resume;
end procedure;

CREATE PROCEDURE "informix".spd_12_pag_adquira (
	p_transm		integer,
	p_ref		char(40),
	p_fecha		date,
	p_idrec		smallint,
	p_caja		char(2),
	p_operacion	integer,
	p_importe		money(12,2),
	p_estado		char(1),
	p_usu		integer,
	p_emailadm	char(30),
	p_idcliente	integer,
	p_telefono	char(20),
	p_email		char(30),
	p_tiptarjeta	smallint,
	p_idbanco	integer,
	p_codigoseg	smallint,
	p_tarjcredeb	smallint,
	p_mesessint	smallint,
	p_periodosint	smallint,
	p_digest		char(50),
	p_moneda	smallint,
	p_idnegocio	smallint,
	p_tipopago	smallint,
	p_servicio	smallint,
	p_track2		char(50),
	p_accion		char(11),
	p_nombret	char(30),
	p_axot		smallint,
	p_mest		smallint,
	p_numtarjeta	char(30),	
	p_movimiento	char(1))

returning	integer;	-- regresa la transmision

define	idtransm		integer;
define	estatus		integer;

let estatus=0;
let idtransm=0;


if  p_movimiento='I' then
    begin
    on exception
         let estatus=1;
    end exception;
--         if  not exists(select * from ta_12_adquira where referencia=p_ref and fecha=p_fecha) 
             insert into ta_12_adquira values(0,p_ref,p_fecha,p_idrec,p_caja,0,p_importe,'V',p_usu,current,p_emailadm,p_idcliente,p_telefono,p_email,p_idbanco,p_codigoseg,p_mesessint,	p_periodosint,p_digest,p_moneda,p_idnegocio,p_tipopago,p_servicio,p_track2,p_nombret,p_axot,p_mest,p_numtarjeta,p_tiptarjeta,p_tarjcredeb,p_accion);
             let idtransm=dbinfo("sqlca.sqlerrd1");
--         else
--            select transm into idtransm from ta_12_adquira where referencia=p_ref and fecha=p_fecha and id_rec=p_idrec and caja=p_caja and operacion=0;
--         end if;
      end;
end if;

if  p_movimiento='P' then
    begin
    on exception
         let estatus=1;
    end exception;
         if  exists(select * from ta_12_adquira where transm=p_transm and referencia=p_ref and fecha=p_fecha and id_rec=p_idrec and caja=p_caja and operacion=0) then
             update ta_12_adquira set operacion=p_operacion,estado='P',telefono=p_telefono,email=p_email,tipo_tarjeta=p_tiptarjeta,id_banco=p_idbanco,codigo_seg=p_codigoseg,
			tarj_credeb=p_tarjcredeb,meses_sint=p_mesessint,periodo_sint=p_periodosint,digest=p_digest,track2=p_track2,
			nombret=p_nombret,axot=p_axot,mest=p_mest,num_tarjetat=p_numtarjeta,importe=p_importe
                         where transm=p_transm and referencia=p_ref and fecha=p_fecha and id_rec=p_idrec and caja=p_caja and operacion=0 and estado='V';
             let idtransm=p_transm;
          end if;
     end;
end if;

if  p_movimiento='C' then
    begin
    on exception
         let estatus=1;
    end exception;
         if  exists(select * from ta_12_adquira where transm=p_transm and referencia=p_ref ) then
             update ta_12_adquira set accion=p_accion where transm=p_transm and referencia=p_ref;
             let idtransm=p_transm;
          end if;
     end;
end if;

return idtransm;
end procedure;

CREATE PROCEDURE "informix".spd_12_rentacaj(
                                                       axo_par    smallint,
                                                       cat_par     smallint,
                                                       sec_par    char(2),
                                                       ccuo_par  smallint,
                                                       sup_par    decimal(7,2))
                                                      returning money(10,2);
define  vimporte money(10,2);
let vimporte=0;
   select (importe_cuota * sup_par) into vimporte
   from ta_11_cuo_locales
        where axo=axo_par and categoria=cat_par and seccion=sec_par and  clave_cuota=ccuo_par;
   if   sec_par ='PS' and ccuo_par<>4 then
        let vimporte=(vimporte)*30;
   end if;
return vimporte;
end procedure;

CREATE PROCEDURE "informix".spd_13_liquidacion(
                             par_mes   smallint)
                             returning   decimal(5,3),
                                              smallint,
                                              money(15,2),
                                              money(15,2);

define vparmetros1        decimal(5,3);
define vparperiodo1       smallint;
define vparmetros        decimal(5,3);
define vparperiodo       smallint;
define vparimporte            money(15,2);
define vparimpterec          money(15,2);
define  ind                   smallint;
define  fija                   smallint;

create temp table ta_temp (
 vpmetros1        decimal(5,3),
 vpperiodo1       smallint,
 vpimporte            money(15,2),
 vpimpterec          money(15,2)
);


foreach
     select * into vparmetros from ta_13_medidas
     let ind=year(today);
     let vparperiodo=(year(today) - 5); 
     let fija=(ind-2008)+1;
     let fija=(ind-2008)+1;


     while ind>=vparperiodo
      insert into ta_temp select  vparmetros , vparperiodo, (sum(trunc((cuota1* (vparmetros)), 2))) , (sum(trunc((trunc((cuota1* (vparmetros)), 2) * (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=par_mes))/100), 2)) ) 
       from ta_13_rcmcuotas  where cementerio="G" and axo_cuota between vparperiodo and (ind-fija);
       if vparperiodo>=2008 then
       update ta_temp set vpimporte=(0),
      vpimpterec=(0)
      where vpmetros1=vparmetros and vpperiodo1=vparperiodo;
end if;
if   vparperiodo<2008 then 
     update ta_temp set vpimporte=vpimporte+(select sum((cuota1* (1))) from ta_13_rcmcuotas  where cementerio="G" and axo_cuota between 2008 and ind) , 
	   vpimpterec=vpimpterec+(select (sum(trunc((trunc((cuota1* (1)), 2) * (select  sum(porcentaje_global) from ta_13_recargosrcm where (axo=axo_cuota and mes=par_mes))/100), 2)) )
	       from ta_13_rcmcuotas  where cementerio="G" and axo_cuota between 2008 and ind) where vpmetros1=vparmetros and vpperiodo1=vparperiodo;
end if;
if   vparperiodo>2007 then 
     update ta_temp set vpimporte=vpimporte+(select sum((cuota1* (1))) from ta_13_rcmcuotas  where cementerio="G" and axo_cuota between vparperiodo and ind) , 
	   vpimpterec=vpimpterec+(select (sum(trunc((trunc((cuota1* (1)), 2) * (select  sum(porcentaje_global) from ta_13_recargosrcm where (axo=axo_cuota and mes=par_mes))/100), 2)) )
	       from ta_13_rcmcuotas  where cementerio="G" and axo_cuota between vparperiodo and ind) where vpmetros1=vparmetros and vpperiodo1=vparperiodo;
end if;
     let vparperiodo=(vparperiodo)+(1);
end while;
end foreach;
foreach
select  vpmetros1 ,vpperiodo1 , vpimporte , vpimpterec   into vparmetros1,vparperiodo1,vparimporte, vparimpterec  from ta_temp order by 1,2
return   vparmetros1,vparperiodo1,vparimporte, vparimpterec with resume;
  end foreach;  

drop table ta_temp;
end procedure;

CREATE PROCEDURE "informix".spd_15_afec_apr(
parm_id_usuario smallint)
returning  integer,
	integer,
               char(1),
               char(1),
               smallint,
               smallint,
               smallint,
               integer,  
               smallint,
               smallint;
define v_id_control integer;
define v_folio integer;
define v_vigencia char(1);
define v_prac char(1);
define v_modulo smallint;
define v_rec smallint; 
define v_periodos smallint;
define v_control_otr integer;
define v_ayo smallint;
define v_per smallint;
foreach							 		               	
      select a.id_control,a.folio,a.vigencia,a.clave_practicado,a.modulo,a.zona,count(b.id_control) into v_id_control,v_folio,v_vigencia,v_prac,v_modulo,v_rec,v_periodos
             from ta_15_apremios a,ta_15_periodos b
             where (a.folio between 5928 and 6865)  
             and a.modulo=11 
             and a.zona=1 
             and a.vigencia='1' 
             and a.clave_practicado='P'
             and b.control_otr=a.id_control
             group by a.id_control,a.folio,a.vigencia,a.clave_practicado,a.modulo,a.zona
             having count(b.id_control)=1
             order by a.folio
             foreach
             select control_otr,ayo,periodo into v_control_otr,v_ayo,v_per
	          from ta_15_periodos  where control_otr=v_id_control
	          if v_ayo=2006 and v_per=10 then
                              update ta_15_apremios set vigencia='3',observaciones='OFICIO D.I. 4121/2006' where id_control=v_id_control;
                              return v_id_control,v_folio,v_vigencia,v_prac,v_modulo,v_rec,v_periodos,v_control_otr,v_ayo,v_per
	              with resume;
	          end if;
             end foreach; 
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_16_cobaseo_s ( p_Control_Contrato Integer, 
                                                               Num_Kiosco Integer, 
                                                               fechap_kiosco Date, 
                                                               hora_kiosco varchar(10), 
                                                               transaccion_kiosco Integer, 
                                                               cantidad money(12,2), 
                                                               clave_pago char(1) )
	returning smallint, Money(12,2), Money(12,2);  -- campos de importe total de adeudos y recargos

  define v_Ctrol_Apremios, v_Lineas_Folios      			Integer;
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato      		Integer;
  define v_Detalle_Apremios 					varchar(120);
  define v_Recargos, v_Adeudos 				Money(12,2);

  define v_Aso, v_Mes                  				varchar(4);
  define Mes_v, Dia_v					varchar(4);

  define v_id_control, v_modulo, v_control_otr, v_folio  		Integer;
  define v_importe_multa, v_importe_gastos			Money(12,2);

  define v_aso_mes_pago             Date;
  define v_importe                         Money(12,2);
  define v_exedencias	     Smallint;

  define v_Importe_recargo					Money(12,2);

  define v_Periodo_1, v_Periodo_2				varchar(7);

       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

       if Day(Current) > Dia_v then
          Let v_Periodo_1 = Year(Current)||'-'||Month(Current);
          Let v_Periodo_2 = Year(Current)||'-'||(Month(Current) - 1);
       else
          Let v_Periodo_1 = '1900-12';
          Let v_Periodo_2 = Year(Current)||'-'||(Month(Current) - 1);
       end if;
------------------------------- Localiza el Contrato
       Select control_contrato, num_contrato, ctrol_aseo
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo
       From ta_16_contratos
       Where Control_Contrato = p_Control_Contrato;

------------------------------- Pone como pagados los adeudos CUOTA NORMAL
                        if exists(Select  status_vigencia,  fecha_hora_pago,  id_rec,  caja,  consec_operacion,  folio_rcbo,  usuario
     		From ta_16_pagos
     		Where  Control_Contrato = p_Control_Contrato and  Ctrol_Operacion = 6 
          		     and  aso_mes_pago = (v_Periodo_1)
          		     and  Status_Vigencia = 'V') then
                           update ta_16_pagos set 
                              	 status_vigencia = 'P',
	              	 fecha_hora_pago = Current Year to Minute,
		 id_rec = 0,
		 caja = ' ',
		 consec_operacion = Transaccion_Kiosco,
		 folio_rcbo = 'Ksk - '||Num_Kiosco,
		 usuario = 0
     		Where  Control_Contrato = p_Control_Contrato and  Ctrol_Operacion = 6 
          		     and  aso_mes_pago = (v_Periodo_1)
          		     and  Status_Vigencia = 'V';
                         end if;
------------------------------- Pone como pagados los adeudos EXEDENCIAS
                        if exists(Select  status_vigencia,  fecha_hora_pago,  id_rec,  caja,  consec_operacion,  folio_rcbo,  usuario
     		From ta_16_pagos
     		Where  Control_Contrato = p_Control_Contrato and  Ctrol_Operacion = 7 
          		     and  aso_mes_pago = (v_Periodo_2)
          		     and  Status_Vigencia = 'V') then
                           update ta_16_pagos set 
                              	 status_vigencia = 'P',
	              	 fecha_hora_pago = Current Year to Minute,
		 id_rec = 0,
		 caja = ' ',
		 consec_operacion = Transaccion_Kiosco,
		 folio_rcbo = 'Ksk - '||Num_Kiosco,
		 usuario = 0
     		Where  Control_Contrato = p_Control_Contrato and  Ctrol_Operacion = 7 
          		     and  aso_mes_pago = (v_Periodo_2)
          		     and  Status_Vigencia = 'V';
                         end if;
------------------------------- Pone como pagados los adeudos CONTENEDORES
                        if exists(Select  status_vigencia,  fecha_hora_pago,  id_rec,  caja,  consec_operacion,  folio_rcbo,  usuario
     		From ta_16_pagos
     		Where  Control_Contrato = p_Control_Contrato and  Ctrol_Operacion = 8 
          		     and  aso_mes_pago = (v_Periodo_2)
          		     and  Status_Vigencia = 'V') then
                           update ta_16_pagos set 
                              	 status_vigencia = 'P',
	              	 fecha_hora_pago = Current Year to Minute,
		 id_rec = 0,
		 caja = ' ',
		 consec_operacion = Transaccion_Kiosco,
		 folio_rcbo = 'Ksk - '||Num_Kiosco,
		 usuario = 0
     		Where  Control_Contrato = p_Control_Contrato and  Ctrol_Operacion = 8 
          		     and  aso_mes_pago = (v_Periodo_2)
          		     and  Status_Vigencia = 'V';
                         end if;

       Insert into ta_pagos_kiosco values
                       (0, Num_Kiosco, fechap_kiosco, hora_kiosco, transaccion_kiosco, 16, p_Control_Contrato, cantidad, 0,0,0,0,' ',0,clave_pago);

end procedure;

CREATE PROCEDURE "informix".spd_16_conaseo_s ( p_Mod Char(2), p_Control_contrato Integer)
	returning Integer,             -- Control de Porcedimiento 
                                                        -- 0 = Procede con Adeudo 
                                                        -- 1 = No Procede por Req. Pend.  
                                                        -- 2 = No Existe el Contrato  
                                                        -- 3 = No tiene Adeudos vigentes
                               Integer,             -- Control de Contrato
                               Money(12,2),    -- Importe de Adeudo
                               Money(12,2),    -- Importe de Recargos
                               Integer,             -- Numero de contrato
                               varchar(15),      -- tipo de Aseo
                               varchar(80),      -- Nombre
                               varchar(80),      -- Domicilio
                               varchar(50),      -- Datos de Recoleccion
                               varchar(150);      -- Periodo de Cobro

  define v_Lineas_Folios      					Integer;
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato      		Integer;
  define v_Detalle_Apremios 					varchar(120);
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_cantidad_recolec					Integer;
  define v_tipo_recolec					varchar(20);
  define v_Recargos, v_Adeudos 				Money(12,2);

  define v_Aso, v_Mes, v_Mes_x                  				varchar(4);
  define Mes_v, Dia_v					varchar(4);
  define v_Periodo						varchar(9);
  define Aso_Hoy						varchar(4);
  define Mes_Hoy						varchar(2);
  define v_Periodo_1, v_Periodo_2, v_Periodo_3			varchar(7);

  define v_id_control, v_modulo, v_control_otr, v_folio  		Integer;
  define v_importe_multa, v_importe_gastos			Money(12,2);

  define v_aso_mes_pago             Date;
  define v_importe                         Money(12,2);
  define v_exedencias	     Smallint;
  define v_Detalle_CN                  varchar(200);
  define v_Detalle_EX                  varchar(200);
  define v_Detalle_CO                  varchar(200);

  define v_fecha_ini 					Date;
  define v_fecha_inicio					Date;

  define registros, reg_CN, reg_EX, reg_CO			smallint;

  define v_Importe_recargo					Money(12,2);
  define v_Status						Integer;
  Let v_Status = -1;
       Let v_Control = 0;
  
----------------------EXISTE ?

 If exists(Select * From ta_16_contratos
                where control_contrato = p_Control_contrato ) then

       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      Let v_Periodo_1 = Year(Current) || '-' || Month(Current);
      if Month(Current) = 1 then
         Let v_Periodo_2 = Year(Current) - 1||'-12';
      else
         Let v_Periodo_2 = Year(Current) || '-' || Month(Current) - 1;
      end if;

      if Day(Current) > Dia_v then
         Let v_Periodo_3 = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_3 = Year(Current) - 1||'-12';
          else
             Let v_Periodo_3 = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, a.aso_mes_oblig
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_fecha_ini
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.control_contrato = p_Control_contrato
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec;

     Let registros = 0;
     Let reg_CN = 0;
     Let reg_EX = 0;
     Let reg_CO = 0;

     Let v_Lineas_Folios = 0;

                foreach
                     Select id_control, modulo, control_otr, folio, importe_multa, importe_gastos
                       Into v_id_control, v_modulo, v_control_otr, v_folio, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = v_Control
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
           		Let v_Lineas_Folios = v_Lineas_Folios + 1;
                end foreach;
                   if v_Lineas_Folios > 0 then
		return 1,v_Control, 0, 0, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, 
                                           'RECOLECCION DE : ' || v_cantidad_recolec || '  ' || v_tipo_recolec, 'Tiene Requerimientos pendientes, pasar a recaudadora a verificacion';
                   else
		-------------------------------------CONSULTA DE CUOTA NORMAL
             		Let v_Detalle_CN = 'CN-';
             		Let v_Adeudos = 0;
             		Let v_Recargos = 0;
             		Let v_importe = 0;
             		Let v_Importe_recargo = 0;
                	foreach
    		Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_1)
          		     and H.Status_Vigencia = 'V'
		Order By h.aso_mes_pago

                                   if v_importe <> 0 then
                                       if reg_CN = 0 then
                                      	Let v_fecha_ini = v_aso_mes_pago;
                                       end if;
                                       if v_importe <> 0 then
                                       	Let reg_CN = reg_CN + 1;
                                       end if;
                                   end if;

                                   Let v_Adeudos = v_Adeudos + v_importe;
                                   Let v_Detalle_CN = v_Detalle_CN||v_Periodo;
  
       		        if Year(v_aso_mes_pago) < Year(Current) then
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
       		        else
       			if Month(v_aso_mes_pago) < Mes_v then
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
       			else
        			      if Day(Current) > Dia_v then
                                                            Select sum(porc_recargo) 
   			                Into v_Importe_recargo
                                                            From ta_16_recargos 
                                                                  Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				       if v_Importe_recargo <> 0 then
     		   		          Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                          let registros = registros + 1;
  				       end if;
        			      end if;
       			end if;
                                        
       		        end if;
                	end foreach;
		-------------------------------------CONSULTA DE EXEDENCIAS
             		Let v_Detalle_EX = 'EX-';
                	foreach
    		Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 7 
          		     and H.aso_mes_pago <= (v_Periodo_2)
          		     and H.Status_Vigencia = 'V'
		Order By h.aso_mes_pago


                                if v_importe <> 0 then
                                   Let v_Adeudos = v_Adeudos + v_importe;
                                   Let v_Detalle_EX = v_Detalle_EX||v_Periodo;
                                   if reg_EX = 0 then
                                      if v_fecha_ini < v_aso_mes_pago then
                                         Let v_fecha_ini = v_aso_mes_pago;
                                      end if;
                                   end if;
                                   Let reg_EX = reg_EX + 1;
                                else
                                   Let v_Detalle_EX = ' ';
                                end if;

       		        if Year(v_aso_mes_pago) < Year(Current) then
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
       		        else
       			if Month(v_aso_mes_pago) < Mes_v then
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
       			else
        			      if Day(Current) > Dia_v then
                                                            Select sum(porc_recargo) 
   			                Into v_Importe_recargo
                                                            From ta_16_recargos 
                                                                  Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				       if v_Importe_recargo <> 0 then
     		   		          Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                          let registros = registros + 1;
  				       end if;
        			      end if;
       			end if;
                                        
       		        end if;
                	end foreach;
		-------------------------------------CONSULTA DE CONTENEDORES
             		Let v_Detalle_CO = 'CO-';
                	foreach
    		Select h.aso_mes_pago, h.importe, h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 8 
          		     and H.aso_mes_pago <= (v_Periodo_2)
          		     and H.Status_Vigencia = 'V'
		Order By h.aso_mes_pago

                                if v_importe <> 0 then
                                   Let v_Adeudos = v_Adeudos + v_importe;
                                   Let v_Detalle_CO = v_Detalle_CO||v_Periodo;
                                   if reg_CO = 0 then
                                      if v_fecha_ini < v_aso_mes_pago then
                                         Let v_fecha_ini = v_aso_mes_pago;
                                      end if;
                                   end if;
                                   Let reg_CO = reg_CO + 1;
                                else
                                   Let v_Detalle_CO = ' ';
                                end if;

       		        if Year(v_aso_mes_pago) < Year(Current) then
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
       		        else
       			if Month(v_aso_mes_pago) < Mes_v then
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
       			else
        			      if Day(Current) > Dia_v then
                                                            Select sum(porc_recargo) 
   			                Into v_Importe_recargo
                                                            From ta_16_recargos 
                                                                  Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_3);
  				       if v_Importe_recargo <> 0 then
     		   		          Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                          let registros = registros + 1;
  				       end if;
        			      end if;
       			end if;
                                        
       		        end if;
                	end foreach;
	       -------------------------------------  SUMA DE ADEUDOS
                       if (v_Adeudos + v_Recargos) > 0 then
		return 0,v_Control, v_Adeudos, v_Recargos, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, 'RECOLECCION DE : ' || v_cantidad_recolec || '  ' || v_tipo_recolec, registros||' ADEUDOS VIGENTES comprendidos entre los periodos del ' ||Year(v_fecha_ini)||'-'||Month(v_fecha_ini)||'  y  '||Year(Current)||'-'||Month(Current)||'  '||reg_CN||' Cuota Normal, '||reg_EX||' Exedencias, '||reg_CO||' Contenedores';
                       else
		return 3,v_Control, v_Adeudos, v_Recargos, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, 
                             'RECOLECCION DE : ' || v_cantidad_recolec || '  ' || v_tipo_recolec, 'NO TIENE ADEUDOS VIGENTES';
                       end if;

                   end if;

 Else
	return 2,v_Control, 0, 0, 0, ' ', ' ', ' ', ' ', 'No existe el contrato';
 End if;

end procedure;

CREATE PROCEDURE "informix".spd_16_gencontrato(	par_Contrato Integer,
				par_Ctrol_aseo Integer,
				par_Emp Integer,
				par_Ctrol_emp Integer,
				par_Ctrol_recolec Integer,
				par_Cant_recolec Smallint,
                                                                par_Dom char(80),
                                                                par_Sector char(1),
                                                                par_Ctrol_zona Integer,
				par_id_rec Smallint,
				par_Vigencia char(1),
				par_Fec_obl Date,
				par_Cve char(1),
				par_Usuario Integer)

	returning Integer;  -- Dato de retorno : Control de contrato
                define v_Control_contrato Integer;

	insert into ta_16_Contratos
		values(0, par_Contrato, par_Ctrol_aseo, par_Emp, par_Ctrol_emp, par_Ctrol_recolec, par_Cant_recolec, par_Dom, 
                                            par_Sector, par_Ctrol_zona, par_id_rec, current year to minute, par_Vigencia, par_Fec_obl, par_Cve, par_Usuario, null);

	select      Control_contrato
		into v_Control_contrato
		from ta_16_contratos
		where
		Num_Contrato=par_Contrato and Ctrol_aseo = par_Ctrol_aseo;
	return v_Control_contrato;
end procedure;

CREATE PROCEDURE "informix".spd_17_a_p400_cont(
parm_id_usuario  integer)
returning smallint,
               smallint;
define    v_control integer;
define    v_colonia smallint;
define    v_calle smallint;
define    v_folio   integer;
define    v_fecha_pago date;
define    v_oficina_pago smallint;
define    v_caja_pago  char(1);
define    v_oper_pago integer;
define    v_pago_parc smallint;
define    v_total_parc smallint;
define    v_importe  money(10,2);
define    v_cve_descuento smallint;
define    v_cve_bonificacion smallint;
define    v_id_usuario integer;
define    v_actual date;
define    v_Incons smallint;
define    v_inserta smallint;
define    v_modifica smallint;
define    v_t_reg smallint;
let v_inserta=0;
let v_modifica=0;
foreach
   select a.*,b.id_convenio into v_colonia,v_calle,v_folio,v_fecha_pago,v_oficina_pago,v_caja_pago,v_oper_pago,v_pago_parc,
        v_total_parc,v_importe,v_cve_descuento,v_cve_bonificacion,v_id_usuario,v_actual,v_control from ta_17_paso_p_400 a,ta_17_convenios b
        where a.colonia=b.colonia and a.calle=b.calle and a.folio=b.folio
   if not exists( select * from ta_17_pagos
                where fecha_pago=v_fecha_pago and oficina_pago=v_oficina_pago and caja_pago=v_caja_pago and operacion_pago=v_oper_pago) then
           insert into ta_17_pagos   values(0,v_control,v_fecha_pago,v_oficina_pago,v_caja_pago,v_oper_pago,v_pago_parc,v_total_parc,v_importe,
                 v_cve_descuento,v_cve_bonificacion,v_id_usuario,current);
                 let v_inserta=v_inserta + 1;
   else
           update ta_17_pagos set  id_convenio=v_control,pago_parcial=v_pago_parc,total_parciales=v_total_parc,importe=v_importe,
                 cve_descuento=v_cve_descuento,cve_bonificacion=v_cve_bonificacion,id_usuario=v_id_usuario,fecha_actual=current
                 where fecha_pago=v_fecha_pago and oficina_pago=v_oficina_pago and caja_pago=v_caja_pago and operacion_pago=v_oper_pago; 
                 let v_modifica=v_modifica + 1;
  end if; 
end foreach;
return v_inserta,v_modifica;
end procedure;

CREATE PROCEDURE "informix".spd_17_act_pag(
parm_id_usuario  integer,
parm_id_conv_resto integer)
returning smallint;
define    v_id_conv_resto integer;
define    v_tipo smallint;
define    v_id_conv_diver integer;
define    v_fecha_inicio date;
define    v_pago_inicio money(10,2);
define    v_pago_parcial money(10,2);
define    v_pago_final money(10,2);
define    v_total_pagos smallint;
define    v_tipo_pago char(1);
define    v_parcialidad smallint;
define    v_parc smallint;
define    v_importe  money(10,2);
define    v_fecha_pvenc date;
define    v_id_usuario integer;
define    v_cont smallint;
define    v_inserta smallint;
define    v_modifica smallint;
define    v_axo smallint;
define    v_mes smallint;
define    v_dia smallint;
define    v_c_pago char(1);
define    v_c_parcial char(1);
let v_c_pago='P';
let v_c_parcial='P';
let v_inserta=0;
let v_modifica=0;
foreach
   select b.id_conv_resto,b.tipo,b.id_conv_diver,b.fecha_inicio,b.cantidad_inicio,b.pago_parcial,b.pago_final,b.total_pagos,b.tipo_pago into v_id_conv_resto,v_tipo,v_id_conv_diver,v_fecha_inicio,v_pago_inicio,v_pago_parcial,v_pago_final,v_total_pagos,v_tipo_pago  from ta_17_con_reg_pred a,ta_17_conv_d_resto b
        where a.tipo=14 and a.tipo=b.tipo and a.id_conv_predio=b.id_conv_diver and b.id_conv_resto=parm_id_conv_resto
    let v_parc=0;
    let v_parcialidad=0; 
    let v_id_usuario=parm_id_usuario;
    let v_dia=day(v_fecha_inicio);      
    let v_mes=month(v_fecha_inicio);
    let v_axo=year(v_fecha_inicio);
    if  v_pago_inicio>0 then
        let v_parc=v_parc + 1;
    end if;
    if v_pago_final>0 then
       let v_parc=v_parc + 1;
    end if;
    let v_parc=v_parc + v_total_pagos;
    for v_cont= 1 to v_parc
         if  v_mes=12 then
             let v_mes=1;
             let v_axo=v_axo + 1;
         else
             if  v_cont=1 then
                 let v_mes=v_mes;
             else
                 let v_mes=v_mes + 1;
             end if; 
         end if;
         if  v_cont=1 and v_pago_inicio>=1 then
             let v_importe=v_pago_inicio;
             let v_parcialidad=0;
             let v_fecha_pvenc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"');
         else
         if  (v_cont>=1 and v_cont<=v_total_pagos) and v_pago_parcial>=1 then
             let v_importe=v_pago_parcial;
             let v_parcialidad=v_parcialidad + 1;
             let v_fecha_pvenc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"');
         else
             let v_importe=v_pago_final;
             let v_parcialidad=30;
             let v_fecha_pvenc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"');
        end if;
        end if;
         if exists( select a.* from ta_17_conv_pagos a
where a.id_conv_resto=parm_id_conv_resto and a.pago_parcial=v_parcialidad
and a.id_conv_resto not in (select id_conv_resto from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and pago_parcial=a.pago_parcial)
and a.pago_parcial not in (select pago_parcial from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and pago_parcial=a.pago_parcial)
) then
        insert into ta_17_adeudos_div  values(0,v_id_conv_resto,v_parcialidad,v_importe,v_fecha_pvenc,v_id_usuario,current,v_c_pago,v_c_parcial);
          let v_inserta=v_inserta + 1;
        end if; 
   end for;
end foreach;
return v_inserta;
end procedure;

CREATE PROCEDURE "informix".spd_17_calc_fechav(
parm_colonia  integer,
parm_calle smallint,
parm_folio smallint,
parm_fecha_inicio date,
parm_parcialidad smallint,
parm_tipo char(1))
returning integer,
               date;
define    v_id_convenio integer;
define    v_colonia smallint;
define    v_calle smallint;
define    v_folio   integer;
define    v_fecha_firma date;
define    v_fecha_venc date;
define    v_axo smallint;
define    v_mes smallint;
define    v_dia smallint;
define    v_parc_vencimiento smallint;
define    v_cont  smallint;
foreach
   select id_convenio into v_id_convenio from ta_17_convenios
        where colonia=parm_colonia and calle=parm_calle and folio=parm_folio 
    let v_fecha_firma=parm_fecha_inicio;
    let v_parc_vencimiento=parm_parcialidad;
   if  v_fecha_firma is null then
       let v_fecha_venc=v_fecha_firma;
   else
   if  parm_tipo='M' then
       let v_dia=day(v_fecha_firma);      
       let v_mes=month(v_fecha_firma);
       let v_axo=year(v_fecha_firma);
       for v_cont= 1 to v_parc_vencimiento 
            if  v_mes=12 then
                let v_mes=1;
                let v_axo=v_axo + 1;
            else
                let v_mes=v_mes + 1;
            end if;
       end for;
      if v_dia = 31 then
         if  (v_mes = 4 or v_mes =6 or v_mes =9 or v_mes =11) then   
             let v_dia=30;
         else
         if v_mes = 2 then  
            let v_dia = 28;
         end if;
         end if;
       end if;
      if v_dia = 30 then
         if v_mes = 2 then  
            let v_dia = 28;
         end if;
         end if;
      if v_dia = 29 then
         if v_mes = 2 then  
            let v_dia = 28;
         end if;
         end if;
       let v_fecha_venc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"'); 
   else
   if  parm_tipo='Q' then
       let v_fecha_venc=v_fecha_firma;
       for v_cont= 1 to v_parc_vencimiento 
             let v_fecha_venc=v_fecha_venc+15;
       end for;
   else
   if  parm_tipo='S' then
       let v_fecha_venc=v_fecha_firma;
       for v_cont= 1 to v_parc_vencimiento 
             let v_fecha_venc=v_fecha_venc+7;
       end for;
   end if;
   end if;
   end if;
   end if;
end foreach;
return v_id_convenio,v_fecha_venc;
end procedure;

CREATE PROCEDURE "informix".spd_17_cons_conv (
parm_modulo smallint,
parm_id_referencia  integer)
returning  smallint,
                smallint,
                smallint,
	integer,
	char(1),
	date,
	smallint,
	char(1),
	integer,
	smallint,
	smallint,
	money(10,2),
	money(10,2),
	char(8),
	date;
define v_tipo smallint;
define v_subtipo smallint;
define v_axo_exp smallint;
define v_numero_exp integer;
define v_cve_parcial char(1);
define v_fecha date;
define v_oficina smallint;
define v_caja char(1);
define v_operacion integer;
define v_pago_pacial smallint;
define v_total_parcial smallint;
define v_importe_pago money(10,2);
define v_importe_rec money(10,2);
define v_usuario char(8);
define v_fecha_actual date;
foreach
     select c.tipo,c.subtipo,c.axo_exp,c.numero_exp,e.cve_parcialidad,d.fecha_pago,d.oficina_pago,d.caja_pago,d.operacion_pago,d.pago_parcial,d.total_parciales,d.importe_pago,d.importe_recargo,f.usuario,d.fecha_actual into v_tipo,v_subtipo,v_axo_exp,v_numero_exp,v_cve_parcial,v_fecha,v_oficina,v_caja,v_operacion,v_pago_pacial,v_total_parcial,v_importe_pago,v_importe_rec,v_usuario,v_fecha_actual
from ta_17_referencia a,ta_17_conv_d_resto b,ta_17_conv_diverso c,ta_17_conv_pagos d,ta_17_adeudos_div e,ta_12_passwords f
    where a.modulo=parm_modulo
    and a.id_referencia=parm_id_referencia
    and b.id_conv_resto=a.id_conv_resto 
    and c.id_conv_diver=b.id_conv_diver 
    and d.id_conv_resto=a.id_conv_resto
    and e.id_conv_resto=a.id_conv_resto
    and e.pago_parcial=d.pago_parcial 
    and f.id_usuario=d.id_usuario
    order by d.fecha_pago,d.oficina_pago,d.caja_pago,d.operacion_pago
return v_tipo,v_subtipo,v_axo_exp,v_numero_exp,v_cve_parcial,v_fecha,v_oficina,v_caja,v_operacion,v_pago_pacial,v_total_parcial,v_importe_pago,v_importe_rec,v_usuario,v_fecha_actual
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_17_ctapub_grec(
parm_rec smallint,
parm_fondo smallint)
returning smallint,
               integer,
               money(10,2),
               char(50);
define    v_control integer;
define    v_tipo smallint;
define    v_axo smallint;
define    v_colonia smallint;
define    v_calle smallint;
define    v_folio   integer;
define    v_vigencia char(1);
define    v_costo money(10,2);
define    v_pagos_ing money(10,2);
define    v_pagos_dev money(10,2);
define    v_pagos_dif money(10,2);
define    v_pagos_real money(10,2); 
define    v_saldo_real money(10,2);
define    v_desc_col char(50);
define    v_desc_tipo char(50); 
define    v_id_pago integer;
define    v_id_conv_dev integer;
define    v_cve_descuento smallint;
define    v_cve_bonificacion smallint;
define    v_contador smallint;
define    v_cont smallint;
define    v_id_rec smallint;
define    v_costo_g money(10,2);
define    v_pagos_ing_g money(10,2);
define    v_pagos_dev_g money(10,2);
define    v_pagos_dif_g money(10,2);
define    v_pagos_real_g money(10,2);
define    v_saldo_real_g money(10,2);
define    v_contratos integer;
define    v_contratos_g integer;
let v_contratos_g=0;
let v_costo_g=0;
let v_pagos_ing_g=0;
let v_pagos_dev_g=0;
let v_pagos_dif_g=0;
let v_pagos_real_g=0; 
let v_saldo_real_g=0;
let v_pagos_ing=0;
let v_pagos_dev=0;
let v_pagos_dif=0;
let v_pagos_real=0; 
let v_saldo_real=0;
let v_contador=0;
let v_contratos=0;
foreach
   select a.tipo,d.id_rec,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,b.pago_total,sum(c.importe),count(c.id_convenio),sum(c.cve_descuento),d.descripcion,e.descripcion,b.vigencia into  v_tipo,v_id_rec,v_axo,v_control,v_colonia,v_calle,v_folio,v_costo,v_pagos_ing,v_contador,v_cve_descuento,v_desc_col,v_desc_tipo,v_vigencia
             from ta_17_calles a,ta_17_convenios b,outer(ta_17_pagos c),ta_17_colonias d,ta_17_tipos e
            where a.tipo=parm_fondo 
                and d.id_rec=parm_rec
                and a.colonia=b.colonia and a.calle=b.calle
                and b.vigencia='A'
                and b.id_convenio=c.id_convenio
                and a.colonia=d.colonia
                and a.tipo=e.tipo
            group by a.tipo,d.id_rec,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,b.pago_total,d.descripcion,e.descripcion,b.vigencia
            order by b.colonia,b.calle,b.folio
            if   v_pagos_ing is null then
                 let v_pagos_ing=0;
            end if;
            let v_pagos_dev=0;
            foreach
            select id_convenio,sum(importe) into v_id_conv_dev,v_pagos_dev
                     from ta_17_devoluciones where id_convenio=v_control
            group by id_convenio     
            end foreach;
            if   (v_contador = 1 and v_cve_descuento = 20) or (v_axo < 1995 and v_cve_descuento = 20) then
                 if  v_pagos_dev > 0 then
                     let v_pagos_dif=0;
                 else    
                     let v_pagos_dif=v_costo - v_pagos_ing;
                 end if;
            else
                 let v_pagos_dif=0; 
            end if;
            let v_pagos_real=((v_pagos_ing - v_pagos_dev) + v_pagos_dif);
            let v_saldo_real=v_costo - v_pagos_real;
            if   v_saldo_real>0 then
                 let v_contratos=1;
            else
                 let v_contratos=0;
            end if;
            let v_contratos_g=v_contratos_g+v_contratos;
            let v_costo_g=v_costo_g+v_costo;
            let v_pagos_ing_g=v_pagos_ing_g+v_pagos_ing;
            let v_pagos_dev_g=v_pagos_dev_g+v_pagos_dev;
            let v_pagos_dif_g=v_pagos_dif_g+v_pagos_dif;
            let v_pagos_real_g=v_pagos_real_g+v_pagos_real;
            let v_saldo_real_g=v_saldo_real_g+v_saldo_real; 
--return v_id_rec,v_contratos,v_costo,v_pagos_real,v_saldo_real,v_desc_tipo
--with resume;
end foreach;
return v_id_rec,v_contratos_g,v_saldo_real_g,v_desc_tipo;
end procedure;

CREATE PROCEDURE "informix".spd_17_graba_desg(
parm_id_usuario  integer)
returning smallint;
define    v_id_adeudo integer;
define    v_id_conv_resto integer;
define    v_pago_parcial smallint;
define    v_importe  money(10,2);
define    v_cuenta_apl integer;
define    v_cont smallint;
define    v_inserta smallint;
let v_inserta=0;
let v_cuenta_apl=23302;
foreach
   select id_adeudo,id_conv_resto,pago_parcial,importe into v_id_adeudo,v_id_conv_resto,v_pago_parcial,v_importe 
        from ta_17_adeudos_div
        where clave_pago='P'
        order by id_adeudo
        insert into ta_17_desg_parcial values(0,v_id_adeudo,v_importe,v_cuenta_apl,parm_id_usuario,current);
        let v_inserta=v_inserta + 1;
end foreach;
return v_inserta;
end procedure;

CREATE PROCEDURE "informix".spd_abcrbokio(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parImporte 	money(15,2),
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parId_cuentacat 	integer,
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta      	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parId_usuario	integer,
                                par_importe            money(15,2),
                                par_impAnt            money(15,2),
                                par_imprecar           money(15,2),
                                par_impgast            money(15,2),
                                par_impmulta            money(15,2)
		)
		returning integer;

		define varOperacion integer;

 define varuap_rcm  integer;
 define varaplica      integer;
 define varpar          smallint;
 define varlinea   	smallint;
 define varsuma           money(15,2);
 define vardiferencia    money(15,2);
 define vardescripcion char(40);
let varOperacion = 0;
let varlinea = 0;
let vardiferencia = 0.00;
let varsuma=0.00;
	select nvl(max(operacion),0) + 1
		into varOperacion 
		from ta_12_rboski2
		where 	id_rec=parId_rec and
			caja=parCaja;

	insert into ta_12_rboski2 values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		'P',5,
    		parId_cuentacat,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		null,null,null,null,null,
    		parId_usuario,
		current);
		
if par_importe>0  then
  let varlinea = varlinea+1;
  if parRegmunur = 'U' then
    let varaplica = 40401;
  else
    let varaplica = 40402;
  end if;
   let vardescripcion = 'Predial';
		insert into ta_12_rboskiDet2 values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
		varLinea,
    		varDescripcion,
		varaplica,
		par_Importe);

end if;
if par_impant>0  then
  let varlinea = varlinea+1;
  if parRegmunur = 'U' then
    let varaplica = 40403;
  else
    let varaplica = 40404;
  end if;
   let vardescripcion = 'Predial anterior';
		insert into ta_12_rboskiDet2 values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
		varLinea,
    		varDescripcion,
		varaplica,
		par_Impant);

end if;
if par_imprecar>0  then
  let varlinea = varlinea+1;
  if parRegmunur = 'U' then
    let varaplica = 46202;
  else
    let varaplica = 46204;
  end if;
   let vardescripcion = 'Recargos';
		insert into ta_12_rboskiDet2 values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
		varLinea,
    		varDescripcion,
		varaplica,
		par_Imprecar);

end if;
if par_impgast>0  then
   let varlinea = varlinea+1;  
   let varaplica = 46580;
   let vardescripcion = 'Gastos ejecucion';
		insert into ta_12_rboskiDet2 values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
		varLinea,
    		varDescripcion,
		varaplica,
		par_Impgast);

end if;
if par_impmulta>0  then
   let varlinea = varlinea+1;
   let varaplica = 46317;
   let vardescripcion = 'Multa';
		insert into ta_12_rboskiDet2 values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
		varLinea,
    		varDescripcion,
		varaplica,
		par_Impmulta);

end if;
let varsuma = par_importe+par_impant+par_imprecar+par_impgast+par_impmulta;
let vardiferencia=parimporte-varsuma;
if vardiferencia<> 0 then
   if vardiferencia>0  then
      let varaplica = 46902;
   else  
      let varaplica = 25012;
   end if;
   let varlinea = varlinea+1;
   let vardescripcion = 'Ajuste Art. 22 ley de Ingresos';
		insert into ta_12_rboskiDet2 values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
		varLinea,
    		varDescripcion,
		varaplica,
		vardiferencia);
end if;

return varOperacion;
end procedure;

CREATE PROCEDURE "informix".spd_abcrecibosdet(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parLinea		smallint,
    		parDescripcion 	varchar(60),
		parCuenta	integer,
		parImporte 	money(15,2),
		parOpc char(1)
		)
		returning integer;

		define varOk integer;

--set debug file to "d:\publico\marco.log";
--trace on;

--inicializa la variable correcto 0=no inserto ,1=inserto
let varOk = 1;

--si la opcion fue insertar
if 	parOpc='I' then
	
	insert into ta_12_recibosDet values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		parOperacion,
		parLinea,
    		parDescripcion,
		parCuenta,
		parImporte);

end if;

return varOk;
--trace off;

end procedure;

CREATE PROCEDURE "informix".spd_abcrecibosdiv(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo 	integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta      	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia     	smallint,
		parObra                 smallint,
		parAxofolio               integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                                Partipo_che            smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc char(1)
		)
		returning integer;

		define varOperacion integer;
 define varuap_rcm  integer;
 define varpar  smallint;


--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;

--si la opcion fue insertar
if 	parOpc='I' then
	
	insert into ta_12_recibosdiv values(0,
    		parFecha,
    		parId_rec,
    		parCaja,
    		parOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current);
              let varOperacion=dbinfo("sqlca.sqlerrd1");
end if;
	


return varOperacion;

end procedure;

CREATE PROCEDURE "informix".spd_adeudoaseo ()
	returning Integer,             -- Control de Porcedimiento 0 = Procede 1,2,3 = No Procede
                               Integer,             -- Control de Contrato
                               Money(12,2),    -- Importe de Adeudos
                               Money(12,2),    -- Importe de Recargos
                               Money(12,2),    -- Importe de Gastos
                               Money(12,2),    -- Importe de Multas
                               Money(12,2),    -- Importe de Total
                               Integer,             -- Numero de contrato
                               varchar(15),      -- tipo de Aseo
                               varchar(80),      -- Nombre
                               varchar(80),      -- Domicilio
                               varchar(50),      -- Datos de Recoleccion
                               varchar(150);      -- Periodo de Cobro


  define v_Ctrol_Apremios, v_Lineas_Folios      			Integer;
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato      		Integer;
  define v_Detalle_Apremios 					varchar(120);
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_cantidad_recolec					Integer;
  define v_tipo_recolec					varchar(20);
  define v_Recargos, v_Adeudos 				Money(12,2);

  define v_Aso, v_Mes, v_Mes_x                  			varchar(4);
  define Mes_v, Dia_v					varchar(4);
  define v_Periodo						varchar(9);
  define v_Periodoex					varchar(150);
  define v_Periodono					varchar(150);
  define Aso_Hoy						varchar(4);
  define Mes_Hoy						varchar(2);
  define v_Periodo_CN, v_Periodo_EXE				varchar(7);

  define v_id_control, v_modulo, v_control_otr, v_folio  		Integer;
--  define v_importe_multa		Money(12,2);
  define v_TOT_Ade		Money(12,2);
  define v_TOT_Ade1		Money(12,2);
  define v_TOT_Ade2		Money(12,2);
  define v_TOT_Exe		Money(12,2);
  define v_TOT_Exe1		Money(12,2);

  define v_aso_mes_pago             Date;
  define v_aso_mes_pago2             Date;
  define v_importe                         Money(12,2);
  define v_exedencias	     Smallint;
  define v_texedencias	     int;
  define v_Detalle_CN                  varchar(200);
  define v_Detalle_EX                  varchar(200);
  define v_Detalle_CO                  varchar(200);
  define v_mensaje                       varchar(250);

  define v_fecha_ini 					Date;
  define v_fecha_inicio					Date;

  define registros, reg_CN, reg_EX, reg_CO			smallint;

  define v_Importe_recargo					Money(12,2);
  define v_Importe_Gastos					Money(12,2);
 define v_Importe_Multas					Money(12,2);
  define v_Importe_Total					Money(12,2);

define v_x1                  char(10);
define v_x2                 char(10);
define v_y1                  char(10);
define v_y2                  char(10);
define v_z1                  char(10);
define v_z2                  char(10);
define v_status                  char(1);
define v_zona                  smallint;
define v_subzona                  smallint;

define v_pernormin                   date; -- Periodo normal de Cobro
define v_pernormax                   date; -- Periodo normal de Cobro
define v_perexemin                    date; -- Periodo exedente de Cobro
define v_perexemax                    date; -- Periodo exedente de Cobro
define v_perconmin                    date; -- Periodo exedente de Cobro
define v_perconmax                    date; -- Periodo exedente de Cobro


create temp table AdeduoAseo(
tidcontrol                         Integer,             -- Control de Contrato
tnumero                          Integer,             -- Numero de contrato
ttipo                               varchar(15),      -- tipo de Aseo
tnombre                               varchar(80),      -- Nombre
tdomicilio                               varchar(80),      -- Domicilio
tadeudo                          Money(12,2),    -- Importe de Adeudos
trecargos                        Money(12,2),    -- Importe de Recargos
tgastos                           Money(12,2),    -- Importe de Gastos
tmultas                           Money(12,2),    -- Importe de Multas
ttotal                               Money(12,2),    -- Importe de Total
trequer	 		integer,
tcantidadre 		integer,
tcantidadex 		integer,
trecoleccion                               varchar(50),      -- Datos de Recoleccion
tpernormin                    char(10), -- Periodo de Cobro
tpernormax                     char(10), -- Periodo de Cobro
tperexemin                     char(10), -- Periodo de Cobro
tperexemax                     char(10), -- Periodo de Cobro
tperconmin                     char(10), -- Periodo de Cobro
tperconmax                     char(10), -- Periodo de Cobro
tstatus                             char(1),
tzona                              smallint,
tsubzona                              smallint,
tmensaje			varchar(250)
);

let v_Ctrol_Apremios=0;
let  v_Lineas_Folios =0;
let  v_Control=0;
let  v_Ctrol_Aseo=0;
let  v_Num_Contrato=0;
let v_cantidad_recolec=0;
let  v_Recargos=0;
let  v_Adeudos=0;
let  v_id_control=0;
let  v_modulo=0;
let  v_control_otr=0;
let  v_folio=0;
let  v_importe=0;
let  v_exedencias=0;
let  v_texedencias=0;
let  registros=0;
let  reg_CN=0;
let  reg_EX=0;
let  reg_CO=0;
let  v_Importe_recargo=0;
let  v_Importe_Gastos=0;
let  v_Importe_Multas=0;
let  v_Importe_Total=0;
let v_TOT_Ade=0;
let v_TOT_Ade1=0;
let v_TOT_Ade2=0;
let v_TOT_Exe=0;
let v_TOT_Exe1=0;

       Select Mes,     Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);

      if Day(Current) > Dia_v then
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
          	if Mes_Hoy   = 1 then    	Let v_Periodo_EXE = Year(Current) - 1||'-11';  end if;
          	if Mes_Hoy   = 2 then    	Let v_Periodo_EXE = Year(Current) - 1||'-12';  end if;
          	if Mes_Hoy >= 3 then    	Let v_Periodo_EXE = Year(Current)     ||'-'|| Month(Current) - 2;  end if;
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

----------------------------------------------------- VERIFICA SI EXISTE EL CONTRATO A CONSULTA DE LO CONTRARIO MENSAJE DE NO LOCALIZACION
foreach
         --             BUSCO EL CONTRATO
                     Select a.control_contrato, a.num_contrato, a.ctrol_aseo,   b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec,   d.descripcion,   a.aso_mes_oblig,a.status_vigencia,z.zona,z.sub_zona
          	      Into  v_Control,                v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre,       v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_fecha_ini, v_status,v_zona,v_subzona 
                      From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d,ta_16_zonas z
                     where b.ctrol_aseo = a.ctrol_aseo
                          and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
                          and d.ctrol_recolec = a.ctrol_recolec and a.ctrol_zona=z.ctrol_zona
----------------------------------------------------- BUSCO SI TIENE REQUERIMIENTOS PENDIENTES
  Let registros = 0;
  Let reg_CN = 0;
  Let reg_EX = 0;
  Let reg_CO = 0;
let   v_mensaje='';
  Let v_Lineas_Folios = 0;
  Let v_Ctrol_Apremios = 0;
                     	Select nvl(sum(importe_multa),0), nvl(sum(importe_gastos),0), count(*)
                       	Into v_importe_multas,        v_importe_gastos,     v_Lineas_Folios 
                      	from ta_15_apremios
                       	Where modulo = 16  And control_otr = v_Control
                       	And vigencia = "1" and clave_practicado = "P";
if v_Lineas_Folios > 0 then
   Let v_Ctrol_Apremios = 1;
let   v_mensaje='Tiene Requerimientos pendientes, pasar a recaudadora a verificacion';
end if;
			-------------------------------------  CONSULTA DE ADEUDOS DE CUOTA NORMAL
                            Let v_Detalle_CN = 'CN-';
                            Let v_Adeudos = 0;
                            Let v_Recargos = 0;
             	            Let v_importe = 0;
             	            Let v_Importe_recargo = 0;

                            foreach
    		Select h.aso_mes_pago, h.importe,   h.exedencias, Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', '
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V'
		Order By h.aso_mes_pago

                                   if v_importe <> 0 then
                                       if reg_CN = 0 then
                                      	Let v_fecha_ini = v_aso_mes_pago;
                                       end if;
                                       if v_importe <> 0 then
                                       	Let reg_CN = reg_CN + 1;
                                       end if;
                                   end if;

                                  Let v_Adeudos = v_Adeudos + v_importe;
                                   Let v_Detalle_CN = v_Detalle_CN||v_Periodo;
                                                    	Select sum(porc_recargo) 
   			    	    Into v_Importe_recargo
                                                    	From ta_16_recargos 
                                                           		Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);
  					if v_Importe_recargo <> 0 then
     		   		   		Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   		Let registros = registros + 1;
  					end if;
                            end foreach;

   		Select min(h.aso_mes_pago),max(h.aso_mes_pago),sum(h.importe)
        		    Into v_pernormin,               v_pernormax,               v_TOT_Ade
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V';
		



			------------------------------------- CONSULTA DE EXEDENCIAS
             	            Let v_Detalle_EX = 'EX-';
	            let v_texedencias=0;	
                            foreach
    		Select h.aso_mes_pago,  h.importe,  h.exedencias, (Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', ')
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 7 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V'
		Order By h.aso_mes_pago

                                if v_importe <> 0 then
                                   Let v_Adeudos = v_Adeudos + v_importe;
                                   Let v_Detalle_EX = v_Detalle_EX||v_Periodo;
                                   if reg_EX = 0 then
                                      if v_fecha_ini < v_aso_mes_pago then
                                         Let v_fecha_ini = v_aso_mes_pago;
                                      end if;
                                   end if;
                                   Let reg_EX = reg_EX + 1;
                                else
                                   Let v_Detalle_EX = ' ';
                                end if;

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);       
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
                            end foreach
   		Select min(h.aso_mes_pago),max(h.aso_mes_pago),sum(h.importe), sum(h.exedencias)
        		    Into v_perexemin,              v_perexemax,               v_TOT_Ade1,  v_TOT_Exe
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 7 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V';
			------------------------------------- CONSULTA DE CONTENEDORES
                            Let v_Detalle_CO = 'CO-';
                            foreach
    		Select h.aso_mes_pago,  h.importe,  h.exedencias, (Year(h.aso_mes_pago) || '-' || Month(h.aso_mes_pago) || ', ')
        		    Into v_aso_mes_pago, v_importe, v_exedencias, v_Periodo
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 8 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V'
		Order By h.aso_mes_pago

                                if v_importe <> 0 then
                                   Let v_Adeudos = v_Adeudos + v_importe;
                                   Let v_Detalle_CO = v_Detalle_CO||v_Periodo;
                                   if reg_CO = 0 then
                                      if v_fecha_ini < v_aso_mes_pago then
                                         Let v_fecha_ini = v_aso_mes_pago;
                                      end if;
                                   end if;
                                   Let reg_CO = reg_CO + 1;
                                else
                                   Let v_Detalle_CO = ' ';
                                end if;

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);
  				if v_Importe_recargo <> 0 then
     		   		   Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
                                                                   let registros = registros + 1;
  				end if;
                            end foreach
   		Select min(h.aso_mes_pago), max(h.aso_mes_pago), sum(h.importe), sum(h.exedencias)
        		    Into v_perconmin,               v_perconmax,               v_TOT_Ade2,   v_TOT_Exe1
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 8 
          		    and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V';

	if v_Adeudos <> 0 then
	   let v_importe_total=v_adeudos+v_recargos+v_importe_gastos+v_importe_multas;
	   let v_texedencias=v_TOT_Exe+v_TOT_Exe1;
	   let v_x1=year(v_pernormin) || '-'||month(v_pernormin);
	   let v_x2=year(v_pernormax) ||'-' ||month(v_pernormax);
	   let v_y1=year(v_perexemin) ||'-' ||month(v_perexemin);
	   let v_y2=year(v_perexemax) ||'-' ||month(v_perexemax);
	   let v_z1=year(v_perconmin) ||'-' ||month(v_perconmin);
	   let v_z2=year(v_perconmax) ||'-' ||month(v_perconmax);
insert into AdeduoAseo values(v_control,v_num_contrato, v_tipo_aseo, v_nombre,v_domicilio,v_adeudos,v_recargos,v_importe_gastos,v_importe_multas,v_importe_total,
v_Lineas_Folios, v_cantidad_recolec,v_texedencias,v_tipo_recolec,v_x1,v_x2,v_y1,v_y2,v_z1,v_z2,v_status,v_zona,v_subzona,v_mensaje);
   end if;

end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_adeudos(var_cem char(01),var_clase smallint, var_clasalf varchar(10,0),
                                                  var_secc smallint, var_seccalf varchar(10,0),
                                                  var_linea smallint, var_linalf varchar(10,0),var_fosa smallint, var_fosalf varchar(10,0))
                             returning  integer, 
                                             money(15,2),
                                              money(15,2);


define v_uap    integer;
define v_axo    integer;
define v_mes   smallint;
define v_metros decimal(5,3);
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_cem char(1);

create temp table ta_adercm(
axo        smallint,
importe  money(15, 2),
recargos money(15, 2));


let v_axo=year(today);
let v_mes=month(today); 

foreach
select  axo_pagado,metros,cementerio into v_uap,v_metros,v_cem from ta_13_datosrcm where cementerio=var_cem and 
        clase=var_clase and clase_alfa=var_clasalf and seccion=var_secc and seccion_alfa=var_seccalf and
        linea=var_linea and linea_alfa=var_linalf and fosa=var_fosa and fosa_alfa=var_fosalf
         insert into ta_adercm select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from               ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and v_axo;
end foreach;
foreach
select  axo,importe ,recargos   into vpar_axo,vpar_impte, vpar_recar  from ta_adercm
return   vpar_axo,vpar_impte, vpar_recar with resume;
 end foreach;  

drop table ta_adercm;
end procedure;

CREATE PROCEDURE "informix".spd_adeudosmasivo() 
                                                
                             returning  char(1), 
                                             integer, 
                                             money(15,2),
                                              money(15,2);


define v_uap    integer;
define v_axo    integer;
define v_mes   smallint;
define v_metros decimal(5,3);
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define var_cem char(1);
define var_con integer;



let v_axo=year(today);
let v_mes=month(today); 

foreach
select  control_rcm, axo_pagado,metros,cementerio into var_con,v_uap,v_metros,var_cem from ta_13_datosrcm where axo_pagado<2007 
         insert into ta_adercmmas select var_con,b.cementerio,b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from               ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=var_cem and b.axo_cuota between v_uap and v_axo;
end foreach;
foreach
select  cementer,axo,sum(importe) ,sum(recargos)   into var_cem,vpar_axo,vpar_impte, vpar_recar  from ta_adercmmas
group by 1,2
order by 1,2
return   var_cem,vpar_axo,vpar_impte, vpar_recar with resume;
 end foreach;  
-- drop table ta_adercm;
end procedure;

CREATE PROCEDURE "informix".spd_adeudosnum(var_control integer)
                                                
                             returning  integer, 
                                             money(15,2),
                                              money(15,2);


define v_uap    integer;
define v_axo    integer;
define v_mes   smallint;
define v_metros decimal(5,3);
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define var_cem char(1);

create temp table ta_adercm(
axo        smallint,
importe  money(15, 2),
recargos money(15, 2));

let v_axo=year(today);
let v_mes=month(today); 

foreach
select  axo_pagado,metros,cementerio into v_uap,v_metros,var_cem from ta_13_datosrcm where control_rcm=var_control
         insert into ta_adercm select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from               ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=var_cem and b.axo_cuota between v_uap and v_axo;
end foreach;
foreach
select  axo,importe ,recargos   into vpar_axo,vpar_impte, vpar_recar  from ta_adercm
return   vpar_axo,vpar_impte, vpar_recar with resume;
 end foreach;  
drop table ta_adercm;
end procedure;

CREATE PROCEDURE "informix".spd_arecibosdetdv(
    		parid_recibo 	integer,
    		parLinea		smallint,
    		parDescripcion 	varchar(60),
		parCuenta	integer,
		parImporte 	money(15,2),
		parOpc char(1)
		)
		returning integer;

		define varOk integer;

--inicializa la variable correcto 0=no inserto ,1=inserto
let varOk = 1;

--si la opcion fue insertar
if 	parOpc='I' then
	
	insert into ta_12_recibosdetdv values(0,
    		parid_recibo,
		parLinea,
    		parDescripcion,
		parCuenta,
		parImporte);

end if;

return varOk;

end procedure;

CREATE PROCEDURE "informix".spd_borra_ingreso(par_fecha date,par_rec int)

{######################################################################
#  Procedimiento: spd_Borra_ingreso
#  Descripcion:   Borra Ingreso por recaudadora y dia
#  Parametros  
#  de entrada:    fecha del ingreso y recaudadora
#  Parametros 
#  de salida:       mensaje de aviso
#  Elaboro:        Sandra Teresa Aranda Garcia
#
#
#  Modifico: 
#  Fecha:           30/11/2010
#  Acci�n:      Borra los registros que involucran el ingreso
######################################################################}


RETURNING 
	INTEGER,
	VARCHAR ( 255 );

DEFINE v_lError INTEGER;
DEFINE v_lISAMError INTEGER;   ----indicador del error
DEFINE v_vcMensaje VARCHAR ( 255 );  --- mensaje del error

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje

	RETURN -1, 'spd_borra_ingreso ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

 delete from CG_12_importes where
   fecing=par_fecha and recing=par_rec;

delete from CG_12_ingreso where fecing=par_fecha
   and recing= par_rec;

delete from CG_12_maestras where fecing=par_fecha
     and recing= par_rec;

RETURN 0, 'INGRESO BORRADO';

end procedure;

CREATE PROCEDURE "informix".spd_estatitulos( par_fecha   date,
                                                    par_axom    integer)
	returning   char(01),
                                 smallint,
                                 char(02),
                                 money(15,2),
                                char(60),
                               char(60);

 define vparTipo  		char(01);
 define vparTitulo  		smallint;
 define vparCapitulo 	char(02);
 define vparDescripT	char(60);
 define vparDescripC	char(60);
 define vparImporteMen 	money(15,2);
                                               
foreach
SELECT 'I', b.titulo, b.capitulo,nvl (sum(a.importe),0),c.desc_titulo,c.desc_capitulo  
  into      vparTipo, vparTitulo, vparCapitulo,vparImporteMen,vparDescripT,vparDescripC
  from ta_12_ingresoanual a , ta_12_cuentas b,ta_12_titulos c
 where a.axo_mes=par_axom and a.cta_aplicacion=b.cta_aplicacion and c.titulo=b.titulo and c.capitulo=b.capitulo
group by b.titulo, b.capitulo,5,6
UNION  all
SELECT 'A', b.titulo,b.capitulo,nvl (sum(a.importe_ajuste),0),desc_titulo ,c.desc_capitulo
from ta_12_ajustes a , ta_12_cuentas b, ta_12_titulos c
 where year(a.fecha_ajuste)=year(par_fecha)  and month(a.fecha_ajuste)=month(par_fecha) and a.cta_aplicacion=b.cta_aplicacion and c.titulo=b.titulo and c.capitulo=b.capitulo
group by b.titulo, b.capitulo,5,6
order by 2,4

return   	vparTipo,vparTitulo,vparCapitulo,vparImporteMen,vparDescripT,vparDescripC 
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_pagofaltantes2(
    		parFecha	                date)
	               	returning    integer,
	               	                  integer;

 define vparFecha  		date;
 define vparRec	 	smallint;
 define vparCaja	 	char(2);
 define vparOper	 	integer;
 define vparImporte  	money(15,2);
 define vparControl	  	integer; 
 define vparMay	  	smallint; 
 define vparSub1	  	smallint;
 define vparSub2	  	smallint;
 define vparSub3	  	integer;
 define vparSuma	  	integer;
 define vparSuma2	  	integer;
  let vparSuma=0;
  let vparSuma2=0;

foreach
select a.fecing,a.recing,cajing,opcaja,totcertificado, (nvl((a.cuenta_id * 1),0)),numero,obra,colonia,axofol  into
vparFecha,vparRec,vparCaja,vparOper,vparImporte,vparControl,vparMay,vparSub1,vparSub2,vparSub3
 from ta_12_ingreso a
  where a.fecing=parfecha  and 
 (select count(*) from ta_12_importes where a.fecing =fecing and a.recing = recing and  a.cajing =cajing and
  a.opcaja = opcaja and cta_aplicacion =14006)>0 
 if vparcontrol>0 then
  if not exists (select *  from ta_12_pagodfalt  where fecing=vparFecha and recing=vparRec and cajing=vparCaja and opcaja=vparOper
                 and control_fal=vparControl)   then 
 
   insert into ta_12_pagodfalt  values(vparFecha,vparRec,vparCaja,vparOper,vparImporte,vparControl,1,vparMay,vparSub1,vparSub2,vparSub3,0,2,today);
     let vparSuma2=(vparSuma2)+(1);
  else
     let vparSuma=(vparSuma)+(1);
end if;
end if;
end foreach;
return   	vparSuma2,vparSuma
with resume;
end procedure;

CREATE PROCEDURE "informix".spd_pagosfaltantes(
    		parFecha	                date,
    		parRec     	smallint,		
                                parUsu     	integer)
	               	returning    integer,
	               	                  integer;

 define vparFecha  		date;
 define vparRec	 	smallint;
 define vparCaja	 	char(2);
 define vparOper	 	integer;
 define vparImporte  	money(15,2);
 define vparControl	  	integer; 
 define vparMay	  	smallint; 
 define vparSub1	  	smallint;
 define vparSub2	  	smallint;
 define vparSub3	  	integer;
 define vparSuma	  	integer;
 define vparSuma2	  	integer;
  let vparSuma=0;
  let vparSuma2=0;

foreach
select a.fecing,a.recing,cajing,opcaja,totcertificado, (nvl((a.cuenta_id * 1),0)),numero,obra,colonia,axofol  into
vparFecha,vparRec,vparCaja,vparOper,vparImporte,vparControl,vparMay,vparSub1,vparSub2,vparSub3
 from ta_12_ingreso a
  where a.fecing=parfecha and a.recing =parRec and 
 (select count(*) from ta_12_importes where a.fecing =fecing and a.recing = recing and  a.cajing =cajing and
  a.opcaja = opcaja and cta_aplicacion =14006)>0 
 if vparcontrol>0 then
  if not exists (select *  from ta_12_pagodfalt  where fecing=vparFecha and recing=vparRec and cajing=vparCaja and opcaja=vparOper
                 and control_fal=vparControl)   then 
 
   insert into ta_12_pagodfalt  values(vparFecha,vparRec,vparCaja,vparOper,vparImporte,vparControl,1,vparMay,vparSub1,vparSub2,vparSub3,0,parUsu,today);
     let vparSuma2=(vparSuma2)+(1);
  else
     let vparSuma=(vparSuma)+(1);
end if;
end if;
end foreach;
return   	vparSuma2,vparSuma
with resume;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkiosco(
    		parcvecuenta    integer,
                paroficina      integer,
                parUR           char(1),
                parcuenta       integer,
                parImpCertificado	money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parKiosco	integer,
                parImpuestoAdeudo money(15,2),
		parImpuestoActual money(15,2),
                parRecargos        money(15,2),
                parGastos         money(15,2),
                parMultas         money(15,2),
                parredondeo       money(5,2)
)
		returning smallint , char(2), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define spoperacion   integer;
define linea integer ;
define cuenta integer;

  select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parkiosco; 

  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, parcuenta, paroficina, parur,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                parNombre, parDomicilio,'Pago de Predial por Kiosco de la cuenta ' || parcvecuenta , '',0,0,
                0,0,parkiosco,current,0,0,0,'',0,'I')
 into spoperacion;

  let varoperacion = spoperacion;
                
let linea = 1;     
if parimpuestoactual > 0 then
      if parur = 'U' then 
         let cuenta = 40401;
      else
         let cuenta = 40402;
      end if;
      insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
        'Impuesto periodo actual '  ,   cuenta,  	parimpuestoactual );
      let linea = linea + 1;
end if;

-- para impuesto anterior
if parimpuestoAdeudo  > 0 then
      if parur = 'U' then 
         let cuenta = 40403;
      else
         let cuenta = 40404;
      end if;
      insert into ta_12_recibosdet values(today,varrec , varcaja , varoperacion , linea , 
        'Impuesto periodo anterior al a�o vigente'  ,   cuenta,  	parimpuestoadeudo );
      let linea = linea + 1;
end if;
if  parrecargos > 0 then
     if parur = 'U' then 
         let cuenta = 46202;
      else
         let cuenta = 46204;
      end if;
insert into ta_12_recibosdet values(today ,varrec , varcaja , varoperacion , linea , 
 'Recargos' , cuenta, parrecargos );
let linea = linea + 1;
end if;
if  parmultas > 0 then
 insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
 'Multas' , 46317, parmultas );
let linea = linea + 1;
end if;
if  pargastos > 0 then
 insert into ta_12_recibosdet values(today,varrec , varcaja ,  varoperacion , linea , 
 'Gastos ' , 46580, pargastos );
let linea = linea + 1;
end if;
if  parredondeo > 0 then
    if (parImpCertificado - (parimpuestoactual + parimpuestoadeudo + parrecargos + pargastos+ parmultas )) > 0 then
     let cuenta = 46902;
      else
     let cuenta = 25012;
    end if;
 insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
 'Ajuste ART. 22 de ley de ingresos ' , 46580, parredondeo );
let linea = linea + 1;
end if;
return varrec, varcaja, spoperacion;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkiosco2(
    		parcvecuenta    integer,
                parImpCertificado	money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		parKiosco	integer
        )
		returning smallint , char(2), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;

--datos del predio.
select recaud , urbrus , cuenta , nombre_completo , trim(c_calle) || ' # Ext ' || TRIM(c_noexterior) || ' # Int ' || trim(c_interior)
, Trim(U_calle) || ' Ext ' || trim(u_noexterior) || ' # Int ' || trim(u_interior),
extend(current, hour to minute)  
into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion , v_hora
 from catastro_gdl@catastro_tcp:datos_gral 
where cvecuenta = parcvecuenta;

--
  select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parkiosco; 

  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial por Kiosco de la cuenta ' || parcvecuenta , '',0,0,
                0,0,parkiosco,current,0,0,0,'',0,'I')
 into spoperacion;

  let varoperacion = spoperacion;
 
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)
                
let linea = 1;     

FOREACH
execute procedure  catastro_gdl@catastro_tcp:kiosko_totalespred( parcvecuenta , parAxohasta, parMeshasta, 1) 
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 

insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );
       let linea = linea +1 ;
       let suma = suma + v_importe;
end FOREACH;
let v_redondeo = parImpCertificado - suma;
if v_redondeo <> 0 then
 if (parImpCertificado - (suma)) > 0 then
     let cuenta = 46902;
      else
     let cuenta = 25012;
    end if;
 
 insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
 'Ajuste ART. 22 de ley de ingresos ' , 46580, v_redondeo );

end if;
-- para afectar catastro del pago;
 let us = 'Kiosco ' || parkiosco;
  insert into catastro_gdl@catastro_tcp:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 1);
-- let varcvepago = dbinfo("sqlca.sqlerrd1");   


return varrec, varcaja, spoperacion;
end procedure;

CREATE PROCEDURE "informix".spd_pruebacon (vcvecuenta integer)
                           returning Char(250);
define  vreto char(250);
  


select nombre_completo into vreto from catastro_tcp@catastro2_tcp:datos_gral1 where cvecuenta = vcvecuenta;


return vreto;
end procedure;

CREATE PROCEDURE "informix".spd_rcmcons(var_control integer,v_cem char(1),v_s_origen integer,v_kiosco varchar(20))
                                    -----         linea, clave, comentario, registro cem completo,nombre, dom completo,        colonia   ,              tipo     ,     nom cementerio,CONCEPTO,imp total,periodo
                             returning  char(1),int,        varchar(100),varchar(100),       VARCHAR(60),VARCHAR(75),VARCHAR(30),VARCHAR(10),VARCHAR(60),varchar(250),money(15,2),varchar(30),
			integer, money(15,2), money(15,2),money(15,2),varchar(60);
			--axo_adeudo, importe, recargo,importe descuento, observacion
define v_uap    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);

define  v_cementerio CHAR(1);
define  v_clase SMALLINT;
define  v_clase_alfa VARCHAR(10);
define  v_seccion SMALLINT;
define  v_seccion_alfa VARCHAR(10);
define  v_linea SMALLINT;
define  v_linea_alfa VARCHAR(20);
define  v_fosa SMALLINT;
define  v_fosa_alfa VARCHAR(20);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_nombre VARCHAR(60) ;
--define  v_domicilio VARCHAR(60);
--define  v_exterior CHAR(6);
--define  v_interior CHAR(6);
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_reg_cem varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_tipodesc VARCHAR(10);
define  v_nomcem VARCHAR(60);
define  v_concepto varchar(250);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);

define v_cuenta integer;
define v_ajuste money(5,2);

let v_axo=year(today);
let v_mes=2;
---month(today); 
let v_imptot=0;
let v_concepto = '';
let v_periodo='';
let v_desctot  = 0;

select cementerio,cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
clase,clase_alfa,seccion,seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
end
into v_cementerio,v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
,v_axo_pagado,v_metros,v_nombre,v_domcompleto,v_colonia ,v_tipodesc
from ta_13_datosrcm where control_rcm=var_control and cementerio=v_cem;

select nombre into v_nomcem from tc_13_cementerios where cementerio=v_cementerio;



if not exists(select * from ta_13_datosrcm where control_rcm=var_control) then
   let v_clave = 1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   insert into rcm_web_bitacora values (var_control, v_cem, v_s_origen, v_kiosco,current,v_clave);
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,''; 
end if;      
if v_axo_pagado=v_axo  then
   let v_clave = 2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   insert into rcm_web_bitacora values (var_control, v_cem, v_s_origen, v_kiosco,current,v_clave);
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,''; 
end if;     
if v_tipodesc <>'FOSA'  then
   let v_clave = 3; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO ES FOSA, NO SE PUEDE PAGAR';
   insert into rcm_web_bitacora values (var_control, v_cem, v_s_origen, v_kiosco,current,v_clave);
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,''; 
end if;     

if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;

let v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || v_axo;
let v_concepto = 'MANTENIMIENTO DEL CEMENTERIO '|| v_nomcem || 'POR EL PERIODO '||  v_axodesde || ' - ' || v_axo || ' DE ' || v_metros || ' MTS. ';
let v_concepto = v_concepto || 'DE '|| v_clase ||' CLASE ' || v_clase_alfa || ' SECC. '|| v_seccion || ' ' || v_seccion_alfa || 'LINEA ' ||v_linea || ' ' || v_linea_alfa || ' FOSA ' || v_fosa;

let v_clave = 0; 
let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO SE PUEDE PAGAR';
insert into rcm_web_bitacora values (var_control, v_cem, v_s_origen, v_kiosco,current,v_clave);

---Para calcular el importe total
foreach 
select b.axo_cuota,((trunc((b.cuota1* (r.metros)), 2))),trunc((b.cuota1* (r.metros)), 2),d.axo_alta,nvl(d.decuento,0)
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento	
           from ta_13_rcmcuotas b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=var_control and
           d.control_rcm=r.control_rcm and d.axo_alta=b.axo_cuota and 
           b.cementerio=r.cementerio and b.axo_cuota between v_axodesde and v_axo
           order by b.axo_cuota

           select porcentaje_global into v_porc_global from   
           ta_13_recargosrcm where axo=vpar_axo and mes=v_mes;

           let vpar_recar = trunc(((vpar_recar * v_porc_global) /100),2); --importe de recargos
    let v_impdesc = 0;
    let v_recardesc = 0;
    let v_desctot = 0;
     --se aplica descuento de pesionado
     if  v_descuento <> 0 then         
           let v_impdesc = trunc(((vpar_impte * v_descuento)  / 100),2);  --descuento a impueso
           let v_recardesc = trunc(((v_recardesc * v_descuento) /100),2); --descuento a recargos
           let v_desctot  = v_desctot  + v_impdesc + v_recardesc;
     end if;
     let v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot) ; 

          --si es el a�o actual y es enero o febrero se aplica el 10% de descuento
---,v_impdesc,v_recardesc, 
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=v_axo)) then
           let v_imptot  = trunc((v_imptot * 0.9),2);
     end if;

end foreach;
--para kiosco se aplica ajuste a peso.
if v_s_origen= 2 then
   execute procedure spd_redondeokiosco(v_imptot) into v_cuenta,v_ajuste;
   let v_imptot = v_imptot + v_ajuste; 
end if;
--Regresa los datos de encabezado
 return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0, 0, 0,'' with resume; 

---Calcula los detalles
foreach 
select b.axo_cuota,((trunc((b.cuota1* (r.metros)), 2))),trunc((b.cuota1* (r.metros)), 2),d.axo_alta,nvl(d.decuento,0)
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento	
           from ta_13_rcmcuotas b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=var_control and
           d.control_rcm=r.control_rcm and d.axo_alta=b.axo_cuota and 
           b.cementerio=r.cementerio and b.axo_cuota between v_axodesde and v_axo
           order by b.axo_cuota

           select porcentaje_global into v_porc_global from   
           ta_13_recargosrcm where axo=vpar_axo and mes=v_mes;
           let vpar_recar = trunc(((vpar_recar * v_porc_global) /100),2); --importe de recargos
    let v_impdesc = 0;
    let v_recardesc = 0;
    let v_desctot = 0;
     --se aplica descuento de pesionado
     let v_obs = '';
     if  v_descuento <> 0 then         
           let v_impdesc = trunc(((vpar_impte * v_descuento)  / 100),2);  --descuento a impueso
           let v_recardesc = trunc(((v_recardesc * v_descuento) /100),2); --descuento a recargos
           let v_desctot  = v_desctot  + v_impdesc + v_recardesc;
           let v_obs = 'INCLUYE DESC. '||v_descuento||'% POR PENSIONADO'; 
     end if;
          --si es el a�o actual y es enero o febrero se aplica el 10% de descuento
---,v_impdesc,v_recardesc, 
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=v_axo)) then
           let v_desctot  = trunc((v_desctot * 0.9),2);
           if  v_obs = '' then
               let v_obs = v_obs || ' INCLUYE DESC. 10% POR PRONTO PAGO'; 
           else
               let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
           end if;
     end if;

   return 'D',v_clave,v_texto,'','','','','','','','','',vpar_axo,vpar_impte, vpar_recar, v_desctot,v_obs with resume; 

end foreach;
   --regresa el ajuste si es kiosco
   if v_s_origen= 2 then
      if v_cuenta <> 0 then    
         return 'D',v_clave,v_texto,'','','','','','','','','',0,v_ajuste,0,0,'AJUSTE ARTICULO 22 LEY DE INGRESOS'; 
     end if;
   end if;
end procedure;

CREATE PROCEDURE "informix".linea_cancpago(
    p_linea VARCHAR(50)
)
--** Para cancelacion de pago, se elimina la linea de pago
--** ESTATUS N=conciliado sin error
returning int,varchar(200);
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_modulo int;

--set debug file to "lineacap.log";
--   trace on;
--** Obtener datos de la linea de captura
--3538 4610 9610 0000 0101 8512 1278 '0000070000000000011285116291'

let v_modulo = substr(p_linea,19,2)*1;

if v_modulo = 1 then --predial
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturapred where trim(linea) = trim(p_linea)) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO EXISTE";
   end if;
   if exists (select * from linea_pagos where trim(linea) = trim(p_linea)) then
      --se borra la linea de pago, para que se pueda cargar nuevamente
	 delete from linea_pagos where trim(linea) = trim(p_linea);
         let estatus = 0;
         let mensaje = "LINEA DE PAGO DE PREDIAL CANCELADO CORRECTAMENTE";
         return estatus,mensaje;
   else
         let estatus = 1;
         let mensaje = "LINEA DE PAGO DE PREDIAL NO EXISTE";
         return estatus,mensaje;
   end if;
end if; --modulo 01 predial

if v_modulo = 2 then --TRANSMISIONES
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturatrans where trim(linea) = trim(p_linea)) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE TRANSMISION NO EXISTE";
   end if;
   if exists (select * from linea_pagos where trim(linea) = trim(p_linea)) then
      --se borra la linea de pago, para que se pueda cargar nuevamente
	 delete from linea_pagos where trim(linea) = trim(p_linea);
         let estatus = 0;
         let mensaje = "LINEA DE PAGO DE TRANSMISION CANCELADO CORRECTAMENTE";
         return estatus,mensaje;
   else
         let estatus = 1;
         let mensaje = "LINEA DE PAGO DE TRANSMISION NO EXISTE";
         return estatus,mensaje;
   end if;
end if; --modulo 02 TRANSMISIONES

if v_modulo = 8 then --Licencias
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturalic where trim(linea) = trim(p_linea)) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO NO EXISTE";
   end if;
   if exists (select * from linea_pagos where trim(linea) = trim(p_linea)) then
      --se borra la linea de pago, para que se pueda cargar nuevamente
	 delete from linea_pagos where trim(linea) = trim(p_linea);
         let estatus = 0;
         let mensaje = "LINEA DE PAGO DE LICENCIA/ANUNCIO CANCELADO CORRECTAMENTE";
         return estatus,mensaje;
   else
         let estatus = 1;
         let mensaje = "LINEA DE PAGO DE LICENCIA/ANUNCIO NO EXISTE";
         return estatus,mensaje;
   end if;
end if; --modulo 08 licencias
end procedure;

CREATE PROCEDURE "informix".linea_capturadiv(p_folio int, p_modulo int,p_total money(16,2),p_fecha date)
returning varchar(110),varchar(28);

define linea1 varchar(110);
define resultado varchar(110);
define v_codigo1 varchar(20);
define v1_7 smallint;
define v1_3 smallint;
define v1_1 smallint;
define vt1    int;
define i int;
define fecha int;
define fechax date;
define control int;
define v_id int;
define v2_11 smallint;
define v2_13 smallint;
define v2_17 smallint;
define v2_19 smallint;
define v2_23 smallint;
define vt2    int;

--set debug file to "banamex.log";
--   trace on;

let linea1 = substr((p_folio/10000000),4,6) || substr((p_modulo/10000000),4,6);

insert into linea_capturadiv (id,linea,fecha,fecha_vig,folio,modulo,total) values (0,linea1,current,null,p_folio,p_modulo,p_total);

LET v_id = dbinfo("sqlca.sqlerrd1");
--LET v_id = 999999;

let linea1 = linea1|| substr((v_id/1000000),3,6)  ;

let linea1 = linea1 || "12"; --pago de diversos

---- codifica fecha
-- let fechax = TO_DATE("26/02/2010", "%d/%m/%iY");
let fechax = p_fecha;

let fecha = ((year(fechax) - 1988) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1);
let linea1 = linea1 || fecha;

------digito verificador de importe
let v_codigo1 = trunc(p_total*100) ;
let vt1 = 0;

for i =   length(v_codigo1) to 1 step -3
  let v1_7 = 0;
  let v1_3 = 0;
  let v1_1 = 0;

  if i >= 1 then
     let v1_7 = substr(v_codigo1,i , 1)  * 7;
  end if;
  if i >= 2 then
     let v1_3 = substr(v_codigo1,(i -1) , 1)  * 3;
  end if;
  if i >= 3 then
     let v1_1 = substr(v_codigo1,(i -2), 1)  * 1;
  end if;

  let  vt1 = vt1+ v1_7 + v1_3 + v1_1;

end for;
let vt1 = mod(vt1,10);
let linea1 = linea1 || vt1;

-----controles
let control = 2; ---valida fecha e importe
let linea1 = linea1 || control;

---control global
let vt2 = 0;

for i =   length(linea1) to 1 step -5
  let v2_11 = 0;
  let v2_13 = 0;
  let v2_17 = 0;
  let v2_19 = 0;
  let v2_23 = 0;

  if i >= 1 then
     let v2_11 = substr(linea1,i , 1)  * 11;
  end if;
  if i >= 2 then
     let v2_13 = substr(linea1,(i -1) , 1)  * 13;
  end if;
  if i >= 3 then
     let v2_17 = substr(linea1,(i -2), 1)  * 17;
  end if;
  if i >= 4 then
     let v2_19 = substr(linea1,(i -3), 1)  * 19;
  end if;  
  if i >= 5 then
     let v2_23 = substr(linea1,(i -4), 1)  * 23;
  end if;
  let  vt2 = vt2+ v2_11 + v2_13 + v2_17 + v2_19 + v2_23;

end for;
let vt2 = mod(vt2,97) +1;
if vt2 < 10 then
   let linea1 = linea1 || "0" || vt2;
else
   let linea1 = linea1 || vt2;
end if;
-----divide la linea en grupos de cuatro caracteres
let resultado = "";

for i = 1 to length(linea1) step 4
   let resultado = resultado || substr(linea1,i , 4) || "   ";
end for;

--trace off;
let resultado = resultado || "     " || p_total;

update linea_capturadiv set linea = linea1, fecha_vig = fechax where id = v_id;

return resultado,linea1;

end procedure;

CREATE PROCEDURE "informix".linea_pagok(
    p_linea VARCHAR(50),
    p_recaud INT,
    p_pagado MONEY(16,2),
    p_forma_carga CHAR(1),
    p_cvepago INT,
    p_fecha_pago DATE,
    p_id_rec SMALLINT,
    p_caja CHAR(2),
    p_operacion INT,
    p_usuario CHAR(8)
)
--** PAga la linea de captura de pagos realizados en kioscos
--** p_recaud es el numero de kiosco que se le asigno en C_recaud 120+
--** Forma de carga C=Cajas Recaudadora, A=Archivo Banco k=kiosco
--** ESTATUS para linea_pago C=carga, A=aplicado, N=conciliado sin error, D=diferencia en importes 
returning int,varchar(200);
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_id int;
define v_linea VARCHAR(50);
define v_id_linea int;
define v_folio int;
define v_modulo int;
define v_id_cont int;
define v_estatus char(1);
define v_fecha_pago date;
define v_fecha_impresion datetime year to second;
define v_importe money(16,2);
define v_difimp money(16,2);
define v_cvepago char(1);
define v_importe_conc money(16,2);
define v_fecha_concilia datetime year to second;


--set debug file to "lineapagok.log";
--   trace on;
--** Obtener datos de la linea de captura
--3538 4610 9610 0000 0101 8512 1278 '0000070000000000011285116291'
--select * from linea_capturadiv where trim(linea) = trim('0000070000000000011285116291')

let v_modulo = substr(p_linea,19,2)*1;

if v_modulo = 1 then --predial
   let v_estatus = "A";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturapred where trim(linea) = trim(p_linea)) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO EXISTE";
   end if;
   --obtener los datos del registro de predial  
   select id,linea,cvecuenta,total into 
	  v_id_linea,v_linea,v_folio,v_importe
          from catastro_gdl:linea_capturapred where trim(linea) = trim(p_linea);  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pago) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pago;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pago,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pago
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pago
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
   else --si no esta cargada la linea de captura en pagos
	 let v_difimp = v_importe - p_pagado;
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pago ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,null ,null ,null ,null ,null ,null ,null ,v_estatus ,p_cvepago ,p_fecha_pago,p_id_rec ,p_caja ,p_operacion ,p_usuario);
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL ESTA APLICADA";
         return estatus,mensaje;
   end if;--no existe linea captura en pagos
end if; --modulo 01 predial
--trace off;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkio2resp(
    		parcvecuenta    integer,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		parKiosco	integer
        )
		returning smallint , char(2), integer, char(28);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_cvereq int;
define p_desde int; 
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;

--set debug file to "pagokiosco.TXT";
--trace on;
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;

 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo , 
   trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior),
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior)
   || '@CVECATASTRAL ' || CVECATNVA || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa 

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip 

  , v_hora
 from catastro_gdl:datos_gralKio a 
 where a.cvecuenta = parcvecuenta;
--  catdescrip =    v_ubicacion[1,40]  ;
--select *  from catastro_gdl:datos_gral  where cvecuenta = 265874

--
  select id_rec , caja  into varrec , varcaja
  
  from ta12_operacKiosco
  where id_usuario = parkiosco; 

  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial por Kiosco de la cuenta ' || parcvecuenta , '',0,0,
                0,0,parkiosco,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'Kiosco ' || parkiosco;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1"); 
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)
                
let linea = 1;     
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
execute procedure  catastro_gdl:kiosco_totalespred( parcvecuenta , parAxohasta, parMeshasta, 1) 
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 

insert into ta_12_recibosdet
( fecha ,id_rec , caja , operacion ,linea , descripcion , cuenta ,importe
)
  values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );
-- audioria para gastos y multas;
 if v_cuenta = 992100009 then   -- gastos
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (parcvecuenta, varcvepago, 992100009,varrec ,v_importe,
'N',0,0);
    let v_gaspag = v_importe;
end if;
if v_cuenta = 510100000 then   -- multas
  insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
   cancelacion, axopago ,  bimini)  values (parcvecuenta, varcvepago, 510100000,varrec ,v_importe,
'N',0,0);
end if;
if v_cuenta = 992100014 then   -- subsidio
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (parcvecuenta, varcvepago, 992100014,varrec ,v_importe,
'N',0,0);
end if;
       let linea = linea +1 ;
       let v_suma = v_suma + v_importe;
end FOREACH;
let v_redondeo = parImpCertificado - v_suma;
if v_redondeo <> 0 then
 if (parImpCertificado - (v_suma)) > 0 then
     let cuenta = 550800000    ; --46902;
      else
     let cuenta = 550800000    ; --25012;
    end if;
 
 insert into ta_12_recibosdet
 ( fecha ,id_rec , caja , operacion ,linea , descripcion , cuenta ,importe
)
values(today ,varrec , varcaja ,  varoperacion , linea , 
 'Ajuste ART. 22 de ley de ingresos ' , 550800000, v_redondeo );

    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (parcvecuenta, varcvepago, 550800000,varrec ,v_redondeo,
'N',0,0);

end if;

let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq , fecemi desc
        end foreach
 select   s.multa,  s.gasto,  s.multavir 
    into   v_mulpag,  v_gaspag,  v_multasvir 
      from  catastro_gdl:saldos s  where  s.cvecuenta= parcvecuenta;
  insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq) 
values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
update catastro_gdl:descmulta 
   set estado = 'P' , cvepago = varcvepago
  where cvecuenta = parcvecuenta and estado = 'V';
end if;
 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

 execute PROCEDURE catastro_gdl:linea_capturapred(parcvecuenta, p_desde , p_hasta ,
parImpCertificado, 0,0,0,parImpCertificado , today) 
into v_lineacapt, v_lineacapt2;
let estatus = 0;
execute  PROCEDURE linea_pagok(v_lineacapt2, parKiosco, parImpCertificado, 'K',varcvepago,
    today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje ;
	
return varrec, varcaja, spoperacion , v_lineacapt2;
--trace off;
end procedure;

CREATE PROCEDURE "informix".spd_17_act_cont(
parm_id_usuario  integer)
returning smallint,
               smallint,
               smallint;
define    v_id_convenio integer;
define    v_colonia smallint;
define    v_calle smallint;
define    v_folio   integer;
define    v_nombre varchar(60);
define    v_desc_calle varchar(50);
define    v_numero   varchar(11);
define    v_tipo_casa varchar(10);
define    v_mtrs_frente decimal(7,2);
define    v_mtrs_ancho decimal(7,2);
define    v_metros2  decimal(7,2);
define    v_entre_calle_1 varchar(20);
define    v_entre_calle_2 varchar(20);
define    v_pago_total money(10,2);
define    v_pago_inicial money(10,2);
define    v_pago_quincenal  money(10,2);
define    v_pagos_parciales smallint;
define    v_fecha_firma date;
define    v_fecha_venc date;
define    v_escritura varchar(10);
define    v_propiedad varchar(6);
define    v_compro_dom varchar(10);
define    v_otros varchar(30);
define    v_observacion varchar(60);
define    v_fecha_impresion date;
define    v_fecha_rev date;
define    v_fecha_cancelado date;
define    v_vigencia char(1);
define    v_recargos_conv money(10,2);
define    v_saldo_insoluto money(10,2);
define    v_descuento  smallint;
define    v_clave_historia smallint;
define    v_clave smallint;
define    v_id_usuario integer;
define    v_axo_obra smallint;
define    v_servicio smallint;
define    v_cve_plazo char(1);
define    v_vig char(1);
define    v_cont smallint;
define    v_inserta smallint;
define    v_inserta_h smallint;
define    v_modifica smallint;
define    v_axo smallint;
define    v_mes smallint;
define    v_dia smallint;
define    v_parc_vencimiento smallint;
define    v_saldoprra money(10,2);
define    v_mensualidad money(10,2);
define    v_motivo varchar(60);
define    v_mot_vig char(1);
define    v_fecha_inicio date;
define    v_fecha_fin date;
define    v_documentacion varchar(60);
define    v_h_colonia smallint;
define    v_h_calle smallint;
define    v_h_folio integer;
define    v_h_nombre varchar(60);
define    v_h_desc_calle varchar(50);
define    v_h_numero   varchar(11);
define    v_h_tipo_casa varchar(10);
define    v_h_mtrs_frente decimal(7,2);
define    v_h_mtrs_ancho decimal(7,2);
define    v_h_metros2  decimal(7,2);
define    v_h_entre_calle_1 varchar(20);
define    v_h_entre_calle_2 varchar(20);
define    v_h_pago_total money(10,2);
define    v_h_pago_inicial money(10,2);
define    v_h_pago_quincenal  money(10,2);
define    v_h_pagos_parcial smallint;
define    v_h_fecha_firma date;
define    v_h_fecha_venc date;
define    v_h_escritura varchar(10);
define    v_h_propiedad varchar(6);
define    v_h_compro_dom varchar(10);
define    v_h_otros varchar(30);
define    v_h_observacion varchar(60);
define    v_h_fecha_impre date;
define    v_h_fecha_rev date;
define    v_h_fecha_cancel date;
define    v_h_vigencia char(1);
define    v_h_recargos_conv money(10,2);
define    v_h_impobra_conv money(10,2);
define    v_impobra_conv money(10,2);
define    v_h_saldo_insoluto money(10,2);
define    v_h_descuento  smallint;
define    v_h_clave_historia smallint;
define    v_h_id_usuario integer;
define    v_h_act  date;
let v_inserta=0;
let v_inserta_h=0;
let v_modifica=0;
foreach
   select a.*,b.axo_obra,b.servicio,b.plazo,b.clave_plazo into v_colonia,v_calle,v_folio,v_nombre,v_desc_calle,v_numero,v_tipo_casa,v_mtrs_frente,
        v_mtrs_ancho,v_metros2,v_entre_calle_1,v_entre_calle_2,v_pago_total,v_pago_inicial,v_pago_quincenal,v_fecha_firma,v_escritura,
        v_propiedad,v_compro_dom,v_otros,v_observacion,v_fecha_impresion,v_fecha_rev,v_fecha_cancelado,v_clave,v_recargos_conv,
        v_saldo_insoluto,v_descuento,v_clave_historia,v_saldoprra,v_mensualidad,v_motivo,v_fecha_inicio,v_fecha_fin,v_documentacion, 
        v_impobra_conv,v_axo_obra,v_servicio,v_parc_vencimiento,v_cve_plazo 
        from ta_17_paso_cont a,ta_17_calles b
        where a.colonia=b.colonia and a.calle=b.calle 
    let v_id_usuario=parm_id_usuario;
    if  (v_colonia=115 and v_calle=1 and v_folio=10) then
        let v_pago_total=172376.71;
    end if;
    if  (v_colonia=22 and v_calle=49 and v_folio=19) then
        let v_pago_total=112823.75;
    end if;
    if  (v_colonia=64 and v_calle=15 and v_folio=1) then
        let v_pago_total=105238.12;   
    end if;
    if  (v_colonia=64 and v_calle=16 and v_folio=49) then
        let v_pago_total=122960.00;
    end if;
    if  (v_colonia=64 and v_calle=23 and v_folio=11) then
        let v_pago_total=105364.00;
    end if;
    if  v_clave_historia = 1 then
        let v_pagos_parciales=v_parc_vencimiento-1;
    else
        let v_pagos_parciales=18;
    end if;
    let v_vig=substr(v_observacion, 1, 1);
    let v_mot_vig=substr(v_motivo, 1, 1);
    if  (v_vig='@'  or v_mot_vig='@') then
        let v_vigencia='C';
    else
        let v_vigencia='A';
   end if;
   if   (v_colonia=61 and v_calle=12 and v_folio=27) then   -- por conflicto legales en 2 fincas, quitar cuando lo indique desarrollo social
        let v_vigencia='C';
   end if;
   if  v_fecha_firma is null then
       let v_fecha_venc=v_fecha_firma;
   else
   if  v_cve_plazo='M' then
       let v_dia=day(v_fecha_firma);      
       let v_mes=month(v_fecha_firma);
       let v_axo=year(v_fecha_firma);
       for v_cont= 1 to v_parc_vencimiento
            if  v_mes=12 then
                let v_mes=1;
                let v_axo=v_axo + 1;
            else
                let v_mes=v_mes + 1;
            end if;
       end for;
      if v_dia = 31 then
         if  (v_mes = 4 or v_mes =6 or v_mes =9 or v_mes =11) then   
             let v_dia=30;
         else
         if v_mes = 2 then  
            let v_dia = 28;
         end if;
         end if;
       end if;
      if v_dia = 30 then
         if v_mes = 2 then  
            let v_dia = 28;
         end if;
         end if;
      if v_dia = 29 then
         if v_mes = 2 then  
            let v_dia = 28;
         end if;
         end if;
       let v_fecha_venc=mdy(v_mes,v_dia,v_axo); -- date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"'); 
   else
       let v_fecha_venc=v_fecha_firma;
       for v_cont= 1 to v_parc_vencimiento 
             let v_fecha_venc=v_fecha_venc+15;
       end for;
   end if;
   end if;
    if  (v_colonia=22 and v_calle=49 and v_folio between 76 and 113) then
        let v_fecha_venc=mdy(2,1,2007); -- '01/02/2007';
    end if;
   if  v_clave_historia = 1 then
       if not exists( select * from ta_17_convenios
                      where colonia=v_colonia and calle=v_calle and folio=v_folio) then
        insert into ta_17_convenios  values(0,v_colonia,v_calle,v_folio,v_nombre,v_desc_calle,v_numero,v_tipo_casa,v_mtrs_frente,
            v_mtrs_ancho,v_metros2,v_entre_calle_1,v_entre_calle_2,v_pago_total,v_pago_inicial,v_pago_quincenal,
            v_pagos_parciales,v_fecha_firma,v_fecha_venc,v_escritura,v_propiedad,v_compro_dom,v_otros,
            v_observacion,v_fecha_impresion,v_fecha_rev,v_fecha_cancelado,v_vigencia,v_id_usuario,current,0,0,0,1,0);
            let v_inserta=v_inserta + 1;
        else
        update ta_17_convenios set nombre=v_nombre,desc_calle=v_desc_calle,numero=v_numero,tipo_casa=v_tipo_casa,mtrs_frente=v_mtrs_frente,
            mtrs_ancho=v_mtrs_ancho,metros2=v_metros2,entre_calle_1=v_entre_calle_1,entre_calle_2=v_entre_calle_2,
            pago_total=v_pago_total,pago_inicial=v_pago_inicial,pago_quincenal=v_pago_quincenal,pagos_parciales=v_pagos_parciales,
            fecha_firma=v_fecha_firma,fecha_vencimiento=v_fecha_venc,escritura=v_escritura,propiedad=v_propiedad,
            compro_dom=v_compro_dom,otros=v_otros,observacion=v_observacion,fecha_impresion=v_fecha_impresion,fecha_rev=v_fecha_rev,
            fecha_cancelado=v_fecha_cancelado,vigencia=v_vigencia,id_usuario=v_id_usuario,fecha_actual=current,
            recargos_conv=0,saldo_insoluto=0,descuento=0,clave_historia=1,impobra_conv=v_impobra_conv
                where colonia=v_colonia and calle=v_calle and folio=v_folio; 
            let v_modifica=v_modifica + 1;
       end if;
   else
       if not exists( select * from ta_17_convenios
                      where colonia=v_colonia and calle=v_calle and folio=v_folio) then
        insert into ta_17_convenios  values(0,v_colonia,v_calle,v_folio,v_nombre,v_desc_calle,v_numero,v_tipo_casa,v_mtrs_frente,
            v_mtrs_ancho,v_metros2,v_entre_calle_1,v_entre_calle_2,v_pago_total,v_pago_inicial,v_pago_quincenal,
            v_pagos_parciales,v_fecha_firma,v_fecha_venc,v_escritura,v_propiedad,v_compro_dom,v_otros,
            v_observacion,v_fecha_impresion,v_fecha_rev,v_fecha_cancelado,v_vigencia,v_id_usuario,current,0,0,0,1,0);
            let v_inserta=v_inserta + 1;
       end if;
       foreach
       select * into v_id_convenio,v_h_colonia,v_h_calle,v_h_folio,v_h_nombre,v_h_desc_calle,v_h_numero,v_h_tipo_casa,v_h_mtrs_frente,
             v_h_mtrs_ancho,v_h_metros2,
             v_h_entre_calle_1,v_h_entre_calle_2,v_h_pago_total,v_h_pago_inicial,v_h_pago_quincenal,v_h_pagos_parcial,v_h_fecha_firma,
             v_h_fecha_venc,v_h_escritura,v_h_propiedad,v_h_compro_dom,v_h_otros,v_h_observacion,v_h_fecha_impre,
             v_h_fecha_rev,v_h_fecha_cancel,v_h_vigencia,v_h_id_usuario,v_h_act,v_h_recargos_conv,v_h_saldo_insoluto,
             v_h_descuento,v_h_clave_historia,v_h_impobra_conv 
             from ta_17_convenios 
                 where colonia=v_colonia and calle=v_calle and folio=v_folio
       if v_h_clave_historia is null then
          let v_h_clave_historia=1;
       end if;
       if not exists( select * from ta_17_hist_conv
                      where id_convenio=v_id_convenio and clave_historia=1) then
       insert into ta_17_hist_conv  values(0,v_id_convenio,v_h_nombre,v_h_desc_calle,v_h_numero,v_h_tipo_casa,v_h_mtrs_frente,
            v_h_mtrs_ancho,v_h_metros2,v_h_entre_calle_1,v_h_entre_calle_2,v_h_pago_total,v_h_pago_inicial,v_h_pago_quincenal,
            v_h_pagos_parcial,v_h_fecha_firma,v_h_fecha_venc,v_h_escritura,v_h_propiedad,v_h_compro_dom,v_h_otros,
            v_h_observacion,v_h_fecha_impre,v_h_fecha_rev,v_h_fecha_cancel,v_h_vigencia,v_h_recargos_conv,
            v_h_saldo_insoluto,v_h_descuento,v_h_clave_historia,v_id_usuario,current,v_h_impobra_conv);
            let v_inserta_h=v_inserta_h + 1;
       end if;
       update ta_17_convenios set nombre=v_nombre,desc_calle=v_desc_calle,numero=v_numero,tipo_casa=v_tipo_casa,mtrs_frente=v_mtrs_frente,
            mtrs_ancho=v_mtrs_ancho,metros2=v_metros2,entre_calle_1=v_entre_calle_1,entre_calle_2=v_entre_calle_2,
            pago_total=v_saldoprra,pago_inicial=0,pago_quincenal=v_mensualidad,pagos_parciales=v_pagos_parciales,
            fecha_firma=v_fecha_inicio,fecha_vencimiento=v_fecha_fin,escritura=v_escritura,propiedad=v_propiedad,
            compro_dom=v_compro_dom,otros=v_documentacion,observacion=v_motivo,fecha_impresion=v_fecha_impresion,fecha_rev=v_fecha_rev,
            fecha_cancelado=v_fecha_cancelado,vigencia=v_vigencia,id_usuario=v_id_usuario,fecha_actual=current,recargos_conv=v_recargos_conv,
            clave_historia=v_clave_historia,saldo_insoluto=v_saldo_insoluto,descuento=v_descuento,impobra_conv=v_impobra_conv
                where colonia=v_colonia and calle=v_calle and folio=v_folio; 
            let v_modifica=v_modifica + 1; 
       end foreach;
   end if; 
end foreach;
return v_inserta,v_modifica,v_inserta_h;
end procedure;

CREATE PROCEDURE "informix".con16_f7detade ( p_Mod Char(2), p_Control_contrato Integer)
	RETURNing varchar(255),    -- Concepto
                               Money(12,2),    -- Importe Adeudos
                               Money(12,2);    -- Importe Recargos

{
#  Procedimiento: Con16_F6DetAde
#  Descripcion:  Genera una consulta del detalle de Contratos/requerimiento/Adeudos con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identIFicacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos/Multa
#  		         Importe : El importe de los Recargos/Gastos
#  Elaboro:    c. Gilberto Moreno
#  ModIFico: 
#  Fecha ModIFicaci�n : 
}

 
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato, v_Ofna		Integer;          --  DATOS DEL CONTRATO
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago, v_fecha_practicado                             Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);

  define v_ayo_per, v_periodo_per, v_Lineas_Per						Smallint;        ------ CAMPOS DE PERIODOS QUE CUBRE EL FOLIO DEL REQ.

  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO, v_DetFolReq, v_Detalle_Per		varchar(120);

  define aso_proceso, aso_actual, v_FolReq						Integer;
  DEFINE v_ult_pago                                             DATE;
   LET v_Detalle_T = ' ';
   LET v_importe = 0;
   LET v_Importe_recargo = 0;
   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;


       SELECT Mes, Dia
           INTO Mes_v, Dia_v
       FROM ta_16_Dia_Limite 
               WHERE Mes = MONTH(Current);

      LET Aso_Hoy = YEAR(Current);
      LET Mes_Hoy = MONTH(Current);
      IF Day(Current) > Dia_v then          --  CUOTA NORMAL
         LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current);
      ELSE
          IF MONTH(Current) = 1 then
             LET v_Periodo_CN = YEAR(Current) - 1||'-12';
          ELSE
             LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current) - 1;
          END IF;
      END IF;

      IF Day(Current) > Dia_v then          --  EXEDENCIAS
          IF Mes_Hoy > 2 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 2;
          ELSE
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
          END IF;
      ELSE
          IF Mes_Hoy > 3 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 3;
          ELSE
                IF Mes_Hoy = 3 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-10';
                END IF;
          END IF;
      END IF;

FOREACH
SELECT a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, id_rec
   INTO  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_Ofna  
FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
WHERE A.CTROL_ASEO = 9
  AND b.ctrol_aseo = a.ctrol_aseo
  AND c.num_empresa = a.num_empresa AND c.ctrol_emp = a.ctrol_emp
  ORDER BY a.ctrol_aseo, a.num_contrato

       RETURN 'RECAUDADORA : ' || v_Ofna  ||  '  CONTRATO : '  ||  v_Num_Contrato || ' TIPO DE ASEO : '  ||  v_tipo_aseo, Null, Null  with resume;

	LET v_importe_multa = 0;
	LET v_importe_gastos = 0;
                FOREACH
                     SELECT id_control, folio, importe_multa, importe_gastos, fecha_practicado 
                       INTO v_id_control, v_folio_req, v_importe_multa, v_importe_gastos, v_fecha_practicado 
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_Control
                       AND vigencia = "1" AND clave_practicado = "P"
                      ORDER BY id_control
                                       LET v_Lineas_Per = 0;
		       LET v_Detalle_Per = ' ';
                                       FOREACH
                           		SELECT ayo, periodo INTO v_ayo_per, v_periodo_per FROM ta_15_periodos 
                            		WHERE control_otr = v_id_control
                                    		IF v_Lineas_Per > 0 then
		          			LET v_Detalle_Per = v_Detalle_Per || ',' || v_ayo_per ||'-' || v_periodo_per;
                                    		ELSE
		          			LET v_Detalle_Per = v_Detalle_Per || v_ayo_per || '-' || v_periodo_per;
  		    		END IF;
				LET v_Lineas_Per = v_Lineas_Per + 1;
                        	       END FOREACH;
                IF v_Lineas_Per > 0 then
                  RETURN '  Folio Requerido : ' || v_folio_req || '  ' || 'Fecha de Practicado ' || v_fecha_practicado || '  Amparan Periodo(s) : ' || v_Detalle_Per, v_importe_multa, v_importe_gastos  with resume;
                ELSE
                  RETURN '  Folio Requerido : ' || v_folio_req || '  ' || 'Fecha de Practicado ' || v_fecha_practicado  , v_importe_multa, v_importe_gastos  with resume;
                END IF;
                END FOREACH;

  LET aso_proceso = 0;
  LET aso_actual = YEAR(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		LET v_Lineas_CN = 0;
  		LET v_Detalle_CN = ' Cuota Normal, Meses --';

                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion = 6 
          		     AND H.aso_mes_pago <= (v_Periodo_CN)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

  		IF v_importe > 0 then
                                    IF v_Lineas_CN > 0 then
		          LET v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    ELSE
		          LET v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    END IF;
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
		    LET v_Lineas_CN = v_Lineas_CN + 1;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		LET v_Lineas_EX = 0;
  		LET v_Detalle_EX = ' Excedencias, Meses --';

                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion <> 6 
          		     AND H.aso_mes_pago <= (v_Periodo_EXE)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

			--LET v_Importe_recargo = 0;
                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);

  		IF v_importe > 0 then
                                    IF v_Lineas_EX > 0 then
		          LET v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    ELSE
		          LET v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    END IF;
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
		    LET v_Lineas_EX = v_Lineas_EX + 1;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;

--     GrabANDo registro
   IF  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       LET v_Detalle_T = '  Adeudos del  ' || aso_proceso || '  ';
       IF v_Lineas_CN > 0 then
                LET v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       END IF;
       IF v_Lineas_EX > 0 then
                LET v_Detalle_T = v_Detalle_T|| '  ' || v_Detalle_EX;
       END IF;
       RETURN v_Detalle_T , v_totAdeudos, v_TotRecargos  with resume;
   END IF;

   LET v_Detalle_T = ' ';
   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;

  END FOR;
   LET V_ULT_PAGO = MDY(01,01,1900);
   SELECT max(fecha_hora_pago) INTO v_ult_pago 
     FROM ta_16_pagos 
    WHERE Control_Contrato = v_Control AND Status_Vigencia = 'P';
   IF v_ult_pago <> mdy(01,01,1950) THEN
      RETURN '  ultimo pago realizado el : '  ||  v_ult_pago, Null, Null  with resume;
   END IF;

END FOREACH;

END procedure;

CREATE PROCEDURE "informix".con16_f8detade ( p_Mod Char(2), p_Control_contrato Integer)
    RETURNING CHAR(2),      -- RECAUDADORA
              VARCHAR(20),  -- TIPO DE ASEO
              INTEGER,      -- NUMERO DE CONTRATO
              VARCHAR(200), -- A NOMBRE DE QUIEN ESTA EL CONTRATO
              VARCHAR(200), -- DOMICILIO
              CHAR(2),      -- VIGENCIA   HASTA AQUI DATOS DEL CONTRATO

              Money(12,2),    -- ADEUDOS 2005 Y ANTERIORES
              Money(12,2),    -- RECARGOS
              Money(12,2),    -- ADEUDOS 2006 Y POSTERIORES
              Money(12,2),    -- RECARGOS  HASTA AQUI DATOS DE ADEUDOS
              Money(12,2),    -- TOTAL DE GASTOS
              Money(12,2),    -- TOTAL DE MULTAS

              varchar(255);    -- DATOS DE REQUERIMIENTOS
{
#  Procedimiento: Con16_F8DetAde
#  Descripcion:  Genera una consulta del detalle de Contratos/requerimiento/Adeudos con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identIFicacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos/Multa
#  		         Importe : El importe de los Recargos/Gastos
#  Elaboro:    c. Gilberto Moreno
#  ModIFico: 
#  Fecha ModIFicaci�n : 
}

 
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato, v_Ofna		Integer;          --  DATOS DEL CONTRATO
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_status_vigencia, v_vigencia          Char(1);

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago, v_fecha_practicado                             Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_totAdeudos2005, v_totAdeudos2006, v_TotRecargos2005, v_TotRecargos2006 Money(12,2);
  define v_Mes								varchar(2);

  define v_axo_emi, v_ayo_per, v_periodo_per, v_Lineas_Per						Smallint;        ------ CAMPOS DE PERIODOS QUE CUBRE EL FOLIO DEL REQ.

  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO			varchar(120);
  define v_DetFolReq							varchar(255);

  define aso_proceso, aso_actual, v_FolReq						Integer;
  DEFINE v_ult_pago                                             DATE;
   LET v_Detalle_T = ' ';
   LET v_importe = 0;
   LET v_Importe_recargo = 0;
   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;


       SELECT Mes, Dia
           INTO Mes_v, Dia_v
       FROM ta_16_Dia_Limite 
               WHERE Mes = MONTH(Current);

      LET Aso_Hoy = YEAR(Current);
      LET Mes_Hoy = MONTH(Current);
      IF Day(Current) > Dia_v then          --  CUOTA NORMAL
         LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current);
      ELSE
          IF MONTH(Current) = 1 then
             LET v_Periodo_CN = YEAR(Current) - 1||'-12';
          ELSE
             LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current) - 1;
          END IF;
      END IF;

      IF Day(Current) > Dia_v then          --  EXEDENCIAS
          IF Mes_Hoy > 2 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 2;
          ELSE
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
          END IF;
      ELSE
          IF Mes_Hoy > 3 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 3;
          ELSE
                IF Mes_Hoy = 3 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-10';
                END IF;
          END IF;
      END IF;

FOREACH
SELECT a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, id_rec, status_vigencia
   INTO  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_Ofna, v_status_vigencia  
FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
WHERE A.CTROL_ASEO = 9
  AND b.ctrol_aseo = a.ctrol_aseo
  AND c.num_empresa = a.num_empresa AND c.ctrol_emp = a.ctrol_emp
  ORDER BY a.ctrol_aseo, a.num_contrato

  	LET v_totAdeudos2005 = 0;
	LET v_totAdeudos2006 = 0;
	LET v_TotRecargos2005 = 0;
	LET v_TotRecargos2006 = 0;

                Let v_tot_gastos = 0;
	LET v_importe_multa = 0;
	LET v_importe_gastos = 0;
    	LET v_axo_emi = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = ' ';
                FOREACH
                     SELECT id_control, folio, importe_multa, importe_gastos, fecha_practicado, Year(fecha_emision), vigencia 
                       INTO v_id_control, v_folio_req, v_importe_multa, v_importe_gastos, v_fecha_practicado, v_axo_emi, v_vigencia 
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_Control
                       AND clave_practicado = "P" AND vigencia = "1" 
                      ORDER BY id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || '|' || v_folio_req || ' ' || v_axo_emi || ' ' || v_fecha_practicado || ' ' || v_vigencia ;
		else
		   Let v_DetFolReq = v_DetFolReq || v_folio_req || ' ' || v_axo_emi || ' ' || v_fecha_practicado || ' ' || v_vigencia;
		Let v_FolReq = v_FolReq + 1;
		end if;
                END FOREACH;

  LET aso_proceso = 0;
  LET aso_actual = YEAR(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL

                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion = 6 
          		     AND H.aso_mes_pago <= (v_Periodo_CN)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

  		IF v_importe > 0 then
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;
	-------------------------------------CONSULTA DE EXEDENCIAS
                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion <> 6 
          		     AND H.aso_mes_pago <= (v_Periodo_EXE)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);

  		IF v_importe > 0 then
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;

--     GrabANDo registro

   IF aso_proceso <= 2005 THEN
       LET v_totAdeudos2005 = v_totAdeudos2005 + v_totAdeudos;
       LET v_TotRecargos2005 = v_TotRecargos2005 + v_TotRecargos;
   ELSE
       LET v_totAdeudos2006 = v_totAdeudos2006 + v_totAdeudos;
       LET v_TotRecargos2006 = v_TotRecargos2006 + v_TotRecargos;
   END IF;

   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;

  END FOR;

       RETURN v_Ofna,v_tipo_aseo,v_Num_Contrato,v_nombre,v_domicilio,v_status_vigencia, 
                       v_totAdeudos2005, v_TotRecargos2005, v_totAdeudos2006, v_TotRecargos2006, v_tot_gastos, v_importe_multa, v_DetFolReq  with resume;

END FOREACH;

END procedure;

CREATE PROCEDURE "informix".con16_f6detade ( p_Mod Char(2), p_Control_contrato Integer)
	RETURNing varchar(255),    -- Concepto
                               Money(12,2),    -- Importe Adeudos
                               Money(12,2);    -- Importe Recargos

{
#  Procedimiento: Con16_F6DetAde
#  Descripcion:  Genera una consulta del detalle de Contratos/requerimiento/Adeudos con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identIFicacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos/Multa
#  		         Importe : El importe de los Recargos/Gastos
#  Elaboro:    c. Gilberto Moreno
#  ModIFico: 
#  Fecha ModIFicaci�n : 
}

 
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato, v_Ofna		Integer;          --  DATOS DEL CONTRATO
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_status_vigencia, v_vigencia          Char(1);

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago, v_fecha_practicado                             Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);

  define v_ayo_per, v_periodo_per, v_Lineas_Per						Smallint;        ------ CAMPOS DE PERIODOS QUE CUBRE EL FOLIO DEL REQ.

  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO, v_DetFolReq, v_Detalle_Per		varchar(120);

  define aso_proceso, aso_actual, v_FolReq						Integer;
  DEFINE v_ult_pago                                             DATE;
   LET v_Detalle_T = ' ';
   LET v_importe = 0;
   LET v_Importe_recargo = 0;
   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;


       SELECT Mes, Dia
           INTO Mes_v, Dia_v
       FROM ta_16_Dia_Limite 
               WHERE Mes = MONTH(Current);

      LET Aso_Hoy = YEAR(Current);
      LET Mes_Hoy = MONTH(Current);
      IF Day(Current) > Dia_v then          --  CUOTA NORMAL
         LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current);
      ELSE
          IF MONTH(Current) = 1 then
             LET v_Periodo_CN = YEAR(Current) - 1||'-12';
          ELSE
             LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current) - 1;
          END IF;
      END IF;

      IF Day(Current) > Dia_v then          --  EXEDENCIAS
          IF Mes_Hoy > 2 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 2;
          ELSE
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
          END IF;
      ELSE
          IF Mes_Hoy > 3 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 3;
          ELSE
                IF Mes_Hoy = 3 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-10';
                END IF;
          END IF;
      END IF;

FOREACH
SELECT a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, id_rec, status_vigencia
   INTO  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_Ofna, v_status_vigencia  
FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
WHERE A.CTROL_ASEO = 9
  AND b.ctrol_aseo = a.ctrol_aseo
  AND c.num_empresa = a.num_empresa AND c.ctrol_emp = a.ctrol_emp
  ORDER BY a.ctrol_aseo, a.num_contrato

       RETURN 'RECAUDADORA:' || v_Ofna  || '  TIPO DE ASEO:'  ||  v_tipo_aseo || '  CONTRATO:'  ||  v_Num_Contrato || '  NOMBRE:' || v_nombre || '  DOMICILIO:' || v_domicilio || '  VIGENCIA:' || v_status_vigencia, Null, Null  with resume;

	LET v_importe_multa = 0;
	LET v_importe_gastos = 0;
                FOREACH
                     SELECT id_control, folio, importe_multa, importe_gastos, fecha_practicado, vigencia 
                       INTO v_id_control, v_folio_req, v_importe_multa, v_importe_gastos, v_fecha_practicado, v_vigencia 
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_Control
                       AND clave_practicado = "P" --AND vigencia = "1" 
                      ORDER BY id_control
                                       LET v_Lineas_Per = 0;
		       LET v_Detalle_Per = ' ';
                                       FOREACH
                           		SELECT ayo, periodo INTO v_ayo_per, v_periodo_per FROM ta_15_periodos 
                            		WHERE control_otr = v_id_control
                                    		IF v_Lineas_Per > 0 then
		          			LET v_Detalle_Per = v_Detalle_Per || ',' || v_ayo_per ||'-' || v_periodo_per;
                                    		ELSE
		          			LET v_Detalle_Per = v_Detalle_Per || v_ayo_per || '-' || v_periodo_per;
  		    		END IF;
				LET v_Lineas_Per = v_Lineas_Per + 1;
                        	       END FOREACH;
                IF v_Lineas_Per > 0 then
                  RETURN '  Folio Requerido : ' || v_folio_req || '  ' || 'Fecha de Practicado ' || v_fecha_practicado || '  Amparan Periodo(s) : ' || v_Detalle_Per, v_importe_multa, v_importe_gastos  with resume;
                ELSE
                  RETURN '  Folio Requerido : ' || v_folio_req || '  ' || 'Fecha de Practicado ' || v_fecha_practicado  , v_importe_multa, v_importe_gastos  with resume;
                END IF;
                END FOREACH;

  LET aso_proceso = 0;
  LET aso_actual = YEAR(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		LET v_Lineas_CN = 0;
  		LET v_Detalle_CN = ' Cuota Normal, Meses --';

                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion = 6 
          		     AND H.aso_mes_pago <= (v_Periodo_CN)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

  		IF v_importe > 0 then
                                    IF v_Lineas_CN > 0 then
		          LET v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    ELSE
		          LET v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    END IF;
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
		    LET v_Lineas_CN = v_Lineas_CN + 1;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		LET v_Lineas_EX = 0;
  		LET v_Detalle_EX = ' Excedencias, Meses --';

                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion <> 6 
          		     AND H.aso_mes_pago <= (v_Periodo_EXE)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

			--LET v_Importe_recargo = 0;
                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);

  		IF v_importe > 0 then
                                    IF v_Lineas_EX > 0 then
		          LET v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    ELSE
		          LET v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    END IF;
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
		    LET v_Lineas_EX = v_Lineas_EX + 1;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;

--     GrabANDo registro
   IF  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       LET v_Detalle_T = '  Adeudos del  ' || aso_proceso || '  ';
       IF v_Lineas_CN > 0 then
                LET v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       END IF;
       IF v_Lineas_EX > 0 then
                LET v_Detalle_T = v_Detalle_T|| '  ' || v_Detalle_EX;
       END IF;
       RETURN v_Detalle_T , v_totAdeudos, v_TotRecargos  with resume;
   END IF;

   LET v_Detalle_T = ' ';
   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;

  END FOR;
--   LET V_ULT_PAGO = MDY(01,01,1900);
--   SELECT max(fecha_hora_pago) INTO v_ult_pago 
--     FROM ta_16_pagos 
--    WHERE Control_Contrato = v_Control AND Status_Vigencia = 'P';
--   IF v_ult_pago <> mdy(01,01,1950) THEN
--      RETURN '  ultimo pago realizado el : '  ||  v_ult_pago, Null, Null  with resume;
--   END IF;

END FOREACH;

END procedure;

create procedure "informix".spd_11_adetotaxo()
returning char(30),smallint,smallint,smallint,char(2),integer,char(1),char(1),
MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),
MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),
MONEY(16,2),MONEY(16,2), 
MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),
MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),MONEY(16,2),
MONEY(16,2),MONEY(16,2),
MONEY(16,2),MONEY(16,2),char(1),char(5000);

define v_axo1994 MONEY(16,2);   define v_axo1995 MONEY(16,2);
define v_axo1996 MONEY(16,2);   define v_axo1997 MONEY(16,2);
define v_axo1998 MONEY(16,2);   define v_axo1999 MONEY(16,2);
define v_axo2000 MONEY(16,2);   define v_axo2001 MONEY(16,2);
define v_axo2002 MONEY(16,2);   define v_axo2003 MONEY(16,2);
define v_axo2004 MONEY(16,2);   define v_axo2005 MONEY(16,2);
define v_axo2006 MONEY(16,2);   define v_axo2007 MONEY(16,2);
define v_axo2008 MONEY(16,2);   define v_axo2009 MONEY(16,2);
define v_axo2010 MONEY(16,2);   define v_axo2011 MONEY(16,2);
define v_rec1994 MONEY(16,2);   define v_rec1995 MONEY(16,2);
define v_rec1996 MONEY(16,2);   define v_rec1997 MONEY(16,2);
define v_rec1998 MONEY(16,2);   define v_rec1999 MONEY(16,2);
define v_rec2000 MONEY(16,2);   define v_rec2001 MONEY(16,2);
define v_rec2002 MONEY(16,2);   define v_rec2003 MONEY(16,2);
define v_rec2004 MONEY(16,2);   define v_rec2005 MONEY(16,2);
define v_rec2006 MONEY(16,2);   define v_rec2007 MONEY(16,2);
define v_rec2008 MONEY(16,2);   define v_rec2009 MONEY(16,2);
define v_rec2010 MONEY(16,2);   define v_rec2011 MONEY(16,2);
define v_multa MONEY(16,2);     define v_gastos MONEY(16,2);
define v_requerimientos char(5000);
define v_salto varchar(10);
define v_mer char(30);          define v_ofi smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(1);           define v_blq char(1);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);
define v_aid_local integer;     define v_aaxo smallint;
define v_aperiodo smallint;     define v_aimporte money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_axo1994=0;   let v_axo1995=0;
let v_axo1996=0;   let v_axo1997=0;
let v_axo1998=0;   let v_axo1999=0;
let v_axo2000=0;   let v_axo2001=0;
let v_axo2002=0;   let v_axo2003=0;
let v_axo2004=0;   let v_axo2005=0;
let v_axo2006=0;   let v_axo2007=0;
let v_axo2008=0;   let v_axo2009=0;
let v_axo2010=0;   let v_axo2011=0;
let v_rec1994=0;   let v_rec1995=0;
let v_rec1996=0;   let v_rec1997=0;
let v_rec1998=0;   let v_rec1999=0;
let v_rec2000=0;   let v_rec2001=0;
let v_rec2002=0;   let v_rec2003=0;
let v_rec2004=0;   let v_rec2005=0;
let v_rec2006=0;   let v_rec2007=0;
let v_rec2008=0;   let v_rec2009=0;
let v_rec2010=0;   let v_rec2011=0;
let v_multa=0;     let v_gastos=0;
let v_requerimientos='';
let v_porc=0;      let v_folio=0; 
--let v_salto=CHaR(10)||CHaR(13);

--begin
--    on exception in (-958)
--       delete from tmp_adeudostot;
--    end exception;
--create temp table tmp_adeudostot(
--  mercado char(30),
--  oficina smallint NOT NULL,
--  num_mercado smallint NOT NULL,
--  categoria SMALLINT,
--  seccion char(2),
--  local integer,
--  letra char(1),
--  bloque char(1),
--  axo1994 MONEY(16,2),
--  rec1994 MONEY(16,2),
--  axo1995 MONEY(16,2),
--  rec1995 MONEY(16,2),
--  axo1996 MONEY(16,2),
--  rec1996 MONEY(16,2),
--  axo1997 MONEY(16,2),
--  rec1997 MONEY(16,2),
--  axo1998 MONEY(16,2),
--  rec1998 MONEY(16,2),
--  axo1999 MONEY(16,2),
--  rec1999 MONEY(16,2),
--  axo2000 MONEY(16,2),
--  rec2000 MONEY(16,2),
--  axo2001 MONEY(16,2),
--  rec2001 MONEY(16,2),
--  axo2002 MONEY(16,2),
--  rec2002 MONEY(16,2),
--  axo2003 MONEY(16,2),
--  rec2003 MONEY(16,2),
--  axo2004 MONEY(16,2),
--  rec2004 MONEY(16,2),
--  axo2005 MONEY(16,2),
--  rec2005 MONEY(16,2),
--  axo2006 MONEY(16,2),
--  rec2006 MONEY(16,2),
--  axo2007 MONEY(16,2),
--  rec2007 MONEY(16,2),
--  axo2008 MONEY(16,2),
--  rec2008 MONEY(16,2),
--  axo2009 MONEY(16,2),
--  rec2009 MONEY(16,2),
--  axo2010 MONEY(16,2),
--  rec2010 MONEY(16,2),
--  axo2011 MONEY(16,2),
--  rec2011 MONEY(16,2),
--  multa MONEY(16,2),
--  gastos MONEY(16,2),
--  estado char(1),
--  requerimientos char(5000));
--end;

foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.vigencia,nvl(max(importe_multa),0), nvl(sum(importe_gastos),0),sum(d.importe) 
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_est,v_multa,v_gastos,v_ade
from ta_11_locales a,ta_11_mercados b,outer ta_15_apremios c,outer ta_11_adeudo_local d
where b.num_mercado_nvo not in(99,214) and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
and c.modulo=11 and c.control_otr=a.id_local and c.vigencia='1' and c.clave_practicado='P'
and d.id_local=a.id_local and (d.axo<2011  or (d.periodo<=1 and d.axo=2011))
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.vigencia
having (sum(importe_gastos)>0) or (max(importe_multa)>0) or (sum(d.importe)>0)
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0) into v_folio
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';


let v_axo1994=0;   let v_axo1995=0;
let v_axo1996=0;   let v_axo1997=0;
let v_axo1998=0;   let v_axo1999=0;
let v_axo2000=0;   let v_axo2001=0;
let v_axo2002=0;   let v_axo2003=0;
let v_axo2004=0;   let v_axo2005=0;
let v_axo2006=0;   let v_axo2007=0;
let v_axo2008=0;   let v_axo2009=0;
let v_axo2010=0;   let v_axo2011=0;
let v_rec1994=0;   let v_rec1995=0;
let v_rec1996=0;   let v_rec1997=0;
let v_rec1998=0;   let v_rec1999=0;
let v_rec2000=0;   let v_rec2001=0;
let v_rec2002=0;   let v_rec2003=0;
let v_rec2004=0;   let v_rec2005=0;
let v_rec2006=0;   let v_rec2007=0;
let v_rec2008=0;   let v_rec2009=0;
let v_rec2010=0;   let v_rec2011=0;
foreach
select axo,sum(importe) into v_axo,v_adeudo from ta_11_adeudo_local
where id_local=v_idl and (axo<2011  or (periodo<=1 and axo=2011))
group by axo order by axo

if v_axo=1994 then let v_axo1994=v_adeudo;
else if v_axo=1995 then let v_axo1995=v_adeudo; 
else if v_axo=1996 then let v_axo1996=v_adeudo; 
else if v_axo=1997 then let v_axo1997=v_adeudo;
else if v_axo=1998 then let v_axo1998=v_adeudo;
else if v_axo=1999 then let v_axo1999=v_adeudo;
else if v_axo=2000 then let v_axo2000=v_adeudo;
else if v_axo=2001 then let v_axo2001=v_adeudo;
else if v_axo=2002 then let v_axo2002=v_adeudo;
else if v_axo=2003 then let v_axo2003=v_adeudo;
else if v_axo=2004 then let v_axo2004=v_adeudo;
else if v_axo=2005 then let v_axo2005=v_adeudo;
else if v_axo=2006 then let v_axo2006=v_adeudo;
else if v_axo=2007 then let v_axo2007=v_adeudo;
else if v_axo=2008 then let v_axo2008=v_adeudo;
else if v_axo=2009 then let v_axo2009=v_adeudo;
else if v_axo=2010 then let v_axo2010=v_adeudo;
else if v_axo=2011 then let v_axo2011=v_adeudo;
end if; end if; end if; end if; end if; end if;
end if; end if; end if; end if; end if; end if;
end if; end if; end if; end if; end if; end if;

-- todos los periodos del a�o adeudo
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=v_idl and axo=v_axo
and b.mes=month(today)
order by axo,periodo

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if today>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
if v_axo=1994 then let v_rec1994=v_rec1994+v_recargos;
else if v_axo=1995 then let v_rec1995=v_rec1995+v_recargos; 
else if v_axo=1996 then let v_rec1996=v_rec1996+v_recargos; 
else if v_axo=1997 then let v_rec1997=v_rec1997+v_recargos;
else if v_axo=1998 then let v_rec1998=v_rec1998+v_recargos;
else if v_axo=1999 then let v_rec1999=v_rec1999+v_recargos;
else if v_axo=2000 then let v_rec2000=v_rec2000+v_recargos;
else if v_axo=2001 then let v_rec2001=v_rec2001+v_recargos;
else if v_axo=2002 then let v_rec2002=v_rec2002+v_recargos;
else if v_axo=2003 then let v_rec2003=v_rec2003+v_recargos;
else if v_axo=2004 then let v_rec2004=v_rec2004+v_recargos;
else if v_axo=2005 then let v_rec2005=v_rec2005+v_recargos;
else if v_axo=2006 then let v_rec2006=v_rec2006+v_recargos;
else if v_axo=2007 then let v_rec2007=v_rec2007+v_recargos;
else if v_axo=2008 then let v_rec2008=v_rec2008+v_recargos;
else if v_axo=2009 then let v_rec2009=v_rec2009+v_recargos;
else if v_axo=2010 then let v_rec2010=v_rec2010+v_recargos;
else if v_axo=2011 then let v_rec2011=v_rec2011+v_recargos;
end if; end if; end if; end if; end if; end if;
end if; end if; end if; end if; end if; end if;
end if; end if; end if; end if; end if; end if;
end foreach; -- cierre de los periodos

end foreach; -- cierre de adeudos

let v_requerimientos='';
foreach
select id_control,fecha_emision,folio,fecha_practicado,( 
(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
from   ta_15_apremios a   
where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
order by a.fecha_emision,a.folio
--let v_requerimientos=trim(v_requerimientos)||'Emisi�n '||v_emi||
--' Folio '||v_fol||' Practicado '||v_pra||' Periodo Inicio '||v_ini||' Periodo Final '||v_fin;
let v_requerimientos=trim(v_requerimientos)||v_emi||'|'||v_fol||'|'||v_pra||'|'||
trim(v_ini)||'|'||trim(v_fin)||'|';

end foreach; -- cierre de apremios
--insert into tmp_adeudostot values(v_mer,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_axo1994,v_rec1994,v_axo1995,v_rec1995,
--v_axo1996,v_rec1996,v_axo1997,v_rec1997,v_axo1998,v_rec1998,v_axo1999,v_rec1999,v_axo2000,v_rec2000,
--v_axo2001,v_rec2001,v_axo2002,v_rec2002,v_axo2003,v_rec2003,v_axo2004,v_rec2004,v_axo2005,v_rec2005,
--v_axo2006,v_rec2006,v_axo2007,v_rec2007,v_axo2008,v_rec2008,v_axo2009,v_rec2009,v_axo2010,v_rec2010,
--v_axo2011,v_rec2011,v_multa,v_gastos,v_est,v_requerimientos);

return v_mer,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_axo1994,v_rec1994,v_axo1995,v_rec1995,
v_axo1996,v_rec1996,v_axo1997,v_rec1997,v_axo1998,v_rec1998,v_axo1999,v_rec1999,v_axo2000,v_rec2000,
v_axo2001,v_rec2001,v_axo2002,v_rec2002,v_axo2003,v_rec2003,v_axo2004,v_rec2004,v_axo2005,v_rec2005,
v_axo2006,v_rec2006,v_axo2007,v_rec2007,v_axo2008,v_rec2008,v_axo2009,v_rec2009,v_axo2010,v_rec2010,
v_axo2011,v_rec2011,v_multa,v_gastos,v_est,v_requerimientos
with resume;
end foreach; -- cierre del principal


end procedure;

CREATE PROCEDURE "informix".actual_rbobcos(
)
returning  date , --v_fecha_pago 
         integer ,  -- v_id_rec 
          char(2) , --v_caja ,
      integer  , -- v_operacion 
      integer , --v_recaud , 
       date ; --v_fecha_pagobco;

define v_recaud int; 
define v_fecha_pagobco date ;
define v_fecha_pago date ;
define v_id_rec int;
define v_caja char(2);
define  v_operacion int;

foreach
select recaud , fecha_pagobco, fecha_pago ,id_rec,caja , operacion
into v_recaud , v_fecha_pagobco, v_fecha_pago , v_id_rec, v_caja , v_operacion
 from linea_pagos where fecha_pago between mdy(1,1,2011) and mdy(2,28,2011) and
      id_rec > 0 and estatus = 'A' and caja not in ('K1','K2','K3')
update ta_12_recibos set fec_pagobco = v_fecha_pagobco ,  lugar_pago = v_recaud
where fecha = v_fecha_pago and
      id_rec = v_id_rec and
      caja  = v_caja and 
      operacion = v_operacion;

return   v_fecha_pago , v_id_rec, v_caja , v_operacion , v_recaud , v_fecha_pagobco with resume;
end foreach;

foreach
select b.recaud , b.fecha_pagobco , c.fecha ,c.recaud, c.caja , c.folio
into v_recaud , v_fecha_pagobco, v_fecha_pago , v_id_rec, v_caja , v_operacion
 from v_bco_carga1 a, catastro_gdl:bco_control b,  v_pagos c
where a.fecha_pagobco between mdy(1,1,2011) and mdy(2,28,2011) and a.cvepago > 0 
and a.id_control = b.id_control and a.cvepago = c.cvepago
update ta_12_recibos set fec_pagobco = v_fecha_pagobco ,  lugar_pago = v_recaud
where fecha = v_fecha_pago and
      id_rec = v_id_rec and
      caja  = v_caja and 
      operacion = v_operacion;
return   v_fecha_pago , v_id_rec, v_caja , v_operacion , v_recaud , v_fecha_pagobco with resume;
end foreach;


end procedure;

CREATE PROCEDURE "informix".kio_pagolicgiro(
    		parlinea varchar(28),
                parImpCertificado money(15,2),
    		parKiosco	integer
        )
		returning smallint , char(2), integer , char(28);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define parlic integer ;
define parlican  integer;
define paranun integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(50); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define v_id_licencia int;
define v_id int;
define paraxodesde int;
define paraxohasta int;
define varcvepago int;
define v_descriprbo varchar(60);
define v_colonia_ubic char(20) ;define  v_cvecatnva char(15) ;
define v_subpredio int ;define v_rfc char(15);
define v_axo int; define v_id_giro int ; define v_actividad char(92);
define v_id_anuncio int; define v_linea char(28); define partipoLic char(1);
define estatus int ; define mensaje varchar(100);
--on exception
--rollback work;
--return 9, ' ', 0 , '';
--end exception;
let parlic =0; let paranun = 0; 
--set debug file to "pagokioLIC.TXT";
--trace on;
let v_linea = '' ;
--datos de la  Licencia .
--begin work;
 select nvl(a.licencia,0) , nvl(a.anuncio,0) , nvl(a.desde,0), nvl(a.hasta,0), a.linea
  into parlic , paranun , paraxodesde, paraxohasta , v_linea
   from catastro_gdl:linea_capturalic a 
   where trim(a.linea) = trim(parlinea);
if v_linea = '' then 
return 0, '', 0 , parlinea;

else

if (parlic > 0) and ( paranun = 0) then   --cuando es licencia
    select nvl(l.id_licencia,0),year(l.fecha_otorgamiento),l.id_giro,l.propietario,
    "Licencia" || trim(l.actividad),
    trim(l.ubicacion) || ' Ext:'|| l.numext_ubic||' '|| trim(l.letraext_ubic)
          || l.numint_ubic || ' '|| trim(l.letraint_ubic),
           trim(l.colonia_ubic)
           ,   cc.cvecatnva,cc.subpredio,l.rfc
           into v_id_licencia,v_axo,v_id_giro,v_nombre,v_actividad,
           v_ubicacion ,
           v_colonia_ubic,
           v_cvecatnva,v_subpredio,v_rfc
   from         catastro_gdl:licencias l,
          outer catastro_gdl:convcta cc
   where licencia= parlic 
            and cc.cvecuenta = l.cvecuenta ;
   let v_id = v_id_licencia;
let parlican = parlic;
let partipoLic = 'L';
   
end if;
if (paranun > 0) and ( parLic = 0) then  --cuando es anuncio
   select nvl(a.id_anuncio,0),year(a.fecha_otorgamiento),a.id_giro,l.propietario,
           'MEDIDAS ' || medidas1 || ' X ' || medidas2 || ' area: ' || area_anuncio || ' CARAS: ' || num_caras
           ,trim(a.ubicacion)|| ' Ext ' || a.numext_ubic || ' ' ||  trim(a.letraext_ubic)|| ' Int ' || 
           a.numint_ubic||  ' Ext ' || trim(a.letraint_ubic),
           a.colonia_ubic,'',0,l.rfc
           into v_id_anuncio,v_axo,v_id_giro,v_nombre,v_actividad,
    v_ubicacion, v_colonia_ubic, v_cvecatnva,v_subpredio,v_rfc
   from catastro_gdl:anuncios a, 
        catastro_gdl:licencias l 
   where a.anuncio=paranun and l.id_licencia=a.id_licencia;
   let v_id = v_id_anuncio;
  let parlican = paranun;
let partipoLic = 'A';
 end if;

  select id_rec , caja  into varrec , varcaja
  from ta12_operacKiosco where id_usuario = parkiosco; 
let v_descriprbo = 'PAGO DE LICENCIA:   Id_licencia : ' || v_id;

  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 9, parlican, 0, '',
              1, parAxodesde, 12, parAxohasta,
                v_Nombre, v_ubicacion,
           v_actividad , '',v_id,0,
                0,0,parkiosco,current,0,0,0,'',0,'I',v_descriprbo)
 into spoperacion;

  let varoperacion = spoperacion;
 -- para afectar catastro del pago;
 let us = 'Kiosco ' || parkiosco;
  let v_hora = extend(current, hour to minute);
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,v_id, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 8);
   let varcvepago = dbinfo("sqlca.sqlerrd1");   
                
let linea = 1;     
let v_suma =0;



FOREACH
execute procedure  catastro_gdl:kiosco_lic_totales( v_id , partipoLic,'R','D') 
    into v_cuenta , v_ob , v_concepto , v_importe 
insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );
-- insertar en auditoria
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (v_id, varcvepago, v_cuenta,varrec ,v_importe,
'N',0,0);
       let linea = linea +1 ;
       let v_suma = v_suma + v_importe;
end FOREACH;
let v_redondeo = parImpCertificado - v_suma;
if v_redondeo <> 0 then
 if (parImpCertificado - (v_suma)) > 0 then
     let cuenta = 55080000;
      else
     let cuenta = 55080000;
    end if;
 
 insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
 'Ajuste ART. 14 de ley de ingresos ' , 55080000, v_redondeo );
  insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (v_id, varcvepago, 55080000,varrec ,v_redondeo,
'N',0,0);
end if;

-- quitar los adeudos
if upper(partipoLic) = 'L' then
    update catastro_gdl:detsal_lic   set cvepago=varcvepago
     	where id_licencia=v_id
       	and cvepago = 0 ;

    execute procedure catastro_gdl:calc_sdosl(v_id);
end if;
if upper(partipoLic) = 'A' then
    update catastro_gdl:detsal_lic  set cvepago=varcvepago
     	where id_anuncio=v_id
       	and cvepago = 0 ;
end if;
execute  PROCEDURE linea_pagok(v_linea, parKiosco, parImpCertificado, 'K',varcvepago,
    today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje ;
--commit work;

return varrec, varcaja, spoperacion , v_linea;
end if;
--trace off;
end procedure;

CREATE PROCEDURE "informix".kio_pagolicgiro2(
    		parlinea varchar(28),
                parImpCertificado money(15,2),
    		parKiosco	integer
        )
		returning smallint , char(2), integer , char(28);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define parlic integer ;
define parlican  integer;
define paranun integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(50); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define v_id_licencia int;
define v_id int;
define paraxodesde int;
define paraxohasta int;
define varcvepago int;
define v_descriprbo varchar(60);
define v_colonia_ubic char(20) ;define  v_cvecatnva char(15) ;
define v_subpredio int ;define v_rfc char(15);
define v_axo int; define v_id_giro int ; define v_actividad char(92);
define v_id_anuncio int; define v_linea char(28); define partipoLic char(1);
define estatus int ; define mensaje varchar(100);

let parlic =0; let paranun = 0; 
--set debug file to "pagokioLIC2.TXT";
--trace on;
let v_linea = '' ;
--datos de la  Licencia .
--begin work;
insert into prueba values(123,"prueba eooe");
 select nvl(a.licencia,0) , nvl(a.anuncio,0) , nvl(a.desde,0), nvl(a.hasta,0), a.linea
  into parlic , paranun , paraxodesde, paraxohasta , v_linea
   from catastro_gdl:linea_capturalic a 
   where trim(a.linea) = trim(parlinea);
if v_linea = '' then 
return 0, '', 0 , parlinea;

else

if (parlic > 0) and ( paranun = 0) then   --cuando es licencia
    select nvl(l.id_licencia,0),year(l.fecha_otorgamiento),l.id_giro,l.propietario,
    "Licencia" || trim(l.actividad),
    trim(l.ubicacion) || ' Ext:'|| l.numext_ubic||' '|| trim(l.letraext_ubic)
          || l.numint_ubic || ' '|| trim(l.letraint_ubic),
           trim(l.colonia_ubic)
           ,   cc.cvecatnva,cc.subpredio,l.rfc
           into v_id_licencia,v_axo,v_id_giro,v_nombre,v_actividad,
           v_ubicacion ,
           v_colonia_ubic,
           v_cvecatnva,v_subpredio,v_rfc
   from         catastro_gdl:licencias l,
          outer catastro_gdl:convcta cc
   where licencia= parlic 
            and cc.cvecuenta = l.cvecuenta ;
   let v_id = v_id_licencia;
let parlican = parlic;
let partipoLic = 'L';
   
end if;
if (paranun > 0) and ( parLic = 0) then  --cuando es anuncio
   select nvl(a.id_anuncio,0),year(a.fecha_otorgamiento),a.id_giro,l.propietario,
           'MEDIDAS ' || medidas1 || ' X ' || medidas2 || ' area: ' || area_anuncio || ' CARAS: ' || num_caras
           ,trim(a.ubicacion)|| ' Ext ' || a.numext_ubic || ' ' ||  trim(a.letraext_ubic)|| ' Int ' || 
           a.numint_ubic||  ' Ext ' || trim(a.letraint_ubic),
           a.colonia_ubic,'',0,l.rfc
           into v_id_anuncio,v_axo,v_id_giro,v_nombre,v_actividad,
    v_ubicacion, v_colonia_ubic, v_cvecatnva,v_subpredio,v_rfc
   from catastro_gdl:anuncios a, 
        catastro_gdl:licencias l 
   where a.anuncio=paranun and l.id_licencia=a.id_licencia;
   let v_id = v_id_anuncio;
  let parlican = paranun;
let partipoLic = 'A';
 end if;

  select id_rec , caja  into varrec , varcaja
  from ta12_operacKiosco where id_usuario = parkiosco; 
let v_descriprbo = 'PAGO DE LICENCIA:   Id_licencia : ' || v_id;

  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 9, parlican, 0, '',
              1, parAxodesde, 12, parAxohasta,
                v_Nombre, v_ubicacion,
           v_actividad , '',v_id,0,
                0,0,parkiosco,current,0,0,0,'',0,'I',v_descriprbo)
 into spoperacion;

  let varoperacion = spoperacion;
 -- para afectar catastro del pago;
 let us = 'Kiosco ' || parkiosco;
  let v_hora = extend(current, hour to minute);
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,v_id, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 8);
   let varcvepago = dbinfo("sqlca.sqlerrd1");   
                
let linea = 1;     
let v_suma =0;



FOREACH
execute procedure  catastro_gdl:kiosco_lic_totales( v_id , partipoLic,'R','D') 
    into v_cuenta , v_ob , v_concepto , v_importe 
insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );
-- insertar en auditoria
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (v_id, varcvepago, v_cuenta,varrec ,v_importe,
'N',0,0);
       let linea = linea +1 ;
       let v_suma = v_suma + v_importe;
end FOREACH;
let v_redondeo = parImpCertificado - v_suma;
if v_redondeo <> 0 then
 if (parImpCertificado - (v_suma)) > 0 then
     let cuenta = 55080000;
      else
     let cuenta = 55080000;
    end if;
 
 insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
 'Ajuste ART. 14 de ley de ingresos ' , 55080000, v_redondeo );
  insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (v_id, varcvepago, 55080000,varrec ,v_redondeo,
'N',0,0);
end if;

-- quitar los adeudos
if upper(partipoLic) = 'L' then
    update catastro_gdl:detsal_lic   set cvepago=varcvepago
     	where id_licencia=v_id
       	and cvepago = 0 ;

    execute procedure catastro_gdl:calc_sdosl(v_id);
end if;
if upper(partipoLic) = 'A' then
    update catastro_gdl:detsal_lic  set cvepago=varcvepago
     	where id_anuncio=v_id
       	and cvepago = 0 ;
end if;
execute  PROCEDURE linea_pagok(v_linea, parKiosco, parImpCertificado, 'K',varcvepago,
    today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje ;
commit work;

return varrec, varcaja, spoperacion , v_linea;
end if;
--trace off;
end procedure;

CREATE PROCEDURE "informix".con16_f4detade ( p_Mod Char(2), p_Control_contrato Integer, p_Axo Integer)
	returning varchar(255),    -- Concepto
                               Money(12,2),    -- Importe Adeudos
                               Money(12,2),    -- Importe Recargos
                               Money(12,2),    -- Importe Multa
                               Money(12,2);    -- Importe Gastos

{
#  Procedimiento: Con16_F3DetAde
#  Descripcion:  Genera una consulta del detalle de Adeudos con un formato definido en una sola linea
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos
#  		         Importe : El importe de los Recargos
#  		         Importe : El importe de la Multa
#  		         Importe : El importe de los Gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago             						Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);



  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO, v_DetFolReq		varchar(120);

  define aso_proceso, aso_actual, v_FolReq						Integer;
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;


                Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = 'Folio(s) Requerido(s) : ';
                foreach
                     Select id_control,   folio,            importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || ',' || v_folio_req;
		else
		   Let v_DetFolReq = v_DetFolReq || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
		end if;
                end foreach;
                       if v_FolReq > 0 then
		--return v_DetFolReq, 0, 0, v_importe_multa, v_tot_gastos  with resume;-------------------------------------------------
		--return 'Multa del Requerimiento con el folio : ' || v_folio_req , v_importe_multa  with resume;
		--return 'Gastos Generados por el Total de Requerimientos : ' , v_tot_gastos  with resume;
                       end if;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to p_Axo

	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' Cuota Normal, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' Excedencias, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;


  END FOR;
--     Grabando registro
--  v_importe_multa, v_tot_gastos
   if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       Let v_Detalle_T = 'Adeudos  ';
       return v_Detalle_T , v_totAdeudos, v_TotRecargos, v_importe_multa, v_tot_gastos  with resume;
   end if;

   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;


end procedure
;

CREATE PROCEDURE "informix".con16_f5detade ( p_Mod Char(2))
	returning varchar(255),    -- Concepto
                               Money(12,2),    -- Importe Adeudos
                               Money(12,2),    -- Importe Recargos
                               Money(12,2),    -- Importe Multa
                               Money(12,2);    -- Importe Gastos

{
#  Procedimiento: Con16_F3DetAde
#  Descripcion:  Genera una consulta del detalle de Adeudos con un formato definido en una sola linea
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos
#  		         Importe : El importe de los Recargos
#  		         Importe : El importe de la Multa
#  		         Importe : El importe de los Gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago             						Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);

  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO, v_DetFolReq		varchar(120);

  define aso_proceso, aso_actual, v_FolReq						Integer;

  define v_Control, v_Ctrol_Aseo, v_Num_Contrato      		Integer;
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);


   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;

FOREACH
Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio
   Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio  
From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
Where b.ctrol_aseo = a.ctrol_aseo
  and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
  ORDER BY a.ctrol_aseo, a.num_contrato

                Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = 'Folio(s) Requerido(s) : ';
                foreach
                     Select id_control,   folio,            importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = v_Control
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || ',' || v_folio_req;
		else
		   Let v_DetFolReq = v_DetFolReq || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
		end if;
                end foreach;
                       if v_FolReq > 0 then
		--return v_DetFolReq, 0, 0, v_importe_multa, v_tot_gastos  with resume;-------------------------------------------------
		--return 'Multa del Requerimiento con el folio : ' || v_folio_req , v_importe_multa  with resume;
		--return 'Gastos Generados por el Total de Requerimientos : ' , v_tot_gastos  with resume;
                       end if;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 2006 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' Cuota Normal, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' Excedencias, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;


  END FOR;
--     Grabando registro
--  v_importe_multa, v_tot_gastos
--   if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       Let v_Detalle_T = 'CONTRATO  ' || v_Num_Contrato || '  ' || v_tipo_aseo || ' NOMBRE : ' || v_nombre || 'DOMICILIO : ' || v_domicilio;
       return v_Detalle_T , v_totAdeudos, v_TotRecargos, v_importe_multa, v_tot_gastos  with resume;
--   end if;

   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
END FOREACH;

end procedure
;

CREATE PROCEDURE "egarcias".opcaja(
    p_orden VARCHAR(20)
)

--SELECT SUM(importe) FROM vw_operacion_caja
--SELECT id,descripcion,operaciones,importe,tiempo FROM vw_operacion_caja ORDER BY p_orden
--SELECT tiempo FROM vw_operacion_caja WHERE id = 3
--DATETIME YEAR TO MINUTE as fecha_act,

returning 
INT as suma,
INT as id,
VARCHAR(40) as descripcion,
DECIMAL(15) as operaciones,
MONEY(32,2) as total,
MONEY(32,2) as importe,
date as tiempo;

--****** parametros desde salida
define o_suma INT;
define o_id INT;
define o_descripcion VARCHAR(40);
define o_operaciones DECIMAL(15);
define o_importe MONEY(32,2);
define o_total MONEY(32,2);
define o_tiempo date;

--Obtenemos total de importes
	SET LOCK MODE TO WAIT;
	SELECT SUM(importe) 
	INTO o_total
	FROM vw_operacion_caja;

--Verifica que existen los datos
  SET LOCK MODE TO WAIT;
  --if NOT exists (SELECT * FROM vw_operacion_caja ORDER BY p_orden) then 
 	if o_total=0 then
      return null,null,null,null,null,null,null;
   	end if;

	SET LOCK MODE TO WAIT;
if trim(p_orden) ='importe' then
foreach
	SELECT id,descripcion,operaciones,importe,tiempo --id,descripcion,operaciones,importe,tiempo
	INTO o_id, o_descripcion, o_operaciones, o_importe, o_tiempo
	FROM vw_operacion_caja
	ORDER BY importe
       return o_total,o_id, o_descripcion, o_operaciones,o_total, o_importe, o_tiempo with resume;
end foreach;
end if;
if trim(p_orden) ='operaciones' then
foreach
	SELECT id,descripcion,operaciones,importe,tiempo --id,descripcion,operaciones,importe,tiempo
	INTO o_id, o_descripcion, o_operaciones, o_importe, o_tiempo
	FROM vw_operacion_caja
	ORDER BY operaciones
       return o_total,o_id, o_descripcion, o_operaciones,o_total, o_importe, o_tiempo with resume;
end foreach;
end if;


end procedure;

CREATE PROCEDURE "informix".elect_pagoespecial( 
    		parFecha 	  date,
    		pid_usuario 	  int,
                                 pid_modulo        int,
                pid_identificador int,
    		parImporte 	  money(15,2),
      parMesdesde 	smallint,
       parAxodesde 	smallint,
     parMeshasta  smallint,
     parAxohasta  smallint,
    		parlineacapt      char(30),
                parid_banco       int,
                partipocheq       int,
                parcheque         int,
                parfechabco      date,
		parOpc         int,
                 parlugarpgo    int
		
        )
		returning  integer , integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define parhora datetime hour to minute;
--
define parId_regmodulo integer;     -- cuenta o licencia
define parId_rec_cta 	smallint;   -- reca cuenta  , licencias nada
define parRegmunur	char(1); -- urbrus , licencias nada

define parNombre 	varchar(60);  
define parDomicilio 	varchar(60); 
define parConcepto 	varchar(60);
define parcveconcepto int;
define parRfcnumero  	integer; -- cvecuenta o idlicecnias
define  parctaaplic  int;
define continuar char(1);
define spoperacion int;
define varcvepago int;
--set debug file to "electronico.TXT";
--trace on;
let spoperacion = 0;
let continuar = 'N';


if pid_modulo = 5 then 
   select nombre_completo , u_calle || u_noexterior, cvecuenta , recaud, urbrus,cuenta  ,  extend(current, hour to minute)
   into parNombre , parDomicilio , parId_regmodulo , parId_rec_cta, parRegmunur,parRfcnumero , parhora
   from catastro_gdl:datos_gral where cvecuenta = Pid_identificador;
   let continuar = 'S';
      if parOpc = 1 then
        let parConcepto = 'DIFERENCIA A FAVOR DEL CONTRIBUYENTE EN IMPUESTO PREDIAL ';
        let parcveconcepto = 25;
        let parctaaplic  = 999900006;
     end if;
if parOpc = 2 then
  let parConcepto = 'PAGO DOBLE EN IMPUESTO PREDIAL';
  let parcveconcepto = 26;
  let parctaaplic  = 999900015;
 end if;
end if;
if pid_modulo = 9 then 
   select propietario , ubicacion || numext_ubic, id_licencia , 0, '',licencia ,  extend(current, hour to minute)
   into parNombre , parDomicilio , parRfcnumero, parId_rec_cta, parRegmunur, parId_regmodulo , parhora
   from catastro_gdl:licencias where licencia = pid_identificador;
   let continuar = 'S';
  if parOpc = 1 then
        let parConcepto = 'DIFERENCIA A FAVOR DEL CONTRIBUYENTE EN LICENCIA DE GIRO';
        let parcveconcepto = 27;
        let parctaaplic  = 999900006;
     end if;
    if parOpc = 2 then
        let parConcepto = 'PAGO DOBLE EN LICENCIA DE GIRO';
        let parcveconcepto = 28;
        let parctaaplic  = 999900015;
 end if;
end if;

if continuar = 'S' then

  select id_rec , caja  into varrec , varcaja 
  from ta_12_operaciones where id_usuario = pid_usuario ;

  execute procedure spd_abcrecibos_pe(parFecha ,varrec , varcaja , 0  , parImporte,
                'P' , 12, parRfcnumero,  parId_rec_cta, parRegmunur,
 parMesdesde,parAxodesde ,parMeshasta,parAxohasta,  parNombre, pardomicilio,
           parConcepto , '', pid_identificador ,0,
                0,0, pid_usuario ,current,parId_banco, partipocheq , parCheque,
parlineacapt  , parImporte ,'I' ,'' , parlugarpgo , parfechabco)

 into spoperacion;





  let varoperacion = spoperacion;

  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0, pid_identificador , varrec, varcaja, spoperacion, parFecha, parhora , 
                    parImporte, 'CAJERO', null, parcveconcepto);
  let varcvepago = dbinfo("sqlca.sqlerrd1"); 
              


insert into ta_12_recibosdet values(parFecha ,varrec , varcaja ,  varoperacion , 1, 
        parcveconcepto ,   parctaaplic, parImporte );
end if;     

return  spoperacion,varcvepago;
--trace off;
end procedure;

CREATE PROCEDURE "informix".con16_f3detade ( p_Mod Char(2), p_Control_contrato Integer)
	returning Integer,	        -- Control_contrato
		varchar(255),    -- Concepto
                               Money(12,2),    -- Importe Adeudos
                               Money(12,2),    -- Importe Recargos
                               Money(12,2),    -- Importe Multa
                               Money(12,2);    -- Importe Gastos
	               

{
#  Procedimiento: Con16_F3DetAde
#  Descripcion:  Genera una consulta del detalle de Adeudos de un contrato
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos
#  		         Importe : El importe de los Recargos
#  		         Importe : El importe de la Multa
#  		         Importe : El importe de los Gastos
#  		         Control : El Numero de Control de los Adeudos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago             						Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);



  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO, v_DetFolReq		varchar(120);

  define aso_proceso, aso_actual, v_FolReq						Integer;
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;


                Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = 'Folio(s) Requerido(s) : ';
                foreach
                     Select id_control,   folio,            importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || ',' || v_folio_req;
		else
		   Let v_DetFolReq = v_DetFolReq || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
		end if;
                end foreach;
                       if v_FolReq > 0 then
		return p_Control_contrato, v_DetFolReq, 0, 0, v_importe_multa, v_tot_gastos  with resume;
                       end if;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' Cuota Normal, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' Excedencias, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;

--     Grabando registro
   if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       Let v_Detalle_T = 'Adeudos del  ' || aso_proceso || '  ';
       if v_Lineas_CN > 0 then
                Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       end if;
       if v_Lineas_EX > 0 then
                Let v_Detalle_T = v_Detalle_T|| '  ' || v_Detalle_EX;
       end if;
       return p_Control_contrato, v_Detalle_T , v_totAdeudos, v_TotRecargos, 0, 0  with resume;
   end if;

   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;

  END FOR;

end procedure;

CREATE PROCEDURE "informix".con16_f4detcont ( p_Mod Char(2), p_Control_contrato Integer, p_Control_Adeudo Char(1))
	returning  Integer,             -- Control del contrato
		Integer,             -- Numero del contrato
		varchar(20),      -- Tipo de aseo
		varchar(80),       -- Nombre de la empresa
		varchar(80),       -- Domicilio de recoleccion del contrato
		Integer,              -- Cantidad de unidades de recoleccion
		varchar(20),      -- Tipo de unidades a recoleccion
		char(1),             -- Sector de recoleccion
		Integer,             -- Recaudadora donde se suscribe el contrato
		Date,                -- Fecha de inicio de obligacion
		Date;                -- Fecha de cancelacion del contrato

{
#  Procedimiento: Con16_F4DetCont
#  Descripcion:  Genera una consulta del Contrato con control de importe
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#                                        p_Control_adeudo : solo imprime si existe contrato
#  Parametros de salida:   todos los datos del contrato
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec	Integer;
  define v_nombre, v_domicilio	, v_tipo_aseo					varchar(80);
  define v_tipo_recolec							varchar(20);
  define v_sector								Char(1);
  define v_fecha_ini, v_fecha_hora_baja						Date;

  define v_Aso, v_Mes, v_Mes_x, Aso_Hoy, Mes_v, Dia_v		varchar(4);
  define Mes_Hoy						varchar(2);
  define v_Periodo_CN, v_Periodo_EXE				varchar(7);

  define v_importe_multa, v_importe_gastos, v_totapremio		Money(12,2);

  define v_Adeudos, v_importe				Money(12,2);


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;
  
----------------------
       Let v_Control = 0;
       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, 
                  a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, 
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.control_contrato = p_Control_contrato
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec;

       Let v_totapremio = 0;
       Let v_importe_multa = 0;
       Let v_importe_gastos = 0;

                foreach
                Select importe_multa, importe_gastos
                Into v_importe_multa, v_importe_gastos 
                from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato and vigencia = "1" and clave_practicado = "P"
                                Let v_totapremio = v_totapremio + v_importe_gastos;
                end foreach;
                                Let v_totapremio = v_totapremio + v_importe_multa;
	-------------------------------------CONSULTA DE CUOTA NORMAL
	Let v_Adeudos = 0;
             	Let v_importe = 0;
                foreach
    	Select h.importe
        	Into v_importe
     	From ta_16_pagos H
     	        	Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		and H.aso_mes_pago <= (v_Periodo_CN) and H.Status_Vigencia = 'V'
                                   	Let v_Adeudos = v_Adeudos + v_importe;
                end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
             	Let v_importe = 0;
                foreach
    	Select h.importe
        	Into v_importe
     	From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
          		 and H.aso_mes_pago <= (v_Periodo_EXE) and H.Status_Vigencia = 'V'
                                   	Let v_Adeudos = v_Adeudos + v_importe;
                end foreach;
      -------------------------------------  IMPRESION DE CONTRATOS
          

      IF p_Control_Adeudo = 'T' then
           return v_Control, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja;
      ELSE
               IF p_Control_Adeudo = 'C' THEN
                       IF (v_totapremio <> 0) OR (v_Adeudos <> 0) THEN
                              return v_Control, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja;
                       END IF;
               ELSE
                       IF (v_totapremio = 0) AND (v_Adeudos = 0) THEN
                              return v_Control, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja;
                       END IF;
               END IF;
      END IF;

end procedure;

CREATE PROCEDURE "informix".con16_f9detade ( p_Axo Integer, p_Ctrol_contrato Integer)
	returning  integer,	       -- Control del contrato
		varchar(255),    -- Concepto
                                Money(12,2),    -- Importe Adeudos
                                Money(12,2),    -- Importe Recargos
                                Money(12,2),    -- Importe Multa
                                Money(12,2);    -- Importe Gastos

{
#  Procedimiento: con16_f9detade
#  Descripcion:  Genera una consulta del detalle de Adeudos por a�o
#  Parametros de entrada: p_Axo : axo de corte
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   p_Control_contrato : id de busqueda del Contrato
#		         Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos
#  		         Importe : El importe de los Recargos
#  		         Importe : El importe de la Multa
#  		         Importe : El importe de los Gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_importe_multa, v_importe_gastos, v_tot_gastos 				Money(12,2);
  define v_importe, v_Importe_recargo, v_totAdeudos, v_TotRecargos			Money(12,2);
  define v_aso_mes_pago             						Date;
  define v_Ctrol_Operacion, v_id_control, v_FolReq, v_folio_req, aso_proceso, aso_actual	Integer;
  define v_Mes								varchar(2);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO, v_DetFolReq		varchar(120);

       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;


                Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = 'Folio(s) Requerido(s) : ';
                foreach
                     Select id_control,   folio,            importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Ctrol_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || ',' || v_folio_req;
		else
		   Let v_DetFolReq = v_DetFolReq || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
		end if;
                end foreach;
                       if v_FolReq > 0 then
		return p_Ctrol_contrato, v_DetFolReq, 0, 0, v_importe_multa, v_tot_gastos  with resume;
                       end if;

  Let v_importe = 0;
  Let v_Importe_recargo = 0;
  Let aso_proceso = 0;
  Let aso_actual = p_Axo;

  FOR aso_proceso = 1989 to aso_actual
   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_multa = 0;
   Let v_tot_gastos = 0;
	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' Cuota Normal, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Ctrol_contrato and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' Excedencias, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Ctrol_contrato and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;


   IF  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       LET v_Detalle_T = ' Adeudos del ' || aso_proceso || ' ';
       IF v_Lineas_CN > 0 then
                LET v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       END IF;
       IF v_Lineas_EX > 0 then
                LET v_Detalle_T = v_Detalle_T|| '  ' || v_Detalle_EX;
       END IF;
       RETURN p_Ctrol_contrato, v_Detalle_T , v_totAdeudos, v_TotRecargos, v_importe_multa, v_tot_gastos  with resume;
   END IF;

  END FOR;

end procedure
;

CREATE PROCEDURE "bcabrera".kiosco_datosmerc(
p_id integer,
p_meses smallint)	-- 0 todo el adeudo, 1..999 solo meses a pagar

returning  	integer as id,		-- id_local
    varchar(30) as registro,     -- registro
    smallint as m_vencidos,       -- meses vencidos
	smallint as mesdsd,		-- mes desde
	smallint as axodsd,		-- a�o desde
	smallint as meshst,		-- mes hasta
	smallint as axohst,		-- a�o hasta
	char(30) as nombre,		-- nombre
	char(20) as adicional,  	-- adicional
	decimal(10,2) as superficie,	-- superficie
	money(15,2) as adeudo,	-- adeudo
	money(15,2) as recargos,	-- recargos
	money(15,2) as multa,	-- multa
	money(15,2) as gastos,	-- gastos
	money(15,2) as total,	-- total
--	money(15,2),	-- descuento
	char(30) as mercado,		-- nombre mercado
	smallint as estatus,		-- estatus	
	char(60) as mensaje,		-- mensaje
    char(28) as linea,          -- linea de captura
    varchar(100) as descripcion;   -- descripcion del registro

define v_estatus smallint;
define v_registro varchar(30);
define v_meses smallint;
define v_merc smallint;
define v_linea char(28);
define v_linea2 char(28);
define v_perdsd integer;
define v_perhst integer;
define v_id_local,v_id integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra char(1); 
define v_bloque char(1);
define v_nombre char(30);
define v_domicilio char(40);
define v_adicional char(20);
define v_superficie decimal(10,2);
define v_adeudo money(15,2);
define v_recargos money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_descuento money(15,2);
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_folio integer;
define v_per smallint;
define v_aid_local integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc integer;
define v_total money(15,2);
define v_ofn,v_cat,v_loc integer;
define v_sec char(2);
define v_descreg varchar(100);
define v_redon money(3,2);

 
let v_id_local=0;
let v_meses=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_nom_mercado='';
let v_descripcion='';
let v_estatus=0;
let v_recargos=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_linea='';
let v_linea2='';
let v_perdsd=0;
let v_perhst=0;
let v_registro='';
let v_descreg='';
let v_redon=0;

if not exists(select * from ta_11_locales where id_local=p_id) then
   let v_estatus=2;
   let v_descripcion='NO EXISTE LOCAL';
else
     -- obtiene los datos generales
    foreach
    select c.id_local,c.id_contribuy_renta,c.nombre,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
c.oficina,c.num_mercado,c.categoria,c.seccion,c.local,c.letra_local,c.bloque 
    into   v_id_local,v_desc,v_nombre,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado,
v_ofn,v_merc,v_cat,v_sec,v_loc,v_letra,v_bloque
    from   ta_11_locales c,ta_11_mercados e
    where c.id_local=p_id
    and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado

    let v_per=0;
    let v_porc=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    let v_registro=v_ofn||'-';
    if  v_merc <10 then let v_registro=v_registro||'00'||v_merc||'-'||v_cat||'-'||v_sec||'-';
    else if  v_merc <99 then let v_registro=v_registro||'0'||v_merc||'-'||v_cat||'-'||v_sec||'-';
    else let v_registro=v_registro||v_merc||'-'||v_cat||'-'||v_sec||'-';
    end if;
    end if;
    if  v_loc <10 then let v_registro=v_registro||'00000'||v_loc||'-';
    else if v_loc <99 then let v_registro=v_registro||'0000'||v_loc||'-';
    else if v_loc <999 then let v_registro=v_registro||'000'||v_loc||'-';
    else if v_loc <9999 then let v_registro=v_registro||'00'||v_loc||'-';
    else if v_loc <99999 then let v_registro=v_registro||'0'||v_loc||'-';
    end if;
    end if;
    end if;
    end if;
    end if;

    if  v_letra is null then
        let v_letra='';
    end if;
    if  v_bloque is null then
        let v_bloque='';
    end if;
    let v_registro=v_registro||v_letra||'-'||v_bloque;

    let v_descreg='Recaudadora: '||v_ofn||' Mercado: '||v_merc||' Categoria: '||v_cat||
' Seccion: '||v_sec||' local: '||v_loc||' Letra del local: '||v_letra||' Bloque del Local: '||v_bloque;

    if  v_bloqueo=1 then
        let v_estatus=3;
        let v_descripcion='LOCAL CONVENIADO'; 
    else                   
    if  v_vigencia<>'A' then
        let v_estatus=4;
        let v_descripcion='LOCAL DADO DE BAJA';
    else
    if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and 
                 ((axo=year(today) and periodo<=month(today)) or (axo<year(today)))) then 	
       let v_estatus=5;
       let v_descripcion=' LOCAL AL CORRIENTE DE PAGOS';
    else 
       let v_recacum=0; 

    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

    -- para sacar el mes minimo       
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

    -- calcula los meses a pagar en base al parametro de entrada
    if p_meses=0 then
       let v_axocalc=year(today);
       let v_mescalc=month(today);
    else
    if p_meses=1 then
       let v_axocalc=v_axomin;
       let v_mescalc=v_mesmin;
    else 
       for v_contador= 1 to p_meses-1
           if  ((v_mesmin=12) and (v_merc <>214)) or ((v_mesmin=4) and (v_merc =214)) then 
               let v_mesmin=1;
               let v_axomin=v_axomin + 1;
           else
               let v_mesmin=v_mesmin + 1;
           end if;
       end for;
       let v_axocalc=v_axomin;
       let v_mescalc=v_mesmin;
    end if;
    end if;
         
    -- para obtener los datos de multa y gastos
    select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
    into     v_multa,v_folio,v_gastos
    from    ta_15_apremios a  
    where modulo=11
    and control_otr=v_id_local
    and vigencia='1'
    and clave_practicado='P';

    -- para obtener los meses venciados
    select nvl(count(*),0) into v_meses
    from  ta_11_adeudo_local  
    where id_local=v_id_local
    and ((axo=v_axocalc and periodo<=v_mescalc) or (axo<v_axocalc)); 

    -- todos los adeudos pendientes hasta mes actual
    foreach
    select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
    into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
    from    ta_11_adeudo_local a,ta_11_fecha_desc b 
    where id_local=v_id_local
    and ((a.axo=v_axocalc and a.periodo<=v_mescalc) or (a.axo<v_axocalc)) 
    and b.mes=month(today)
    order by axo,periodo

    if v_merc=214 then
       let v_impcalc=(v_aimporte*(100-v_desc))/100;
    else
       let v_impcalc=v_aimporte;
    end if;
  
    if v_mesdsd=0 then
       let v_mesdsd=v_aperiodo;
    end if;
  
    if v_axodsd=0 then
       let v_axodsd=v_aaxo;
    end if; 

    let v_meshst=v_aperiodo;
    let v_axohst=v_aaxo;  

    -- obtiene el porcentaje de recargos
    if v_merc <>214 then 	
       if today>=v_fecha_rec then
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
       end if;
    else 
       if v_aperiodo=1 then let v_primermes=1;
       else if v_aperiodo=2 then let v_primermes=4;
       else if v_aperiodo=3 then let v_primermes=7;
       else if v_aperiodo=4 then let v_primermes=10;
       else let v_primermes=0;
       end if;
       end if;
       end if;
       end if;

       if v_primermes=month(today) then
          if today>=v_fecha_rec then
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
          else
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
          end if;
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
       end if;
    end if;

    if  v_porc is null then
        let v_porc=0;
    end if;

    if  v_folio = 0 then
        if v_porc > 100 then
           let v_recacum=trunc(v_impcalc*100)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    else
        if v_porc > 250 then
           let v_recacum=trunc(v_impcalc*250)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    end if;

    let v_recargos=v_recargos+v_recacum;
	
    if v_merc<>214 then
       if v_aaxo=year(today) and v_aperiodo=month(today) then
          if today>v_fecha_desc then
             let v_adeacum=v_aimporte;
          else
             let v_adeacum=v_aimporte-(v_aimporte*.10);
             let v_descuento=v_aimporte*.10;
          end if;
       else
          let v_adeacum=v_aimporte;
       end if;
    else
       let v_adeacum=v_impcalc;
       let v_descuento=v_descuento+(v_aimporte-v_impcalc);
    end if;

    let v_adeudo=v_adeudo+v_adeacum;

    let v_estatus=0;
    let v_descripcion='SE PUEDE COBRAR';
    end foreach;
    end if;
    end if;
    end if;
    end foreach;
    let v_total=v_adeudo+v_recargos+v_multa+v_gastos;
--ajuste al peso.
  let v_redon = (trunc(v_total) + 1 ) - v_total ;
 if v_redon <> 0 then
    let v_total=v_total + v_redon;
 end if;

end if;
let v_perdsd=v_axodsd||v_mesdsd;
let v_perhst=v_axohst||v_meshst;

if v_estatus=0 then
   execute procedure linea_capturamrc(v_id_local,v_perdsd,v_perhst,v_adeudo,
v_recargos,v_gastos,v_multa,v_total,today) into v_linea,v_linea2;
end if;

return v_id_local,v_registro,v_meses,v_mesdsd,v_axodsd,v_meshst,v_axohst,v_nombre,v_adicional,
v_superficie,v_adeudo,v_recargos,v_multa,v_gastos,v_total,v_nom_mercado,v_estatus,v_descripcion,
v_linea2,v_descreg;
end procedure;

CREATE PROCEDURE "gmoreno".con16_f5detcont ()
	returning  varchar(50),      -- Tipo de aseo
		varchar(50),      -- Contrato
        		Money(12,2);    -- Adeudo Total

{
#  Procedimiento: Con16_F5DetCont
#  Descripcion:  Genera una consulta del Contrato con control de importe
#  Parametros de entrada: ninguno
#  Parametros de salida:   todos los datos del contrato mas su importe total de adeudo
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec	Integer;
  define v_nombre, v_domicilio	, v_tipo_aseo					varchar(80);
  define v_tipo_recolec							varchar(20);
  define v_sector								Char(1);
  define v_fecha_ini, v_fecha_hora_baja						Date;
  define v_aso_mes_pago             						Date;

  define v_id_control                               Integer;
  define v_Aso, v_Mes, v_Mes_x, Aso_Hoy, Mes_v, Dia_v		varchar(4);
  define Mes_Hoy						varchar(2);
  define v_Periodo_CN, v_Periodo_EXE				varchar(7);

  define v_importe_multa, v_importe_gastos, v_totapremio, v_Importe_recargo		Money(12,2);

  define v_Adeudos, v_importe				Money(12,2);


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;
  
----------------------
       Let v_Control = 0;

  FOREACH
       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, 
                  a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, 
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec
       Order by a.ctrol_aseo, a.num_contrato

       Let v_totapremio = 0;
       Let v_importe_multa = 0;
       Let v_importe_gastos = 0;

                foreach
                Select id_control, importe_multa, importe_gastos
                Into v_id_control, v_importe_multa, v_importe_gastos 
                from ta_15_apremios
                       Where modulo = 16  And control_otr = v_Control and vigencia = "1" and clave_practicado = "P"
                        Order by id_control
                                Let v_totapremio = v_totapremio + v_importe_gastos;
                end foreach;
                                Let v_totapremio = v_totapremio + v_importe_multa;
	-------------------------------------CONSULTA DE CUOTA NORMAL
	Let v_Adeudos = 0;
             	Let v_importe = 0;
	Let v_Importe_recargo = 0;
                foreach
    	Select h.aso_mes_pago, h.importe
        	Into v_aso_mes_pago, v_importe
     	From ta_16_pagos H
     	        	Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 6 
          		and H.aso_mes_pago <= (v_Periodo_CN) and H.Status_Vigencia = 'V'
                                   	Let v_Adeudos = v_Adeudos + v_importe;

                                             Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                             From ta_16_recargos 
                                                    Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);
  		              if v_Importe_recargo <> 0 then
     		                     Let v_Adeudos = v_Adeudos + ((v_importe * v_Importe_recargo) / 100);
  		              end if;
                end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
             	Let v_importe = 0;
                foreach
    	Select h.aso_mes_pago, h.importe
        	Into v_aso_mes_pago, v_importe
     	From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion <> 6 
          		 and H.aso_mes_pago <= (v_Periodo_EXE) and H.Status_Vigencia = 'V'
                                   	Let v_Adeudos = v_Adeudos + v_importe;

                                             Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                             From ta_16_recargos 
                                                    Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);
  		              if v_Importe_recargo <> 0 then
     		                     Let v_Adeudos = v_Adeudos + ((v_importe * v_Importe_recargo) / 100);
  		              end if;
                end foreach;
      -------------------------------------  IMPRESION DE CONTRATOS
--if (v_Num_Contrato = 4) and (v_Ctrol_Aseo = 9) then
--   return 'de ' || v_aso_mes_pago, ' a ' || v_Periodo_EXE, v_Adeudos with resume;
--else

          IF (v_totapremio <> 0) OR (v_Adeudos <> 0) THEN
              return 'TIPO DE ASEO : ' || v_tipo_aseo, 'NUMERO DE CONTRATO : ' || v_Num_Contrato, v_totapremio + v_Adeudos with resume;
          END IF;
--end if;
  END FOREACH;
end procedure;

CREATE PROCEDURE "bcabrera".kiosco_totalesmerc(p_id integer,p_axo smallint,p_mes smallint,p_redon char(1))	

returning  	integer as id,		
    integer as cuenta,
    char(1) as obligatorio,
    char(60) as concepto,
	money(15,2) as importe;

define v_cuenta integer;
define v_ctarezago integer;
define v_merc smallint;
define v_perdsd integer;
define v_perhst integer;
define v_id_local,v_id integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_adeudo money(15,2);
define v_recargos money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_descuento money(15,2);
define v_folio integer;
define v_per smallint;
define v_aid_local integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc integer;
define v_total money(15,2);
define v_redon money(3,2);

 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_recargos=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_perdsd=0;
let v_perhst=0;
let v_redon=0;

     -- obtiene los datos generales
    foreach
    select nvl(a.id_local,0),a.id_contribuy_renta,nvl(a.num_mercado,0),
nvl(b.cuenta_ingreso,0),nvl(b.cuenta_rezago,0) 
    into   v_id_local,v_desc,v_merc,v_cuenta,v_ctarezago
    from   ta_11_locales a,ta_11_mercados b
    where a.id_local=p_id
    and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado

    let v_per=0;
    let v_porc=0;
    if  v_desc is null then
        let v_desc=0;
    end if;

    let v_recacum=0; 

    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

    -- para sacar el mes minimo       
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;
       
    -- todos los adeudos hasta periodo de entrada
    foreach
    select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
    into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
    from    ta_11_adeudo_local a,ta_11_fecha_desc b 
    where id_local=v_id_local
    and ((a.axo=p_axo and a.periodo<=p_mes) or (a.axo<p_axo)) 
    and b.mes=month(today)
    order by axo,periodo

    if v_merc=214 then
       let v_impcalc=(v_aimporte*(100-v_desc))/100;
    else
       let v_impcalc=v_aimporte;
    end if;
  
    if v_mesdsd=0 then
       let v_mesdsd=v_aperiodo;
    end if;
  
    if v_axodsd=0 then
       let v_axodsd=v_aaxo;
    end if; 

    let v_meshst=v_aperiodo;
    let v_axohst=v_aaxo;  

    -- obtiene el porcentaje de recargos
    if v_merc <>214 then 	
       if today>=v_fecha_rec then
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
       end if;
    else 
       if v_aperiodo=1 then let v_primermes=1;
       else if v_aperiodo=2 then let v_primermes=4;
       else if v_aperiodo=3 then let v_primermes=7;
       else if v_aperiodo=4 then let v_primermes=10;
       else let v_primermes=0;
       end if;
       end if;
       end if;
       end if;

       if v_primermes=month(today) then
          if today>=v_fecha_rec then
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
          else
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
          end if;
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
       end if;
    end if;

    if  v_porc is null then
        let v_porc=0;
    end if;

    if  v_folio = 0 then
        if v_porc > 100 then
           let v_recacum=trunc(v_impcalc*100)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    else
        if v_porc > 250 then
           let v_recacum=trunc(v_impcalc*250)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    end if;

    let v_recargos=v_recargos+v_recacum;
	
    if v_merc<>214 then
       if v_aaxo=year(today) and v_aperiodo=month(today) then
          if today>v_fecha_desc then
             let v_adeacum=v_aimporte;
          else
             let v_adeacum=v_aimporte-(v_aimporte*.10);
             let v_descuento=v_aimporte*.10;
          end if;
       else
          let v_adeacum=v_aimporte;
       end if;
    else
       let v_adeacum=v_impcalc;
       let v_descuento=v_descuento+(v_aimporte-v_impcalc);
    end if;

    let v_adeudo=v_adeudo+v_adeacum;

    end foreach;

    if v_merc=214 then
       return v_id_local,v_cuenta,"S", 'PAGO TRIMESTRAL DEL '||
              v_mesmin||'-'||v_axomin||' AL '||p_mes||'-'||p_axo, v_adeudo with resume;
       return v_id_local,570100000,"S", 'RECARGOS', v_recargos with resume;
    else
       return v_id_local,v_cuenta,"S", 'RENTA MENSUAL DEL '||
              v_mesmin||'-'||v_axomin||' AL '||p_mes||'-'||p_axo, v_adeudo with resume;
       return v_id_local,390400000,"S", 'RECARGOS', v_recargos with resume;
    end if;

    -- para obtener los datos de multa y gastos
    select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
    into    v_multa,v_folio,v_gastos
    from    ta_15_apremios a  
    where modulo=11
    and control_otr=v_id_local
    and vigencia='1'
    and clave_practicado='P';

    return v_id_local,992100009,"S", 'GASTOS', v_gastos with resume;
    return v_id_local,510500000,"S", 'MULTA', v_multa with resume;
    end foreach;
    let v_total=v_adeudo+v_recargos+v_multa+v_gastos;

--ajuste al peso.
   if p_redon='S' then
      let v_redon = (trunc(v_total) + 1 ) - v_total ;
      if v_redon <> 0 then
         return v_id_local,550800000,"S", "AJUSTE ARTICULO 14 DE LA LEY DE INGRESOS", v_redon  with resume;
      end if;
   end if;

end procedure;

CREATE PROCEDURE "informix".linea_estatus(
    p_id INT,
    p_usuario CHAR(8)
)

{######################################################################
#  Procedimiento:    linea_estatus
#  Descripcion:      Cambia el estatus de linea pago de D=diferencia a N=normal
#  Parametros       
#  de entrada:        
#  Parametros
#  de salida:        
#  Elaboro:          Marco A. Ortega Navarro
#
#  Llamado por:      Aplicacion de Bancos
#  Llama a:          
######################################################################}

RETURNING
	int as estatus, -- estatus de carga
	VARCHAR ( 200 ) as mensaje; --descripcion del estatus
--** ESTATUS para linea_pago C=carga, A=aplicado, N=conciliado sin error, D=diferencia en importes 

define estatus int;
define mensaje varchar(200);

define v_linea VARCHAR(50);
define v_id_linea int;
define v_folio int;
define v_foliotrans int;
define v_modulo int;
define v_id_cont int;
define v_estatus char(1);
define v_fecha_pago date;
define v_fecha_impresion datetime year to second;
define v_importe money(16,2);
define v_cvepago char(1);
define v_importe_conc money(16,2);
define v_fecha_concilia datetime year to second;
define v_forma_carga char(1);

--set debug file to "lineacap.log";
--   trace on;

  --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where id = p_id) then
      select l.estatus,fecha_pago,fecha_impresion,forma_carga into v_estatus,v_fecha_pago,v_fecha_impresion,v_forma_carga
	      from linea_pagos l where id = p_id;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --Esta conciliada correctamente
	 let estatus = 8;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO YA ESTA CONCILIADA CORRECTAMENTE";
         return estatus,mensaje;
      end if;
      --actualiza estatus de pago a N para poder procesarlo
	 update  linea_pagos set
     			estatus="N" ,
     			usuario=p_usuario
	 where id = p_id;
         let estatus = 0;
         let mensaje = "LINEA DE PAGO ACTUALIZADA";
         return estatus,mensaje;
   else --si no esta cargada la linea de captura en pagos
      return 9,"LA LINEA DE CAPTURA NO EXISTE";
   end if;--no existe linea captura en pagos
end procedure;

CREATE PROCEDURE "informix".spd_abcrecibos_pe(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 	char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta     smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia   smallint,
		parObra         smallint,
		parAxofolio     integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                partipo_che     smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc          char(1),
		parDescripcion  varchar(255) , parlugar int, parfecbanco date
		)
		returning integer;

		define varOperacion integer;
 define varuap_rcm  integer;
 define varpar  smallint;

--set debug file to "marco.log";
--trace on;

--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;

--si la opcion fue insertar
if 	parOpc='I' then
	
	select nvl(operacion,0) + 1
		into varOperacion 
		from ta_12_operaciones
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario;

	--if	varOperacion = 10000 then
	--	let varOperacion = 1;
	--end if;
     insert into ta_12_recibos(
     		fecha , id_rec ,
     		caja , operacion ,
     		importe , cvepago ,
     		id_modulo , id_regmodulo ,
     		id_rec_cta , regmunur ,
     		mesdesde , axodesde ,
     		meshasta , axohasta ,
     		nombre , domicilio ,
     		concepto , rfcini ,
     		rfcnumero , rfccolonia ,
     		obra , axofolio ,
     		id_usuario , fecha_act,
		descripcion, lugar_pago,fec_pagobco ) 
     values(	parFecha, parId_rec,
    		parCaja, varOperacion,
    		parImporte, parCvepago,
    		parId_modulo, parId_regmodulo,
    		parId_rec_cta, parRegmunur,
    		parMesdesde, parAxodesde,
    		parMeshasta, parAxohasta,
    		parNombre, parDomicilio,
    		parConcepto, parRfcini,
    		parRfcnumero, parRfccolonia,
		parObra, parAxofolio,
    		parId_usuario, current,
		parDescripcion, parlugar,parfecbanco);


	update	ta_12_operaciones set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario;
	
	if	parId_banco > 0 then
		insert	into ta_12_cheques ( fecha ,    id_rec,
    caja ,    operacion,    id_banco ,    cheque,    cuenta ,    importe ,    tipo_pag ,
    datos_internet ) values(
    			parFecha,
    			parId_rec,
    			parCaja,
    			varOperacion,
			parId_banco,
			parCheque,
			parCuenta,
			parImpCheque,
			Partipo_che ,null);
	end if;

end if;
if 	parOpc='C' then
    -- para orden de pago
    if exists(select * from ta_12_recibosdiv where fecha=parFecha and id_rec=parId_rec and
              caja=parCaja and operacion=parOperacion) then
       update ta_12_recibosdiv set caja='',operacion=0,cvepago='V'
       where fecha=parFecha and id_rec=parId_rec and
              caja=parCaja and operacion=parOperacion;
    end if; 
	
	update ta_12_recibos set
    		cvepago=parCvepago,				
    		id_usuario=parId_usuario,
		fecha_act=current
                                where
		fecha=parFecha and
		id_rec=parId_rec and
    		caja=parCaja and
    		operacion=parOperacion;

	if	parId_banco > 0 then
		delete	from ta_12_cheques where fecha=parFecha and
    			id_rec=parId_rec and caja=parCaja and operacion=parOperacion;
			
	end if;
                if   parId_modulo=13 then

	 delete from ta_13_pagosrcm where  fecing=parFecha and
		recing=parId_rec and
    		cajing=parCaja and
    		opcaja=parOperacion and
                                control_rcm=parId_regmodulo;
                 select max(axo_pago_hasta) into varuap_rcm
                             from ta_13_pagosrcm where 
                                control_rcm=parId_regmodulo;
                if varuap_rcm is null then
                 update ta_13_datosrcm set axo_pagado =1999
                            where  control_rcm=parId_regmodulo;
               else
                update ta_13_datosrcm set axo_pagado =varuap_rcm
                            where  control_rcm=parId_regmodulo;
                end if;
                 end if;	
               if   parId_modulo=16 then
	   update ta_16_pagos set  id_rec=0, caja=' ',consec_operacion=0,status_vigencia="V"
                   where  date(fecha_hora_pago)=parFecha and id_rec=parId_rec and
    		caja=parCaja and consec_operacion=parOperacion and
                                control_contrato=parId_regmodulo;
                 update ta_15_apremios set fecha_pago =0,recaudadora=0,caja='',operacion=0,vigencia='1'
                            where  modulo=16 and fecha_pago=parFecha and
		recaudadora=parId_rec and
    		caja=parCaja and
    		operacion=parOperacion;
                 end if;	
               if   (parId_modulo=17) and (parId_rec_cta  in (16,15,11))  then
	   DELETE FROM ta_17_pagos
                   where  fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
    		caja_PAGO=parCaja and operacion_PAGO=parOperacion and
                                id_convenio=parId_regmodulo;
                 end if;	
               if   (parId_modulo=17) and (parId_rec_cta  not in (16,15,11))  then
                    foreach
                    select pago_parcial    into varpar from   ta_17_conv_pagos where 
                              fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
    	              caja_PAGO=parCaja and operacion_PAGO=parOperacion and
                               id_conv_resto=parId_regmodulo
	   update ta_17_adeudos_div set clave_pago =null
                   where  id_conv_resto=parId_regmodulo and pago_parcial=varpar;
                 end foreach;
                 end if;	
               if   (parId_modulo=17) and (parId_rec_cta  not in (16,15,11))  then
	   DELETE FROM ta_17_conv_pagos
                   where  fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
    		caja_PAGO=parCaja and operacion_PAGO=parOperacion and
                                id_conv_resto=parId_regmodulo;
                 end if;	
end if;
--para orden de pago
if 	parOpc='O' then
	
	select nvl(operacion,0) + 1
		into varOperacion 
		from ta_12_operaciones
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario;

    update ta_12_recibosdiv set fecha=parFecha,id_rec=parId_rec,
           caja=parCaja,operacion=varOperacion,cvepago='P'
           where id_recibo=parOperacion;

	insert into ta_12_recibos (fecha , id_rec ,
     		caja ,operacion ,
     		importe ,cvepago ,
     		id_modulo ,id_regmodulo ,
     		id_rec_cta ,regmunur ,
     		mesdesde ,axodesde ,
     		meshasta ,axohasta ,
     		nombre ,domicilio ,
     		concepto ,rfcini ,
     		rfcnumero ,rfccolonia ,
     		obra ,	axofolio ,
     		id_usuario ,fecha_act,
		descripcion, lugar_pago ,fec_pagobco)
          values(parFecha, parId_rec,
    		parCaja, varOperacion,
    		parImporte, parCvepago,
    		parId_modulo, parId_regmodulo,
    		parId_rec_cta, parRegmunur,
    		parMesdesde, parAxodesde,
    		parMeshasta, parAxohasta,
    		parNombre, parDomicilio,
    		parConcepto, parRfcini,
    		parRfcnumero, parRfccolonia,
		parObra, parAxofolio,
    		parId_usuario, 
   	current, parlugar,parfecbanco);


	update	ta_12_operaciones set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario;
	
	if	parId_banco > 0 then
		insert	into ta_12_cheques ( fecha ,    id_rec,
    caja ,    operacion,    id_banco ,    cheque,    cuenta ,    importe ,    tipo_pag ,
    datos_internet ) values(
    			parFecha, parId_rec,
    			parCaja, varOperacion,
			parId_banco, parCheque,
			parCuenta, parImpCheque,
			Partipo_che,null);
	end if;

end if;


return varOperacion;
--trace off;

end procedure;

CREATE PROCEDURE "bcabrera".kiosco_pagomerc(
plinea varchar(28),
pCertificado money(15,2),
pKiosco	integer)

returning smallint as rec , char(2) as caja, integer as operacion , char(28) as linea;

define varFecha date;
define varrec smallint;
define varCaja char(2);
define varOperacion integer;
define v_id_local int;
define v_ofn smallint;
define v_merc smallint;
define v_cat smallint;
define v_sec char(2); 
define v_let char(15) ;
define v_local int;
define v_blq char(15);
define v_linea char(28); 
define v_nombre char(60);
define v_domicilio char(60);
define v_adicional char(20);
define v_mercado char(30);
define spoperacion integer;
define linea integer ;
define cuenta integer;
define parid integer ;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(50); define v_redondeo money(3,2);
define v_concrbo char(60);
define v_id int;
define paraxodesde int;
define parmesdesde int;
define paraxohasta int;
define parmeshasta int;
define varcvepago int;
define v_descriprbo varchar(60);
define estatus int ; define mensaje varchar(100);
define v_aid_local,v_aaxo,v_aperiodo,v_folio,v_idcontrol integer;
define v_aimporte,v_gastos money(15,2);
define v_desc,v_dmes smallint;
define v_fecha_desc date;
define v_cuenta integer;

let parid =0;  

let v_linea = '' ;
--datos de la linea.
 select nvl(id_local,0), nvl(substr(a.desde,1,4),0),nvl(substr(a.desde,5,2),0),
 nvl(substr(a.hasta,1,4),0), nvl(substr(a.hasta,5,2),0) , a.linea
 into parid , paraxodesde , parmesdesde, paraxohasta ,parmeshasta , v_linea
 from linea_capturamrc 
 where trim(linea) = trim(plinea);
if v_linea = '' then 
return 0, '', 0 , plinea;

else
-- sacar el numero de local
if (parid > 0)  then
    select nvl(a.id_local,0),nvl(a.id_contribuy_renta,0),a.oficina,a.num_mercado,a.categoria,
a.seccion,a.local,a.letra_local,a.bloque,a.nombre,a.domicilio,a.descripcion_local,b.descripcion
    into v_id_local,v_desc,v_ofn,v_merc,v_cat,v_sec,v_local,v_let,v_blq,v_nombre,
v_domicilio,v_adicional,v_mercado
    from ta_11_locales a,ta_11_mercados b
    where a.id_local= parid
    and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado; 

if v_let is null then
   let v_let='';
end if;
if v_blq is null then
   let v_blq='';
end if;
if v_merc=214 then
   let v_concrbo='PAGO TRIMESTRAL DEL '||v_mercado;
else
   let v_concrbo='PAGO RENTA MENSUAL DEL MERCADO '||v_merc||' '||v_mercado;
end if;
let v_descriprbo = 'MERCADO: '||v_mercado||' LOCAL: '||v_local||'LETRA: '||v_let||'BLOQUE: '||v_blq||
' ID LOCAL: '||parid;

-- obtiene la recaudadora y caja del kiosco   
select id_rec , caja  into varrec , varcaja
from ta12_operacKiosco where id_usuario = pkiosco;

-- inserta el recibo 
execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , pCertificado,
                'P' , 11, parid, v_ofn, 'M',
              parmesdesde, parAxodesde, parmeshasta, parAxohasta,
                v_nombre, v_domicilio,
           v_concrbo , v_sec,v_local,v_merc,
                v_cat,0,pkiosco,current,0,0,0,'',0,'I',v_descriprbo)
 into spoperacion;

  let varoperacion = spoperacion;
              
let linea = 1;     
let v_suma =0;

FOREACH -- ejecuta el procedimiento de totales
execute procedure  kiosco_totalesmerc( v_id_local , paraxohasta,parmeshasta,'S') 
    into v_id ,v_cuenta , v_ob , v_concepto , v_importe

-- inserta el detalle de cuentas 
insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );
       let linea = linea +1; 
       let v_suma = v_suma + v_importe;
end FOREACH;
 
-- todos los adeudos del periodo de linea de captura
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento 
into v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc
from    ta_11_adeudo_local a,ta_11_fecha_desc b where a.id_local=parid
and ((a.axo=paraxohasta and a.periodo<=parmeshasta) or (a.axo<paraxohasta))
and b.mes=month(today) 
order by axo,periodo

-- calcula los descuentos de tianguis y pronto pago de locales
if v_merc=214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
else
   if v_aaxo=year(today) and v_aperiodo=month(today) then
      if today<=v_fecha_desc then
         let v_aimporte=v_aimporte-(v_aimporte*.10); 
      end if;
   end if;
end if;

-- inserta el pago a mercados
insert into ta_11_pagos_local values(0,parid,v_aaxo,v_aperiodo,today,varrec,varcaja,varoperacion,
v_aimporte,'PAGO EN KIOSCO',current,pkiosco);

-- quitar los adeudos
delete from ta_11_adeudo_local where id_local=parid and axo=v_aaxo and periodo=v_aperiodo;
end foreach;

foreach
-- seleccionar los folios vigentes y practicados
select nvl(id_control,0),nvl(folio,0),importe_gastos 
into v_idcontrol,v_folio,v_gastos
from    ta_15_apremios a  
where modulo=11
and control_otr=parid
and vigencia='1'
and clave_practicado='P'

-- poner como pagados los folios vigentes y practicados
update ta_15_apremios set fecha_pago=today,recaudadora=varrec,caja=varcaja,
operacion=varoperacion,vigencia='2',clave_mov='P',importe_pago=v_gastos
where modulo=11 and Id_control=v_idcontrol;
end foreach;

-- correr procedimiento de pago de linea de captura para bancos
execute  PROCEDURE linea_pagok(v_linea, pKiosco, pCertificado, 'K',varcvepago,
    today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje;

return varrec, varcaja, spoperacion , v_linea;
end if;
end if;
end procedure;

CREATE PROCEDURE "gmoreno".con16_f10detade ( p_Ctrol_Aseo Integer)
    RETURNING CHAR(2),      -- RECAUDADORA
              VARCHAR(20),  -- TIPO DE ASEO
              INTEGER,      -- NUMERO DE CONTRATO
              VARCHAR(200), -- A NOMBRE DE QUIEN ESTA EL CONTRATO
              VARCHAR(200), -- DOMICILIO
              CHAR(2),      -- VIGENCIA   HASTA AQUI DATOS DEL CONTRATO

              Money(12,2),    -- ADEUDOS 2005 Y ANTERIORES
              Money(12,2),    -- RECARGOS
              Money(12,2),    -- ADEUDOS 2006 Y POSTERIORES
              Money(12,2),    -- RECARGOS  HASTA AQUI DATOS DE ADEUDOS
              Money(12,2),    -- TOTAL DE GASTOS
              Money(12,2),    -- TOTAL DE MULTAS

              varchar(255);    -- DATOS DE REQUERIMIENTOS
{
#  Procedimiento: con16_f10detade
#  Descripcion:  Genera una consulta del detalle de Contratos/requerimiento/Adeudos con un formato definido
#  Parametros de entrada: p_Mod : Caracteres de identIFicacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#  		         Importe : El importe de los Adeudos/Multa
#  		         Importe : El importe de los Recargos/Gastos
#  Elaboro:    c. Gilberto Moreno
#  ModIFico: 
#  Fecha ModIFicaci�n : 
}

 
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato, v_Ofna		Integer;          --  DATOS DEL CONTRATO
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_status_vigencia, v_vigencia          Char(1);

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago, v_fecha_practicado                             Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_totAdeudos2005, v_totAdeudos2006, v_TotRecargos2005, v_TotRecargos2006 Money(12,2);
  define v_Mes								varchar(2);

  define v_axo_emi, v_ayo_per, v_periodo_per, v_Lineas_Per						Smallint;        ------ CAMPOS DE PERIODOS QUE CUBRE EL FOLIO DEL REQ.

  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO			varchar(120);
  define v_DetFolReq							varchar(255);

  define aso_proceso, aso_actual, v_FolReq						Integer;
  DEFINE v_ult_pago                                             DATE;
   LET v_Detalle_T = ' ';
   LET v_importe = 0;
   LET v_Importe_recargo = 0;
   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;


       SELECT Mes, Dia
           INTO Mes_v, Dia_v
       FROM ta_16_Dia_Limite 
               WHERE Mes = MONTH(Current);

      LET Aso_Hoy = YEAR(Current);
      LET Mes_Hoy = MONTH(Current);
      IF Day(Current) > Dia_v then          --  CUOTA NORMAL
         LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current);
      ELSE
          IF MONTH(Current) = 1 then
             LET v_Periodo_CN = YEAR(Current) - 1||'-12';
          ELSE
             LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current) - 1;
          END IF;
      END IF;

      IF Day(Current) > Dia_v then          --  EXEDENCIAS
          IF Mes_Hoy > 2 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 2;
          ELSE
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
          END IF;
      ELSE
          IF Mes_Hoy > 3 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 3;
          ELSE
                IF Mes_Hoy = 3 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-10';
                END IF;
          END IF;
      END IF;

FOREACH
SELECT a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, id_rec, status_vigencia
   INTO  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_Ofna, v_status_vigencia  
FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
WHERE A.CTROL_ASEO = p_Ctrol_Aseo
  AND b.ctrol_aseo = a.ctrol_aseo
  AND c.num_empresa = a.num_empresa AND c.ctrol_emp = a.ctrol_emp
  ORDER BY a.ctrol_aseo, a.num_contrato

  	LET v_totAdeudos2005 = 0;
	LET v_totAdeudos2006 = 0;
	LET v_TotRecargos2005 = 0;
	LET v_TotRecargos2006 = 0;

                Let v_tot_gastos = 0;
	LET v_importe_multa = 0;
	LET v_importe_gastos = 0;
    	LET v_axo_emi = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = ' ';
                FOREACH
                     SELECT id_control, folio, importe_multa, importe_gastos, fecha_practicado, Year(fecha_emision), vigencia 
                       INTO v_id_control, v_folio_req, v_importe_multa, v_importe_gastos, v_fecha_practicado, v_axo_emi, v_vigencia 
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_Control
                       AND clave_practicado = "P" AND vigencia = "1" 
                      ORDER BY id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || '|' || v_folio_req || ' ' || v_axo_emi || ' ' || v_fecha_practicado || ' ' || v_vigencia ;
		else
		   Let v_DetFolReq = v_DetFolReq || v_folio_req || ' ' || v_axo_emi || ' ' || v_fecha_practicado || ' ' || v_vigencia;
		Let v_FolReq = v_FolReq + 1;
		end if;
                END FOREACH;

  LET aso_proceso = 0;
  LET aso_actual = YEAR(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL

                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion = 6 
          		     AND H.aso_mes_pago <= (v_Periodo_CN)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

  		IF v_importe > 0 then
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;
	-------------------------------------CONSULTA DE EXEDENCIAS
                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion <> 6 
          		     AND H.aso_mes_pago <= (v_Periodo_EXE)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);

  		IF v_importe > 0 then
  		    LET v_totAdeudos = v_totAdeudos + v_importe;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;

--     GrabANDo registro

   IF aso_proceso <= 2005 THEN
       LET v_totAdeudos2005 = v_totAdeudos2005 + v_totAdeudos;
       LET v_TotRecargos2005 = v_TotRecargos2005 + v_TotRecargos;
   ELSE
       LET v_totAdeudos2006 = v_totAdeudos2006 + v_totAdeudos;
       LET v_TotRecargos2006 = v_TotRecargos2006 + v_TotRecargos;
   END IF;

   LET v_totAdeudos = 0;
   LET v_TotRecargos = 0;

  END FOR;

       IF (v_totAdeudos2005 <> 0)  OR  (v_TotRecargos2005 <> 0)  OR  (v_totAdeudos2006 <> 0)  OR  (v_TotRecargos2006 <> 0)  OR  (v_tot_gastos <> 0)  OR  (v_importe_multa <> 0) THEN
           RETURN v_Ofna,v_tipo_aseo,v_Num_Contrato,v_nombre,v_domicilio,v_status_vigencia, 
                           v_totAdeudos2005, v_TotRecargos2005, v_totAdeudos2006, v_TotRecargos2006, v_tot_gastos, v_importe_multa, v_DetFolReq  with resume;
       END IF;

END FOREACH;

END procedure;

CREATE PROCEDURE "gmoreno".con16_f11detade ( p_Ctrol_Aseo Integer)
    RETURNING 	VARCHAR(20),  	-- TIPO DE ASEO
              		INTEGER,      	-- NUMERO DE CONTRATO
              		VARCHAR(200), 	-- A NOMBRE DE QUIEN ESTA EL CONTRATO
              		VARCHAR(200), 	-- DOMICILIO

              		Money(12,2),    -- ADEUDOS 
              		Money(12,2),    -- RECARGOS
              		Money(12,2),    -- TOTAL DE GASTOS
              		Money(12,2),    -- TOTAL DE MULTAS

              		varchar(255),    -- DATOS DE REQUERIMIENTOS PRACTICADOS

		Date, 		-- FECHA DEL ULTIMO PAGO REALIZADO
		Date, 		-- FECHA DE LA ULTIMA MODIFICACION AL CONTRATO
              		varchar(255);    	-- DATOS DE LA ULTIMA MODIFICACION

 
  define v_Control, v_Ctrol_Aseo, v_Num_Contrato, v_Ofna, v_cuento	Integer;          --  DATOS DEL CONTRATO
  define v_tipo_aseo					varchar(15);
  define v_nombre, v_domicilio					varchar(80);
  define v_status_vigencia, v_vigencia          			Char(1);

  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_aso_mes_pago, v_fecha_practicado                             			Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_Importe, v_TotAdeudos, v_Importe_Recargo, v_TotRecargos		Money(12,2);
  define v_Mes								varchar(2);

  define v_axo_emi, v_ayo_per, v_periodo_per, v_Lineas_Per			Smallint;        ------ CAMPOS DE PERIODOS QUE CUBRE EL FOLIO DEL REQ.

  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO			varchar(120);
  define v_DetFolReq, v_DetUltMod, v_DetUltMod_F				varchar(255);

  define aso_proceso, aso_actual, v_FolReq					Integer;
  DEFINE v_ult_pago, v_ult_mod, v_ult_mod_F					DATE;

   LET v_Detalle_T = ' ';
   LET v_Importe = 0;
   LET v_Importe_Recargo = 0;
   LET v_TotAdeudos = 0;
   LET v_TotRecargos = 0;


       SELECT Mes, Dia
           INTO Mes_v, Dia_v
       FROM ta_16_Dia_Limite 
               WHERE Mes = MONTH(Current);

      LET Aso_Hoy = YEAR(Current);
      LET Mes_Hoy = MONTH(Current);
      IF Day(Current) > Dia_v then          --  CUOTA NORMAL
         LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current);
      ELSE
          IF MONTH(Current) = 1 then
             LET v_Periodo_CN = YEAR(Current) - 1||'-12';
          ELSE
             LET v_Periodo_CN = YEAR(Current) || '-' || MONTH(Current) - 1;
          END IF;
      END IF;

      IF Day(Current) > Dia_v then          --  EXEDENCIAS
          IF Mes_Hoy > 2 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 2;
          ELSE
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
          END IF;
      ELSE
          IF Mes_Hoy > 3 then
             LET v_Periodo_EXE = YEAR(Current) || '-' || MONTH(Current) - 3;
          ELSE
                IF Mes_Hoy = 3 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-12';
                END IF;
                IF Mes_Hoy = 2 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-11';
                END IF;
                IF Mes_Hoy = 1 then
                   LET v_Periodo_EXE = YEAR(Current) - 1||'-10';
                END IF;
          END IF;
      END IF;

FOREACH
SELECT a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, id_rec, status_vigencia
   INTO  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_Ofna, v_status_vigencia  
FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
WHERE A.CTROL_ASEO = p_Ctrol_Aseo
  AND b.ctrol_aseo = a.ctrol_aseo
  AND c.num_empresa = a.num_empresa AND c.ctrol_emp = a.ctrol_emp
  ORDER BY a.ctrol_aseo, a.num_contrato

       LET v_cuento = 0;
       LET v_ult_mod_F = TODAY;
       LET v_DetUltMod = ' ';
       LET v_DetUltMod_F = ' ';

   	LET v_TotAdeudos = 0;
   	LET v_TotRecargos = 0;

                LET v_Tot_gastos = 0;
	LET v_importe_multa = 0;
	LET v_importe_gastos = 0;
    	LET v_axo_emi = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = ' ';
                FOREACH
                     SELECT id_control, folio, importe_multa, importe_gastos, fecha_practicado, Year(fecha_emision), vigencia 
                       INTO v_id_control, v_folio_req, v_importe_multa, v_importe_gastos, v_fecha_practicado, v_axo_emi, v_vigencia 
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_Control
                       AND clave_practicado = "P" AND vigencia = "1" 
                      ORDER BY id_control
		Let v_Tot_gastos = v_Tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || '|' || v_folio_req || ' ' || v_axo_emi || ' ' || v_fecha_practicado || ' ' || v_vigencia ;
		else
		   Let v_DetFolReq = v_DetFolReq || v_folio_req || ' ' || v_axo_emi || ' ' || v_fecha_practicado || ' ' || v_vigencia;
		Let v_FolReq = v_FolReq + 1;
		end if;
                END FOREACH;

  LET aso_proceso = 0;
  LET aso_actual = YEAR(Current);

  FOR aso_proceso = 1989 to aso_actual 
	-------------------------------------CONSULTA DE CUOTA NORMAL

                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion = 6 
          		     AND H.aso_mes_pago <= (v_Periodo_CN)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

  		IF v_importe > 0 then
  		    LET v_TotAdeudos = v_TotAdeudos + v_importe;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;
	-------------------------------------CONSULTA DE EXEDENCIAS
                	FOREACH
    		SELECT h.aso_mes_pago,  Ctrol_Operacion,     h.importe, MONTH(h.aso_mes_pago)
        		    INTO v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		FROM ta_16_pagos H
     		WHERE H.Control_Contrato = v_Control AND H.Ctrol_Operacion <> 6 
          		     AND H.aso_mes_pago <= (v_Periodo_EXE)
          		     AND H.Status_Vigencia = 'V' AND YEAR(h.aso_mes_pago) = aso_proceso
		ORDER BY h.aso_mes_pago

                                                    SELECT sum(porc_recargo) 
   			    INTO v_Importe_recargo
                                                    FROM ta_16_recargos 
                                                           WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);

  		IF v_importe > 0 then
  		    LET v_TotAdeudos = v_TotAdeudos + v_importe;
  		    IF v_Importe_recargo <> 0 then
     		           LET v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    END IF;
  		END IF;

   		LET v_importe = 0;
   		LET v_Importe_recargo = 0;
                	END FOREACH;

  END FOR;
-------------------------------------------------------------------------------------------------------------------
       Select Max(fecha_hora_pago) Into v_ult_pago From ta_16_pagos 
               Where control_contrato = v_Control and status_vigencia = 'P';
-------------------------------------------------------------------------------------------------------------------
       FOREACH
       Select fecha_movto, descripcion Into v_ult_mod, v_DetUltMod From ta_16_contratos_h Where control_contrato = v_Control order by fecha_movto desc
           IF v_cuento = 0 THEN
              LET v_cuento = 1;
              LET v_ult_mod_F = v_ult_mod;
              LET v_DetUltMod_F = v_DetUltMod;
           END IF;
       END FOREACH;
-------------------------------------------------------------------------------------------------------------------
       IF (v_TotAdeudos <> 0)  OR  (v_TotRecargos <> 0)  OR  (v_tot_gastos <> 0)  OR  (v_importe_multa <> 0) THEN
          IF v_cuento > 0 THEN
                RETURN v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, 
                       v_TotAdeudos, v_TotRecargos, v_tot_gastos, v_importe_multa, 
                       v_DetFolReq, v_ult_pago, v_ult_mod_F, v_DetUltMod_F  with resume;
          ELSE
                RETURN v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, 
                       v_TotAdeudos, v_TotRecargos, v_tot_gastos, v_importe_multa, 
                       v_DetFolReq, v_ult_pago, NULL, NULL  with resume;
          END IF;
       END IF;

END FOREACH;

END procedure;

CREATE PROCEDURE "bcabrera".spd_11_consmercado(
parm_apl char(2),
parm_id integer)
--parm_meses smallint)	-- 0 todo el adeudo, 1..999 solo meses a pagar

returning  	integer as estatus,	-- estatus
	varchar(60) as mensaje,		-- mensaje
	varchar(255) as nombre,		-- nombre
	varchar(255) as mercado,		-- domicilio
	varchar(255) as observaciones;		-- observaciones

define v_estatus smallint;
define v_id_local integer;
define v_loc integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra char(1); 
define v_bloque char(1);
define v_nombre varchar(30);
define v_domicilio varchar(250);
define v_adicional varchar(20);
define v_superficie decimal(10,2);
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_vigencia char(1);
define v_bloqueo smallint;
define v_axomin,v_axocalc,v_axomax smallint;
define v_mesmin,v_mescalc,v_mesmax,v_primermes smallint;
define v_desc integer;
define v_ofn smallint;
define v_mer smallint;
define v_cat smallint;
define v_sec char(2);
define v_per varchar(20);
define v_observ varchar(250);
 
let v_id_local=0;
let v_loc=0;
let v_observ='';
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_nom_mercado='';
let v_descripcion='';
let v_estatus=0;
let v_ofn=0;
let v_mer=0;
let v_cat=0;
let v_sec='';
let v_per='';


if not exists(select * from ta_11_locales where id_local=parm_id) then
   let v_estatus=2;
   let v_descripcion='NO EXISTE LOCAL';
else
     -- obtiene los datos generales
         select c.id_local,c.oficina,c.num_mercado,c.categoria,c.seccion,c.local,c.letra_local,c.bloque,
                c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion 
         into   v_id_local,v_ofn,v_mer,v_cat,v_sec,v_loc,v_letra,v_bloque,
                v_desc,v_nombre,v_domicilio,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado
         from   ta_11_locales c,ta_11_mercados e
         where c.id_local=parm_id and e.num_mercado_nvo=c.num_mercado and e.oficina=c.oficina;

         
         if v_domicilio is null then
            let v_domicilio='';
         end if;

         if v_nom_mercado is null then
            let v_nom_mercado='';
         end if;

         if v_adicional is null then
            let v_adicional='';
         end if;

         if v_letra is null then
            let v_letra='';
         end if;

         if v_bloque is null then
            let v_bloque='';
         end if;

         if  v_bloqueo=1 then
             let v_estatus=3;
             let v_descripcion='LOCAL CONVENIADO'; 
         else                   
         if  v_vigencia<>'A' then
             let v_estatus=4;
             let v_descripcion='LOCAL DADO DE BAJA';
         else
         if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and ((axo=year(today) and periodo<=month(today)) or (axo<year(today)))) then 	
            let v_estatus=5;
            let v_descripcion=' LOCAL AL CORRIENTE DE PAGOS';
         else
--         let v_domicilio=trim(v_domicilio)||' MERCADO:'||trim(v_nom_mercado);
         let v_domicilio=' MERCADO:'||trim(v_nom_mercado);
         -- para sacar el a�o minimo
         select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;
         -- para sacar el mes minimo       
         select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;
         -- para sacar el a�o maximo
         select  max(axo) into v_axomax from ta_11_adeudo_local where id_local=v_id_local;
         -- para sacar el mes minimo       
         select max(periodo) into v_mesmax  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomax;

         let v_per=v_mesmin||'/'||v_axomin||' al '||v_mesmax||'/'||v_axomax;
         let v_observ='LOCAL:'||v_ofn||'-'||v_mer||'-'||v_cat||'-'||v_sec||'-'||v_loc||'-'||v_letra||'-'||v_bloque||
             ' ADICIONAL(ES):'||trim(v_adicional)||' SUPERFICIE:'||v_superficie||' PERIODOS: '||v_per;
         let v_estatus=0;
         let v_descripcion='SE PUEDE COBRAR';
         end if;
         end if;
         end if;
end if;
return v_estatus,v_descripcion,v_nombre,v_domicilio,v_observ;
end procedure;

CREATE PROCEDURE "bcabrera".spd_11_consadeudo(
parm_ofn smallint,
parm_mer smallint,
parm_cat smallint,
parm_sec char(2),
parm_loc integer,
parm_let char(1),
parm_blq char(1),
parm_meses smallint)	-- 0 todo el adeudo, 1..999 solo meses a pagar

returning  	integer as id_local,		-- id_local
	smallint as mesdesde,		-- mes desde
	smallint as axodesde,		-- a�o desde
	smallint as meshasta,		-- mes hasta
	smallint as axohasta,		-- a�o hasta
	char(30) as nombre,		-- nombre
	char(40) as domicilio,		-- domicilio
	char(20) as adicional,  	-- adicional
	decimal(10,2) as superficie,	-- superficie
	money(15,2) as adeudo,	-- adeudo
	money(15,2) as recargos,	-- recargos
	money(15,2) as multa,	-- multa
	money(15,2) as gastos,	-- gastos
	money(15,2) as total,	-- total
	money(15,2) as descuiento,	-- descuento
	char(30) as mercado,		-- nombre mercado
	smallint as estatus,		-- estatus	
	char(60) as mensaje;		-- mensaje

define v_estatus smallint;
define v_id_local,v_id,vid integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra1,v_let char(1); 
define v_bloque1,v_blq char(1);
define v_nombre char(30);
define v_domicilio char(40);
define v_adicional char(20);
define v_superficie decimal(10,2);
define v_adeudo money(15,2);
define v_recargos money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_descuento money(15,2);
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_folio integer;
define v_per smallint;
define v_aid_local integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc integer;
define v_total money(15,2);
 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_nom_mercado='';
let v_descripcion='';
let v_estatus=0;
let v_recargos=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;

if not exists(select * from ta_11_locales where oficina=parm_ofn and num_mercado=parm_mer and categoria=parm_cat
            and seccion=parm_sec and local=parm_loc) then
   let v_estatus=2;
   let v_descripcion='NO EXISTE LOCAL';
else
     -- obtiene los datos generales
     foreach
     select id_local,letra_local,bloque into vid,v_let,v_blq 
                from ta_11_locales where oficina=parm_ofn
	and num_mercado=parm_mer and categoria=parm_cat
	and seccion=parm_sec and local=parm_loc
     if v_let is null then
        let v_letra1='';
     else
        let v_letra1=v_let;
     end if;
     if v_blq is null then
        let v_bloque1='';
     else
        let v_bloque1=v_blq;
     end if;
     if  (v_letra1=trim(parm_let) and v_bloque1=trim(parm_blq)) then
         let v_locales=v_locales+1;
         select c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion 
         into     v_id_local,v_desc,v_nombre,v_domicilio,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado
         from    ta_11_locales c,ta_11_mercados e
         where c.id_local=vid
	    and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado
	    group by c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion;

         let v_per=0;
         let v_porc=0;

         if v_desc is null then
            let v_desc=0;
         end if;

         if  v_bloqueo=1 then
             let v_estatus=3;
             let v_descripcion='LOCAL CONVENIADO'; 
         else                   
         if  v_vigencia<>'A' then
             let v_estatus=4;
             let v_descripcion='LOCAL DADO DE BAJA';
         else
         if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and ((axo=year(today) and periodo<=month(today)) or (axo<year(today)))) then 	
            let v_estatus=5;
            let v_descripcion=' LOCAL AL CORRIENTE DE PAGOS';
         else 
         let v_recacum=0; 

         -- para sacar el a�o minimo
         select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

         -- para sacar el mes minimo       
         select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

         -- calcula los meses a pagar en base al parametro de entrada
         if parm_meses=0 then
            let v_axocalc=year(today);
            let v_mescalc=month(today);
         else
         if parm_meses=1 then
            let v_axocalc=v_axomin;
            let v_mescalc=v_mesmin;
         else 
            for v_contador= 1 to parm_meses-1
                 if  ((v_mesmin=12) and (parm_mer <>214)) or ((v_mesmin=4) and (parm_mer =214)) then 
                     let v_mesmin=1;
                     let v_axomin=v_axomin + 1;
                 else
                     let v_mesmin=v_mesmin + 1;
                 end if;
            end for;
            let v_axocalc=v_axomin;
            let v_mescalc=v_mesmin;
         end if;
         end if;
         
         -- para obtener los datos de multa y gastos
         select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
         into     v_multa,v_folio,v_gastos
         from    ta_15_apremios a  
         where modulo=11
                    and control_otr=v_id_local
                    and vigencia='1'
                    and clave_practicado='P';

         -- todos los adeudos pendientes hasta mes actual
         foreach
         select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
         into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
         from    ta_11_adeudo_local a,ta_11_fecha_desc b 
         where id_local=v_id_local
                   and ((a.axo=v_axocalc and a.periodo<=v_mescalc) or (a.axo<v_axocalc)) 
--                   and ((a.axo=year(today) and a.periodo<=month(today)) or (a.axo<year(today))) 
                   and b.mes=month(today)
                   order by axo,periodo

         if parm_mer=214 then
            let v_impcalc=(v_aimporte*(100-v_desc))/100;
         else
            let v_impcalc=v_aimporte;
         end if;
  
         if v_mesdsd=0 then
            let v_mesdsd=v_aperiodo;
         end if;
  
         if v_axodsd=0 then
            let v_axodsd=v_aaxo;
         end if; 

         let v_meshst=v_aperiodo;
         let v_axohst=v_aaxo;  

         -- obtiene el porcentaje de recargos
         if parm_mer <>214 then 	
            if today>=v_fecha_rec then
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
            else
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
            end if;
         else 
            if v_aperiodo=1 then let v_primermes=1;
            else if v_aperiodo=2 then let v_primermes=4;
            else if v_aperiodo=3 then let v_primermes=7;
            else if v_aperiodo=4 then let v_primermes=10;
            else let v_primermes=0;
            end if;
            end if;
            end if;
            end if;

            if v_primermes=month(today) then
               if today>=v_fecha_rec then
                  select sum(porcentaje_mes) into v_porc from ta_12_recargos
                  where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                               (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
               else
                  select sum(porcentaje_mes) into v_porc from ta_12_recargos
                  where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                               (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
               end if;
            else
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
            end if;
         end if;

         if  v_porc is null then
             let v_porc=0;
         end if;

         if  v_folio = 0 then
             if v_porc > 100 then
                let v_recacum=trunc(v_impcalc*100)/100;
             else
                let v_recacum=trunc(v_impcalc*v_porc)/100;
             end if;
         else
             if v_porc > 250 then
                let v_recacum=trunc(v_impcalc*250)/100;
             else
                let v_recacum=trunc(v_impcalc*v_porc)/100;
             end if;
         end if;

         let v_recargos=v_recargos+v_recacum;
	
         if parm_mer<>214 then
            if v_aaxo=year(today) and v_aperiodo=month(today) then
               if today>v_fecha_desc then
                  let v_adeacum=v_aimporte;
               else
                  let v_adeacum=v_aimporte-(v_aimporte*.10);
                  let v_descuento=v_aimporte*.10;
               end if;
            else
               let v_adeacum=v_aimporte;
            end if;
         else
            let v_adeacum=v_impcalc;
            let v_descuento=v_descuento+(v_aimporte-v_impcalc);
         end if;

         let v_adeudo=v_adeudo+v_adeacum;

         let v_estatus=0;
         let v_descripcion='SE PUEDE COBRAR';
         end foreach;
         end if;
         end if;
         end if;
     else
         if  v_locales=0 then
             let v_estatus=2;
             let v_descripcion='NO EXISTE LOCAL';
         end if; 
     end if;
     end foreach;
     let v_total=v_adeudo+v_recargos+v_multa+v_gastos;
end if;
return v_id_local,v_mesdsd,v_axodsd,v_meshst,v_axohst,v_nombre,v_domicilio,v_adicional,v_superficie,v_adeudo,v_recargos,v_multa,v_gastos,v_total,v_descuento,v_nom_mercado,v_estatus,v_descripcion;
end procedure;

CREATE PROCEDURE "bcabrera".spd_11_consdetalle(
parm_apl char(2),
parm_id integer)
--parm_meses smallint)	-- 0 todo el adeudo, 1..999 solo meses a pagar

returning  	varchar(100) as concepto, money(15,2) as importe; --concepto e importe

define parm_meses smallint;
define v_id_local,v_id,vid integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_adeudo money(15,2);
define v_recargos money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_descuento money(15,2);
define v_folio integer;
define v_per smallint;
define v_aid_local integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc integer;
define v_total money(15,2);
define parm_mer smallint;
define v_concepto varchar(100);
define v_axoc smallint;
define v_importec money(15,2);
define v_ident char(2);

let v_ident='';
let v_concepto='ADEUDO ARRENDAMIENTO ';
let v_axoc=0;
let parm_meses=0; 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_recargos=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;

begin
    on exception in (-958)
       delete from tmp_edocuenta;
    end exception;
create temp table tmp_edocuenta(
  id_local integer,
  identificador char(2),
  axo smallint,
  concepto varchar(100),
  importe money(15,2));
end;

-- obtiene los datos generales
select id_local,num_mercado into v_id_local,parm_mer
from   ta_11_locales 
where  id_local=parm_id;


let v_per=0;
let v_porc=0;
let v_recacum=0; 
let v_axocalc=0;
let v_mescalc=0;
let v_axomin=0;
let v_mesmin=0;
let v_contador=0;
-- para sacar el a�o minimo
select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

-- para sacar el mes minimo       
select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

-- calcula los meses a pagar en base al parametro de entrada
if parm_meses=0 then
   let v_axocalc=year(today);
   let v_mescalc=month(today);
else
   if parm_meses=1 then
      let v_axocalc=v_axomin;
      let v_mescalc=v_mesmin;
   else 
      for v_contador= 1 to parm_meses-1
          if  ((v_mesmin=12) and (parm_mer <>214)) or ((v_mesmin=4) and (parm_mer =214)) then 
              let v_mesmin=1;
              let v_axomin=v_axomin + 1;
          else
              let v_mesmin=v_mesmin + 1;
          end if;
      end for;
      let v_axocalc=v_axomin;
      let v_mescalc=v_mesmin;
   end if;
 end if;
         
-- todos los adeudos pendientes hasta mes actual
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where a.id_local=v_id_local
and ((a.axo=v_axocalc and a.periodo<=v_mescalc) or (a.axo<v_axocalc)) 
--      and ((a.axo=year(today) and a.periodo<=month(today)) or (a.axo<year(today))) 
and b.mes=month(today)
order by a.axo,a.periodo

if parm_mer=214 then
   let v_impcalc=(v_aimporte*(100-v_desc))/100;
else
   let v_impcalc=v_aimporte;
end if;
  
if v_mesdsd=0 then
   let v_mesdsd=v_aperiodo;
end if;
  
if v_axodsd=0 then
   let v_axodsd=v_aaxo;
end if; 

let v_meshst=v_aperiodo;
let v_axohst=v_aaxo;
-- obtiene el porcentaje de recargos
if parm_mer <>214 then 	
   if today>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   end if;
else 
   if v_aperiodo=1 then let v_primermes=1;
   else if v_aperiodo=2 then let v_primermes=4;
   else if v_aperiodo=3 then let v_primermes=7;
   else if v_aperiodo=4 then let v_primermes=10;
   else let v_primermes=0;
   end if;
   end if;
   end if;
   end if;

if v_primermes=month(today) then
   if today>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   end if;
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
           (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
end if;
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recacum=trunc(v_impcalc*100)/100;
    else
       let v_recacum=trunc(v_impcalc*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recacum=trunc(v_impcalc*250)/100;
    else
       let v_recacum=trunc(v_impcalc*v_porc)/100;
    end if;
end if;

--let v_recargos=v_recargos+v_recacum;
	
if parm_mer<>214 then
   if v_aaxo=year(today) and v_aperiodo=month(today) then
      if today>v_fecha_desc then
         let v_adeacum=v_aimporte;
      else
         let v_adeacum=v_aimporte-(v_aimporte*.10);
         let v_descuento=v_aimporte*.10;
      end if;
   else
      let v_adeacum=v_aimporte;
   end if;
else
   let v_adeacum=v_impcalc;
   let v_descuento=v_descuento+(v_aimporte-v_impcalc);
end if;

if ((v_axoc=0) or (v_axoc=v_aaxo)) then
   let v_concepto=v_concepto||v_aperiodo||' ';
   let v_axoc=v_aaxo;
   let v_adeudo=v_adeudo+v_adeacum;
   let v_recargos=v_recargos+v_recacum;
else
   insert into tmp_edocuenta values(v_id_local,'R',v_axoc,v_concepto,v_adeudo);
   insert into tmp_edocuenta values(v_id_local,'',v_axoc,'RECARGOS ARRENDAMIENTO',v_recargos);
   let v_concepto='ADEUDO ARRENDAMIENTO '||v_aperiodo||' ';
   let v_axoc=v_aaxo;
   let v_adeudo=v_adeacum;
   let v_recargos=v_recacum;
end if;
end foreach;

if v_adeudo>0 then
   insert into tmp_edocuenta values(v_id_local,'R',v_axoc,v_concepto,v_adeudo);
end if;
if v_recargos>0 then
   insert into tmp_edocuenta values(v_id_local,'',v_axoc,'RECARGOS ARRENDAMIENTO',v_recargos);
end if;
-- para obtener los datos de multa y gastos
select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
into   v_multa,v_folio,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_id_local and vigencia='1' and clave_practicado='P';
-- gastos
if v_gastos>0 then
   insert into tmp_edocuenta values(v_id_local,'',9999,'GASTOS',v_gastos);
end if;
-- multa
if v_multa>0 then
   insert into tmp_edocuenta values(v_id_local,'',9999,'MULTA',v_multa);
end if;

--execute procedure spd_11_enerdetalle(v_id_local,parm_mer);

foreach
select identificador,axo,concepto,importe into v_ident,v_axoc,v_concepto,v_importec
from tmp_edocuenta 
order by axo asc,identificador desc

if v_axoc=9999 then
   let v_concepto='     '||v_concepto;
else
   let v_concepto=v_axoc||' '||v_concepto;
end if;
return v_concepto,v_importec
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "gmoreno".con16_f12detade ( p_Mod Char(2), p_Ctrol_Aseo Integer)
	returning varchar(100),    -- Tipo de Aseo
		varchar(255),    -- Concepto
                               Money(12,2),    -- Importe Adeudos
                               Money(12,2),    -- Importe Recargos
                               Money(12,2),    -- Importe Multa
                               Money(12,2);    -- Importe Gastos
	               

{
#  Procedimiento: Con16_F3DetAde
#  Descripcion:  Genera una consulta del detalle de Adeudos de un contrato
#  Parametros de entrada:p_Mod : Caracteres de identificacion del Modulo
#                                       p_TipoAseo : Tipo de Aseo
#  Parametros de salida:   Concepto : Tipo de Aseo
#  		         Concepto : Concepto de cobro
#		         Importe : El importe de los Adeudos
#  		         Importe : El importe de los Recargos
#  		         Importe : El importe de la Multa
#  		         Importe : El importe de los Gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTRATO
   define  v_Control, v_Num_Contrato, v_Ctrol_Aseo				Integer;
   define  v_tipo_aseo, v_nombre, v_domicilio					varchar(80);
--****************************************************************************************************************************** REQUERIMIENTOS
  define v_importe_multa, v_importe_gastos, v_TP_Gastos, v_TN_Gastos, v_TP_Multa, v_TN_Multa   Money(12,2);
  define v_aso_mes_pago, v_FEmision, v_FPracticado				Date;
  define v_id_control, v_modulo, v_control_otr, v_folio, v_Ctrol_Operacion, v_folio_req  	Integer;
  define v_importe, v_totAdeudos						Money(12,2);
  define v_Importe_recargo, v_TotRecargos					Money(12,2);
  define v_Mes								varchar(2);
  define v_practicado, v_diligencia, v_vigencia					Char(1);
--******************************************************************************************************************************************
  define Mes_v, Dia_v, Mes_Hoy						varchar(4);
  define Aso_Hoy								varchar(4);
  define v_Periodo_CN, v_Periodo_EXE						varchar(7);
  define v_Periodo								varchar(9);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 				Smallint;
  define v_Detalle_T, v_Detalle_CN, v_Detalle_EX, v_Detalle_CO, v_DetFolReqP, v_DetFolReqN varchar(120);
--******************************************************************************************************************************************
  define v_DetFolReq, v_DetUltMod, v_DetUltMod_F				varchar(255);
  define v_ult_pago, v_ult_mod, v_ult_mod_F					DATE;
  define aso_proceso, aso_actual, v_FolReqP, v_FolReqN, v_cuento			Integer;
   Let v_practicado = ' ';
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;

--********************************************************************************* PERIODICIDAD
       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;
--***********************************************************************************************************************************************
FOREACH
SELECT a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio
   INTO  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio
FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
WHERE A.CTROL_ASEO = p_Ctrol_Aseo
  AND b.ctrol_aseo = a.ctrol_aseo
  AND c.num_empresa = a.num_empresa AND c.ctrol_emp = a.ctrol_emp
  ORDER BY a.ctrol_aseo, a.num_contrato

       --RETURN 'TIPO DE ASEO:'  ||  Trim(v_tipo_aseo), '  CONTRATO:'  ||  v_Num_Contrato || '  NOMBRE:' || Trim(v_nombre) || '  DOMICILIO:' || Trim(v_domicilio), Null, Null, Null, Null  with resume;
       RETURN 'CONTRATO:'  ||  v_Num_Contrato, 'TIPO DE ASEO:'  ||  Trim(v_tipo_aseo)  || '  NOMBRE:' || Trim(v_nombre) || '  DOMICILIO:' || Trim(v_domicilio), Null, Null, Null, Null  with resume;

       LET v_cuento = 0;
       LET v_ult_mod_F = mdy(01,01,1900);
       LET v_DetUltMod = ' ';
       LET v_DetUltMod_F = ' ';

                Let v_TP_Gastos = 0;
                Let v_TN_Gastos = 0;
                Let v_TP_Multa = 0;
                Let v_TN_Multa = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReqP = 0;
	Let v_FolReqN = 0;
	Let v_DetFolReqP = 'Docto(s) Practicado(s) : ';
	Let v_DetFolReqN = 'Docto(s) No Diligenciado(s) : ';
                foreach
                     Select id_control,   folio,            diligencia,     clave_practicado, fecha_emision, fecha_practicado, importe_multa,     importe_gastos,      vigencia
                       Into v_id_control, v_folio_req, v_diligencia, v_practicado,        v_FEmision,     v_FPracticado,      v_importe_multa, v_importe_gastos , v_vigencia
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = v_Control
                       And diligencia in ("R","N") and clave_practicado in ("P","N")
                      Order By id_control

		if v_practicado = "P" then
			if v_FolReqP > 0 then
		   		Let v_DetFolReqP = v_DetFolReqP || '|' || v_diligencia || v_folio_req || ' ' || v_FEmision || ' ' || v_FPracticado || ' ' || v_vigencia ;
			else
		   		Let v_DetFolReqP = v_DetFolReqP || v_diligencia || v_folio_req || ' ' || v_FEmision || ' ' || v_FPracticado || ' ' || v_vigencia ;
			Let v_FolReqP = v_FolReqP + 1;
			Let v_TP_Gastos = v_TP_Gastos + v_importe_gastos;
			Let v_TP_Multa = v_importe_multa;
			end if;
		else
			if v_FolReqN > 0 then
		   		Let v_DetFolReqN = v_DetFolReqN || '|' || v_diligencia || v_folio_req || ' ' || v_FEmision || ' ' || v_FPracticado || ' ' || v_vigencia ;
			else
		   		Let v_DetFolReqN = v_DetFolReqN || v_diligencia || v_folio_req || ' ' || v_FEmision || ' ' || v_FPracticado || ' ' || v_vigencia ;
			Let v_FolReqN = v_FolReqN + 1;
			Let v_TN_Gastos = v_TN_Gastos + v_importe_gastos;
			Let v_TN_Multa = v_importe_multa;
			end if;
		end if;
                end foreach;
                       if v_FolReqP > 0 then
		return Null, v_DetFolReqP, 0, 0, v_TP_Multa, v_TP_Gastos  with resume;
                       end if;
                       if v_FolReqN > 0 then
		return Null, v_DetFolReqN, 0, 0, v_TN_Multa, v_TN_Gastos  with resume;
                       end if;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' Cuota Normal, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion = 6 
          		     and H.aso_mes_pago <= (v_Periodo_CN)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;
	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' Excedencias, Meses --';

                	foreach
    		Select h.aso_mes_pago,  Ctrol_Operacion,     h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_Ctrol_Operacion, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = v_Control and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= (v_Periodo_EXE)
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

			--Let v_Importe_recargo = 0;
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		           Let v_TotRecargos = v_TotRecargos + ((v_importe * v_Importe_recargo) / 100);
  		    end if;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                	end foreach;

--     Grabando registro
   if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
       Let v_Detalle_T = 'Adeudos del  ' || aso_proceso || '  ';
       if v_Lineas_CN > 0 then
                Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       end if;
       if v_Lineas_EX > 0 then
                Let v_Detalle_T = v_Detalle_T|| '  ' || v_Detalle_EX;
       end if;
       return Null, v_Detalle_T , v_totAdeudos, v_TotRecargos, 0, 0  with resume;
   end if;

   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;

  END FOR;
-------------------------------------------------------------------------------------------------------------------
       Select Max(fecha_hora_pago) Into v_ult_pago From ta_16_pagos 
               Where control_contrato = v_Control and status_vigencia = 'P';
       if v_ult_pago <> mdy(01,01,1900) then
       RETURN Null, 'FECHA DEL ULTIMO PAGO REALIZADO  ' || v_ult_pago, Null, Null, Null, Null  with resume;
       end if;
-------------------------------------------------------------------------------------------------------------------
       FOREACH
       Select fecha_movto, descripcion Into v_ult_mod, v_DetUltMod From ta_16_contratos_h Where control_contrato = v_Control order by fecha_movto desc
           IF v_cuento = 0 THEN
              LET v_cuento = 1;
              LET v_ult_mod_F = v_ult_mod;
              LET v_DetUltMod_F = v_DetUltMod;
           END IF;
       END FOREACH;
          IF v_cuento > 0 THEN
                RETURN Null, 'FECHA Y DESCRIPCION DEL ULTIMO MOVIMIENTO ' || v_ult_mod_F || '  ' ||  v_DetUltMod_F, Null, Null, Null, Null  with resume;
          END IF;


END FOREACH;

end procedure;

create procedure "bcabrera".spd_11_presclocal(p_idlocal int,p_axo int,p_mes int,p_oficio char(13),p_user int,
p_mov char(1))

returning int as idpago,char(30) as mensaje;

define v_idpago int;
define v_mensaje char(30);
define v_idlocalade int;
define v_axoade int;
define v_mesade int;
define v_importeade money(16,2);
define v_idlocalpre int;
define v_axopre int;
define v_mespre int;
define v_importepre money(16,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_observ varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'spd_11_presclocal ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_idpago=0;
-- condonar � prescribir adeudos
if (p_mov='P') or (p_mov='C') then
   if p_mov='P' then
      let v_observ='PRESCRIPCION DE ADEUDO OFICIO '||p_oficio;
   else
      let v_observ='CONDONACION DE ADEUDO OFICIO '||p_oficio;
   end if; 
   -- selecciona el periodo de adeudo
   select id_local,axo,periodo,importe into v_idlocalade,v_axoade,v_mesade,v_importeade
    from ta_11_adeudo_local where id_local=p_idlocal and axo=p_axo and periodo=p_mes;

   -- graba la condonacion � prescripcion
   insert into ta_11_ade_loc_canc (id_cancelacion,id_local,axo,periodo,importe,clave_canc,observacion,
fecha_alta,id_usuario) values(0,v_idlocalade,v_axoade,v_mesade,v_importeade,p_mov,v_observ,current,p_user);
   let v_idpago=dbinfo("sqlca.sqlerrd1");
   let v_mensaje='Movimiento aplicado correctamente';

   -- borra el periodo de adeudo
   delete from ta_11_adeudo_local where id_local=v_idlocalade and axo=v_axoade and periodo=v_mesade;
   return v_idpago,v_mensaje; 
end if;

-- para cancelar la condonacion � prescripcion de adeudos
if p_mov='A' then
   -- selecciona el periodo condonado � prescrito
   select id_local,axo,periodo,importe into v_idlocalpre,v_axopre,v_mespre,v_importepre
    from ta_11_ade_loc_canc where id_local=p_idlocal and axo=p_axo and periodo=p_mes;

   -- graba el adeudo 
   insert into ta_11_adeudo_local (id_adeudo_local,id_local,axo,periodo,importe,fecha_alta,id_usuario)
     values(0,v_idlocalpre,v_axopre,v_mespre,v_importepre,current,p_user);
   let v_idpago=dbinfo("sqlca.sqlerrd1");
   let v_mensaje='Cancelacion de movimiento aplicado correctamente';

   -- borra el periodo de adeudo
   delete from ta_11_ade_loc_canc where id_local=v_idlocalpre and axo=v_axopre and periodo=v_mespre;
   return v_idpago,v_mensaje;
end if;

end procedure;

CREATE PROCEDURE "bcabrera".int_adeudosmerc(
p_id integer)	

returning  	integer as id,		-- id_local
	smallint as axoadeudo,		-- a�o desde
	smallint as mesadeudo,		-- mes hasta
	money(15,2) as adeudo,      -- adeudo
	money(15,2) as recargos,	-- recargos
    varchar(100) as descripcion;   -- descripcion del registro

define v_estatus smallint;
define v_registro varchar(30);
define v_meses smallint;
define v_merc smallint;
define v_linea char(28);
define v_linea2 char(28);
define v_perdsd integer;
define v_perhst integer;
define v_id_local,v_id integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_adeudo money(15,2);
define v_recargos money(15,2);
define v_descuento money(15,2);
define v_descripcion char(60);
define v_folio integer;
define v_per smallint;
define v_aid_local integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc integer;
define v_total money(15,2);
define v_descreg varchar(100);
define v_redon money(3,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_mensaje varchar(255);

let v_mensaje='';
let v_multa=0;
let v_gastos=0; 
let v_id_local=0;
let v_meses=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_adeudo=0;
let v_recargos=0;
let v_descripcion='';
let v_estatus=0;
let v_recargos=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_linea='';
let v_linea2='';
let v_perdsd=0;
let v_perhst=0;
let v_registro='';
let v_descreg='';
let v_redon=0;
let v_desc=0;

-- para obtener los datos de multa y gastos
select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
into     v_multa,v_folio,v_gastos
from    ta_15_apremios a 
where modulo=11
and control_otr=p_id
and vigencia='1'
and clave_practicado='P';
 
-- todos los adeudos pendientes por pagar
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos,
       d.id_contribuy_renta,d.num_mercado 
into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec,v_desc,v_merc
from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d 
where a.id_local=p_id
--and ((a.axo=v_axocalc and a.periodo<=v_mescalc) or (a.axo<v_axocalc)) 
and b.mes=month(today) and d.id_local=a.id_local
order by a.axo,a.periodo
let v_descripcion='';
let v_porc=0;
if  v_desc is null then
    let v_desc=0;
end if;
let v_adeudo=0;
let v_recargos=0;
let v_recacum=0;
if v_merc=214 then
   let v_impcalc=(v_aimporte*(100-v_desc))/100;
else
   if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
      if v_aperiodo=month(today) then
         if today>v_fecha_desc then
            let v_impcalc=v_aimporte;
         else
            let v_impcalc=v_aimporte-(v_aimporte*.10);
            let v_descripcion='Descuento por pronto pago';
         end if;
      else
         let v_impcalc=v_aimporte-(v_aimporte*.10);
         let v_descripcion='Descuento por pronto pago';     
      end if;
   else
      let v_impcalc=v_aimporte;
   end if;   
end if;
  
if v_mesdsd=0 then
   let v_mesdsd=v_aperiodo;
end if;
  
if v_axodsd=0 then
   let v_axodsd=v_aaxo;
end if; 

let v_meshst=v_aperiodo;
let v_axohst=v_aaxo;  

-- obtiene el porcentaje de recargos
if v_merc <>214 then 	
   if today>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   end if;
else 
   if v_aperiodo=1 then let v_primermes=1;
   else if v_aperiodo=2 then let v_primermes=4;
   else if v_aperiodo=3 then let v_primermes=7;
   else if v_aperiodo=4 then let v_primermes=10;
   else let v_primermes=0;
   end if;
   end if;
   end if;
   end if;

   if v_primermes=month(today) then
      if today>=v_fecha_rec then
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                 (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
      else
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                 (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
      end if;
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
   end if;
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recacum=trunc(v_impcalc*100)/100;
    else
       let v_recacum=trunc(v_impcalc*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recacum=trunc(v_impcalc*250)/100;
    else
       let v_recacum=trunc(v_impcalc*v_porc)/100;
    end if;
end if;
let v_descuento=0;
execute procedure sp_desctomerc(v_aid_local,v_aaxo,v_aperiodo,1,
v_recacum,null,0,'',0,11) into v_descuento,v_mensaje;
if v_descuento>0 then
   let v_descripcion='Descuento en recargos ';
end if;
let v_recargos=v_recacum-v_descuento;
let v_adeudo=v_impcalc;
	
return v_aid_local,v_aaxo,v_aperiodo,v_adeudo,v_recargos,v_descripcion with resume;
end foreach;

end procedure;

CREATE PROCEDURE "saranda".spd_13_extra(var_control integer)
                 returning  smallint as dlinea, int as dcontrol, varchar(60) as dnombre, varchar(60) as ddomicilio,
                 VARCHAR(30) as dcorreo, VARCHAR(18) as dtelefono, varchar(255)as sobserv;

define  v_clave    smallint;
define  v_linea    smallint;
define v_control     int;
define  v_nombre    VARCHAR(60) ;
define  v_domicilio VARCHAR(60) ;
define  v_correo    VARCHAR(30);
define  v_telefono   VARCHAR(18);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_texto  varchar(200);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN 0,0,  '','','' ,'', ('spd_13_extra ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION

let v_linea= 0;


if not exists(select * from ta_13_datosrcmextra where control_rcm=var_control and vigencia='V') then
   let v_clave = 0; 
   let v_texto = 'sin registros';
   return 0,0,  '','','' ,'',(v_texto||' '||v_clave); 
end if;      

foreach
    select id_control,  nombre,  domicilio,  correo,   telefono
    into   v_control,   v_nombre,v_domicilio,v_correo ,v_telefono 
    from ta_13_datosrcmextra where control_rcm=var_control and vigencia='V'
    order by id_control desc


let v_clave = 1; 
let v_texto = 'SE PUEDE GRABAR';
let v_linea= v_linea+1;


--Regresa los datos de encabezado
--return '1',v_control,   v_nombre,v_domicilio,v_correo ,v_telefono,(v_texto||' '||v_clave); 

return v_linea, v_control,   v_nombre,v_domicilio,v_correo ,v_telefono,(v_texto||' '||v_clave) with resume; 

end foreach;

end procedure;

CREATE PROCEDURE "saranda".spd_13_insextra(var_control integer, var_nombre varchar(60), var_domicilio varchar(60),var_correo
                 VARCHAR(30),var_telefono VARCHAR(18), varparentesco char(25))
                 returning  smallint as par_ok, varchar(255)as sobserv;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_insextra ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION


if not exists(SELECT *
    FROM ta_13_datosrcmextra where control_rcm=var_control and nombre=var_nombre and
    domicilio=var_domicilio and correo=var_correo and telefono=var_telefono) then
INSERT INTO ta_13_datosrcmextra(id_control, control_rcm, nombre, domicilio, correo, telefono, fecalta,vigencia,parentesco) 
    VALUES(0, var_control, var_nombre, var_domicilio,var_correo,var_telefono,today,'V',varparentesco);


return 0,'Dado de alta';
else
return 0,'Ya existe';
end if;
end procedure;

create procedure "bcabrera".int_liquidmerc(p_idlocal int,p_axofin int,p_mesfin int,p_medio int)	

returning  	int as idtransaccion,		
            int as idlocal,
            int as numperiodos,
            varchar(250) as descripcion,
            money(16,2) as impactual,
            int as cta_actual,
            money(16,2) as imprezago,
            int as cta_rezago,
            money(16,2) as imprecargos,
            int as cta_recargos,
            money(16,2) as impmulta,
            int as cta_multa,
            money(16,2) as impgastos,
            int as cta_gastos,
            money(16,2) as impredondeo,
            int as cta_redondeo;

define v_cuenta integer;
define v_ctarezago integer;
define v_merc smallint;
define v_perdsd integer;
define v_perhst integer;
define v_id_local,v_id integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_adeudo money(15,2);
define v_adeudorzg money(15,2);
define v_recargos money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_descuento money(15,2);
define v_folio integer;
define v_per smallint;
define v_aid_local integer;
define v_axomin,v_aaxo smallint;
define v_mesmin,v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axocalc smallint;
define v_mescalc,v_primermes smallint;
define v_desc integer;
define v_total money(15,2);
define v_redon money(3,2);
define v_mensaje varchar(30);
define v_folreq integer;
define v_fecreq date;
define dias_cuantos integer;
define dias_habil integer;
define v_porcmul integer;
define v_numper integer;
define v_ctarec integer;
define v_ctamul integer;
define v_ctagas integer;
define v_ctared integer;
define v_descripcion varchar(250);
define v_numtrans integer;
 
let v_id_local=0;
let v_numper=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_adeudo=0;
let v_adeudorzg=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_recargos=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_perdsd=0;
let v_perhst=0;
let v_redon=0;
let v_mensaje='';
let v_ctarec=0;
let v_ctamul=0;
let v_ctagas=0;
let v_fecreq=0;
let v_porcmul=0;
let v_ctared=0;
let v_descripcion='Folios Req. ';
let v_numtrans=0;
let v_axomin=0;
let v_mesmin=0;

    -- para obtener los datos de folios y gastos
    select nvl(count(a.folio),0), nvl(sum(a.importe_gastos),0)  
    into   v_folio,v_gastos
    from   ta_15_apremios a  
    where a.modulo=11
    and a.control_otr=p_idlocal
    and a.vigencia='1'
    and a.clave_practicado='P';

    -- para obtener el datos de multa
    foreach
    select nvl(b.folio,0), nvl(b.importe_multa,0),nvl(b.fecha_practicado,0),nvl(b.porcentaje_multa,0)
    into v_folreq,v_multa,v_fecreq,v_porcmul
    from ta_15_apremios b
    where b.modulo=11 and b.control_otr=p_idlocal and b.vigencia='1' and b.clave_practicado='P'
    order by  b.fecha_emision,b.folio
    let v_descripcion=trim(v_descripcion)||v_folreq||',';
    end foreach;

    let v_descripcion=substr(v_descripcion,1,(length(v_descripcion)-1));
    let dias_cuantos=0;

    select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales 
      where fecha between v_fecreq and today;
    
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
           let v_multa=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
              let v_multa=v_multa*80/100;
           else  
              let v_multa=(v_multa*(100-v_porcmul))/100;
           end if;
        end if;
    else
        let v_multa=(v_multa*(100-v_porcmul))/100;
    end if;

     -- obtiene los datos generales
    select nvl(a.id_local,0),a.id_contribuy_renta,nvl(a.num_mercado,0),
nvl(b.cuenta_ingreso,0),nvl(b.cuenta_rezago,0) 
    into   v_id_local,v_desc,v_merc,v_cuenta,v_ctarezago
    from   ta_11_locales a,ta_11_mercados b
    where a.id_local=p_idlocal
    and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado;

    let v_per=0;
    let v_porc=0;
    if  v_desc is null then
        let v_desc=0;
    end if;

    let v_recacum=0; 

    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

    -- para sacar el mes minimo       
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;
 
    -- para sacar el numero de periodos
    select nvl(count(*),0) into v_numper  from ta_11_adeudo_local 
    where id_local=v_id_local
    and ((axo=p_axofin and periodo<=p_mesfin) or (axo<p_axofin));
       
    -- todos los adeudos hasta periodo de entrada
    foreach
    select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
    into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
    from    ta_11_adeudo_local a,ta_11_fecha_desc b 
    where id_local=v_id_local
    and ((a.axo=p_axofin and a.periodo<=p_mesfin) or (a.axo<p_axofin)) 
    and b.mes=month(today)
    order by axo,periodo

    if v_merc=214 then
       let v_impcalc=(v_aimporte*(100-v_desc))/100;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_impcalc=v_aimporte;
             else
                let v_impcalc=v_aimporte-(v_aimporte*.10);
             end if; 
          else
             let v_impcalc=v_aimporte-(v_aimporte*.10); 
          end if;
       else
          let v_impcalc=v_aimporte;
       end if;   
    end if;
  
    if v_mesdsd=0 then
       let v_mesdsd=v_aperiodo;
    end if;
  
    if v_axodsd=0 then
       let v_axodsd=v_aaxo;
    end if; 

    let v_meshst=v_aperiodo;
    let v_axohst=v_aaxo;  

    -- obtiene el porcentaje de recargos
    if v_merc <>214 then 	
       if today>=v_fecha_rec then
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
       end if;
    else 
       if v_aperiodo=1 then let v_primermes=1;
       else if v_aperiodo=2 then let v_primermes=4;
       else if v_aperiodo=3 then let v_primermes=7;
       else if v_aperiodo=4 then let v_primermes=10;
       else let v_primermes=0;
       end if;
       end if;
       end if;
       end if;

       if v_primermes=month(today) then
          if today>=v_fecha_rec then
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
          else
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
          end if;
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
       end if;
    end if;

    if  v_porc is null then
        let v_porc=0;
    end if;

    if  v_folio = 0 then
        if v_porc > 100 then
           let v_recacum=trunc(v_impcalc*100)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    else
        if v_porc > 250 then
           let v_recacum=trunc(v_impcalc*250)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    end if;

    -- verifica los decuentos de recargos
    let v_descuento=0;
    execute procedure sp_desctomerc(v_aid_local,v_aaxo,v_aperiodo,1,
    v_recacum,null,0,'',0,11) into v_descuento,v_mensaje;
    let v_recacum=v_recacum-v_descuento;
    let v_recargos=v_recargos+v_recacum;

    if  v_aaxo=year(today) then
        let v_adeudo=v_adeudo+v_impcalc;
    else
        let v_adeudorzg=v_adeudorzg+v_impcalc;
    end if;
    end foreach;

    let v_total=v_adeudo+v_adeudorzg+v_recargos+v_multa+v_gastos;

    if v_adeudo<=0 then
       let v_cuenta=0;
    end if;
    if v_adeudorzg<=0 then
       let v_ctarezago=0;
    end if;
    if v_recargos>0 then
       if v_merc=214 then 
          let v_ctarec=570100000;
       else
          let v_ctarec=390400000;
       end if;
    end if;
    if v_multa>0 then
       let v_ctamul=510500000;
    end if;
    if v_gastos>0 then
       let v_ctagas=992100009;
    end if;  

--ajuste al peso.
--   if p_medio<>500 then
--      let v_redon = (trunc(v_total) + 1 ) - v_total ;
--      if v_redon <> 0 then
--         let v_ctared=550800000;
--      end if;
--   end if;

-- inserta totales a tabla de transacciones
if (v_total>0) and (p_medio=500) then
   insert into ta_11_kio_trans (numtrans,id_local,descripcion,axoini,mesini,axofin,mesfin,numperiodos,
   idmedio,impactual,imprezago,imprecargos,impmulta,impgastos,impredon,fecha,estado) 
   values(0,v_id_local,v_descripcion,v_axomin,v_mesmin,p_axofin,p_mesfin,v_numper,
   p_medio,v_adeudo,v_adeudorzg,v_recargos,v_multa,v_gastos,v_redon,current,'V');
   let v_numtrans=dbinfo("sqlca.sqlerrd1");
else
   let v_numtrans=0;
end if;

return v_numtrans,v_id_local,v_numper,v_descripcion,v_adeudo,v_cuenta,v_adeudorzg,v_ctarezago,v_recargos,
v_ctarec,v_multa,v_ctamul,v_gastos,v_ctagas,v_redon,v_ctared;
end procedure;

create procedure "bcabrera".int_pagamerc(p_numtrans int,p_medio int,p_idbanco int,
p_confir int,p_tarjeta varchar(30),p_tipopago int,p_datosinternet varchar(80))

returning int as rec,char(2) as caja,int as operacion,char(200) as descripcion, char(28) as linea;

define v_numtrans int;
define v_idlocal int;
define v_descripcion varchar(240);
define v_axoini,v_mesini,v_axofin,v_mesfin int;
define v_numperiodos int;
define v_idmedio int;
define v_impactual,v_imprezago,v_imprecargos,v_impmulta,v_impgastos,v_impredon money(16,2);
define v_nummerc int;
define v_seccion char(2);
define v_local int;
define v_letra,v_bloque char(1);
define v_adicional char(20);
define v_nomsec,v_nommer char(30);
define v_ctaact,v_ctarzg,v_ctarec,v_ctamul,v_ctagas int;
define v_conc1,v_conc2,v_conc3,v_conc4,v_conc5,v_conc6,v_conc7,v_conc8 char(60);
define v_conc4f1,v_conc4f2,v_conc4f3,v_conc4f4 char(60);
define v_nombre,v_domicilio,v_mensaje char(60);
define v_linea1 char(100);
define v_linea2 char(28);
define v_adeudo,v_total,v_importe money(16,2);
define v_perini,v_perfin int;
define v_reca,v_porcdescrec int; 
define v_caja char(2);
define v_operacion,v_cont,v_cont1,v_cuenta int;
define v_concepto char(60);
define v_categoria,v_desc,v_idcontrol,v_folio int;
define v_aid_local,v_aaxo,v_aperiodo,v_dmes int;
define v_aimporte,v_gastos,v_descuento money(16,2);
define v_fecha_desc date; 

-- datos de la tabla trans
select numtrans,id_local,descripcion,axoini,mesini,axofin,mesfin,numperiodos,idmedio,
impactual,imprezago,imprecargos,impmulta,impgastos,impredon
into v_numtrans,v_idlocal,v_descripcion,v_axoini,v_mesini,v_axofin,v_mesfin,v_numperiodos,v_idmedio,
v_impactual,v_imprezago,v_imprecargos,v_impmulta,v_impgastos,v_impredon
from ta_11_kio_trans where numtrans=p_numtrans;

-- datos de generales y cuentas de aplicacion
select a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque,a.descripcion_local,
b.descripcion,d.descripcion,d.cuenta_ingreso,cuenta_rezago,
case when a.num_mercado = 214 then 570100000 else 390400000 end,510500000,992100009,
a.categoria,a.id_contribuy_renta
into v_nummerc,v_seccion,v_local,v_letra,v_bloque,v_adicional,v_nomsec,v_nommer,
v_ctaact,v_ctarzg,v_ctarec,v_ctamul,v_ctagas,v_categoria,v_desc
from ta_11_locales a,ta_11_secciones b,ta_11_mercados d
where a.id_local=v_idlocal and b.seccion=a.seccion and d.num_mercado_nvo=a.num_mercado;

-- verifica si tiene descuento en recargos
select nvl(porcentaje,0) into v_porcdescrec from ta_11_descrec where id_local=v_idlocal
and vigencia='V' and fecha_baja is null;

-- arma detalle de recibos
let v_conc1='SEC. '||v_seccion||' '||v_nomsec||' LOCAL '||v_local||
' LET. '||v_letra||' BLQ. '||v_bloque;
let v_conc2='ADICIONAL(ES) '||v_adicional;
let v_conc3='POR LOS PERIODOS DEL '||v_mesini||'/'||v_axoini||' AL '||v_mesfin||'/'||v_axofin;
let v_conc4f1 = trim(v_descripcion[1,60]);
let v_conc4f2 = trim(v_descripcion[61,120]);
let v_conc4f3 = trim(v_descripcion[121,180]);
let v_conc4f4 = trim(v_descripcion[181,240]);
let v_conc5='PAGO POR INTERNET';
let v_adeudo=v_impactual+v_imprezago;
let v_total=v_impactual+v_imprezago+v_imprecargos+v_impgastos+v_impmulta;
let v_perini=v_axoini||v_mesini;
let v_perfin=v_axofin||v_mesfin;
let v_concepto='PAGO RENTA MENSUAL DEL MERCADO '||v_nummerc||' '||v_nommer;
let v_conc6='DESCUENTO AUTORIZADO EN RECARGOS '||v_porcdescrec||'%';

-- genera linea de captura de mercados
execute procedure linea_capturamrc(v_idlocal,v_perini,v_perfin,
v_adeudo,v_imprecargos,v_impgastos,v_impmulta,v_total,today) into v_linea1,v_linea2;
let v_domicilio='LINEA CAPTURA '||v_linea2;

-- selecciona la caja y operacion
select id_rec,caja  into v_reca,v_caja 
from ta12_operacKiosco where id_usuario = p_medio; 

select nvl(operacion,0) + 1 into v_operacion 
from ta12_operacKiosco where id_rec=v_reca and caja=v_caja and id_usuario=p_medio;

-- graba recibo
insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,
rfccolonia,obra,id_usuario,fecha_act) 
values(today,v_reca,v_caja,v_operacion,v_total,'P',11,v_idlocal,'M',v_mesini,v_axoini,
v_mesfin,v_axofin,v_nombre,v_domicilio,v_concepto,'INT',v_local,v_nummerc,v_categoria,
p_medio,current);

-- graba la nueva operacion
update ta12_operacKiosco set operacion=v_operacion
where id_rec=v_reca and caja=v_caja and id_usuario=p_medio;

-- afecta datos de tarjeta 
if p_confir > 0 and  trim(p_tarjeta) <> '' then
   insert into ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today ,v_reca , v_caja, v_operacion , p_idbanco  ,
  p_confir ,  p_tarjeta, v_total,  p_tipopago, p_datosinternet);
end if;

-- graba detalle de recibo
for v_cont= 1 to 8
    if v_cont = 1 then let v_conc8=v_conc1; let v_cuenta=v_ctaact; let v_importe=v_impactual; 
    else if v_cont = 2 then let v_conc8=v_conc2; let v_cuenta=v_ctaact; let v_importe=v_imprezago;
    else if v_cont = 3 then let v_conc8=v_conc3; let v_cuenta=v_ctaact; let v_importe=v_impmulta;
    else if v_cont = 4 then let v_conc8=v_conc4f1; let v_cuenta=v_ctaact; let v_importe=v_impgastos;
    else if v_cont = 5 then let v_conc8=v_conc4f2; let v_cuenta=0; let v_importe=0;
    else if v_cont = 6 then let v_conc8=v_conc4f3; let v_cuenta=0; let v_importe=0;
    else if v_cont = 7 then let v_conc8=v_conc4f4; let v_cuenta=0; let v_importe=0;
    else if v_cont = 8 then let v_conc8=v_conc5; let v_cuenta=0; let v_importe=0;
    else if v_cont = 9 then let v_conc8=v_conc6; let v_cuenta=0; let v_importe=0;
    else let v_conc8=''; let v_cuenta=0; let v_importe=0;
    end if; end if; end if; end if; end if; end if; end if; end if; end if; 

    if trim(v_conc8)>'' then
       insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
       values(today,v_reca,v_caja,v_operacion,v_cont,v_conc8,v_cuenta,v_importe);
    end if;
end for;

-- afecta como pagado num_trans
update ta_11_kio_trans set estado='P' where numtrans=p_numtrans;

-- afecta los periodos como pagados
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento 
into v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc
from    ta_11_adeudo_local a,ta_11_fecha_desc b where a.id_local=parid
and ((a.axo=p_axofin and a.periodo<=p_mesfin) or (a.axo<p_axofin))
and b.mes=month(today) 
order by axo,periodo

-- calcula los descuentos de tianguis y pronto pago de locales
if v_nummerc=214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
else
   if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
      if v_aperiodo=month(today) then
         if today<=v_fecha_desc then
            let v_aimporte=v_aimporte-(v_aimporte*.10);
         end if;
      else
         let v_aimporte=v_aimporte-(v_aimporte*.10); 
      end if;
   end if;
end if;

-- inserta el pago a mercados
insert into ta_11_pagos_local(id_pago_local,id_local,axo,periodo,fecha_pago,oficina_pago,
caja_pago,operacion_pago,importe_pago,folio,fecha_modificacion,id_usuario) 
values(0,v_idlocal,v_aaxo,v_aperiodo,today,v_reca,v_caja,v_operacion,
v_aimporte,'PAGO POR INTERNET',current,p_medio);

-- quitar los adeudos
delete from ta_11_adeudo_local where id_local=v_idlocal and axo=v_aaxo and periodo=v_aperiodo;
end foreach;

-- seleccionar los folios vigentes y practicados
foreach
select nvl(id_control,0),nvl(folio,0),importe_gastos 
into v_idcontrol,v_folio,v_gastos
from    ta_15_apremios a  
where modulo=11
and control_otr=p_idlocal
and vigencia='1'
and clave_practicado='P'

-- poner como pagados los folios vigentes y practicados
update ta_15_apremios set fecha_pago=today,recaudadora=v_reca,caja=v_caja,
operacion=v_operacion,vigencia='2',clave_mov='P',importe_pago=v_gastos
where modulo=11 and Id_control=v_idcontrol;
end foreach

-- afecta como pagado el descuento de recargos
if  v_porcdescrec>0 then
    execute procedure sp_desctomerc(v_idlocal,v_axofin,v_mesfin,3,0,today,
    v_reca,v_caja,v_operacion,11) into v_descuento,v_mensaje;
end if;
   
-- poner la linea de captura consilidada y pagada 

return v_reca,v_caja,v_operacion,v_descripcion,v_linea2;
end procedure;

create procedure "saranda".sp_13_historia(var_control int)
                   returning  smallint as par_ok, varchar(255)as sobserv;

define v_lError         int;
define v_lISAMError     int;
define v_vcMensaje      varchar(255);
define v_control_rcm    int;
define v_cementerio   	CHAR(1);
define v_clase        	SMALLINT;
define v_clase_alfa   	VARCHAR(10);
define v_seccion      	SMALLINT;
define v_seccion_alfa 	VARCHAR(10);
define v_linea        	SMALLINT;
define v_linea_alfa   	VARCHAR(20);
define v_fosa         	SMALLINT;
define v_fosa_alfa    	VARCHAR(20);
define v_axo_pagado   	INTEGER;
define v_metros       	DECIMAL(5,3);
define v_nombre       	VARCHAR(60);
define v_domicilio    	VARCHAR(60);
define v_exterior     	CHAR(6);
define v_interior     	CHAR(6);
define v_colonia      	VARCHAR(30);
define v_observaciones	VARCHAR(60);
define v_usuario      	INTEGER;
define v_fecha_mov    	DATE;
define v_tipo         	CHAR(1);
define v_fecha_alta   	DATE;
define v_vigencia     	CHAR(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_historia ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION




SELECT control_rcm, cementerio, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, 
    axo_pagado, metros, nombre, domicilio, exterior, interior, colonia, observaciones, usuario, fecha_mov, tipo, fecha_alta, vigencia 
    into v_control_rcm, v_cementerio, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, v_fosa,
    v_fosa_alfa, v_axo_pagado, v_metros, v_nombre, v_domicilio, v_exterior, v_interior, v_colonia, v_observaciones, v_usuario, v_fecha_mov, v_tipo, v_fecha_alta, v_vigencia 
    FROM ta_13_datosrcm where control_rcm=var_control;
   INSERT INTO ta_13_datosrcmHis 
    VALUES(0, v_control_rcm, v_cementerio, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, v_fosa,
    v_fosa_alfa, v_axo_pagado, v_metros, v_nombre, v_domicilio, v_exterior, v_interior, v_colonia, v_observaciones, v_usuario, v_fecha_mov, v_tipo, v_fecha_alta, v_vigencia,today);

    return 0,'Dado de alta';
end procedure;

CREATE PROCEDURE "saranda".spd_13_datosrcm(var_control integer,var_cementerio char(1),var_clase smallint, var_clasalf varchar(10,0),var_secc smallint,
                                 var_seccalf varchar(10,0),var_linea smallint, var_linalf varchar(10,0),var_fosa smallint,
                                 var_fosalf varchar(10,0),var_axo int)
                 returning  char(1) as slinea, int as sclave, varchar(100) as scomentario, varchar(100) as sregcomp,
               VARCHAR(60) as snombre,VARCHAR(75) as sdomcomp, VARCHAR(30)as scol,VARCHAR(10) as stdesc,
               VARCHAR(60) as snomcem, varchar(250) as sconcepto, money(15,2) as simptot,varchar(30) as speriodo,
			integer as saxoade, money(15,2) as simporte,money(15,2) as sctaapli, money(15,2) as srecargo, money(15,2) as sctaaplr,
             money(15,2) as sdesctoimp,money(15,2) as sctaapldi, money(15,2) as sdesctorec, money(15,2) as sctaapldr,
            money(15,2) as sajuste, varchar(60)as sobserv;
			--axo_adeudo, importe, recargo,importe descuento, observacion

define v_uap    integer;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_clase SMALLINT;
define  v_clase_alfa VARCHAR(10);
define  v_seccion SMALLINT;
define  v_seccion_alfa VARCHAR(10);
define  v_linea SMALLINT;
define  v_linea_alfa VARCHAR(20);
define  v_fosa SMALLINT;
define  v_fosa_alfa VARCHAR(20);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_nombre VARCHAR(60) ;
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_reg_cem varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_tipodesc VARCHAR(10);
define  v_nomcem VARCHAR(60);
define  v_concepto varchar(250);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define  v_totim money(15,2);
define  v_totre money(15,2);
define  v_totdi money(15,2);
define  v_totdr money(15,2);

define v_cuenta integer;
define v_ajuste money(5,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


--ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--RETURN '-1',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,'', 'sp_13_datosrcm ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

--END EXCEPTION

let v_axo=year(today);
let v_mes=month(today);
--let v_mes=2;
let v_imptot=0;
let v_concepto = '';
let v_periodo='';
let v_desctot  = 0;
let  v_totim=0;
let  v_totre=0;
let  v_totdi=0;
let  v_totdr=0;
let  v_ctaapli=0;
let  v_ctaaplr=0;
let  v_ctaapldi=0;
let  v_ctaapldr=0;

if var_control>0 then
select control_rcm, cementerio,cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
clase,clase_alfa,seccion,seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
end
into v_control, v_cementerio,v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
,v_axo_pagado,v_metros,v_nombre,v_domcompleto,v_colonia ,v_tipodesc
from ta_13_datosrcm where control_rcm=var_control;
else
select control_rcm, cementerio,cementerio || clase||' '||clase_alfa ||' '||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
clase,clase_alfa,seccion,seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
end
into v_control,v_cementerio,v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
,v_axo_pagado,v_metros,v_nombre,v_domcompleto,v_colonia ,v_tipodesc
from ta_13_datosrcm where cementerio=var_cementerio and clase=var_clase and clase_alfa= var_clasalf and seccion=var_secc 
and seccion_alfa=var_seccalf and linea=var_linea and linea_alfa=var_linalf and fosa= var_fosa  and fosa_alfa=var_fosalf;
end if;



select  nombre, cta_aplicacion, cta_vencido into v_nomcem,v_ctaapl1,v_ctaapl2 
from tc_13_cementerios where cementerio=v_cementerio;



if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   let v_clave = 1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,0,0,0,0,0,''; 
end if;      
if v_axo_pagado=v_axo  then
   let v_clave = 2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,0,0,0,0,0,''; 
end if;     
if v_tipodesc <>'FOSA'  then
   let v_clave = 3; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO ES FOSA, NO SE PUEDE PAGAR';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,0,0,0,0,0,''; 
end if;     

if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;

let v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || v_axo;
let v_concepto = 'MANTENIMIENTO DEL CEMENTERIO '|| v_nomcem || 'POR EL PERIODO '||  v_axodesde || ' - ' || v_axo || ' DE ' || v_metros || ' MTS. ';
let v_concepto = v_concepto || 'DE '|| v_clase ||' CLASE ' || v_clase_alfa || ' SECC. '|| v_seccion || ' ' || v_seccion_alfa || 'LINEA ' ||v_linea || ' ' || v_linea_alfa || ' FOSA ' || v_fosa;

let v_clave = 0; 
let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO SE PUEDE PAGAR';

if v_axo<>var_axo then
   let v_axo=var_axo;
end if;
---Para calcular el importe total
foreach 
select b.axo_adeudo,b.importe,b.importe_recargos,d.axo_descto,nvl(d.descuento,0),b.descto_impote, b.descto_recargos
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
           order by 1


--    let v_impdesc = 0;
--    let v_recardesc = 0;
    let v_desctot = 0;
    let v_desctotre = 0;
     --se aplica descuento de pesionado
--     if  v_descuento <> 0 then         
--           let v_impdesc = trunc(((vpar_impte * v_descuento)  / 100),2);  --descuento a impueso
--           let v_recardesc = trunc(((v_recardesc * v_descuento) /100),2); --descuento a recargos
--           let v_desctot  = v_desctot  + v_impdesc + v_recardesc;
--     end if;
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=v_axo)) then
           let v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
     end if;
     let v_desctot  =  v_impdesc;
     let v_desctotre  =   v_recardesc;
     let v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) ; 
     let v_totim = (v_totim + vpar_impte); 
     let v_totre = (v_totre + vpar_recar); 
     let v_totdi = (v_totdi + v_desctot); 
     let v_totdr = (v_totdr + v_desctotre); 

          --si es el a�o actual y es enero o febrero se aplica el 10% de descuento

end foreach;

--Regresa los datos de encabezado
    execute procedure catastro_gdl:redondeocaja(v_imptot) into v_imptot, v_ajuste; 
  --   let v_imptot = (v_imptot + v_ajuste) ; 
     let v_totdi = (v_totdi * -1); 
     let v_totdr = (v_totdr * -1); 

 return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,v_totim,0,v_totre,0,
 v_totdi,0, v_totdr,0,v_ajuste,'' with resume; 

---Calcula los detalles
foreach 
    select b.axo_adeudo,b.importe,b.importe_recargos,d.axo_descto,nvl(d.descuento,0),b.descto_impote, b.descto_recargos
          into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
          order by 1

    let v_desctot = 0;
    let v_desctotre = 0;
     --se aplica descuento de pesionado
    let v_obs = '';
    if  v_descuento <> 0 then         
           let v_desctot  = v_desctot  + v_impdesc;
           let v_obs = 'INCLUYE DESC. '||v_descuento||'% POR PENSIONADO'; 
     end if;
          --si es el a�o actual y es enero o febrero se aplica el 10% de descuento
     let v_desctotre  = v_desctotre  + v_recardesc;
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=v_axo)) then
          let v_desctot  =v_desctot+ trunc(((vpar_impte-v_impdesc) * 0.1),2);
          if  v_obs = '' then
             let v_obs = v_obs || ' INCLUYE DESC. 10% POR PRONTO PAGO'; 
          else
              let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
          end if;
     end if;
     if vpar_axo=year(today) then
        let v_ctaapli=v_ctaapl1;
     else
        let v_ctaapli=v_ctaapl2;
     end if;   
     if vpar_recar>0 then
        let v_ctaaplr=390300000;
     end if;   
     if v_desctot>0 then
        let v_ctaapldi=v_ctaapli;
        let v_desctot= v_desctot* -1;
     end if;   
     if v_desctotre>0 then
        let v_ctaapldr=390300000;
        let v_desctotre= v_desctotre* -1;
     end if;   
  return 'D',v_clave,v_texto,'','','','','','','','','',vpar_axo,vpar_impte, v_ctaapli, vpar_recar, v_ctaaplr,
v_desctot,v_ctaapldi,v_desctotre,v_ctaapldr,0,v_obs with resume; 

end foreach;


   --regresa el ajuste si es kiosco
  -- if v_s_origen= 2 then
     if v_ajuste <> 0 then    
        return 'D',v_clave,v_texto,'','','','','','','','','',0,v_ajuste, 550800000, 0, 0,0, 0,0,0,0,'AJUSTE ARTICULO 14 LEY DE INGRESOS'; 
     end if;
   --end if;
end procedure;

CREATE PROCEDURE "saranda".sp_13_altapens(v_foliod int, v_folioh int)
                returning varchar(100);  
define      Vcontrol_des    int;
define      Vcontrol_rcm	INTEGER;
define      Vaxo_alta   	INTEGER;
define      Vdecuento   	INTEGER;
define      Vusuario    	INTEGER;
define      Vfecha_mov  	DATE;
define      Vaxo_ini    	INTEGER;
define      vini    	INTEGER;
define      vreac    	char(1);

let vini=0;
foreach
select  control_rcm, axo_alta, decuento, usuario, fecha_mov, axo_ini 
into   Vcontrol_rcm, Vaxo_alta, Vdecuento, Vusuario, Vfecha_mov, Vaxo_ini 
from ta_13_descpens1 where control_rcm between v_foliod and v_folioh
let vini=vaxo_ini;
if Vaxo_alta=2011 then
   let vreac='S';
else
   let vreac='N';
end if;
--   return ''||vini||' '||vaxo_alta||' '||vcontrol_rcm with resume;

while (Vaxo_alta+1)>vini
  insert into ta_13_descpens values(0, Vcontrol_rcm, vini, Vdecuento, Vusuario, Vfecha_mov, today,'V',vreac); 
--   return ''||vini||' '||vaxo_alta||' '||vcontrol_rcm with resume;
  let vini= vini+1;
end while;
 
end foreach;

end procedure;

create procedure  "informix".sp_cg_pres_predial(p_axo integer)
  returning 
    INT as poliza,
    VARCHAR(200) as mensaje;
 define    cgo_mayor CHAR(4) ;
 define    cgo_sub01 CHAR(2) ;
 define    cgo_sub02 CHAR(4) ;
 define    cgo_sub03 CHAR(5) ;
 define    cgo_sub04 CHAR(5) ;
 define    abo_mayor CHAR(4) ;
 define    abo_sub01 CHAR(2) ;
 define    abo_sub02 CHAR(4) ;
 define    abo_sub03 CHAR(5) ;
 define    abo_sub04 CHAR(5) ;
define v_ctaaplica int;
define v_numero int;
define v_idpoliza int;
define v_impuesto money(16,2);
define v_cvecuenta integer;
define v_tot_impuesto money(16,2);
define  v_cargo  money(16,2);
define  v_abono money(16,2);
define mensaje char(100);
let v_tot_impuesto = 0;
let v_ctaaplica = 110210000;  --rustico
select max(numero) into v_numero
 from cg_polizas where ejercicio = p_axo and mes = 1and tipo =3 ;
if v_numero is null then
   let v_numero = 0;
end if;
let v_numero = v_numero +1;
insert into cg_polizas ( id_poliza , ejercicio , mes , tipo , numero , fecha ,id_modulo ,
    id_proceso, id_rec , concepto , concepto_gral, clave ,  capturo , tipo_proceso)
values (0, p_axo, 1, 3, v_numero, today, 5,1, 9, 'PRESUPUESTO INICIAL '|| p_axo,'ejecucion del proceso sp_cg_pres_predial', 'A', user , 'A');
LET v_idpoliza = dbinfo("sqlca.sqlerrd1");
---  insertar cada registro por cuenta al impuesto.
--- PAra Cuentas Rusticas
select cta_m11 , cta_m12 , cta_m13 , cta_m14 , cta_m15 , cta_m21 , cta_m22 , cta_m23 , cta_m24 , cta_m25
into cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,   abo_mayor 
,   abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 
 from ta_12_cuentasmci where cta_aplicacion =  v_ctaaplica and momentos = 10 ;

FOREACH 

 select  a.cvecuenta , nvl(sum(a.impfac),0) into v_cvecuenta ,v_impuesto
         from catastro_gdl:detsaldos a, catastro_gdl:convcta b 
         where a.axosal = p_axo and  a.cvecuenta = b.cvecuenta and b.urbrus = 'R' 
               and b.vigente ='V' 
          group by 1
 
 
 insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
  values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
   v_impuesto , 0, v_cvecuenta , '1 al 6 del '|| p_axo , 'Presupuesto inicial de predial '|| p_axo ) ;   
  let v_tot_impuesto = v_tot_impuesto + v_impuesto;
END FOREACH;

insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono ,id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
   0,v_tot_impuesto , 0, 'Del 1 al 6 del '||p_axo  , 'Presupuesto inicial de predial '||p_axo) ;

let v_tot_impuesto = 0;

let v_ctaaplica = 110110000;  -- urbano
--- PAra Cuentas Urbanas
select cta_m11 , cta_m12 , cta_m13 , cta_m14 , cta_m15 , cta_m21 , cta_m22 , cta_m23 , cta_m24 , cta_m25
into cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,   abo_mayor 
,   abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 
 from ta_12_cuentasmci where cta_aplicacion =  v_ctaaplica and momentos = 10 ;

FOREACH 

 select  a.cvecuenta , nvl(sum(a.impfac),0) into v_cvecuenta ,v_impuesto
         from catastro_gdl:detsaldos a, catastro_gdl:convcta b 
         where a.axosal = p_axo and  a.cvecuenta = b.cvecuenta and b.urbrus = 'U' 
               and b.vigente ='V' 
          group by 1
  
 insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
  values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
   v_impuesto , 0, v_cvecuenta , '1 al 6 del '|| p_axo , 'Presupuesto inicial de predial '|| p_axo ) ;   
  let v_tot_impuesto = v_tot_impuesto + v_impuesto;
END FOREACH;
-- para cuentas URbanas

insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono ,id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
   0,v_tot_impuesto , 0, 'Del 1 al 6 del '||p_axo  , 'Presupuesto inicial de predial '||p_axo) ;

select sum(cargo), sum(abono) into v_cargo , v_abono from  cg_poliza_movimientos where  id_poliza = v_idpoliza;
let mensaje = 'Poliza cuadrada..';
if v_cargo <> v_abono then
    let mensaje = 'Poliza descuadrada.. Verifique';
end if;
return v_idpoliza , mensaje;
end procedure
;

create procedure "imtorre".operkiosco(p_fecha date , p_kiosco char(2)) 
    RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_fechatime datetime year to fraction(3) ;
   begin
    on exception in (-958)
       delete from tmp_operkiosco;
    end exception;
    create temp table tmp_operkiosco
       (id_modulo integer,
        descripcion       char(140),
        operaciones      integer,
        importe     money(16,2)  ,
        fecha  datetime year to fraction(3) ) with no log;
     end



     
 insert into tmp_operkiosco
    select  r.id_modulo , d.descripcion  ,count(*), sum(r.importe) , CURRENT year to fraction(3) 
     from ta_12_recibos r , ta_12_moduloscat d 
    where r.fecha = p_fecha and r.caja = p_kiosco
    and r.id_modulo <> 12  and r.id_rec <> 9 and r.cvepago = 'P' and d.id_modulo = r.id_modulo
    group by 1,2;
   
   insert into tmp_operkiosco
    select (r.id_modulo *1000) + r.id_regmodulo ,d.descripcion   , count(*), sum(importe) , CURRENT year to fraction(3) 
      from ta_12_recibos r , outer ta_12_moduloscat d 
   where r.fecha = p_fecha and r.caja = p_kiosco
   and r.id_modulo = 12 and r.id_rec <> 9 and r.cvepago = 'P'  and d.id_modulo = (r.id_modulo *1000) + r.id_regmodulo
    group by 1,2 ;
   foreach 
    select id_modulo ,  descripcion ,   operaciones   ,   importe    ,   fecha
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
   from tmp_operkiosco order by 4
    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach

 
end procedure;

CREATE PROCEDURE "egarcias".adeudo_cons(
    p_recaud SMALLINT,
    p_urbrus CHAR(1),
    p_cuenta INT
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);

--****** variables locales
define v_cvecuenta int;
define v_cvepago int;
define v_caja char(2);--
define v_operacion int;--
define v_fecha date;--
define v_id_rec smallint;--
define v_estatus char(1);
define v_linea char(33);

--select * from catastro_gdl:convcta where cvecuenta = 10000
--Verifica que exista en catastro_gdl:convcta
  	if NOT exists (select * from catastro_gdl:convcta where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta)then--bco
	
	return -1,"LA CUENTA PROPORCIONADA NO EXISTE",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin bco	

--select * from catastro_gdl:saldos where cvecuenta = 10000 and saldototal=0

--Verifica que exista en v_bco_carga1
	
	if exists (select * from v_bco_carga1 where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta
		and estatus != "A" and cvepago = 0 and YEAR(fecha_pagobco) = YEAR(today))then--bco2
-- el -2 me sirve para ense�ar enlace en la p�gina...
	return -2,"LA CUENTA PRESENTA PAGOS PENDIENTES POR APLICAR",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;
	end if; --Fin bco2	

  	if NOT exists (select * from v_bco_carga1 where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta
		and estatus = "A" and cvepago > 0 and YEAR(fecha_pagobco) = YEAR(today))then--bco
	
	--Obtengo la cvecuenta
		select cvecuenta into v_cvecuenta from catastro_gdl:convcta where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta;		
	
	--Verifico si est� la l�nea de captura en linea_pagos mediante la clave cuenta
	  	if exists (select linea from linea_pagos where substr(linea,1,6) = v_cvecuenta AND modulo = 1 AND fecha_pago >= "01/01/"||year(today))then--linea
		
		select linea into v_linea from linea_pagos where substr(linea,1,6) = v_cvecuenta AND modulo = 1 AND fecha_pago >= "01/01/"||year(today);

		return -3,v_linea,
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;
	     
	      end if; --Fin linea

	return -1,"LA CUENTA NO PRESENTA PAGOS EN BANCOS PARA EL A�O ACTUAL",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;

   	end if; --Fin bco	
	
	select cvecuenta, cvepago, estatus 
	into v_cvecuenta, v_cvepago, v_estatus
	from v_bco_carga1 
	where recaud = p_recaud 
	and urbrus = p_urbrus
	and cuenta = p_cuenta
	and estatus = "A"
	and cvepago > 0
	and YEAR(fecha_pagobco) = YEAR(today);
	
	if v_estatus <> "A" then
         return -1,"LA CUENTA NO HA SIDO APLICADA, PARA PAGO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;
        end if;	

--Verificar en v_pagos
	if NOT exists ( select * from v_pagos where cvepago = v_cvepago and cvecuenta= v_cvecuenta 
	and cvecanc is null)then --v_pagos
	
	return -1,"EL PAGO REALIZADO A ESTA CUENTA, EST� EN PROCESO DE APLICACI�N",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin v_pagos

	select fecha, recaud, caja, folio 
	into v_fecha, v_id_rec, v_caja, v_operacion
	from v_pagos
	where cvepago= v_cvepago 
	and cvecuenta= v_cvecuenta
	and cvecanc is null; 	

--Validar en ta_12_recibos

       if NOT exists (select * from ta_12_recibos where fecha=v_fecha and id_rec = v_id_rec and caja=v_caja 
	and operacion=v_operacion and cvepago="P") then--recibos
	
	return -1,"LA CUENTA NO EXISTE EN EL REGISTRO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos

  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc

  from  ta_12_recibos 

  where  fecha=v_fecha and id_rec = v_id_rec and caja=v_caja 
	 and operacion=v_operacion and cvepago="P";

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"CUENTA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc;
end procedure;

CREATE PROCEDURE "saranda".spd_13_datosenc(var_control integer, var_axo int)
                 returning  char(1) as slinea, int as sclave, varchar(100) as scomentario, varchar(100) as sregcomp,
               VARCHAR(60) as snombre,VARCHAR(75) as sdomcomp, VARCHAR(30)as scol,VARCHAR(10) as stdesc, dec(5,3) as smetros,
               VARCHAR(60) as snomcem, varchar(250) as sconcepto, money(15,2) as simptot,varchar(30) as speriodo,
			   money(15,2) as simporte, money(15,2) as srecargo, money(15,2) as sdesctoimp,money(15,2) as sdesctorec,
               money(15,2) as sajuste, varchar(60)as sobserv;

define v_uap    integer;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_metros dec(5,3);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_clase SMALLINT;
define  v_clase_alfa VARCHAR(10);
define  v_seccion SMALLINT;
define  v_seccion_alfa VARCHAR(10);
define  v_linea SMALLINT;
define  v_linea_alfa VARCHAR(20);
define  v_fosa SMALLINT;
define  v_fosa_alfa VARCHAR(20);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_nombre VARCHAR(60) ;
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_vigencia CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_reg_cem varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_tipodesc VARCHAR(10);
define  v_nomcem VARCHAR(60);
define  v_concepto varchar(250);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define  v_totim money(15,2);
define  v_totre money(15,2);
define  v_totdi money(15,2);
define  v_totdr money(15,2);

define v_cuenta integer;
define v_ajuste money(5,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


--ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--RETURN '-1',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,'', 'sp_13_datosrcm ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

--END EXCEPTION

let v_axo=year(today);
let v_mes=month(today);
--let v_mes=2;
let v_imptot=0;
let v_concepto = '';
let v_periodo='';
let v_obs='';
let v_desctot  = 0;
let  v_totim=0;
let  v_totre=0;
let  v_totdi=0;
let  v_totdr=0;
let  v_ctaapli=0;
let  v_ctaaplr=0;
let  v_ctaapldi=0;
let  v_ctaapldr=0;

if var_control>0 then
select control_rcm, cementerio,cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
clase,clase_alfa,seccion,seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,metros,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
end, vigencia
into v_control, v_cementerio,v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
,v_axo_pagado,v_metros,v_nombre,v_domcompleto,v_colonia ,vpar_metros,v_tipodesc,v_vigencia
from ta_13_datosrcm where control_rcm=var_control;
else
select control_rcm, cementerio,cementerio || clase||' '||clase_alfa ||' '||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
clase,clase_alfa,seccion,seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,metros,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
end,vigencia
into v_control,v_cementerio,v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
,v_axo_pagado,v_metros,v_nombre,v_domcompleto,v_colonia ,vpar_metros,v_tipodesc,v_vigencia
from ta_13_datosrcm where cementerio=var_cementerio and clase=var_clase and clase_alfa= var_clasalf and seccion=var_secc 
and seccion_alfa=var_seccalf and linea=var_linea and linea_alfa=var_linalf and fosa= var_fosa  and fosa_alfa=var_fosalf;
end if;



select  nombre, cta_aplicacion, cta_vencido into v_nomcem,v_ctaapl1,v_ctaapl2 
from tc_13_cementerios where cementerio=v_cementerio;



if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   let v_clave = 1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,''; 
end if;      
if v_axo_pagado=v_axo  then
   let v_clave = 2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,''; 
end if;     
if v_vigencia='B'  then
   let v_clave = 2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO ESTA DADO DE BAJA';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,''; 
end if;     
--if v_tipodesc <>'FOSA'  then
--   let v_clave = 3; 
--   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO ES FOSA, NO SE PUEDE PAGAR';
--   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,''; 
--end if;     

if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;

let v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || var_axo;
let v_concepto = 'MANTENIMIENTO DEL CEMENTERIO '|| v_nomcem || 'POR EL PERIODO '||  v_axodesde || ' - ' || var_axo || ' DE ' || v_metros || ' MTS. ';
let v_concepto = v_concepto || 'DE '|| v_clase ||' CLASE ' || v_clase_alfa || ' SECC. '|| v_seccion || ' ' || v_seccion_alfa || 'LINEA ' ||v_linea || ' ' || v_linea_alfa || ' FOSA ' || v_fosa;
let v_concepto = v_concepto || '  ' || v_fosa_alfa;

let v_clave = 0; 
let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO SE PUEDE PAGAR';

if v_axo=var_axo then   
   EXECUTE PROCEDURE spd_13_recargos(v_control, v_mes);
end if;

if v_axo<>var_axo then
   let v_axo=var_axo;
end if;
---Para calcular el importe total
foreach 
select b.axo_adeudo,b.importe,b.importe_recargos,d.axo_descto,nvl(d.descuento,0),b.descto_impote, b.descto_recargos
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and b.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
           order by 1

    let v_desctot = 0;
    let v_desctotre = 0;
    if  v_descuento>0 then
           let v_obs='Desc Pensionado 50%';
    end if;
     --se aplica descuento de pesionado
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
     if  v_descuento=0 then
           let v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
           let v_obs=v_obs||' Incluye 10% Desc por pronto pago ';
     end if;
     end if;
     let v_desctot  =  v_impdesc;
     let v_desctotre  =   v_recardesc;
     let v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) ; 
     let v_totim = (v_totim + vpar_impte); 
     let v_totre = (v_totre + vpar_recar); 
     let v_totdi = (v_totdi + v_desctot); 
     let v_totdr = (v_totdr + v_desctotre); 


end foreach;

--Regresa los datos de encabezado
    execute procedure catastro_gdl:redondeocaja(v_imptot) into v_imptot, v_ajuste; 
     let v_totdi = (v_totdi * -1); 
     let v_totdr = (v_totdr * -1); 

 return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,v_totim,v_totre,
 v_totdi, v_totdr,v_ajuste,v_obs with resume; 

end procedure;

CREATE PROCEDURE "saranda".spd_13_datosdet(var_control integer, var_axo int)
                 returning  char(1) as slinea, int as sclave, 
                integer as saxoade, money(15,2) as simporte, money(15,2) as sdescimp, int as sctaapli, 
                 money(15,2) as srecar, money(15,2) as sdescrec, int as sctaaplr,varchar(60)as sobserv;

define v_uap    integer;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_nombre VARCHAR(60) ;
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_vigencia CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_nomcem VARCHAR(60);
define  v_concepto varchar(250);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define  v_totim money(15,2);
define  v_totre money(15,2);
define  v_totdi money(15,2);
define  v_totdr money(15,2);

define v_cuenta integer;
define v_ajuste money(5,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


let v_axo=year(today);
let v_mes=month(today);
let v_imptot=0;
let v_concepto = '';
let v_periodo='';
let v_desctot  = 0;
--let v_mes=2;

let  v_totim=0;
let  v_totre=0;
let  v_totdi=0;
let  v_totdr=0;
let  v_ctaapli=0;
let  v_ctaaplr=0;
let  v_ctaapldi=0;
let  v_ctaapldr=0;

select control_rcm, cementerio,axo_pagado,vigencia
into v_control, v_cementerio,v_axo_pagado,v_vigencia
from ta_13_datosrcm where control_rcm=var_control;

select  nombre, cta_aplicacion, cta_vencido into v_nomcem,v_ctaapl1,v_ctaapl2 
from tc_13_cementerios where cementerio=v_cementerio;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   let v_clave = 1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   return 'D',v_clave,0,0,0,0,0,0,0,v_texto; 
end if;      
if v_axo_pagado=v_axo  then
   let v_clave = 2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   return 'D',v_clave,0,0,0,0,0,0,0,v_texto; 
end if;     
if v_vigencia='B'  then
   let v_clave = 3; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO ESTA DADO DE BAJA';
   return 'D',v_clave,0,0,0,0,0,0,0,v_texto; 
end if;     

if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;
let v_clave = 0; 
if v_axo<>var_axo then
   let v_axo=var_axo;
end if;
---Para calcular el importe total
foreach 
select b.axo_adeudo,b.importe,b.importe_recargos,d.axo_descto,nvl(d.descuento,0),b.descto_impote, b.descto_recargos
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
           order by 1


    let v_desctot = 0;
    let v_desctotre = 0;
     --se aplica descuento de pesionado
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
           let v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
     end if;
     let v_desctot  =  v_impdesc;
     let v_desctotre  =   v_recardesc;
     let v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) ; 

end foreach;

--Calcula ajuste
--    execute procedure catastro_gdl:redondeocaja(v_imptot) into v_imptot, v_ajuste; 
---Calcula los detalles
foreach 
    select b.axo_adeudo,b.importe,b.importe_recargos,d.axo_descto,nvl(d.descuento,0),b.descto_impote, b.descto_recargos
          into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and  b.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
          order by 1

    let v_desctot = 0;
    let v_desctotre = 0;
     --se aplica descuento de pesionado
    let v_obs = '';
    if  v_descuento <> 0 then         
           let v_desctot  = v_desctot  + v_impdesc;
           let v_obs = 'INCLUYE DESC. '||v_descuento||'% POR PENSIONADO'; 
     end if;
          --si es el a�o actual y es enero o febrero se aplica el 10% de descuento
     let v_desctotre  = v_desctotre  + v_recardesc;
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
        if v_impdesc=0 then
          let v_desctot  =v_desctot+ trunc(((vpar_impte-v_impdesc) * 0.1),2);
          if  v_obs = '' then
             let v_obs = v_obs || ' INCLUYE DESC. 10% POR PRONTO PAGO'; 
          else
              let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
          end if;
          end if;
     end if;
     if vpar_axo=year(today) then
        let v_ctaapli=v_ctaapl1;
     else
        let v_ctaapli=v_ctaapl2;
     end if;   
     if vpar_recar>0 then
        let v_ctaaplr=390300000;
     end if;   
     if v_desctot>0 then
        let v_ctaapldi=v_ctaapli;
        let v_desctot= v_desctot* -1;
     end if;   
     if v_desctotre>0 then
        let v_ctaapldr=390300000;
        let v_desctotre= v_desctotre* -1;
     end if;   
  return 'D',v_clave,vpar_axo,vpar_impte, v_desctot, v_ctaapli, vpar_recar, v_desctotre,v_ctaaplr, v_obs with resume; 

end foreach;
end procedure;

CREATE PROCEDURE "saranda".spd_adeudoind(var_control int,v_usu int, var_axo int)
                            returning  integer, 
                                      money(15,2),
                                     money(15,2);


define v_uap    integer;
define v_axo    integer;
define v_mes   smallint;
define v_metros decimal(5,3);
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_cem char(1);
define v_sum   smallint;
DEFINE vparperiodo INT;

create temp table ta_adercm1(
axo        smallint,
importe  money(15, 2),
recargos money(15, 2))   with no log;

 let v_axo=year(today);
let v_mes=month(today); 
let v_sum=0;
let v_uap=var_axo;
select  metros,cementerio into v_metros,v_cem from ta_13_datosrcm where control_rcm=var_control;

if v_uap<2008 then
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),
         ((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota = v_uap;
end if;
if v_uap>2007 then
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota=v_uap;
end if;
foreach
  select  axo,importe ,recargos   into vpar_axo,vpar_impte, vpar_recar  from ta_adercm1
return   vpar_axo,vpar_impte, vpar_recar with resume;
  insert into ta_13_adeudosrcm values( 0,var_control,vpar_axo,vpar_impte, vpar_recar,0,0,'V',v_usu,today,null);
 end foreach;  

drop table ta_adercm1;

end procedure;

create procedure  "saranda".spd_13_presupcem(p_axo integer)
  returning 
    INT as poliza,
    VARCHAR(255) as mensaje;



 define    cgo_mayor CHAR(4) ;
 define    cgo_sub01 CHAR(2) ;
 define    cgo_sub02 CHAR(4) ;
 define    cgo_sub03 CHAR(5) ;
 define    cgo_sub04 CHAR(5) ;
 define    abo_mayor CHAR(4) ;
 define    abo_sub01 CHAR(2) ;
 define    abo_sub02 CHAR(4) ;
 define    abo_sub03 CHAR(5) ;
 define    abo_sub04 CHAR(5) ;
define     v_ctaaplica int;
define     v_cem    char(1);
define     v_desc   char(20);
define     v_numero int;
define     v_idpoliza int;
define     v_impuesto money(16,2);
define     v_control integer;
define     v_tot_impuesto money(16,2);
define     v_cargo  money(16,2);
define    v_abono money(16,2);
define    mensaje char(100);
define v_lError         int;
define v_lISAMError     int;
define v_vcMensaje      varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_presupcem ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION


let       v_tot_impuesto = 0;

select nvl(max(numero),0) into v_numero from cg_polizas where ejercicio = p_axo and mes = 1 and tipo =3 ;

foreach
     select c.cta_aplicacion, c.cementerio, c.nombre, 
     cta_m11 , cta_m12 , cta_m13 , cta_m14 , cta_m15 , cta_m21 , cta_m22 , cta_m23 , cta_m24 , cta_m25
     into v_ctaaplica, v_cem,v_desc,  cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,   abo_mayor,
          abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 
     from tc_13_cementerios c,ta_12_cuentasmci a
     where c.cta_aplicacion = a.cta_aplicacion and momentos = 10

    let v_numero = v_numero +1;

     insert into cg_polizas ( id_poliza , ejercicio , mes , tipo , numero , fecha ,id_modulo ,
        id_proceso, id_rec , concepto , concepto_gral, clave ,  capturo , tipo_proceso)
     values (0, p_axo, 1, 3, v_numero, today, 13,1, 9, ('PRESUP INICIAL CEMENTERIO '||v_desc||' '||p_axo),'ejecucion del proceso spd_13_presupcem', 'A', user , 'A');

    LET v_idpoliza = dbinfo("sqlca.sqlerrd1");
    let v_tot_impuesto = 0;

    FOREACH 

---  insertar cada registro por rcm al mantenimiento.
    select  a.control_rcm , b.importe into v_control ,v_impuesto
       from ta_13_datosrcm a, ta_13_adeudosrcm b 
       where a.control_rcm = b.control_rcm and a.cementerio = v_cem and a.vigencia='V' and b.axo_adeudo = p_axo and b.vigencia <>'C' 
       AND (a.fecha_alta<mdy(01,01,2012) or a.fecha_alta is null)
    insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
    values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
        v_impuesto , 0, v_control , ('Anualidad '|| p_axo) , ('Presupuesto inicial de cementerio '||v_desc||' '|| p_axo)) ;   
  
    let v_tot_impuesto = v_tot_impuesto + v_impuesto;
    end foreach;

---  inserta Global por cementerio de mantenimiento.
insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
   cta_sub04 ,  cargo, abono ,id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
  0,v_tot_impuesto , 0, ('Anualidad '||p_axo)  , ('Presupuesto inicial de cementerio '||v_desc||' '||p_axo)) ;

end foreach;

end procedure;

create procedure  "bcabrera".sp_cg_pres_mercado(p_axo integer)
  returning  INT as poliza;
define cgo_mayor CHAR(4);
define cgo_sub01 CHAR(2);
define cgo_sub02 CHAR(4);
define cgo_sub03 CHAR(5);
define cgo_sub04 CHAR(5);
define abo_mayor CHAR(4);
define abo_sub01 CHAR(2);
define abo_sub02 CHAR(4);
define abo_sub03 CHAR(5);
define abo_sub04 CHAR(5);
define v_ctaaplica int;
define v_merc,v_cat,v_cuo,v_cont int;
define v_sec char(2);
define v_superf decimal(7,2);
define v_numero int;
define v_idpoliza int;
define v_renta money(16,2);
define v_adeudo money(16,2);
define v_pagos money(16,2);
define v_idlocal integer;
define v_tot_renta money(16,2);
define v_cargo  money(16,2);
define v_abono money(16,2);
define mensaje char(100);

let v_tot_renta = 0;
let v_ctaaplica = 0;

-- extrae el numero mayor   
select nvl(max(numero),0) into v_numero from cg_polizas where ejercicio=p_axo and mes=1 and tipo=3;

let v_numero=v_numero+1;

-- inserta la poliza
insert into cg_polizas ( id_poliza,ejercicio,mes,tipo,numero,fecha,id_modulo,
    id_proceso,id_rec,concepto,concepto_gral,clave,capturo,tipo_proceso)
values (0, p_axo, 1, 3, v_numero, today,11,1,9,'PRESUPUESTO INICIAL '||p_axo,
'ejecucion del proceso sp_cg_pres_mercado', 'A', user , 'A');
LET v_idpoliza = dbinfo("sqlca.sqlerrd1");

let v_tot_renta=0;
let v_renta=0;

foreach
-- toma catalogo de mercados para la cuenta de aplicacion
select nvl(a.num_mercado_nvo,0),nvl(a.cuenta_ingreso,0),cta_m11, cta_m12, cta_m13, cta_m14, cta_m15, cta_m21, cta_m22, cta_m23, cta_m24, cta_m25
into v_merc,v_ctaaplica,cgo_mayor,cgo_sub01,cgo_sub02,cgo_sub03,cgo_sub04,abo_mayor,abo_sub01,abo_sub02,abo_sub03,abo_sub04 
from ta_11_mercados a,ta_12_cuentasmci b 
where a.num_mercado_nvo<>99 and b.cta_aplicacion=a.cuenta_ingreso and momentos=10
order by a.num_mercado_nvo

  FOREACH 
  -- selecciona los adeudos del local
  select  nvl(id_local,0),nvl(categoria,0),seccion,nvl(clave_cuota,0),nvl(superficie,0) 
  into v_idlocal,v_cat,v_sec,v_cuo,v_superf
  from ta_11_locales  
  where num_mercado=v_merc and vigencia ='A'  

  let v_renta=0;
  let v_adeudo=0;
  if v_merc<> 214 then
     execute procedure spd_11_calc_renta(p_axo,v_cat,v_sec,v_cuo,v_superf,v_merc,0) into v_adeudo;
     let v_renta=v_adeudo*12;
  else
     for v_cont= 1 to 4
         execute procedure spd_11_calc_renta(p_axo,v_cat,v_sec,v_cuo,v_superf,v_merc,v_cont) into v_adeudo;
         let v_renta=v_renta+v_adeudo;
     end for;
  end if;

  ---  insertar cada registro por local de renta 
  insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
  values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
   v_renta , 0, v_idlocal , '1 al 12 del '|| p_axo , 'Presupuesto inicial de mercados '|| p_axo ) ;
   
  let v_tot_renta = v_tot_renta + v_renta;
  END FOREACH;

end foreach;

-- inserta el total de todos los locales
insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono ,id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
   0,v_tot_renta , 0, 'Del 1 al 12 del '||p_axo  , 'Presupuesto inicial de mercados '||p_axo) ;

return v_idpoliza;
end procedure
;

create procedure "informix".operkiosco2(p_fecha date , p_kiosco char(2)) 
    RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_fechatime datetime year to fraction(3) ;
   begin
    on exception in (-958)
       delete from tmp_operkiosco;
    end exception;
    create temp table tmp_operkiosco
       (id_modulo integer,
        descripcion       char(140),
        operaciones      integer,
        importe     money(16,2)  ,
        fecha  datetime year to fraction(3) ) with no log;
   end


 begin
    on exception in (-243)
    return 0 , 'EN USO' ,0 , 0, current ; 
    end exception;
 insert into tmp_operkiosco
    select  r.id_modulo , d.descripcion  ,count(*), sum(r.importe) , CURRENT year to fraction(3) 
     from ta_12_recibos r , ta_12_moduloscat d 
    where r.fecha = p_fecha and r.caja = p_kiosco
    and r.id_modulo <> 12  and r.id_rec <> 9 and r.cvepago = 'P' and d.id_modulo = r.id_modulo
    group by 1,2;
   
   insert into tmp_operkiosco
    select (r.id_modulo *1000) + r.id_regmodulo ,d.descripcion   , count(*), sum(importe) , CURRENT year to fraction(3) 
      from ta_12_recibos r , outer ta_12_moduloscat d 
   where r.fecha = p_fecha and r.caja = p_kiosco
   and r.id_modulo = 12 and r.id_rec <> 9 and r.cvepago = 'P'  and d.id_modulo = (r.id_modulo *1000) + r.id_regmodulo
    group by 1,2 ;
   foreach 
    select id_modulo ,  descripcion ,   operaciones   ,   importe    ,   fecha
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
   from tmp_operkiosco order by 4
    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach
 end
 
end procedure;

CREATE PROCEDURE "saranda".spd_12_estadcobro(
    		parAxod	   date, parAxoh date)
	               	returning     --smallint,
            date as fecha,
	 		char(30) as descripcion,
	 		integer as recibos,
		 	money(15,2) as importe;

 define vparfec  		date;
 define vparrec  		smallint;
 define vpardesc 	               char(30);
 define vparCuenta 		integer;
  define vparImporte 	money(15,2);
define v_total 	money(15,2);
define v_recibo 	int;

let v_total=0;
let v_recibo=0;

foreach
      SELECT a.fecing,--b.descrip,
             count(*), sum(a.totcertificado)
      into    vparfec,--vpardesc,
             vparCuenta, vparImporte
      from          cg_12_ingreso a , outer ta_12_tiporecibo b
     where      a.fecing between parAxod and parAxoh  and tipo_rbo=tipo
     group by   1
     order by 1
     let v_total=v_total+vparImporte;
     let v_recibo=v_recibo+vparCuenta;

return   	vparfec,' Dia '||day(vparfec),vparCuenta,vparImporte
with resume;
end foreach;
return   	null,'Total ',v_recibo,v_total;

end procedure;

create procedure "saranda".operkiosco3(p_fecha date ,p_fechas date, p_kiosco char(2)) 
    RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_fechatime datetime year to fraction(3) ;
   begin
    on exception in (-958)
       delete from tmp_operkiosco;
    end exception;
    create temp table tmp_operkiosco
       (id_modulo integer,
        descripcion       char(140),
        operaciones      integer,
        importe     money(16,2)  ,
        fecha  datetime year to fraction(3) ) with no log;
   end


 begin
    on exception in (-243)
    return 0 , 'EN USO' ,0 , 0, current ; 
    end exception;
 insert into tmp_operkiosco
    select  r.id_modulo , d.descripcion  ,count(*), sum(r.importe) , CURRENT year to fraction(3) 
     from ta_12_recibos r , ta_12_moduloscat d 
    where r.fecha between  p_fecha and p_fechas and r.caja = p_kiosco
    and r.id_modulo <> 12  and r.id_rec <> 9 and r.cvepago = 'P' and d.id_modulo = r.id_modulo
    group by 1,2;
   
   insert into tmp_operkiosco
    select (r.id_modulo *1000) + r.id_regmodulo ,d.descripcion   , count(*), sum(importe) , CURRENT year to fraction(3) 
      from ta_12_recibos r , outer ta_12_moduloscat d 
   where r.fecha between p_fecha and p_fechas and r.caja = p_kiosco
   and r.id_modulo = 12 and r.id_rec <> 9 and r.cvepago = 'P'  and d.id_modulo = (r.id_modulo *1000) + r.id_regmodulo
    group by 1,2 ;
   foreach 
    select id_modulo ,  descripcion ,   operaciones   ,   importe    ,   fecha
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
   from tmp_operkiosco order by 4
    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach
 end
 
end procedure;

CREATE PROCEDURE "bcabrera".spd_11_mercgral(p_axo int, p_mes int)	

returning  	integer as mercado,
            varchar(30) as nombre,
            money(15,2) as arrendamiento,
            money(15,2) as recargos,
            money(15,2) as multa,
            money(15,2) as gastos,
            integer as vigentes,
            integer as bajas,
            integer as adeudo,
            integer as pagados,
            integer as procedimientos,
            integer as procedimientospagados;

define v_cuenta integer;
define v_ctarezago integer;
define v_merc smallint;
define v_perdsd integer;
define v_perhst integer;
define v_id_local,v_id integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_adeudo,v_adetot money(15,2);
define v_recargos,v_rectot money(15,2);
define v_multa,v_multot money(15,2);
define v_gastos,v_gastot money(15,2);
define v_descuento money(15,2);
define v_folio integer;
define v_per smallint;
define v_aid_local integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc,v_vig,v_baj,v_ade,v_ademer,v_pagtot,v_req,v_reqtot,v_rpagtot,v_rpag integer;
define v_total money(15,2);
define v_redon money(3,2);
define v_nombre varchar(30);
define v_vigencia char(1);
 
let v_id_local=0; let v_mesdsd=0; let v_axodsd=0; let v_meshst=0;
let v_axohst=0; let v_adeudo=0; let v_recargos=0; let v_multa=0;
let v_gastot=0; let v_adetot=0; let v_rectot=0; let v_multot=0;
let v_gastos=0; let v_recargos=0; let v_contador=0; let v_locales=0;
let v_folio=0; let v_descuento=0; let v_adeacum=0; let v_primermes=0;
let v_impcalc=0; let v_total=0; let v_perdsd=0; let v_perhst=0;
let v_vig=0; let v_baj=0; let v_ade=0; let v_ademer=0; let v_pagtot=0; 
let v_req=0; let v_reqtot=0; let v_rpagtot=0; let v_rpag=0;
 
-- obtiene los datos generales
foreach
select num_mercado_nvo,descripcion into v_merc,v_nombre
from ta_11_mercados where num_mercado_nvo not in (99,214)
order by num_mercado_nvo
let v_gastot=0; let v_adetot=0; let v_rectot=0; let v_multot=0;
let v_vig=0; let v_baj=0; let v_pagtot=0; let v_ademer=0; 
let v_adeudo=0; let v_recargos=0; let v_reqtot=0; let v_rpagtot=0;
    foreach
    select nvl(id_local,0),vigencia into v_id_local,v_vigencia
    from   ta_11_locales 
    where num_mercado=v_merc
    if  v_vigencia='A' then
        let v_vig=v_vig+1;
    else
        let v_baj=v_baj+1;
    end if;

    let v_per=0;
    let v_porc=0;
    let v_recacum=0; 

    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

    -- para sacar el mes minimo       
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

    let v_multa=0; let v_gastos=0;

    -- para obtener los datos de multa y gastos
    select nvl(max(importe_multa),0),nvl(sum(importe_gastos),0),nvl(count(a.folio),0)  
    into v_multa,v_gastos,v_folio
    from    ta_15_apremios a  
    where modulo=11 and control_otr=v_id_local and vigencia='1' and clave_practicado='P';

    let v_multot=v_multot+v_multa;
    let v_gastot=v_gastot+v_gastos;

    -- para obtener los datos de requerimientos del 2010 - 2012 emitidos
    select nvl(count(folio),0) into v_req
    from    ta_15_apremios a  
    where modulo=11 and control_otr=v_id_local 
    and (fecha_emision between mdy(1,1,2010) and today);
    let v_reqtot=v_reqtot+v_req;

    -- para obtener los datos de requerimientos del 2010 - 2012 pagados
    select nvl(count(folio),0) into v_rpag
    from    ta_15_apremios a  
    where modulo=11 and control_otr=v_id_local and vigencia='2' 
    and (fecha_emision between mdy(1,1,2010) and today);
    let v_rpagtot=v_rpagtot+v_rpag;

    -- verifica cuantos locales tienen adeudo y al corriente de pagos
    select nvl(count(id_local),0) into v_ade from ta_11_adeudo_local 
    where id_local=v_id_local
    and ((axo=p_axo and periodo<=p_mes) or (axo<p_axo));
    if v_ade=0 then
       let v_pagtot=v_pagtot+1;
    else
       let v_ademer=v_ademer+1;
    end if;
       
    -- todos los adeudos hasta periodo de entrada
    foreach
    select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
    into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
    from    ta_11_adeudo_local a,ta_11_fecha_desc b 
    where id_local=v_id_local
    and ((a.axo=p_axo and a.periodo<=p_mes) or (a.axo<p_axo)) 
    and b.mes=month(today)
    order by axo,periodo

    let v_impcalc=v_aimporte;
  
    if v_mesdsd=0 then
       let v_mesdsd=v_aperiodo;
    end if;
  
    if v_axodsd=0 then
       let v_axodsd=v_aaxo;
    end if; 

    let v_meshst=v_aperiodo;
    let v_axohst=v_aaxo;  

    -- obtiene el porcentaje de recargos
    if v_merc <>214 then 	
       if today>=v_fecha_rec then
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
       end if;
    else 
       if v_aperiodo=1 then let v_primermes=1;
       else if v_aperiodo=2 then let v_primermes=4;
       else if v_aperiodo=3 then let v_primermes=7;
       else if v_aperiodo=4 then let v_primermes=10;
       else let v_primermes=0;
       end if;
       end if;
       end if;
       end if;

       if v_primermes=month(today) then
          if today>=v_fecha_rec then
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
          else
             select sum(porcentaje_mes) into v_porc from ta_12_recargos
             where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                     (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
          end if;
       else
          select sum(porcentaje_mes) into v_porc from ta_12_recargos
          where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
       end if;
    end if;

    if  v_porc is null then
        let v_porc=0;
    end if;

    if  v_folio = 0 then
        if v_porc > 100 then
           let v_recacum=trunc(v_impcalc*100)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    else
        if v_porc > 250 then
           let v_recacum=trunc(v_impcalc*250)/100;
        else
           let v_recacum=trunc(v_impcalc*v_porc)/100;
        end if;
    end if;

    let v_recargos=v_recargos+v_recacum;
	
    if v_merc<>214 then
       if v_aaxo=year(today) and v_aperiodo=month(today) then
          if today>v_fecha_desc then
             let v_adeacum=v_aimporte;
          else
             let v_adeacum=v_aimporte-(v_aimporte*.10);
             let v_descuento=v_aimporte*.10;
          end if;
       else
          let v_adeacum=v_aimporte;
       end if;
    else
       let v_adeacum=v_impcalc;
       let v_descuento=v_descuento+(v_aimporte-v_impcalc);
    end if;

    let v_adeudo=v_adeudo+v_adeacum;

    end foreach;
    let v_rectot=v_recargos;
    let v_adetot=v_adeudo;

    end foreach;

return v_merc,v_nombre,v_adetot,v_rectot,v_multot,v_gastot,v_vig,v_baj,v_ademer,
v_pagtot,v_reqtot,v_rpagtot with resume;
end foreach;

end procedure;

CREATE PROCEDURE "saranda".spd_13_abcpago(v_control int,v_fecpago date, v_rec int, v_caja char(2), v_oper int, v_axod int,
                                 v_axoh int,v_importe money(15,2), v_id int, v_usu int, v_opc int)
                returning smallint as par_ok, varchar(255)as par_observ;  
define      Vcontrol_des    int;
define      Vcontrol_rcm	INTEGER;
define      Vaxo_alta   	INTEGER;
define      Vdecuento   	INTEGER;
define      Vusuario    	INTEGER;
define      Vfecha_mov  	DATE;
define      Vaxo_ini    	INTEGER;
define      vini    	INTEGER;
define      vreac    	char(1);
define      vcementerio char(1);
define      vclase      INTEGER;
define      vclase_alfa varchar(10);
define      vseccion        INTEGER;    
define      vseccion_alfa   varchar(20);
define      vlinea          INTEGER;    
define      vlinea_alfa     varchar(20);
define      vfosa           INTEGER;
define      vfosa_alfa      varchar(20);
define      vcvepago           INTEGER;
define      vuap           INTEGER;
define      vuapact           INTEGER;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_abcpago ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION


let vuapact=(year(today) - 6);
let vuap=0;
 
if v_opc=1 then


SELECT cementerio, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa
into vcementerio, vclase, vclase_alfa, vseccion, vseccion_alfa, vlinea, vlinea_alfa, vfosa, vfosa_alfa
    FROM informix.ta_13_datosrcm where control_rcm=v_control;


insert into ta_13_pagosrcm values(v_Fecpago,v_Rec,v_Caja,v_Oper,0,v_control,
vcementerio, vclase, vclase_alfa, vseccion, vseccion_alfa, vlinea, vlinea_alfa, vfosa, vfosa_alfa,
v_axod,v_axoh,v_importe,0,"A",v_usu,today);

   let vcvepago=dbinfo("sqlca.sqlerrd1");

  update ta_13_adeudosrcm  set vigencia='P',id_pago=vcvepago 
    where control_rcm=v_control and axo_adeudo between v_axod and v_axoh;

 select nvl(max(axo_pago_hasta),0) 
 into vuap
 from ta_13_pagosrcm where control_rcm=v_control and vigencia='A';

if vuap=0 then
   let vuap=vuapact;
end if;

   update ta_13_datosrcm set axo_pagado=vuap where control_rcm=v_control;

   update ta_13_adeudosrcm set vigencia='B', fecha_mov=today,usuario=v_usu 
    where control_rcm=v_control and axo_adeudo<vuap and vigencia='V';

   return 1,'Se ha dado de alta pago';

end if;

if v_opc=2 then
--  select control_id into vcvepago from ta_13_pagosrcm 
--    where control_rcm=v_control and fecing=v_fecpago and recing=v_rec and cajing=v_caja and opcaja=v_oper and vigencia='A';

  update ta_13_pagosrcm set vigencia='C', fecha_mov=today, usuario=v_usu
  where control_id=v_id; 

  update ta_13_adeudosrcm  set vigencia='V',id_pago=0 where control_rcm=v_control and id_pago=v_id;
 select nvl(max(axo_pago_hasta),0) 
 into vuap
 from ta_13_pagosrcm where control_rcm=v_control and vigencia='A';
if vuap=0 then
   let vuap=vuapact;
end if;
   update ta_13_datosrcm set axo_pagado=vuap where control_rcm=v_control;
    
     update ta_13_adeudosrcm set vigencia='V', fecha_mov=today,usuario=v_usu 
    where control_rcm=v_control and axo_adeudo>vuap and vigencia='B';


   return 1,'Se ha dado de baja ';
end if;
end procedure;

CREATE PROCEDURE "saranda".spd_13_datostot(var_control integer, var_axo int)
                 returning  char(1) as slinea, int as sclave, 
                 money(15,2) as stotal,  int as sctaapli,varchar(60)as sobserv;

define v_uap    integer;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_concepto varchar(250);
define  v_nomcem VARCHAR(60);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define  v_totim money(15,2);
define  v_totre money(15,2);
define  v_totimac money(15,2);
define  v_totreac money(15,2);

define v_cuenta integer;
define v_ctaapli integer;
define v_ctaapla integer;
define v_ctaaplr integer;
define v_ctadescto integer;
define v_ajuste money(15,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);



let v_axo=year(today);
let v_mes=month(today);
--let v_mes=2;
let v_imptot=0;
let v_concepto = '';
let v_periodo='';
let v_desctot = 0;
let v_desctotre = 0;

let  v_totim=0;
let  v_totre=0;
let  v_totimac=0;
let  v_totreac=0;

select control_rcm, cementerio,axo_pagado
into v_control, v_cementerio,v_axo_pagado
from ta_13_datosrcm where control_rcm=var_control;

select  nombre, cta_aplicacion, cta_vencido, cta_descto
into v_nomcem,v_ctaapl1,v_ctaapl2, v_ctadescto 
from tc_13_cementerios where cementerio=v_cementerio;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   let v_clave = 1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   return 'T',v_clave,0,0,v_texto; 
end if;      
if v_axo_pagado=v_axo  then
   let v_clave = 2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   return 'T',v_clave,0,0,v_texto; 
end if;     
if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;
let v_clave = 0; 

---Para calcular el importe total
foreach 
select b.axo_adeudo, case when b.axo_adeudo =year(today) then v_ctaapl1 
        else v_ctaapl2 end,b.importe, b.importe_recargos, nvl((b.descto_impote),0),nvl((b.descto_recargos),0)
        into vpar_axo,v_cuenta, vpar_impte, vpar_recar,v_impdesc,v_recardesc 	
        from ta_13_adeudosrcm b, ta_13_datosrcm r where r.control_rcm=v_control and
             b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and var_axo and b.vigencia='V'  
        order by 1

     if ((v_mes >= 1)  and (v_mes <=2) and (v_cuenta=v_ctaapl1)) then
        if v_impdesc=0 then
           let v_impdesc  = trunc(((vpar_impte) * 10/100),2);
        end if;
     end if;
     
     if vpar_axo<v_axo then
        let v_totim = (v_totim + vpar_impte); 
        let v_totre = (v_totre + vpar_recar); 
        let v_desctot = (v_desctot + v_impdesc); 
        let v_desctotre = (v_desctotre + v_recardesc); 
        let v_ctaapli=v_cuenta;
     else   
        let v_totimac = (v_totimac + vpar_impte); 
        let v_totreac = (v_totreac + vpar_recar); 
        let v_desctot = (v_desctot + v_impdesc); 
        let v_desctotre = (v_desctotre + v_recardesc); 
        let v_ctaapla=v_cuenta;
     end if;
  if vpar_axo=var_axo then
     if v_totim>0 then
        let v_obs = 'Mantenimiento Rezago '||v_nomcem;
        let v_imptot = v_imptot+v_totim; 
        return 'T',v_clave, v_totim,v_ctaapli, v_obs with resume; 
     end if;   
     
    if v_totre>0 then
       let v_ctaaplr=390300000;
       let v_obs = 'Recargos Rezago ';
       let v_imptot = v_imptot+v_totre; 
       return 'T',v_clave, v_totre,v_ctaaplr, v_obs with resume; 
    end if;   

    if v_totimac>0 then
       let v_obs = 'Mantenimiento '||v_nomcem;
       let v_imptot = v_imptot+v_totimac; 
       return 'T',v_clave, vpar_impte, v_ctaapla, v_obs with resume;    
    end if;

    if v_totreac>0 then
       let v_ctaaplr=390300000;
       let v_obs = 'Recargos ';
       let v_imptot = v_imptot+v_totreac; 
      return 'T',v_clave, v_totreac,v_ctaaplr, v_obs with resume; 
    end if; 
    if v_desctot>0 then
       let v_ctaaplr=v_ctadescto;
       let v_obs = 'Descto Imp ';
       let v_imptot = v_imptot-v_desctot; 
      return 'T',v_clave, (v_desctot*-1),v_ctaaplr, v_obs with resume; 
    end if; 
    if v_desctotre>0 then
       let v_ctaaplr=v_ctadescto;
       let v_obs = 'Descto Rec ';
       let v_imptot = v_imptot-v_desctotre; 
      return 'T',v_clave, (v_desctotre*-1),v_ctaaplr, v_obs with resume; 
    end if; 
 end if; 
end foreach;

  

    execute procedure catastro_gdl:redondeocaja(v_imptot) into v_imptot, v_ajuste; 
     if v_ajuste <> 0 then    
        return 'T',v_clave, v_ajuste, 550800000,'AJUSTE ARTICULO 14 LEY DE INGRESOS '; 
     end if;
end procedure;

create procedure "saranda".spd_ajustadif(par_fecha date, par_rec int, par_caja char(2))
returning varchar(100,0) as cuantas;

define vfecha    date;
define vfecbco    date;
define vrec     int;
define vcaja    char(2);
define voper    int;
define vdifer   money(6,2);
define vlinea    int;
define vcuantosr  int;
define vcuantos int;

let vcuantos=0;
let vcuantosr=0;


foreach
SELECT fecha, id_rec, caja, operacion, (importe- (select sum(importe) from ta_12_recibosdet where fecha=ta_12_recibos.fecha
and id_rec=ta_12_recibos.id_rec and caja=ta_12_recibos.caja and operacion=ta_12_recibos.operacion)),
(select max(linea) from ta_12_recibosdet where fecha=ta_12_recibos.fecha
and id_rec=ta_12_recibos.id_rec and caja=ta_12_recibos.caja and operacion=ta_12_recibos.operacion),fec_pagobco
into vfecha, vrec, vcaja,voper,vdifer,vlinea,vfecbco  
    FROM informix.ta_12_recibos
where fecha=par_fecha and id_rec=par_rec and caja=par_caja
if (((vdifer< 1) and (vdifer> - 1) and (vdifer<>0)) and month(vfecbco)<3 ) then
    update ta_12_recibosdet set importe=importe+(vdifer) 
      where fecha=vfecha and id_rec=vrec and caja=vcaja and operacion=voper and cuenta=992100014;
   let vcuantosr=vcuantosr+1; 
end if;

if (vdifer<-.06)then
    INSERT INTO ta_12_recibosdet(fecha, id_rec, caja, operacion, linea, descripcion, cuenta, importe) 
    VALUES(vfecha, vrec, vcaja, voper, (vlinea+1), 'Diferencia Rec', 150100000, vdifer);
          let vcuantos=vcuantos+1; 
   let vcuantosr=vcuantosr+1; 
end if;

if (((vdifer< 1) and (vdifer> - 1) and (vdifer<>0)) and month(vfecbco)>2 )then
    INSERT INTO ta_12_recibosdet(fecha, id_rec, caja, operacion, linea, descripcion, cuenta, importe) 
    VALUES(vfecha, vrec, vcaja, voper, (vlinea+1), '', 550800000, vdifer);
          let vcuantos=vcuantos+1; 
   let vcuantosr=vcuantosr+1; 
end if;
end foreach;
return (vcuantos||' recargos '||vcuantosr);
end procedure;

CREATE PROCEDURE "pgmoreno".con16_detade_03 ( p_Control_contrato Integer, p_Fecha_fin Char(7))
	returning Money(12,2),    -- Importe Adeudos2005
                               Money(12,2),    -- Importe Recargos2005
                               Money(12,2),    -- Importe Adeudos2006
                               Money(12,2),    -- Importe Recargos2006
                               Money(12,2),    -- Importe Multa
                               Money(12,2),    -- Importe Gastos
		varchar(255);    -- Documentos
               

{
#  Procedimiento: Con16_detade_03
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#  		          p_Rep : Tipo de reporte a obtener
#  		          p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#  		          p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Importe : El importe de los Adeudos2005 y anteriores
#  		         Importe : El importe de los Recargos2005 y anteriores
#  		         Importe : El importe de los Adeudos2006 y posteriores
#  		         Importe : El importe de los Recargos2006 y posteriores
#  		         Importe : El importe de la Multa
#  		         Importe : El importe de los Gastos
#  		         Concepto : Documentacion turnada por este contrato
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador								Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq					Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos				Money(12,2);
  define v_DetFolReq							varchar(120);
  define v_diligencia								char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago             						Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2			Money(12,2);
  define v_totAdeudos2005, v_TotRecargos2005, v_totAdeudos2006, v_TotRecargos2006	Money(12,2);
  define v_Mes								varchar(2);

  define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato				Integer;
  define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato			varchar(120);

       define v_Importe_recargo, v_TotRecargos, v_Reg_1				Money(12,2);
       define v_mensaje_proc							varchar(255);
--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy					varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade   varchar(7);
  define v_Periodo								varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo					Integer;
--****************************************************************************************************************************** 
   Let v_Contador = 0;
   
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_rec1 = 0;
   Let v_importe_rec2 = 0;
   Let v_axo = 0;
	Let v_Lineas_Dato = 0;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;


                Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
                foreach
                     Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
		else
		   Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
		end if;
                end foreach;
                       if v_FolReq > 0 then
		--return v_DetFolReq, Null, Null, v_importe_multa, v_tot_gastos  with resume;
                                Let v_Contador = v_Contador + 1;
                       end if;

	Let v_Lineas_Dato = 0;
	Let v_Detalle_Dato = '';
		Select ('Descuento de Recargos en periodo(s) del ' || axoinicio || '-' || mesinicio || 
        			' al ' || axofin || '-' || mesfin || ' por el ' || porcentaje || ' %'), 
			(axoinicio || '-' || mesinicio), axofin || '-' || mesfin, porcentaje
			INTO v_Detalle_Dato, v_Periodo_Inicio, v_Periodo_fin, v_porc
			from ta_16_descrec
			Where id_contrato = p_Control_contrato and vigencia = 'V';

 		if v_Detalle_Dato <> '' then
		   Let v_Lineas_Dato = v_Lineas_Dato + 1;
 		end if;

  LET v_totAdeudos2005 = 0;
  LET v_totAdeudos2006 = 0;
  LET v_TotRecargos2005 = 0;
  LET v_TotRecargos2006 = 0;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to aso_actual 

	-------------------------------------CONSULTA DE CUOTA NORMAL
		Let v_Lineas_CN = 0;
  		Let v_Detalle_CN = ' C.N. Mes(s) --';

                	foreach
    			Select Year(h.aso_mes_pago), h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago)
        		    		Into v_axo, v_aso_mes_pago, v_importe, v_Mes 
     				From ta_16_pagos H
     				Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
          		     		and H.aso_mes_pago <= ( p_Fecha_fin )
          		     		and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
				Order By h.aso_mes_pago

                                                 if v_aso_mes_pago > ( p_Fecha_fin ) then
                                                    Let v_importe = 0;
                                                 else
				Select sum(porc_recargo) 
   			    	Into v_Importe_recargo
                                                    	From ta_16_recargos 
                                                           	Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);
                                                 end if;
  		if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
		          Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
		          Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_CN = v_Lineas_CN + 1;
  		    if v_Importe_recargo <> 0 then
     		       Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                       if v_importe_rec2 > 0 then
     		          Let v_TotRecargos = v_TotRecargos + v_importe_rec2;
                                          Let v_Lineas_Dato = v_Lineas_Dato + 1;
                                       else
     		          Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
                                       end if;
  		    end if;
                                    Let v_Contador = v_Contador + 1;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;
                	end foreach;

	-------------------------------------CONSULTA DE EXEDENCIAS
  		Let v_Lineas_EX = 0;
  		Let v_Detalle_EX = ' EXE. Mes(s) --';

                	foreach
    		Select h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago)
        		    Into v_aso_mes_pago, v_importe, v_Mes 
     		From ta_16_pagos H
     		Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
          		     and H.aso_mes_pago <= ( p_Fecha_fin )
          		     and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
		Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

  		if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
		          Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
		          Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  		    end if;
  		    Let v_totAdeudos = v_totAdeudos + v_importe;
		    Let v_Lineas_EX = v_Lineas_EX + 1;
  		    if v_Importe_recargo <> 0 then
     		       Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                       if v_importe_rec2 > 0 then
     		          Let v_TotRecargos = v_TotRecargos + v_importe_rec2;
                                          Let v_Lineas_Dato = v_Lineas_Dato + 1;
                                       else
     		          Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
                                       end if;
  		    end if;
                                    Let v_Contador = v_Contador + 1;
  		end if;

   		Let v_importe = 0;
   		Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;
                	end foreach;

--     Grabando registro
   IF aso_proceso < 2007 THEN
       LET v_totAdeudos2005 = v_totAdeudos2005 + v_totAdeudos;
       LET v_TotRecargos2005 = v_TotRecargos2005 + v_TotRecargos;
   ELSE
       LET v_totAdeudos2006 = v_totAdeudos2006 + v_totAdeudos;
       LET v_TotRecargos2006 = v_TotRecargos2006 + v_TotRecargos;
   END IF;


   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;

  END FOR;

   if v_Contador = 0 then
       return Null, Null, Null, Null, Null, Null, Null;
   else
       return v_totAdeudos2005, v_TotRecargos2005, v_totAdeudos2006, v_TotRecargos2006, v_importe_multa, v_tot_gastos, v_DetFolReq;
   end if;

end procedure;

CREATE PROCEDURE "pgmoreno".con16_detcont_01 ( p_Ctrol_aseo Integer, p_Adeudos Char(1), p_Fecha_fin Char(7))
    RETURNING CHAR(2),      	-- RECAUDADORA
              VARCHAR(20),  	-- TIPO DE ASEO
              INTEGER,      	-- NUMERO DE CONTRATO
              VARCHAR(200), 	-- A NOMBRE DE QUIEN ESTA EL CONTRATO
              VARCHAR(200), 	-- DOMICILIO
              CHAR(2),      	-- VIGENCIA   HASTA AQUI DATOS DEL CONTRATO

              Money(12,2),    	-- ADEUDOS 2006 Y ANTERIORES
              Money(12,2),    	-- RECARGOS
              Money(12,2),    	-- ADEUDOS 2007 Y POSTERIORES
              Money(12,2),    	-- RECARGOS  HASTA AQUI DATOS DE ADEUDOS
              Money(12,2),    	-- TOTAL DE GASTOS
              Money(12,2),    	-- TOTAL DE MULTAS

              varchar(255);    	-- DATOS DE REQUERIMIENTOS

{
#  Procedimiento: Con16_F4DetCont
#  Descripcion:  Genera una consulta del Contrato con control de importe
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#                                        p_Control_adeudo : solo imprime si existe contrato
#  Parametros de salida:   todos los datos del contrato
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec	Integer;
  define v_nombre, v_domicilio	, v_tipo_aseo					varchar(80);
  define v_tipo_recolec							varchar(20);
  define v_sector, v_status_vigencia						Char(1);
  define v_fecha_ini, v_fecha_hora_baja						Date;

  define v_importe_multa, v_importe_gastos, v_tot_gastos					Money(12,2);
  define v_totAdeudos2006, v_TotRecargos2006, v_totAdeudos2007, v_TotRecargos2007	Money(12,2);
  define v_Datos									varchar(120);


----------------------
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2006 = 0;
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2006 = 0;
LET v_TotRecargos2007 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;

FOREACH
       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, 
                  a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja, a.status_vigencia
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, 
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja, v_status_vigencia
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.ctrol_aseo = p_Ctrol_aseo
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec
       Order by a.num_contrato
       
     FOREACH
	EXECUTE PROCEDURE con16_detade_03 ( v_Control, p_Fecha_fin) 
		INTO v_totAdeudos2006, v_TotRecargos2006, v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, v_Datos
     END FOREACH;
-- 'S'=CON ADEUDO,             'N'=SIN ADEUDO,          'T'=TODOS
  IF p_Adeudos = 'S' THEN
      IF ( v_totAdeudos2006 <> 0 ) OR ( v_TotRecargos2006 <> 0 ) OR 
	( v_totAdeudos2007 <> 0 ) OR ( v_TotRecargos2007 <> 0 ) OR
	( v_importe_multa <> 0 ) OR ( v_tot_gastos <> 0 ) THEN
           	RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2006, v_TotRecargos2006, v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, v_Datos  with resume;
      END IF;
  END IF;

  IF p_Adeudos = 'N' THEN
      IF ( v_totAdeudos2006 = 0 ) AND ( v_TotRecargos2006 = 0 ) AND 
	( v_totAdeudos2007 = 0 ) AND ( v_TotRecargos2007 = 0 ) AND
	( v_importe_multa = 0 ) AND ( v_tot_gastos = 0 ) THEN
           	RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2006, v_TotRecargos2006, v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, v_Datos  with resume;
      END IF;
  END IF;

  IF p_Adeudos = 'T' THEN
     if v_Datos <> 'Docto(s) Requerido(s) : ' then
           	RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2006, v_TotRecargos2006, v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, v_Datos  with resume;
     else
           	RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2006, v_TotRecargos2006, v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, Null  with resume;
     end if;
  END IF;

Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2006 = 0;
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2006 = 0;
LET v_TotRecargos2007 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;

END FOREACH;

end procedure;

CREATE PROCEDURE "informix".e_parkingconstest(parPlaca char(7), parMedio int)
				
	 returning smallint , smallint,  char(7) ,      int , date ,  smallint , Char(40) , money(7,2), smallint ,  money(7,2),        int ,            int ,                         char(100)  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define infra_descrip char(40);
set debug file to "parkivan.log";
trace on;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then


foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
, infra.descripcion
into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b , ta14_infraccion infra, outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and infra.num_clave = a.infraccion and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A' 
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;

--select count(*) 
--       into dias_habil 
--       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha+1 and today;

--     while x1 <= fecha_hoy 
--        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
--          let dias_cuantos =dias_cuantos+1;
--         end if;
--     let x1 = x1+1;
--   end while;


  if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado , infra_descrip, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,'',0,0,0,0,0,'No existen folios para esta placa';
end if;
trace off;
end procedure
;

create procedure "informix".spd_11_ademeses1(paxo int,pmes int)
returning   varchar(60) as mercado,
            smallint as vigentes,
            smallint as adeudos,
            MONEY(16,2) as arrendamiento,
            MONEY(16,2) as accesorios,
            smallint as adeudo3mas,
            MONEY(16,2) as arrendamiento3mas,
            MONEY(16,2) as accesorios3mas,
            smallint as adeudo2menos,
            MONEY(16,2) as arrendamiento2menos,
            MONEY(16,2) as accesorios2menos,
            smallint as sinadeudo;

define vmercado varchar(60);
define vvigentes smallint;
define vadeudos smallint;
define varrendamiento MONEY(16,2);
define vaccesorios MONEY(16,2);
define vadeudo3mas smallint;
define varrendamiento3mas MONEY(16,2);
define vaccesorios3mas MONEY(16,2);
define vadeudo2menos smallint;
define varrendamiento2menos MONEY(16,2);
define vaccesorios2menos MONEY(16,2);
define vsinadeudo smallint;

define v_multa,v_mul,v_mul3,v_mul2 MONEY(16,2);
define v_gastos,v_gas,v_gas3,v_gas2 MONEY(16,2);
define v_recartot,v_rec,v_rec3,v_rec2 money(16,2);
define v_nmer,v_numero smallint;
define v_mer varchar(60);          
define v_idl,v_folio,v_periodos integer;
define v_axo,v_vig smallint;
define v_adeudo,v_ade3,v_ade2 money(16,2);
define v_ida integer;
define v_ade money(16,2);
define v_aid_local,v_idt,v_idl3,v_idl2 integer;     
define v_aaxo smallint;
define v_aperiodo smallint;     
define v_aimporte money(16,2);
define v_dmes smallint;         
define v_fecha_desc date;
define v_fecha_rec date;        
define v_porc decimal(10,2);
define v_recargos money(16,2);

let vmercado='';
let vvigentes=0;
let vadeudos=0;
let varrendamiento=0;
let vaccesorios=0;
let vadeudo3mas=0;
let varrendamiento3mas=0;
let vaccesorios3mas=0;
let vadeudo2menos=0;
let varrendamiento2menos=0;
let vaccesorios2menos=0;
let vsinadeudo=0;
let v_recartot=0;
let v_multa=0;     
let v_gastos=0;
let v_porc=0;      

begin
    on exception in (-958)
       delete from tmp_ademeses;
    end exception;
create temp table tmp_ademeses(
  num_mercado smallint,
  mercado char(60),
  id_local integer NOT NULL,
  renta MONEY(16,2),
  recargos MONEY(16,2),
  multa MONEY(16,2),
  gastos MONEY(16,2),
  periodos smallint);
end;


-- totales adeudos general
foreach
select a.num_mercado,b.descripcion,id_local,
nvl(sum((select max(importe_multa) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and vigencia='1' and clave_practicado='P')),0),
nvl(sum((select sum(importe_gastos) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and vigencia='1' and clave_practicado='P')) ,0),
nvl(sum((select sum(importe) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<2012  or (periodo<=5 and axo=2012)))),0) 
into v_nmer,vmercado,v_idl,v_multa,v_gastos,v_adeudo
from ta_11_locales a,ta_11_mercados b
where b.num_mercado_nvo not in(99,214) and a.vigencia='A' 
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
group by a.num_mercado,b.descripcion,a.id_local
order by a.num_mercado,a.id_local


-- checa si tiene folios
let v_folio=0;
select nvl(count(folio),0) into v_folio
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

-- todos los periodos del a�o adeudo
let v_periodos=0;
let v_recartot=0;
if v_adeudo>0 then
   foreach
   select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos   
   into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
   from   ta_11_adeudo_local a,ta_11_fecha_desc b
   where a.id_local=v_idl
   and (a.axo<2012  or (periodo<=5 and a.axo=2012))
   and b.mes=month(today)
   order by a.axo,a.periodo
   let v_periodos=v_periodos+1;

   -- obtiene el porcentaje de recargos
   let v_porc=0;
   let v_recargos=0;
   if today>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   end if;

   if  v_porc is null then
       let v_porc=0;
   end if;

   if  v_folio = 0 then
       if v_porc > 100 then
          let v_recargos=trunc(v_aimporte*100)/100;
       else
          let v_recargos=trunc(v_aimporte*v_porc)/100;
       end if;
   else
       if v_porc > 250 then
          let v_recargos=trunc(v_aimporte*250)/100;
       else
          let v_recargos=trunc(v_aimporte*v_porc)/100;
       end if;
   end if;

   let v_recartot=v_recartot+v_recargos;
   end foreach; -- cierre de los periodos
end if;

insert into tmp_ademeses values(v_nmer,vmercado,v_idl,v_adeudo,v_recartot,v_multa,v_gastos,v_periodos);
end foreach; -- cierre de adeudos general

foreach
select num_mercado,mercado,nvl(count(*),0) into v_numero,vmercado,vvigentes
from tmp_ademeses
group by num_mercado,mercado
order by num_mercado

  select nvl(count(*),0),nvl(sum(renta),0),nvl((sum(recargos)+sum(multa)+sum(gastos)),0) 
  into vadeudos,varrendamiento,vaccesorios 
  from tmp_ademeses
  where num_mercado=v_numero and periodos>0;


  select nvl(count(*),0),nvl(sum(renta),0),nvl((sum(recargos)+sum(multa)+sum(gastos)),0) 
  into vadeudo3mas,varrendamiento3mas,vaccesorios3mas 
  from tmp_ademeses
  where num_mercado=v_numero and periodos>=3;

  select nvl(count(*),0),nvl(sum(renta),0),nvl((sum(recargos)+sum(multa)+sum(gastos)),0) 
  into vadeudo2menos,varrendamiento2menos,vaccesorios2menos 
  from tmp_ademeses
  where num_mercado=v_numero and (periodos>=1 and periodos<=2);

  select nvl(count(*),0) 
  into vsinadeudo
  from tmp_ademeses
  where num_mercado=v_numero and periodos=0;

return vmercado,vvigentes,vadeudos,varrendamiento,vaccesorios,vadeudo3mas,varrendamiento3mas,
vaccesorios3mas,vadeudo2menos,varrendamiento2menos,vaccesorios2menos,vsinadeudo
with resume;
end foreach;
end procedure;

create procedure "informix".spd_11_apremitidos(pfdsd date,pfhst date,paxo int,pmes int)

returning   varchar(60) as mercado,
            smallint as vigentes,
            smallint as localemi,
            smallint as not_emi,
            smallint as req_emi,
            MONEY(16,2) as renta_emitidos,
            MONEY(16,2) as imp_emitidos,
            smallint as local_pra,
            smallint as practicados,
            MONEY(16,2) as renta_pract,
            MONEY(16,2) as imp_practicado,
            smallint as local_pag,
            smallint as pagados,
            MONEY(16,2) as renta_pagada,
            MONEY(16,2) as imp_pagados,
            smallint as local_can,
            smallint as cancelados,
            MONEY(16,2) as renta_cancelada,
            MONEY(16,2) as imp_cancelados,
            smallint as local_vig,
            smallint as vig_emi,
            MONEY(16,2) as Arrendamiento,
            MONEY(16,2) as Accesorios,
            smallint as sinfolios;

define vmercado varchar(60);
define vvigentes smallint;
define vlocalemi smallint;
define vnot_emi smallint;
define vreq_emi smallint;
define vrenta_emitidos MONEY(16,2);
define vimp_emitidos MONEY(16,2);
define vlocal_pra smallint;
define vpracticados smallint;
define vrenta_pract MONEY(16,2);
define vimp_practicado MONEY(16,2);
define vlocal_pag smallint;
define vpagados  smallint;
define vrenta_pagada MONEY(16,2);
define vimp_pagados MONEY(16,2);
define vlocal_can smallint;
define vcancelados  smallint;
define vrenta_cancelada MONEY(16,2);
define vimp_cancelados MONEY(16,2);
define vlocal_vig smallint;
define vvig_emi smallint;
define varrendamiento MONEY(16,2);
define vaccesorios  MONEY(16,2);
define vsinfolios  smallint;

define v_multa,v_mulpr,v_mulp,v_mulv,v_mulc MONEY(16,2);
define v_gastos,v_gaspr,v_gasp,v_gasv,v_gasc MONEY(16,2);
define v_recar,v_recpr,v_recp,v_recv,v_recc MONEY(16,2);
define v_renta,v_renpr,v_renp,v_renv,v_renc MONEY(16,2);
define v_recartot,v_rec,v_rec3,v_rec2 money(16,2);
define v_nmer,v_numero,v_not,v_req,v_epra,v_epag,v_evig,v_ecan smallint;
define v_mer varchar(60);          
define v_idl,v_folio,v_periodos integer;
define v_axon,v_vig smallint;
define v_adeudo,v_ade3,v_ade2 money(16,2);
define v_ida integer;
define v_ade money(16,2);
define v_aid_local,v_idt,v_idl3,v_idl2 integer;     
define v_aaxo smallint;
define v_aperiodo smallint;     
define v_aimporte money(16,2);
define v_dmes smallint;         
define v_fecha_desc date;
define v_fecha_rec date;        
define v_porc decimal(10,2);
define v_recargos money(16,2);

let vmercado='';
let vvigentes=0;
let vlocalemi=0;
let vnot_emi=0;
let vreq_emi=0;
let vimp_emitidos=0;
let vlocal_pag=0;
let vpagados=0;
let vimp_pagados=0;
let vlocal_vig=0;
let vvigentes=0;
let varrendamiento=0;
let vaccesorios=0;
let vsinfolios=0;
let v_recartot=0;
let v_multa=0;     
let v_gastos=0;
let v_porc=0; 


begin
    on exception in (-958)
       delete from tmp_apremitidos;
    end exception;
create temp table tmp_apremitidos(
  num_mercado smallint,
  mercado char(60),
  id_local integer NOT NULL,
  renta MONEY(16,2),
  recargos MONEY(16,2),
  rentaemitidos MONEY(16,2),
  recargosemitidos MONEY(16,2),
  multa MONEY(16,2),
  gastos MONEY(16,2),
  notificaciones smallint,
  requerimientos smallint,
  practicados smallint,
  rentapracticada money(16,2),
  recargospract money(16,2),
  multapracticada money(16,2),
  gastospracticados money(16,2),
  pagados smallint,
  rentapagada money(16,2),
  recargospagados money(16,2),
  multapagada money(16,2),
  gastospagados money(16,2),
  vigentes smallint,
  rentavigente money(16,2),
  recargosvigente money(16,2),
  multavigente money(16,2),
  gastosvigentes money(16,2),
  cancelados smallint,
  rentacancelada money(16,2),
  recargoscanc money(16,2),
  multacancelada money(16,2),
  gastoscanclados money(16,2));
end;

-- todos los registros
foreach
select a.num_mercado,b.descripcion,id_local,
nvl(sum((select max(importe_global) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) )),0),
nvl(sum((select max(importe_recargo) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) )),0),
nvl(sum((select max(importe_multa) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) )),0),
nvl(sum((select sum(importe_gastos) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) )) ,0),
nvl(sum((select sum(importe) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo)))),0),
nvl(sum((select count(*) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and diligencia='N' )) ,0),
nvl(sum((select count(*) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and diligencia='R' )) ,0),
nvl(sum((select count(*) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst)  and clave_practicado='P')) ,0),
nvl(sum((select max(importe_global) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst)  and clave_practicado='P')),0), 
nvl(sum((select max(importe_recargo) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst)  and clave_practicado='P')),0),
nvl(sum((select max(importe_multa) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst)  and clave_practicado='P')),0),
nvl(sum((select sum(importe_gastos) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst)  and clave_practicado='P')) ,0),
nvl(sum((select count(*) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=2 )) ,0),
nvl(sum((select max(importe_global) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=2 )),0),
nvl(sum((select max(importe_recargo) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=2 )),0),
nvl(sum((select max(importe_multa) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=2 )),0),
nvl(sum((select sum(importe_gastos) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=2 )) ,0),
nvl(sum((select count(*) from ta_15_apremios where modulo=11 and control_otr=a.id_local
and (fecha_emision between pfdsd and pfhst) and vigencia=1 )) ,0),
nvl(sum((select max(importe_global) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=1 )),0),
nvl(sum((select max(importe_recargo) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=1 )),0), 
nvl(sum((select max(importe_multa) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=1 )),0),
nvl(sum((select sum(importe_gastos) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=1 )) ,0),
nvl(sum((select count(*) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=3 )) ,0),
nvl(sum((select max(importe_global) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=3 )),0),
nvl(sum((select max(importe_recargo) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=3 )),0), 
nvl(sum((select max(importe_multa) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=3 )),0),
nvl(sum((select sum(importe_gastos) from ta_15_apremios where modulo=11 and control_otr=a.id_local 
and (fecha_emision between pfdsd and pfhst) and vigencia=3 )) ,0)
into v_nmer,vmercado,v_idl,v_renta,v_recar,v_multa,v_gastos,v_adeudo,v_not,v_req,v_epra,v_renpr,v_recpr,v_mulpr,v_gaspr,
v_epag,v_renp,v_recp,v_mulp,v_gasp,v_evig,v_renv,v_recv,v_mulv,v_gasv,v_ecan,v_renc,v_recc,v_mulc,v_gasc
from ta_11_locales a,ta_11_mercados b
where b.num_mercado_nvo not in(99,214) and a.vigencia='A' 
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
group by a.num_mercado,b.descripcion,a.id_local
order by a.num_mercado,a.id_local

-- checa si tiene folios
let v_folio=0;
select nvl(count(folio),0) into v_folio
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

-- todos los periodos del a�o adeudo
let v_periodos=0;
let v_recartot=0;
if v_adeudo>0 then
   foreach
   select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos   
   into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
   from   ta_11_adeudo_local a,ta_11_fecha_desc b
   where a.id_local=v_idl
   and (a.axo<paxo  or (periodo<=pmes and a.axo=paxo))
   and b.mes=month(today)
   order by a.axo,a.periodo

   -- obtiene el porcentaje de recargos
   let v_porc=0;
   let v_recargos=0;
   if today>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   end if;

   if  v_porc is null then
       let v_porc=0;
   end if;

   if  v_folio = 0 then
       if v_porc > 100 then
          let v_recargos=trunc(v_aimporte*100)/100;
       else
          let v_recargos=trunc(v_aimporte*v_porc)/100;
       end if;
   else
       if v_porc > 250 then
          let v_recargos=trunc(v_aimporte*250)/100;
       else
          let v_recargos=trunc(v_aimporte*v_porc)/100;
       end if;
   end if;

   let v_recartot=v_recartot+v_recargos;
   end foreach; -- cierre de los periodos
end if;

insert into tmp_apremitidos values(v_nmer,vmercado,v_idl,v_adeudo,v_recartot,v_renta,v_recar,
v_multa,v_gastos,v_not,v_req,v_epra,v_renpr,v_recpr,v_mulpr,v_gaspr,v_epag,v_renp,v_recp,v_mulp,v_gasp,
v_evig,v_renv,v_recv,v_mulv,v_gasv,v_ecan,v_renc,v_recc,v_mulc,v_gasc);
end foreach; -- cierre de adeudos general

foreach
select num_mercado,mercado,nvl(count(*),0) into v_numero,vmercado,vvigentes
from tmp_apremitidos
group by num_mercado,mercado
order by num_mercado

  select nvl(count(*),0),nvl(sum(notificaciones),0),nvl(sum(requerimientos),0),
nvl(sum(rentaemitidos),0),nvl((sum(recargosemitidos)+sum(multa)+sum(gastos)),0)  
  into vlocalemi,vnot_emi,vreq_emi,vrenta_emitidos,vimp_emitidos
  from tmp_apremitidos
  where num_mercado=v_numero and  (notificaciones>0 or requerimientos>0);

  select nvl(count(*),0),nvl(sum(practicados),0),nvl(sum(rentapracticada),0),
nvl((sum(recargospract)+sum(multapracticada)+sum(gastospracticados)),0) 
  into vlocal_pra,vpracticados,vrenta_pract,vimp_practicado
  from tmp_apremitidos
  where num_mercado=v_numero and practicados>0;

  select nvl(count(*),0),nvl(sum(pagados),0),nvl(sum(rentapagada),0),
nvl((sum(recargospagados)+sum(multapagada)+sum(gastospagados)),0) 
  into vlocal_pag,vpagados,vrenta_pagada,vimp_pagados
  from tmp_apremitidos
  where num_mercado=v_numero and pagados>0;

  select nvl(count(*),0),nvl(sum(cancelados),0),nvl(sum(rentacancelada),0),
nvl((sum(recargoscanc)+sum(multacancelada)+sum(gastoscanclados)),0) 
  into vlocal_can,vcancelados,vrenta_cancelada,vimp_cancelados
  from tmp_apremitidos
  where num_mercado=v_numero and cancelados>0;

  select nvl(count(*),0),nvl(sum(vigentes),0),nvl(sum(rentavigente),0),
  nvl((sum(multavigente)+sum(gastosvigentes))+sum(recargosvigente),0)  
  into  vlocal_vig,vvig_emi,varrendamiento,vaccesorios
  from tmp_apremitidos
  where num_mercado=v_numero  and vigentes>0; 

  select nvl(count(*),0) into vsinfolios
  from  tmp_apremitidos
  where num_mercado=v_numero and renta>0 and notificaciones=0 and requerimientos=0;

return vmercado,vvigentes,vlocalemi,vnot_emi,vreq_emi,vrenta_emitidos,vimp_emitidos,vlocal_pra,vpracticados,vrenta_pract,vimp_practicado,
vlocal_pag,vpagados,vrenta_pagada,vimp_pagados,vlocal_can,vcancelados,vrenta_cancelada,vimp_cancelados,
vlocal_vig,vvig_emi,varrendamiento,vaccesorios,vsinfolios
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".cg_generapoliza (par_Fecha Date, par_ejercicio smallint, par_mes smallint, par_tipopol smallint, 
                                                               par_id_modulo integer, par_id_proceso integer, par_id_rec integer, 
                                                               par_conc char(30), par_conc_gral char(200), 
                                                               par_tipoproceso char(1), par_id_proceso_admin Integer)
                returning integer;  -- regresa el id_poliza

define varNumpol smallint;
define v_idpoliza integer;

Let v_idpoliza = 0;

     SELECT max(numero) into varNumpol FROM cg_polizas WHERE ejercicio = par_ejercicio AND mes = par_mes AND tipo = par_tipopol ;
                if varNumpol is null then
                let varNumpol = 0;
                end if;
                let varNumpol = varNumpol +1;

                insert into cg_polizas ( id_poliza , ejercicio , mes , tipo , numero , fecha ,id_modulo ,
                               id_proceso, id_rec , concepto , concepto_gral, clave ,  capturo , tipo_proceso, id_proceso_admin)
                values (0, par_ejercicio, par_mes, par_tipopol, varNumpol, par_Fecha, par_id_modulo,
                               par_id_proceso, par_id_rec, par_conc, par_conc_gral, 'A', user , 'A', par_id_proceso_admin);
                LET v_idpoliza = dbinfo("sqlca.sqlerrd1");

                return v_idpoliza;
--            Regresa el id de la poliza generada

end procedure;

create procedure "saranda".spd_12_polcontables (v_fecha date, v_usu int)
                 returning smallint as momento, varchar(25) as cta_admin, varchar(80) as descripcion,
                        varchar(80) as num_cta, money(15,2) as cargo, money(15,2) as abono, smallint as origen,
                        int as error, int as error1, varchar(255) as mensaje;







define p_momen  smallint;
define p_cta    varchar(25);
define p_desc   varchar(80);
define p_numcta varchar(80);
define p_cargo  money(15,2);
define p_abono  money(15,2);
define p_origen  smallint;
define p_numero  int;
define     v_idpoliza int;
define   v_axop int;
define   v_mesp int;
define    p_mayor CHAR(4) ;
 define   p_sub01 CHAR(2) ;
 define   p_sub02 CHAR(4) ;
 define   p_sub03 CHAR(5) ;
 define   p_sub04 CHAR(5) ;
define p_existe     int;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_usuario varchar(20);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN 0,'', '', '', 0 , 0, 0,-1,0, 'spd_12_polcontable ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let p_existe=0;
let v_axop=year(today);
let v_mesp=month(today);

select nvl(max(numero),0) into p_numero from cg_polizas where ejercicio = v_axop  and tipo =3 ;

select  usuario into  v_usuario from ta_12_passwords where id_usuario=v_usu;

select nvl(count(*),0) into p_existe from cg_12_importes  where fecing=v_fecha;

if p_existe=0 then
   RETURN 0,'', '', '', 0 , 0, 0,-1,0, 'No Existe Informacion con esa fecha '||v_fecha;
end if;

if p_existe>0 then

 


LET v_idpoliza = dbinfo("sqlca.sqlerrd1");


foreach
select 0 ,(b.cta_mayor||'-'||b.CTA_sub01 ||"-"|| b.cta_sub02 ||"-"|| b.cta_sub03 ||"-"|| b.cta_sub04), (nombre || " No. CTA " || numero_cuenta),
(''), sum(a.importe), (0), 1, b.cta_mayor, b.CTA_sub01 , b.cta_sub02 , b.cta_sub03 , b.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04 
FROM cg_12_depositos a, cg_12_bancos b
 WHERE a.feciNG=v_fecha and  a.control_bco=b.control_bco 
group by 1,2,3,4,b.cta_mayor, b.CTA_sub01 , b.cta_sub02 , b.cta_sub03 , b.cta_sub04 
return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;







end foreach;

foreach
select 0, (a.cta_mayor||'-'||a.CTA_sub01 ||"-"|| a.cta_sub02 ||"-"|| a.cta_sub03 ||"-"|| a.cta_sub04),a.nombre,b.concepto, sum(b.importe_faltante),(0)
,1, a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,  
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04 
FROM cg_12_faltantes b, cg_12_deudores a
 WHERE b.feciNG=v_fecha and   b.control_deudor=a.control_deudor 
group by 1,2,3,4,a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

 
 
 
 
 


end foreach;

foreach
select 0, (a.cta_mayor||'-'||a.CTA_sub01 ||"-"|| a.cta_sub02 ||"-"|| a.cta_sub03 ||"-"|| a.cta_sub04) ,a.nombre,
c.concepto, sum(c.importe_cargo),sum(importe_abono),1, a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_virtuales c, cg_12_deudores a
 WHERE c.feciNG=v_fecha and   c.control_deudor=a.control_deudor 
group by 1,2,3,4,a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;



 
 
 

end foreach;
foreach
select  0, (c.cta_mayor||'-'||c.CTA_sub01 ||"-"|| c.cta_sub02 ||"-"|| c.cta_sub03 ||"-"|| c.cta_sub04),b.nombre,
b.concepto,0,a.importe_cta,1, c.cta_mayor, c.CTA_sub01 , c.cta_sub02 , c.cta_sub03 , c.cta_sub04
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_importes a,  cg_12_ingreso b, cg_12_deudores c
 WHERE a.feciNG=v_fecha and   b.tipo_rbo= 15 and 
 a.FECING=b.FECING AND a.RECING=b.RECING and a.cajing=b.cajing and a.opcaja=b.opcaja
and b.numero=c.control_deudor 

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

 
 
 
 
 

end foreach;

foreach
select 0, (d.cta_mayor||'-'||d.CTA_sub01 ||"-"|| d.cta_sub02 ||"-"|| d.cta_sub03 ||"-"|| d.cta_sub04) ,d.concepto, 
('INGRESO DEL DIA'),(0),sum(e.importe_cta), 1, d.cta_mayor, d.CTA_sub01 , d.cta_sub02 , d.cta_sub03 , d.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_importes e, cg_12_cuentas d,cg_12_ingreso f
 WHERE e.feciNG=v_fecha and  e.cta_aplicacion = d.cta_aplicacion and 
f.FECING=e.FECING AND f.RECING=e.RECING and f.cajing=e.cajing and f.opcaja=e.opcaja and f.tipo_rbo<>15 
group by 1,2,3,4, d.cta_mayor, d.CTA_sub01 , d.cta_sub02 , d.cta_sub03 , d.cta_sub04 

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

 
 
 
 
 

end foreach;
foreach
select (momentos + 1),(m.cta_m11||"-"||cta_m12||"-"||cta_m13||"-"||cta_m14||"-"||cta_m15), (descripcion||" "||desc_mci1)," ",
 sum(importe_cta), 0 ,m.origen,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha and momentos=0   and momentos<3  and m.vigencia='V'
group by 1, 2, 3, 4,7,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;







end foreach;

foreach
select (momentos + 1),(cta_m21||"-"|| cta_m22||"-"||cta_m23||"-"||cta_m24||"-"||cta_m25), (descripcion||" "||desc_mci2)," ",
 0 cargo, sum(importe_cta)  abono,m.origen, m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha  and momentos=0  and momentos<3 and m.vigencia='V'
group by 1, 2, 3, 4,7, m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

 
 
 
 
 

end foreach;

foreach
select momentos  ,(m.cta_m11||"-"||cta_m12||"-"||cta_m13||"-"||cta_m14||"-"||cta_m15), (descripcion||"-"||desc_mci1)," ",
 sum(importe_cta), 0 ,m.origen,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha and momentos>0 and momentos<3 and m.vigencia='V'
group by 1, 2, 3, 4,7,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;


  
  
  
  

end foreach;

foreach
select momentos, (cta_m21||"-"|| cta_m22||"-"||cta_m23||"-"||cta_m24||"-"||cta_m25), (descripcion||" "||desc_mci2)," ",
0 cargo, sum(importe_cta)  abono,m.origen,  m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha  and momentos>0 and momentos<3 and m.vigencia='V'
group by 1, 2, 3, 4,7, m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25
order by 1, 2, 3, 4

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

 
  
  
  
  

end foreach;
end if;
end procedure;

create procedure "saranda".spd_12_polcontable (v_fecha date, v_usu int)
                 returning smallint as momento, varchar(25) as cta_admin, varchar(80) as descripcion,
                        varchar(80) as num_cta, money(15,2) as cargo, money(15,2) as abono, smallint as origen,
                        int as error, int as error1, varchar(255) as mensaje;


define p_momen  smallint;
define p_cta    varchar(25);
define p_desc   varchar(80);
define p_numcta varchar(80);
define p_cargo  money(15,2);
define p_abono  money(15,2);
define p_origen  smallint;
define p_numero  int;
define     v_idpoliza int;
define   v_axop int;
define   v_mesp int;
define    p_mayor CHAR(4) ;
 define   p_sub01 CHAR(2) ;
 define   p_sub02 CHAR(4) ;
 define   p_sub03 CHAR(5) ;
 define   p_sub04 CHAR(5) ;
define p_existe     int;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_usuario varchar(20);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN 0,'', '', '', 0 , 0, 0,-1,0, 'spd_12_polcontable ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let p_existe=0;
let v_axop=year(today);
let v_mesp=month(today);

select nvl(max(numero),0) into p_numero from cg_polizas where ejercicio = v_axop  and tipo =3 ;

select  usuario into  v_usuario from ta_12_passwords where id_usuario=v_usu;

select nvl(count(*),0) into p_existe from cg_12_importes  where fecing=v_fecha;

if p_existe=0 then
   RETURN 0,'', '', '', 0 , 0, 0,-1,0, 'No Existe Informacion con esa fecha '||v_fecha;
end if;

if p_existe>0 then
insert into cg_polizas ( id_poliza , ejercicio , mes , tipo , numero , fecha ,id_modulo ,
             id_proceso, id_rec , concepto , concepto_gral, clave ,  capturo , tipo_proceso, nombre_proceso,id_proceso_admin)
       values (0, v_axop, v_mesp, 3, p_numero, today, 12, 5, 9, ('POLIZA DEL INGRESO DIARIO '||v_fecha),'POLIZA DEL INGRESO DIARIO '||v_fecha, 'A', v_usuario , 'A','spd_12_polcontable',96);

LET v_idpoliza = dbinfo("sqlca.sqlerrd1");


foreach
select 0 ,(b.cta_mayor||'-'||b.CTA_sub01 ||"-"|| b.cta_sub02 ||"-"|| b.cta_sub03 ||"-"|| b.cta_sub04), (nombre || " No. CTA " || numero_cuenta),
(''), sum(a.importe), (0), 1, b.cta_mayor, b.CTA_sub01 , b.cta_sub02 , b.cta_sub03 , b.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04 
FROM cg_12_depositos a, cg_12_bancos b
 WHERE a.feciNG=v_fecha and  a.control_bco=b.control_bco 
group by 1,2,3,4,b.cta_mayor, b.CTA_sub01 , b.cta_sub02 , b.cta_sub03 , b.cta_sub04 
return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;

foreach
select 0, (a.cta_mayor||'-'||a.CTA_sub01 ||"-"|| a.cta_sub02 ||"-"|| a.cta_sub03 ||"-"|| a.cta_sub04),a.nombre,b.concepto, sum(b.importe_faltante),(0)
,1, a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,  
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04 
FROM cg_12_faltantes b, cg_12_deudores a
 WHERE b.feciNG=v_fecha and   b.control_deudor=a.control_deudor 
group by 1,2,3,4,a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   


end foreach;

foreach
select 0, (a.cta_mayor||'-'||a.CTA_sub01 ||"-"|| a.cta_sub02 ||"-"|| a.cta_sub03 ||"-"|| a.cta_sub04) ,a.nombre,
c.concepto, sum(c.importe_cargo),sum(importe_abono),1, a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_virtuales c, cg_12_deudores a
 WHERE c.feciNG=v_fecha and   c.control_deudor=a.control_deudor 
group by 1,2,3,4,a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;
foreach
select  0, (c.cta_mayor||'-'||c.CTA_sub01 ||"-"|| c.cta_sub02 ||"-"|| c.cta_sub03 ||"-"|| c.cta_sub04),b.nombre,
b.concepto,0,a.importe_cta,1, c.cta_mayor, c.CTA_sub01 , c.cta_sub02 , c.cta_sub03 , c.cta_sub04
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_importes a,  cg_12_ingreso b, cg_12_deudores c
 WHERE a.feciNG=v_fecha and   b.tipo_rbo= 15 and 
 a.FECING=b.FECING AND a.RECING=b.RECING and a.cajing=b.cajing and a.opcaja=b.opcaja
and b.numero=c.control_deudor 

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;

foreach
select 0, (d.cta_mayor||'-'||d.CTA_sub01 ||"-"|| d.cta_sub02 ||"-"|| d.cta_sub03 ||"-"|| d.cta_sub04) ,d.concepto, 
('INGRESO DEL DIA'),(0),sum(e.importe_cta), 1, d.cta_mayor, d.CTA_sub01 , d.cta_sub02 , d.cta_sub03 , d.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_importes e, cg_12_cuentas d,cg_12_ingreso f
 WHERE e.feciNG=v_fecha and  e.cta_aplicacion = d.cta_aplicacion and 
f.FECING=e.FECING AND f.RECING=e.RECING and f.cajing=e.cajing and f.opcaja=e.opcaja and f.tipo_rbo<>15 
group by 1,2,3,4, d.cta_mayor, d.CTA_sub01 , d.cta_sub02 , d.cta_sub03 , d.cta_sub04 

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;
foreach
select (momentos + 1),(m.cta_m11||"-"||cta_m12||"-"||cta_m13||"-"||cta_m14||"-"||cta_m15), (descripcion||" "||desc_mci1)," ",
 sum(importe_cta), 0 ,m.origen,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha and momentos=0   and momentos<3  and m.vigencia='V'
group by 1, 2, 3, 4,7,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;

foreach
select (momentos + 1),(cta_m21||"-"|| cta_m22||"-"||cta_m23||"-"||cta_m24||"-"||cta_m25), (descripcion||" "||desc_mci2)," ",
 0 cargo, sum(importe_cta)  abono,m.origen, m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha  and momentos=0  and momentos<3 and m.vigencia='V'
group by 1, 2, 3, 4,7, m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;

foreach
select momentos  ,(m.cta_m11||"-"||cta_m12||"-"||cta_m13||"-"||cta_m14||"-"||cta_m15), (descripcion||"-"||desc_mci1)," ",
 sum(importe_cta), 0 ,m.origen,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha and momentos>0 and momentos<3 and m.vigencia='V'
group by 1, 2, 3, 4,7,  m.cta_m11, m.CTA_m12 , m.cta_m13 , m.cta_m14 , m.cta_m15

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;

foreach
select momentos, (cta_m21||"-"|| cta_m22||"-"||cta_m23||"-"||cta_m24||"-"||cta_m25), (descripcion||" "||desc_mci2)," ",
0 cargo, sum(importe_cta)  abono,m.origen,  m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
from cg_12_importes i, ta_12_cuentasmci m
where i.cta_aplicacion=m.cta_aplicacion and fecing =v_fecha  and momentos>0 and momentos<3 and m.vigencia='V'
group by 1, 2, 3, 4,7, m.cta_m21, m.CTA_m22 , m.cta_m23 , m.cta_m24 , m.cta_m25
order by 1, 2, 3, 4

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

  insert into cg_poliza_movimientos (
        control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
        cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
      values (0, v_idpoliza , 0 , p_mayor ,   p_sub01 , p_sub02  , p_sub03 ,   p_sub04 ,
        p_cargo , p_abono, p_origen , p_desc , p_numcta) ;   

end foreach;
end if;
end procedure;

CREATE PROCEDURE "informix".regist_configpc(pid_centro int, pEquipo char(30), pip char(30),
 pid_usuarioconfig int)

returning  integer as idpc;
define v_idpc int;	
insert into ta_12_Equiposctrosrecas ( id_pc, id_centro, Equipo, ip , id_usuarioconfig)
values (0, pid_centro, pEquipo, pip , pid_usuarioconfig );
LET v_idpc = dbinfo("sqlca.sqlerrd1");
return v_idpc;
end procedure;

create procedure "saranda".spd_12_asignarcaja(p_usu int, p_centro int, p_super int, p_caja char(2), p_rein char(1),
                 p_rec int, p_opc int)
                 returning smallint as par_ok, int as par_id, varchar(255) as par_observ; 


define v_id     int;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_computer char(50); 

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 999, ('sp_12_AsignarCaja ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION

   execute procedure catastro_gdl:getcomputer() into   v_computer;

select nvl((id_centro),0) into v_id from ta_12_cajeros_centros where id_usuario=p_usu;


if p_opc = 1 then 
  
  INSERT INTO ta_12_cajeros_centros(id_usuario, id_centro, id_supervisor, fecha_movimiento, clave, pc_movimiento) 
    VALUES(p_usu, p_centro, p_super, today, '', v_computer);
  
  INSERT INTO ta_12_operaciones(id_rec, caja, operacion, id_usuario, tip_impresora) 
    VALUES(p_rec, p_caja, 0, p_usu, 'L');
 
  RETURN 1, 0, ('Registro Dado de Alta');

end if;

if p_opc = 2 then

   UPDATE ta_12_operaciones 
      SET id_usuario=0, operacion=0
      WHERE id_rec=p_rec and caja=p_caja;

  if v_id>0 then
   INSERT INTO ta_12_cajeros_centros_h(control, fecha_hist, id_usuario, id_centro, id_supervisor, fecha_movimiento, clave, pc_movimiento) 
    SELECT 0,today,id_usuario, id_centro, id_supervisor, fecha_movimiento, clave, pc_movimiento 
    FROM ta_12_cajeros_centros where id_usuario=p_usu;

   delete from ta_12_cajeros_centros 
    WHERE id_usuario=p_usu;
  end if;

   RETURN 1,1, ('Registro se ha dado de Baja');

end if;

if p_opc = 3 then

  if  p_rein='S' then
      UPDATE ta_12_operaciones 
      SET id_usuario=p_usu, operacion=0
      WHERE id_rec=p_rec and caja=p_caja;
  end if;

  if  p_rein='N' then
      UPDATE ta_12_operaciones 
      SET id_usuario=p_usu
      WHERE id_rec=p_rec and caja=p_caja;
  end if;

  if  v_id>0 then
      if v_id<> p_centro then
      INSERT INTO ta_12_cajeros_centros_h(control, fecha_hist, id_usuario, id_centro, id_supervisor, fecha_movimiento, clave, pc_movimiento) 
      SELECT 0,today,id_usuario, id_centro, id_supervisor, fecha_movimiento, clave, pc_movimiento 
      FROM ta_12_cajeros_centros where id_usuario=p_usu;

      UPDATE ta_12_cajeros_centros 
       SET  id_centro=p_centro, id_supervisor=p_super, fecha_movimiento=today, pc_movimiento=v_computer
      WHERE id_usuario=p_usu;
     end if;
  else
    INSERT INTO ta_12_cajeros_centros(id_usuario, id_centro, id_supervisor, fecha_movimiento, clave, pc_movimiento) 
      VALUES(p_usu, p_centro, p_super, today, '', v_computer);
  end if;

   RETURN 1,2, ('Registro se ha Asigando la caja ' || p_caja||' a centro de recaudacion ');

end if;

end procedure;

CREATE PROCEDURE "informix".sp_repcaneladas(p_fecha_ini date, p_fecha_fin date , p_reca int)
                returning   date as fecha, int as id_rec, char(2) as caja, int as operacion,
               money(15,2) as importe, varchar(100) as concepto,
               datetime year to minute as fecha_act, varchar(50) as cajero , varchar(50) as nombre_canc , varchar(50) as tipo_pago ;  
define  v_fecha date;
define  v_id_rec int;
define  v_caja char(2);
define  v_operacion int;
define  v_importe money(15,2);
define  v_id_modulo int ;
define  v_tipoPago  varchar(50);
define  v_concepto  varchar(100);
define  v_nombreCancela varchar(50);
define  v_fecha_act  datetime year to minute;
define  v_cajero varchar(50);


foreach

select  a.fecha ,  a.id_rec , a.caja ,  a.operacion , a.importe , a.id_modulo ,
    c.descrip tipoPago,  a.concepto,  b.nombre  ,  a.fecha_act 
 into 
    v_fecha , v_id_rec , v_caja , v_operacion , v_importe , v_id_modulo , v_tipoPago,
    v_concepto, v_nombreCancela, v_fecha_act 

   from ta_12_recibos a,  ta_12_passwords b, ta_12_tiporecibo c 
 
   where  (a.fecha between p_fecha_ini and p_fecha_fin) and a.id_rec = p_reca and a.cvepago = 'C'  and 
   a.id_usuario = b.id_usuario and a.id_modulo = c.tipo 


foreach

   select unique nvl(p.nombre,'') into v_cajero   
        from ta_12_passwords p , ta_12_recibos r 
       where p.id_usuario = r.id_usuario and 
        (r.fecha between v_fecha and v_fecha +3) and  r.id_rec=v_id_rec and r.caja=v_caja and r.operacion between (v_operacion + 1) and (v_operacion + 10)
        and r.cvepago='P'

end foreach;

return  v_fecha , v_id_rec , v_caja , v_operacion , v_importe , v_concepto,  
    v_fecha_act , v_cajero ,  v_nombreCancela ,v_tipoPago with resume;
end foreach;

end procedure;

CREATE PROCEDURE "informix".getcomputerdet()
   returning int as idses , char(10) as usuario, char(20) as pc;
   define  v_idses  int;
   define  v_usuario char(10);
   define  v_computer  char(20);
   
    select sid , trim(username) , trim(hostname) into v_idses , v_usuario, v_computer 
    from sysmaster:syssessions where sid = DBINFO('sessionid');


    return  v_idses , v_usuario, v_computer ;
END PROCEDURE;

CREATE PROCEDURE "informix".prubsepara(dato  varchar(60))

returning  char(8) as contratost , 
         integer as contratoint ,
           integer as longcontrato;

define v_contrato int; 
define v_long int;
define v_contratost char(8);
let v_long = length(trim(dato));

let v_contratost = substring(dato from 35 for 8);
let v_contrato = v_contratost *1;
return v_contratost , v_contrato , v_long;

end procedure;

CREATE PROCEDURE "informix".con16_detcont_02 ( p_Ctrol_aseo Integer, p_Adeudos Char(1), p_Fecha_fin Char(7))
    RETURNING CHAR(2),               -- RECAUDADORA
              VARCHAR(20),    -- TIPO DE ASEO
              INTEGER,              -- NUMERO DE CONTRATO
              VARCHAR(200),                 -- A NOMBRE DE QUIEN ESTA EL CONTRATO
              VARCHAR(200),                 -- DOMICILIO
              CHAR(2),               -- VIGENCIA   HASTA AQUI DATOS DEL CONTRATO

              Money(12,2),    -- ADEUDOS
              Money(12,2),    -- RECARGOS
              Money(12,2),    -- TOTAL DE GASTOS
              Money(12,2),    -- TOTAL DE MULTAS

              varchar(255);      -- DATOS DE REQUERIMIENTOS

{
#  Procedimiento: Con16_F4DetCont
#  Descripcion:  Genera una consulta del Contrato con control de importe
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#                                        p_Control_adeudo : solo imprime si existe contrato
#  Parametros de salida:   todos los datos del contrato
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec      Integer;
  define v_nombre, v_domicilio               , v_tipo_aseo                                                                  varchar(80);
  define v_tipo_recolec                                                                                                              varchar(20);
  define v_sector, v_status_vigencia                                                                                    Char(1);
  define v_fecha_ini, v_fecha_hora_baja                                                                                          Date;

  define v_importe_multa, v_importe_gastos, v_tot_gastos                                                                    Money(12,2);
  define v_totAdeudos2006, v_TotRecargos2006, v_totAdeudos2007, v_TotRecargos2007         Money(12,2);
  define v_Datos                                                                                                                                           varchar(120);


----------------------
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2006 = 0;
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2006 = 0;
LET v_TotRecargos2007 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;
LET v_Datos = '';

FOREACH
       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, 
                  a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja, a.status_vigencia
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, 
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja, v_status_vigencia
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.ctrol_aseo = p_Ctrol_aseo
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec
       Order by a.num_contrato
       
     FOREACH
                EXECUTE PROCEDURE con16_detade_04 ( v_Control, p_Fecha_fin) 
                               INTO v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, v_Datos
     END FOREACH;

  IF p_Adeudos = 'T' THEN
     if v_Datos <> 'Docto(s) Requerido(s) : ' then
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, v_Datos  with resume;
     else
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2007, v_TotRecargos2007, v_importe_multa, v_tot_gastos, Null  with resume;
     end if;
  END IF;

Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2006 = 0;
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2006 = 0;
LET v_TotRecargos2007 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;

END FOREACH;

end procedure;

CREATE PROCEDURE "informix".con16_detade_04 ( p_Control_contrato Integer, p_Fecha_fin Char(7))
                returning Money(12,2),    -- Importe Adeudos
                               Money(12,2),    -- Importe Recargos
                               Money(12,2),    -- Importe Multa
                               Money(12,2),    -- Importe Gastos
                               varchar(255);    -- Documentos
               

{
#  Procedimiento: Con16_detade_04
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Importe : El importe de los Adeudos
#                                      Importe : El importe de los Recargos
#                                      Importe : El importe de la Multa
#                                      Importe : El importe de los Gastos
#                                      Concepto : Documentacion turnada por este contrato
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                                    Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq                                                                   Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos                                                    Money(12,2);
  define v_DetFolReq                                                                                                  varchar(120);
  define v_diligencia                                                                                                                     char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago                                                                                                        Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2                                 Money(12,2);
  define v_totAdeudos2005, v_TotRecargos2005, v_totAdeudos2006, v_TotRecargos2006         Money(12,2);
  define v_Mes                                                                                                               varchar(2);

  define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato                                                      Integer;
  define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato                                      varchar(120);

       define v_Importe_recargo, v_TotRecargos, v_Reg_1                                                           Money(12,2);
       define v_mensaje_proc                                                                                                     varchar(255);
--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade   varchar(7);
  define v_Periodo                                                                                                                       varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo                                                                           Integer;
--****************************************************************************************************************************** 
   Let v_Contador = 0;
   
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_rec1 = 0;
  Let v_importe_rec2 = 0;
   Let v_axo = 0;
                Let v_Lineas_Dato = 0;
  Let aso_proceso = 0;


       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;


                Let v_tot_gastos = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_FolReq = 0;
                Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
                foreach
                     Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                               if v_FolReq > 0 then
                                  Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
                               else
                                  Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
                               Let v_FolReq = v_FolReq + 1;
                               end if;
                end foreach;
                       if v_FolReq > 0 then
                               --return v_DetFolReq, Null, Null, v_importe_multa, v_tot_gastos  with resume;
                                Let v_Contador = v_Contador + 1;
                       end if;

                Let v_Lineas_Dato = 0;
                Let v_Detalle_Dato = '';
                               Select ('Descuento de Recargos en periodo(s) del ' || axoinicio || '-' || mesinicio || 
                                               ' al ' || axofin || '-' || mesfin || ' por el ' || porcentaje || ' %'), 
                                               (axoinicio || '-' || mesinicio), axofin || '-' || mesfin, porcentaje
                                               INTO v_Detalle_Dato, v_Periodo_Inicio, v_Periodo_fin, v_porc
                                               from ta_16_descrec
                                               Where id_contrato = p_Control_contrato and vigencia = 'V';

                              if v_Detalle_Dato <> '' then
                                  Let v_Lineas_Dato = v_Lineas_Dato + 1;
                              end if;

  LET v_totAdeudos2005 = 0;
  LET v_totAdeudos2006 = 0;
  LET v_TotRecargos2005 = 0;
  LET v_TotRecargos2006 = 0;


                -------------------------------------CONSULTA DE CUOTA NORMAL
                               Let v_Lineas_CN = 0;
                               Let v_Detalle_CN = ' C.N. Mes(s) --';

                               foreach
                                               Select Year(h.aso_mes_pago), h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago)
                                                              Into v_axo, v_aso_mes_pago, v_importe, v_Mes 
                                                               From ta_16_pagos H
                                                               Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6 
                                                              and H.aso_mes_pago <= ( p_Fecha_fin )
                                                              and H.Status_Vigencia = 'V' 
                                                               Order By h.aso_mes_pago

                                                               Select sum(porc_recargo) 
                                                               Into v_Importe_recargo
                                                               From ta_16_recargos 
                                                               Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);

                               if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
                                         Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
                                         Let v_Detalle_CN = v_Detalle_CN||v_Mes;
                                   end if;
                                   Let v_totAdeudos = v_totAdeudos + v_importe;
                                   Let v_Lineas_CN = v_Lineas_CN + 1;
                                   if v_Importe_recargo <> 0 then
                                      Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                       if v_importe_rec2 > 0 then
                                         Let v_TotRecargos = v_TotRecargos + v_importe_rec2;
                                          Let v_Lineas_Dato = v_Lineas_Dato + 1;
                                       else
                                         Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
                                       end if;
                                   end if;
                                    Let v_Contador = v_Contador + 1;
                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;
                               end foreach;

                -------------------------------------CONSULTA DE EXEDENCIAS
                               Let v_Lineas_EX = 0;
                               Let v_Detalle_EX = ' EXE. Mes(s) --';

                               foreach
                               Select h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago)
                                   Into v_aso_mes_pago, v_importe, v_Mes 
                               From ta_16_pagos H
                               Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6 
                                    and H.aso_mes_pago <= ( p_Fecha_fin )
                                    and H.Status_Vigencia = 'V' 
                               Order By h.aso_mes_pago

                                                    Select sum(porc_recargo) 
                                                   Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);

                               if v_importe > 0 then
                                    if v_Lineas_EX > 0 then
                                         Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                                    else
                                         Let v_Detalle_EX = v_Detalle_EX||v_Mes;
                                   end if;
                                   Let v_totAdeudos = v_totAdeudos + v_importe;
                                   Let v_Lineas_EX = v_Lineas_EX + 1;
                                   if v_Importe_recargo <> 0 then
                                      Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                       if v_importe_rec2 > 0 then
                                         Let v_TotRecargos = v_TotRecargos + v_importe_rec2;
                                          Let v_Lineas_Dato = v_Lineas_Dato + 1;
                                       else
                                         Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
                                       end if;
                                   end if;
                                    Let v_Contador = v_Contador + 1;
                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;
                               end foreach;

--     Grabando registro
       LET v_totAdeudos2006 = v_totAdeudos2006 + v_totAdeudos;
       LET v_TotRecargos2006 = v_TotRecargos2006 + v_TotRecargos;


   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;


   if v_Contador = 0 then
       return Null, Null, Null, Null, Null;
   else
       return v_totAdeudos2006, v_TotRecargos2006, v_importe_multa, v_tot_gastos, v_DetFolReq;
   end if;

end procedure;

create procedure "informix".spd_11_padronmeses(paxo int,pmes int)
returning   char(30) as mercado,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(1) as letra,
            char(1) as bloque,
            varchar(60) as nombre,
            char(15) as estado,
            char(30) as periodo,
            integer as axoadeudo,
            MONEY(16,2) as adeudo,
            MONEY(16,2) as recargos,
            MONEY(16,2) as multa,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total,
            char(5000) as folios;
  
define v_recargostotal MONEY(16,2);  
define v_multa MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(15);
define v_nombre varchar(60);
define v_periodo varchar(30);
define v_mer char(30);          define v_ofi smallint;
define v_nme,v_axog smallint;    define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(1);           define v_blq char(1);
define v_est char(1);           define v_idl integer;
define v_axo,v_per smallint;    define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);
define v_aid_local integer;     define v_aaxo smallint;
define v_aperiodo smallint;     define v_aimporte money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;      
let v_folio=0;
let v_periodo=''; 
--let v_salto=CHaR(10)||CHaR(13);
--set debug file to "beny.log";
--trace on;

foreach
select trim(b.descripcion),a.id_local,a.oficina,a.num_mercado,a.categoria,trim(a.seccion),
a.local,trim(a.letra_local),trim(a.bloque),trim(a.nombre),a.vigencia,nvl(d.axo,0),nvl(sum(d.importe),0) 
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_est,v_axog,v_ade
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where b.num_mercado_nvo not in(99,214) and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
and d.id_local=a.id_local and (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo))
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,
a.letra_local,a.bloque,a.nombre,a.vigencia,d.axo
order by a.oficina,a.num_mercado,a.categoria,6,a.local,8,9,12

if v_est='A' then
   let v_estado='VIGENTE';
else
   let v_estado='BAJA';
end if;

let v_per=0;

if v_axog=0 then
   let v_per=0;
else
if v_axog<paxo then
   let v_per=12;
else
if v_axog=paxo then
   let v_per=pmes;
end if;
end if;
end if;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  
let v_total=0;

-- todos los periodos del local
let v_periodo='';
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=v_idl and (a.periodo between 1 and v_per) and a.axo=v_axog 
and b.mes=month(today)
order by a.axo,a.periodo
let v_periodo=trim(v_periodo)||v_aperiodo||',';

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if today>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

let v_periodo=substr(v_periodo,1,(length(v_periodo)-1));

-- verifica los folios de requerimientos
let v_requerimientos='';
foreach
select id_control,fecha_emision,folio,fecha_practicado,( 
(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
from   ta_15_apremios a   
where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
order by a.fecha_emision,a.folio
--let v_requerimientos=trim(v_requerimientos)||'Emisi�n '||v_emi||
--' Folio '||v_fol||' Practicado '||v_pra||' Periodo Inicio '||v_ini||' Periodo Final '||v_fin;
--let v_requerimientos=trim(v_requerimientos)||v_emi||'|'||v_fol||'|'||v_pra||'|'||
--trim(v_ini)||'|'||trim(v_fin)||'|';
let v_requerimientos=trim(v_requerimientos)||v_fol||',';
end foreach; -- cierre de apremios

let v_requerimientos=substr(v_requerimientos,1,(length(v_requerimientos)-1));
let v_total=v_ade+v_recargostotal; -- 
--let v_total=v_ade+v_recargostotal+v_multa+v_gastos;

return v_mer,v_nme,v_sec,v_loc,v_let,v_blq,v_nombre,
v_estado,v_periodo,v_axog,v_ade,v_recargostotal,v_multa,v_gastos,v_total,v_requerimientos
with resume;
end foreach; -- cierre del principal
--trace off;

end procedure;

CREATE PROCEDURE "informix".sp_maq_verifica(p_hostname CHAR(256),p_ip CHAR(25), p_usuario_win CHAR(50))
{######################################################################
#  Procedimiento:    sp_maq_verifica
#  Descripcion:      Verifica si una maquina tiene acceso a los modulos
#
#  Parametros        p_hostname          = nombre de la maquina
#  de entrada:       p_ip        = ip de la maquina
#                    p_usuario_win = usuario de windows
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            22 Octubre 2012   
#
#  Llamado por:      ModulosGDL       
#  Llama a:          security:sp_maq_verifica
#  
######################################################################}
	returning 
int AS estatus,
varchar(255) AS mensaje;

--Parametros de salida:
define v_estatus		int;
define v_mensaje 		varchar(255);

-- fin Parametros de Salida
--hace el llamado al procedimiento en la base se seguridad
execute PROCEDURE security:"informix".sp_maq_verifica(p_hostname,p_ip,p_usuario_win) into v_estatus,v_mensaje;

return v_estatus,v_mensaje;
END PROCEDURE
;

CREATE PROCEDURE "informix".sp_maq_registro(p_hostname CHAR(256),p_ip CHAR(25), p_usuario_win CHAR(50),p_mac varchar(255),p_modulo VARCHAR(20))
{######################################################################
#  Procedimiento:    sp_maq_registro
#  Descripcion:      Registra las maquina que tienen acceso a los modulos
#
#  Parametros        p_hostname          = nombre de la maquina
#  de entrada:       p_ip        = ip de la maquina
#                    p_usuario_win = usuario de windows
#		     p_mac =mac adress de la maquina	
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            22 Octubre 2012   
#
#  Llamado por:      sp_maq_registro       
#  Llama a:          security:sp_maq_registro
#  
######################################################################}
	returning 
int AS estatus,
varchar(255) AS mensaje;

--Parametros de salida:
define v_estatus		int;
define v_mensaje 		varchar(255);

-- fin Parametros de Salida
--hace el llamado al procedimiento en la base se seguridad
execute PROCEDURE security:"informix".sp_maq_registro(p_hostname,p_ip,p_usuario_win,p_mac,p_modulo) into v_estatus,v_mensaje;

return v_estatus,v_mensaje;
END PROCEDURE
;

create procedure "informix".spd_17_padronconv(prec int)
returning   varchar(30) as tipo,
            varchar(30) as subtipo,
            varchar(20) as convenio,
            varchar(60) as nombre,
            varchar(10) as vigencia,
            date as fecha_otorg,
            smallint as plazo,
            varchar(20) as tipo_plazo,
            money(16,2) as cantidad,
            date as primer_pago,
            money(16,2) as importe_primerpago,
            smallint as pagos_realizados,
            money(16,2) as importe_pagado,
            smallint as parc_adeudo,
            money(16,2) as importe_adeudo;

define v_desctipo,v_descsubt,v_nombre varchar(60);
define v_iddiver,v_idresto,v_numexp,v_axoexp,v_pagos,v_canpag,v_canade integer;
define v_letexp,v_letras char(3);
define v_costo,v_imppag,v_impade,v_importe1 money(16,2);
define v_fechaotor,v_fecha1 date;
define v_tippag,v_vig char(1);
define v_vigencia varchar(10);
define v_convenio,v_tipo_plazo varchar(20);

let v_tipo_plazo='';
let v_convenio='';
let v_letras='';
let v_vigencia='';
let v_impade=0;
let v_canade=0;

if prec=1 then let v_letras='ZC1';
else if prec=2 then let v_letras='ZO2';
else if prec=3 then let v_letras='ZO3';
else if prec=4 then let v_letras='ZM4';
else if prec=5 then let v_letras='ZC5'; 
end if; end if; end if; end if; end if;

foreach
select i.descripcion,d.desc_subtipo,a.id_conv_diver,b.id_conv_resto,a.letras_exp,a.numero_exp,a.axo_exp,b.nombre,
b.vigencia,b.fecha_inicio,(b.total_pagos+1),b.tipo_pago,b.cantidad_total,count(c.id_conv_resto),nvl(sum(c.importe_pago),0)
into v_desctipo,v_descsubt,v_iddiver,v_idresto,v_letexp,v_numexp,v_axoexp,v_nombre,
v_vig,v_fechaotor,v_canpag,v_tippag,v_costo,v_pagos,v_imppag
from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer (ta_17_conv_pagos c),ta_17_subtipo_conv d,ta_17_tipos i
where a.letras_exp=v_letras 
and a.tipo=b.tipo and a.id_conv_diver=b.id_conv_diver and b.id_conv_resto=c.id_conv_resto
and a.tipo=d.tipo and a.subtipo=d.subtipo and a.tipo=i.tipo
group by i.descripcion,d.desc_subtipo,a.id_conv_diver,b.id_conv_resto,a.letras_exp,a.numero_exp,a.axo_exp,
b.nombre,b.vigencia,b.fecha_inicio,11,b.tipo_pago,b.cantidad_total
order by a.letras_exp,a.axo_exp,a.numero_exp 

let v_convenio=trim(v_letexp)||'-'||v_numexp||'/'||v_axoexp;

if v_vig='A' then let v_vigencia='VIGENTE';
else if v_vig='P' then let v_vigencia='PAGADO';
else if v_vig='B' then let v_vigencia='BAJA';
end if; end if; end if;

if (trim(v_tippag)='M' or trim(v_tippag)='m') then
   let v_tipo_plazo='MENSUAL';
else
if (trim(v_tippag)='Q' or trim(v_tippag)='q') then
   let v_tipo_plazo='QUINCENAL';
else 
if (trim(v_tippag)='S' or trim(v_tippag)='s') then
   let v_tipo_plazo='SEMANAL';
else
  let v_tipo_plazo='';
end if; 
end if;
end if;

select fecha_pago,importe_pago into v_fecha1,v_importe1 
from ta_17_conv_pagos where id_conv_resto=v_idresto and pago_parcial=1;

select nvl(count(id_adeudo),0),nvl(sum(importe),0) into v_canade,v_impade 
from ta_17_adeudos_div where id_conv_resto=v_idresto and clave_pago is null;

return v_desctipo,v_descsubt,v_convenio,v_nombre,v_vigencia,v_fechaotor,v_canpag,v_tipo_plazo,v_costo,
v_fecha1,v_importe1,v_pagos,v_imppag,v_canade,v_impade with resume;
end foreach;
end procedure;

create function "informix".fn_getademerc(fid int,faxo int,fmes int)
returning money(16,2) as ADEUDO;

define v_adeudo money(16,2);

select nvl(sum(importe),0) into v_adeudo
from ta_11_adeudo_local 
where  id_local=fid and axo=faxo and periodo<=fmes;

return v_adeudo;
end function;

create function "informix".fn_getrecmerc(fid int,faxo int,fmes int)
returning money(16,2) as RECARGOS;

define v_recargos,v_multa,v_gastos,v_recargostotal,v_aimporte money(16,2);
define v_folio,v_aid_local,v_aaxo,v_aperiodo,v_dmes,v_merc,v_desc,v_primermes int;
define v_porc decimal(7,2);
define v_fecha_desc,v_fecha_rec date;

select num_mercado,nvl(id_contribuy_renta,0) into v_merc,v_desc
from ta_11_locales where id_local=fid;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=fid and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=fid and axo=faxo and periodo<=fmes 
and b.mes=month(today)
order by axo,periodo
if v_merc =214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
end if;

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if v_merc <>214 then
   if today>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   end if;
else 
   if v_aperiodo=1 then let v_primermes=1;
   else if v_aperiodo=2 then let v_primermes=4;
   else if v_aperiodo=3 then let v_primermes=7;
   else if v_aperiodo=4 then let v_primermes=10;
   else let v_primermes=0;
   end if;
   end if;
   end if;
   end if;

   if v_primermes=month(today) then
      if today>=v_fecha_rec then
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
      else
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                 (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
      end if;
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
    end if;
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

return v_recargostotal;
end function;

CREATE PROCEDURE "saranda".sp_auxiliares(par_fecha date, par_fecha2 date, par_rec1 int,par_rec2 int, par_cuenta integer)
                            returning date as fecha, integer as ofna, char(2) as caja, integer as operac,
                            money(16,2) as totalcer, integer as recaud, char(1) as tiporeg, char(6) as cta_ctrol,
                            integer as dvcta, integer as numero, integer as colonia, integer as obra, char(3) as letra,
                            integer as axo_fol, varchar(60,0) as nombre, varchar(60,0) as concepto, char(2) as tipo_rbo,
                            int as docum, int as mes_des ,int as ax_des, int as mes_has, int as axo_has, money(16,2) as impte,
                            int as cta_aplic, varchar(60) as descrip, varchar(20,0) as zona, varchar(60) as nom_rbo, varchar(60) as dom_rbo, 
                            varchar(60) as con_rbo;



define v_fecing 	date;
define v_rec 	integer;
define v_caja	char(2);
define v_oper	integer;
define v_totalc	money(16,2);
define v_recid	integer;
define v_tipoid	char(1);
define v_ctaid	char(6);
define v_dvcta	integer;
define v_numero	integer;
define v_colonia	integer;
define v_obra	integer;
define v_letra	char(3);
define v_axofol	integer;
define v_nombre	varchar(60,0);
define v_concep	varchar(60,0);
define v_trbo	char(2);
define v_documen	int;
define v_mesdes	int;
define v_axodes	int;
define v_meshas	int;
define v_axohas	int;
define v_impte	money(16,2);
define v_ctaapl	int;
define v_nomzona	varchar(20,0);
define v_nomrec	varchar(60,0);
define v_conrec	varchar(60,0);
define v_domrec	varchar(60,0);
define v_descrip	varchar(60,0);


foreach
  select unique fecing, recing, cajing, opcaja
  into  v_fecing, v_rec, v_caja, v_oper
  from  cg_12_importes
  where fecing >=par_fecha  and fecing <= par_fecha2 and recing >=par_rec1 and recing <=par_rec2 and 
        cta_aplicacion =par_cuenta
  order by 1,2,3,4
    
     select nombre, domicilio, concepto
     into v_nomrec, v_domrec, v_conrec
	 from ta_12_recibos	
     where fecha =v_fecing and id_rec =v_rec  and caja=v_caja and operacion=v_oper;
     
     select d.zona 
     into v_nomzona 
     from ta_12_recaudadoras c, ta_12_zonas d
     where c.id_rec=v_rec and c.id_zona=d.id_zona;
     
     select totcertificado, rec_id,tipo_id,cuenta_id,dvcta_id,numero,colonia,obra, letras, axofol,nombre,concepto,tipo_rbo
     into v_totalc, v_recid, v_tipoid, v_ctaid, v_dvcta, v_numero, v_colonia, v_obra, v_letra, v_axofol, v_nombre, v_concep, v_trbo
     from cg_12_ingreso	
     where fecing =v_fecing and recing =v_rec  and cajing=v_caja and opcaja=v_oper;
     
    foreach
      select documento, mes_desde, axo_desde, mes_hasta, axo_hasta, importe_cta, cta_aplicacion  
      into  v_documen, v_mesdes, v_axodes, v_meshas, v_axohas, v_impte, v_ctaapl  
      from cg_12_importes
      where fecing =v_fecing  and recing =v_rec and cajing =v_caja and opcaja=v_oper

      select descripcion 
      into v_descrip 
      from cg_12_cuentas
      where cta_aplicacion=v_ctaapl;
     
      return   v_fecing,v_rec,v_caja,v_oper, v_totalc, v_recid, v_tipoid, v_ctaid, v_dvcta, v_numero, v_colonia, v_obra, v_letra, v_axofol, v_nombre,
               v_concep, v_trbo, v_documen,v_mesdes,v_axodes,v_meshas,v_axohas,v_impte, v_ctaapl ,v_descrip, v_nomzona, v_nomrec,v_domrec,v_conrec
      with resume;

    end foreach;
end foreach;
end procedure;

create procedure "informix".fn_mtomesing(p_cta_aplicacion int , p_axomes int)
  RETURNING money(15,2) as monto  ;

   define v_monto money(15,2); 
   define v_doctos int;

select sum(numero_doctos) , sum(importe) 
  into v_doctos , v_monto 
 from ta_12_ingresoanual
where cta_aplicacion = p_cta_aplicacion and axo_mes = p_axomes;

  if v_monto is null then
     let v_monto = 0;
  end if; 
     RETURN  v_monto ;
  
end procedure;

create procedure "informix".fn_doctmesing(p_cta_aplicacion int , p_axomes int)
  RETURNING int as doctos  ;

   define v_monto money(15,2); 
   define v_doctos int;

select sum(numero_doctos) , sum(importe) 
  into v_doctos , v_monto 
 from ta_12_ingresoanual
where cta_aplicacion = p_cta_aplicacion and axo_mes = p_axomes;

  if v_doctos is null then
     let v_doctos = 0;
  end if; 
     RETURN  v_doctos ;
  
end procedure;

create procedure "saranda".sp_recar_cem()
           returning int as s_axo, int as s_mes, int as s_porc;

define v_axo int;
define v_mes int;
define v_porc dec(5,2);
define v_ind int;

create temp table ta_recar(
axo       int,
mes       smallint,
porc      dec(5, 2))   with no log;

let v_ind=1;

while v_ind<13 
foreach
 select r.axo,((select sum(porcentaje_parcial)
 from ta_13_recargosrcm where axo>=r.axo and axo<2013)+
 (select sum(porcentaje_parcial) from ta_13_recargosrcm where axo=2013 and mes between 1 and v_ind))
into v_axo,v_porc
 from ta_13_recargosrcm r 
 where axo between 2004 and 2012
 group by 1

 if v_porc >100 then
    let v_porc=100 ;
 end if; 

 insert into ta_recar values(v_axo,v_ind,v_porc);
end foreach;
 let v_ind=v_ind+1;

end while;

foreach
select axo,mes,porc 
into v_axo,v_mes,v_porc
from ta_recar
order by axo,mes

update ta_13_recargosrcm set porcentaje_global=v_porc where axo=v_axo and mes=v_mes;

return v_axo, v_mes, v_porc with resume;
end foreach;
drop table ta_recar;
 end procedure;

CREATE PROCEDURE "informix".sp_13_generapens(controld int,controlh int)
                returning varchar(100);  
define      Vcontrol_des    int;
define      Vcontrol_rcm	INTEGER;
define      Vaxo_alta   	INTEGER;
define      Vdecuento   	INTEGER;
define      Vusuario    	INTEGER;
define      Vfecha_mov  	DATE;
define      Vaxo_ini    	INTEGER;
define      vini    	INTEGER;
define      vreac    	int;

let vini=0;
let vreac=0;
foreach
select  control_rcm, axo_descto,descuento
into   Vcontrol_rcm, Vaxo_alta,vdecuento
from ta_13_descpens  where vigencia='V' and control_rcm between controld and controlh and axo_descto=2013
if exists(select * from ta_13_adeudosrcm where control_rcm=vcontrol_rcm and axo_adeudo=vaxo_alta) then
   update ta_13_adeudosrcm  set descto_impote=(importe*vdecuento/100) where control_rcm=vcontrol_rcm and axo_adeudo=vaxo_alta;
    let vini= vini+1;

--else
--   update ta_13_descpens  set vigencia='P' where control_rcm=vcontrol_rcm and axo_descto=vaxo_alta;
--    let vreac= vreac+1;
end if; 
end foreach;
return 'desc '||vini||' paga '||vreac;
end procedure;

CREATE PROCEDURE "saranda".spd_estadcobro(
    		parAxod	   date, parAxoh	   date)
	               	returning     smallint as recaudadora,
	 		char(30) as descripcion,
	 		integer as recibos,
		 	money(15,2) as importe,
	 		integer as aporta,
		 	money(15,2) as importe_apo;

 define vparrec  		smallint;
 define vpardesc 	               char(30);
 define vparCuenta 		integer;
  define vparImporte 	money(15,2);
define vparCuenta_a 		integer;
  define vparImporte_a 	money(15,2);
 define vmod  		smallint;

foreach
      SELECT a.id_rec, b.descrip, id_modulo,count(*), sum(a.importe)
      into   vparrec, vpardesc, vmod, vparCuenta, vparImporte
      from         ta_12_recibos a , outer ta_12_tiporecibo b
     where      a.fecha between parAxod and paraxoh and a.cvepago='P' and id_modulo=tipo
     group by   1,2,3
     order by 1,3
     if (vmod = 5 or vmod=9) then
   select  count(*), nvl(sum(d.importe),0)
    into  vparCuenta_a, vparImporte_a
    from ta_12_recibos r, ta_12_recibosdet d 
     where d.cuenta in(991700001, 992100027)
     and   r.fecha=d.fecha and r.id_rec=d.id_rec and r.caja=d.caja and r.operacion=d.operacion 
     and   d.fecha between parAxod and paraxoh and d.id_rec = vparrec and r.id_modulo=vmod and r.cvepago='P' 
     and d.importe>0;
     else
     let vparCuenta_a=0;
       let vparImporte_a=0;
   end if;
return   	vparrec,vpardesc,vparCuenta,vparImporte,vparCuenta_a, vparImporte_a
with resume;
end foreach;
foreach
      SELECT 9, b.descrip, id_modulo, count(*), sum(a.importe)
      into   vparrec, vpardesc,vmod, vparCuenta, vparImporte
      from         ta_12_recibos a , outer ta_12_tiporecibo b
     where      a.fecha between parAxod and paraxoh and a.cvepago='P' and id_modulo=tipo
     group by   1,2,3
     order by 1,3

     if (vmod = 5 or vmod=9) then
     select  count(*), nvl(sum(d.importe),0)
    into  vparCuenta_a, vparImporte_a
    from ta_12_recibos r, ta_12_recibosdet d 
     where d.cuenta in(991700001, 992100027)
     and   r.fecha=d.fecha and r.id_rec=d.id_rec and r.caja=d.caja and r.operacion=d.operacion 
    and   d.fecha between parAxod and paraxoh  and r.cvepago='P' and r.id_modulo=vmod and d.importe>0;
    else
    let vparCuenta_a=0;
      let vparImporte_a=0;
  end if;

return   	vparrec,vpardesc,vparCuenta,vparImporte,vparCuenta_a, vparImporte_a
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".linea_pago(
    p_linea VARCHAR(50),
    p_recaud INT,
    p_fecha_pagobco DATE,
    p_pagado MONEY(16,2),
    p_cvepago INT,
    p_fecha_pago DATE,
    p_id_rec SMALLINT,
    p_caja CHAR(2),
    p_operacion INT,
    p_usuario CHAR(8)
)
--** p_recaud es el numero de banco que se le asigno en C_recaud 100-119
--** Forma de carga C=Cajas Recaudadora, A=Archivo Banco
--** p_bco_recibo,p_bco_suc,p_bco_caj,p_bco_oper datos de recibo bancario si cuenta con ellos o vacios
--** p_bco_lineatxt es la linea completa del archivo, vacio se es por caja
--** ESTATUS para linea_pago C=carga, A=aplicado, N=conciliado sin error, D=diferencia en importes 
returning int,varchar(200);
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_id int;
define v_linea VARCHAR(50);
define v_id_linea int;
define v_folio int;
define v_foliotrans int;
define v_modulo int;
define v_id_cont int;
define v_estatus char(1);
define v_fecha_pago date;
define v_fecha_impresion datetime year to second;
define v_importe money(16,2);
define v_cvepago char(1);
define v_importe_conc money(16,2);
define v_fecha_concilia datetime year to second;
define v_forma_carga char(1);

--set debug file to "lineacap.log";
--   trace on;
--** Obtener datos de la linea de captura
--3538 4610 9610 0000 0101 8512 1278 '0000070000000000011285116291'

let v_modulo = substr(p_linea,19,2)*1;


if v_modulo = 1 then --predial
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturapred where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO EXISTE";
   end if;
   --obtener los datos del registro de predial  
   select id,linea,cvecuenta,total into 
	  v_id_linea,v_linea,v_folio,v_importe
          from catastro_gdl:linea_capturapred where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion,forma_carga into v_id,v_estatus,v_fecha_pago,v_fecha_impresion,v_forma_carga
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus <> "N" then --No esta conciliada correctamente
	 let estatus = 8;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO ESTA CONCILIADA CORRECTAMENTE";
         return estatus,mensaje;
      end if;
      --actualiza pago, lo deja como pago aplicado
      if v_forma_carga="C" then --cuando se cargan por cajas de recaudadora
         let v_fecha_impresion = current;
      else 
         let v_fecha_impresion = null;
      end if;
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			estatus="A" ,
     			cvepago=p_cvepago ,
     			fecha_pago=p_fecha_pago ,
     			id_rec=p_id_rec ,
     			caja= p_caja,
     			operacion=p_operacion ,
                        fecha_impresion = v_fecha_impresion,
     			usuario=p_usuario
	 where id = v_id;
         let estatus = 0;
         let mensaje = "RECIBO DE PREDIAL CORRECTO, PAGO APLICADO";
         return estatus,mensaje;
   else --si no esta cargada la linea de captura en pagos
      return 9,"LA LINEA DE CAPTURA NO SE HA CARGADO";
   end if;--no existe linea captura en pagos
end if; --modulo 1 predial


if v_modulo = 2 then --transmisiones
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturatrans where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE TRANSMISION NO EXISTE";
   end if;
   --obtener los datos del registro de transmision
   select id,linea,cvecuenta,folio,total into 
	  v_id_linea,v_linea,v_folio,v_foliotrans,v_importe  
          from catastro_gdl:linea_capturatrans where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    

   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion,forma_carga into v_id,v_estatus,v_fecha_pago,v_fecha_impresion,v_forma_carga
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus <> "N" then --No esta conciliada correctamente
	 let estatus = 8;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO ESTA CONCILIADA CORRECTAMENTE";
         return estatus,mensaje;
      end if;
      --actualiza pago, lo deja como pago aplicado
      if v_forma_carga="C" then --cuando se cargan por cajas de recaudadora
         let v_fecha_impresion = current;
      else 
         let v_fecha_impresion = null;
      end if;
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			estatus="A" ,
     			cvepago=p_cvepago ,
     			fecha_pago=p_fecha_pago ,
     			id_rec=p_id_rec ,
     			caja= p_caja,
     			operacion=p_operacion ,
                        fecha_impresion = v_fecha_impresion,
     			usuario=p_usuario
	 where id = v_id;
         let estatus = 0;
         let mensaje = "RECIBO DE TRANSMISION CORRECTO, PAGO APLICADO";
         return estatus,mensaje;
   else --si no esta cargada la linea de captura en pagos
      return 9,"LA LINEA DE CAPTURA NO SE HA CARGADO";
   end if;--no existe linea captura en pagos
end if; --modulo 2 TRANSMISIONES

if v_modulo = 8 then --licencias
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturalic where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE LICENCIA NO EXISTE";
   end if;
   --obtener los datos del registro de licencias
   select id,linea,licencia,total into 
	  v_id_linea,v_linea,v_folio,v_importe  
          from catastro_gdl:linea_capturalic where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    

   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion,forma_carga into v_id,v_estatus,v_fecha_pago,v_fecha_impresion,v_forma_carga
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus <> "N" then -- No esta conciliada correctamente
	 let estatus = 8;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO NO ESTA CONCILIADA CORRECTAMENTE";
         return estatus,mensaje;
      end if;
      --actualiza pago, lo deja como pago aplicado
      if v_forma_carga="C" then --cuando se cargan por cajas de recaudadora
         let v_fecha_impresion = current;
      else 
         let v_fecha_impresion = null;
      end if;
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			estatus="A" ,
     			cvepago=p_cvepago ,
     			fecha_pago=p_fecha_pago ,
     			id_rec=p_id_rec ,
     			caja= p_caja,
     			operacion=p_operacion ,
                        fecha_impresion = v_fecha_impresion,
     			usuario=p_usuario
	 where id = v_id;
         let estatus = 0;
         let mensaje = "RECIBO DE  LICENCIA/ANUNCIO CORRECTO, PAGO APLICADO";
         return estatus,mensaje;
   else --si no esta cargada la linea de captura en pagos
      return 9,"LA LINEA DE CAPTURA NO SE HA CARGADO";
   end if;--no existe linea captura en pagos
end if; --modulo 8 licencias

if v_modulo = 12 then
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from linea_capturadiv where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE DIVERSOS NO EXISTE";
   end if;
   --obtener los datos del registro de diversos  
   select id,linea,modulo,folio,total into 
	  v_id_linea,v_modulo,v_folio,v_importe,v_linea 
          from linea_capturadiv where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliaciada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus <> "N" then --No esta conciliada correctamente
	 let estatus = 8;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE DIVERSOS NO ESTA CONCILIADA CORRECTAMENTE";
         return estatus,mensaje;
      end if;
      --si el estatus es N=normal (D=dif imp, C=cargado), Revisa el estatus del recibo de diversos
      if exists (select * from ta_12_recibosdiv where id_recibo=v_folio) then
	 select importe,cvepago into v_importe,v_cvepago  from ta_12_recibosdiv where id_recibo=v_folio; 
         if v_cvepago = "P" then
            return 5,"EL RECIBO DE DIVERSOS YA FUE PAGADO";
         end if;
         if v_importe <> p_pagado then
           -- let v_estatus = "D";
	   -- let v_fecha_concilia = null;
            let estatus = 6;
	    let mensaje = "EL RECIBO DE DIVERSOS TIENE DIFERENCIA EN IMPORTE";
            return estatus,mensaje;
         end if; --v_importe <> p_pagado
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			estatus="A" ,
     			cvepago=p_cvepago ,
     			fecha_pago=p_fecha_pago ,
     			id_rec=p_id_rec ,
     			caja= p_caja,
     			operacion=p_operacion ,
     			usuario=p_usuario

	 where id = v_id;
         let estatus = 0;
         let mensaje = "EL RECIBO DE DIVERSOS CORRECTO, PAGO APLICADO";
         return estatus,mensaje;
      else		         
         return 7,"EL RECIBO DE DIVERSOS NO EXISTE";
      end if; --existe en recibosdiv

   else --si no esta cargada la linea de captura en pagos
      return 9,"LA LINEA DE CAPTURA NO SE HA CARGADO";
   end if;--no existe linea captura en pagos
end if; --modulo 12

end procedure;

create procedure "informix".spd_testtiempo()
            returning datetime hour to FRACTION ;

define v_importe money(16,2);
define v_horaini datetime hour to FRACTION;
define v_horafin datetime hour to FRACTION;
select extend(current, hour to second) into v_horaini from catastro_gdl:parametros;
return v_horaini with resume;
--let v_horaini =  extend(current, hour to FRACTION);
select sum(importe) into v_importe from ta_12_recibos where fecha between mdy(1,1,2012) and   mdy(12,11,2012);
--let v_horafin =  extend(current, hour to FRACTION);

select extend(current, hour to second) into v_horaini from catastro_gdl:parametros;
return v_horaini with resume;
end procedure;

CREATE PROCEDURE "informix".get_bimestre ( par_fecha Date)
	returning Smallint as bimestre;    	          -- Bimestre
               

{
#  Procedimiento: con_bimestre
#  Descripcion:  OBTENCION DEL BIMESTRE DE ACUERDO A CUALQUIER FECHA CAPTURADA
#  Parametros de entrada: Fecha
#  Parametros de salida:  bimestre
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

define v_bim	smallint;
define v_fecha	Date;

Let v_fecha = par_fecha;
if (Month(v_fecha) = 1) then Let v_bim = 1;  end if;
if (Month(v_fecha) = 2) then Let v_bim = 1;  end if;
if (Month(v_fecha) = 3) then Let v_bim = 2; end if;
if (Month(v_fecha) = 4) then Let v_bim = 2; end if;
if (Month(v_fecha) = 5) then Let v_bim = 3; end if;
if (Month(v_fecha) = 6) then Let v_bim = 3; end if;
if (Month(v_fecha) = 7) then Let v_bim = 4; end if;
if (Month(v_fecha) = 8) then Let v_bim = 4; end if;
if (Month(v_fecha) = 9) then Let v_bim = 5; end if;
if (Month(v_fecha) = 10) then Let v_bim = 5; end if;
if (Month(v_fecha) = 11) then Let v_bim = 6; end if;
if (Month(v_fecha) = 12) then Let v_bim = 6; end if;

RETURN v_bim;

end procedure;

create procedure "informix".spd_12_grupodiv(p_cuenta int,p_fecha date,p_rec int,p_caja char(2),p_oper int)
returning   smallint as estado,
            varchar(100) as descripcion;

define v_cuenta int;
define v_idmodulo int;

if not exists(select * from ta_12_recibos where fecha=p_fecha and id_rec=p_rec 
              and caja=p_caja and operacion=p_oper) then
   return 1,'NO EXISTE LA OPERACION DE CAJA';
else
   if not exists(select * from cg_12_cuentas where cta_aplicacion=p_cuenta) then
      return 1,'NO EXISTE LA CUENTA DE APLICACION';
   end if;
   select cta_aplicacion,nvl(id_modulocat,12) into v_cuenta,v_idmodulo
     from cg_12_cuentas where cta_aplicacion=p_cuenta;
 
   update ta_12_recibos set grupo=v_idmodulo 
     where fecha=p_fecha and id_rec=p_rec and caja=p_caja and operacion=p_oper;
   return 0,'AFECTACION CORRECTA DE GRUPO';
end if;

end procedure;

create procedure "informix".ldopercaja(p_fecha date) 
    RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_contfecha int;
define v_fechatime datetime year to fraction(3) ;



   begin
    on exception in (-310)
       let v_id_modulo = 0;
       let v_descripcion ='ESPERE UN MOMENTO....VUELVA A INTENTAR';
       let v_cantidad = 0; let v_importe = 0; let v_fechatime = CURRENT year to fraction(3);
      return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   ;
  
    end exception;  
     foreach 
     select x0.id_modulo ,x1.descripcion ,count(*) ,sum(x0.importe ) , CURRENT year to fraction(3) 
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
     from ta_12_recibos x0 , ta_12_moduloscat x1 
     where (((x0.fecha = p_fecha ) AND (x0.cvepago = 'P' ) ) AND (x1.id_modulo = x0.id_modulo ) ) and x0.id_modulo <> 15
     group by x0.id_modulo ,   x1.descripcion 
    let v_contfecha = 0;
    select count(*) into v_contfecha from   ta12_ingrexmodulo where modulo = v_id_modulo and fecha = p_fecha ;
     if v_contfecha > 0 then

       update ta12_ingrexmodulo set operaciones = v_cantidad, importe = v_importe,  fecha_act = today
       where modulo = v_id_modulo and fecha = p_fecha;

    else
     insert into ta12_ingrexmodulo (modulo,  fecha , operaciones, importe,  fecha_act) 
    values (v_id_modulo , p_fecha, v_cantidad , v_importe , v_fechatime);
    end if;
    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach
end ;
 
end procedure;

create procedure "informix".spd_11_padultimanr(pemi1 date,pemi2 date, paxo int,pmes int)
returning   varchar(60) as mercado,
            smallint as rec,
            smallint as merc,
            smallint as cat,
            char(2) as seccion,
            integer as local,
            char(1) as letra,
            char(1) as bloque,
            varchar(60) as nombre,
            varchar(20) as estado,
            smallint as axoinicial,
            smallint as meses,
            money(16,2) as adeudo,
            integer as not1,
            date as emitido_not1,
            date as pract_not1,
            char(1) as estado_not1,
            char(1) as vigencia_not1,
            integer as not2,
            date as emitido_not2,
            date as pract_not2,
            char(1) as estado_not2,
            char(1) as vigencia_not2,
            integer as req1,
            date as emitido_req1,
            date as pract_req1,
            char(1) as estado_req1,
            char(1) as vigencia_req1,
            integer as req2,
            date as emitido_req2,
            date as pract_req2,
            char(1) as estado_req2,
            char(1) as vigencia_req2;

define v_idlocal,v_rec,v_merc,v_cat,v_local,v_meses,v_axoini,v_bloqueo integer;
define v_mercado,v_nombre varchar(60);
define v_sec char(2);
define v_let,v_blq,v_estn1,v_estn2,v_estr1,v_estr2,v_vign1,v_vign2,v_vigr1,v_vigr2,v_est,v_vig char(1);
define v_adeudo money(16,2);
define v_estado varchar(20);
define v_not1,v_not2,v_fol,v_req1,v_req2,v_contador,v_totnot,v_totreq integer;
define v_pracn1,v_pracn2,v_pra,v_emi,v_pracr1,v_pracr2 date;
define v_emin1,v_emin2,v_emir1,v_emir2 date;

foreach
select a.id_local,b.descripcion,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,
  a.nombre,a.bloqueo,nvl(sum(d.importe),0),nvl(count(d.id_adeudo_local),0)
  into v_idlocal,v_mercado,v_rec,v_merc,v_cat,v_sec,v_local,v_let,v_blq,v_nombre,v_bloqueo,v_adeudo,v_meses 
  from ta_11_locales a, ta_11_mercados b,outer ta_11_adeudo_local d
  where b.num_mercado_nvo not in(99,214) and a.vigencia='A'
  and (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo)) 
  and b.num_mercado_nvo=a.num_mercado and d.id_local=a.id_local 
  group by a.id_local,b.descripcion,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,
a.letra_local,a.bloque,a.nombre,a.bloqueo
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque
 
if v_bloqueo=1 then
   let v_estado='CONVENIADO';
else
   let v_estado='';
end if;

-- verifica el periodo inicial de adeudo
select nvl(min(axo),0) into v_axoini from ta_11_adeudo_local where id_local=v_idlocal
  and (axo<paxo  or (periodo<=pmes and axo=paxo)); 

-- verifica los ultimos 2 folios de notificaciones 
let v_not1=0;
let v_not2=0;
let v_estn1=0;
let v_estn2=0;
let v_vign1=0;
let v_vign2=0;
let v_emin1=null;
let v_emin2=null;
let v_pracn1=null;
let v_pracn2=null;
let v_totnot=0;
if exists (select * from ta_15_apremios where modulo=11 and control_otr=v_idlocal and diligencia='N'
   and (fecha_emision between pemi1 and pemi2)) then
   foreach
   select fecha_emision,folio,fecha_practicado,clave_practicado,vigencia into v_emi,v_fol,v_pra,v_est,v_vig
     from   ta_15_apremios where modulo=11 and control_otr=v_idlocal and diligencia='N'
     and (fecha_emision between pemi1 and pemi2)
     order by fecha_emision desc,folio desc
   let v_totnot=v_totnot+1;
   if v_totnot =1 then 
      let v_not1=v_fol;
      let v_emin1=v_emi;
      let v_pracn1=v_pra;
      let v_estn1=v_est;
      let v_vign1=v_vig;
   else
      if v_totnot =2 then
         let v_not2=v_fol;
         let v_emin2=v_emi;
         let v_pracn2=v_pra;
         let v_estn2=v_est;
         let v_vign2=v_vig;
      end if;
   end if;
   end foreach; -- cierre de notificaciones
end if;
-- verifica los ultimos 2 folios de requerimientos 
let v_req1=0;
let v_req2=0;
let v_estr1=0;
let v_estr2=0;
let v_vigr1=0;
let v_vigr2=0;
let v_emir1=null;
let v_emir2=null;
let v_pracr1=null;
let v_pracr2=null;
let v_totreq=0;
if exists (select * from ta_15_apremios where modulo=11 and control_otr=v_idlocal and diligencia='R'
   and (fecha_emision between pemi1 and pemi2)) then
   foreach
   select fecha_emision,folio,fecha_practicado,clave_practicado,vigencia into v_emi,v_fol,v_pra,v_est,v_vig
     from   ta_15_apremios where  modulo=11 and control_otr=v_idlocal and diligencia='R'
     and (fecha_emision between pemi1 and pemi2)
     order by fecha_emision desc,folio desc
   let v_totreq=v_totreq+1;
   if v_totreq =1 then 
      let v_req1=v_fol;
      let v_emir1=v_emi;
      let v_pracr1=v_pra;
      let v_estr1=v_est;
      let v_vigr1=v_vig;
   else
      if v_totreq =2 then
         let v_req2=v_fol;
         let v_emir2=v_emi;
         let v_pracr2=v_pra;
         let v_estr2=v_est;
         let v_vigr2=v_vig;
      end if;
   end if;
   end foreach; -- cierre de requerimientos
end if;
return v_mercado,v_rec,v_merc,v_cat,v_sec,v_local,v_let,v_blq,v_nombre,v_estado,v_axoini,v_meses,v_adeudo,
v_not1,v_emin1,v_pracn1,v_estn1,v_vign1,v_not2,v_emin2,v_pracn2,v_estn2,v_vign2,
v_req1,v_emir1,v_pracr1,v_estr1,v_vign1,v_req2,v_emir2,v_pracr2,v_estr2,v_vigr2
with resume;
end foreach; 

end procedure;

create procedure "informix".spd_17_adeudoscont (p_axo int,p_opc char(1))
returning   smallint as obra,
            smallint as colonia,
            smallint as calle,
            integer as folio,
            varchar(60) as nombre,
            date as inicial,
            date as vencimiento,
            money(16,2) as costo,
            money(16,2) as pagos,
            money(16,2) as adeudo,
            varchar(20) as estado,
            varchar(40) as ampliacion;

define v_idconv,v_obra,v_calle,v_colonia,v_folio,v_aoficio integer;
define v_fecini,v_fecfin,v_inicioamp,v_finamp,v_fecpago,v_inicial,v_vencimiento date;
define v_nombre varchar(60);
define v_adeudo,v_pagototal,v_totampliacion,v_imppago,v_impdevolucion,v_costo,v_pagos money(16,2);
define v_recant,v_recnvo money(16,2);
define v_ampliacion varchar(40);
define v_estado varchar(20);
define v_cvedesc,v_oper,v_historia smallint;
define v_foficio varchar(6);
let v_estado='';
foreach
select a.id_convenio,a.colonia,a.calle,a.folio,a.nombre,a.fecha_firma,a.fecha_vencimiento,a.pago_total,
  a.clave_historia,f.axo_obra 
  into v_idconv,v_colonia,v_calle,v_folio,v_nombre,v_fecini,v_fecfin,v_pagototal,v_historia,v_obra
  from ta_17_convenios a,ta_17_calles f
  where f.axo_obra=p_axo and a.vigencia='A'
  and a.colonia=f.colonia and a.calle=f.calle  
  order by a.colonia,a.calle,a.folio
let v_pagos=0;
let v_adeudo=0;
let v_imppago=0;
let v_recant=0;
let v_recnvo=0;
let v_impdevolucion=0;
if not exists (select * from ta_17_amp_plazo where id_convenio=v_idconv and vigencia='A') then
   if v_historia=2 then
      let v_ampliacion='PROG. REGULARIZACION DE ADEUDOS';
      select nvl(count(*),0),nvl(sum(importe),0),nvl(sum(cve_descuento),0),nvl(sum((select sum(importe_cta) 
        from ta_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
        and opcaja=a.operacion_pago and a.fecha_pago<=v_fecfin and cta_aplicacion=46210)),0),nvl(sum((select sum(importe_cta) 
        from cg_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
        and opcaja=a.operacion_pago and a.fecha_pago<=v_fecfin and cta_aplicacion=570200000)),0)  
        into v_oper,v_imppago,v_cvedesc,v_recant,v_recnvo
        from ta_17_pagos a where a.id_convenio=v_idconv and fecha_pago>=v_fecini;
   else
      let v_ampliacion='CONTRATO ORIGINAL';
      select nvl(count(*),0),nvl(sum(importe),0),nvl(sum(cve_descuento),0),0,0  
        into v_oper,v_imppago,v_cvedesc,v_recant,v_recnvo
        from ta_17_pagos a where a.id_convenio=v_idconv;
   end if;
   let v_inicial=v_fecini;
   let v_vencimiento=v_fecfin;
   select nvl(sum(importe),0) into v_impdevolucion from ta_17_devoluciones where id_convenio=v_idconv;
   if (v_oper=1) and (v_cvedesc=20) then
      let v_adeudo=0;
      let v_pagos=v_imppago;
      let v_estado='PAGO CON DESCUENTO';
   else
      let v_pagos=(v_imppago + v_recant + v_recnvo) - v_impdevolucion;
      let v_adeudo=v_pagototal - v_pagos;
      if v_adeudo=0 then
         let v_estado='LIQUIDADO';
      else
      if v_adeudo<0 then
         let v_estado='SALDO A FAVOR';
      else
         let v_estado='ADEUDO';
      end if;
      end if;
   end if; 
   let v_costo=v_pagototal;
else
   select nvl(sum(importe),0) into v_impdevolucion from ta_17_devoluciones where id_convenio=v_idconv;
   foreach
   select axo_oficio,folio_oficio,total,fecha_inicio,fecha_fin 
     into v_aoficio,v_foficio,v_totampliacion,v_inicioamp,v_finamp
     from ta_17_amp_plazo where id_convenio=v_idconv and vigencia='A'
     order by axo_oficio,folio_oficio
   end foreach;
   if v_fecfin<v_inicioamp then
      let v_ampliacion='AMPLIACION DE PLAZO';
      select nvl(count(*),0),nvl(sum(importe),0),nvl(sum(cve_descuento),0),nvl(sum((select sum(importe_cta) 
        from ta_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
        and opcaja=a.operacion_pago and a.fecha_pago<=v_finamp and cta_aplicacion=46210)),0),nvl(sum((select sum(importe_cta) 
        from cg_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
        and opcaja=a.operacion_pago and a.fecha_pago<=v_finamp and cta_aplicacion=570200000)),0)
        into v_fecpago,v_imppago,v_cvedesc,v_recant,v_recnvo
        from ta_17_pagos a where a.id_convenio=v_idconv and fecha_pago>=v_inicioamp;
      let v_costo=v_totampliacion;
      let v_pagos=(v_imppago + v_recant + v_recnvo) - v_impdevolucion;
      let v_adeudo=v_totampliacion - v_pagos;
      let v_inicial=v_inicioamp;
      let v_vencimiento=v_finamp;
   else
      if v_historia=2 then
         let v_ampliacion='PROG. REGULARIZACION DE ADEUDOS';
         select nvl(count(*),0),nvl(sum(importe),0),nvl(sum(cve_descuento),0),nvl(sum((select sum(importe_cta) 
           from ta_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
           and opcaja=a.operacion_pago and a.fecha_pago<=v_fecfin and cta_aplicacion=46210)),0),nvl(sum((select sum(importe_cta) 
           from cg_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
           and opcaja=a.operacion_pago and a.fecha_pago<=v_fecfin and cta_aplicacion=570200000)),0)  
           into v_oper,v_imppago,v_cvedesc,v_recant,v_recnvo
           from ta_17_pagos a where a.id_convenio=v_idconv and fecha_pago>=v_fecini;
         let v_costo=v_pagototal;
         let v_pagos=(v_imppago + v_recant + v_recnvo) - v_impdevolucion;
         let v_adeudo=v_pagototal - v_pagos;
         let v_inicial=v_fecini;
         let v_vencimiento=v_fecfin;
      else
         let v_ampliacion='CONTRATO ORIGINAL';
         select nvl(count(*),0),nvl(sum(importe),0),nvl(sum(cve_descuento),0),nvl(sum((select sum(importe_cta) 
           from ta_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
           and opcaja=a.operacion_pago and a.fecha_pago<=v_fecfin and cta_aplicacion=46210)),0),nvl(sum((select sum(importe_cta) 
           from cg_12_importes where fecing=a.fecha_pago and recing=a.oficina_pago and cajing=a.caja_pago 
           and opcaja=a.operacion_pago and a.fecha_pago<=v_fecfin and cta_aplicacion=570200000)),0)  
           into v_oper,v_imppago,v_cvedesc,v_recant,v_recnvo
           from ta_17_pagos a where a.id_convenio=v_idconv;
         let v_costo=v_pagototal;
         let v_pagos=(v_imppago + v_recant + v_recnvo) - v_impdevolucion;
         let v_adeudo=v_pagototal - v_pagos;
         let v_inicial=v_fecini;
         let v_vencimiento=v_fecfin;
      end if;
   end if;      
   if v_adeudo=0 then
      let v_estado='LIQUIDADO';
   else
   if v_adeudo<0 then
      let v_estado='SALDO A FAVOR';
   else
      let v_estado='ADEUDO';
   end if;
   end if;
end if;
if p_opc='T' then
   return v_obra,v_colonia,v_calle,v_folio,v_nombre,v_inicial,v_vencimiento,v_costo,v_pagos,v_adeudo,v_estado,v_ampliacion
   with resume;
else
if p_opc='A' then
   if v_adeudo>0 then
      return v_obra,v_colonia,v_calle,v_folio,v_nombre,v_inicial,v_vencimiento,v_costo,v_pagos,v_adeudo,v_estado,v_ampliacion
      with resume;
   end if;
else
if p_opc='L' then
   if v_adeudo=0 then
      return v_obra,v_colonia,v_calle,v_folio,v_nombre,v_inicial,v_vencimiento,v_costo,v_pagos,v_adeudo,v_estado,v_ampliacion
      with resume;
   end if;
else
if p_opc='S' then
   if v_adeudo<0 then
      return v_obra,v_colonia,v_calle,v_folio,v_nombre,v_inicial,v_vencimiento,v_costo,v_pagos,v_adeudo,v_estado,v_ampliacion
      with resume;
   end if;
end if;
end if;
end if;
end if;
end foreach;
end procedure;

CREATE PROCEDURE "saranda".spd_13_pagcaja(par_control int, par_axod smallint, par_axoh smallint, par_fecp date, par_rec smallint,
                                par_caja char(2), par_oper int,  par_importe money(15,2), par_recar money(15,2), 
                                par_usu int, par_opcion smallint)

RETURNING int as sbien,
          varchar(255) as mensage;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);
define vcvepago     int;
define v_axop     int;
define v_axof     int;


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'spd_13_pagcaja ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

if par_opcion=1 then
   SELECT cementerio, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa 
   into  v_cem, v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa
   FROM ta_13_datosrcm where control_rcm=par_control;

   let v_axof=0;

   SELECT axofin
   into  v_axof
   FROM ta_13_descrec where id_folio =par_control and vigencia='V';

   INSERT INTO ta_13_pagosrcm  VALUES(par_fecp, par_rec, par_caja, par_oper, 0, par_control, v_cem, v_clase, v_calfa, v_seccion, v_salfa, 
        v_linea, v_lalfa, v_fosa, v_falfa, par_axod, par_axoh, par_importe, par_recar, 'A', par_usu, today);

   let vcvepago=dbinfo("sqlca.sqlerrd1");

   update ta_13_adeudosrcm set  vigencia='P', id_pago=vcvepago
     where control_rcm=par_control and axo_adeudo between par_axod and par_axoh and vigencia='V';

   if par_axoh>=v_axof then
      update ta_13_descrec
      set vigencia='P', fec_pag=par_fecp, id_rec=par_rec, caja=par_caja, operac=par_oper 
      where id_folio =par_control and vigencia='V';
   end if;
  
    update ta_13_datosrcm set axo_pagado=par_axoh where control_rcm=par_control;
 
    update ta_13_descpens set vigencia='P' where control_rcm=par_control and axo_descto between par_axod and par_axoh and vigencia='V';
 
 return 0,'Pagado ' || vcvepago;

end if; 

 

if par_opcion=2 then   

  select control_id into vcvepago from ta_13_pagosrcm  
  where control_rcm=par_control and fecing=par_fecp and recing=par_rec and cajing=par_caja and opcaja=par_oper;

   update ta_13_adeudosrcm set  vigencia='V',id_pago=0
     where control_rcm=par_control  and vigencia='P' and id_pago=vcvepago;

   update ta_13_descrec
   set vigencia='V',
       fec_pag=null, id_rec=0,caja='', 
       operac=0 
    where id_folio =par_control and  fec_pag=par_fecp and id_rec=par_rec and
            caja=par_caja and operac=par_oper and vigencia='P';

    select nvl((min(axo_adeudo)-1),0) into v_axop from ta_13_adeudosrcm
    where control_rcm=par_control and vigencia='V';

   if v_axop>0 then 
    update ta_13_descpens set vigencia='V' 
    where control_rcm=par_control and axo_descto between v_axop and par_axoh and vigencia='P';
   end if;

   if v_axop=0 then 
      let v_axop=year(today);
   end if;

    update ta_13_datosrcm set axo_pagado=v_axop
     where control_rcm=par_control;
   
  update ta_13_pagosrcm  set vigencia='C', usuario=par_usu, fecha_mov=today
  where control_rcm=par_control and fecing=par_fecp and recing=par_rec and cajing=par_caja and opcaja=par_oper;
   let vcvepago=dbinfo("sqlca.sqlerrd1");

   return 0,'Pago Cancelado '|| vcvepago;
end if;

END PROCEDURE;

create function "informix".fn_getrentamerc(paxo int,pmerc int)
returning   money(16,2) as renta;

define v_renta,v_ren money(16,2);
define v_merc,v_cat,v_cvecuo int;
define v_secc char(2);
define v_sup decimal(7,2);

let v_renta=0;
foreach
select num_mercado,categoria,seccion,clave_cuota,superficie into v_merc,v_cat,v_secc,v_cvecuo,v_sup
from ta_11_locales where num_mercado=pmerc and vigencia='A'
let v_ren=0;
execute procedure spd_11_calc_renta(paxo,v_cat,v_secc,v_cvecuo,v_sup,v_merc,1) into v_ren; 
let v_renta=v_renta+v_ren;
end foreach;

return v_renta;
end function;

CREATE PROCEDURE "informix".spget_bimestre(p_fecha date)
{######################################################################
#  Procedimiento:    spget_bimestre
#  Descripcion:      Regresa el bimestre de la fecha dada
#
#  Parametros        p_fecha = fecha a calcular
#  de entrada:       
#
#  Parametros        bimestre = el bimestre al que pertenece la p_fecha
#  de salida:
#
#  Elaboro:          Marco A. Ortega
#  Fecha:            05 Marzo 2013
#
#  Llamado por:      Cualquier procedimiento o aplicacion
#  Llama a:
######################################################################}
returning
int as bimestre;
--Parametros de salida:
define v_bimestre      int;                -- 1
select case when
 mod(10,2) = 0 then round(month(p_fecha)/2) else round((month(p_fecha)/2)+0.9) end
into v_bimestre
 from parametros;
return  v_bimestre;

END PROCEDURE
;

create procedure "imtorre".opercaja_act(p_fecha date) 
    RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_fechatime datetime year to fraction(3) ;



   begin
    on exception in (-310)
       let v_id_modulo = 0;
       let v_descripcion ='ESPERE UN MOMENTO....VUELVA A INTENTAR';
       let v_cantidad = 0; let v_importe = 0; let v_fechatime = CURRENT year to fraction(3);
      return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   ;
  
    end exception;  
     foreach 
     select x0.id_modulo ,x1.descripcion ,count(*) ,sum(x0.importe ) , CURRENT year to fraction(3) 
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
     from ta_12_recibos x0 , ta_12_moduloscat x1 
     where (((x0.fecha = p_fecha ) AND (x0.cvepago = 'P' ) ) AND (x1.id_modulo = x0.id_modulo ) ) and x0.id_modulo <> 15
     group by x0.id_modulo ,   x1.descripcion 
 
    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach
end ;
 
end procedure;

create procedure "informix".opercaja_nvo(p_fecha date) 
    RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_fechatime datetime year to fraction(3) ;



   begin
    on exception in (-310)
       let v_id_modulo = 0;
       let v_descripcion ='ESPERE UN MOMENTO....VUELVA A INTENTAR';
       let v_cantidad = 0; let v_importe = 0; let v_fechatime = CURRENT year to fraction(3);
      return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   ;
  
    end exception;  
     foreach 
     select x0.id_modulo ,x1.descripcion ,count(*) ,sum(x0.importe ) , CURRENT year to fraction(3) 
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
     from ta_12_recibos x0 , ta_12_moduloscat x1 
     where (((x0.fecha = p_fecha ) AND (x0.cvepago = 'P' ) )  AND (x1.id_modulo = x0.id_modulo ) ) and x0.id_modulo not in (12,15)
     group by x0.id_modulo ,   x1.descripcion 
 
    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach;
   foreach 
     select (x0.grupo) ,trim(x1.descripcion) || ' por diversos' ,count(*) ,sum(x0.importe ) , CURRENT year to fraction(3) 
   into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
     from ta_12_recibos x0 , ta_12_moduloscat x1 
     where (x0.fecha = p_fecha  ) AND (x0.cvepago = 'P' )   and x0.id_modulo = 12 and (x1.id_modulo = x0.grupo )
     group by x0.grupo ,   x1.descripcion 
 


    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach;
end ;
 
end procedure;

CREATE PROCEDURE "informix".actual_rbogrupos12( p_fecha_ini date , p_fecha_fin date)
returning  date , --v_fecha_pago 
         integer ,  -- v_id_rec 
          char(2) , --v_caja ,
         integer , 
        integer ; -- v_operacion 
     

define v_recaud int; 

define v_fecha_pago date ;
define v_id_rec int;
define v_caja char(2);
define  v_operacion int;
define v_grupo int;

foreach
select  x0.fecha, x0.id_rec , x0.caja, x0.operacion  , nvl(x3.id_modulocat,0)
      into v_fecha_pago ,v_id_rec , v_caja , v_operacion , v_grupo
   from ta_12_recibosdet x0, ta_12_recibos x1, outer cg_12_cuentas x3
   where x1.fecha between p_fecha_ini and p_fecha_fin  and x1.id_modulo = 12 and x1.grupo is null and x1.cvepago = 'P' and
         x0.fecha = x1.fecha and
         x0.caja  = x1.caja  and
         x0.id_rec = x1.id_rec and
         x0.operacion = x1.operacion and x0.linea = 1 and x0.importe <> 0 and x0.cuenta = x3.cta_aplicacion 
if v_grupo > 0 then
 
update ta_12_recibos set grupo  = v_grupo where fecha = v_fecha_pago and
      id_rec = v_id_rec and
      caja  = v_caja and 
      operacion = v_operacion;
return   v_fecha_pago , v_id_rec, v_caja , v_operacion , v_grupo  with resume;
else
return   v_fecha_pago , v_id_rec, v_caja , v_operacion , 0 with resume;
end if;


end foreach;



end procedure;

create function "informix".fn_getmesesade(fmerc int,faxo int,fmes int,ffec date)
returning   integer as meses;

define v_mesesade,v_mesespag,v_total money(16,2);

select nvl(count(*),0) into v_mesesade
from ta_11_locales a,ta_11_adeudo_local b 
where  a.num_mercado=fmerc and a.vigencia='A'
and b.id_local=a.id_local and (b.axo<faxo  or (b.periodo<=fmes and b.axo=faxo));


select nvl(count(*),0) into v_mesespag
from ta_11_locales d,ta_11_pagos_local e 
where  d.num_mercado=fmerc and d.vigencia='A'
and (e.fecha_pago between ffec and today)
and e.id_local=d.id_local and (e.axo<faxo  or (e.periodo<=fmes and e.axo=faxo));

let v_total=v_mesesade+v_mesespag;
return v_total;
end function;

create function "informix".fn_getadeudoconv(fid int,ffec date)
returning   money(16,2) as total;

define v_adeudo,v_pago,v_total money(16,2);

select nvl(sum(importe),0) into v_adeudo
from ta_17_adeudos_div 
where id_conv_resto=fid and clave_pago is null; 

select nvl(sum(importe_pago),0) into v_pago
from ta_17_conv_pagos 
where  id_conv_resto=fid and (fecha_pago between ffec and today);

let v_total=v_adeudo+v_pago;
return v_total;
end function;

create function "informix".fn_getpagmesconv(fid int,ffec date)
returning   money(16,2) as total;

define v_adeudo,v_pago,v_total money(16,2);

select nvl(sum(importe_pago),0) into v_pago 
from ta_17_conv_pagos 
where  id_conv_resto=fid and month(fecha_pago)=month(ffec) and year(fecha_pago)=year(ffec);

return v_pago;
end function;

create procedure "informix".spd_17_adeudosconv(prec smallint,pfec1 date)
returning   integer as id_conv_resto,
            varchar(30) as tipo,
            varchar(30) as referencia,
            varchar(60) as nombre,
            varchar(20) as convenio,
            varchar(15) as periodo,
            money(16,2) as adeudo,
            money(16,2) as pagos,
            money(16,2) as total;

define v_tipo,v_axo,v_sub,v_clave smallint;
define v_referencia,v_nomtipo varchar(30);
define v_nombre varchar(60);
define v_convenio varchar(20);
define v_periodo varchar(15);
define v_adeudo,v_pagos,v_total money(16,2);
define v_id,v_numero integer;
define v_vig char(1);
define v_letras char(3);
define v_actual date;

if prec=1 then
   let v_letras='ZC1';
else if prec=2 then
     let v_letras='ZO2';
else if prec=3 then
     let v_letras='ZO3';
else if prec=4 then
     let v_letras='ZM4';
else let v_letras='ZC5';
end if;
end if;
end if;
end if;

foreach
select b.descripcion,d.axo_exp,d.numero_exp,a.id_conv_resto,a.tipo,d.subtipo,a.nombre,a.vigencia,
(trim(d.letras_exp)||'/'||d.numero_exp||'/'||d.axo_exp),
(min(e.pago_parcial)||' A '||max(e.pago_parcial)||'/'||max(e.pago_parcial)),
fn_getadeudoconv(a.id_conv_resto,pfec1),fn_getpagmesconv(a.id_conv_resto,pfec1),
(fn_getadeudoconv(a.id_conv_resto,pfec1)-fn_getpagmesconv(a.id_conv_resto,pfec1)),a.fecha_actual
into v_nomtipo,v_axo,v_numero,v_id,v_tipo,v_sub,v_nombre,v_vig,v_convenio,v_periodo,
v_adeudo,v_pagos,v_total,v_actual
from ta_17_conv_d_resto a,ta_17_tipos b,ta_17_conv_diverso d, outer ta_17_adeudos_div e
where d.letras_exp=v_letras
and b.tipo=a.tipo and d.id_conv_diver=a.id_conv_diver and d.tipo=a.tipo
and e.id_conv_resto=a.id_conv_resto and e.clave_pago is null
group by  b.descripcion,d.axo_exp,d.numero_exp,a.id_conv_resto,a.tipo,d.subtipo,a.nombre,a.vigencia,9,14
order by a.tipo,d.axo_exp,d.numero_exp

if (v_tipo=3) and (v_sub=1) then
   select referencia into v_referencia from ta_17_referencia 
   where id_conv_resto=v_id and modulo=9;
else
   select referencia into v_referencia from ta_17_referencia 
   where id_conv_resto=v_id;
end if;
let v_clave=0;
if v_periodo is null then
   let v_periodo='S/PARCIALIDADES';
end if;
if  v_vig='A' then
    let v_clave=1;
else
if  (v_vig='B') and ((month(v_actual)=month(pfec1)) 
    and (year(v_actual)=year(pfec1))) then
    let v_clave=1;
    let v_total=0;
    let v_periodo='BAJA';
else
if  (v_vig='P') and ((month(v_actual)=month(pfec1)) 
    and (year(v_actual)=year(pfec1))) then
    let v_clave=1;
    let v_periodo='PAGADO';
else
    let v_clave=2;
end if;
end if;
end if;

if v_clave=1 then
   return v_id,v_tipo,v_referencia,v_nombre,v_convenio,v_periodo,v_adeudo,v_pagos,v_total
   with resume;
end if; 
   
end foreach;
end procedure;

CREATE PROCEDURE "informix".con16_cifras ( p_Rep Char(1), p_Fecha_fin Char(7) )
                returning Integer,                          -- control de linea

                               varchar(100),     -- Concepto
                               Integer,               -- cant concepto
                               Money(12,2),                   -- Importe concepto

                               varchar(100),     -- Concepto
                               Integer,               -- cant concepto
                               Money(12,2),                   -- Importe concepto

                               varchar(100),     -- Concepto
                               Integer,               -- cant concepto
                               Money(12,2);                   -- Importe concepto
              

{
#  Procedimiento: con16_Cifras
#  Descripcion:  Genera una consulta de cifras totales a un periodo determinado
#  Parametros de entrada: fecha de corte para Cuota Normal y Excedencias
#  Parametros de salida:   Concepto, unidades e importe del concepto leido
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define v_concepto1, v_concepto2, v_concepto3, v_concepto                              varchar(100);
  define v_cant1, v_cant2, v_cant3, v_ctrol_aseo                                                  Integer;
  define v_importe1, v_importe2, v_importe3                                                           Money(12,2);
  define v_Periodo_CN, v_Periodo_EXE                                                                             varchar(7);
--****************************************************************************************************************************** 
                EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;  
  -- pedazo adicionado
  if p_Rep <> 'V' then
     Let v_Periodo_CN = p_Fecha_fin;
     Let v_Periodo_EXE = p_Fecha_fin;
  end if;


   foreach
                SELECT ctrol_aseo, descripcion INTO v_ctrol_aseo, v_concepto FROM ta_16_tipo_aseo order by ctrol_aseo
                RETURN 1, 'TIPO DE ASEO  '|| v_concepto, null, null,        null, null, null,     null, null, null  with resume;

                SELECT count(*) INTO v_cant1 FROM ta_16_contratos where ctrol_aseo = v_ctrol_aseo;
                SELECT count(*) INTO v_cant2 FROM ta_16_contratos where ctrol_aseo = v_ctrol_aseo and status_vigencia = 'V';
                SELECT count(*) INTO v_cant3 FROM ta_16_contratos where ctrol_aseo = v_ctrol_aseo and status_vigencia = 'C';

                RETURN 2, 'CONTRATOS  ', v_cant1, null,        'VIGENTES ', v_cant2, null,     'CANCELADOS ', v_cant3, null  with resume;
                RETURN null, NULL, NULL, NULL,        NULL, NULL, NULL,     NULL, NULL, NULL  with resume;  -- SALTO DE LINEA

                SELECT 'CUOTA NORMAL', NVL((sum(B.importe)),0) INTO v_concepto1, v_importe1 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_CN and b.ctrol_operacion = 6;
                SELECT 'EXCEDENCIAS', NVL((sum(B.importe)),0) INTO v_concepto2, v_importe2 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 7;
                SELECT 'CONTENEDORES', NVL((sum(B.importe)),0) INTO v_concepto3, v_importe3 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 8;
                RETURN 3, v_concepto1, null, v_importe1,        v_concepto2, null, v_importe2,     v_concepto3, null, v_importe3  with resume;
                RETURN null, NULL, NULL, NULL,        NULL, NULL, NULL,     NULL, NULL, NULL  with resume;  -- SALTO DE LINEA


                SELECT 'VIGENTES', NVL((sum(B.importe)),0) INTO v_concepto1, v_importe1 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_CN and b.ctrol_operacion = 6  and B.status_vigencia = 'V';
                SELECT 'VIGENTES', NVL((sum(B.importe)),0) INTO v_concepto2, v_importe2 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 7  and B.status_vigencia = 'V';
                SELECT 'VIGENTES', NVL((sum(B.importe)),0) INTO v_concepto3, v_importe3 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 8  and B.status_vigencia = 'V';
                RETURN 4, v_concepto1, null, v_importe1,        v_concepto2, null, v_importe2,     v_concepto3, null, v_importe3  with resume;

                SELECT 'CANCELADOS', NVL((sum(B.importe)),0) INTO v_concepto1, v_importe1 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_CN and b.ctrol_operacion = 6  and B.status_vigencia = 'C';
                SELECT 'CANCELADOS', NVL((sum(B.importe)),0) INTO v_concepto2, v_importe2 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
               AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 7  and B.status_vigencia = 'C';
                SELECT 'CANCELADOS', NVL((sum(B.importe)),0) INTO v_concepto3, v_importe3 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 8  and B.status_vigencia = 'C';
                RETURN 4, v_concepto1, null, v_importe1,        v_concepto2, null, v_importe2,     v_concepto3, null, v_importe3  with resume;

                SELECT 'PAGADOS', NVL((sum(B.importe)),0) INTO v_concepto1, v_importe1 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_CN and b.ctrol_operacion = 6  and B.status_vigencia = 'P';
                SELECT 'PAGADOS', NVL((sum(B.importe)),0) INTO v_concepto2, v_importe2 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 7  and B.status_vigencia = 'P';
                SELECT 'PAGADOS', NVL((sum(B.importe)),0) INTO v_concepto3, v_importe3 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 8  and B.status_vigencia = 'P';
                RETURN 4, v_concepto1, null, v_importe1,        v_concepto2, null, v_importe2,     v_concepto3, null, v_importe3  with resume;

                SELECT 'CONDONADOS', NVL((sum(B.importe)),0) INTO v_concepto1, v_importe1 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_CN and b.ctrol_operacion = 6  and B.status_vigencia = 'S';
                SELECT 'CONDONADOS', NVL((sum(B.importe)),0) INTO v_concepto2, v_importe2 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 7  and B.status_vigencia = 'S';
                SELECT 'CONDONADOS', NVL((sum(B.importe)),0) INTO v_concepto3, v_importe3 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 8  and B.status_vigencia = 'S';
                RETURN 4, v_concepto1, null, v_importe1,        v_concepto2, null, v_importe2,     v_concepto3, null, v_importe3  with resume;

                SELECT 'PRESCRITOS', NVL((sum(B.importe)),0) INTO v_concepto1, v_importe1 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_CN and b.ctrol_operacion = 6  and B.status_vigencia = 'R';
                SELECT 'PRESCRITOS', NVL((sum(B.importe)),0) INTO v_concepto2, v_importe2 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 7  and B.status_vigencia = 'R';
                SELECT 'PRESCRITOS', NVL((sum(B.importe)),0) INTO v_concepto3, v_importe3 FROM ta_16_contratos a, ta_16_pagos b
                WHERE a.ctrol_aseo = v_ctrol_aseo AND b.control_contrato = a.control_contrato
                AND b.aso_mes_pago <= v_Periodo_EXE and b.ctrol_operacion = 8  and B.status_vigencia = 'R';
                RETURN 4, v_concepto1, null, v_importe1,        v_concepto2, null, v_importe2,     v_concepto3, null, v_importe3  with resume;
                RETURN null, NULL, NULL, NULL,        NULL, NULL, NULL,     NULL, NULL, NULL  with resume;  -- SALTO DE LINEA
                RETURN null, NULL, NULL, NULL,        NULL, NULL, NULL,     NULL, NULL, NULL  with resume;  -- SALTO DE LINEA
                RETURN null, NULL, NULL, NULL,        NULL, NULL, NULL,     NULL, NULL, NULL  with resume;  -- SALTO DE LINEA

   end foreach

end procedure;

CREATE PROCEDURE "informix".con16_lperiodo ()
                returning varchar(7),    -- Periodo Cuota Normal
                               varchar(7);         -- Periodo Excedente

{
#  Procedimiento: con16_LPeriodo
#  Descripcion:  Genera una consulta del Periodo Limite de CN y EXE actual.
#  Parametros de entrada: NINGUNO
#  Parametros de salida:   A�o y mes de la CUOTA NORMAL
#  Parametros de salida:   A�o y mes de lEXCEDENCIAS
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Periodo_CN, v_Periodo_EXE                                              varchar(7);
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                       varchar(4);

       Select Mes, Dia
           Into Mes_v, Dia_v
       From ta_16_Dia_Limite 
               Where Mes = Month(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;

      if Day(Current) > Dia_v then          --  EXEDENCIAS
          if Mes_Hoy > 2 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 2;
          else
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
          end if;
      else
          if Mes_Hoy > 3 then
             Let v_Periodo_EXE = Year(Current) || '-' || Month(Current) - 3;
          else
                if Mes_Hoy = 3 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-12';
                end if;
                if Mes_Hoy = 2 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-11';
                end if;
                if Mes_Hoy = 1 then
                   Let v_Periodo_EXE = Year(Current) - 1||'-10';
                end if;
          end if;
      end if;

RETURN v_Periodo_CN, v_Periodo_EXE;

end procedure;

CREATE PROCEDURE "informix".ins16_contrato_01 ( par_Num_Cont Integer, par_Ctrol_Aseo Integer, 
                                                                    par_Num_Emp Integer, par_Ctrol_Emp Integer, 
                                                                    par_Cve_recolec Char(1), par_Cant_recolec Integer, 
                                                                    par_Domicilio Char(80), par_Sector Char(1), 
                                                                    par_Ctrol_Zona Integer, par_Id_Rec Integer, 
                                                                    par_Axo_Ini Integer, par_Mes_Ini Integer)
                returning Integer,                     -- Status
                               varchar(100);     -- Concepto status
               

{
#  Procedimiento: ins16_contrato_01
#  Descripcion:  Opciones de Contratos Inserta, cancela, actualiza
#  Parametros de entrada: Todos los datos del contrato
#  Parametros de salida:   Status del Procedimiento
#                                      Concepto del Procedimiento
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}


--************************************************************************RECARGOS
  define v_Importe_recargo, v_importe_rec1                                                  Money(12,2);
--************************************************************************PERIODOS Y CONTROL
--define Aso_Hoy                                                                                                         varchar(4);
define aso_actual, aso_inicio, v_mes, mes_actual                                                         Integer;
define v_control_contrato                                                                                       Integer;
--************************************************************************UNIDADES DE RECOLECCION
define v_control_recolec                                                                                          Integer;
define v_costo_unidad, v_costo_exed, v_importe_reg                                             Money(12,2);
--************************************************************************DATOS AUXILIARES
define v_importe_inicio, v_importe_actual, v_suma_adeudos, v_suma_recargos        Money(12,2);
define v_periodo                                                                                                          Char(7);
define v_id_usuario, v_id_rec                                                                                Integer;
define v_IdPoliza, v_status_poliza                                                                        integer;
--************************************************************************MOMENTOS CONTABLES
define v_ctaaplica, v_origen                     integer;
define v_cta_m11, v_cta_m21                 CHAR(4);
define v_cta_m12, v_cta_m22                 CHAR(2);
define v_cta_m13, v_cta_m23                 CHAR(4);
define v_cta_m14, v_cta_m24                 CHAR(5);
define v_cta_m15, v_cta_m25                 CHAR(5);
--************************************************************************

Let aso_inicio = par_Axo_Ini;
if par_Axo_Ini = Year(Current) then
   Let aso_actual = par_Axo_Ini;
else
   Let aso_actual = Year(Current);
end if;
Let v_control_contrato = 0;
Let mes_actual = Month(Current);

--************************************************************************USUARIO
SELECT id_usuario, id_rec INTO v_id_usuario, v_id_rec FROM ta_12_passwords WHERE usuario = user;
--************************************************************************

--  EVITAR QUE EL EJERCICIO NO EXCEDA DE MAS DE 1 A�O DE ANTERIORIDAD ( A�O ACTUAL O PASADO )
    if not exists(Select * From ta_16_contratos
         Where Num_Contrato = par_Num_Cont and Ctrol_Aseo = par_Ctrol_Aseo) then

                if exists(Select * From ta_16_empresas
                    Where num_empresa = par_Num_Emp and ctrol_emp = par_Ctrol_Emp) then

                               EXECUTE PROCEDURE con16_Costo_Und ( par_Cve_recolec, aso_inicio ) INTO v_control_recolec, v_costo_unidad, v_costo_exed;
                               insert into ta_16_contratos values
                               ( 0, par_Num_Cont, par_Ctrol_Aseo, par_Num_Emp, par_Ctrol_Emp, v_control_recolec, par_Cant_recolec, 
                                Trim(par_Domicilio), par_Sector, par_Ctrol_Zona, par_Id_Rec, Today, 'V', mdy(par_Mes_Ini, 01, par_Axo_Ini), 'A', v_id_usuario, Null );
                               LET v_control_contrato = dbinfo("sqlca.sqlerrd1");

                               if v_control_contrato > 0 then
                                                                                              --************************************* GENERACION DE ADEUDOS DEL A�O ANTERIOR
                                               if par_Axo_Ini < aso_actual  then    
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
                                                               EXECUTE PROCEDURE con16_Costo_Und ( par_Cve_recolec, par_Axo_Ini ) INTO v_control_recolec, v_costo_unidad, v_costo_exed;
                                                               Let v_importe_reg = par_Cant_recolec * v_costo_unidad;
                                                               FOR v_mes = par_Mes_Ini to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              EXECUTE PROCEDURE con16_Rcgos ('CN', par_Axo_Ini || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    

                                                                              Insert into ta_16_Pagos values
                                                                              ( v_control_contrato, mdy(v_mes, 01, par_Axo_Ini), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec);
                                                                              --Insert into ta_16_Pagos values
                                                                              --( v_control_contrato, mdy(v_mes, 01, par_Axo_Ini), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec, v_importe_rec1, 0);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;

                                                                                              --  ************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
                                                               EXECUTE PROCEDURE con16_Costo_Und ( par_Cve_recolec, aso_actual ) INTO v_control_recolec, v_costo_unidad, v_costo_exed;
                                                               Let v_importe_reg = par_Cant_recolec * v_costo_unidad;
                                                               FOR v_mes = 1 to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              EXECUTE PROCEDURE con16_Rcgos ('CN', aso_actual || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    
                                                               
                                                                              Insert into ta_16_Pagos values
                                                                              ( v_control_contrato, mdy(v_mes, 01, aso_actual), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec);
                                                                              --Insert into ta_16_Pagos values
                                                                              --( v_control_contrato, mdy(v_mes, 01, aso_actual), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec, v_importe_rec1, 0);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;

                                                                                              --  ************************************* GENERACION DE POLIZA CONTABLE DEL A�O EN CURSO
                                                               --EXECUTE PROCEDURE cg_generapoliza (mdy( 01, 01, aso_actual), aso_actual, 01, 3, 16, 1, v_id_rec, 
                                                               --                                            'MODIFICACION AL PRESUPUESTO ACTUAL', 'ejecucion del proceso ins16_contrato_01', 'A',43) INTO v_IdPoliza;      
                                                               --            if v_IdPoliza > 0 then
                                                               --                            foreach;
                                                               --                            EXECUTE PROCEDURE cg_Momentos ( 'AP', 1 ) INTO v_ctaaplica, v_origen, 
                                                               --                                                           v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15,  
                                                               --                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25;
                                                               --                                            if v_ctaaplica > 0 then
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                            v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15, v_suma_adeudos, 0, v_control_contrato, 
                                                               --                                            'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                            v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25, 0, v_suma_adeudos, 0, 
                                                               --                                            'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            else
                                                               --                                                           RETURN 1,'No tiene momentos contables';
                                                               --                                            end if;
                                                               --                            end foreach;
                                                               --            else
                                                               --            RETURN 1,'No se creo la Poliza al Presupuesto de Actual';
                                                               --            end if;
                                                               RETURN 0,'Se creo el contrato correctamente';
                                               end if;
                                                                                              --************************************* 


                                               if par_Axo_Ini = aso_actual then    --************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
                                                               EXECUTE PROCEDURE con16_Costo_Und ( par_Cve_recolec, aso_actual ) INTO v_control_recolec, v_costo_unidad, v_costo_exed;
                                                               Let v_importe_reg = par_Cant_recolec * v_costo_unidad;
                                                               FOR v_mes = par_Mes_Ini to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              EXECUTE PROCEDURE con16_Rcgos ('CN', aso_actual || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    

                                                                              Insert into ta_16_Pagos values
                                                                              ( v_control_contrato, mdy(v_mes, 01, aso_actual), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec);
                                                                              --Insert into ta_16_Pagos values
                                                                              --( v_control_contrato, mdy(v_mes, 01, aso_actual), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec, v_importe_rec1, 0);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;
                                                                                              --  *************************************  CREACION DE LA POLIZA DE ADEUDOS DEL A�O EN CURSO
                                                               --EXECUTE PROCEDURE cg_generapoliza (mdy( par_Mes_Ini, 01, par_Axo_Ini), par_Axo_Ini, par_Mes_Ini, 3, 16, 1, v_id_rec, 
                                                               --                                            'MODIFICACION AL PRESUPUESTO ACTUAL', 'ejecucion del proceso ins16_contrato_01', 'A',43) INTO v_IdPoliza;      
                                                               --            if v_IdPoliza > 0 then
                                                               --                            EXECUTE PROCEDURE cg_Momentos ( 'AP', 1 ) INTO v_ctaaplica, v_origen, 
                                                               --                                                           v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15,  
                                                               --                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25;
                                                               --                            if v_ctaaplica > 0 then
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                                                           v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15, v_suma_adeudos, 0, v_control_contrato, 
                                                               --                                                                           'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25, 0, v_suma_adeudos, 0, 
                                                               --                                                                           'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                            else
                                                               --                                            RETURN 1,'No tiene momentos contables';
                                                               --                            end if;
                                                               --            else
                                                               --            RETURN 1,'No se creo la Poliza al Presupuesto de Actual';
                                                               --            end if;
                                                               RETURN 0,'Se creo el contrato correctamente';
                                               end if;
                                               --************************************* 
                               else
                                    RETURN 1,'No se creo el contrato, comunicate al Depto de Proyectos';
                               end if;
                else
                     RETURN 1,'No se puede dar de alta un contrato si la empresa no existe';
                end if;
    else
        RETURN 1,'No se puede dar de alta un contrato que ya existe';
    end if;

end procedure;

CREATE PROCEDURE "informix".ins16_empresa_01 ( par_Emp_Ctrol Integer, par_Emp_Nombre Char(80), par_Emp_RepLeg Char(80) )
                returning Integer,                           -- Status
                               varchar(100),                    -- Concepto status
                               Integer;                               -- Numero de Empresa
               

{
#  Procedimiento: ins16_empresa_01
#  Descripcion:  Empresas Inserta
#  Parametros de entrada: Control, Nombre y representante de la empresa
#  Parametros de salida:   Status del Procedimiento
#                                      Concepto del Procedimiento
#                                      Numero asignado a la empresa nueva
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--***********************************************************************
define v_num_emp, v_Nvo_Num                         Integer;
--**********************************************************************

Let v_num_emp = 0;
Let v_Nvo_Num = 0;

SELECT Max(Num_empresa) INTO v_num_emp FROM ta_16_empresas WHERE Ctrol_emp = par_Emp_Ctrol;

                               insert into ta_16_empresas values
                               ( v_num_emp + 1, par_Emp_Ctrol, par_Emp_Nombre, par_Emp_RepLeg );
                               LET v_Nvo_Num = dbinfo("sqlca.sqlerrd1");

if v_Nvo_Num > 1000 then
                RETURN 0, 'Se creo correctamente la empresa', v_Nvo_Num;
else
                RETURN 1, 'No se creo la empresa, ocurrio algun error; informar a Depto. de Proyectos', 0;
end if;

end procedure;

CREATE PROCEDURE "informix".redondeo50(nImporte money(15,2))
   RETURNING       money(15,2);
   DEFINE nImp     money(15,2);
   DEFINE nTmp     money(15,2);
   DEFINE nDif     money(5,2);
   DEFINE nDifresto     money(5,2);

   LET nTmp = TRUNC( nImporte );
   LET nDif = nImporte - nTmp;
   LET nDifresto = 0;
   LET nImp = 0;

   IF nDif > 0 THEN
      IF ((nDif > 0.00) AND (nDif < 0.25)) THEN
         LET nImp = nTmp;
         LET nDifresto =  nDif * -1;
      END IF;
      IF ((nDif >= 0.25) AND (nDif < 0.50)) THEN
         LET nImp = nTmp + 0.50;
         LET nDifresto = 0.50 - nDif;
      END IF;
      IF (nDif = 0.50) THEN
         LET nDifresto = 0;
         LET nImp = nImporte;
      END IF;
      IF ((nDif > 0.50) AND (nDif < 0.75)) THEN
         LET nImp = nTmp + 0.50;
         LET nDifresto = 0.50 - nDif;
      END IF;
      IF ((nDif >= 0.75) AND (nDif < 1)) THEN
         LET nImp = nTmp + 1;
         LET nDifresto = 1 - nDif;
      END IF;
   ELSE
      LET nImp = nImporte;
   END IF;
   RETURN nImp;
END PROCEDURE;

create function "informix".fn_getadeaxoloc(fid int,faxo int,fmes int,ffec date)
returning   money(16,2) as total;

define v_adeudo,v_pago,v_total money(16,2);

if faxo>=2001 then
   select nvl(sum(importe),0) into v_adeudo
   from ta_11_adeudo_local 
   where  id_local=fid and axo=faxo and periodo<=fmes;
else
   select nvl(sum(importe),0) into v_adeudo
   from ta_11_adeudo_local  
   where  id_local=fid and (axo<2000  or (periodo<=12 and axo=2000));

end if;

if faxo>=2001 then 
   select nvl(sum(importe_pago),0) into v_pago
   from ta_11_pagos_local  
   where  id_local=fid
   and (fecha_pago between ffec and today)
   and axo=faxo and periodo<=fmes;
else
   select nvl(sum(importe_pago),0) into v_pago
   from ta_11_pagos_local  
   where  id_local=fid
   and (fecha_pago between ffec and today)
   and (axo<2000  or (periodo<=12 and axo=2000));
end if;

let v_total=v_adeudo+v_pago;
return v_total;
end function;

create function "informix".fn_getrecaxomerc(fid int,faxo int,fmes int,ffec date)
returning money(16,2) as RECARGOS;

define v_recargos,v_multa,v_gastos,v_recargostotal,v_aimporte money(16,2);
define v_folio,v_aid_local,v_aaxo,v_aperiodo,v_dmes,v_merc,v_desc,v_primermes int;
define v_porc decimal(7,2);
define v_fecha_desc,v_fecha_rec date;

select num_mercado,nvl(id_contribuy_renta,0) into v_merc,v_desc
from ta_11_locales where id_local=fid;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=fid and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where a.id_local=fid and a.axo=faxo and a.periodo<=fmes 
and b.mes=month((ffec-1))
union all select d.id_local,d.axo,d.periodo,d.importe_pago,e.mes,e.fecha_descuento,e.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_pagos_local d,ta_11_fecha_desc e
where (d.fecha_pago between ffec and today) 
and d.id_local=fid and d.axo=faxo and d.periodo<=fmes
and e.mes=month((ffec-1))
order by 2,3

if v_merc =214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
end if;

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if v_merc <>214 then
   if (ffec-1)>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year((ffec-1))  or (mes<=month((ffec-1)) and axo =year((ffec-1)))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year((ffec-1))  or (mes<=(month((ffec-1))-1) and axo =year((ffec-1)))) );
   end if;
else 
   if v_aperiodo=1 then let v_primermes=1;
   else if v_aperiodo=2 then let v_primermes=4;
   else if v_aperiodo=3 then let v_primermes=7;
   else if v_aperiodo=4 then let v_primermes=10;
   else let v_primermes=0;
   end if;
   end if;
   end if;
   end if;

   if v_primermes=month((ffec-1)) then
      if (ffec-1)>=v_fecha_rec then
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                  (axo<year((ffec-1))  or (mes<=month((ffec-1)) and axo =year((ffec-1)))) );
      else
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                 (axo<year((ffec-1))  or (mes<=(month((ffec-1))-1) and axo =year((ffec-1)))) );
      end if;
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
              (axo<year((ffec-1))  or (mes<=month((ffec-1)) and axo =year((ffec-1)))) );   
    end if;
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

return v_recargostotal;
end function;

create function "informix".fn_getadeaxomerc(fmerc int,faxo int,fmes int,ffec date)
returning   money(16,2) as total;

define v_adeudo,v_pago,v_total money(16,2);

if faxo>=2003 then
   select nvl(sum(b.importe),0) into v_adeudo
   from ta_11_locales a, ta_11_adeudo_local b 
   where  a.num_mercado=fmerc and a.vigencia='A'
   and b.id_local=a.id_local and b.axo=faxo and b.periodo<=fmes;
else
   select nvl(sum(b.importe),0) into v_adeudo
   from ta_11_locales a,ta_11_adeudo_local b 
   where  a.num_mercado=fmerc and a.vigencia='A'
   and b.id_local=a.id_local and (b.axo<2002  or (b.periodo<=12 and b.axo=2002));

end if;

if faxo>=2003 then 
   select nvl(sum(e.importe_pago),0) into v_pago
   from ta_11_locales d,ta_11_pagos_local e 
   where  d.num_mercado=fmerc and d.vigencia='A'
   and (e.fecha_pago between ffec and today)
   and e.id_local=d.id_local and e.axo=faxo and e.periodo<=fmes;
else
   select nvl(sum(e.importe_pago),0) into v_pago
   from ta_11_locales d,ta_11_pagos_local e 
   where  d.num_mercado=fmerc and d.vigencia='A'
   and (e.fecha_pago between ffec and today)
   and e.id_local=d.id_local and (e.axo<2002  or (e.periodo<=12 and e.axo=2002));
end if;

let v_total=v_adeudo+v_pago;
return v_total;
end function;

create procedure "informix".spd_11_adeaxodesg(paxo int,pmes int,pfec date,ptip char(1))
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(1) as letra,
            char(1) as bloque,
            varchar(60) as nombre,
            MONEY(16,2) as adeudo_anterior,
            MONEY(16,2) as recargos_anterior,
            MONEY(16,2) as adeudo2001,
            MONEY(16,2) as recargos2001,
            MONEY(16,2) as adeudo2002,
            MONEY(16,2) as recargos2002,
            MONEY(16,2) as adeudo2003,
            MONEY(16,2) as recargos2003,
            MONEY(16,2) as adeudo2004,
            MONEY(16,2) as recargos2004,
            MONEY(16,2) as adeudo2005,
            MONEY(16,2) as recargos2005,
            MONEY(16,2) as adeudo2006,
            MONEY(16,2) as recargos2006,
            MONEY(16,2) as adeudo2007,
            MONEY(16,2) as recargos2007,
            MONEY(16,2) as adeudo2008,
            MONEY(16,2) as recargos2008,
            MONEY(16,2) as adeudo2009,
            MONEY(16,2) as recargos2009,
            MONEY(16,2) as adeudo2010,
            MONEY(16,2) as recargos2010,
            MONEY(16,2) as adeudo2011,
            MONEY(16,2) as recargos2011,
            MONEY(16,2) as adeudo2012,
            MONEY(16,2) as recargos2012,
            MONEY(16,2) as adeudo2013,
            MONEY(16,2) as recargos2013,
            MONEY(16,2) as total;
  
define v_recargostotal,v_rec2001,v_rec2002,v_rec2003,v_rec2004,v_rec2005,v_rec2006,
       v_rec2007,v_rec2008,v_rec2009,v_rec2010,v_rec2011,v_rec2012,v_rec2013 MONEY(16,2);
define v_ade2001,v_ade2002,v_ade2003,v_ade2004,v_ade2005,v_ade2006,
       v_ade2007,v_ade2008,v_ade2009,v_ade2010,v_ade2011,v_ade2012,v_ade2013 MONEY(16,2);  
define v_multa MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer char(30);          define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(1);           define v_blq char(1);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 


foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,nvl(sum(d.importe),0)
,fn_getadeaxoloc(a.id_local,2001,12,pfec),fn_getrecaxomerc(a.id_local,2001,12,pfec)
,fn_getadeaxoloc(a.id_local,2002,12,pfec),fn_getrecaxomerc(a.id_local,2002,12,pfec)
,fn_getadeaxoloc(a.id_local,2003,12,pfec),fn_getrecaxomerc(a.id_local,2003,12,pfec)
,fn_getadeaxoloc(a.id_local,2004,12,pfec),fn_getrecaxomerc(a.id_local,2004,12,pfec)
,fn_getadeaxoloc(a.id_local,2005,12,pfec),fn_getrecaxomerc(a.id_local,2005,12,pfec)
,fn_getadeaxoloc(a.id_local,2006,12,pfec),fn_getrecaxomerc(a.id_local,2006,12,pfec)
,fn_getadeaxoloc(a.id_local,2007,12,pfec),fn_getrecaxomerc(a.id_local,2007,12,pfec) 
,fn_getadeaxoloc(a.id_local,2008,12,pfec),fn_getrecaxomerc(a.id_local,2008,12,pfec)
,fn_getadeaxoloc(a.id_local,2009,12,pfec),fn_getrecaxomerc(a.id_local,2009,12,pfec)
,fn_getadeaxoloc(a.id_local,2010,12,pfec),fn_getrecaxomerc(a.id_local,2010,12,pfec)
,fn_getadeaxoloc(a.id_local,2011,12,pfec),fn_getrecaxomerc(a.id_local,2011,12,pfec)
,fn_getadeaxoloc(a.id_local,2012,12,pfec),fn_getrecaxomerc(a.id_local,2012,12,pfec)
,fn_getadeaxoloc(a.id_local,2013,pmes,pfec),fn_getrecaxomerc(a.id_local,2013,pmes,pfec)
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_superf,v_est,v_bloqueo,v_cvecuo,
v_ade,v_ade2001,v_rec2001,v_ade2002,v_rec2002,
v_ade2003,v_rec2003,v_ade2004,v_rec2004,v_ade2005,v_rec2005,v_ade2006,v_rec2006,v_ade2007,v_rec2007,
v_ade2008,v_rec2008,v_ade2009,v_rec2009,v_ade2010,v_rec2010,v_ade2011,v_rec2011,v_ade2012,v_rec2012,
v_ade2013,v_rec2013
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where b.tipo_emision=ptip and a.vigencia='A'
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
and d.id_local=a.id_local and (d.axo<2000  or (d.periodo<=12 and d.axo=2000))
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,a.superficie,a.vigencia,bloqueo,a.clave_cuota
having (sum(d.importe)>0) or (fn_getadeaxoloc(a.id_local,2001,12,pfec))>0 
or (fn_getadeaxoloc(a.id_local,2002,12,pfec))>0
or (fn_getadeaxoloc(a.id_local,2003,12,pfec))>0 or (fn_getadeaxoloc(a.id_local,2004,12,pfec))>0
or (fn_getadeaxoloc(a.id_local,2005,12,pfec))>0 or (fn_getadeaxoloc(a.id_local,2006,12,pfec))>0 
or (fn_getadeaxoloc(a.id_local,2007,12,pfec))>0 or (fn_getadeaxoloc(a.id_local,2008,12,pfec))>0 
or (fn_getadeaxoloc(a.id_local,2009,12,pfec))>0 or (fn_getadeaxoloc(a.id_local,2010,12,pfec))>0
or (fn_getadeaxoloc(a.id_local,2011,12,pfec))>0 or (fn_getadeaxoloc(a.id_local,2012,12,pfec))>0
or (fn_getadeaxoloc(a.id_local,2013,pmes,pfec))>0 
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

if v_est='A' then
   if v_bloqueo=4 then
      let v_estado='VIGENTE-BLOQUEADO';
   else
      let v_estado='VIGENTE';
   end if;
else
   let v_estado='BAJA';
end if;

select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  
let v_total=0;

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where a.id_local=v_idl and (a.axo<2000  or (a.periodo<=12 and a.axo=2000)) 
and b.mes=month((pfec-1))
union all select d.id_local,d.axo,d.periodo,d.importe_pago,e.mes,e.fecha_descuento,e.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_pagos_local d,ta_11_fecha_desc e
where (d.fecha_pago between pfec and today) 
and d.id_local=v_idl and (d.axo<2000  or (d.periodo<=12 and d.axo=2000))
and e.mes=month((pfec-1))
order by 2,3
-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if (pfec-1)>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year((pfec-1))  or (mes<=month((pfec-1)) and axo =year((pfec-1)))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year((pfec-1))  or (mes<=(month((pfec-1))-1) and axo =year((pfec-1)))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

-- verifica los periodos de adeudo
select a.id_local, ( 
(select min(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo)))),
((select Max(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo))))
into v_ida,v_ini,v_fin
from   ta_11_adeudo_local a   
where  a.id_local=v_idl 
group by a.id_local;
let v_periodo=trim(v_ini);

-- verifica los folios de requerimientos
let v_requerimientos='';
foreach
select id_control,fecha_emision,folio,fecha_practicado,( 
(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
from   ta_15_apremios a   
where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
order by a.fecha_emision,a.folio
let v_requerimientos=trim(v_requerimientos)||v_fol||',';
end foreach; -- cierre de apremios

let v_requerimientos=substr(v_requerimientos,1,(length(v_requerimientos)-1));

let v_total=v_ade+v_recargostotal+v_ade2001+v_rec2001+v_ade2002+v_rec2002+
v_ade2003+v_rec2003+v_ade2004+v_rec2004+v_ade2005+v_rec2005+v_ade2006+v_rec2006+v_ade2007+v_rec2007+
v_ade2008+v_rec2008+v_ade2009+v_rec2009+v_ade2010+v_rec2010+v_ade2011+v_rec2011+v_ade2012+v_rec2012+
--v_ade2013+v_rec2013+v_multa+v_gastos;
v_ade2013+v_rec2013;

return trim(v_mer),v_ofi,v_nme,trim(v_sec),v_loc,trim(v_let),trim(v_blq),trim(v_nombre),
v_ade,v_recargostotal,v_ade2001,v_rec2001,v_ade2002,v_rec2002,
v_ade2003,v_rec2003,v_ade2004,v_rec2004,v_ade2005,v_rec2005,v_ade2006,v_rec2006,v_ade2007,v_rec2007,
v_ade2008,v_rec2008,v_ade2009,v_rec2009,v_ade2010,v_rec2010,v_ade2011,v_rec2011,v_ade2012,v_rec2012,
v_ade2013,v_rec2013,v_total
with resume;
end foreach; -- cierre del principal

end procedure;

create procedure "informix".spd_11_ademercaxo(paxo int,pmes int,ptip char(1),pfec date,pofn int)
returning   smallint as Merc,
            char(30) as mercado,
            MONEY(16,2) as adeudo_anterior,
            MONEY(16,2) as adeudo2003,
            MONEY(16,2) as adeudo2004,
            MONEY(16,2) as adeudo2005,
            MONEY(16,2) as adeudo2006,
            MONEY(16,2) as adeudo2007,
            MONEY(16,2) as adeudo2008,
            MONEY(16,2) as adeudo2009,
            MONEY(16,2) as adeudo2010,
            MONEY(16,2) as adeudo2011,
            MONEY(16,2) as adeudo2012,
            MONEY(16,2) as adeudo2013,
            MONEY(16,2) as total,
            integer as meses;
  
define v_recargostotal,v_rec2001,v_rec2002,v_rec2003,v_rec2004,v_rec2005,v_rec2006,
       v_rec2007,v_rec2008,v_rec2009,v_rec2010,v_rec2011,v_rec2012,v_rec2013 MONEY(16,2);
define v_ade2001,v_ade2002,v_ade2003,v_ade2004,v_ade2005,v_ade2006,
       v_ade2007,v_ade2008,v_ade2009,v_ade2010,v_ade2011,v_ade2012,v_ade2013 MONEY(16,2);  
define v_multa MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer char(30);          define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc,v_meses integer;
define v_let char(1);           define v_blq char(1);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_meses=0; 


foreach
select descripcion,num_mercado_nvo,fn_getadeaxomerc(num_mercado_nvo,2002,12,pfec)
,fn_getadeaxomerc(num_mercado_nvo,2003,12,pfec),fn_getadeaxomerc(num_mercado_nvo,2004,12,pfec)
,fn_getadeaxomerc(num_mercado_nvo,2005,12,pfec),fn_getadeaxomerc(num_mercado_nvo,2006,12,pfec)
,fn_getadeaxomerc(num_mercado_nvo,2007,12,pfec),fn_getadeaxomerc(num_mercado_nvo,2008,12,pfec)
,fn_getadeaxomerc(num_mercado_nvo,2009,12,pfec),fn_getadeaxomerc(num_mercado_nvo,2010,12,pfec)
,fn_getadeaxomerc(num_mercado_nvo,2011,12,pfec),fn_getadeaxomerc(num_mercado_nvo,2012,12,pfec)
,fn_getadeaxomerc(num_mercado_nvo,2013,pmes,pfec),fn_getmesesade(num_mercado_nvo,2013,pmes,pfec)
into v_mer,v_nme,v_ade,v_ade2003,v_ade2004,v_ade2005,v_ade2006,v_ade2007,
v_ade2008,v_ade2009,v_ade2010,v_ade2011,v_ade2012,v_ade2013,v_meses
from ta_11_mercados
where tipo_emision=ptip and oficina=pofn
group by descripcion,num_mercado_nvo
order by num_mercado_nvo

let v_total=0;

let v_total=v_ade+v_ade2003++v_ade2004+v_ade2005+v_ade2006+v_ade2007+v_ade2008++v_ade2009+v_ade2010+
v_ade2011+v_ade2012+v_ade2013;

return v_nme,trim(v_mer),v_ade,v_ade2003,v_ade2004,v_ade2005,v_ade2006,v_ade2007,
v_ade2008,v_ade2009,v_ade2010,v_ade2011,v_ade2012,v_ade2013,v_total,v_meses
with resume;
end foreach; -- cierre del principal

end procedure;

create procedure "informix".spd_11_ctapublica(paxo int,pmes int,pfec date,prec int)
returning   int as mercado,
            varchar(30) as nombre,
            int as doctosini,
            money(18,2) as importeini,
            int as doctosalt,
            money(18,2) as importealt,
            int as doctospag,
            money(18,2) as importepag,
            int as doctosfin,
            money(18,2) as importefin;

define v_mercado,v_docini,v_docalt,v_docpag,v_docfin int;
define v_nombre varchar(30);
define v_impini,v_impalt,v_imppag,v_impfin money(18,2);

foreach
select num_mercado_nvo,descripcion,
fn_getctapubmerc(num_mercado_nvo,paxo,pmes,pfec,'I','D'),fn_getctapubmerc(num_mercado_nvo,paxo,pmes,pfec,'I','I'),
fn_getctapubmerc(num_mercado_nvo,paxo,pmes,pfec,'A','D'),fn_getctapubmerc(num_mercado_nvo,paxo,pmes,pfec,'A','I'),
--fn_getctapubmerc(num_mercado_nvo,paxo,pmes,pfec,'P','D'),fn_getctapubmerc(num_mercado_nvo,paxo,pmes,pfec,'P','I')
fn_getctapubmerc(num_mercado_nvo,2013,5,mdy(5,31,2013),'I','D'),fn_getctapubmerc(num_mercado_nvo,2013,5,mdy(5,31,2013),'I','I')
into v_mercado,v_nombre,v_docini,v_impini,v_docalt,v_impalt,v_docfin,v_impfin
from ta_11_mercados where oficina=prec and tipo_emision='M'
order by num_mercado_nvo

--let v_docfin=(v_docini+v_docalt)-v_docpag;
--let v_impfin=(v_impini+v_impalt)-v_imppag;

let v_docpag=(v_docini+v_docalt)-v_docfin;
let v_imppag=(v_impini+v_impalt)-v_impfin;

return v_mercado,v_nombre,v_docini,v_impini,v_docalt,v_impalt,v_docpag,v_imppag,v_docfin,v_impfin
with resume;
end foreach;

end procedure;

create procedure "saranda".spd_12_polcontmes (v_fechad date,v_fechaa date,v_rec int)
                 returning smallint as momento, varchar(25) as cta_admin, varchar(80) as descripcion,
                        varchar(80) as num_cta, money(15,2) as cargo, money(15,2) as abono, smallint as origen,
                        int as error, int as error1, varchar(255) as mensaje;







define p_momen  smallint;
define p_cta    varchar(25);
define p_desc   varchar(80);
define p_numcta varchar(80);
define p_cargo  money(15,2);
define p_abono  money(15,2);
define p_origen  smallint;
define p_numero  int;
define     v_idpoliza int;
define   v_axop int;
define   v_mesp int;
define    p_mayor CHAR(4) ;
 define   p_sub01 CHAR(2) ;
 define   p_sub02 CHAR(4) ;
 define   p_sub03 CHAR(5) ;
 define   p_sub04 CHAR(5) ;
define p_existe     int;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_usuario varchar(20);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN 0,'', '', '', 0 , 0, 0,-1,0, 'spd_12_polcontmes ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let p_existe=0;
let v_axop=year(today);
let v_mesp=month(today);

select nvl(count(*),0) into p_existe from cg_12_importes  where fecing=v_fechad;

if p_existe=0 then
   RETURN 0,'', '', '', 0 , 0, 0,-1,0, 'No Existe Informacion con esa fecha '||v_fechad;
end if;

if p_existe>0 then

 foreach
select 0 ,(b.cta_mayor||'-'||b.CTA_sub01 ||"-"|| b.cta_sub02 ||"-"|| b.cta_sub03 ||"-"|| b.cta_sub04), (nombre || " No. CTA " || numero_cuenta),
(''), sum(a.importe), (0), 1, b.cta_mayor, b.CTA_sub01 , b.cta_sub02 , b.cta_sub03 , b.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04 
FROM cg_12_depositos a, cg_12_bancos b
 WHERE a.feciNG between v_fechad and v_fechaa and  a.control_bco=b.control_bco and a.recing=1 
group by 1,2,3,4,b.cta_mayor, b.CTA_sub01 , b.cta_sub02 , b.cta_sub03 , b.cta_sub04 
return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

end foreach;

foreach
select 0, (a.cta_mayor||'-'||a.CTA_sub01 ||"-"|| a.cta_sub02 ||"-"|| a.cta_sub03 ||"-"|| a.cta_sub04),a.nombre,b.concepto, sum(b.importe_faltante),(0)
,1, a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,  
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04 
FROM cg_12_faltantes b, cg_12_deudores a
 WHERE b.feciNG between v_fechad and v_fechaa and   b.control_deudor=a.control_deudor and b.recing=1 
group by 1,2,3,4,a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

 end foreach;

foreach
select 0, (a.cta_mayor||'-'||a.CTA_sub01 ||"-"|| a.cta_sub02 ||"-"|| a.cta_sub03 ||"-"|| a.cta_sub04) ,a.nombre,
c.concepto, sum(c.importe_cargo),sum(importe_abono),1, a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_virtuales c, cg_12_deudores a
 WHERE c.feciNG between v_fechad and v_fechaa and   c.control_deudor=a.control_deudor and c.recing=1 
group by 1,2,3,4,a.cta_mayor, a.CTA_sub01 , a.cta_sub02 , a.cta_sub03 , a.cta_sub04

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

end foreach;

foreach
select  0, (c.cta_mayor||'-'||c.CTA_sub01 ||"-"|| c.cta_sub02 ||"-"|| c.cta_sub03 ||"-"|| c.cta_sub04),b.nombre,
b.concepto,0,a.importe_cta,1, c.cta_mayor, c.CTA_sub01 , c.cta_sub02 , c.cta_sub03 , c.cta_sub04
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_importes a,  cg_12_ingreso b, cg_12_deudores c
 WHERE a.feciNG between v_fechad and v_fechaa and   b.tipo_rbo= 15 and 
 a.FECING=b.FECING AND a.RECING=b.RECING and a.cajing=b.cajing and a.opcaja=b.opcaja and a.recing=1 
and b.numero=c.control_deudor 

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;

end foreach;

foreach
select 0, (d.cta_mayor||'-'||d.CTA_sub01 ||"-"|| d.cta_sub02 ||"-"|| d.cta_sub03 ||"-"|| d.cta_sub04) ,d.concepto, 
('INGRESO DEL DIA'),(0),sum(e.importe_cta), 1, d.cta_mayor, d.CTA_sub01 , d.cta_sub02 , d.cta_sub03 , d.cta_sub04 
into p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen, 
p_mayor, p_sub01, p_sub02, p_sub03, p_sub04  
FROM cg_12_importes e, cg_12_cuentas d,cg_12_ingreso f
 WHERE e.feciNG between v_fechad and v_fechaa and  e.cta_aplicacion = d.cta_aplicacion and 
f.FECING=e.FECING AND f.RECING=e.RECING and f.cajing=e.cajing and f.opcaja=e.opcaja and f.tipo_rbo<>15 and e.recing=1  
group by 1,2,3,4, d.cta_mayor, d.CTA_sub01 , d.cta_sub02 , d.cta_sub03 , d.cta_sub04 

return p_momen, p_cta, p_desc, p_numcta , p_cargo , p_abono, p_origen,0,0,'' with resume;
end foreach; 
end if;
end procedure;

create function "informix".fn_getadeper(fid int,faxod int,fmesd int,faxoh int,fmesh int)
returning money(16,2) as ADEUDO;

define v_adeudo money(16,2);

select nvl(sum(importe),0) into v_adeudo
from ta_11_adeudo_local 
where  id_local=fid 
and ( (axo>faxod or (periodo>=fmesd and axo=faxod)) and
      (axo<faxoh or (periodo<=fmesh and axo=faxoh)) );

return v_adeudo;
end function;

create procedure "informix".spd_11_padronper(paxod int,pmesd int,paxoh int,pmesh int,ptip char(1))
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(1) as letra,
            char(1) as bloque,
            varchar(60) as nombre,
            decimal(8,2) as superficie,
            money(7,2) as costo_mtr2013,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo2013,
            MONEY(16,2) as recargos2013,
            MONEY(16,2) as multa,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total,
            char(5000) as folios;
  
define v_recargostotal,v_rec2001,v_rec2002,v_rec2003,v_rec2004,v_rec2005,v_rec2006,
       v_rec2007,v_rec2008,v_rec2009,v_rec2010,v_rec2011,v_rec2012,v_rec2013 MONEY(16,2);
define v_ade2001,v_ade2002,v_ade2003,v_ade2004,v_ade2005,v_ade2006,
       v_ade2007,v_ade2008,v_ade2009,v_ade2010,v_ade2011,v_ade2012,v_ade2013 MONEY(16,2);  
define v_multa MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer char(30);          define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(1);           define v_blq char(1);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 


foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota
,fn_getadeper(a.id_local,paxod,pmesd,paxoh,pmesh),0--,fn_getrecmerc(a.id_local,2013,pmes)
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_superf,v_est,v_bloqueo,v_cvecuo,
v_ade2013,v_rec2013
from ta_11_locales a,ta_11_mercados b
where b.tipo_emision=ptip and a.vigencia='A'
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,a.superficie,a.vigencia,bloqueo,a.clave_cuota
having (fn_getadeper(a.id_local,paxod,pmesd,paxoh,pmesh))>0 
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

if v_est='A' then
   if v_bloqueo=4 then
      let v_estado='VIGENTE-BLOQUEADO';
   else
      let v_estado='VIGENTE';
   end if;
else
   let v_estado='BAJA';
end if;

select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  
let v_total=0;

-- todos los periodos del local
--foreach
--select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
--into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
--from   ta_11_adeudo_local a,ta_11_fecha_desc b 
--where id_local=v_idl
 --and ( (axo>paxod or (periodo>=pmesd and axo=paxod)) and
 --     (axo<paxoh or (periodo<=pmesh and axo=paxoh)) ) 
--and b.mes=month(today)
--order by axo,periodo

-- obtiene el porcentaje de recargos
--let v_porc=0;
--let v_recargos=0;
--if today>=v_fecha_rec then
--   select sum(porcentaje_mes) into v_porc from ta_12_recargos
--   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
--         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
--else
--   select sum(porcentaje_mes) into v_porc from ta_12_recargos
--   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
--         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
--end if;

--if  v_porc is null then
--    let v_porc=0;
--end if;

--if  v_folio = 0 then
--    if v_porc > 100 then
--       let v_recargos=trunc(v_aimporte*100)/100;
--    else
--       let v_recargos=trunc(v_aimporte*v_porc)/100;
--    end if;
--else
--    if v_porc > 250 then
--       let v_recargos=trunc(v_aimporte*250)/100;
--    else
--       let v_recargos=trunc(v_aimporte*v_porc)/100;
--    end if;
--end if;

-- acumula recargos por a�o
--let v_recargostotal=v_recargostotal+v_recargos;

--end foreach; -- cierre de los periodos

-- verifica los periodos de adeudo
--select a.id_local, ( 
--(select min(axo) from ta_11_adeudo_local where id_local=a.id_local 
--and (axo<paxod  or (periodo<=pmesd and axo=paxod)))),
--((select Max(axo) from ta_11_adeudo_local where id_local=a.id_local 
--and (axo<paxoh  or (periodo<=pmesh and axo=paxoh))))
--into v_ida,v_ini,v_fin
--from   ta_11_adeudo_local a   
--where  a.id_local=v_idl 
--group by a.id_local;
--let v_periodo=trim(v_ini);
let v_periodo=2013;

-- verifica los folios de requerimientos
let v_requerimientos='';
foreach
select id_control,fecha_emision,folio,fecha_practicado,( 
(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
from   ta_15_apremios a   
where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
order by a.fecha_emision,a.folio
let v_requerimientos=trim(v_requerimientos)||v_fol||',';
end foreach; -- cierre de apremios

let v_requerimientos=substr(v_requerimientos,1,(length(v_requerimientos)-1));
let v_total=v_ade2013+v_rec2013+v_multa+v_gastos;

return trim(v_mer),v_ofi,v_nme,trim(v_sec),v_loc,trim(v_let),trim(v_blq),trim(v_nombre),v_superf,v_costomtr,
trim(v_estado),trim(v_periodo),v_ade2013,v_rec2013,v_multa,v_gastos,v_total,trim(v_requerimientos)
with resume;
end foreach; -- cierre del principal

end procedure;

CREATE PROCEDURE "informix".spd_abcrecibos(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 	char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta     smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia   integer,
		parObra         integer,
		parAxofolio     integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                partipo_che     smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc          char(1),
		parDescripcion  varchar(255)
		)
		returning integer;

		define varOperacion integer;
 define varuap_rcm  integer;
 define varpar  smallint;

--set debug file to "marco.log";
--trace on;

--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;

--si la opcion fue insertar
if 	parOpc='I' then
	
	select nvl(operacion,0) + 1
		into varOperacion 
		from ta_12_operaciones
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario;

	--if	varOperacion = 10000 then
	--	let varOperacion = 1;
	--end if;
     insert into ta_12_recibos(
     		fecha ,
     		id_rec ,
     		caja ,
     		operacion ,
     		importe ,
		cvepago ,
     		id_modulo ,
     		id_regmodulo ,
     		id_rec_cta ,
     		regmunur ,
     		mesdesde ,
     		axodesde ,
     		meshasta ,
     		axohasta ,
     		nombre ,
     		domicilio ,
     		concepto ,
     		rfcini ,
     		rfcnumero ,
     		rfccolonia ,
     		obra ,
     		axofolio ,
     		id_usuario ,
     		fecha_act,
		descripcion
     		) 
     values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current,
		parDescripcion);


	update	ta_12_operaciones set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario;
	
	if	parId_banco > 0 then
		insert	into ta_12_cheques ( fecha ,    id_rec,
    caja ,    operacion,    id_banco ,    cheque,    cuenta ,    importe ,    tipo_pag ,
    datos_internet ) values(
    			parFecha,
    			parId_rec,
    			parCaja,
    			varOperacion,
			parId_banco,
			parCheque,
			parCuenta,
			parImpCheque,
			Partipo_che ,null);
	end if;

end if;
if 	parOpc='C' then
    -- para orden de pago
    if exists(select * from ta_12_recibosdiv where fecha=parFecha and id_rec=parId_rec and
              caja=parCaja and operacion=parOperacion) then
       update ta_12_recibosdiv set caja='',operacion=0,cvepago='V'
       where fecha=parFecha and id_rec=parId_rec and
              caja=parCaja and operacion=parOperacion;
    end if; 
	
	update ta_12_recibos set
    		cvepago=parCvepago,				
    		id_usuario=parId_usuario,
		fecha_act=current
                                where
		fecha=parFecha and
		id_rec=parId_rec and
    		caja=parCaja and
    		operacion=parOperacion;

	if	parId_banco > 0 then
		delete	from ta_12_cheques where fecha=parFecha and
    			id_rec=parId_rec and caja=parCaja and operacion=parOperacion;
			
	end if;
                if   parId_modulo=13 then

	 delete from ta_13_pagosrcm where  fecing=parFecha and
		recing=parId_rec and
    		cajing=parCaja and
    		opcaja=parOperacion and
                                control_rcm=parId_regmodulo;
                 select max(axo_pago_hasta) into varuap_rcm
                             from ta_13_pagosrcm where 
                                control_rcm=parId_regmodulo;
                if varuap_rcm is null then
                 update ta_13_datosrcm set axo_pagado =1999
                            where  control_rcm=parId_regmodulo;
               else
                update ta_13_datosrcm set axo_pagado =varuap_rcm
                            where  control_rcm=parId_regmodulo;
                end if;
                 end if;	
               if   parId_modulo=16 then
	   update ta_16_pagos set  id_rec=0, caja=' ',consec_operacion=0,status_vigencia="V"
                   where  date(fecha_hora_pago)=parFecha and id_rec=parId_rec and
    		caja=parCaja and consec_operacion=parOperacion and
                                control_contrato=parId_regmodulo;
                 update ta_15_apremios set fecha_pago =0,recaudadora=0,caja='',operacion=0,vigencia='1'
                            where  modulo=16 and fecha_pago=parFecha and
		recaudadora=parId_rec and
    		caja=parCaja and
    		operacion=parOperacion;
                 end if;	
               if   (parId_modulo=17) and (parId_rec_cta  in (16,15,11))  then
	   DELETE FROM ta_17_pagos
                   where  fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
    		caja_PAGO=parCaja and operacion_PAGO=parOperacion and
                                id_convenio=parId_regmodulo;
                 end if;	
               if   (parId_modulo=17) and (parId_rec_cta  not in (16,15,11))  then
                    foreach
                    select pago_parcial    into varpar from   ta_17_conv_pagos where 
                              fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
    	              caja_PAGO=parCaja and operacion_PAGO=parOperacion and
                               id_conv_resto=parId_regmodulo
	   update ta_17_adeudos_div set clave_pago =null
                   where  id_conv_resto=parId_regmodulo and pago_parcial=varpar;
                 end foreach;
                 end if;	
               if   (parId_modulo=17) and (parId_rec_cta  not in (16,15,11))  then
	   DELETE FROM ta_17_conv_pagos
                   where  fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
    		caja_PAGO=parCaja and operacion_PAGO=parOperacion and
                                id_conv_resto=parId_regmodulo;
                 end if;	
end if;
--para orden de pago
if 	parOpc='O' then
	
	select nvl(operacion,0) + 1
		into varOperacion 
		from ta_12_operaciones
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario;

    update ta_12_recibosdiv set fecha=parFecha,id_rec=parId_rec,
           caja=parCaja,operacion=varOperacion,cvepago='P'
           where id_recibo=parOperacion;

	insert into ta_12_recibos values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current);


	update	ta_12_operaciones set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario;
	
	if	parId_banco > 0 then
		insert	into ta_12_cheques ( fecha ,    id_rec,
    caja ,    operacion,    id_banco ,    cheque,    cuenta ,    importe ,    tipo_pag ,
    datos_internet )
values(			parFecha,
    			parId_rec,
    			parCaja,
    			varOperacion,
			parId_banco,
			parCheque,
			parCuenta,
			parImpCheque,
			Partipo_che ,null);
	end if;

end if;


return varOperacion;
--trace off;

end procedure;

create function "informix".fn_getadetotmerc(fmerc int,faxo int,fmes int)
returning   money(16,2) as total;

define v_total money(16,2);


   select nvl(sum(b.importe),0) into v_total
   from ta_11_locales a,ta_11_adeudo_local b 
   where  a.num_mercado=fmerc and a.vigencia='A'
   and b.id_local=a.id_local and (b.axo<faxo  or (b.periodo<=fmes and b.axo=faxo));

return v_total;
end function;

create procedure "saranda".spd_difer(p_fec date, p_fec1 date)
      returning char(10) as deter, date as fec, int as rec, 
      char(2) as caj, int as ope, money as importe, int as cta_ap;


define v_fec date;
define v_rec int;
define v_caja char(2);
define v_ope int;
define v_imp money ;
define v_cta int;
define v_imp1 money ;
define v_cta1 int;

 
foreach

SELECT fecing, recing, cajing, opcaja 
into   v_fec, v_rec, v_caja, v_ope
 from cg_12_ingreso where fecha_mov between p_fec and p_fec1  

--   foreach
 --    SELECT importe_cta, cta_aplicacion 
  --     into   v_imp, v_cta
 --    from cg_12_importes
 --      where fecing=v_fec and recing=v_rec and cajing=v_caja and opcaja=v_ope

--       return 'ingre',v_fec, v_rec, v_caja, v_ope, v_imp, v_cta with resume;
 --   end foreach;
   foreach
   select importe,cuenta
      into   v_imp1, v_cta1
     FROM ta_12_recibosdet
    where fecha=v_fec and id_rec=v_rec and caja=v_caja and operacion=v_ope and cuenta>0

      return 'reci',v_fec, v_rec, v_caja, v_ope, v_imp1, v_cta1 with resume;
  end foreach;

end foreach;
end procedure;

create procedure "saranda".spd_15cansinade(p_foliod int, p_folioh int, p_mod int, p_reca int, p_can int)
                 returning  int as par_ok, varchar(255)as sobserv;


define v_cvereq     int;
define v_ade        money;
define v_cuantos    int;
define v_fol        int;
define v_vfolio     varchar(255);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_15cansinade ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION

let v_cuantos=0;
let v_ade=0;
let v_vfolio='';

foreach
  select id_control, folio into v_cvereq, v_fol
  from ta_15_apremios where zona= p_reca and folio between p_foliod and p_folioh and modulo=p_mod and vigencia=1
  
  execute procedure spd_15_sinade(v_fol, p_mod, p_reca) into v_ade;  
  if v_ade=0 then
     let v_cuantos=v_cuantos+1;
     let v_vfolio = v_vfolio || v_fol || ',';
     if p_can > 0 then
        update ta_15_apremios set vigencia=3, fecha_pago=today, observaciones='Se Cancela Requerimiento Masivamente por no existir adeudos '
        where id_control=v_cvereq;
     end if;
  end if;
end foreach;
if p_can > 0 then
   return v_cuantos, ' Folios Cancelados que no tienen Adeudo '||v_vfolio;
else
   return v_cuantos, ' Folios sin Adeudo '||v_vfolio;
end if;
end procedure;

CREATE PROCEDURE "pgmoreno".con16_fact_01 ( par_Ade Char(1), par_Rcgo Char(1), par_Axo Smallint, par_Mes Smallint )
                returning VarChar(80) as TipoAseo,
		Integer as NumContrato,
		VarChar(80) as Empresa,
		VarChar(80) as Domicilio,
		Char(1) as Vigencia,
                               Money(12,2) as Importe;
               

{
#  Procedimiento: con16_fact_01
#  Descripcion:  Opciones : Consulta_Facturacion
#  Parametros de entrada: tabla, control y periodo de fin de obligacion
#  Parametros de salida:   Control, concesionario, superficie, tipo de local, licencia e importe con y sin recargos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_tipo_Aseo, v_empresa, v_domicilio					VarChar(80);
  define v_control_contrato, v_num_contrato					Integer;
  define v_status_vigencia, v_limite						Char(1);
  define Dia_v								Smallint;
  define v_importe, v_recargo, v_importe_rgo, v_por_recargo, v_importe_total		Money(12,2);
  define v_periodo								Date;

  define v_Periodo_CN, v_Periodo_EXE						varchar(7);


  EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;  

       Select  Day(fechalimite)
           Into Dia_v
       From t34_fechalimite
               Where Month(fechalimite) = Month(Current) and Year(fechalimite) = Year(Current);

      if Day(Current) > Dia_v then
         Let v_limite = 'S';
      else
         Let v_limite = 'N';
      end if;


FOREACH
	SELECT a.control_contrato, b.descripcion, a.num_contrato, c.descripcion, a.domicilio, a.status_vigencia
		INTO v_control_contrato, v_tipo_Aseo, v_num_contrato, v_empresa, v_domicilio, v_status_vigencia
		FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c
		WHERE b.ctrol_aseo = a.ctrol_aseo
		AND c.ctrol_emp = a.ctrol_emp AND c.num_empresa = a.num_empresa
		ORDER BY a.ctrol_aseo, a.num_contrato
                
                               if par_Ade = 'A' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
			Let v_recargo = 0;
                                               if exists( SELECT *  FROM ta_16_pagos   WHERE control_contrato = v_control_contrato  
				AND aso_mes_pago = par_Axo || '-' || par_Mes  AND status_vigencia in ('V','P') ) then
                                                               SELECT aso_mes_pago, importe, status_vigencia  INTO v_periodo, v_importe, v_status_vigencia
                                                               FROM ta_16_pagos
                                                               WHERE control_contrato = v_control_contrato  AND aso_mes_pago = par_Axo || '-' || par_Mes  AND status_vigencia in ('V','P');

                                                               if v_status_vigencia = 'V'  then
					if par_Rcgo = 'S' then
                                                                              		if v_importe > 0 then 
                                                                                              		if v_limite = 'S' then
                                                                                                              		Select sum(por_recargo) 
                                                                                                              		Into v_por_recargo
                                                                                                              		From t34_porcentajes 
                                                                                                              		Where periodo_porc between (v_periodo) and (v_Periodo_CN);

                                                                                                             		if v_por_recargo > 0 then
                                                                                                                             		Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
                                                                                                              		else
                                                                                                                              		Let v_importe_rgo = 0;
                                                                                                              		end if;
							else
								Let v_importe_rgo = 0;
                                                                                              		end if;
						else
							Let v_importe_rgo = 0;
						end if;
					else
						Let v_importe_rgo = 0;
					end if;
                                                                              Let v_importe_total = v_importe + v_importe_rgo;
				else
                                                                              Let v_importe_total = v_importe + v_recargo;
				end if;
				if v_importe_total > 0 then
					RETURN v_tipo_Aseo, v_num_contrato, v_empresa, v_domicilio, v_status_vigencia,  v_importe_total    with resume;
				end if;				
                                                end if;
                               end if;
                               if par_Ade = 'B' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
			Let v_recargo = 0;
                                               if exists( SELECT *  FROM ta_16_pagos   WHERE control_contrato = v_control_contrato  
				AND aso_mes_pago = par_Axo || '-' || par_Mes  AND status_vigencia in ('V') ) then
                                                               SELECT aso_mes_pago, importe, status_vigencia  INTO v_periodo, v_importe, v_status_vigencia
                                                               FROM ta_16_pagos
                                                               WHERE control_contrato = v_control_contrato  AND aso_mes_pago = par_Axo || '-' || par_Mes  AND status_vigencia in ('V');

					if par_Rcgo = 'S' then
                                                                              		if v_importe > 0 then 
                                                                                              		if v_limite = 'S' then
                                                                                                              		Select sum(por_recargo) 
                                                                                                              		Into v_por_recargo
                                                                                                              		From t34_porcentajes 
                                                                                                              		Where periodo_porc between (v_periodo) and (v_Periodo_CN);

                                                                                                             		if v_por_recargo > 0 then
                                                                                                                             		Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
                                                                                                              		else
                                                                                                                              		Let v_importe_rgo = 0;
                                                                                                              		end if;
							else
								Let v_importe_rgo = 0;
                                                                                              		end if;
						else
							Let v_importe_rgo = 0;
						end if;
					else
						Let v_importe_rgo = 0;
					end if;
				Let v_importe_total = v_importe + v_importe_rgo;
				if v_importe_total > 0 then
					RETURN v_tipo_Aseo, v_num_contrato, v_empresa, v_domicilio, v_status_vigencia,  v_importe_total    with resume;
				end if;				
                                               end if;
                               end if;
                               if par_Ade = 'C' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
			Let v_recargo = 0;
                                               if exists( SELECT *  FROM ta_16_pagos   WHERE control_contrato = v_control_contrato  
				AND aso_mes_pago = par_Axo || '-' || par_Mes  AND status_vigencia in ('P') ) then
                                                               SELECT aso_mes_pago, importe, status_vigencia  INTO v_periodo, v_importe, v_status_vigencia
                                                               FROM ta_16_pagos
                                                               WHERE control_contrato = v_control_contrato  AND aso_mes_pago = par_Axo || '-' || par_Mes  AND status_vigencia in ('P');

                                                               if v_importe > 0 then
                                                                              Let v_importe_total = v_importe + v_recargo;
                                                               else
                                                                              Let v_importe_total = 0;
                                                               end if;                                                                 
				if v_importe_total > 0 then
					RETURN v_tipo_Aseo, v_num_contrato, v_empresa, v_domicilio, v_status_vigencia,  v_importe_total    with resume;
				end if;				
                                               end if;
                               end if;

END FOREACH;
--trace off;

                                           
end procedure;

CREATE PROCEDURE "informix".con34_rfact_02 ( par_Ade Char(1), par_Rcgo Char(1), par_Axo Smallint, par_Mes Smallint )
                returning Char(10) as Control,
                               VarChar(200) as Concesionario,
                               Decimal(7,2) as Superficie,
                               VarChar(100) as Tipo,
                               Integer as Licencia,
                               Money(15,2) as Importe;
               

{
#  Procedimiento: con34_RFact_01
#  Descripcion:  Opciones : Consulta_Facturacion
#  Parametros de entrada: opci�n de reporte, con o sin recargos y periodo de corte
#  Parametros de salida:   Control, concesionario, superficie, tipo de local, licencia e importe con y sin recargos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_control                                                                                                                                         Char(10);
  define v_concesionario                                                                                                                           VarChar(200);
  define v_superficie                                                                                                                                   Decimal(7,2);
  define v_descripcion                                                                                                                VarChar(100);
  define v_licencia, v_id_34_datos, v_id_34_pagos                                                                       Integer;
  define v_importe, v_recargo, v_por_recargo, v_importe_rgo, v_importe_total                                          Money(12,2);
  define v_cve_stat, v_limite                                                                                                                   Char(1);
  define v_periodo                                                                                                                                       Date;

  define v_Periodo_CN, r_Periodo_CN                                                                                               varchar(7);
  define Dia_v                                                                                                                                 Smallint;
--set debug file to "rfact01";
--trace on;
--************************************************************************

--************************************************************************ STATUS CONCESION/LOCAL
--SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = '3' and cve_stat = 'C' ;
--************************************************************************

       Select  Day(fechalimite)
           Into Dia_v
       From t34_fechalimite
               Where Month(fechalimite) = Month(Current) and Year(fechalimite) = Year(Current);

     if Day(Current) > Dia_v then
         Let v_limite = 'S';
      else
         Let v_limite = 'N';
      end if;

  EXECUTE PROCEDURE con34_1lperiodo () INTO v_Periodo_CN;
  -- pedazo adicionado
  Let r_Periodo_CN = v_Periodo_CN;



FOREACH
                SELECT a.id_34_datos, a.control, a.concesionario, a.superficie, a.licencia, b.descripcion  INTO v_id_34_datos, v_control, v_concesionario, v_superficie, v_licencia, v_descripcion 
                               FROM t34_datos a, t34_unidades b
                              WHERE a.cve_tab = '3'  AND b.id_34_unidad = a.id_unidad
                               ORDER BY a.concesionario
                
                               if par_Ade = 'A' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
                                               Let v_recargo = 0;
                                               if exists( SELECT a.*  FROM t34_pagos a, t34_status b   WHERE a.id_datos = v_id_34_datos 
                                                               AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V','P') ) then
                                                               SELECT a.periodo, a.importe, a.recargo, a.id_34_pagos, b.cve_stat  INTO v_periodo, v_importe, v_recargo, v_id_34_pagos, v_cve_stat 
                                                               FROM t34_pagos a, t34_status b 
                                                               WHERE a.id_datos = v_id_34_datos AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V','P');

                                                               if v_cve_stat = 'V'  then
                                                                              if par_Rcgo = 'S' then
                                                                                                              if v_importe > 0 then 
                                                                                                                             if v_limite = 'S' then
                                                                                                                                             Select sum(por_recargo) 
                                                                                                                                             Into v_por_recargo
                                                                                                                                             From t34_porcentajes 
                                                                                                                                             Where periodo_porc between (v_periodo) and (v_Periodo_CN);

                                                                                                                             if v_por_recargo > 0 then
                                                                                                                                                             Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
                                                                                                                                             else
                                                                                                                                                             Let v_importe_rgo = 0;
                                                                                                                                             end if;
                                                                                                              else
                                                                                                                             Let v_importe_rgo = 0;
                                                                                                                             end if;
                                                                                              else
                                                                                                              Let v_importe_rgo = 0;
                                                                                              end if;
                                                                              else
                                                                                              Let v_importe_rgo = 0;
                                                                              end if;
                                                                              Let v_importe_total = v_importe + v_importe_rgo;
                                                               else
                                                                              Let v_importe_total = v_importe + v_recargo;
                                                               end if;
                                                                              RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, v_importe_total  with resume;
                                               else
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, 0  with resume;
                                                end if;
                               end if;
                               if par_Ade = 'B' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
                                               Let v_recargo = 0;
                                               if exists( SELECT a.*  FROM t34_pagos a, t34_status b   WHERE a.id_datos = v_id_34_datos 
                                                               AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V') ) then
                                                               SELECT a.periodo, a.importe, a.recargo, a.id_34_pagos, b.cve_stat  INTO v_periodo, v_importe, v_recargo, v_id_34_pagos, v_cve_stat 
                                                               FROM t34_pagos a, t34_status b 
                                                               WHERE a.id_datos = v_id_34_datos AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V');

                                                                              if par_Rcgo = 'S' then
                                                                                                              if v_importe > 0 then 
                                                                                                                             if v_limite = 'S' then
                                                                                                                                             Select sum(por_recargo) 
                                                                                                                                             Into v_por_recargo
                                                                                                                                             From t34_porcentajes 
                                                                                                                                             Where periodo_porc between (v_periodo) and (v_Periodo_CN);

                                                                                                                             if v_por_recargo > 0 then
                                                                                                                                                             Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
                                                                                                                                             else
                                                                                                                                                             Let v_importe_rgo = 0;
                                                                                                                                             end if;
                                                                                                              else
                                                                                                                             Let v_importe_rgo = 0;
                                                                                                                             end if;
                                                                                              else
                                                                                                              Let v_importe_rgo = 0;
                                                                                              end if;
                                                                              else
                                                                                              Let v_importe_rgo = 0;
                                                                              end if;
                                                               Let v_importe_total = v_importe + v_importe_rgo;
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, v_importe_total  with resume;
                                               else
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, 0  with resume;
                                               end if;
                               end if;
                               if par_Ade = 'C' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
                                               Let v_recargo = 0;
                                               if exists( SELECT a.*  FROM t34_pagos a, t34_status b   WHERE a.id_datos = v_id_34_datos 
                                                               AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('P') ) then
                                                               SELECT a.periodo, a.importe, a.recargo, a.id_34_pagos, b.cve_stat  INTO v_periodo, v_importe, v_recargo, v_id_34_pagos, v_cve_stat 
                                                               FROM t34_pagos a, t34_status b 
                                                               WHERE a.id_datos = v_id_34_datos AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('P');

                                                               if v_importe > 0 then
                                                                              Let v_importe_total = v_importe + v_recargo;
                                                               else
                                                                              Let v_importe_total = 0;
                                                               end if;                                                                 
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, v_importe_total  with resume;
                                               else
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, 0  with resume;
                                               end if;
                               end if;

END FOREACH;
--trace off;

                                           
end procedure;

CREATE PROCEDURE "informix".upd34_ade_01 ( par_id_34_datos Integer, par_Axo Integer, par_Mes Integer, par_Fecha Date, par_Id_Rec Integer, 
				par_Caja Char(2), par_Consec Integer, par_Folio_rcbo Char(15), par_tab Char(1), par_status Char(1), par_Opc Char(1) )
                returning Integer as Status,
		VarChar(200) as Concepto_status;

define v_id_34_stat, v_id_control				Integer;
define v_importe_gastos					Money(12,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'upd34_Ade_01 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION


Let v_id_control = 0;
Let v_importe_gastos = 0;
--************************************************************************ STATUS
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = par_tab and cve_stat = par_status;
--************************************************************************

if par_Opc = 'A' then  -- entrada por cajero
	if par_status = 'P' then
		UPDATE t34_pagos SET
			fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec,  caja = par_Caja,
			operacion = par_Consec,  folio_recibo = par_Folio_rcbo,  usuario = user,  id_stat = v_id_34_stat
		WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;

		FOREACH
			SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos
                      			FROM ta_15_apremios
                       			WHERE modulo = 34  AND control_otr = par_id_34_datos  AND vigencia = "1" AND clave_practicado = "P"
				if exists ( select * from ta_15_apremios where id_control = v_id_control ) then
					UPDATE ta_15_apremios SET
						fecha_pago = par_Fecha, recaudadora = par_Id_Rec,  caja = par_Caja,  
						operacion = par_Consec,  importe_pago = v_importe_gastos,  vigencia = '2'
						WHERE id_control = v_id_control;
				end if;
		END FOREACH;

		return 0,'Cajero - Pago aplicado correctamente';
	else
		-- aqui insertar el guardar en el historico de movimientos
		UPDATE t34_pagos SET
			fecha_hora_pago = Null,  id_recaudadora = Null,  caja = Null,
			operacion = Null,  folio_recibo = Null,  usuario = user,  id_stat = v_id_34_stat
		WHERE fecha_hora_pago = par_Fecha and id_recaudadora = par_Id_Rec and caja = par_Caja and operacion = par_Consec ;

		FOREACH
			SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos
                      			FROM ta_15_apremios
                       			WHERE modulo = 34  AND control_otr = par_id_34_datos  AND vigencia = "2" AND clave_practicado = "P"
				if exists ( select * from ta_15_apremios where id_control = v_id_control ) then
					UPDATE ta_15_apremios SET
						fecha_pago = Null, recaudadora = 0,  caja = ' ',  
						operacion = 0,  importe_pago = 0,  vigencia = '1'
                       					WHERE id_control = v_id_control;
				end if;


		END FOREACH;

		return 0,'Cajero - Cancelacion de recibo y reactivacion de folios aplicada correctamente';
	end if;
else	
	UPDATE t34_pagos SET
		fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec,  caja = par_Caja,
		operacion = par_Consec,  folio_recibo = par_Folio_rcbo,  usuario = user,  id_stat = v_id_34_stat
		WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;
	if par_status = 'P' then
		return 0,'Pago aplicado correctamente';
	end if;
	if par_status = 'S' then
		return 0,'Condonacion aplicada correctamente';
	end if;
	if par_status = 'C' then
		return 0,'Cancelacion aplicada correctamente';
	end if;
	if par_status = 'R' then
		return 0,'Prescripcion aplicada correctamente';
	end if;
end if;

end procedure;

CREATE PROCEDURE "informix".con34_rdetade_021 ( p_id_datos Integer )
                returning Integer as Registro,                     -- control del registro
                               Date as Periodo,              -- Periodo
                               Money(12,2) as Importe,            -- Importe Adeudos
                               Money(12,2) as Recargo;            -- Importe Recargos
               

{
#  Procedimiento: con34_rdetade_021
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_id_datos : id de busqueda de pagos del local
#  Parametros de salida:   Control :   dato de control del registro
#                                      Periodo : el dato del a�o y mes
#                                      Importe : El importe de los Adeudos
#                                      Importe : El importe de los Recargos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** DETALLE DE ADEUDO
  define v_Periodo_CN                                                                                               varchar(7);
  define v_id_34_pagos, v_id_datos                                                                                     integer;
  define v_periodo                                                                                                                       date;
  define v_importe, v_recargo                                                                                                money(12,2);
  define v_cve_stat                                                                                                                      char(1);
--****************************************************************************************************************************** 

  EXECUTE PROCEDURE con34_1lperiodo () INTO v_Periodo_CN;

FOREACH
SELECT a.id_34_pagos, a.id_datos, a.periodo, a.importe, a.recargo, b.cve_stat
INTO     v_id_34_pagos, v_id_datos, v_periodo, v_importe, v_recargo, v_cve_stat
FROM t34_pagos a, t34_status b 
WHERE a.id_datos = p_id_datos AND a.periodo <= v_Periodo_CN
AND b.id_34_stat = a.id_stat AND b.cve_stat = 'V'
ORDER BY a.periodo
   if v_importe > 0 then
      RETURN v_id_34_pagos, v_periodo, v_importe, v_recargo with resume;
   end if;
END FOREACH;

end procedure
;

CREATE PROCEDURE "informix".con34_1detade_01 ( p_Control Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
                returning varchar(255),    -- Concepto
                               Money(12,2),    -- Importe Adeudos
                              Money(12,2);    -- Importe Recargos
               

{
#  Procedimiento: Con34_1detade_01
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#                                      Importe : El importe de los Adeudos
#                                      Importe : El importe de los Recargos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                                    Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq                                                                   Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos                                                    Money(12,2);
  define v_DetFolReq                                                                                                  varchar(120);
  define v_diligencia                                                                                                                     char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago                                                                                                        Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2                                 Money(12,2);
  define v_Mes                                                                                                               varchar(2);

  define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato                                                      Integer;
  define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato                                      varchar(120);

       define v_Importe_recargo, v_TotRecargos, v_Reg_1                                                           Money(12,2);
       define v_mensaje_proc                                                                                                     varchar(255);
--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE                             varchar(7);
  define v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade                                                        varchar(7);
  --define v_Periodo_CN, v_Periodo_EXE                                                                                          varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo                                                                           Integer;
--****************************************************************************************************************************** 
   Let v_Contador = 0;
   
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_rec1 = 0;
   Let v_importe_rec2 = 0;
   Let v_axo = 0;
                Let v_Lineas_Dato = 0;

  -- requerimientos
  -- requerimientos termina

  -- fecha_limite
                EXECUTE PROCEDURE con34_1lperiodo () INTO v_Periodo_CN;  
  -- fecha limite termina

  -- pedazo adicionado
   -- poner aqui la fecha de vencidos

  Let r_Periodo_CN = v_Periodo_CN;
  if p_Rep <> 'V' then
     Let v_Periodo_CN = p_Fecha_fin;
  end if;


  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to aso_actual 

                -------------------------------------CONSULTA DE CUOTA NORMAL
                               Let v_Lineas_CN = 0;
                               --Let v_Detalle_CN = ' C.N. Mes(s) --';
                               Let v_Detalle_CN = ' Mes(s) --';

                               foreach
                                               Select Year(h.periodo), h.periodo,  h.importe, Month(h.periodo)
                                                              Into v_axo, v_aso_mes_pago, v_importe, v_Mes 
                                                               From t34_pagos H, t34_status b
                                                               Where H.id_datos = p_Control 
                                                              and H.periodo <= ( v_Periodo_CN ) 
                                                               and Year(h.periodo) = aso_proceso       
                                                              and b.id_34_stat = h.id_stat and b.cve_stat = 'V'
                                                               Order By h.periodo

                               if v_importe > 0 then
                                               Select sum(por_recargo) 
                                               Into v_Importe_recargo
                                                From t34_porcentajes
                                                Where periodo_porc between (v_aso_mes_pago) and (r_Periodo_CN);
                               end if;

                               if v_importe > 0 then
                                    if v_Lineas_CN > 0 then
                                         Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                                    else
                                         Let v_Detalle_CN = v_Detalle_CN||v_Mes;
                                   end if;
                                   Let v_totAdeudos = v_totAdeudos + v_importe;
                                   Let v_Lineas_CN = v_Lineas_CN + 1;
                                   if v_Importe_recargo <> 0 then
                                      Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       --EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                       --if v_importe_rec2 > 0 then
                                        -- Let v_TotRecargos = v_TotRecargos + (v_importe_rec1 - v_importe_rec2);  -- modificado de sumando a restando
                                        --  Let v_Lineas_Dato = v_Lineas_Dato + 1;
                                       --else
                                         Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
                                       --end if;
                                   end if;
                                    Let v_Contador = v_Contador + 1;
                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;
                               end foreach;

--     Grabando registro
   if  (v_Lineas_CN > 0) then
       --Let v_Detalle_T = 'Adeudos del ' || aso_proceso || ' ';
       Let v_Detalle_T = 'Adeudos por Arrendamiento del ' || aso_proceso;  -- Adicionado la leyenda de Adeudos por Arrendamiento del
       if v_Lineas_CN > 0 then
                Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       end if;
       return v_Detalle_T , v_totAdeudos, v_TotRecargos  with resume;
       Let v_Contador = v_Contador + 1;
   end if;


   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;

  END FOR;

   if v_Contador = 0 then
       return 'NO HAY ADEUDO DENTRO DEL PERIODO SELECCIONADO' , Null, Null  with resume;
   else
       if v_Lineas_Dato > 0 then
          return v_Detalle_Dato , Null, Null  with resume;
       end if;
   end if;

end procedure;

CREATE PROCEDURE "informix".con34_1detade_02 ( p_Control Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
                returning varchar(100),     -- Concepto
              Integer,                         -- Cantidad de recoleccion
              Money(12,2),    -- Importe Adeudos/multa
              Money(12,2);    -- Importe Recargos/gastos
               

{
#  Procedimiento: con34_1detade_02
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Fecha :   Periodo de Adeudo   
#                                      Concepto : El concepto de cobro
#                                      Numero : Unidades recolectadas
#                                      Importe : El importe de los Adeudos/multa
#                                      Importe : El importe de los Recargos/gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                                    Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq, v_Lineas_Dato                                                   Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos                                                    Money(12,2);
  define v_DetFolReq                                                                                                  varchar(120);
  define v_diligencia                                                                                                                     char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago                                                                                                        Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2                                 Money(12,2);

  define v_Ctrol_Operacion, v_exedencias                                                                        Integer;
  define v_descripcion                                                                                                 varchar(50);
  define v_Detalle_Dato                                                                                                             varchar(100);

       define v_Importe_recargo, v_TotRecargos                                                               Money(12,2);
       define v_mensaje_proc                                                                                                     varchar(255);
--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE                             varchar(7);
  define v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade                                                        varchar(7);
  define v_Periodo                                                                                                                       varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo, v_Mes                                                           Integer;
--****************************************************************************************************************************** 
-- set debug file to 'Gil.log';
-- trace on;   
Let v_Contador = 0;
   
   Let v_descripcion = 'Cuota Normal ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_rec1 = 0;
   Let v_importe_rec2 = 0;
   Let v_axo = 0;
                Let v_Lineas_Dato = 0;


  -- fecha_limite
                EXECUTE PROCEDURE con34_1lperiodo () INTO v_Periodo_CN;  
  -- fecha limite termina



  -- pedazo adicionado
  Let r_Periodo_CN = v_Periodo_CN;
  if p_Rep <> 'V' then
     Let v_Periodo_CN = p_Fecha_fin;
  end if;
  -- pedazo adicionado termina

                               foreach
                                               Select Year(h.periodo), h.periodo,  h.importe, Month(h.periodo)
                                                              Into v_axo, v_aso_mes_pago, v_importe, v_Mes 
                                                               From t34_pagos H, t34_status b
                                                               Where H.id_datos = p_Control 
                                                              and H.periodo <= ( v_Periodo_CN ) 
                                                              and b.id_34_stat = h.id_stat and b.cve_stat = 'V'
                                                               Order By h.periodo
             
                               if v_importe > 0 then
                                               Select sum(por_recargo) 
                                               Into v_Importe_recargo
                                                From t34_porcentajes
                                                Where periodo_porc between (v_aso_mes_pago) and (r_Periodo_CN);
                               end if;

                               if v_importe > 0 then
                                   Let v_totAdeudos = v_totAdeudos + v_importe;
                                   if v_Importe_recargo <> 0 then
                                      Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       --EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                       --if v_importe_rec2 > 0 then
                                       --  Let v_TotRecargos = v_importe_rec1 - v_importe_rec2;  -- modificado de sumando a restando
                                       --else
                                         Let v_TotRecargos = v_importe_rec1;
                                       --end if;
                                   end if;
                                   RETURN 'Adeudo por Periodo de Arrendamiento del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), null, v_importe, v_TotRecargos                 with resume;
                                   --RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), null, v_importe, v_TotRecargos                 with resume;
                                    Let v_Contador = v_Contador + 1;
                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;

                               Let v_totAdeudos = 0;
                               Let v_TotRecargos = 0;
                               end foreach;



   if v_Contador = 0 then
       return 'NO HAY ADEUDO DENTRO DEL PERIODO SELECCIONADO' , Null, Null, Null  with resume;
   else
       if v_Lineas_Dato > 0 then
          return v_Detalle_Dato, Null, Null, Null       with resume;
       end if;
   end if;
--trace off;
end procedure
;

CREATE PROCEDURE "informix".upd34_rastro_01 ( par_opc Integer, par_id_34_datos Integer, par_conces Char(200), par_ubica Char (200), 
				      par_lic Integer, par_sup Money(7,2), par_Descrip Char(100), par_Axo_Ini Smallint, par_Mes_Ini Smallint )
	returning Integer,    	          -- Status
		varchar(100);     -- Concepto status
               

{
#  Procedimiento: upd34_Rastro_01
#  Descripcion:  Opciones : Cancelar
#  Parametros de entrada: tabla, control y periodo de fin de obligacion
#  Parametros de salida:   Status del Procedimiento
#		         Concepto del Procedimiento
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_id_34_datos, v_IdPoliza							Integer;

  define v_id_unidad								Integer;
  define v_costo									Money(12,2);

 define v_id_34_stat								Integer;

 define v_mes, aso_inicio, aso_actual, mes_actual						Integer;
 define v_importe_reg, v_suma_adeudos, v_suma_recargos, v_Importe_recargo, v_importe_rec1	Money(12,2);
 define v_fecha_inicio								Date;

--************************************************************************


--************************************************************************MOMENTOS CONTABLES
define v_ctaaplica, v_origen		integer;
define v_cta_m11, v_cta_m21 	CHAR(4);
define v_cta_m12, v_cta_m22 	CHAR(2);
define v_cta_m13, v_cta_m23 	CHAR(4);
define v_cta_m14, v_cta_m24 	CHAR(5);
define v_cta_m15, v_cta_m25 	CHAR(5);
--************************************************************************

Let aso_inicio = par_Axo_Ini;
if par_Axo_Ini = Year(Current) then
   Let aso_actual = par_Axo_Ini;
else
   Let aso_actual = Year(Current);
end if;
Let v_id_34_datos = 0;
Let mes_actual = Month(Current);

--************************************************************************ STATUS CONCESION/LOCAL
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = '3' and cve_stat = 'C' ;
--************************************************************************

--  EVITAR QUE EL EJERCICIO NO EXCEDA DE MAS DE 1 A�O DE ANTERIORIDAD ( A�O ACTUAL O PASADO )
    if exists( Select * from t34_datos Where id_34_datos = par_id_34_datos ) then
	if par_opc < 3 then
		if par_opc = 0 then		-- CONCESIONARIO
                   		UPDATE t34_datos SET  concesionario = par_conces	Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo el Concesionario del Local';
		end if;
		if par_opc = 1 then		-- UBICACION
                   		UPDATE t34_datos SET  ubicacion = par_ubica		Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo La Ubicacion del Local';
		end if;
		if par_opc = 2 then		-- LICENCIA
                   		UPDATE t34_datos SET  licencia = par_lic		Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo el dato del No. de Licencia del Local';
		end if;
	end if;
		if par_opc = 3 then		-- SUPERFICIE
			UPDATE t34_datos SET  superficie = par_sup	Where id_34_datos = par_id_34_datos;
		    	if par_Axo_Ini < aso_actual  then   --************************************* ACTUALIZA ADEUDOS DE A�OS ANTERIOR
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

				-- suma importes de registros vigentes antes de cambiarlos ( todo el a�o )
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = 1 to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	if par_Axo_Ini = aso_actual then    --************************************* ACTUALIZA ADEUDOS DEL A�O EN CURSO
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
			RETURN 0,'Se actualizo Adeudos por cambio de Superficie';
		end if;

		if par_opc = 4 then		-- TIPO LOCAL
			SELECT id_34_unidad INTO v_id_unidad FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip;
			UPDATE t34_datos SET  id_unidad = v_id_unidad	Where id_34_datos = par_id_34_datos;
		    	if par_Axo_Ini < aso_actual  then   --************************************* ACTUALIZA ADEUDOS DE A�OS ANTERIOR
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

				-- suma importes de registros vigentes antes de cambiarlos ( todo el a�o )
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = 1 to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	if par_Axo_Ini = aso_actual then    --************************************* ACTUALIZA ADEUDOS DEL A�O EN CURSO
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
			RETURN 0,'Se actualizo Adeudos por cambio de Tipo de Local';
		end if;

		if par_opc = 5 then		-- CAMBIO DE INICIO DE OBLIGACION
		      SELECT fecha_inicio INTO v_fecha_inicio FROM t34_datos  Where id_34_datos = par_id_34_datos;
 		      if mdy(par_Mes_Ini, 01, par_Axo_Ini) < mdy(Month(v_fecha_inicio), Day(v_fecha_inicio), Year(v_fecha_inicio)) then
			-- solo crear periodos faltantes
		    	if par_Axo_Ini < aso_actual  then   --************************************* ACTUALIZA ADEUDOS DE A�OS ANTERIOR
				-- suma importes de registros vigentes antes de adicionar periodos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
					if not exists( Select * from t34_pagos Where id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes ) then
			       			Insert into t34_pagos values
		                       			( 0, par_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat);
					end if;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros totales para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

				-- suma importes de registros vigentes antes de cambiarlos ( todo el a�o )
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = 1 to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
					if not exists( Select * from t34_pagos Where id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes ) then
			       			Insert into t34_pagos values
		                       			( 0, par_id_34_datos, mdy(v_mes,01,aso_actual), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat);
					end if;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	if par_Axo_Ini = aso_actual then    --************************************* ACTUALIZA ADEUDOS DEL A�O EN CURSO
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip;
				SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
					if not exists( Select * from t34_pagos Where id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes ) then
			       			Insert into t34_pagos values
		                       			( 0, par_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat);
					end if;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	UPDATE t34_datos SET  fecha_inicio = mdy(par_Mes_Ini, 01, par_Axo_Ini)	Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo Adeudos por cambio de Inicio de Obligacion del Local';
		      else
			-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
			DELETE FROM t34_pagos Where id_datos = par_id_34_datos and periodo < par_Axo_Ini || '-' || par_Mes_Ini;
			-- suma importes de registros modificados para crear la poliza contable
			-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

		     	UPDATE t34_datos SET  fecha_inicio = mdy(par_Mes_Ini, 01, par_Axo_Ini)	Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo Adeudos por cambio de Inicio de Obligacion del Local';
		
		      end if;
		end if;
    else
        RETURN 1,'No se puede dar de baja una Concesion/Local que no existe';
    end if;

end procedure;

CREATE PROCEDURE "informix".ins34_rastro_01 ( par_tabla Char(1), par_control Char(10), par_conces Char(200), par_ubica Char (200), 
                                                                   par_sup Money(7,2), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_ofna Integer, par_sector Char(1), par_zona Integer, 
                                                                   par_lic Integer, par_Descrip Char(100) )
                returning Integer,                     -- Status
                               varchar(100);     -- Concepto status
               

{
#  Procedimiento: ins34_Rastro_01
#  Descripcion:  Opciones de Contratos Inserta, cancela, actualiza
#  Parametros de entrada: Todos los datos del contrato
#  Parametros de salida:   Status del Procedimiento
#                                      Concepto del Procedimiento
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_id_34_datos, v_IdPoliza                                                                                                       Integer;

  define v_id_34_unidad                                                                                                                           Integer;
  define v_costo                                                                                                                                            Money(12,2);

define v_id_34_stat                                                                                                                   Integer;

define v_mes, aso_inicio, aso_actual, mes_actual                                                                                       Integer;
define v_importe_reg, v_suma_adeudos, v_suma_recargos, v_Importe_recargo, v_importe_rec1    Money(12,2);

--************************************************************************


--************************************************************************MOMENTOS CONTABLES
define v_ctaaplica, v_origen                     integer;
define v_cta_m11, v_cta_m21                 CHAR(4);
define v_cta_m12, v_cta_m22                 CHAR(2);
define v_cta_m13, v_cta_m23                 CHAR(4);
define v_cta_m14, v_cta_m24                 CHAR(5);
define v_cta_m15, v_cta_m25                 CHAR(5);
--************************************************************************

Let aso_inicio = par_Axo_Ini;
if par_Axo_Ini = Year(Current) then
   Let aso_actual = par_Axo_Ini;
else
   Let aso_actual = Year(Current);
end if;
Let v_id_34_datos = 0;
Let mes_actual = Month(Current);

--************************************************************************ UNIDADES
SELECT id_34_unidad, costo INTO v_id_34_unidad, v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip;
--************************************************************************ STATUS CONCESION/LOCAL
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = '3' and cve_stat = 'V' ;
--************************************************************************

--  EVITAR QUE EL EJERCICIO NO EXCEDA DE MAS DE 1 A�O DE ANTERIORIDAD ( A�O ACTUAL O PASADO )
    if not exists(Select * from t34_datos Where cve_tab = par_tabla and control = par_control) then

                               insert into t34_datos values (0, par_tabla, par_control, par_conces, par_ubica, par_sup, mdy(par_Mes_Ini, 01, par_Axo_Ini), null, 
                                                                              par_ofna, par_sector, par_zona, par_lic, user, today, null, v_id_34_unidad, v_id_34_stat);
                               LET v_id_34_datos = dbinfo("sqlca.sqlerrd1");

                               if v_id_34_datos > 0 then  --************************************* GENERACION DE ADEUDOS DEL A�O ANTERIOR
                                               if par_Axo_Ini < aso_actual  then    
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
                                                               SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip;
                                                               SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
                                                               Let v_importe_reg = par_sup * v_costo;
                                                               FOR v_mes = par_Mes_Ini to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              --EXECUTE PROCEDURE con16_Rcgos ('CN', par_Axo_Ini || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              --Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    

                                                                              Insert into t34_pagos values
                                                                              ( 0, v_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;

                                                                                              --  ************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
                                                               SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip;
                                                               SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
                                                               Let v_importe_reg = par_sup * v_costo;
                                                               FOR v_mes = 1 to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              --EXECUTE PROCEDURE con16_Rcgos ('CN', aso_actual || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              --Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    
                                                               
                                                                              Insert into t34_pagos values
                                                                              ( 0, v_id_34_datos, mdy(v_mes,01,aso_actual), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat);
                                                                              --Insert into ta_16_Pagos values
                                                                              --( v_control_contrato, mdy(v_mes, 01, aso_actual), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec, v_importe_rec1, 0);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;

                                                                                              --  ************************************* GENERACION DE POLIZA CONTABLE DEL A�O EN CURSO
                                                               --EXECUTE PROCEDURE cg_generapoliza (mdy( 01, 01, aso_actual), aso_actual, 01, 3, 16, 1, v_id_rec, 
                                                               --                                            'MODIFICACION AL PRESUPUESTO ACTUAL', 'ejecucion del proceso ins16_contrato_01', 'A',43) INTO v_IdPoliza;      
                                                               --            if v_IdPoliza > 0 then
                                                               --                            foreach;
                                                               --                            EXECUTE PROCEDURE cg_Momentos ( 'AP', 1 ) INTO v_ctaaplica, v_origen, 
                                                               --                                                            v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15,  
                                                               --                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25;
                                                               --                                            if v_ctaaplica > 0 then
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                            v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15, v_suma_adeudos, 0, v_control_contrato, 
                                                               --                                            'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                            v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25, 0, v_suma_adeudos, 0, 
                                                               --                                            'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            else
                                                               --                                                           RETURN 1,'No tiene momentos contables';
                                                               --                                            end if;
                                                               --                            end foreach;
                                                               --            else
                                                               --            RETURN 1,'No se creo la Poliza al Presupuesto de Actual';
                                                               --            end if;
                                               end if;
                                                                                              --************************************* 


                                               if par_Axo_Ini = aso_actual then    --************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
                                                               SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip;
                                                               SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
                                                               Let v_importe_reg = par_sup * v_costo;
                                                               FOR v_mes = par_Mes_Ini to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              --EXECUTE PROCEDURE con16_Rcgos ('CN', par_Axo_Ini || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              --Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    

                                                                              Insert into t34_pagos values
                                                                              ( 0, v_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;
                                                                                              --  *************************************  CREACION DE LA POLIZA DE ADEUDOS DEL A�O EN CURSO
                                                               --EXECUTE PROCEDURE cg_generapoliza (mdy( par_Mes_Ini, 01, par_Axo_Ini), par_Axo_Ini, par_Mes_Ini, 3, 16, 1, v_id_rec, 
                                                               --                                            'MODIFICACION AL PRESUPUESTO ACTUAL', 'ejecucion del proceso ins16_contrato_01', 'A',43) INTO v_IdPoliza;      
                                                               --            if v_IdPoliza > 0 then
                                                               --                            EXECUTE PROCEDURE cg_Momentos ( 'AP', 1 ) INTO v_ctaaplica, v_origen, 
                                                               --                                                           v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15,  
                                                               --                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25;
                                                               --                            if v_ctaaplica > 0 then
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                                                           v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15, v_suma_adeudos, 0, v_control_contrato, 
                                                               --                                                                           'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25, 0, v_suma_adeudos, 0, 
                                                               --                                                                           'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                            else
                                                               --                                            RETURN 1,'No tiene momentos contables';
                                                               --                            end if;
                                                               --            else
                                                               --            RETURN 1,'No se creo la Poliza al Presupuesto de Actual';
                                                               --            end if;
                                               end if;
                                               --************************************* 
                                    RETURN 0,'Termino correctamente la generacion de la Concesion';
                               else
                                    RETURN 1,'No se creo la Concesion/Local, comunicate al Depto de Proceso de Datos';
                               end if;
    else
        RETURN 1,'No se puede dar de alta una Concesion/Local que ya existe';
    end if;

end procedure;

CREATE PROCEDURE "informix".cob34_rdatosg_01 ( par_Local Integer, par_Letra Char(1) )
                returning Integer as Status,
		VarChar(200) as Concepto_status,
		Integer as Id_Datos,
                               VarChar(200) as Concesionario,
                               VarChar(200) as Ubicacion,
                               VarChar(200) as Adicionales,
                               Integer as Zona,
                               Integer as Giro,
                               Decimal(7,2) as Superficie,
                               Integer as Licencia;
               

{
#  Procedimiento: cob34_RDatosG_01
#  Descripcion:  Opciones : Datos Generales del Local
#  Parametros de entrada: tabla, Local, Letra
#  Parametros de salida:   Status y concepto del status
#  Parametros de salida:   Concesionario, Ubicacion, Adicionales, Zona, Giro, Superficie, Licencia
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_control								Char(10);
  define v_concesionario, v_ubicacion						VarChar(200);
  define v_superficie                                                                                                                Decimal(7,2);
  define v_id_34_datos, v_id_zona, v_licencia, v_id_giro				Integer;
--set debug file to "rfact01";
--trace on;
--************************************************************************

if par_Letra <> '' then
	Let v_control = par_Local || '-' || par_Letra;
else
	Let v_control = par_Local;
end if;
Let v_id_34_datos = 0;
Let v_concesionario = '';
Let v_ubicacion = '';
Let v_id_zona = 0;
Let v_id_giro = 0;
Let v_superficie = 0;
Let v_licencia = 0;

if exists( SELECT * FROM t34_datos WHERE cve_tab = '3' AND control = v_control ) then
                SELECT id_34_datos, concesionario, ubicacion, id_zona, superficie, licencia  INTO v_id_34_datos, v_concesionario, v_ubicacion, v_id_zona, v_superficie, v_licencia
                               FROM t34_datos
                              WHERE cve_tab = '3'  AND control = v_control ;
		
		if v_licencia > 0 then
					if exists( SELECT * FROM catastro_gdl:licencias where licencia = v_licencia ) then
						SELECT id_giro INTO v_id_giro  FROM catastro_gdl:licencias where licencia = v_licencia;
					else
						Let v_id_giro = 0;
					end if;
		else
			Let v_id_giro = 0;
		end if;	

	RETURN 0, 'Encontro el registro', v_id_34_datos, v_concesionario, v_ubicacion, Null, v_id_zona, v_id_giro, v_superficie, v_licencia with resume;
else
	RETURN 1, 'No se encontro registro con tal dato', Null, Null, Null, Null, Null, Null, Null, Null  with resume;
end if;

--trace off;

                                           
end procedure;

CREATE PROCEDURE "informix".cob34_rdetade_01 ( par_Id Integer, par_Axo Smallint, par_Mes Smallint )
                returning VarChar(200) as Concepto,
		Integer as Axo,
		Integer as Mes,
		Money(12,2) as Importe_Pagar,
		Money(12,2) as Recargos_Pagar,
		Money(12,2) as Dscto_Importe,
		Money(12,2) as Dscto_Recargos;
               

{
#  Procedimiento: cob34_Rdetade_01
#  Descripcion:  Opciones : Detalle para cobro
#  Parametros de entrada: Id del Control mas a�o y mes de corte
#  Parametros de salida:   Concepto General de cobro
#  Parametros de salida:   Axo, Mes, Importe a Pagar, Recargos a Pagar, Descuento del Importe, Descuento del Recargo
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_Periodo_CN, r_Periodo_CN                                                                                    varchar(7);
  define v_importe, v_recargo, v_por_recargo, v_importe_rgo, v_importe_total		Money(12,2);
  define v_Axo, v_Mes							Integer;

--set debug file to "rfact01";
--trace on;
--************************************************************************

  EXECUTE PROCEDURE con34_1lperiodo () INTO v_Periodo_CN;
  -- pedazo adicionado
  Let r_Periodo_CN = v_Periodo_CN;

Let v_importe =0;
Let v_recargo =0;
Let v_por_recargo =0;
Let v_importe_rgo =0;

FOREACH

                SELECT Year(a.periodo), Month(a.periodo), a.importe, a.recargo  INTO v_Axo, v_Mes, v_importe, v_recargo  
		FROM t34_pagos a, t34_status b    WHERE id_datos = par_Id  AND periodo <= par_Axo || '-' || par_Mes
			AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E'  AND b.cve_stat in ('V')
			ORDER BY periodo
		
			if v_importe > 0 then 
                                                	Select sum(por_recargo) 
                                                                Into v_por_recargo
                                                                From t34_porcentajes 
                                                                Where periodo_porc between v_Axo || '-' || v_Mes and (v_Periodo_CN);

				if v_por_recargo > 0 then
                                                                	Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
				else
                                                                	Let v_importe_rgo = 0;
				end if;
			else
				Let v_importe_rgo = 0;
			end if;
	if v_importe > 0 then
		RETURN 'Periodo de Cobro por Arrendamiento ' || v_Axo || '-' || v_Mes, v_Axo, v_Mes, v_importe, v_importe_rgo, 0,0   with resume;
	end if;
END FOREACH;
--trace off;
                                           
end procedure;

CREATE PROCEDURE "informix".con34_1lperiodo ()
                returning varchar(7);    -- Periodo Cuota Normal

{
#  Procedimiento: con34_1LPeriodo
#  Descripcion:  Genera una consulta del Periodo Limite de CN y EXE actual.
#  Parametros de entrada: NINGUNO
#  Parametros de salida:   A�o y mes de la CUOTA
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Periodo_CN				varchar(7);
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy		varchar(4);

       Select Month(fechalimite), Day(fechalimite)
           Into Mes_v, Dia_v
       From t34_fechalimite
               Where Month(fechalimite) = Month(Current) and Year(fechalimite) = Year(Current);

      Let Aso_Hoy = Year(Current);
      Let Mes_Hoy = Month(Current);
      if Day(Current) > Dia_v then          --  CUOTA NORMAL
         Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      else
          if Month(Current) = 1 then
             Let v_Periodo_CN = Year(Current) - 1||'-12';
          else
             Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          end if;
      end if;


RETURN v_Periodo_CN;

end procedure;

CREATE PROCEDURE "informix".del34_rastro_01 ( par_id_34_datos Integer, par_Axo_Fin Smallint, par_Mes_Fin Smallint )
	returning Integer,    	          -- Status
		varchar(100);     -- Concepto status
               

{
#  Procedimiento: del34_Rastro_01
#  Descripcion:  Opciones : Cancelar
#  Parametros de entrada: tabla, control y periodo de fin de obligacion
#  Parametros de salida:   Status del Procedimiento
#		         Concepto del Procedimiento
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_id_34_datos, v_IdPoliza							Integer;

  define v_id_34_unidad								Integer;
  define v_costo									Money(12,2);

 define v_id_34_stat_dat, v_id_34_stat_pag						Integer;

 define v_mes, aso_inicio, aso_actual, mes_actual						Integer;
 define v_importe_reg, v_suma_adeudos, v_suma_recargos, v_Importe_recargo, v_importe_rec1	Money(12,2);

--************************************************************************


--************************************************************************MOMENTOS CONTABLES
define v_ctaaplica, v_origen		integer;
define v_cta_m11, v_cta_m21 	CHAR(4);
define v_cta_m12, v_cta_m22 	CHAR(2);
define v_cta_m13, v_cta_m23 	CHAR(4);
define v_cta_m14, v_cta_m24 	CHAR(5);
define v_cta_m15, v_cta_m25 	CHAR(5);
--************************************************************************

Let aso_inicio = par_Axo_Fin;
if par_Axo_Fin = Year(Current) then
   Let aso_actual = par_Axo_Fin;
else
   Let aso_actual = Year(Current);
end if;
Let v_id_34_datos = 0;
Let mes_actual = Month(Current);

--************************************************************************ STATUS CONCESION/LOCAL
SELECT id_34_stat INTO v_id_34_stat_dat from t34_status where cve_tab = '3' and cve_stat = 'C' ;
--************************************************************************ STATUS PAGO
SELECT id_34_stat INTO v_id_34_stat_pag from t34_status where cve_tab = 'E' and cve_stat = 'C';
--************************************************************************ 

--  EVITAR QUE EL EJERCICIO NO EXCEDA DE MAS DE 1 A�O DE ANTERIORIDAD ( A�O ACTUAL O PASADO )
    if exists( Select * from t34_datos Where id_34_datos = par_id_34_datos ) then

                   	UPDATE t34_datos SET
                              		Fecha_Fin = mdy( par_Mes_Fin,01,par_Axo_Fin),
			Fecha_Cancelacion = Today,
			Id_Stat = v_id_34_stat_dat
                  	Where id_34_datos = par_id_34_datos;

			
		    	if par_Axo_Fin < aso_actual  then 
				-- sumar aqui todos los adeudos para poliza contable a�o anterior a partir del fin de la obligacion hasta el final del a�o
			       	UPDATE t34_pagos SET 
					usuario = user, id_stat = v_id_34_stat_pag
				WHERE id_datos = par_id_34_datos and periodo BETWEEN par_Axo_Fin || '-' || par_Mes_Fin AND par_Axo_Fin || '-' || 12;
				-- sumar aqui todos los adeudos para poliza contable a�o anterior
				-- aqui genera la poliza contable

				-- sumar aqui todos los adeudos para poliza contable a�o actual a partir de enero a diciembre del a�o actual
			       	UPDATE t34_pagos SET 
					usuario = user, id_stat = v_id_34_stat_pag
				WHERE id_datos = par_id_34_datos and periodo BETWEEN aso_actual || '-' || 01 AND aso_actual || '-' || 12;
				-- sumar aqui todos los adeudos para poliza contable a�o actual
				-- aqui genera la poliza contable
			end if;
		     	if par_Axo_Fin = aso_actual then    --************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
				-- sumar aqui todos los adeudos para poliza contable a�o anterior a partir del fin de la obligacion hasta el final del a�o
			       	UPDATE t34_pagos SET 
					usuario = user, id_stat = v_id_34_stat_pag
				WHERE id_datos = par_id_34_datos and periodo BETWEEN par_Axo_Fin || '-' || par_Mes_Fin AND par_Axo_Fin || '-' || 12;
				-- sumar aqui todos los adeudos para poliza contable a�o anterior
				-- aqui genera la poliza contable
			end if;
			--************************************* 
	RETURN 0,'Termino correctamente la Cancelacion de la Concesion';
    else
        RETURN 1,'No se puede dar de baja una Concesion/Local que no existe';
    end if;

end procedure;

CREATE PROCEDURE "informix".redondeocaja (nImporte money(15,2))
   RETURNING       money(15,2),money(5,2);
   DEFINE nImp     money(15,2);
   DEFINE nTmp     money(15,2);
   DEFINE nDif     money(5,2);
   DEFINE nDifresto     money(5,2);

   LET nTmp = TRUNC( nImporte );
   LET nDif = nImporte - nTmp;
   LET nDifresto = 0;
   LET nImp = 0;

   IF nDif > 0 THEN
      IF ((nDif > 0.00) AND (nDif < 0.25)) THEN
         LET nImp = nTmp;
         LET nDifresto =  nDif * -1;
      END IF;
      IF ((nDif >= 0.25) AND (nDif < 0.50)) THEN
         LET nImp = nTmp + 0.50;
         LET nDifresto = 0.50 - nDif;
      END IF;
      IF (nDif = 0.50) THEN
         LET nDifresto = 0;
         LET nImp = nImporte;
      END IF;
      IF ((nDif > 0.50) AND (nDif < 0.75)) THEN
         LET nImp = nTmp + 0.50;
         LET nDifresto = 0.50 - nDif;
      END IF;
      IF ((nDif >= 0.75) AND (nDif < 1)) THEN
         LET nImp = nTmp + 1;
         LET nDifresto = 1 - nDif;
      END IF;
   ELSE
      LET nImp = nImporte;
   END IF;
   RETURN nImp,nDifresto;
END PROCEDURE;

CREATE PROCEDURE "informix".cob34_rtotade_01 ( par_Id Integer, par_Axo Smallint, par_Mes Smallint )
                returning Integer as Cuenta,
		Char(1) as Obliga,
		VarChar(200) as Concepto,
		Money(12,2) as Importe;
               

{
#  Procedimiento: cob34_Rtotade_01
#  Descripcion:  Opciones : Totales para cobro
#  Parametros de entrada: Id del Control mas a�o y mes de corte
#  Parametros de salida:   Cuenta de aplicacion, obligatoriedad, concepto e importe
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_Periodo_CN								varchar(7);
  define v_importe, v_recargo, v_por_recargo, v_importe_rgo, v_importe_total			Money(12,2);
  define v_totimporte_rgo, v_totimporte_rezago, v_totimporte_devengado, v_totimporte_actual	Money(12,2);
  define v_Axo, v_Mes, Dia_v, Mes_v, Axo_v						Integer;
  define v_limite									Char(1);
  define v_periodo, r_Periodo_CN							Date;

  define v_importe_multa, v_importe_gastos, v_tot_gastos					Money(12,2);
  define v_total_importes, v_redondeado							Money(15,2);
  define v_redondear								Money(5,2);

--set debug file to "rfact01";
--trace on;
--************************************************************************

       Select  Day(fechalimite), Month(fechalimite), Year(fechalimite)
           Into Dia_v, Mes_v, Axo_v
       From t34_fechalimite
               Where Month(fechalimite) = Month(Current) and Year(fechalimite) = Year(Current);

      if Day(Current) <= Dia_v then
	if Mes_v = 1 then
		Let Mes_v = 12;
		Let Axo_v = Axo_v - 1;
	else
		Let Mes_v = Mes_v - 1;
	end if;
      end if;

  EXECUTE PROCEDURE con34_1lperiodo () INTO v_Periodo_CN;
  -- pedazo adicionado
  --Let r_Periodo_CN = v_Periodo_CN;

Let v_importe =0;
Let v_recargo =0;
Let v_por_recargo =0;
Let v_importe_rgo =0;
Let v_totimporte_actual = 0;
Let v_totimporte_devengado = 0;
Let v_totimporte_rezago = 0;
Let v_totimporte_rgo = 0;

FOREACH
                SELECT Year(a.periodo), Month(a.periodo), a.periodo, a.importe, a.recargo  INTO v_Axo, v_Mes, v_periodo, v_importe, v_recargo  
		FROM t34_pagos a, t34_status b    WHERE id_datos = par_Id  AND periodo <= par_Axo || '-' || par_Mes
			AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('V')
			ORDER BY a.periodo
		
			if v_importe > 0 then 
                                                	Select sum(por_recargo) 
                                                                Into v_por_recargo
                                                                From t34_porcentajes 
                                                                Where periodo_porc between v_Axo || '-' || v_Mes and (v_Periodo_CN);

				if v_por_recargo > 0 then
                                                                	Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
				else
                                                                	Let v_importe_rgo = 0;
				end if;
			else
				Let v_importe_rgo = 0;
			end if;
	if v_Axo  < Year(Current) then
		Let v_totimporte_rgo = v_totimporte_rgo + v_importe_rgo;
		Let v_totimporte_rezago = v_totimporte_rezago + v_importe;
	end if;
	if v_Axo  = Year(Current) then
		if v_Mes > Mes_v then
			Let v_totimporte_rgo = v_totimporte_rgo + v_importe_rgo;
			Let v_totimporte_actual = v_totimporte_actual + v_importe;
		else
			Let v_totimporte_rgo = v_totimporte_rgo + v_importe_rgo;
			Let v_totimporte_devengado = v_totimporte_devengado + v_importe;
		end if;
	end if;


END FOREACH;
--trace off;
	if v_totimporte_actual > 0 then
		RETURN 352010090, 'S', ' Arrendamiento Actual ', v_totimporte_actual   with resume;
	end if;
	if v_totimporte_devengado > 0 then
		RETURN 352020090, 'S', ' Arrendamiento Devengado ', v_totimporte_devengado   with resume;
	end if;
	if v_totimporte_rezago > 0 then
		RETURN 352030090, 'S', ' Arrendamiento por Rezago ', v_totimporte_rezago   with resume;
	end if;
	if v_totimporte_rgo > 0 then
		RETURN 390400000, 'S', ' Recargos ', v_totimporte_rgo   with resume;
	end if;
                 
	Let v_importe_multa = 0;
	Let v_importe_gastos =0;
	Let v_tot_gastos = 0;
FOREACH
                     --Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos
                     --  Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos 
	SELECT importe_multa, importe_gastos INTO v_importe_multa, v_importe_gastos
                      from ta_15_apremios
                       Where modulo = 34  And control_otr = par_Id
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		--if v_FolReq > 0 then
		--   Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
		--else
		--   Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
		--Let v_FolReq = v_FolReq + 1;
		--end if;
END FOREACH;
                       --if v_FolReq > 0 then
	       --	return v_DetFolReq, Null, Null, v_importe_multa, v_tot_gastos  with resume;
                       --         Let v_Contador = v_Contador + 1;
                       --end if;

	if v_tot_gastos > 0 then
		RETURN 992100009, 'S', ' Gastos  ', v_tot_gastos   with resume;
	end if;
	if v_importe_multa > 0 then
		RETURN 512300000, 'S', ' Multas  ', v_importe_multa   with resume;
	end if;

	Let v_total_importes = v_totimporte_actual + v_totimporte_devengado + v_totimporte_rezago + v_totimporte_rgo;
   
	EXECUTE PROCEDURE redondeocaja (v_total_importes) INTO v_redondeado, v_redondear;

	if v_redondear <> 0 then
		RETURN 550800000, 'S', ' Redondeo  ', v_redondear   with resume;
	end if;
end procedure;

CREATE PROCEDURE "informix".del34_gen_01 ( par_tabla Char(1), par_id_34_datos Integer, par_Axo_Fin Smallint, par_Mes_Fin Smallint )
	returning Integer,    	          -- Status
		varchar(100);     -- Concepto status
               

{
#  Procedimiento: del34_Gen_01
#  Descripcion:  Opciones : Cancelar
#  Parametros de entrada: tabla, control y periodo de fin de obligacion
#  Parametros de salida:   Status del Procedimiento
#		         Concepto del Procedimiento
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_id_34_datos, v_IdPoliza							Integer;

  define v_id_34_unidad								Integer;
  define v_costo									Money(12,2);

 define v_id_34_stat_dat, v_id_34_stat_pag						Integer;

 define v_mes, aso_inicio, aso_actual, mes_actual						Integer;
 define v_importe_reg, v_suma_adeudos, v_suma_recargos, v_Importe_recargo, v_importe_rec1	Money(12,2);

--************************************************************************


--************************************************************************MOMENTOS CONTABLES
define v_ctaaplica, v_origen		integer;
define v_cta_m11, v_cta_m21 	CHAR(4);
define v_cta_m12, v_cta_m22 	CHAR(2);
define v_cta_m13, v_cta_m23 	CHAR(4);
define v_cta_m14, v_cta_m24 	CHAR(5);
define v_cta_m15, v_cta_m25 	CHAR(5);
--************************************************************************

Let aso_inicio = par_Axo_Fin;
if par_Axo_Fin = Year(Current) then
   Let aso_actual = par_Axo_Fin;
else
   Let aso_actual = Year(Current);
end if;
Let v_id_34_datos = 0;
Let mes_actual = Month(Current);


--  EVITAR QUE EL EJERCICIO NO EXCEDA DE MAS DE 1 A�O DE ANTERIORIDAD ( A�O ACTUAL O PASADO )
    if exists( Select * from t34_datos Where id_34_datos = par_id_34_datos ) then
		SELECT id_34_stat INTO v_id_34_stat_dat from t34_status where cve_tab = par_tabla and cve_stat = 'C' ;
                   	UPDATE t34_datos SET
                              		Fecha_Fin = mdy( par_Mes_Fin,01,par_Axo_Fin),
			Fecha_Cancelacion = Today,
			Id_Stat = v_id_34_stat_dat
                  	Where id_34_datos = par_id_34_datos;


			SELECT id_34_stat INTO v_id_34_stat_pag from t34_status where cve_tab = 'E' and cve_stat = 'C';			
		    	if par_Axo_Fin < aso_actual  then 
				-- sumar aqui todos los adeudos para poliza contable a�o anterior a partir del fin de la obligacion hasta el final del a�o
			       	UPDATE t34_pagos SET 
					usuario = user, id_stat = v_id_34_stat_pag
				WHERE id_datos = par_id_34_datos and periodo BETWEEN par_Axo_Fin || '-' || par_Mes_Fin AND par_Axo_Fin || '-' || 12;
				-- sumar aqui todos los adeudos para poliza contable a�o anterior
				-- aqui genera la poliza contable

				-- sumar aqui todos los adeudos para poliza contable a�o actual a partir de enero a diciembre del a�o actual
			       	UPDATE t34_pagos SET 
					usuario = user, id_stat = v_id_34_stat_pag
				WHERE id_datos = par_id_34_datos and periodo BETWEEN aso_actual || '-' || 01 AND aso_actual || '-' || 12;
				-- sumar aqui todos los adeudos para poliza contable a�o actual
				-- aqui genera la poliza contable
			end if;
		     	if par_Axo_Fin = aso_actual then    --************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
				-- sumar aqui todos los adeudos para poliza contable a�o anterior a partir del fin de la obligacion hasta el final del a�o
			       	UPDATE t34_pagos SET 
					usuario = user, id_stat = v_id_34_stat_pag
				WHERE id_datos = par_id_34_datos and periodo BETWEEN par_Axo_Fin || '-' || par_Mes_Fin AND par_Axo_Fin || '-' || 12;
				-- sumar aqui todos los adeudos para poliza contable a�o anterior
				-- aqui genera la poliza contable
			end if;
			--************************************* 
	RETURN 0,'Termino correctamente la Cancelacion';
    else
        RETURN 1,'No se puede Cancelar Registro que no existe';
    end if;

end procedure;

CREATE PROCEDURE "informix".con34_gdetade_021 ( p_id_datos Integer )
                returning Integer as Registro,                     -- control del registro
                               Date as Periodo,              -- Periodo
                               Money(12,2) as Importe,            -- Importe Adeudos
                               Money(12,2) as Recargo;            -- Importe Recargos
               

{
#  Procedimiento: con34_Gdetade_021
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_id_datos : id de busqueda de pagos del local
#  Parametros de salida:   Control :   dato de control del registro
#                                      Periodo : el dato del a�o y mes
#                                      Importe : El importe de los Adeudos
#                                      Importe : El importe de los Recargos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** DETALLE DE ADEUDO
  define v_Periodo_CN                                                                                               varchar(7);
  define v_id_34_pagos, v_id_datos                                                                                     integer;
  define v_periodo                                                                                                                       date;
  define v_importe, v_recargo                                                                                                money(12,2);
  define v_cve_stat                                                                                                                      char(1);
--****************************************************************************************************************************** 

  EXECUTE PROCEDURE con34_1lperiodo () INTO v_Periodo_CN;

FOREACH
SELECT a.id_34_pagos, a.id_datos, a.periodo, a.importe, a.recargo, b.cve_stat
INTO     v_id_34_pagos, v_id_datos, v_periodo, v_importe, v_recargo, v_cve_stat
FROM t34_pagos a, t34_status b 
WHERE a.id_datos = p_id_datos AND a.periodo <= v_Periodo_CN
AND b.id_34_stat = a.id_stat AND b.cve_stat = 'V'
ORDER BY a.periodo
   if v_importe > 0 then
      RETURN v_id_34_pagos, v_periodo, v_importe, v_recargo with resume;
   end if;
END FOREACH;

end procedure
;

create function "informix".fn_getpagosloc(fid int,fdsd date,fhst date)
returning   money(16,2) as rezago,
            money(16,2) as actual,
            money(16,2) as total;

define v_pagorzg,v_pagoact,v_total money(16,2);
-- pagos rezago
select nvl(sum(importe_pago),0) into v_pagorzg
from ta_11_pagos_local 
where (fecha_pago between fdsd and fhst) and axo<year(today)
and id_local=fid;
-- pagos actual
select nvl(sum(importe_pago),0) into v_pagoact 
from ta_11_pagos_local 
where (fecha_pago between fdsd and fhst) and axo=year(today)
and id_local=fid;

let v_total=v_pagorzg+v_pagoact;
return v_pagorzg,v_pagoact,v_total;
end function;

create function "informix".locate(p_instring varchar(255), p_lookfor varchar(1)) returning integer;

define w_work varchar(255);
define w_token char(1);
define w_location smallint;
define i smallint;

if (p_instring is NULL) then
-- or (p_lookfor = '')) then
let w_location = -1;
return w_location;
end if;

let w_work = trim(p_instring);
let w_token = p_lookfor;
let w_location = 0;

for i = 1 to length(w_work)
if ( substr(w_work,i,1) = w_token ) then
let w_location = i;
exit for ;
end if;
end for;

return w_location;
end function;

CREATE PROCEDURE "informix".ins34_gen_01 ( par_tabla Char(1), par_control Char(10), par_conces Char(200), par_ubica Char (200), 
                                                                   par_sup Money(7,2), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_ofna Integer, par_sector Char(1), par_zona Integer, 
                                                                   par_lic Integer, par_Descrip Char(100), par_NomCom Char(200), par_Lugar Char(200), par_Obs Char(200) )
{######################################################################
#  Procedimiento:    ins34_gen_01
#  Descripcion:      Interfaz de ALTA a registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		     	par_control = dato de control del registro
#		     	par_conces = concesionario
#                    		par_ubica = ubicacion
#                    		par_sup = superficie
#                    		par_Axo_Ini = a�o de inicio de obligacion
#                    		par_Mes_Ini = mes de inicio de obligacion
#                    		par_ofna = recaudadora de control
#                    		par_sector = sector de control
#                    		par_zona = zona de control
#                    		par_lic = licencia del giro
#                    		par_Descrip = descripcion de la unidad a calculo para adeudos
#                    		par_NomCom = nombre comercial
#                    		par_Lugar = lugar
#                    		par_Obs = observaciones
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
               

--**********************************************************************************************
  define v_id_34_datos, v_IdPoliza, v_id_34_stat_tab, v_id_34_stat_concep, v_id_34_stat_adic	Integer;

  define v_id_34_unidad                                                                                                                          Integer;
  define v_costo                                                                                                                                       Money(12,2);
  define v_id_34_stat                                                                                                                   	Integer;
  define v_mes, aso_inicio, aso_actual, mes_actual                                                                                Integer;
  define v_importe_reg, v_suma_adeudos, v_suma_recargos, v_Importe_recargo, v_importe_rec1    	Money(12,2);

  define v_tipo_var									Char(1);

--************************************************************************
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion ins34_gen_01 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_leyenda    	= 'ALGO EXTRA�O PASO';
let v_estatus	= -1;

Let aso_inicio = par_Axo_Ini;
if par_Axo_Ini = Year(Current) then
   Let aso_actual = par_Axo_Ini;
else
   Let aso_actual = Year(Current);
end if;
Let v_id_34_datos = 0;
Let mes_actual = Month(Current);

Let v_tipo_var = '';

--  EVITAR QUE EL EJERCICIO NO EXCEDA DE MAS DE 1 A�O DE ANTERIORIDAD ( A�O ACTUAL O PASADO )
    if not exists(Select * from t34_datos Where cve_tab = par_tabla and control = par_control) then

		SELECT id_34_stat INTO v_id_34_stat_tab from t34_status where cve_tab = par_tabla and cve_stat = 'V' ;
		SELECT id_34_unidad INTO v_id_34_unidad FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip and cve_unidad = 'T';
                               insert into t34_datos values (0, par_tabla, par_control, par_conces, par_ubica, par_sup, mdy(par_Mes_Ini, 01, par_Axo_Ini), null, 
                                                                              par_ofna, par_sector, par_zona, par_lic, user, today, null, v_id_34_unidad, v_id_34_stat_tab);
                               LET v_id_34_datos = dbinfo("sqlca.sqlerrd1");

                               if v_id_34_datos > 0 then  --************************************* GENERACION DE ADEUDOS DEL A�O ANTERIOR
				select id_34_stat into v_id_34_stat_concep from t34_status where cve_tab = 'D' and cve_stat = 'V';
			if par_Obs <> '' then
				insert into t34_conceptos values (0, v_id_34_datos, 'O', par_Obs, user, v_id_34_stat_concep);
			end if;
			if par_NomCom <> '' then
				insert into t34_conceptos values (0, v_id_34_datos, 'N', par_NomCom, user, v_id_34_stat_concep);
			end if;
			if par_Lugar <> '' then
				insert into t34_conceptos values (0, v_id_34_datos, 'L', par_Lugar, user, v_id_34_stat_concep);
			end if;

			if par_tabla = '3' then
				select id_34_stat into v_id_34_stat_adic from t34_status where cve_tab = 'C' and cve_stat = 'V';
				insert into t34_adicionales values (0, v_id_34_datos, '1', 'SS', Null, user, v_id_34_stat_adic);
			end if;

			Let v_id_34_stat = 0;
			SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
			if par_tabla = '5' then  
				-- REGISTRO DEL VALOR DE LA FORMA 
				Let v_costo = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla and ejercicio = par_Axo_Ini  
					AND cve_unidad = 'F';
				Let v_tipo_var = 'F';
				Insert into t34_pagos values  
                                                	( 0, v_id_34_datos, mdy(par_Mes_Ini,01,par_Axo_Ini), v_costo, 0, Null, Null, Null, Null, Null, user, v_id_34_stat, v_tipo_var);
			end if;	-- FIN DEL REGISTRO DEL VALOR DE LA FORMA

                                               if par_Axo_Ini < aso_actual  then    
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
				if par_tabla = '5' then 
					SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = par_Axo_Ini  
						AND cve_unidad = 'A'  AND descripcion = par_Descrip ;
						Let v_tipo_var = 'A';
				else
					SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = par_Axo_Ini  
						AND cve_unidad = 'T'  AND descripcion = par_Descrip ;
						Let v_tipo_var = 'T';
				end if;
				
                                                               SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
                                                               Let v_importe_reg = par_sup * v_costo;
                                                               FOR v_mes = par_Mes_Ini to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              --EXECUTE PROCEDURE con16_Rcgos ('CN', par_Axo_Ini || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              --Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    

                                                                              Insert into t34_pagos values
                                                                              ( 0, v_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat, v_tipo_var);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;

                                                                                              --  ************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = aso_actual  
						AND cve_unidad = 'T'  AND descripcion = par_Descrip ;
						Let v_tipo_var = 'T';
                                                               SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
                                                               Let v_importe_reg = par_sup * v_costo;
                                                               FOR v_mes = 1 to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              --EXECUTE PROCEDURE con16_Rcgos ('CN', aso_actual || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              --Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    
                                                               
                                                                              Insert into t34_pagos values
                                                                              ( 0, v_id_34_datos, mdy(v_mes,01,aso_actual), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat, v_tipo_var);
                                                                              --Insert into ta_16_Pagos values
                                                                              --( v_control_contrato, mdy(v_mes, 01, aso_actual), 6, v_importe_reg, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec, v_importe_rec1, 0);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;

                                                                                              --  ************************************* GENERACION DE POLIZA CONTABLE DEL A�O EN CURSO
                                                               --EXECUTE PROCEDURE cg_generapoliza (mdy( 01, 01, aso_actual), aso_actual, 01, 3, 16, 1, v_id_rec, 
                                                               --                                            'MODIFICACION AL PRESUPUESTO ACTUAL', 'ejecucion del proceso ins16_contrato_01', 'A',43) INTO v_IdPoliza;      
                                                               --            if v_IdPoliza > 0 then
                                                               --                            foreach;
                                                               --                            EXECUTE PROCEDURE cg_Momentos ( 'AP', 1 ) INTO v_ctaaplica, v_origen, 
                                                               --                                                            v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15,  
                                                               --                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25;
                                                               --                                            if v_ctaaplica > 0 then
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                            v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15, v_suma_adeudos, 0, v_control_contrato, 
                                                               --                                            'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                            v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25, 0, v_suma_adeudos, 0, 
                                                               --                                            'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            else
                                                               --                                                           RETURN 1,'No tiene momentos contables';
                                                               --                                            end if;
                                                               --                            end foreach;
                                                               --            else
                                                               --            RETURN 1,'No se creo la Poliza al Presupuesto de Actual';
                                                               --            end if;
                                               end if;
                                                                                              --************************************* 


                                               if par_Axo_Ini = aso_actual then    --************************************* GENERACION DE ADEUDOS DEL A�O EN CURSO
                                                               Let v_mes = 0;
                                                               Let v_suma_adeudos = 0;
                                                               Let v_suma_recargos = 0;
				if par_tabla = '5' then 
					SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = par_Axo_Ini  
						AND cve_unidad = 'A'  AND descripcion = par_Descrip ;
						Let v_tipo_var = 'A';
				else
					SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = par_Axo_Ini  
						AND cve_unidad = 'T'  AND descripcion = par_Descrip ;
						Let v_tipo_var = 'T';
				end if;
                                                               SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
                                                               Let v_importe_reg = par_sup * v_costo;
                                                               FOR v_mes = par_Mes_Ini to 12
                                                                              Let v_Importe_recargo = 0;
                                                                              Let v_importe_rec1 = 0;
                                                                              --EXECUTE PROCEDURE con16_Rcgos ('CN', par_Axo_Ini || '-' || v_mes ) INTO v_Importe_recargo;  
                                                                              --Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    

                                                                              Insert into t34_pagos values
                                                                              ( 0, v_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat, v_tipo_var);
                                                               Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
                                                               Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
                                                               END FOR;
                                                                                              --  *************************************  CREACION DE LA POLIZA DE ADEUDOS DEL A�O EN CURSO
                                                               --EXECUTE PROCEDURE cg_generapoliza (mdy( par_Mes_Ini, 01, par_Axo_Ini), par_Axo_Ini, par_Mes_Ini, 3, 16, 1, v_id_rec, 
                                                               --                                            'MODIFICACION AL PRESUPUESTO ACTUAL', 'ejecucion del proceso ins16_contrato_01', 'A',43) INTO v_IdPoliza;      
                                                               --            if v_IdPoliza > 0 then
                                                               --                            EXECUTE PROCEDURE cg_Momentos ( 'AP', 1 ) INTO v_ctaaplica, v_origen, 
                                                               --                                                           v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15,  
                                                               --                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25;
                                                               --                            if v_ctaaplica > 0 then
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                                                           v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15, v_suma_adeudos, 0, v_control_contrato, 
                                                               --                                                                           'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                                            EXECUTE PROCEDURE cg_ins_movs ( v_IdPoliza, v_ctaaplica, v_origen, 
                                                               --                                                                           v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25, 0, v_suma_adeudos, 0, 
                                                               --                                                                           'Del ' || par_Mes_Ini || ' al 12 del '|| par_Axo_Ini, 'MODIFICACION AL PRESUPUESTO ACTUAL');
                                                               --                            else
                                                               --                                            RETURN 1,'No tiene momentos contables';
                                                               --                            end if;
                                                               --            else
                                                               --            RETURN 1,'No se creo la Poliza al Presupuesto de Actual';
                                                               --            end if;
                                               end if;
                                               --************************************* 
         			let v_leyenda = 'Termino correctamente la generacion';
         			let v_estatus  = 0;
			
                               else
         			let v_leyenda = 'No se creo , comunicate al Depto de Proceso de Datos';
         			let v_estatus  = 1;
                               end if;
    else
	let v_leyenda = 'No se puede dar de alta un Dato que ya existe';
         	let v_estatus  = 1;
    end if;
	RETURN v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".con34_grequerim_01 ( par_Modulo Integer, p_Id Integer )
{######################################################################
#  Procedimiento:    con34_grequerim_01
#  Descripcion:      Interfaz de adeudos por requerimientos para el cobro o consulta de CUALQUIER MODULOS DENTRO DE INGRESOS
#
#  Parametros         par_Tabla     = Rubro de ingreso 
#  de entrada:         par_Id   = Id de Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento para cualquiera que solicite datos de requerimientos
#  Llama a:          
#  
######################################################################}
                returning varchar(255) as Concepto,    
                               Money(12,2) as Multa,    
                               Money(12,2) as Gastos;    

--******************************************************************************************* APREMIOS
  define v_id_control, v_folio_req, v_FolReq		Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos      Money(12,2);
  define v_DetFolReq                                                               varchar(255);
  define v_diligencia                                                                 char(1);
--*******************************************************************************************

	Let v_id_control = 0;

                Let v_tot_gastos = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_FolReq = 0;
                Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
                foreach
                     Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos 
                      from ta_15_apremios
                       Where modulo = par_Modulo  And control_otr = p_Id
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                               if v_FolReq > 0 then
                                  Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
                               else
                                  Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
                               Let v_FolReq = v_FolReq + 1;
                               end if;
                end foreach;

	RETURN v_DetFolReq, v_importe_multa, v_tot_gastos  ;

END PROCEDURE;

create procedure "informix".sp_pagosapremios(pfdsd date,pfhst date)
returning      varchar(60) as mercado,
                int as rec,
                int as nomercado,
                char(2) as seccion,
                int as local,
                char(1) as letra,
                char(1) as bloque,
                varchar(60) as arrendatario,
                int as mesdesde,
                int as axodesde,
                int as meshasta,
                int as axohasta,
                date as fecha,
                int as recpago,
                char(2) as caja,
                int as operacion,
                money(18,2) as arrendamiento,
                money(18,2) as recargos,
                money(18,2) as gastos,
                money(18,2) as multas,
                char(1000) as procedimientos;

define v_mercado,v_nombre varchar(60);
define v_seccion,v_caja char(2);
define v_letra,v_bloque char(1);
define v_apremios char(1000);
define v_merc,v_rec,v_local,v_recp,v_oper,v_actual,v_rezago,v_folio int;
define v_mesdsd,v_axodsd,v_meshst,v_axohst,v_id int;
define v_fecha,v_fechaprac,v_fechaemi date;
define v_renta,v_recargos,v_gastos,v_multas money(18,2);

let v_apremios='';

foreach
select b.id_local,c.descripcion,b.num_mercado,b.oficina,b.seccion,b.local,b.letra_local,b.bloque,b.nombre,
a.mesdesde,a.axodesde,a.meshasta,a.axohasta,a.fecha,a.id_rec,a.caja,a.operacion,c.cuenta_ingreso,c.cuenta_rezago,
nvl(sum((select sum(importe) from ta_12_recibosdet where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja
and operacion=a.operacion and cuenta in(c.cuenta_ingreso,c.cuenta_rezago))),0) impuesto,
nvl(sum((select sum(importe) from ta_12_recibosdet where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja
and operacion=a.operacion and cuenta in(390400000))),0) recargos,
nvl(sum((select sum(importe) from ta_12_recibosdet where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja
and operacion=a.operacion and cuenta in(510500000))),0) multa,
nvl(sum((select sum(importe) from ta_12_recibosdet where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja
and operacion=a.operacion and cuenta in(992100009))),0) gastos
into v_id,v_mercado,v_merc,v_rec,v_seccion,v_local,v_letra,v_bloque,v_nombre,
v_mesdsd,v_axodsd,v_meshst,v_axohst,v_fecha,v_recp,v_caja,v_oper,
v_actual,v_rezago,v_renta,v_recargos,v_multas,v_gastos
from ta_12_recibos a, ta_11_locales b,ta_11_mercados c
where (a.fecha between pfdsd and pfhst)
and a.cvepago='P' and a.id_modulo=11 and b.id_local=a.id_regmodulo
and b.num_mercado not in (214,99) and c.num_mercado_nvo=b.num_mercado 
group by b.id_local,c.descripcion,b.num_mercado,b.oficina,b.seccion,b.local,b.letra_local,b.bloque,b.nombre,
a.mesdesde,a.axodesde,a.meshasta,a.axohasta,a.fecha,a.id_rec,a.caja,a.operacion,c.cuenta_ingreso,c.cuenta_rezago
order by a.fecha,a.id_rec,a.caja,a.operacion

--select nvl(sum(importe),0) into v_renta from ta_12_recibosdet where fecha=v_fecha and id_rec=v_recp and caja=v_caja
--and operacion=v_oper and cuenta in(v_actual,v_rezago);

--select nvl(sum(importe),0) into v_recargos from ta_12_recibosdet where fecha=v_fecha and id_rec=v_recp and caja=v_caja
--and operacion=v_oper and cuenta in(390400000);

--select nvl(sum(importe),0)  into v_multas from ta_12_recibosdet where fecha=v_fecha and id_rec=v_recp and caja=v_caja
--and operacion=v_oper and cuenta in(510500000);

--select nvl(sum(importe),0) into v_gastos from ta_12_recibosdet where fecha=v_fecha and id_rec=v_recp and caja=v_caja
--and operacion=v_oper and cuenta in(992100009);

let v_apremios='';
  foreach
  select folio,fecha_emision,fecha_practicado into v_folio,v_fechaemi,v_fechaprac
  from ta_15_apremios where fecha_pago=v_fecha and recaudadora=v_recp
  and caja=v_caja and operacion=v_oper and modulo=11 and control_otr=v_id
  order by fecha_emision,folio
  let v_apremios=trim(v_apremios)||v_folio||'|'||v_fechaprac||'|';
  end foreach; -- cierre de apremios

let v_apremios=substr(v_apremios,1,(length(v_apremios)-1));
return v_mercado,v_rec,v_merc,v_seccion,v_local,v_letra,v_bloque,v_nombre,
v_mesdsd,v_axodsd,v_meshst,v_axohst,v_fecha,v_recp,v_caja,v_oper,
v_renta,v_recargos,v_gastos,v_multas,v_apremios with resume;

end foreach;

end procedure;

create procedure "informix".sp_datos_cementerios_14(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10))
                 returning  int as dcontrol, varchar(60) as dnombre, varchar(20) as sparentesco, varchar(60) as ddomicilio,
                 VARCHAR(18) as dtelefono, VARCHAR(30) as dcorreo;


define  v_clave   int;
define v_control     int;
define  v_nombre    VARCHAR(60) ;
define  v_domicilio VARCHAR(60) ;
define  v_correo, v_paren   VARCHAR(30);
define  v_telefono   VARCHAR(18);
define v_texto  varchar(200);

let v_control= nvl(p_segmento1,0);

if not exists(select * from db_ingresos:ta_13_datosrcmextra where control_rcm=v_control and vigencia='V') then
   let v_clave = 0; 
   let v_texto = 'sin registros';
   return 0,' ',' ',' ' ,' ',(v_texto||' '||v_clave); 
end if;      

foreach
    select id_control,  nombre, parentesco, domicilio,  correo,   telefono
    into   v_clave, v_nombre,v_paren, v_domicilio,v_correo ,v_telefono 
    from db_ingresos:ta_13_datosrcmextra where control_rcm=v_control and vigencia='V'
    order by id_control desc

return v_clave,  v_nombre,v_paren, v_domicilio,v_telefono, v_correo  with resume; 

end foreach;

end procedure;

create procedure "informix".admin_datos_cementerios_14(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10))
                 returning  int as dcontrol, varchar(60) as dnombre, varchar(20) as sparentesco, varchar(60) as ddomicilio,
                 VARCHAR(18) as dtelefono, VARCHAR(30) as dcorreo;


define  v_clave   int;
define v_control     int;
define  v_nombre    VARCHAR(60) ;
define  v_domicilio VARCHAR(60) ;
define  v_correo, v_paren   VARCHAR(30);
define  v_telefono   VARCHAR(18);
define v_texto  varchar(200);

let v_control= nvl(p_segmento1,0);

if not exists(select * from ta_13_datosrcmextra where control_rcm=v_control and vigencia='V') then
   let v_clave = 0; 
   let v_texto = 'sin registros';
   return 0,' ',' ',' ' ,' ',(v_texto||' '||v_clave); 
end if;      

foreach
    select id_control,  nombre, parentesco, domicilio,  correo,   telefono
    into   v_clave, v_nombre,v_paren, v_domicilio,v_correo ,v_telefono 
    from ta_13_datosrcmextra where control_rcm=v_control and vigencia='V'
    order by id_control desc

return v_clave,  v_nombre,v_paren, v_domicilio,v_telefono, v_correo  with resume; 

end foreach;

end procedure;

CREATE PROCEDURE "informix".admin_datos_varios_18 (p_tipo char(1), p_numero int)
{######################################################################
#  Procedimiento:    admin_datos_varios_18
#  Descripcion:      Interfaz de consulta de datos varios para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros        p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:       p_numero   = Numero de Contrato
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_datos_varios en dbingresosw
#  Llama a:          
#  
######################################################################}
returning   varchar(150) as datovario;

define  v_oficina, v_control_contrato, v_cantidad_recolec, v_excedentes	Integer;
define  v_fechabaja							Date;


let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato, a.id_rec, a.fecha_hora_baja, a.cantidad_recolec  INTO  v_control_contrato, v_oficina, v_fechabaja, v_cantidad_recolec
		FROM ta_16_contratos a, ta_16_tipo_aseo b
		WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

					Let v_excedentes = 0;
					if exists( SELECT * FROM ta_16_pagos WHERE control_contrato = v_control_contrato and ctrol_operacion <> 6 and status_vigencia = 'V') then
						SELECT sum(exedencias)  INTO v_excedentes  FROM ta_16_pagos WHERE control_contrato = v_control_contrato 
											and ctrol_operacion <> 6 and status_vigencia = 'V';
					else
						let v_excedentes	= 0;
					end if;
	RETURN v_oficina with resume;
	RETURN v_control_contrato with resume;
	RETURN v_excedentes with resume;
	--RETURN TO_CHAR(nvl(v_fechabaja,mdy(01,01,1990)),'%d/%m/%Y')  with resume;
	RETURN TO_CHAR(nvl(v_fechabaja,mdy(01,01,1990)),'%d%m%Y') with resume;
	RETURN v_cantidad_recolec  with resume;
end if;
end procedure;

create procedure "informix".admin_datos_varios_20(pinterface int,pcol char(10),pcalle char(10),pfol varchar(10),
pseg4 varchar(10),pseg5 varchar(10),pseg6 varchar(10))

returning   varchar(150) as datovario;

define  a_colonia,a_descripcion varchar(50);
define  a_calle varchar(80);
define  a_tipoobra varchar(20);
define  a_nombreobra varchar(100);
define  a_referencia varchar(30);
define  a_pagototal,a_pagoinicial,a_pagoparcial,a_adeudo,a_monto,a_acumulado decimal(8,2);
define  a_pagos,a_parcialidad,a_restan,a_apagar,a_cuentaapl int;
define  a_vencimiento date;
define  v_id int;

select id_convenio into v_id from ta_17_convenios
where colonia=pcol and calle=pcalle and folio=pfol;

foreach
execute procedure admin_adeudo_20(v_id,0,2) into a_colonia,a_calle,a_tipoobra,a_nombreobra,a_pagototal,a_pagoinicial,
a_pagoparcial,a_pagos,a_adeudo,a_vencimiento,a_parcialidad,a_restan,a_apagar,a_cuentaapl,a_referencia,
a_descripcion,a_monto,a_acumulado
end foreach;
return a_colonia with resume;
return a_calle with resume;
return a_tipoobra with resume;
return a_pagototal with resume;
return a_pagoinicial with resume;
return a_pagoparcial with resume;
return TO_CHAR(nvl(a_vencimiento,mdy(01,01,1990)),'%d%m%Y') with resume;
return a_parcialidad with resume;
return a_restan with resume;
return a_apagar with resume;
return a_nombreobra with resume;


end procedure;

CREATE PROCEDURE "informix".admin_datos_varios_25 ( par_Tabla Char(2), par_Control Char(10) )
{######################################################################
#  Procedimiento:    admin_datos_varios_25
#  Descripcion:      Interfaz de consulta de datos varios para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros        par_Tabla     = Rubro de ingreso 
#  de entrada:       par_Control   = Dato de Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_datos_varios en dbingresosw
#  Llama a:          
#  
######################################################################}
returning   varchar(150) as datovario;

--**********************************************************************************************
  define v_id_34_datos, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro		Integer;
  define v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs		VarChar(200);
  define v_superficie								Decimal(7,2);
  define v_fecha_inicio, v_fecha_fin						Date;
  define v_sector								Char(1);
  define v_status 								VarChar(50);
  define v_unidades 							VarChar(100);
  define v_categoria 							Char(15);
  define v_control, v_seccion, v_bloque 						Char(10);
  define v_nombre_tabla							Char(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
--set debug file to "gil22.log";
--trace on;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN  'Error en transaccion de Otras Obligaciones ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
--************************************************************************
Let v_id_34_datos = 0;
Let v_id_recaudadora = 0;
Let v_id_zona = 0;
Let v_licencia = 0;
Let v_id_giro = 0;
Let v_superficie = 0;

Let v_concesionario = '';
Let v_ubicacion = '';
Let v_nom_comercial = '';
Let v_lugar = '';
Let v_obs = '';
Let v_sector = '';
Let v_status = '';
Let v_unidades = '';
Let v_categoria = '';
Let v_control = '';
Let v_seccion = '';
Let v_bloque = '';


--****************************************************************************************************************************
SELECT nombre INTO v_nombre_tabla  FROM t34_tablas WHERE cve_tab = par_Tabla;
--****************************************************************************************************************************


if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
                SELECT a.id_34_datos, a.control, a.concesionario, a.ubicacion, (f.descripcion) unidades, a.sector, a.superficie, a.fecha_inicio, a.fecha_fin, 
		a.id_recaudadora, a.id_zona, a.licencia

		INTO v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_unidades, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, 
		v_id_recaudadora, v_id_zona, v_licencia

		FROM t34_datos A, t34_unidades F
			WHERE a.cve_tab = par_Tabla and a.control = par_Control
			AND F.id_34_unidad = A.id_unidad;

		if exists( SELECT * FROM t34_adicionales WHERE id_datos =  v_id_34_datos ) then
			SELECT categoria  INTO  v_categoria  FROM t34_adicionales  WHERE id_datos =  v_id_34_datos;
		else
			let v_categoria = '0';
		end if;
		if exists( SELECT * FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'N' ) then
			SELECT (concepto) nom_comercial INTO v_nom_comercial   FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'N';
		else
			let v_nom_comercial = ' ';
		end if;
		if exists( SELECT * FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'L' ) then
			SELECT (concepto) lugar INTO v_lugar   FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'L';
		else
			let v_lugar = ' ';
		end if;

		if v_licencia > 0 then
			if exists( SELECT * FROM catastro_gdl:licencias where licencia = v_licencia ) then
				SELECT id_giro INTO v_id_giro  FROM catastro_gdl:licencias where licencia = v_licencia;
			else
				Let v_id_giro = 0;
			end if;
		else
			Let v_id_giro = 0;
		end if;

	RETURN substr ( v_nombre_tabla,1,40 ) with resume;
	RETURN substr ( v_nom_comercial,1,50 ) with resume;
	RETURN substr ( v_lugar,1,50 ) with resume;
	RETURN ' ' with resume;  -- ADICIONALES
	RETURN substr ( v_unidades,1,20 ) with resume;
	RETURN substr ( v_categoria,1,2 ) with resume;
	RETURN substr ( v_sector,1,5 ) with resume;
	RETURN TO_CHAR(nvl(v_fecha_inicio,mdy(01,01,1990)),'%d%m%Y') with resume; -- TO_CHAR(nvl(v_fecha_inicio,mdy(01,01,1990)),'%d/%m/%Y')  with resume;
	RETURN TO_CHAR(nvl(v_fecha_fin,mdy(01,01,1990)),'%d%m%Y') with resume; -- TO_CHAR(nvl(v_fecha_fin,mdy(01,01,1990)),'%d/%m/%Y')  with resume;
	RETURN substr ( v_id_giro,1,4 )  with resume;
	RETURN substr ( v_licencia,1,8 )  with resume;
	RETURN substr ( v_id_zona,1,2 )  with resume;
	RETURN substr ( v_superficie,1,6 )  with resume;
	RETURN substr ( v_id_recaudadora,1,1 )  with resume;
end if;

--trace off;
end procedure;

CREATE PROCEDURE "informix".admin_ins_datosextra_14(var_control integer, var_nombre varchar(60), varparentesco char(25), 
                  var_domicilio varchar(60),var_telefono VARCHAR(18),var_correo VARCHAR(30))
                 returning  smallint as par_ok, varchar(255)as sobserv;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_insextra_admin ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION


if not exists(SELECT *
    FROM ta_13_datosrcmextra where control_rcm=var_control and nombre=var_nombre and
    domicilio=var_domicilio and correo=var_correo and telefono=var_telefono) then
INSERT INTO ta_13_datosrcmextra(id_control, control_rcm, nombre, domicilio, correo, telefono, fecalta,vigencia,parentesco) 
    VALUES(0, var_control, var_nombre, var_domicilio,var_correo,var_telefono,today,'V',varparentesco);


return 0,'Dado de alta';
else
return 0,'Ya existe';
end if;
end procedure;

create procedure "informix".admin_recargos_20(pimp money(18,2),pven date)
returning   money(18,2) as recargos;

define v_recargos money(18,2);
define v_porc decimal(5,2);

let v_porc=0;
let v_recargos=0;
if day(today)<=day(pven) then
   select sum(porcentaje_parcial) into v_porc from ta_13_recargosrcm
   where ( (axo>year(pven)  or (mes>=month(pven)  and axo=year(pven))) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
else
   select sum(porcentaje_parcial) into v_porc from ta_13_recargosrcm
   where ( (axo>year(pven) or (mes>=month(pven)  and axo=year(pven))) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if v_porc > 100 then
   let v_recargos=trunc(pimp*100)/100;
else
   let v_recargos=trunc(pimp*v_porc)/100;
end if;
return v_recargos;
end procedure;

CREATE PROCEDURE "pgmoreno".con34_cgacart_01 ( par_Tabla Char(2), par_Ejer Integer )
{######################################################################
#  Procedimiento:    con34_CgaCart_01
#  Descripcion:      Interfaz para generacion de cartera de OTRAS OBLIGACIONES 
#
#  Parametros        par_Tabla     = Rubro de ingreso 
#  de entrada:       par_Ejercicio   = ejercicio de creacion de cartera
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento del modulo mismo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_id_usuario	int;

define v_mes, v_id_34_datos, v_id_34_stat_pag		Integer;
define v_sup					decimal(7,2);
define v_importe_reg, v_costo				Money(12,2);
define v_descripcion				VarChar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion upd34_gade_01 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_leyenda    	= 'ALGO EXTRA�O PASO';
let v_estatus	= -1;


--************************************************************************ STATUS PAGOS
SELECT id_34_stat INTO v_id_34_stat_pag from t34_status where cve_tab = 'E' and cve_stat = 'V';
--************************************************************************


FOREACH
                SELECT a.id_34_datos, a.superficie, b.descripcion  INTO v_id_34_datos, v_sup, v_descripcion 
                               FROM t34_datos a, t34_unidades b, t34_status c
                              WHERE a.cve_tab = par_Tabla  AND b.id_34_unidad = a.id_unidad
		AND c.id_34_stat = a.id_stat AND c.cve_tab = par_Tabla  AND c.cve_stat in ('V')
                               ORDER BY a.control


                                                               Let v_mes = 0;
                                                               Let v_costo = 0;
                                                               Let v_importe_reg = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_Tabla AND ejercicio = par_Ejer  
						AND cve_unidad = 'T'  AND descripcion = Trim(v_descripcion) ;
                                                               Let v_importe_reg = v_sup * v_costo;
                                                               FOR v_mes = 1 to 12
                                                               
                                                                              Insert into t34_pagos values
                                                                              ( 0, v_id_34_datos, mdy(v_mes,01,par_Ejer), v_importe_reg, 0, Null, Null, Null, Null, Null, user, v_id_34_stat_pag, 'T');
                                                               END FOR;
		let v_leyenda    	= 'TERMINO SATISFACTORIAMENTE LA CARGA DE LA CARTERA';
		let v_estatus	= 0;
END FOREACH;
--trace off;
	RETURN v_estatus,v_leyenda;
                                           
end procedure;

CREATE PROCEDURE "pgmoreno".ins34_rubro_01 ( par_Nombre Char(50) )
{######################################################################
#  Procedimiento:    ins34_tabla_01
#  Descripcion:      Interfaz de CREACION de tablas para OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_Nombre = Nombre del Nuevo Rubro de Ingreso
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;

define v_Numero, v_Registro	int;

SELECT max(auto_tab) INTO v_Numero FROM T34_TABLAS WHERE auto_tab > 0;

                               insert into t34_tablas values
                               ( 0, TO_CHAR(v_Numero + 1), par_Nombre, 'N', v_Numero + 1 );
                               LET v_Registro = dbinfo("sqlca.sqlerrd1");

if v_Registro > 0 then
                RETURN v_Numero + 1, 'Se creo correctamente el Rubro';
else
                RETURN -1, 'No se creo lel Rubro de Ingresos, avisar a DPD';
end if;

end procedure;

create function "informix".get_aplicacionesp(
    p_usuario  CHAR(10),
    p_busqueda varchar(20)
)
{######################################################################
#  funcion:    get_aplicaciones
#  Descripcion:      Obtiene informacion de las aplicaciones a las que tien acceso el usuario
#
#  Parametros        p_usuario = usuario de las bases de ingresos y catastro y egresos
#  de entrada:       p_busqueda  = parametros de busqueda
#
#  Parametros        
#  de salida:        id_modulo:   Id del Modulo
#		     descripcion:  Nombre de la aplicacion
#                    aplicacion: nomre del ejecutable
#		     version:   Version del Archivo
#                    fecha:  Fecha de la version        
#                    ruta :  Rutade descarga
#                    id_modulo_egresos: id del modulo que corresponde en egresos
#                    modulo_catastro: bandera para saber que es de catastro 0=no 1=si
#
#  Elaboro:          Marco A. Ortega
#  Fecha:            9 Marzo 2012   
#
#  Llamado por:      Licencias, tramite, cajero, etc      
#  Llama a:          
#  
######################################################################}
returning 
int as id_modulo,
VARCHAR(20) as descripcion,
CHAR(60) as aplicacion ,
VARCHAR(10) as version ,
DATE as fecha ,
VARCHAR(200) as ruta ,
INT as id_modulo_egresos ,
int as modulo_catastro;
--*******************************************
--Version de PRUEBA
--*******************************************

--Parametros de salida:
define o_id_modulo int;
define o_descripcion VARCHAR(20);
define o_aplicacion CHAR(60);
define o_version VARCHAR(10);
define o_fecha DATE;
define o_ruta VARCHAR(200);
define o_id_modulo_egresos INT;
define o_modulo_catastro INT;
-- fin Parametros de Salida

let o_id_modulo =0;
let o_descripcion ='';
let o_aplicacion ='';
let o_version = '';
let o_fecha = null;
let o_ruta = '';
let o_id_modulo_egresos = 0;
let o_modulo_catastro = 0;

--**verifica que el usuario exista para la base de ingresos y este activo ***---

if exists(select * from ta_12_passwords where usuario=p_usuario and estado="A") then

foreach
select m.id_modulo,m.descripcion,m.aplicacion,m.version,m.fecha,m.ruta,m.id_modulo_egresos, m.modulo_catastro
   into o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro 
 from ta_tags b,ta_autoriza c,ta_12_modulos m,ta_12_passwords u where
b.tag=c.tag
and b.id_modulo=c.id_modulo
and m.id_modulo=b.id_modulo
and u.id_usuario=c.id_usuario
and u.usuario = p_usuario and b.tag=0 and trim(aplicacion) <> '' 
and upper(m.descripcion) like "%"||trim(p_busqueda)||"%"
and m.activo="S"
order by 2
return o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro with resume;
end foreach;

end if;

--**verifica que el usuario exista para la base de Egresos y este activo ***---

if exists(select * from db_egresos:ta_passwords where usuario=p_usuario and estado="A") then

foreach
select mi.id_modulo,mi.descripcion,mi.aplicacion,mi.version,mi.fecha,mi.ruta,mi.id_modulo_egresos, mi.modulo_catastro
   into o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro 
from db_egresos:ta_tags b,db_egresos:ta_autoriza c,
db_egresos:ta_modulos m,db_egresos:ta_passwords u,ta_12_modulos mi where
b.tag=c.tag
and b.id_modulo=c.id_modulo
and m.id_modulo=b.id_modulo
and u.id_usuario=c.id_usuario
and mi.id_modulo_egresos=m.id_modulo
and u.usuario = p_usuario and b.tag=0 and trim(mi.aplicacion) <> ''
and upper(mi.descripcion) like "%"||trim(p_busqueda)||"%"
and mi.activo="S"
order by 2
return o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro with resume;
end foreach;

end if;

--**verifica que el usuario exista para la base de Egresos y este activo ***---

if exists(select * from catastro_gdl:usuarios where usuario=p_usuario and fecbaj is null) then

foreach
select distinct m.id_modulo,m.descripcion,m.aplicacion,m.version,m.fecha,m.ruta,m.id_modulo_egresos, m.modulo_catastro
   into o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro 
from ta_12_modulos m,catastro_gdl:usuarios u, catastro_gdl:autoriza a 
where modulo_catastro=1 and u.usuario=a.usuario and u.usuario=p_usuario  and trim(m.aplicacion) <> ''
and a.num_tag = m.id_modulo
and upper(m.descripcion) like "%"||trim(p_busqueda)||"%"
and m.activo="S"
order by 2
return o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro with resume;
end foreach;

end if;

end function;

create function "informix".get_aplicaciones(
    p_usuario  CHAR(10),
    p_busqueda varchar(20)
)
{######################################################################
#  funcion:    get_aplicaciones
#  Descripcion:      Obtiene informacion de las aplicaciones a las que tien acceso el usuario
#
#  Parametros        p_usuario = usuario de las bases de ingresos y catastro y egresos
#  de entrada:       p_busqueda  = parametros de busqueda
#
#  Parametros        
#  de salida:        id_modulo:   Id del Modulo
#		     descripcion:  Nombre de la aplicacion
#                    aplicacion: nomre del ejecutable
#		     version:   Version del Archivo
#                    fecha:  Fecha de la version        
#                    ruta :  Rutade descarga
#                    id_modulo_egresos: id del modulo que corresponde en egresos
#                    modulo_catastro: bandera para saber que es de catastro 0=no 1=si
#
#  Elaboro:          Marco A. Ortega
#  Fecha:            9 Marzo 2012   
#
#  Llamado por:      Licencias, tramite, cajero, etc      
#  Llama a:          
#  
######################################################################}
returning 
int as id_modulo,
VARCHAR(20) as descripcion,
CHAR(60) as aplicacion ,
VARCHAR(10) as version ,
DATE as fecha ,
VARCHAR(200) as ruta ,
INT as id_modulo_egresos ,
int as modulo_catastro;
--*******************************************
--Version de Produccion
--*******************************************

--Parametros de salida:
define o_id_modulo int;
define o_descripcion VARCHAR(20);
define o_aplicacion CHAR(60);
define o_version VARCHAR(10);
define o_fecha DATE;
define o_ruta VARCHAR(200);
define o_id_modulo_egresos INT;
define o_modulo_catastro INT;
-- fin Parametros de Salida

let o_id_modulo =0;
let o_descripcion ='';
let o_aplicacion ='';
let o_version = '';
let o_fecha = null;
let o_ruta = '';
let o_id_modulo_egresos = 0;
let o_modulo_catastro = 0;

--**verifica que el usuario exista para la base de ingresos y este activo ***---

if exists(select * from ta_12_passwords where usuario=p_usuario and estado="A") then

foreach
select m.id_modulo,m.descripcion,m.aplicacion,m.version,m.fecha,m.ruta,m.id_modulo_egresos, m.modulo_catastro
   into o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro 
 from ta_tags b,ta_autoriza c,ta_12_modulos m,ta_12_passwords u where
b.tag=c.tag
and b.id_modulo=c.id_modulo
and m.id_modulo=b.id_modulo
and u.id_usuario=c.id_usuario
and u.usuario = p_usuario and b.tag=0 and trim(aplicacion) <> '' 
and upper(m.descripcion) like "%"||trim(p_busqueda)||"%"
and m.activo="S"
order by 2
return o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro with resume;
end foreach;

end if;

--**verifica que el usuario exista para la base de Egresos y este activo ***---

if exists(select * from db_egresos:ta_passwords where usuario=p_usuario and estado="A") then

foreach
select mi.id_modulo,mi.descripcion,mi.aplicacion,mi.version,mi.fecha,mi.ruta,mi.id_modulo_egresos, mi.modulo_catastro
   into o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro 
from db_egresos:ta_tags b,db_egresos:ta_autoriza c,
db_egresos:ta_modulos m,db_egresos:ta_passwords u,ta_12_modulos mi where
b.tag=c.tag
and b.id_modulo=c.id_modulo
and m.id_modulo=b.id_modulo
and u.id_usuario=c.id_usuario
and mi.id_modulo_egresos=m.id_modulo
and u.usuario = p_usuario and b.tag=0 and trim(mi.aplicacion) <> ''
and upper(mi.descripcion) like "%"||trim(p_busqueda)||"%"
and mI.activo="S"
order by 2
return o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro with resume;
end foreach;

end if;

--**verifica que el usuario exista para la base de Egresos y este activo ***---

if exists(select * from catastro_gdl:usuarios where usuario=p_usuario and fecbaj is null) then

foreach
select distinct m.id_modulo,m.descripcion,m.aplicacion,m.version,m.fecha,m.ruta,m.id_modulo_egresos, m.modulo_catastro
   into o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro 
from ta_12_modulos m,catastro_gdl:usuarios u, catastro_gdl:autoriza a 
where modulo_catastro=1 and u.usuario=a.usuario and u.usuario=p_usuario  and trim(m.aplicacion) <> ''
and a.num_tag = m.id_modulo
and upper(m.descripcion) like "%"||trim(p_busqueda)||"%"
and m.activo="S"
order by 2
return o_id_modulo,o_descripcion,o_aplicacion,o_version,o_fecha,o_ruta,o_id_modulo_egresos, o_modulo_catastro with resume;
end foreach;

end if;

end function;

CREATE PROCEDURE "informix".upd34_gen_01 ( par_opc Integer, par_id_34_datos Integer, par_conces Char(200), par_ubica Char (200), 
				      par_lic Integer, par_sup Money(7,2), par_Descrip Char(100), par_Axo_Ini Smallint, par_Mes_Ini Smallint, 
					par_nomcom Char (200), par_lugar Char (200), par_obs Char (200) )
	returning Integer,    	          -- Status
		varchar(100);     -- Concepto status
               

{
#  Procedimiento: upd34_Gen_01
#  Descripcion:  Opciones : Cancelar
#  Parametros de entrada: tabla, control y periodo de fin de obligacion
#  Parametros de salida:   Status del Procedimiento
#		         Concepto del Procedimiento
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_id_34_datos, v_IdPoliza							Integer;

  define v_id_unidad								Integer;
  define v_costo									Money(12,2);

 define v_id_34_stat_pag, v_id_34_stat_concep						Integer;

 define v_mes, aso_inicio, aso_actual, mes_actual						Integer;
 define v_importe_reg, v_suma_adeudos, v_suma_recargos, v_Importe_recargo, v_importe_rec1	Money(12,2);
 define v_fecha_inicio								Date;

--************************************************************************


--************************************************************************MOMENTOS CONTABLES
define v_ctaaplica, v_origen		integer;
define v_cta_m11, v_cta_m21 	CHAR(4);
define v_cta_m12, v_cta_m22 	CHAR(2);
define v_cta_m13, v_cta_m23 	CHAR(4);
define v_cta_m14, v_cta_m24 	CHAR(5);
define v_cta_m15, v_cta_m25 	CHAR(5);
--************************************************************************

Let aso_inicio = par_Axo_Ini;
if par_Axo_Ini = Year(Current) then
   Let aso_actual = par_Axo_Ini;
else
   Let aso_actual = Year(Current);
end if;
Let v_id_34_datos = 0;
Let mes_actual = Month(Current);

--************************************************************************ STATUS CONCESION/LOCAL
SELECT id_34_stat INTO v_id_34_stat_concep from t34_status where cve_tab = 'D' and cve_stat = 'V';
SELECT id_34_stat INTO v_id_34_stat_pag from t34_status where cve_tab = 'E' and cve_stat = 'V';
--************************************************************************

--  EVITAR QUE EL EJERCICIO NO EXCEDA DE MAS DE 1 A�O DE ANTERIORIDAD ( A�O ACTUAL O PASADO )
    if exists( Select * from t34_datos Where id_34_datos = par_id_34_datos ) then
	if par_opc < 6 then
		if par_opc = 0 then		-- CONCESIONARIO
                   		UPDATE t34_datos SET  concesionario = par_conces	Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo el Concesionario - Propietario';
		end if;
		if par_opc = 1 then		-- UBICACION
                   		UPDATE t34_datos SET  ubicacion = par_ubica		Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo La Ubicacion';
		end if;
		if par_opc = 2 then		-- LICENCIA
                   		UPDATE t34_datos SET  licencia = par_lic		Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo el dato del No. de Licencia';
		end if;
		if par_opc = 3 then		-- NOMBRE COMERCIAL
			if exists ( SELECT * from t34_conceptos Where id_datos = par_id_34_datos and tipo = 'N' ) then
				if par_nomcom = 'nada' then
					DELETE FROM t34_conceptos Where  id_datos = par_id_34_datos and tipo = 'N';
				else
                   				UPDATE t34_conceptos SET  concepto = par_nomcom	Where id_datos = par_id_34_datos and tipo = 'N';
				end if;
			else
				insert into t34_conceptos values ( 0, par_id_34_datos, 'N', par_nomcom, user, v_id_34_stat_concep );
			end if;
			RETURN 0,'Se actualizo el Nombre Comercial o Generico';
		end if;
		if par_opc = 4 then		-- LUGAR
			if exists ( SELECT * from t34_conceptos Where id_datos = par_id_34_datos and tipo = 'L' ) then
				if par_lugar = 'nada' then
					DELETE FROM t34_conceptos Where  id_datos = par_id_34_datos and tipo = 'L';
				else
                   				UPDATE t34_conceptos SET  concepto = par_lugar	Where id_datos = par_id_34_datos and tipo = 'L';
				end if;
			else
				insert into t34_conceptos values ( 0, par_id_34_datos, 'L', par_lugar, user, v_id_34_stat_concep );
			end if;
			RETURN 0,'Se actualizo el dato del Lugar';
		end if;
		if par_opc = 5 then		-- OBSERVACIONES
			if exists ( SELECT * from t34_conceptos Where id_datos = par_id_34_datos and tipo = 'O' ) then
				if par_obs = 'nada' then
					DELETE FROM t34_conceptos Where  id_datos = par_id_34_datos and tipo = 'O';
				else
                   				UPDATE t34_conceptos SET  concepto = par_obs	Where id_datos = par_id_34_datos and tipo = 'O';
				end if;
			else
				insert into t34_conceptos values ( 0, par_id_34_datos, 'O', par_obs, user, v_id_34_stat_concep );
			end if;
			RETURN 0,'Se actualizo las Observaciones';
		end if;
	end if;
		if par_opc = 6 then		-- SUPERFICIE
			UPDATE t34_datos SET  superficie = par_sup	Where id_34_datos = par_id_34_datos;
		    	if par_Axo_Ini < aso_actual  then   --************************************* ACTUALIZA ADEUDOS DE A�OS ANTERIOR
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

				-- suma importes de registros vigentes antes de cambiarlos ( todo el a�o )
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = 1 to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	if par_Axo_Ini = aso_actual then    --************************************* ACTUALIZA ADEUDOS DEL A�O EN CURSO
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
			RETURN 0,'Se actualizo Adeudos por cambio de Superficie';
		end if;

		if par_opc = 7 then		-- TIPO LOCAL
			SELECT id_34_unidad INTO v_id_unidad FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip and cve_unidad = 'T';
			UPDATE t34_datos SET  id_unidad = v_id_unidad	Where id_34_datos = par_id_34_datos;
		    	if par_Axo_Ini < aso_actual  then   --************************************* ACTUALIZA ADEUDOS DE A�OS ANTERIOR
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

				-- suma importes de registros vigentes antes de cambiarlos ( todo el a�o )
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = 1 to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	if par_Axo_Ini = aso_actual then    --************************************* ACTUALIZA ADEUDOS DEL A�O EN CURSO
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
			       		UPDATE t34_pagos SET 
						importe = v_importe_reg
						WHERE id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
			RETURN 0,'Se actualizo Adeudos por cambio de Tipo de Local';
		end if;

		if par_opc = 8 then		-- CAMBIO DE INICIO DE OBLIGACION
		      SELECT fecha_inicio INTO v_fecha_inicio FROM t34_datos  Where id_34_datos = par_id_34_datos;
 		      if mdy(par_Mes_Ini, 01, par_Axo_Ini) < mdy(Month(v_fecha_inicio), Day(v_fecha_inicio), Year(v_fecha_inicio)) then
			-- solo crear periodos faltantes
		    	if par_Axo_Ini < aso_actual  then   --************************************* ACTUALIZA ADEUDOS DE A�OS ANTERIOR
				-- suma importes de registros vigentes antes de adicionar periodos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
					if not exists( Select * from t34_pagos Where id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes ) then
			       			Insert into t34_pagos values
		                       			( 0, par_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat_pag);
					end if;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros totales para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

				-- suma importes de registros vigentes antes de cambiarlos ( todo el a�o )
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = 1 to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
					if not exists( Select * from t34_pagos Where id_datos = par_id_34_datos and periodo = aso_actual || '-' || v_mes ) then
			       			Insert into t34_pagos values
		                       			( 0, par_id_34_datos, mdy(v_mes,01,aso_actual), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat_pag);
					end if;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	if par_Axo_Ini = aso_actual then    --************************************* ACTUALIZA ADEUDOS DEL A�O EN CURSO
				-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
				Let v_mes = 0;
				Let v_suma_adeudos = 0;
				Let v_suma_recargos = 0;
				SELECT costo INTO v_costo FROM t34_unidades Where ejercicio = aso_actual And descripcion = par_Descrip and cve_unidad = 'T';
				Let v_importe_reg = par_sup * v_costo;
  				FOR v_mes = par_Mes_Ini to 12
					Let v_Importe_recargo = 0;
					Let v_importe_rec1 = 0;
					if not exists( Select * from t34_pagos Where id_datos = par_id_34_datos and periodo = par_Axo_Ini || '-' || v_mes ) then
			       			Insert into t34_pagos values
		                       			( 0, par_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, user, v_id_34_stat_pag);
					end if;
				Let v_suma_adeudos = v_suma_adeudos + v_importe_reg;
				Let v_suma_recargos = v_suma_recargos + v_importe_rec1;
  				END FOR;
				-- suma importes de registros modificados para crear la poliza contable
				-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido
			end if;
		     	UPDATE t34_datos SET  fecha_inicio = mdy(par_Mes_Ini, 01, par_Axo_Ini)	Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo Adeudos por cambio de Inicio de Obligacion del Local';
		      else
			-- suma importes de registros vigentes a partir del cambio antes de actualizarlos
			DELETE FROM t34_pagos Where id_datos = par_id_34_datos and periodo < par_Axo_Ini || '-' || par_Mes_Ini;
			-- suma importes de registros modificados para crear la poliza contable
			-- aqui genera la poliza contable por el a�o originado que sera la diferencia entre los originales y lo corregido

		     	UPDATE t34_datos SET  fecha_inicio = mdy(par_Mes_Ini, 01, par_Axo_Ini)	Where id_34_datos = par_id_34_datos;
			RETURN 0,'Se actualizo Adeudos por cambio de Inicio de Obligacion del Local';
		
		      end if;
		end if;
    else
        RETURN 1,'No se puede Actualizar algo que NO EXISTE';
    end if;

end procedure;

create procedure "informix".opercaja(p_fecha date) 
    RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define  v_estadist money(16,2);
define  v_acumulado money(16,2);
define  v_fechatime datetime year to fraction(3) ;



   begin
    on exception in (-310)
       let v_id_modulo = 0;
       let v_descripcion ='ESPERE UN MOMENTO....VUELVA A INTENTAR';
       let v_cantidad = 0; let v_importe = 0; let v_fechatime = CURRENT year to fraction(3);
      return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   ;
  
    end exception;  
    select sum(importe) into v_estadist from ta12_ingrexmodulo where fecha = p_fecha;
     if v_estadist is null then
       let v_estadist = 0;
     end if;
     let v_acumulado = 0;

     foreach 
     select x0.id_modulo ,x1.descripcion ,count(*) ,sum(x0.importe ) , CURRENT year to fraction(3) 
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
     from ta_12_recibos x0 , ta_12_moduloscat x1 
     where (((x0.fecha = p_fecha ) AND (x0.cvepago = 'P' ) ) AND (x1.id_modulo = x0.id_modulo ) ) and x0.id_modulo <> 15
     group by x0.id_modulo ,   x1.descripcion 
     order by 3 desc
     let v_acumulado = v_acumulado + v_importe;
    return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach

end ;
     if v_acumulado <> v_estadist then
        execute procedure ldopercajaint(p_fecha);
     end if;
end procedure;

CREATE procedure "saranda".spd_13_titextra (v_control	INT, v_tit 	INT, v_fec DATE,
                                v_libro	INT, v_axo int, v_folio int, v_nomben varCHAR(60),
                                v_domben varCHAR(60), v_colben varCHAR(60), v_telben varCHAR(20), v_part varchar(25))
                   returning  smallint as par_ok, varchar(255)as sobserv;
define v_lError         int;
define v_lISAMError     int;
define v_vcMensaje      varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_titextra ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION

if not exists(SELECT *
    FROM ta_13_titextra where control_rcm=v_control and titulo=v_tit) then

INSERT INTO ta_13_titextra(control_rcm, titulo, fecha_imp, libro, axo, folio, nombre_ben, dom_ben, col_ben, tel_ben,partida) 
    VALUES(v_control, v_tit, v_fec, v_libro, v_axo, v_folio, v_nomben, v_domben, v_colben, v_telben,v_part);
return 0,'Dado de alta';
else

UPDATE ta_13_titextra 
    SET fecha_imp=v_fec, libro=v_libro, axo=v_axo, folio=v_folio, nombre_ben=v_nomben, dom_ben=v_domben,
        col_ben=v_colben, tel_ben=v_telben, partida=v_part
    WHERE control_rcm=v_control and titulo=v_tit;
return 0,'Se Actualizo';
end if;
end procedure;

CREATE PROCEDURE "saranda".spd_pagofaltantecg(
    		parFecha	                date,
    		parRec     	smallint,		
                                parUsu     	integer)
	               	returning    integer,
	               	                  integer;

 define vparFecha  		date;
 define vparRec	 	smallint;
 define vparCaja	 	char(2);
 define vparOper	 	integer;
 define vparImporte  	money(15,2);
 define vparControl	  	integer; 
 define vparMay	  	smallint; 
 define vparSub1	  	smallint;
 define vparSub2	  	smallint;
 define vparSub3	  	integer;
 define vparSuma	  	integer;
 define vparSuma2	  	integer;
  let vparSuma=0;
  let vparSuma2=0;

foreach
select a.fecing,a.recing,cajing,opcaja,totcertificado, (nvl((a.cuenta_id * 1),0)),numero,obra,colonia,axofol  into
vparFecha,vparRec,vparCaja,vparOper,vparImporte,vparControl,vparMay,vparSub1,vparSub2,vparSub3
 from CG_12_ingreso a
  where a.fecing=parfecha and a.recing =parRec and 
 (select count(*) from CG_12_importes where a.fecing =fecing and a.recing = recing and  a.cajing =cajing and
  a.opcaja = opcaja and cta_aplicacion =999900003)>0 
 if vparcontrol>0 then
  if not exists (select *  from ta_12_pagodfalt  where fecing=vparFecha and recing=vparRec and cajing=vparCaja and opcaja=vparOper
                 and control_fal=vparControl)   then 
 
   insert into ta_12_pagodfalt  values(vparFecha,vparRec,vparCaja,vparOper,vparImporte,vparControl,0,parUsu,today);
     let vparSuma2=(vparSuma2)+(1);
  else
     let vparSuma=(vparSuma)+(1);
end if;
end if;
end foreach;
return   	vparSuma2,vparSuma
with resume;
end procedure;

CREATE PROCEDURE "informix".linea_ligapago(
    p_id int,
    p_cvepago INT,
    p_fecha_pago DATE,
    p_id_rec SMALLINT,
    p_caja CHAR(2),
    p_operacion INT,
    p_usuario CHAR(8)
)
{######################################################################
#  Procedimiento:    linea_ligapago
#  Descripcion:      Liga el pago de linea de captura hecho por cajero por diferencias en conciliacion
#
#  Parametros        p_id     = id de linea de pago
#  de entrada:       p_cvepago,p_fecha_pago,p_id_rec,p_cajap_operacion,   =  datos del recibo de pago
#		     p_usuario      = usuario que hace la liga
# 
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            04 Marzo 2014   
#
#  Llamado por:      Modulo de bancos/verificapagolinea/pagarlinea
#  Llama a:          
#  
######################################################################}
returning int as estatus ,varchar(200) as mensaje;
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en cancelacion de Licencia/anuncio ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

--set debug file to "lineacap.log";
--   trace on;

let estatus=0;
let mensaje="lINEA DE PAGO LIGADO A RECIBO";

if NOT exists (select * from linea_pagos where id = p_id) then
   return -1,"LA LINEA DE CAPTURA DE PAGO NO EXISTE";
end if;

update linea_pagos
set
  estatus = 'L',
  cvepago = p_cvepago,
  fecha_pago = p_fecha_pago,
  id_rec = p_id_rec,
  caja = p_caja,
  operacion = p_operacion,
  usuario = p_usuario
where
  id = p_id;

return estatus,mensaje;

end procedure;

CREATE PROCEDURE "informix".conv_licanun(v_dato int,v_tipo char(1),v_opc char(1),v_id_convenio int,v_usuario char(8))
	returning int;
--v_tipo L=licencia, A=Anuncio
--v_opc A=Alta de Convenio, B=Cancelacion de Convenio, P=Pago de Convenio
define ok int;
execute PROCEDURE catastro_gdl:conv_licanun(v_dato,v_tipo,v_opc,v_id_convenio,v_usuario) into ok;
return ok;
end procedure;

CREATE PROCEDURE "informix".grafphp_02()
returning 
int as zona,
varchar(50) as descripcion,
int as vigentes,
int as canceladas;
-----------Define las variables de retorno----------------
define v_descripcion    	varchar(50);
define v_zona 	int;
define v_vigente 	int;
define v_cancelada 	int;
FOREACH
select a.recaud ,  a.descripcion , 
( select count(*) from catastro_gdl:convcta v where v.vigente="V" and v.recaud = a.recaud )  ,
( select count(*) from catastro_gdl:convcta c where c.vigente="C" and c.recaud = a.recaud ) 
into v_zona, v_descripcion, v_vigente, v_cancelada
from catastro_gdl:c_recaud a
where a.recaud in (1,2,3,4) 
return v_zona, v_descripcion, v_vigente, v_cancelada with resume;
end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".grafphp_01()
returning 
int as zona,
varchar(50) as descripcion,
int as vigentes,
int as canceladas;
-----------Define las variables de retorno----------------
define v_descripcion    	varchar(50);
define v_zona 	int;
define v_vigente 	int;
define v_cancelada 	int;
FOREACH
select a.recaud ,  a.descripcion , 
( select count(*) from catastro_gdl:convcta v where v.vigente="V" and v.recaud = a.recaud and year(crea_fecha) =year(today))  ,
( select count(*) from catastro_gdl:convcta c where c.vigente="C" and c.recaud = a.recaud and year(baja_fecha) = year(today)) 
into v_zona, v_descripcion, v_vigente, v_cancelada
from catastro_gdl:c_recaud a
where a.recaud in (1,2,3,4) 
return v_zona, v_descripcion, v_vigente, v_cancelada with resume;
end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".grafphp_03(p_fecini date , p_fecfin date)
returning 
int as clave,
varchar(50) as descripcion,
int as movimientos;

-----------Define las variables de retorno----------------
define v_descripcion    	varchar(50);
define v_cvemov 	int;
define v_cuentas 	int;

FOREACH
select h.cvemov,d.clavemovto, count(*) 
     into  v_cvemov , v_descripcion , v_cuentas 
    from catastro_gdl:h_catastro h, catastro_gdl:c_movcta d 
    where h.cvemov=d.cvemov and h.feccap between p_fecini and p_fecfin and h.cvemov not in (94,92)
    group by 1,2  having count(*) >0      order by 2 
return  v_cvemov , v_descripcion , v_cuentas with resume;
end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".grafphp_04(p_fecini date , p_fecfin date)
returning 
int as clave,
varchar(50) as descripcion,
int as axo_anteriores,
int as axo_otorga,
int as axo_actual;
-----------Define las variables de retorno----------------
define v_descripcion    	varchar(50);
define v_clave 	int;
define v_axo_anteriores 	int;
define v_axo_otorga 	int;
define v_axo_actual 	int;
FOREACH
select c.cvedesc_grupo, C.descripcion , nvl(antes.desctosantes,0) , nvl(otorga.desctootorga,0) , nvl(actual.desctosactual,0) 
into  v_clave , v_descripcion , v_axo_anteriores ,v_axo_otorga , v_axo_actual
from catastro_gdl:c_grupos_descpred C
left join ( 
select d.cvedesc_grupo , count(distinct h.cvecuenta ) desctosantes
 from catastro_gdl:descpred h, catastro_gdl:c_descpred d
 where  h.cvedescuento=d.cvedescuento and h.fecbaja is null and d.axodescto < YEAR(TODAY) and
  h.fecalta between p_fecini and p_fecfin
   group by 1) as antes on antes.cvedesc_grupo = c.cvedesc_grupo
left join ( 
select d.cvedesc_grupo , count(distinct h.cvecuenta ) desctootorga
 from catastro_gdl:descpred h, catastro_gdl:c_descpred d
 where  h.cvedescuento=d.cvedescuento and h.fecbaja is null and d.axodescto = YEAR(TODAY) and
  h.fecalta between p_fecini and p_fecfin
   group by 1) as otorga on otorga.cvedesc_grupo = c.cvedesc_grupo
left join ( 
select d.cvedesc_grupo , count(distinct h.cvecuenta ) desctosactual
 from catastro_gdl:descpred h, catastro_gdl:c_descpred d
 where  h.cvedescuento=d.cvedescuento and h.fecbaja is null and d.axodescto = YEAR(TODAY)
  
   group by 1) as actual on actual.cvedesc_grupo = c.cvedesc_grupo

return v_clave , v_descripcion , v_axo_anteriores ,v_axo_otorga , v_axo_actual with resume;

end FOREACH;
end procedure
;

create procedure "informix".spd_bajaconvenios(plet char(3),ptipo int,pfecven date)
returning   int as estado,
            varchar(100) as mensaje;

define v_estado,v_idresto int;
define v_mensaje varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1,'spd_bajaconvenios ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_estado=0;
let v_mensaje='LOS CONVENIOS SE CANCELARON CORRECTAMENTE';

foreach
select b.id_conv_resto into v_idresto
from ta_17_conv_diverso a,ta_17_conv_d_resto b
 where a.letras_exp=plet and b.vigencia='A' and b.fecha_venc<=pfecven and a.tipo=ptipo
 and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver 
order by a.tipo,a.subtipo,a.letras_exp,a.axo_exp,a.numero_exp

update ta_17_conv_d_resto set vigencia='B',nombrefirma='BAJA EN BASE AL OFICIO DI/01/1234/2014'
WHERE id_conv_resto=v_idresto;

update catastro_gdl:convenios set vigencia='B' where id_conv_diver=v_idresto;

end foreach;

return v_estado,v_mensaje;
end procedure;

create procedure "saranda".spd_12_estadistica2013(p_fecha date,p_rec1 int, p_rec2 int, p_caju int)
                returning int as s_tit,varchar(50) as s_titulo,int as s_cap, varchar(60) as s_capitulo, int as s_ctaapl, varchar(60) as s_descrip,
                          money as s_diario, int as s_docdia, money as s_mensual, int as s_docmen, money as s_ajuste,
                          money as s_ajusanual, money as s_anual, int as s_docanual;

define v_dtit,v_dcap, v_desc   varchar(60);
define v_ddia, v_dmen, v_danu, v_cta,v_tit, v_cap int;
define v_idia, v_imen, v_ianu money;
define v_iaju, v_iajuanu      money;

begin
    on exception in (-958)
    delete from t_estadtem;
end exception;
create temp table  t_estadtem(
t_tit   int,
t_cap   int,
t_cta   int,
t_descr varchar(60),
t_dia   money default 0,
t_dodia int default 0,
t_men   money default 0,
t_domen money default 0,
t_aju   money default 0,
t_ajanu money default 0,
t_anual money default 0,
t_doanu int   default 0) with no log;
end;

foreach
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, 
sum(a.importe_cta),sum(a.documento),(0) , (0) ,
(0) , (0), (0) ,(0)
into v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen, v_dmen, v_iaju, v_ianu, v_danu, v_iajuanu 
from cg_12_importes a , cg_12_cuentas2013 b
 where a.cta_aplicacion=b.cta_aplicacion and a.fecing=p_fecha and a.recing between p_rec1 and p_rec2
and b.titulo<9999
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

insert into t_estadtem (t_tit,t_cap,t_cta,t_descr,t_dia,t_dodia,t_men,t_domen,t_aju,t_ajanu,t_anual,t_doanu)
values(v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia, v_imen, v_dmen, v_iaju, v_iajuanu, v_ianu, v_danu); 
end foreach;

foreach
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),
sum(a.importe_cta),sum(trunc(a.documento)), 
(0), (0), (0),(0)
into v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen, v_dmen, v_iaju, v_ianu, v_danu, v_iajuanu 
from cg_12_importes a , cg_12_cuentas2013 b
 where a.cta_aplicacion=b.cta_aplicacion and year(a.fecing)=year(p_fecha) and month(a.fecing)= month(p_fecha) 
and a.fecing<= p_fecha and a.recing between p_rec1 and p_rec2
and b.titulo<9999
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

if exists(select * from t_estadtem where t_cta=v_cta) then
  update t_estadtem set t_men=v_imen, t_domen=v_dmen where t_cta=v_cta;
else
insert into t_estadtem values(v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen,
 v_dmen, v_iaju, v_iajuanu, v_ianu, v_danu); 
end if;
end foreach;

if p_caju=0 then
foreach
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),(0),(0),
sum(a.importe_ajuste), (0), (0),(0)
into v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen, v_dmen, v_iaju, v_ianu, v_danu, v_iajuanu 
from ta_12_ajustes a , cg_12_cuentas2013 b
 where year(a.fecha_ajuste)=year(p_fecha) and month(a.fecha_ajuste)= month(p_fecha)
 and a.fecha_ajuste<=p_fecha and a.cta_aplicacion=b.cta_aplicacion
and b.titulo<9999
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

if exists(select * from t_estadtem where t_cta=v_cta) then
   update t_estadtem set t_aju=v_iaju where t_cta=v_cta;
else
   insert into t_estadtem values(v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen,
   v_dmen, v_iaju, v_iajuanu, v_ianu, v_danu); 
end if;
end foreach;
end if;

foreach
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),(0),(0),(0),
sum(a.importe_cta),sum(a.documento),(0) 
into v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen, v_dmen, v_iaju, v_ianu, v_danu, v_iajuanu 
from cg_12_importes a , cg_12_cuentas2013 b
 where a.cta_aplicacion=b.cta_aplicacion and year(a.fecing)=year(p_fecha) and month(a.fecing)< month(p_fecha) 
 and  a.recing between p_rec1 and p_rec2
and b.titulo<9999
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

if exists(select * from t_estadtem where t_cta=v_cta) then
   update t_estadtem set t_anual=v_ianu, t_doanu=v_danu where t_cta=v_cta;
else
   insert into t_estadtem values(v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen,
   v_dmen, v_iaju, v_iajuanu, v_ianu, v_danu); 
end if;
end foreach;

if p_caju=0 then
foreach
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),(0),(0),
(0), (0),(0),sum(a.importe_ajuste)
into v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen, v_dmen, v_iaju, v_ianu, v_danu, v_iajuanu 
from ta_12_ajustes a , cg_12_cuentas2013 b
 where year(a.fecha_ajuste)=year(p_fecha)
 and a.fecha_ajuste<=p_fecha and a.cta_aplicacion=b.cta_aplicacion
and b.titulo<9999
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

if exists(select * from t_estadtem where t_cta=v_cta) then
   update t_estadtem set t_ajanu=v_iajuanu where t_cta=v_cta;
else
   insert into t_estadtem values(v_tit, v_cap,  v_cta, v_desc, v_idia, v_ddia,v_imen,
   v_dmen, v_iaju, v_iajuanu, v_ianu, v_danu); 
end if;
end foreach;
end if;

foreach
select t_tit,(select desc_titulo from ta_12_titulos where titulo=t_tit and capitulo="00")
,t_cap,(select desc_titulo from ta_12_titulos where titulo=t_tit and capitulo=t_cap),  t_cta, t_descr, t_dia, t_dodia,t_men, t_domen, t_aju, t_anual, t_doanu, t_ajanu 
into v_tit,v_dtit, v_cap,v_dcap,  v_cta, v_desc, v_idia, v_ddia,v_imen, v_dmen, v_iaju, v_ianu, v_danu, v_iajuanu 
 from t_estadtem a
order by 1,3,t_cta
return v_tit,upper(v_dtit), v_cap,upper(v_dcap),  v_cta, upper(v_desc), v_idia, v_ddia,v_imen, v_dmen, v_iaju, v_iajuanu , v_ianu, v_danu with resume;

end foreach;

drop table t_estadtem;
end procedure;

CREATE PROCEDURE "saranda".spd_estadpredial(
    		parAxo	                integer,
    		parMes     	smallint,
    		parCompleto1     	integer,
   		parCompleto     	integer
		)
	               	returning     smallint,
	 		char(02),
	 		integer,
	 		char(60),
		 	money(15,2),
		 	money(15,2);

 define vparTitulo  		smallint;
 define vparCapitulo 	char(02);
 define vparCuenta 		integer;
 define vparDescrip 		char(60);
 define vparImporteMen 	money(15,2);
 define vparImporteAnu 	money(15,2);

foreach
      SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, sum(a.importe_cta), (0)
      into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu
      from         ta_12_importes a , ta_12_cuentas b
     where      ((year(a.fecing)=parAxo) and (month(a.fecing)=parMes)) and a.cta_aplicacion=b.cta_aplicacion          
      and (a.cta_aplicacion in (40401,40402,40403,40404,40601,42510,42901,42902,42903,42905,42905,42906,
42907,42908,42909,46202,46203,46204,46317,46318,48102))
     group by   b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 
union
 SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),sum(a.importe)
--      into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu
     from       ta_12_ingresoanual  a, ta_12_cuentas b
     where   a.axo_mes>=parcompleto1  and a.axo_mes<parcompleto and a.cta_aplicacion=b.cta_aplicacion
                  and a.cta_aplicacion in (40401, 40402,40403,40404,40601,42510,42901,42902,42903,42905,42905, 42906,42907,42908,42909,46202,46203,46204,46317,46318,48102)
    group by  b.titulo, b.capitulo, b.cta_aplicacion,  b.descripcion
return   	vparTitulo,vparCapitulo,vparCuenta,vparDescrip,vparImporteMen,vparImporteAnu
with resume;
end foreach;

end procedure;

create procedure "saranda".spd_estad_anual2013(p_axo int, p_rec1 int, p_rec2 int)
       returning int as s_tit, varchar(60) as s_desct, int as cta_apl,varchar(60) as s_desc,
                                 int as doc_ene, int as ctas_ene, money as impte_ene,
                                 int as doc_feb, int as ctas_feb, money as impte_feb,
                                 int as doc_mar, int as ctas_mar, money as impte_mar,
                                 int as doc_abr, int as ctas_abr, money as impte_abr,
                                 int as doc_may, int as ctas_may, money as impte_may,
                                 int as doc_jun, int as ctas_jun, money as impte_jun,
                                 int as doc_jul, int as ctas_jul, money as impte_jul,
                                 int as doc_ago, int as ctas_ago, money as impte_ago,
                                 int as doc_sep, int as ctas_sep, money as impte_sep,
                                 int as doc_oct, int as ctas_oct, money as impte_oct,
                                 int as doc_nov, int as ctas_nov, money as impte_nov,
                                 int as doc_dic, int as ctas_dic, money as impte_dic;

define  v_cta,v_tit      int;
define  v_doc      int;
define  v_ctad     int;
define  v_impte    money;
define  v_doc_ene     int;
define  v_cta_ene     int ;
define  v_impte_ene   money;
define  v_doc_feb     int ;
define  v_cta_feb     int ;
define  v_impte_feb   money;
define  v_doc_mar     int ;
define  v_cta_mar     int ;
define  v_impte_mar   money ;
define  v_doc_abr     int;
define  v_cta_abr     int ;
define  v_impte_abr    money ;
define  v_doc_may     int;
define  v_cta_may     int ;
define  v_impte_may   money;
define  v_doc_jun     int ;
define  v_cta_jun     int ;
define  v_impte_jun   money ;
define  v_doc_jul     int ;
define  v_cta_jul     int ;
define  v_impte_jul   money ;
define  v_doc_ago     int ;
define  v_cta_ago     int ;
define  v_impte_ago   money ;
define  v_doc_sep     int ;
define  v_cta_sep     int ;
define  v_impte_sep   money ;
define  v_doc_oct     int ;
define  v_cta_oct     int ;
define  v_impte_oct   money ;
define  v_doc_nov     int ;
define  v_cta_nov     int ;
define  v_impte_nov   money ;
define  v_doc_dic     int ;
define  v_cta_dic     int ;
define  v_impte_dic   money ;
define  v_desc,v_desct        varchar(60);         

begin
    on exception in (-958)
    delete from est_anual;
end exception;
create temp table est_anual(
an_cta      int,
doc_ene     int default 0,
cta_ene     int default 0,
impte_ene   money default 0,
doc_feb     int default 0,
cta_feb     int default 0,
impte_feb   money default 0,
doc_mar     int default 0,
cta_mar     int default 0,
impte_mar   money default 0,
doc_abr     int default 0,
cta_abr     int default 0,
impte_abr    money default 0,
doc_may     int default 0,
cta_may     int default 0,
impte_may   money default 0,
doc_jun     int default 0,
cta_jun     int default 0,
impte_jun   money default 0,
doc_jul     int default 0,
cta_jul     int default 0,
impte_jul   money default 0,
doc_ago     int default 0,
cta_ago     int default 0,
impte_ago   money default 0,
doc_sep     int default 0,
cta_sep     int default 0,
impte_sep   money default 0,
doc_oct     int default 0,
cta_oct     int default 0,
impte_oct   money default 0,
doc_nov     int default 0,
cta_nov     int default 0,
impte_nov   money default 0,
doc_dic     int default 0,
cta_dic     int default 0,
impte_dic   money default 0) with no log;
end;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=01 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion

  insert into est_anual (an_cta,doc_ene,cta_ene,impte_ene) values(v_cta, v_doc,v_ctad,v_impte);

end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=02 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_feb=v_doc,cta_feb=v_ctad,impte_feb=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_feb,cta_feb,impte_feb) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=03 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_mar=v_doc,cta_mar=v_ctad, impte_mar=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_mar,cta_mar,impte_mar) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=04 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_abr=v_doc,cta_abr=v_ctad,impte_abr=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_abr,cta_abr,impte_abr) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=05 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_may=v_doc,cta_may=v_ctad,impte_may=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_may,cta_may,impte_may) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=06 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_jun=v_doc,cta_jun=v_ctad, impte_jun=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_jun,cta_jun,impte_jun) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=07 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_jul=v_doc,cta_jul=v_ctad, impte_jul=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_jul,cta_jul,impte_jul) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=08 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_ago=v_doc,cta_ago=v_ctad, impte_ago=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_ago,cta_ago,impte_ago) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=09 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_sep=v_doc,cta_sep=v_ctad,impte_sep=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_sep,cta_sep,impte_sep) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=10 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_oct=v_doc,cta_oct=v_ctad,impte_oct=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_oct,cta_oct,impte_oct) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=11 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_nov=v_doc,cta_nov=v_ctad,impte_nov=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_nov,cta_nov,impte_nov) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach 
select cta_aplicacion,  sum(documento) , count(*), sum(importe_cta)  
into v_cta, v_doc,v_ctad,v_impte
from CG_12_importes where year(fecing)=p_axo and month(fecing)=12 and recing >=p_rec1 and recing<=p_rec2
group by  1,cta_aplicacion
if exists(select * from est_anual where an_cta=v_cta) then
   update est_anual set doc_dic=v_doc,cta_dic=v_ctad,impte_dic=v_impte where an_cta=v_cta;
else
  insert into est_anual (an_cta,doc_dic,cta_dic,impte_dic) values(v_cta, v_doc,v_ctad,v_impte);
end if;
end foreach;

foreach
select b.titulo, upper(t.desc_titulo),an_cta,upper(b.descripcion), doc_ene,cta_ene,impte_ene,doc_feb,cta_feb,impte_feb,doc_mar,cta_mar,impte_mar,doc_abr,
cta_abr,impte_abr,doc_may,cta_may,impte_may,doc_jun,cta_jun,impte_jun,doc_jul,cta_jul,impte_jul,
doc_ago,cta_ago,impte_ago,doc_sep,cta_sep,impte_sep,doc_oct,cta_oct,impte_oct,doc_nov,cta_nov,impte_nov,
doc_dic,cta_dic,impte_dic
into  v_tit,v_desct,v_cta, v_desc, v_doc_ene,v_cta_ene,v_impte_ene,v_doc_feb,v_cta_feb,v_impte_feb,v_doc_mar,v_cta_mar,v_impte_mar,v_doc_abr,
v_cta_abr,v_impte_abr,v_doc_may,v_cta_may,v_impte_may,v_doc_jun,v_cta_jun,v_impte_jun,v_doc_jul,v_cta_jul,v_impte_jul,
v_doc_ago,v_cta_ago,v_impte_ago,v_doc_sep,v_cta_sep,v_impte_sep,v_doc_oct,v_cta_oct,v_impte_oct,v_doc_nov,v_cta_nov,v_impte_nov,
v_doc_dic,v_cta_dic,v_impte_dic
from est_anual a, cg_12_cuentas2013 b, outer ta_12_titulos t
where a.an_cta=b.cta_aplicacion and b.titulo=t.titulo and t.capitulo=00
ORDER BY 1,3
return v_tit,v_desct,v_cta, v_desc,v_doc_ene,v_cta_ene,v_impte_ene,v_doc_feb,v_cta_feb,v_impte_feb,v_doc_mar,v_cta_mar,v_impte_mar,v_doc_abr,
v_cta_abr,v_impte_abr,v_doc_may,v_cta_may,v_impte_may,v_doc_jun,v_cta_jun,v_impte_jun,v_doc_jul,v_cta_jul,v_impte_jul,
v_doc_ago,v_cta_ago,v_impte_ago,v_doc_sep,v_cta_sep,v_impte_sep,v_doc_oct,v_cta_oct,v_impte_oct,v_doc_nov,v_cta_nov,v_impte_nov,
v_doc_dic,v_cta_dic,v_impte_dic with resume;
end foreach;
drop table est_anual;
end procedure;

create PROCEDURE "saranda".spd_estadpredial2013(parAxo integer, parMes  smallint)
	               	returning     smallint as s_tit, smallint as s_cap,	int as s_cta,
	 		varchar(60) as s_desc, 	money  as s_imptemen,	money as s_impteanu, money as s_impteaju,
		 	money as s_impteajuanu;

 define vparTitulo  		smallint;
 define vparCapitulo 	char(02);
 define vparCuenta 		integer;
 define vparDescrip 		char(60);
 define vparImporteMen 	money(15,2);
 define vparImporteajuM 	money(15,2);
 define vparImporteAnu 	money(15,2);
 define vparImporteajuA 	money(15,2);

begin
    on exception in (-958)
    delete from est_pred;
end exception;
create temp table est_pred(
an_tit      int default 0,
an_cap      int default 0,
an_cta      int,
an_descr    varchar(60),
impte_mens   money default 0,
impte_anua   money default 0,
impte_ajus   money default 0,
impte_ajuanu money default 0) with no log;
end;

foreach
      SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, sum(a.importe_cta), (0),(0),(0)
      into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA
      from         cg_12_importes a , cg_12_cuentas b
     where      ((year(a.fecing)=parAxo) and (month(a.fecing)=parMes)) and a.cta_aplicacion=b.cta_aplicacion          
      and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
     group by   b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 
    insert into est_pred (an_tit, an_cap, an_cta, an_descr, impte_mens, impte_anua, impte_ajus, impte_ajuanu)
            values(vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA);
end foreach;

foreach
 SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),sum(a.importe_cta),(0),(0)
      into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA
     from       cg_12_importes a, cg_12_cuentas b
     where   ((year(a.fecing)=parAxo) and (month(a.fecing)<parMes)) and a.cta_aplicacion=b.cta_aplicacion          
      and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
    group by  b.titulo, b.capitulo, b.cta_aplicacion,  b.descripcion

if exists(select * from est_pred where an_cta=vparCuenta) then
   update est_pred set impte_anua= vparImporteAnu where an_cta=vparCuenta;
else
    insert into est_pred (an_tit, an_cap, an_cta, an_descr, impte_mens, impte_anua, impte_ajus, impte_ajuanu)
            values(vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA);
end if;
end foreach;
foreach
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),sum(a.importe_ajuste), (0)
into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA
from ta_12_ajustes a , cg_12_cuentas b
 where year(a.fecha_ajuste)=parAxo and month(a.fecha_ajuste)=parMes
 and a.cta_aplicacion=b.cta_aplicacion       and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

if exists(select * from est_pred where an_cta=vparCuenta) then
   update est_pred set impte_ajus= vparImporteajuM where an_cta=vparCuenta;
else
    insert into est_pred (an_tit, an_cap, an_cta, an_descr, impte_mens, impte_anua, impte_ajus, impte_ajuanu)
            values(vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA);
end if;
end foreach;
foreach
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),(0),sum(a.importe_ajuste)
into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA
from ta_12_ajustes a , cg_12_cuentas b
 where year(a.fecha_ajuste)=parAxo and month(a.fecha_ajuste)<parMes
 and a.cta_aplicacion=b.cta_aplicacion      and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

if exists(select * from est_pred where an_cta=vparCuenta) then
   update est_pred set impte_ajuanu= vparImporteajuA where an_cta=vparCuenta;
else
    insert into est_pred (an_tit, an_cap, an_cta, an_descr, impte_mens, impte_anua, impte_ajus, impte_ajuanu)
            values(vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA);
end if;
end foreach;

foreach
SELECT an_tit, an_cap, an_cta, upper(an_descr), impte_mens, impte_anua, impte_ajus, impte_ajuanu
into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA
from est_pred
order by 1,2,3
return   	vparTitulo,vparCapitulo,vparCuenta,vparDescrip,vparImporteMen,vparImporteAnu,vparImporteajum,vparImporteAjua
with resume;
end foreach;
drop table est_pred;
end procedure;

create PROCEDURE "saranda".spd_estadpredial1(
    		parAxo	                integer,
    		parMes     	smallint,
    		parCompleto1     	integer,
   		parCompleto     	integer
		)
	               	returning     smallint,
	 		char(02),
	 		integer,
	 		char(60),
		 	money(15,2),
		 	money(15,2),
		 	money(15,2),
		 	money(15,2);

 define vparTitulo  		smallint;
 define vparCapitulo 	char(02);
 define vparCuenta 		integer;
 define vparDescrip 		char(60);
 define vparImporteMen 	money(15,2);
 define vparImporteajuM 	money(15,2);
 define vparImporteAnu 	money(15,2);
 define vparImporteajuA 	money(15,2);

foreach
      SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, sum(a.importe_cta), (0),(0),(0)
      into   vparTitulo, vparCapitulo, vparCuenta, vparDescrip, vparImporteMen, vparImporteAnu,vparImporteajuM,vparImporteajuA
      from         cg_12_importes a , cg_12_cuentas b
     where      ((year(a.fecing)=parAxo) and (month(a.fecing)=parMes)) and a.cta_aplicacion=b.cta_aplicacion          
      and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
     group by   b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 
union
 SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),sum(a.importe),(0),(0)
     from       ta_12_ingresoanual  a, cg_12_cuentas b
     where   a.axo_mes>=parcompleto1  and a.axo_mes<parcompleto and a.cta_aplicacion=b.cta_aplicacion
      and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
    group by  b.titulo, b.capitulo, b.cta_aplicacion,  b.descripcion
union
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),sum(a.importe_ajuste), (0)
from ta_12_ajustes a , cg_12_cuentas b
 where year(a.fecha_ajuste)=parAxo and month(a.fecha_ajuste)=parMes
 and a.cta_aplicacion=b.cta_aplicacion       and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 
union
SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, (0),(0),(0),sum(a.importe_ajuste)
from ta_12_ajustes a , cg_12_cuentas b
 where year(a.fecha_ajuste)=parAxo and month(a.fecha_ajuste)<parMes
 and a.cta_aplicacion=b.cta_aplicacion      and (b.id_modulocat in(5,1205,7) or tipo_pago='P')
group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

return   	vparTitulo,vparCapitulo,vparCuenta,vparDescrip,vparImporteMen,vparImporteAnu,vparImporteajum,vparImporteAjua
with resume;
end foreach;

end procedure;

CREATE PROCEDURE "informix".distingresostitulos( p_axo int , p_mes int)
returning 
int as titulo,
varchar(50) as descripcion,
money(15,2) as importe,
money(15,2) as acumulado;
-----------Define las variables de retorno----------------
define v_descripcion    	varchar(50);
define v_titulo 	int;
define v_axo_anteriores 	int;
define v_ingreso_01 money(15,2);
define v_ingreso_02 money(15,2);
define v_ingreso_03 money(15,2);
define v_ingreso_04 money(15,2);
define v_ingreso_05 money(15,2);
define v_ingreso_06 money(15,2);
define v_ingreso_07 money(15,2);
define v_ingreso_08 money(15,2);
define v_ingreso_09 money(15,2);
define v_ingreso_10 money(15,2);
define v_ingreso_11 money(15,2);
define v_ingreso_12 money(15,2);
define v_acumulado  money(15,2);
define v_importe    money(15,2);
FOREACH
       SELECT  a.titulo, b.desc_titulo , nvl(a.ingreso_01,0)  
 , nvl(a.ingreso_02,0)
 , nvl(a.ingreso_03,0)
 , nvl(a.ingreso_04,0)
 , nvl(a.ingreso_05,0)
 , nvl(a.ingreso_06,0)
 , nvl(a.ingreso_07,0)
 , nvl(a.ingreso_08,0)
 , nvl(a.ingreso_09,0)
 , nvl(a.ingreso_10,0)
 , nvl(a.ingreso_11,0)
 , nvl(a.ingreso_12,0)

       into v_titulo, v_descripcion , v_ingreso_01  , v_ingreso_02 , v_ingreso_03 , v_ingreso_04 , v_ingreso_05
 , v_ingreso_06 , v_ingreso_07 , v_ingreso_08 , v_ingreso_09 , v_ingreso_10 , v_ingreso_11 , v_ingreso_12

  from ta_pres_dev_ing a , ta_12_titulos b
where a.ejercicio = p_axo and  a.capitulo = 0 and a.cta_aplicacion = 0
 and a.titulo = b.titulo   and a.capitulo = b.capitulo
order by 1
if p_mes = 01 then
   let v_importe = v_ingreso_01;
   let v_acumulado = v_ingreso_01;
end if;
if p_mes = 02 then
   let v_importe = v_ingreso_02;
   let v_acumulado = v_ingreso_01 + v_ingreso_02;
end if;
if p_mes = 03 then
   let v_importe = v_ingreso_03;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03;
end if;
if p_mes = 04 then
   let v_importe = v_ingreso_04;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04;
end if;
if p_mes = 05 then
   let v_importe = v_ingreso_05;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05;
end if;
if p_mes = 06 then
   let v_importe = v_ingreso_06;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06;
end if;
if p_mes = 07 then
   let v_importe = v_ingreso_07;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07;
end if;
if p_mes = 08 then
   let v_importe = v_ingreso_08;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08;
end if;
if p_mes = 09 then
   let v_importe = v_ingreso_09;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09;
end if;
if p_mes = 10 then
   let v_importe = v_ingreso_10;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10;
end if;
if p_mes = 11 then
   let v_importe = v_ingreso_11;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10 + v_ingreso_11;
end if;
if p_mes = 12 then
   let v_importe = v_ingreso_12;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10 + v_ingreso_11 + v_ingreso_12;
end if;


return v_titulo, v_descripcion , v_importe , v_acumulado with resume;

end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".distingresoscapitulos( p_axo int, p_titulo int , p_mes int)
returning 
int as titulo,
int as capitulo,
varchar(50) as descripcion,
money(15,2) as ingreso2,
money(15,2) as acumulado;
-----------Define las variables de retorno----------------
define v_descripcion    	varchar(50);
define v_titulo 	int;
define v_capitulo 	int;
define v_axo_anteriores 	int;
define v_ingreso_01 money(15,2);
define v_ingreso_02 money(15,2);
define v_ingreso_03 money(15,2);
define v_ingreso_04 money(15,2);
define v_ingreso_05 money(15,2);
define v_ingreso_06 money(15,2);
define v_ingreso_07 money(15,2);
define v_ingreso_08 money(15,2);
define v_ingreso_09 money(15,2);
define v_ingreso_10 money(15,2);
define v_ingreso_11 money(15,2);
define v_ingreso_12 money(15,2);
define v_acumulado  money(15,2);
define v_importe    money(15,2);
FOREACH
       SELECT  a.titulo,a.capitulo, b.desc_capitulo , nvl(a.ingreso_01,0)  
 , nvl(a.ingreso_02,0)
 , nvl(a.ingreso_03,0)
 , nvl(a.ingreso_04,0)
 , nvl(a.ingreso_05,0)
 , nvl(a.ingreso_06,0)
 , nvl(a.ingreso_07,0)
 , nvl(a.ingreso_08,0)
 , nvl(a.ingreso_09,0)
 , nvl(a.ingreso_10,0)
 , nvl(a.ingreso_11,0)
 , nvl(a.ingreso_12,0)

       into v_titulo,v_capitulo, v_descripcion , v_ingreso_01  , v_ingreso_02 , v_ingreso_03 , v_ingreso_04 , v_ingreso_05
 , v_ingreso_06 , v_ingreso_07 , v_ingreso_08 , v_ingreso_09 , v_ingreso_10 , v_ingreso_11 , v_ingreso_12

  from ta_pres_dev_ing a , ta_12_titulos b
where a.ejercicio = p_axo and  a.titulo = p_titulo and a.capitulo > 0 and a.cta_aplicacion = 0
 and a.titulo = b.titulo   and a.capitulo = b.capitulo
order by 2

if p_mes = 01 then
   let v_importe = v_ingreso_01;
   let v_acumulado = v_ingreso_01;
end if;
if p_mes = 02 then
   let v_importe = v_ingreso_02;
   let v_acumulado = v_ingreso_01 + v_ingreso_02;
end if;
if p_mes = 03 then
   let v_importe = v_ingreso_03;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03;
end if;
if p_mes = 04 then
   let v_importe = v_ingreso_04;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04;
end if;
if p_mes = 05 then
   let v_importe = v_ingreso_05;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05;
end if;
if p_mes = 06 then
   let v_importe = v_ingreso_06;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06;
end if;
if p_mes = 07 then
   let v_importe = v_ingreso_07;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07;
end if;
if p_mes = 08 then
   let v_importe = v_ingreso_08;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08;
end if;
if p_mes = 09 then
   let v_importe = v_ingreso_09;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09;
end if;
if p_mes = 10 then
   let v_importe = v_ingreso_10;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10;
end if;
if p_mes = 11 then
   let v_importe = v_ingreso_11;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10 + v_ingreso_11;
end if;
if p_mes = 12 then
   let v_importe = v_ingreso_12;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10 + v_ingreso_11 + v_ingreso_12;
end if;


return v_titulo,v_capitulo, v_descripcion , v_importe , v_acumulado with resume;

end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".distingresosctaaplic( p_axo int, p_titulo int, p_capitulo int , p_mes int)
returning 
int as cta_aplicacion,
varchar(50) as descripcion,
money(15,2) as ingreso3,
money(15,2) as acumulado;
-----------Define las variables de retorno----------------
define v_descripcion    	varchar(50);
define v_titulo 	int;
define v_cta_aplicacion 	int;
define v_axo_anteriores 	int;
define v_ingreso_01 money(15,2);
define v_ingreso_02 money(15,2);
define v_ingreso_03 money(15,2);
define v_ingreso_04 money(15,2);
define v_ingreso_05 money(15,2);
define v_ingreso_06 money(15,2);
define v_ingreso_07 money(15,2);
define v_ingreso_08 money(15,2);
define v_ingreso_09 money(15,2);
define v_ingreso_10 money(15,2);
define v_ingreso_11 money(15,2);
define v_ingreso_12 money(15,2);
define v_acumulado  money(15,2);
define v_importe    money(15,2);
FOREACH
SELECT a.cta_aplicacion , nvl(b.descripcion,'sin definir') , nvl(a.ingreso_01,0)  
 , nvl(a.ingreso_02,0)
 , nvl(a.ingreso_03,0)
 , nvl(a.ingreso_04,0)
 , nvl(a.ingreso_05,0)
 , nvl(a.ingreso_06,0)
 , nvl(a.ingreso_07,0)
 , nvl(a.ingreso_08,0)
 , nvl(a.ingreso_09,0)
 , nvl(a.ingreso_10,0)
 , nvl(a.ingreso_11,0)
 , nvl(a.ingreso_12,0)

       into v_cta_aplicacion, v_descripcion , v_ingreso_01  , v_ingreso_02 , v_ingreso_03 , v_ingreso_04 , v_ingreso_05
 , v_ingreso_06 , v_ingreso_07 , v_ingreso_08 , v_ingreso_09 , v_ingreso_10 , v_ingreso_11 , v_ingreso_12

  from ta_pres_dev_ing a , outer cg_12_cuentas b 
where a.ejercicio = p_axo and  a.titulo = p_titulo and a.capitulo = p_capitulo and a.cta_aplicacion > 0
       and a.cta_aplicacion = b.cta_aplicacion 
order by 1

if p_mes = 01 then
   let v_importe = v_ingreso_01;
   let v_acumulado = v_ingreso_01;
end if;
if p_mes = 02 then
   let v_importe = v_ingreso_02;
   let v_acumulado = v_ingreso_01 + v_ingreso_02;
end if;
if p_mes = 03 then
   let v_importe = v_ingreso_03;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03;
end if;
if p_mes = 04 then
   let v_importe = v_ingreso_04;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04;
end if;
if p_mes = 05 then
   let v_importe = v_ingreso_05;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05;
end if;
if p_mes = 06 then
   let v_importe = v_ingreso_06;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06;
end if;
if p_mes = 07 then
   let v_importe = v_ingreso_07;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07;
end if;
if p_mes = 08 then
   let v_importe = v_ingreso_08;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08;
end if;
if p_mes = 09 then
   let v_importe = v_ingreso_09;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09;
end if;
if p_mes = 10 then
   let v_importe = v_ingreso_10;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10;
end if;
if p_mes = 11 then
   let v_importe = v_ingreso_11;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10 + v_ingreso_11;
end if;
if p_mes = 12 then
   let v_importe = v_ingreso_12;
   let v_acumulado = v_ingreso_01 + v_ingreso_02 + v_ingreso_03 + v_ingreso_04 + v_ingreso_05  + v_ingreso_06
    + v_ingreso_07  + v_ingreso_08  + v_ingreso_09 + v_ingreso_10 + v_ingreso_11 + v_ingreso_12;
end if;


return v_cta_aplicacion, v_descripcion , v_importe , v_acumulado with resume;

end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".sp42_doctos ( penv_rec char(1), pcontrol int, pcentro_destino int, pid_usuario_centro int, preqresp char(1), pstatus int )

returning   int as estatus,
            varchar(100) as mensaje;

define v_status		int;
define v_mensaje 		varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp42_doctos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

   			insert into t42_doctos (id, 	t42_control_id, 	t42_centros_id, 	t42_personas_id_recibe, 	fec_notif, 	
						req_resp, 		usuario_mov, 	fec_mov, 			t42_status_id )
   					values(0, 	pcontrol, 		pcentro_destino, 	pid_usuario_centro,		current, 		
						preqresp, 		user,		current,			pstatus );
			let v_status=dbinfo("sqlca.sqlerrd1");

   return v_status,'DOCUMENTO CORRECTAMENTE';

end procedure;

CREATE PROCEDURE "informix".sp42_seguimiento ( puser varchar(10),pvig int )
returning   varchar(30) as abreviatura,
            integer as numero,
            integer as ejercicio,
            varchar(30) as nombre_generico,
            varchar(100) as nombre_centro,
            integer as id_control,
            integer as id_usuario,
            integer as id_persona,
            integer as id_centro;

define v_abrevia,v_generico varchar(30);
define v_numero,v_ejercicio,v_idcontrol,v_iduser,v_idpersona,v_doctos, v_idcentro integer;
define v_centro varchar(100);
define v_cantidad	int;

let v_abrevia='';
let v_generico='';
let v_idpersona=0;
let v_numero=0;
let v_ejercicio=0;
let v_idcontrol=0;
let v_iduser=0;
let v_centro='';

let v_cantidad = 0;

--select h.abreviatura,e.numero,e.ejercicico,e.nombre_generico,d.nombre,e.id,a.id
--,(select id from t42_personas where t42_centros_id=b.t42_centros_id),nvl(count(*),0) 
--into v_abrevia,v_numero,v_ejercicio,v_generico,v_centro,v_idcontrol,v_iduser,v_idpersona,v_doctos
--from t42_deleg a,t42_seguimiento b,t42_centros d,t42_control e,t42_doctos f,t42_personas h
--where a.usuario=puser and a.t42_status_id=1 and e.t42_status_id=pvig and b.usuario_seg=a.id 
--and f.id=b.t42_doctos_id and e.id=f.t42_control_id and d.id=e.t42_centros_id
--and h.t42_centros_id=d.id 
--group by h.abreviatura,e.numero,e.ejercicico,e.nombre_generico,d.nombre,e.id,a.id,8
--order by h.abreviatura,e.numero,e.ejercicico

foreach
select b.abreviatura,e.numero,e.ejercicico,e.nombre_generico,d.nombre,e.id,a.id,b.id 
into v_abrevia,v_numero,v_ejercicio,v_generico,v_centro,v_idcontrol,v_iduser,v_idpersona
from t42_deleg a,t42_personas b,t42_centros d,t42_control e
where a.usuario=puser and a.t42_status_id=1 
and e.t42_status_id=pvig and b.t42_deleg_id=a.id 
and d.id=b.t42_centros_id and (e.t42_centros_id=d.id or e.t42_centro_id_captura=d.id)  
order by b.abreviatura,e.numero,e.ejercicico

return v_abrevia,v_numero,v_ejercicio,v_generico,v_centro,v_idcontrol,v_iduser,v_idpersona, v_idcentro
with resume;
end foreach;

FOREACH
select b.abreviatura, a.id, b.id, c.id, d.t42_control_id, a.autorizado
into v_abrevia,v_centro,v_idcontrol,v_iduser,v_idpersona, v_idcentro 
from t42_deleg a, t42_personas b, t42_centros c, t42_doctos d
where a.usuario = 'pgcabrer' and a.t42_status_id = 1 and a.autorizado = 1
and b.id = a.t42_personas_id and c.id = b.t42_centros_id
and d.t42_centros_id = c.id
END FOREACH;





foreach	--	OFICIOS RECIBIDOS
select b.abreviatura, d.numero, d.ejercicico, d.nombre_generico, e.nombre, d.id, a.id, b.id, d.t42_centros_id
into v_abrevia,v_numero,v_ejercicio,v_generico,v_centro,v_idcontrol,v_iduser,v_idpersona, v_idcentro
from t42_deleg a, t42_personas b, t42_centros c, t42_control d, t42_centros e    
where a.usuario = puser and a.t42_status_id=1  and a.autorizado = 1
and b.id = a.t42_personas_id and c.id = b.t42_centros_id
and d.t42_centros_id = b.t42_centros_id and d.t42_status_id = pvig and d.tipo_control = 'R'  	-- ADICIONADO EL ULTIMO AND
and e.id = d.t42_centros_id

return v_abrevia,v_numero,v_ejercicio,v_generico,v_centro,v_idcontrol,v_iduser,v_idpersona, v_idcentro
with resume;
end foreach;



foreach	--	OFICIOS ENVIADOS
select b.abreviatura, d.numero, d.ejercicico, d.nombre_generico, e.nombre, d.id, a.id, b.id, d.t42_centros_id
into v_abrevia,v_numero,v_ejercicio,v_generico,v_centro,v_idcontrol,v_iduser,v_idpersona, v_idcentro
from t42_deleg a, t42_personas b, t42_centros c, t42_control d, t42_centros e    
where a.usuario = puser and a.t42_status_id=1  and a.autorizado = 1
and b.id = a.t42_personas_id and c.id = b.t42_centros_id
and d.t42_centro_id_captura = b.t42_centros_id and d.t42_status_id = pvig
and e.id = d.t42_centros_id
return v_abrevia,v_numero,v_ejercicio,v_generico,v_centro,v_idcontrol,v_iduser,v_idpersona, v_idcentro
with resume;
end foreach;


end procedure;

CREATE PROCEDURE "informix".grafphp_catval(p_reca int , p_tipo char(1) , p_cuenta int)
returning 
int as escritura,
varchar(50) as notario,
char(10) as fecha_otorgamiento,
int as area_titulo,
money(16,2) as valor_transm,
varchar(50) as naturaleza_acto,
int as pago_reca,
char(10) as pago_fecha,
money(16,2) as pago_importe,
decimal(10,2) as notsup_terreno,
decimal(10,2) as notsup_const,
money(16,2) as notval_terreno,
money(16,2) as notval_const,
money(16,2) as notval_fiscal,
decimal(10,2) as tecsup_terreno,
decimal(10,2) as tecsup_const,
money(16,2) as tecval_terreno,
money(16,2) as tecval_const,
money(16,2) as tecval_fiscal,
decimal(10,2) as regsup_terreno,
decimal(10,2) as regsup_const,
money(16,2) as regval_terreno,
money(16,2) as regval_const,
money(16,2) as regval_fiscal;
-----------Define las variables de retorno----------------
define v_escritura  int ;
define v_notario  varchar(50);
define v_fecha_otorgamiento char(10) ;
define v_area_titulo  int;
define v_valor_transm  money(16,2);
define v_naturaleza_acto varchar(50);
define v_pago_reca int;
define v_pago_fecha char(10);
define v_pago_importe money(16,2);
define v_notsup_terreno decimal(10,2);
define v_notsup_const decimal(10,2);
define v_notval_terreno money(16,2);
define v_notval_const money(16,2);
define v_notval_fiscal money(16,2);
define v_tecsup_terreno decimal(10,2);
define v_tecsup_const decimal(10,2);
define v_tecval_terreno money(16,2);
define v_tecval_const money(16,2);
define v_tecval_fiscal money(16,2);
define v_regsup_terreno decimal(10,2);
define v_regsup_const decimal(10,2);
define v_regval_terreno money(16,2);
define v_regval_const money(16,2);
define v_regval_fiscal money(16,2);
--
define v_cvecuenta int;
define  v_compro_trans int;
define v_cvevalor int;
define v_cveavaluo int;
define v_cveavaext int;
select cvecuenta into v_cvecuenta from catastro_gdl:convcta
 where recaud = p_reca and urbrus = p_tipo and cuenta = p_cuenta;
select cvevalor , cveavaluo into v_cvevalor , v_cveavaluo from catastro_gdl:catastro where cvecuenta = v_cvecuenta;

select  max(axocomp * 1000000 + nocomp) into v_compro_trans
 from catastro_gdl:actostransm where cvecuenta = v_cvecuenta and axocomp <= year(today) and status = 'R';

select a.noescrituras, trim(n.nombres)|| ' ' || trim(n.paterno)|| ' '  || trim(n.materno) ,
a.fechaotorg ,a.areatitulo , a.valortransm, a.cveavaext , na.descripcion, p.recaud , p.fecha , p.importe  
into 
v_escritura , v_notario , v_fecha_otorgamiento, v_area_titulo  , v_valor_transm , v_cveavaext ,
 v_naturaleza_acto , v_pago_reca, v_pago_fecha, v_pago_importe
 from catastro_gdl:actostransm a, catastro_gdl:notario n , catastro_gdl:c_natactos na,  outer catastro_gdl:pagos p
where a.cvecuenta = v_cvecuenta and status = 'R' and (a.axocomp * 1000000 + a.nocomp) = v_compro_trans
  and n.idnotaria = a.idnotaria and 
na.idacto = a.naturaleza and 
p.cvepago = a.cvepago;
if (v_cveavaext is null) or (v_cveavaext = 0 )then
let v_cveavaext = 0;
let v_notsup_terreno = 0;
let v_notsup_const = 0;
let v_notval_terreno = 0;
let v_notval_const =0 ;
let v_notval_fiscal = 0;
else
select nvl(supterr,0) , nvl(supconst,0) , nvl(valterr,0) , nvl(valconst,0) , nvl(valava,0) 
into  v_notsup_terreno , v_notsup_const ,v_notval_terreno , v_notval_const , v_notval_fiscal
from catastro_gdl:avaexterno where cveavaext = v_cveavaext;
end if;

if (v_cvevalor is null) or (v_cvevalor = 0 )then
let v_cvevalor = 0;
let v_regsup_terreno = 0;
let v_regsup_const = 0;
let v_regval_terreno = 0;
let v_regval_const =0 ;
let v_regval_fiscal = 0;
else
select areaterr , areaconst , valterr ,valconst , valfiscal 
into  v_regsup_terreno , v_regsup_const ,v_regval_terreno , v_regval_const , v_regval_fiscal
from catastro_gdl:valores where cvevalor = v_cvevalor;
end if;

if (v_cveavaluo is null) or (v_cveavaluo = 0) then
let v_cvevalor = 0;
let v_tecsup_terreno = 0;
let v_tecsup_const = 0;
let v_tecval_terreno = 0;
let v_tecval_const =0 ;
let v_tecval_fiscal = 0;
else
select supterr , supconst , valorterr , valorconst , valfiscal  
into v_tecsup_terreno, v_tecsup_const , v_tecval_terreno , v_tecval_const, v_tecval_fiscal
from catastro_gdl:avaluos where cveavaluo = v_cveavaluo;
end if;



return v_escritura , v_notario , v_fecha_otorgamiento, v_area_titulo  , v_valor_transm ,
 v_naturaleza_acto , v_pago_reca, v_pago_fecha, v_pago_importe,
v_notsup_terreno , v_notsup_const ,v_notval_terreno , v_notval_const , v_notval_fiscal,
v_tecsup_terreno, v_tecsup_const , v_tecval_terreno , v_tecval_const, v_tecval_fiscal,
v_regsup_terreno , v_regsup_const ,v_regval_terreno , v_regval_const , v_regval_fiscal;


end procedure;

create procedure "informix".operingreegre(p_axo int) 
    RETURNING int as id_orden , char(30) as descripcion, money(16,2) as ingresos, money(16,2) as Gastos, money(16,2) as Diferencia ;
 define v_id_modulo int;
define v_descripcion char(30)  ;
 define v_ingreso_01  money(16,2); DEFINE  v_ingreso_02 money(16,2); DEFINE  v_ingreso_03 money(16,2);
 DEFINE v_ingreso_04  money(16,2); DEFINE  v_ingreso_05  money(16,2); DEFINE  v_ingreso_06  money(16,2);
 DEFINE  v_ingreso_07  money(16,2); DEFINE  v_ingreso_08 money(16,2); DEFINE  v_ingreso_09 money(16,2); 
 DEFINE  v_ingreso_10  money(16,2);  DEFINE  v_ingreso_11  money(16,2); DEFINE  v_ingreso_12  money(16,2); 
 define v_egreso_01  money(16,2); DEFINE  v_egreso_02 money(16,2); DEFINE  v_egreso_03 money(16,2);
 DEFINE v_egreso_04  money(16,2); DEFINE  v_egreso_05  money(16,2); DEFINE  v_egreso_06  money(16,2);
 DEFINE  v_egreso_07  money(16,2); DEFINE  v_egreso_08 money(16,2); DEFINE  v_egreso_09 money(16,2); 
 DEFINE  v_egreso_10  money(16,2);  DEFINE  v_egreso_11  money(16,2); DEFINE  v_egreso_12  money(16,2); 
define v_fechatime datetime year to fraction(3) ;
define feciniant date; define fecfinant date;
define axo_actual int;
define axo_antes int;
define v_orden int;
define dia  int;
define mes int;




 select   ingreso_01 , ingreso_02, ingreso_03,ingreso_04 , ingreso_05 , ingreso_06 ,
 ingreso_07 , ingreso_08, ingreso_09,ingreso_10 , ingreso_11 , ingreso_12  
 into 
 v_ingreso_01 , v_ingreso_02, v_ingreso_03, v_ingreso_04 , v_ingreso_05 , v_ingreso_06 ,
 v_ingreso_07 , v_ingreso_08, v_ingreso_09, v_ingreso_10 , v_ingreso_11 , v_ingreso_12 
 from ta_pres_dev_ing
 where ejercicio = 2014 and titulo = 1 and capitulo = 1 and cta_aplicacion = 1;
 select   ingreso_01 , ingreso_02, ingreso_03,ingreso_04 , ingreso_05 , ingreso_06 ,
 ingreso_07 , ingreso_08, ingreso_09,ingreso_10 , ingreso_11 , ingreso_12 
into 
 v_egreso_01 , v_egreso_02, v_egreso_03, v_egreso_04 , v_egreso_05 , v_egreso_06 ,
 v_egreso_07 , v_egreso_08, v_egreso_09, v_egreso_10 , v_egreso_11 , v_egreso_12 
 from ta_pres_dev_ing
 where ejercicio = 2014 and titulo = 2 and capitulo = 2 and cta_aplicacion = 2;

 return 1, 'ENERO' , v_ingreso_01 , v_egreso_01 , (v_ingreso_01 - v_egreso_01) with resume;
 return 2, 'FEBRERO' , v_ingreso_02 , v_egreso_02 , (v_ingreso_02 - v_egreso_02) with resume;
 return 3, 'MARZO' , v_ingreso_03 , v_egreso_03 , (v_ingreso_03 - v_egreso_03) with resume;
 return 4, 'ABRIL' , v_ingreso_04 , v_egreso_04 , (v_ingreso_04 - v_egreso_04) with resume;
 return 5, 'MAYO' , v_ingreso_05, v_egreso_05 , (v_ingreso_05 - v_egreso_05) with resume;
 return 6, 'JUNIO' , v_ingreso_06 , v_egreso_06 , (v_ingreso_06 - v_egreso_06) with resume;
 return 7, 'JULIO' , v_ingreso_07 , v_egreso_07 , (v_ingreso_07 - v_egreso_07) with resume;
 return 8, 'AGOSTO' , v_ingreso_08 , v_egreso_08 , (v_ingreso_08 - v_egreso_08) with resume;
 return 9, 'SEPTIEMBRE' , v_ingreso_09 , v_egreso_09 , (v_ingreso_09 - v_egreso_09) with resume;
 return 10, 'OCTUBRE' , v_ingreso_10 , v_egreso_10 , (v_ingreso_10 - v_egreso_10) with resume;
 return 11, 'NOVIEMBRE' , v_ingreso_11 , v_egreso_11 , (v_ingreso_11 - v_egreso_11) with resume;
 return 12, 'DICIEMBRE' , v_ingreso_12 , v_egreso_12 , (v_ingreso_12 - v_egreso_12) with resume;
end procedure;

create procedure "saranda".spd_12_gastoscob(p_fecd date, p_fech date, p_rec int)
                returning date as r_fecp, int as r_rec, char(02) as r_caja, int as r_oper, money as r_imptecta
                ,money as r_totcert, int as r_folio, int as r_ofnaf, date as r_fecemi, date as r_fecpra, date as r_fecent
                , money as r_imptegf, int as r_ejecutor, varchar(70) as r_nomeje, varchar(100) as r_datos;
define  v_fecp       date;
define  v_recp       int;
define  v_cajp       char(2);
define  v_opep       int;
define  v_tiporbo    int;
define  v_imptecta   money;
define  v_totcert    money;
define  v_folio      int;
define  v_eje        int;
define  v_ofnaf      int;
define  v_fecemi     date;
define  v_fecpra     date;
define  v_fecent     date;
define  v_impteg     money;
define  v_nomeje     varchar(70);
define  v_datos      varchar(100);
define  v_cvepago    int;
define  v_encap      int;
define  v_encca    int;

let v_encap=0;
let v_encca=0;

foreach

select i.fecing,i.recing,i.cajing,i.opcaja,i.importe_cta, r.totcertificado, r.tipo_rbo
into  v_fecp, v_recp, v_cajp, v_opep, v_imptecta, v_totcert, v_tiporbo 
 from cg_12_importes i, cg_12_ingreso r
 where i.fecing=r.fecing and i.recing=r.recing and i.cajing=r.cajing
and i.opcaja=r.opcaja and
i.fecing between p_fecd and p_fech and i.recing=p_rec and i.cta_aplicacion in(550600000, 992100009, 550630001)

if (v_tiporbo = 11) or (v_tiporbo = 16) then
   foreach
   select a.folio,a.zona, a.ejecutor,a.fecha_emision,a.fecha_practicado,a.fecha_entrega1,a.importe_gastos,e.nombre,
       case when a.modulo=16 then
      (select ('Aseo '||tc.tipo_aseo||'-'||ta.num_contrato)
       from    ta_16_contratos ta, ta_16_tipo_aseo tc
       where  ta.ctrol_aseo=tc.ctrol_aseo and ta.control_contrato=a.control_otr) 
       else
       (select ('Mercado '||oficina||'-'||num_mercado||'-'||categoria||'-'||seccion||'-'||local||'-'||nvl((letra_local),' ')||'-'||nvl((bloque),' ')) 
       from ta_11_locales where id_local=a.control_otr) end datos
   into  v_folio, v_ofnaf, v_eje, v_fecemi, v_fecpra, v_fecent, v_impteg , v_nomeje , v_datos 
   from ta_15_apremios a, ta_15_ejecutores e
   where a.ejecutor=e.cve_eje and e.id_rec=p_rec and a.fecha_pago=v_fecp and a.recaudadora=v_recp 
         and  a.caja=v_cajp and a.operacion=v_opep

   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_folio, v_ofnaf,  v_fecemi, v_fecpra, 
    v_fecent, v_impteg , v_eje, v_nomeje , v_datos
    with resume;
   end foreach
else
   select cvepago into v_cvepago from catastro_gdl:pagos 
    where fecha=v_fecp and recaud=v_recp and  caja=v_cajp and folio=v_opep;
    foreach
    select r.folioreq ,r.recaud, r.cveejecut, r.fecemi, r.fecpract, r.fecejec, r.gasto_req, (trim(e.nombres)||' '||trim(paterno)||' '||trim(materno)),
        ('Multa Mpal '||trim(d.abrevia)||'-'||m.axo_acta||'-'||m.num_acta)
    into  v_folio, v_ofnaf, v_eje, v_fecemi, v_fecpra, v_fecent, v_impteg , v_nomeje , v_datos 
    from catastro_gdl:reqmultas r, catastro_gdl:multas m, catastro_gdl:ejecutor e, catastro_gdl:c_dependencias d
    where  r.cvepago=v_cvepago and m.id_multa = r.id_multa and d.id_dependencia = m.id_dependencia
    and r.cveejecut =e.cveejecutor
   
   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_folio, v_ofnaf,  v_fecemi, v_fecpra, 
      v_fecent, v_impteg , v_eje, v_nomeje , v_datos
    with resume;
    end foreach;
    foreach
    select r.folioreq, r.recaud, r.cveejecut, r.fecemi, r.fecent, r.fecejec, r.gasto_req, (trim(e.nombres)||' '||trim(paterno)||' '||trim(materno)),
      ('Predial '||a.recaud||'-'||a.urbrus||'-'||a.cuenta)
    into  v_folio, v_ofnaf, v_eje, v_fecemi, v_fecpra, v_fecent, v_impteg , v_nomeje , v_datos 
    from catastro_gdl:convcta a, catastro_gdl:reqpredial r, catastro_gdl:ejecutor e
    where  r.cvepago=v_cvepago and r.cveejecut=e.cveejecutor   and a.cvecuenta = r.cvecuenta
 
   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_folio, v_ofnaf,  v_fecemi, v_fecpra, 
   v_fecent, v_impteg , v_eje, v_nomeje , v_datos
   with resume;
   end foreach;
end if;
end foreach;
foreach

  select i.fecing,i.recing,i.cajing,i.opcaja,i.importe_cta, r.totcertificado, r.tipo_rbo
  into  v_fecp, v_recp, v_cajp, v_opep, v_imptecta, v_totcert, v_tiporbo 
  from cg_12_importes i, cg_12_ingreso r
   where i.fecing=r.fecing and i.recing=r.recing and i.cajing=r.cajing
  and i.opcaja=r.opcaja and r.tipo_rbo=12 and
  i.fecing between p_fecd and p_fech and i.recing=p_rec and i.cta_aplicacion in(550600000, 992100009)

  if exists(select * from ta_15_apremios where fecha_pago=v_fecp and recaudadora=v_recp 
         and  caja=v_cajp and operacion=v_opep) then
     let v_encap=v_encap;
  else
  if exists(select * from catastro_gdl:pagos where fecha=v_fecp and recaud=v_recp and  caja=v_cajp and folio=v_opep) then
     select cvepago into v_cvepago from catastro_gdl:pagos 
     where fecha=v_fecp and recaud=v_recp and  caja=v_cajp and folio=v_opep;
     if exists(select * from catastro_gdl:reqmultas where cvepago=v_cvepago) then
        let v_encca=v_encca;
     else
     if exists(select * from catastro_gdl:reqpredial where cvepago=v_cvepago) then
        let v_encca=v_encca;
     else
     return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_encap, v_encca,  '', '', '', v_imptecta ,0, 0 ,'Gastos No Aplicados en Catastro Carg'
     with resume;
   end if;
   end if;
else
   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_encap, v_encca,  '', '', '',v_imptecta ,0, 0 ,'Gastos No Aplicados a Ningun Lado'
   with resume;
end if;
end if;
end foreach
end procedure;

create procedure "saranda".spd_12_gastoscobxrec(p_fecd date, p_fech date, p_rec int)
                returning date as r_fecp, int as r_rec, char(02) as r_caja, int as r_oper, money as r_imptecta
                ,money as r_totcert, int as r_folio, int as r_ofnaf, date as r_fecemi, date as r_fecpra, date as r_fecent
                , money as r_imptegf, int as r_ejecutor, varchar(70) as r_nomeje, varchar(100) as r_datos;
define  v_fecp       date;
define  v_recp       int;
define  v_cajp       char(2);
define  v_opep       int;
define  v_tiporbo    int;
define  v_imptecta   money;
define  v_totcert    money;
define  v_folio      int;
define  v_eje        int;
define  v_ofnaf      int;
define  v_fecemi     date;
define  v_fecpra     date;
define  v_fecent     date;
define  v_impteg     money;
define  v_nomeje     varchar(70);
define  v_datos      varchar(100);
define  v_cvepago    int;
define  v_encap      int;
define  v_encca    int;

let v_encap=0;
let v_encca=0;

foreach

select i.fecing,i.recing,i.cajing,i.opcaja,i.importe_cta, r.totcertificado, r.tipo_rbo
into  v_fecp, v_recp, v_cajp, v_opep, v_imptecta, v_totcert, v_tiporbo 
 from cg_12_importes i, cg_12_ingreso r
 where i.fecing=r.fecing and i.recing=r.recing and i.cajing=r.cajing
and i.opcaja=r.opcaja and
i.fecing between p_fecd and p_fech  and i.cta_aplicacion in(550600000, 992100009, 550630001)

if (v_tiporbo = 11) or (v_tiporbo = 16) then
   foreach
   select a.folio,a.zona, a.ejecutor,a.fecha_emision,a.fecha_practicado,a.fecha_entrega1,a.importe_gastos,e.nombre,
       case when a.modulo=16 then 
      (select ('Aseo '||tc.tipo_aseo||'-'||ta.num_contrato)
       from    ta_16_contratos ta, ta_16_tipo_aseo tc
       where  ta.ctrol_aseo=tc.ctrol_aseo and ta.control_contrato=a.control_otr) 
       else
       (select ('Mercado '||oficina||'-'||num_mercado||'-'||categoria||'-'||seccion||'-'||local||'-'||nvl((letra_local),' ')||'-'||nvl((bloque),' ')) 
       from ta_11_locales where id_local=a.control_otr) end datos
   into  v_folio, v_ofnaf, v_eje, v_fecemi, v_fecpra, v_fecent, v_impteg , v_nomeje , v_datos 
   from ta_15_apremios a, ta_15_ejecutores e
   where a.ejecutor=e.cve_eje and e.id_rec=p_rec and a.fecha_pago=v_fecp and a.recaudadora=v_recp 
         and  a.caja=v_cajp and a.operacion=v_opep and a.zona=p_rec

   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_folio, v_ofnaf,  v_fecemi, v_fecpra, 
    v_fecent, v_impteg , v_eje, v_nomeje , v_datos
    with resume;
   end foreach
else
   select cvepago into v_cvepago from catastro_gdl:pagos 
    where fecha=v_fecp and recaud=v_recp and  caja=v_cajp and folio=v_opep;
    foreach
    select r.folioreq ,r.recaud, r.cveejecut, r.fecemi, r.fecpract, r.fecejec, r.gasto_req, (trim(e.nombres)||' '||trim(paterno)||' '||trim(materno)),
        ('Multa Mpal '||trim(d.abrevia)||'-'||m.axo_acta||'-'||m.num_acta)
    into  v_folio, v_ofnaf, v_eje, v_fecemi, v_fecpra, v_fecent, v_impteg , v_nomeje , v_datos 
    from catastro_gdl:reqmultas r, catastro_gdl:multas m, catastro_gdl:ejecutor e, catastro_gdl:c_dependencias d
    where  r.cvepago=v_cvepago and m.id_multa = r.id_multa and d.id_dependencia = m.id_dependencia
    and r.cveejecut =e.cveejecutor and r.recaud=p_rec
   
   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_folio, v_ofnaf,  v_fecemi, v_fecpra, 
      v_fecent, v_impteg , v_eje, v_nomeje , v_datos
    with resume;
    end foreach;
    foreach
    select r.folioreq, r.recaud, r.cveejecut, r.fecemi, r.fecent, r.fecejec, r.gasto_req, (trim(e.nombres)||' '||trim(paterno)||' '||trim(materno)),
      ('Predial '||a.recaud||'-'||a.urbrus||'-'||a.cuenta)
    into  v_folio, v_ofnaf, v_eje, v_fecemi, v_fecpra, v_fecent, v_impteg , v_nomeje , v_datos 
    from catastro_gdl:convcta a, catastro_gdl:reqpredial r, catastro_gdl:ejecutor e
    where  r.cvepago=v_cvepago and r.cveejecut=e.cveejecutor   and a.cvecuenta = r.cvecuenta and r.recaud=p_rec
 
   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_folio, v_ofnaf,  v_fecemi, v_fecpra, 
   v_fecent, v_impteg , v_eje, v_nomeje , v_datos
   with resume;
   end foreach;
end if;
end foreach;
foreach

  select i.fecing,i.recing,i.cajing,i.opcaja,i.importe_cta, r.totcertificado, r.tipo_rbo
  into  v_fecp, v_recp, v_cajp, v_opep, v_imptecta, v_totcert, v_tiporbo 
  from cg_12_importes i, cg_12_ingreso r
   where i.fecing=r.fecing and i.recing=r.recing and i.cajing=r.cajing
  and i.opcaja=r.opcaja and r.tipo_rbo=12 and
  i.fecing between p_fecd and p_fech and i.recing=p_rec and i.cta_aplicacion in(550600000, 992100009)

  if exists(select * from ta_15_apremios where fecha_pago=v_fecp and recaudadora=v_recp 
         and  caja=v_cajp and operacion=v_opep) then
     let v_encap=v_encap;
  else
  if exists(select * from catastro_gdl:pagos where fecha=v_fecp and recaud=v_recp and  caja=v_cajp and folio=v_opep) then
     select cvepago into v_cvepago from catastro_gdl:pagos 
     where fecha=v_fecp and recaud=v_recp and  caja=v_cajp and folio=v_opep;
     if exists(select * from catastro_gdl:reqmultas where cvepago=v_cvepago) then
        let v_encca=v_encca;
     else
     if exists(select * from catastro_gdl:reqpredial where cvepago=v_cvepago) then
        let v_encca=v_encca;
     else
     return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_encap, v_encca,  '', '', '', v_imptecta ,0, 0 ,'Gastos No Aplicados en Catastro Carg'
     with resume;
   end if;
   end if;
else
   return  v_fecp,v_recp,v_cajp,v_opep,v_imptecta,v_totcert,v_encap, v_encca,  '', '', '',v_imptecta ,0, 0 ,'Gastos No Aplicados a Ningun Lado'
   with resume;
end if;
end if;
end foreach
end procedure;

create procedure "informix".admin_adeudos_detalle_20(pinterface int,pcol char(10),pcalle char(10),pfol varchar(10),
pseg4 varchar(10),pseg5 varchar(10),pseg6 varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(50) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  a_colonia,a_descripcion varchar(50);
define  a_calle varchar(80);
define  a_tipoobra varchar(20);
define  a_nombreobra varchar(100);
define  a_referencia varchar(30);
define  a_pagototal,a_pagoinicial,a_pagoparcial,a_adeudo,a_monto,a_acumulado decimal(14,2);
define  a_pagos,a_parcialidad,a_restan,a_apagar,a_cuentaapl int;
define  a_vencimiento date;
define  v_id,v_ref int;

begin
    on exception in (-958)
       delete from tmp_totalesobra;
    end exception;
create temp table tmp_totalesobra(
  rubro int,
  concepto int,
  cuenta int,
  referencia int,
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

select id_convenio into v_id from ta_17_convenios
where colonia=pcol and calle=pcalle and folio=pfol;

if trim(pref)='' then
   let v_ref=0;
else
   let v_ref=pref;
end if;

foreach
execute procedure admin_adeudo_20(v_id,v_ref,3) into a_colonia,a_calle,a_tipoobra,a_nombreobra,a_pagototal,a_pagoinicial,
a_pagoparcial,a_pagos,a_adeudo,a_vencimiento,a_parcialidad,a_restan,a_apagar,a_cuentaapl,a_referencia,
a_descripcion,a_monto,a_acumulado
return 0,0,a_cuentaapl,a_referencia,a_descripcion,a_monto,a_acumulado with resume;
insert into tmp_totalesobra values(0,0,a_cuentaapl,a_referencia,a_descripcion,a_monto,a_acumulado);
end foreach;

end procedure;

create procedure "informix".admin_encabezados_20(pinterface int,pcol char(10),pcalle char(10),pfol varchar(10),
pseg4 varchar(10),pseg5 varchar(10),pseg6 varchar(10))

returning   varchar(92) as Nombrecompleto,
            varchar(80) as calle,
            varchar(10) as Exterior,
            varchar(10) as interior,
            varchar(50) as colonia,
            varchar(10) as codigopostal,
            varchar(13) as RFC,
            varchar(50) as municipio,
            varchar(50) as estado,
            varchar(18) as curp,
            integer as carteraxcobar,
            varchar(255) as leyenda,
            varchar(255) as leyendaRECIBO,
            integer as codigo;

define  v_descripcionrecibo lvarchar(500);
define  v_carteraxcobar,v_codigo,v_adeudo,v_id integer;
define  v_leyenda varchar(255);
define  v_nombre varchar(92);
define  v_calle,a_calle varchar(80);  
define  v_ext,v_int varchar(10);
define  v_vig char(1);
define  v_col,a_colonia,a_descripcion varchar(50);
define  a_tipoobra varchar(20);
define  a_referencia varchar(30);
define  a_nombreobra varchar(100);
define  a_pagototal,a_pagoinicial,a_pagoparcial,a_adeudo,a_monto,a_acumulado decimal(8,2);
define  a_pagos,a_parcialidad,a_restan,a_apagar,a_cuentaapl int;
define  a_vencimiento date;

let v_adeudo=0;
if not exists(select * from ta_17_convenios where colonia=pcol and calle=pcalle and folio=pfol) then
       return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'NO EXISTE CONTRATO','',-1;
end if;

select a.id_convenio,a.nombre,a.desc_calle,a.numero,a.vigencia,b.descripcion
into v_id,v_nombre,v_calle,v_ext,v_vig,v_col 
from ta_17_convenios a,ta_17_colonias b
where a.colonia=pcol and a.calle=pcalle and a.folio=pfol
and b.colonia=a.colonia;

if v_vig<>'A' then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONTRATO CANCELADO','',-1;
end if;

execute procedure admin_adeudo_20(v_id,0,1) into a_colonia,a_calle,a_tipoobra,a_nombreobra,a_pagototal,a_pagoinicial,
a_pagoparcial,a_pagos,a_adeudo,a_vencimiento,a_parcialidad,a_restan,a_apagar,a_cuentaapl,a_referencia,
a_descripcion,a_monto,a_acumulado;

if (v_vig='A') and (a_adeudo=0) then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONTRATO PAGADO','',-1;
else
if (v_vig='A') and (a_adeudo<0) then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONTRATO CON SALDO A FAVOR DE '||a_adeudo,'',-1;
else
if (v_vig='A') and (a_adeudo>0) then 
   return v_nombre,v_calle,v_ext,' ',v_col,' ',' ',' ',' ',' ',1,'CONTRATO CON ADEUDO, PUEDE COBRARSE','',0;
end if;
end if;
end if;

end procedure;

create procedure "pgcabrer".spd_11_pagosmerc(pini date,pfin date,paxo int,pmes int)
returning   int as mercado,
            varchar(60) as nombre,
            money(16,2) as renta,
            money(16,2) as actual,
            money(16,2) as rezago,
            money(16,2) as adeudo;

define v_merc int;
define v_nombre varchar(60);
define v_rezago,v_actual,v_renta,v_adeudo money(16,2);

foreach
select a.num_mercado_nvo,a.descripcion,nvl(fn_getrentamerc(year(pini),a.num_mercado_nvo),0),
nvl(fn_getpagmerc(pini,pfin,a.num_mercado_nvo,2),0),
nvl(fn_getpagmerc(pini,pfin,a.num_mercado_nvo,1),0), 
nvl(fn_getadetotmerc(a.num_mercado_nvo,paxo,pmes),0)
into v_merc,v_nombre,v_renta,v_rezago,v_actual,v_adeudo
from ta_11_mercados a
where num_mercado_nvo not in (99,214)
order by a.num_mercado_nvo

return v_merc,v_nombre,v_renta,v_actual,v_rezago,v_adeudo
with resume;
end foreach; 
end procedure;

create function "pgcabrer".fn_getpagmerc(pini date,pfin date,pmerc int,ptipo int)
returning   money(16,2) as adeudo;

define v_rezago money(16,2);
define v_rezdev money(16,2);
define v_actual money(16,2);

if ptipo=3 then
   select nvl(sum(importe_pago),0) into v_rezago 
   from ta_11_pagos_local a,ta_11_locales b
   where (fecha_pago between pini and pfin) and axo<=year(pini)-1
   and b.num_mercado=pmerc
   and b.id_local=a.id_local; 
   return v_rezago;
else
if ptipo=2 then
   select nvl(sum(importe_pago),0) into v_rezdev 
   from ta_11_pagos_local a,ta_11_locales b
   where (fecha_pago between pini and pfin) 
   and ((axo=year(pini) and a.periodo<=month(pini)-1) or (axo<year(pini)))
   and b.num_mercado=pmerc
   and b.id_local=a.id_local;
   return v_rezdev;
else
if ptipo=1 then
   select nvl(sum(importe_pago),0) into v_actual 
   from ta_11_pagos_local a,ta_11_locales b
   where (fecha_pago between pini and pfin) 
   and ((axo=year(pini) and a.periodo>=month(pini)) or (axo>year(pini)))
   and b.num_mercado=pmerc
   and b.id_local=a.id_local;
   return v_actual;
else
   return 0;
end if;
end if;
end if;
end function;

CREATE PROCEDURE "informix".admin_pago_14s(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10), p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10), p_Apagar char(20), p_certifp money,p_imptep money,
                                  p_redonp money, p_idcobro int, p_foliorbo varchar(10), p_fechapago date, p_recrbo int,  p_centrorbo int,p_cajarbo char(20),
                                  p_nomcajero  varchar(40), p_cajero    varchar(08), p_adicional1 varchar(100), p_adicional2 varchar(100),
                                  p_adicional3 varchar(100), p_adicional4 varchar(100), p_adicional5 varchar(100), p_adicional6 varchar(100),
                                  p_adicional7 varchar(100), p_adicional8 varchar(100), p_adicional9 varchar(100), p_adicional10 varchar(100),
                                  p_adicional11 varchar(100), p_adicional12 varchar(100), p_adicional13 varchar(100), p_adicional14 varchar(100),
                                  p_adicional15 varchar(100))
                RETURNING int as sbien, varchar(255) as mensage;



define v_lError     int;
define v_lISAMError, v_tok int;
define v_vcMensaje,v_tmsg  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);
define vcvepago     int;
define v_axop     int;
define v_axof,v_cont,v_uno,v_dos     int;
define v_control,v_idusu    integer;
define  par_axod,v_ctaapl1   int;
define  par_axoh   int;
define  par_importe money;
define  par_recar   money;
define  par_tot   money;
define  v_nombre,v_colonia  varchar(80);
define  v_domcompleto,v_desade VARCHAR(75);
define  v_exte,v_refe      VARCHAR(10);
define  v_inte      VARCHAR(10);
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -1, 'admin_pago_14 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

-- set debug file to "pago14";
-- trace on;
  let v_r = 'N';
let v_control= nvl(p_segmento1,0);
let v_cont   = 0;
let v_axof   = 0;
let par_axod = 0;
let v_tok    = 0;
let v_idusu    = 0;
let par_axoh = nvl(p_Apagar,0); 

SELECT cementerio, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, 
         nombre,domicilio, exterior, interior,colonia
into  v_cem, v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa,
      v_nombre,v_domcompleto,v_exte,v_inte,v_colonia
FROM ta_13_datosrcm where control_rcm=v_control;

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;

SELECT axofin
into  v_axof
FROM  ta_13_descrec where id_folio =v_control and vigencia='V';

if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if v_control>0 then
    BEGIN WORK;
   let v_r = 'S';
    insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
    id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcnumero,
    axofolio,id_usuario,fecha_act,descripcion, id_centro, foliorecibo) 
    values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro, p_certifp,'P',13, v_control, 0, '',1,par_axod,12,par_axoh,
    v_nombre, (Trim(v_domcompleto)||' '||trim(v_exte) ||' '||trim(v_inte)), v_colonia, v_control, 0, v_idusu, current,
    (p_nomcajero||' '||p_foliorbo||' '||v_cem||' '||v_clase||' '||trim(v_calfa)||' '||v_seccion||' '||trim(v_salfa)||' '||v_linea||' '||trim(v_lalfa)||' '||v_fosa||' '||trim(v_falfa)),
     p_centrorbo, p_foliorbo);

    foreach
     execute PROCEDURE admin_adeudos_detalle_14(v_control,'','','','','', p_Apagar) 
     into v_uno,v_dos, v_ctaapl1,v_refe,v_desade,par_importe, par_recar 
     let v_cont=v_cont+1;
     insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
     values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,v_desade,v_ctaapl1, par_importe);
     if par_axod = 0 then
        let par_axod=v_refe;
     end if;
    end foreach;

    if p_redonp <> 0 then
       let v_cont=v_cont+1;
       insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
       values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,'Redondeo ',55080000, p_redonp);
    end if;

    INSERT INTO ta_13_pagosrcm  VALUES(p_fechapago, p_recrbo, p_cajarbo, p_idcobro, 0, v_control, v_cem, v_clase, v_calfa, v_seccion, v_salfa, 
        v_linea, v_lalfa, v_fosa, v_falfa, par_axod, par_axoh, p_certifp, 0, 'A', 0, today);

   let vcvepago=dbinfo("sqlca.sqlerrd1");

   update ta_13_adeudosrcm set  vigencia='P', id_pago=vcvepago
     where control_rcm=v_control and axo_adeudo between par_axod and par_axoh and vigencia='V';


   if par_axoh>=v_axof then
      update ta_13_descrec
     set vigencia='P', fec_pag=p_fechapago, id_rec=p_recrbo, caja=p_cajarbo, operac=p_idcobro 
      where id_folio =v_control and vigencia='V';
  end if;

    update ta_13_datosrcm set axo_pagado=par_axoh where control_rcm=v_control;

   update ta_13_descpens set vigencia='P' where control_rcm=v_control and axo_descto between par_axod and par_axoh and vigencia='V';

 --  EXECUTE procedure spd_13_insextra_admin(v_control, p_adicional2, p_adicional3, p_adicional4,p_adicional5, p_adicional6) into v_tok, v_tmsg;

  COMMIT WORK;  
return 0,'Pagado ' || vcvepago;
else
return 1,'Folio a PAGAR no encontrado ' ||v_control;
end if;
trace off;
END PROCEDURE;

CREATE PROCEDURE "informix".sp_maq_verifica(p_mac varchar(255))
{######################################################################
#  Procedimiento:    sp_maq_verifica
#  Descripcion:      Verifica si una maquina tiene acceso a los modulos
#
#  Parametros        p_mac          = mac de la maquina
#  de entrada:       
#                    
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            22 Octubre 2012   
#  modificado:       7 de Julio de 2014
#  Llamado por:      ModulosGDL       
#  Llama a:          security:sp_maq_verifica
#  
######################################################################}
	returning 
int AS estatus,
varchar(255) AS mensaje;

--Parametros de salida:
define v_estatus		int;
define v_mensaje 		varchar(255);

-- fin Parametros de Salida

--hace el llamado al procedimiento en la base se seguridad
execute PROCEDURE security:"informix".sp_maq_verifica(p_mac) into v_estatus,v_mensaje;

--let v_estatus =0;	
--let v_mensaje = "Equipo Autorizado";
return v_estatus,v_mensaje;
END PROCEDURE
;

CREATE PROCEDURE "informix".sp_maq_verifica(p_hostname CHAR(256),p_mac varchar(255))
{######################################################################
#  Procedimiento:    sp_maq_verifica
#  Descripcion:      Verifica si una maquina tiene acceso a los modulos
#
#  Parametros        
#  de entrada:       p_hostname          = nombre de la maquina
#                    p_mac          = mac de la maquina
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            22 Octubre 2012   
#  modificado:       9 de Julio de 2014
#  Llamado por:      ModulosGDL       
#  Llama a:          security:sp_maq_verifica
#  
######################################################################}
	returning 
int AS estatus,
varchar(255) AS mensaje;

--Parametros de salida:
define v_estatus		int;
define v_mensaje 		varchar(255);

-- fin Parametros de Salida

--hace el llamado al procedimiento en la base se seguridad
execute PROCEDURE security:"informix".sp_maq_verifica(p_hostname,p_mac) into v_estatus,v_mensaje;

--let v_estatus =0;	
--let v_mensaje = "Equipo Autorizado";
return v_estatus,v_mensaje;
END PROCEDURE
;

create procedure "informix".admin_pago_22sd(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10),pref varchar(20),pimppag money(14,2),
pimpcartera money(14,2),pimpredondeo money(14,2),pidcobro int,
pfolio varchar(10),pfecha date,precp int,pcentrop int,pcaja char(20),pnombreuser varchar(40),
puser char(8))

{######################################################################
#  Procedimiento:    admin_pago_22
#  Descripcion:      Interfaz de pago para el cobro Convenios diversos para admin
#
#  Parametros        
#  de entrada:       pinterface = 22 numero de interfaz para convenios diversos
#                    ptipo = tipo de convenio ejem(1-predial)
#                    psubt = subtipo del tipo de convenio ejem (1-urbano)
#                    plet = letras del convenio ejem(ZC1)
#                    pnum = nuemro del convenio
#                    paxo = a�o del convenio
#                    pseg = sin informacion
#                    pref = hasta que parcialidad se afectara como pagado
#                    pimppag = importe total de pago
#                    pimpcartera = importe de total de las parcialidades 
#                    pimpredondeo = importe de redondeo
#                    pidcobro = numero de operacion,
#                    pfolio = folio de recibo ofical
#                    pfecha = fecha de pago
#                    precp = recaudadora de pago
#                    pcentrop = numero de centro de recaudacion
#                    pcaja = caja de pago
#                    pnombreuser = nombre del cajero
#                    puser = nombre del usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            30 Octubre 2013   
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}


returning   int as status, 
            varchar(100) as mensaje;

define v_Nombrecompleto varchar(92); 
define v_calle varchar(80);
define v_Exterior,v_interior,v_codigopostal varchar(10);
define v_colonia,v_municipio,v_estado varchar(50);
define v_RFC varchar(13);
define v_curp varchar(18);
define v_carteraxcobar,v_codigo,v_cuentatot,v_tcta,v_cont,v_totparc int;
define v_leyenda,v_leyenda1,v_leyendaRECIBO varchar(255);
define v_tipo,v_subtipo varchar(50);
define v_fecha varchar(20);
define v_referencia,v_refper,v_refrec varchar(30); 
define v_inicio,v_parcial,v_final,v_total,v_acumulado,v_montotot,v_acumuladotot decimal(16,2);
define v_montoper,v_montorec,v_gastostmp,v_multatmp,v_imprecutmp,v_imprecrtmp decimal(16,2);
define v_datosvarios,v_descrbo,v_conceptodet,v_mensmerc,v_menspred,v_mensultima varchar(150);
define v_concepto,v_domicilio varchar(60);
define v_ref,v_iduser,v_contvarios,v_parci,v_parcf,v_id,v_cvevenc,v_idreferencia int;
define v_aini,v_mini,v_afin,v_mfin,v_statmerc,v_statpred,v_reccta,v_status,v_estultima int;
define v_ctarec,v_ctaint,v_ctagst,v_ctamul,v_ctarecurb,v_ctarecrus int;
define v_ur char(1);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -11, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE CONVENIOS DIVERSOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
 set debug file to "pago22";
 trace on;
  let v_r = 'N';
 
  select count(*) into v_ca from  tmp_totalesconv ;
  if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;

let v_contvarios=0;
let v_cont=0;

-- Asigna valor a fererencia a pagar
if trim(pref)='' then
   let v_ref=999;
else
   let v_ref=pref;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

if not exists (select * from tmp_totalesconv) then
   let v_status=1;
   let v_leyenda1='No existen adeudos para afectar';
   return v_status,v_leyenda1;
end if;

-- checa que exista el convenio
if not exists(select * from ta_17_conv_diverso a,ta_17_conv_d_resto b
   where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
   and a.numero_exp=pnum and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver) then
       return 1,'NO EXISTE CONVENIO';
end if;

-- obtiene el id resto
select b.id_conv_resto into v_id 
from ta_17_conv_diverso a,ta_17_conv_d_resto b
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver;

-- ejecuta el procedimeinto de encabezados
execute procedure admin_encabezados_22(pinterface,ptipo,psubt,plet,pnum,paxo,pseg) into
v_Nombrecompleto,v_calle,v_Exterior,v_interior,v_colonia,v_codigopostal,v_RFC,v_municipio,v_estado,
v_curp,v_carteraxcobar,v_leyenda,v_leyendaRECIBO,v_codigo;

-- ejecuta el procedimiento de datos varios
foreach
execute procedure admin_datos_varios_22(pinterface,ptipo,psubt,plet,pnum,paxo,pseg) into v_datosvarios
let v_contvarios=v_contvarios+1;
if v_contvarios = 1 then let v_tipo=v_datosvarios; 
else if v_contvarios = 2 then let v_subtipo=v_datosvarios;
else if v_contvarios = 3 then let v_fecha=v_datosvarios;
else if v_contvarios = 4 then let v_inicio=v_datosvarios;
else if v_contvarios = 5 then let v_parcial=v_datosvarios;
else if v_contvarios = 6 then let v_final=v_datosvarios;
else if v_contvarios = 7 then let v_total=v_datosvarios;
else let v_referencia=v_datosvarios;
end if; end if; end if; end if; end if; end if; end if; 
end foreach;

-- para sacar parcialidad minima
select  min(referencia) into v_parci from tmp_totalesconv; 
-- para sacar parcialidad maxima
select  max(referencia) into v_parcf from tmp_totalesconv;
-- para sacar el maximo de parcialidades de todo el convenio
select max(pago_parcial) into v_totparc from ta_17_adeudos_div where id_conv_resto=v_id;
-- obtiene el periodo de la primera parcialida
select axo_desde,mes_desde into v_aini,v_mini 
from ta_17_adeudos_div where id_conv_resto=v_id and pago_parcial=v_parci;
-- obtiene el periodo de la ultima parcialida
select axo_hasta,mes_hasta into v_afin,v_mfin 
from ta_17_adeudos_div where id_conv_resto=v_id and pago_parcial=v_parcf;

-- ejecuta el procedimiento de adeudo detalle
foreach
select acumulado into v_acumulado from tmp_totalesconv where referencia=v_parcf 
end foreach;
           
-- valida si el importe pagado es igual al importe adeudo 
if pimpcartera<>v_acumulado then
   return 2,'El importe cartera pagada es diferente al importe adeudo';
end if;

-- valida si el importe pagado mas redondeo es igual al importe pagado 
if (pimpcartera+pimpredondeo)<>pimppag then
   return 2,'El importe cartera pagada mas importe redondeo es diferente al importe pagado';
end if;

BEGIN WORK;
let v_r = 'S';
-- graba la operacion en recibos
let v_concepto='PAGO DE CONVENIO DIVERSOS '||trim(v_subtipo);
let v_descrbo='DATOS DEL CONVENIO '||trim(ptipo)||'-'||trim(psubt)||'-'||trim(plet)||'-'||
                                     trim(pnum)||'-'||paxo||'     ID CONV_RESTO '||v_id;
let v_domicilio=v_calle||' '||v_Exterior||' '||v_interior;
insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,
rfccolonia,obra,axofolio,id_usuario,fecha_act,descripcion,id_centro,foliorecibo) 
values(pfecha,precp,pcaja,pidcobro,pimppag,'P',17,v_id,0,'',v_parci,v_parcf,month(today),year(today),
v_Nombrecompleto,v_domicilio,v_concepto,plet,pnum,psubt,ptipo,paxo,v_iduser,current,v_descrbo,
pcentrop,pfolio);

foreach
select cuenta,descripcion,count(cuenta),sum(monto),sum(acumulado) 
into v_cuentatot,v_conceptodet,v_tcta,v_montotot,v_acumuladotot  
from tmp_totalesconv group by cuenta,descripcion order by cuenta

-- graba detalle de recibo
let v_cont=v_cont+1;
insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
values(pfecha,precp,pcaja,pidcobro,v_cont,v_conceptodet,v_cuentatot,v_montotot);
end foreach;

-- inserta el redondeo
if pimpredondeo<>0 then
   insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
   values(pfecha,precp,pcaja,pidcobro,v_cont+1,'REDONDEO',550800000,pimpredondeo);
end if;

-- afecta los periodos como pagados
select cuenta_recargos,cuenta_intereses into v_ctarec,v_ctaint from ta_17_subtipo_conv
where tipo=ptipo and subtipo=psubt; 

foreach
select referencia,sum(monto) into v_refper,v_montoper  
from tmp_totalesconv where cuenta not in(v_ctarec,v_ctaint)
group by referencia order by referencia

select referencia,nvl(monto,0) into v_refrec,v_montorec
from tmp_totalesconv where referencia=v_refper and cuenta=v_ctarec;
if v_montorec>0 then
   let v_cvevenc=2;
else
   let v_cvevenc=1;
end if;

-- inserta el pago a convenios diversos
insert into ta_17_conv_pagos(id_conv_pago,id_conv_resto,fecha_pago,oficina_pago,caja_pago,operacion_pago,
pago_parcial,total_parciales,importe_pago,importe_recargo,cve_venc,cve_descuento,cve_bonificacion,
id_usuario,fecha_actual) 
values(0,v_id,pfecha,precp,pcaja,pidcobro,v_refper,v_totparc,v_montoper,v_montorec,v_cvevenc,
null,null,v_iduser,current);
let v_status=0;
let v_leyenda1='PAGO APLICADO CORRECTAMENTE';

-- quitar los adeudos
update ta_17_adeudos_div set clave_pago='P' where id_conv_resto=v_id and pago_parcial=trim(v_refper);

-- para afectar el convenio como pagado si es la ultima parcialidad
if v_totparc=v_refper then
   execute procedure spd_17_ultimaparc(v_id,0,'P',puser,v_iduser) into v_estultima,v_mensultima;
   if v_estultima <> 0 then
      ROLLBACK WORK;
      return v_estultima,v_mensultima;
   end if; 
end if;
end foreach;

if ptipo=1 then
   select sum(monto) into v_gastostmp
   from tmp_totalesconv where cuenta=550610001;
   if v_gastostmp is null then
      let v_gastostmp=0;
   end if;
   select sum(monto) into v_multatmp
   from tmp_totalesconv where cuenta=515001001;
   if v_multatmp is null then
      let v_multatmp=0;
   end if;
   select sum(monto) into v_imprecutmp
   from tmp_totalesconv where cuenta=150100000;
   if v_imprecutmp is null then
      let v_imprecutmp=0;
   end if;
      select sum(monto) into v_imprecrtmp
   from tmp_totalesconv where cuenta=150200000;
   if v_imprecrtmp is null then
      let v_imprecrtmp=0;
   end if;

   -- obtiene la referencia de pago
   select  first 1 d.id_referencia into v_idreferencia  
   from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_referencia d
   where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
   and a.numero_exp=pnum and axo_exp=paxo
   and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
   and d.id_conv_resto=b.id_conv_resto;

   -- afecta los periodos en tablas de mercados y sus requerimientos
   let v_ur=substr(v_referencia,3,1);
   let v_reccta=substr(v_referencia,1,1); 
   execute procedure catastro_gdl:admin_inspred_22(v_idreferencia,precp,pcaja,pidcobro,pfecha,puser,pimppag,
   v_gastostmp,v_multatmp,v_imprecutmp,v_imprecrtmp,pimpredondeo,v_aini,v_mini,v_afin,v_mfin,
   v_ur,v_reccta,v_id) into v_statpred,v_menspred;
   if v_statpred <> 0 then
      ROLLBACK WORK;
      return v_statpred,v_menspred;
     
     end if;      
else
  if (ptipo=6) and (psubt=1) then

     -- obtiene la referencia
     select first 1 d.id_referencia into v_idreferencia  
     from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_referencia d
     where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
     and a.numero_exp=pnum and axo_exp=paxo
     and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
     and d.id_conv_resto=b.id_conv_resto;

     select c.cuenta_gastos into v_ctagst from ta_17_referencia a,ta_11_locales b,ta_11_mercados c
     where a.id_conv_resto=v_id and b.id_local=a.id_referencia and c.num_mercado_nvo=b.num_mercado; 
 
     select sum(monto) into v_gastostmp
     from tmp_totalesconv where cuenta=v_ctagst;
     if v_gastostmp is null then
        let v_gastostmp=0;
     end if;

     -- afecta los periodos en tablas de mercados y sus requerimientos
     foreach
     execute procedure cajero_afecmerconv(v_idreferencia,v_aini,v_mini,v_afin,v_mfin,
     pfecha,precp,pcaja,pidcobro,'CONV. '||trim(plet)||'/'||trim(pnum)||'/'||trim(paxo),
     v_iduser,'P',v_gastostmp) into v_statmerc,v_mensmerc
     if v_statmerc <= 0 then
        ROLLBACK WORK;
        return v_statmerc,v_mensmerc;
       
     end if;
     end foreach;
  end if;
end if;

-- borrar tabla temporal 
delete from tmp_totalesconv;
COMMIT WORK;

return v_status, v_leyenda1;
trace off;
end procedure;

CREATE PROCEDURE "informix".upd34_gade_01 ( par_id_34_datos Integer, par_Axo Integer, par_Mes Integer, par_Fecha Date, par_Id_Rec Integer, 
				par_Caja Char(2), par_Consec Integer, par_Folio_rcbo Char(15), par_tab Char(1), par_status Char(1), par_Opc Char(1) )
{######################################################################
#  Procedimiento:    upd34_gade_01
#  Descripcion:      Interfaz de actualizaciones a registros de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_Id_Cobro = Id 
#		     	par_Axo = a�o del periodo a actualizar
#		     	par_Mes = mes del periodo a actualizar
#                    		par_Fecha = Fecha del recibo
#                    		par_Id_Rec = recaudadora donde se realiza el pago(para nuevas solo en rec 2)
#                    		par_Caja = caja de pago
#                    		par_Consec = operacion de pago
#                    		par_Folio_rcbo = Folio del recibo
#                    		par_tab = rubro de ingreso
#                    		par_status = status de la operacion que deseas realizar
#                    		par_Opc = opcion de entrada de la operacion  A = operacion por cajero
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_id_usuario	int;

define v_id_34_stat, v_id_control				Integer;
define v_importe_gastos					Money(12,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion upd34_gade_01 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_leyenda    	= 'ALGO EXTRA�O PASO';
let v_estatus	= -1;

Let v_id_control = 0;
Let v_importe_gastos = 0;
--************************************************************************ STATUS
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = par_tab and cve_stat = par_status;
--************************************************************************

if par_Opc = 'A' then  -- entrada por cajero
	if par_status = 'P' then
		--BEGIN WORK;	
		UPDATE t34_pagos SET
			fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec,  caja = par_Caja,
			operacion = par_Consec,  folio_recibo = par_Folio_rcbo,  usuario = user,  id_stat = v_id_34_stat
		WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;

		FOREACH
			SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos
                      			FROM ta_15_apremios
                       			WHERE modulo = 34  AND control_otr = par_id_34_datos  AND vigencia = "1" AND clave_practicado = "P"
				if exists ( select * from ta_15_apremios where id_control = v_id_control ) then
					UPDATE ta_15_apremios SET
						fecha_pago = par_Fecha, recaudadora = par_Id_Rec,  caja = par_Caja,  
						operacion = par_Consec,  importe_pago = v_importe_gastos,  vigencia = '2'
						WHERE id_control = v_id_control;
				end if;
		END FOREACH;

         		let v_leyenda = 'Cajero - Pago aplicado correctamente';
         		let v_estatus  = 0;
		--COMMIT WORK; 
	else
		-- aqui insertar el guardar en el historico de movimientos
		--BEGIN WORK;	
		UPDATE t34_pagos SET
			fecha_hora_pago = Null,  id_recaudadora = Null,  caja = Null,
			operacion = Null,  folio_recibo = Null,  usuario = user,  id_stat = v_id_34_stat
		WHERE fecha_hora_pago = par_Fecha and id_recaudadora = par_Id_Rec and caja = par_Caja and operacion = par_Consec ;

		FOREACH
			SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos
                      			FROM ta_15_apremios
                       			WHERE modulo = 34  AND control_otr = par_id_34_datos  AND vigencia = "2" AND clave_practicado = "P"
				if exists ( select * from ta_15_apremios where id_control = v_id_control ) then
					UPDATE ta_15_apremios SET
						fecha_pago = Null, recaudadora = 0,  caja = ' ',  
						operacion = 0,  importe_pago = 0,  vigencia = '1'
                       					WHERE id_control = v_id_control;
				end if;


		END FOREACH;

         		let v_leyenda = 'Cajero - Cancelacion de recibo y reactivacion de folios aplicada correctamente';
         		let v_estatus  = 0;
		--COMMIT WORK; 
	end if;
else	
	if par_status = 'P' then
		--if exists( SELECT * FROM ta_12_recibos 
		--	WHERE fecha = par_Fecha AND id_rec = par_Id_Rec AND caja = par_Caja AND operacion = par_Consec ) then
		
			--BEGIN WORK;	
			UPDATE t34_pagos SET
				fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec,  caja = par_Caja,
				operacion = par_Consec,  folio_recibo = par_Folio_rcbo,  usuario = user,  id_stat = v_id_34_stat
				WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;

         			let v_leyenda = 'Modulo - Pago aplicado correctamente';
         			let v_estatus  = 0;
			--COMMIT WORK; 
		--else
         		--	let v_leyenda = 'Modulo - Pago no aplicado correctamente por no existir recibo';
         		--	let v_estatus  = -1;
		--end if;
	end if;
		--BEGIN WORK;	
		UPDATE t34_pagos SET
			fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec,  caja = par_Caja,
			operacion = par_Consec,  folio_recibo = par_Folio_rcbo,  usuario = user,  id_stat = v_id_34_stat
			WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;
		--COMMIT WORK; 
		if par_status = 'S' then
         			let v_leyenda = 'Modulo - Condonacion aplicada correctamente';
         			let v_estatus  = 0;
		end if;
		if par_status = 'C' then
         			let v_leyenda = 'Modulo - Cancelacion aplicada correctamente';
         			let v_estatus  = 0;
		end if;
		if par_status = 'R' then
         			let v_leyenda = 'Modulo - Prescripcion aplicada correctamente';
         			let v_estatus  = 0;
		end if;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "informix".fn_accexc( p_usr varchar(8))
returning smallint as repuesta;
define v_contar integer;

  select count(*) into v_contar from ta_autoriza where id_modulo = 45 and tag = 0 and
   id_usuario =  (select id_usuario  from ta_12_passwords where usuario = trim(p_usr));
   if v_contar = 1 then
     return v_contar ;
   else
     return 0;
   end if;
end procedure;

CREATE PROCEDURE "informix".con34_gcta_apl ( par_tabla Char(2), par_apl Char(1), par_tipo_oblig Char(1), par_abrev Char(20) )
{######################################################################
#  Procedimiento:    con34_GCta_apl
#  Descripcion:      Interfaz de consulta de cuentas de aplicacion para el cobro de OTRAS OBLIGACIONES
#
#  Parametros         par_Tabla     = Rubro de ingreso 
#  de entrada:         par_apl          = origen para la consulta L = Local E = Externo
#                             par_tipo_oblig   = Tipo de obligacion F = Forma, A = Apertura, T = Tarifa normal
#                             par_abrev  = Abreviatura del concepto para la aplicacion       DSCTO. MULTAS = DESCUENTO A MULTAS
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            18 Febrero 2014   
#
#  Llamado por:      Cualquiera que lo requiera
#  Llama a:          
#  
######################################################################}
                returning  integer,                         --            Cuenta de aplicacion
                               VarChar(100);                   --            Concepto de la cuenta

  define v_cta                                                                   Integer;
  define v_concepto                                                                     VarChar(100);

  Let v_cta = 0;
  Let v_concepto = '';

  SELECT cuenta, concepto INTO v_cta, v_concepto FROM t34_ctas_aplic
                WHERE cve_tab = par_tabla  AND aplicacion = par_apl
                AND tipo_oblig = par_tipo_oblig AND abrev = par_abrev;


RETURN v_cta, Trim(v_concepto);

end procedure;

CREATE PROCEDURE "informix".sp42_actualizo ( popc char(1) )
returning   int as estado,
            varchar(100) as mensaje;

define vestatus, vId_doctos, vId_doctos_x int;
define vseguim, vdocto_ant, vcero		int;
define vmensaje varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp42_actualizo ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

Let vestatus = 0;
Let vmensaje = 'TERMINO SATISFACTORIAMENTE';

FOREACH
	SELECT (a.id) id_seguimiento, (a.t42_doctos_id) id_docto_ant, NVL(b.id,0) id_documento
	INTO 	vseguim, vdocto_ant, vcero
	FROM t42_seguimiento a, outer t42_doctos b
	WHERE b.id = a.t42_doctos_id
	ORDER BY  b.id, a.id

		if vcero = 0 then
			SELECT C.t42_doctos_id INTO vId_doctos_x FROM t42_seguimiento C where C.id = vdocto_ant;

			UPDATE t42_seguimiento SET	t42_doctos_id = vId_doctos_x		WHERE id = vseguim;
		end if;

END FOREACH;

	return vestatus,vmensaje;

end procedure;

create procedure "informix".admin_terceros_pag(pinterface int,pseg1 char(10),pseg2 char(10),pseg3 varchar(10),
pseg4 varchar(10),pseg5 varchar(10),pseg6 varchar(10),pref varchar(20),pimppag money(14,2),
pimpcartera money(14,2),pimpredondeo money(14,2),pidcobro int,
pfolio varchar(10),pfecha date,precp int,pcentrop int,pcaja char(20),pnombreuser varchar(40),
puser char(8),pmodulo int,pmov int,pidentificador int,pforma char(10))

{######################################################################
#  Procedimiento:    admin_terceros_pag
#  Descripcion:      Interfaz de pago para afectacion de pagos a terceros solo para pagos
#                    dobles y en demasia para admin
#
#  Parametros        
#  de entrada:       pinterface = 28 numero de interfaz para afectacion de pagos a terceros(conciliacion)
#                    pseg1 = recaudadora cuenta y/� numero de licencia
#                    pseg2 = tipo de prediao (U � R)
#                    pseg3 = Numero de cuenta predial 
#                    pseg4 = numero de local
#                    pseg5 = letra del local
#                    pseg6 = bloque del local
#                    pref = siempre sera un espacio en blanco
#                    pimppag = importe total de pago doble � pago en demasia
#                    pimpcartera = siempre sera cero
#                    pimpredondeo = siempre sera cero
#                    pidcobro = numero de operacion,
#                    pfolio = folio de recibo ofical
#                    pfecha = fecha de pago
#                    precp = recaudadora de pago
#                    pcentrop = numero de centro de recaudacion
#                    pcaja = caja de pago
#                    pnombreuser = nombre del cajero
#                    puser = nombre del usuario
#                    pmodulo = Numero de interface para identificar el modulo a afectar
#                    pmov = tipo de movimiento valores 1= pago en demasia 2= pago doble
#                    pidentificador = identificador ya sea linea de captura � pagos varios
#                    pforma = forma de pago ejemplo: "LINEA", "VARIOS" e "INTERNET"
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            18 diciembre 2013   
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}


returning   int as status, 
            varchar(150) as mensaje;

define v_status int;
define v_leyenda varchar(150);
define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define parhora datetime hour to minute;
--
define parId_regmodulo integer;     -- cuenta o licencia
define parId_rec_cta 	smallint;   -- reca cuenta  , licencias nada
define parRegmunur	char(1); -- urbrus , licencias nada

define parNombre 	varchar(60);  
define parDomicilio 	varchar(60); 
define parConcepto 	varchar(60);
define parcveconcepto int;
define parRfcnumero  	integer; -- cvecuenta o idlicecnias
define  parctaaplic  int;
define continuar char(1);
define spoperacion int;
define varcvepago int;
define parcvecuenta int;
define parrecaudbco,v_iduser int;
define parfechabco date;
define v_usuario char(10);
define v_linea char(28);
define v_estatus int;
define v_mensaje varchar(200);
define v_id_control int;
define v_importe money(16,2);
define v_sucursal,v_cajero,v_operacion,v_perdes,v_perhas int; 
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
  if v_r = 'S' then
     ROLLBACK WORK;
  end if;
  if  v_lError = -236   THEN
      RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;

let v_r = 'N';
let spoperacion = 0;
let continuar = 'N';
let parrecaudbco=0;
let parfechabco=null;
let v_linea='';
let v_status=0;
let v_leyenda='PAGO APLICADO CORRECTAMENTE';

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario,usuario into v_iduser,v_usuario from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
   let v_usuario='ADMIN';
end if;

if pmodulo=8 then -- predial
   select cvecuenta into parcvecuenta from catastro_gdl:convcta 
   where recaud=trim(pseg1) and urbrus=trim(pseg2) and cuenta=trim(pseg3);

   select nombre_completo , u_calle || u_noexterior, cvecuenta , recaud, urbrus,cuenta  ,  extend(current, hour to minute)
   into parNombre , parDomicilio , parRfcnumero , parId_rec_cta, parRegmunur, parId_regmodulo , parhora
   from catastro_gdl:datos_gral where cvecuenta = parcvecuenta;

   if pmov=1 then -- diferencia a favor de contribuyente (pago en demasia)
      let continuar = 'S';
      let parConcepto = 'PAGO EN DEMASIA DE IMPUESTO PREDIAL ';
      let parcveconcepto = 39;
      let parctaaplic  = 999900006;   
   end if;
   if pmov = 2 then -- pago doble
      let continuar = 'S';
      let parConcepto = 'PAGO DOBLE DE IMPUESTO PREDIAL';
      let parcveconcepto = 26;
      let parctaaplic  = 999900015;
   end if;
   if pmov = 3 then -- partida transitoria
      let continuar = 'S';
      let parConcepto = 'PARTIDA TRANSITORIA EN ACLARACION DE PREDIAL';
      let parcveconcepto = 40;
      let parctaaplic  = 990200004;
   end if;
end if;

if pmodulo = 12 then -- licencias
   select propietario , ubicacion || numext_ubic, id_licencia , 0, '',licencia ,  extend(current, hour to minute)
   into parNombre , parDomicilio , parRfcnumero, parId_rec_cta, parRegmunur, parId_regmodulo , parhora
   from catastro_gdl:licencias where licencia = trim(pseg1);
   if pmov = 1 then -- diferencia a favor de contribuyente (pago en demasia)
      let continuar = 'S';
      let parConcepto = 'PAGO EN DEMASIA DE LICENCIA DE GIRO';
      let parcveconcepto = 41;
      let parctaaplic  = 999900006;
   end if;
   if pmov = 2 then -- pago doble
      let continuar = 'S';
      let parConcepto = 'PAGO DOBLE DE LICENCIA DE GIRO';
      let parcveconcepto = 28;
      let parctaaplic  = 999900015;
   end if;
   if pmov = 3 then -- pago transitoria
      let continuar = 'S';
      let parConcepto = 'PARTIDA TRANSITORIA DE LICENCIA DE GIRO';
      let parcveconcepto = 42;
      let parctaaplic  = 990200004;
   end if;
end if;

if continuar = 'S' then
   if trim(pforma)='LINEA' then
      select recaud,fecha_pagobco,linea into parrecaudbco,parfechabco,v_linea 
        from linea_pagos WHERE estatus="N" and id=pidentificador;
   end if;
   if trim(pforma)='VARIOS' then
      select b.recaud,a.fecha_pagobco,a.id_control,a.importe,a.sucursal,a.cajero,a.operacion,a.perdes,a.perhas  
        into parrecaudbco,parfechabco,v_id_control,v_importe,v_sucursal,v_cajero,v_operacion,v_perdes,v_perhas 
        from catastro_gdl:BCO_CARGA1 a,catastro_gdl:bco_control b
       WHERE a.ESTATUS="N" and a.id_carga=pidentificador and b.id_control=a.id_control;
   end if;
   BEGIN WORK;
   let v_r = 'S';
   insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
     		id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,
     		rfcini,rfcnumero,rfccolonia,obra,axofolio,id_usuario,fecha_act,descripcion,
            lugar_pago,fec_pagobco,id_centro,foliorecibo) 
     values(pfecha,precp,pcaja,pidcobro,pimppag,'P',12,parId_regmodulo,
    		parId_rec_cta,parRegmunur,month(today),year(today),month(today),year(today),parNombre, 
            parDomicilio,parConcepto,'',parRfcnumero,pmov,0,0,v_iduser,current,'',
            parrecaudbco,parfechabco,pcentrop,pfolio);

   insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
          values(0, parRfcnumero , precp, pcaja, pidcobro, pfecha, parhora , pimppag, v_usuario, null, parcveconcepto);
   let varcvepago = dbinfo("sqlca.sqlerrd1"); 
              
   insert into ta_12_recibosdet values(pfecha,precp,pcaja,pidcobro,1,parConcepto,parctaaplic,pimppag);

   if (trim(pforma)='LINEA') and (pmov=2) then
      execute procedure linea_pago(v_linea,parrecaudbco,parfechabco,pimppag,varcvepago,
                        pfecha,precp,pcaja,pidcobro,v_usuario) into v_estatus,v_mensaje;
      if (v_estatus <> 0) and (v_estatus <>3) and (v_estatus <>4) then
         let v_status=v_estatus;
         let v_leyenda=v_mensaje;
         ROLLBACK WORK;
      end if;         
   end if;
   if (trim(pforma)='VARIOS') and (pmov=2) then
      execute procedure catastro_gdl:caj_aplicabancos(pidentificador,v_id_control,parRfcnumero,varcvepago,
                        parId_rec_cta,parRegmunur,parId_regmodulo,pfecha,precp,pcaja,pidcobro,pimppag,v_iduser,
                        v_usuario,parfechabco,v_importe,v_sucursal,v_cajero,v_operacion,
                        v_perdes,v_perhas) into v_estatus,v_mensaje;
      if v_estatus <> 0 then
         let v_status=v_estatus;
         let v_leyenda=v_mensaje;
         ROLLBACK WORK;
      end if;
   end if;
   if (trim(pforma)='INTERNET') and (pmov=2) then
      update catastro_gdl:lic_pago_alt set cvepago = varcvepago
             where licencia = pidentificador and cvepago = 0 and (year(fecha_registro)=year(today));
   end if;
    let v_status=0;
    let v_leyenda='PAGO APLICADO CORRECTAMENTE';
   COMMIT WORK;
end if;     
return v_status,v_leyenda;
end procedure;

create procedure "informix".desgopercompacum(p_fecini date, p_fecfin date, modulo int) 
    RETURNING int as id , char(30) as descripcion,  int as operactual, money(16,2) as impactual, 
             int as operantes,  money(16,2) as impantes,  int as operdif,  money(16,2) as impdif ;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_operantes int;
define  v_operactual int;
define  v_operdif int ;
define  v_impantes money(16,2);
 define v_impactual money(16,2); 
 define v_impdif money(16,2);
define  v_importe money(16,2);
define v_fechatime datetime year to fraction(3) ;
define feciniant date; define fecfinant date;
define axo_actual int;
define axo_antes int;
define v_cuenta int;
define dia  int;
define mes int;
define v_dia_fin_act date;
define v_dia_ini_act date;
define v_cero int;

let dia = day(p_fecini);
let mes = month(p_fecini);
let axo_antes = year(p_fecini) - 1;
 if  p_fecini > mdy(6,30,2014) then
    let v_cero = 1;
    let v_dia_ini_act = mdy(6,30,2014);
 else
    let v_cero = 0;
    let v_dia_ini_act = p_fecini ;
 end if;
  if  p_fecfin > mdy(6,30,2014) then
    let v_dia_fin_act = mdy(6,30,2014);
 else
    let v_dia_fin_act = p_fecfin ;
 end if;

let feciniant = mdy(mes,dia,axo_antes);
let dia = day(p_fecfin);
let mes = month(p_fecfin);
let axo_antes = year(p_fecfin) - 1;

let fecfinant = mdy(mes,dia,axo_antes);

     foreach 
     select  x3.cta_aplicacion , x3.descripcion , nvl(antes.operantes,0) , nvl(actual.operactual,0),
     (nvl(actual.operactual,0) - nvl(antes.operantes,0)) DifOper ,
     nvl(antes.impantes,0) , nvl(actual.impactual,0) , (nvl(actual.impactual,0) - nvl(antes.impantes,0)) difimpor
     into  v_cuenta , v_descripcion, v_operantes , v_operactual , v_operdif, v_impantes , v_impactual , v_impdif 
     from cg_12_cuentas x3 ,
     outer 
    ( select an.cuenta ctaantes, count(an.operacion) operantes, sum(an.importe) impantes 
      from ta_12_recibosdet an , ta_12_recibos x1 
      where an.fecha between feciniant and fecfinant  and
         x1.id_modulo = 12 and x1.cvepago = 'P' and
         an.fecha = x1.fecha and
         an.caja  = x1.caja  and
         an.id_rec = x1.id_rec and
         an.operacion = x1.operacion and x1.importe <> 0  group by 1 )  antes , 
     outer
    ( select ac.cuenta ctaactual , count(ac.operacion) operactual, sum(ac.importe) impactual 
      from ta_12_recibosdet ac , ta_12_recibos x2 
      where ac.fecha between v_dia_ini_act and v_dia_fin_act  and
         x2.id_modulo = 12 and x2.cvepago = 'P' and
         ac.fecha = x2.fecha and
         ac.caja  = x2.caja  and
         ac.id_rec = x2.id_rec and
         ac.operacion = x2.operacion and x2.importe <> 0  group by 1 )  actual 

     where x3.cta_aplicacion = antes.ctaantes and x3.cta_aplicacion = actual.ctaactual 
          order by 7 desc, 6 desc
  if v_cero = 1 then
     let v_operactual = 0 ; let v_impactual = 0; let v_operdif = 0; let  v_impdif = 0;
  end if;
    if ( v_impantes <> 0 )or ( v_impactual <> 0) then
     return  v_cuenta , v_descripcion , v_operactual, v_impactual , v_operantes , v_impantes ,   v_operdif,  v_impdif   with resume;
     end if;
    end foreach    ;
 
end procedure;

CREATE PROCEDURE "informix".admin_datos_varios_14(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10))
               returning  varchar(150) as sdato_vario;

define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_tipo CHAR(10);
define  v_vigencia CHAR(1);
define  v_reg_cem varchar(100);
define  v_nomcem VARCHAR(60);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);

let v_axo=year(today);
let v_mes=month(today);
let v_control= p_segmento1;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   return ' '; 
end if;      

select cementerio, cementerio ||' '|| clase||' '||clase_alfa ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
axo_pagado, metros, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ' '
end, vigencia
into v_cementerio,v_reg_cem,
v_axo_pagado, v_metros,v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa,v_tipo,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

select  nombre into v_nomcem
from tc_13_cementerios where cementerio=v_cementerio;

--if v_axo_pagado=v_axo  then
--   return ' '; 
--end if;  
   
if v_vigencia='B'  then
   return ' '; 
end if;     
--foreach
return v_nomcem  with resume;
return v_reg_cem with resume; 
 return v_metros  with resume; 
 return v_tipo with resume; 
  return v_clase    with resume; 
  return v_seccion  with resume; 
 return v_linea    with resume; 
 return v_fosa || v_falfa  with resume; 
--end foreach; 
end procedure;

create procedure "informix".admin_datos_varios_22(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10))

returning   varchar(150) as datovario;

define  v_tipo,v_subtipo varchar(50);
define  v_fecha varchar(20);
define  v_referencia,v_periodo varchar(30); 
define  v_inicio,v_parcial,v_final,v_total decimal(16,2);
define  v_modulo,v_idresto,v_parc,v_cont,v_resto integer; 

let v_periodo='';
let v_parc=0;
let v_idresto=0;
let v_cont=0;
let v_resto=0;

foreach
select nvl(d.descripcion,' '),nvl(e.desc_subtipo,' '),TO_CHAR(nvl(b.fecha_inicio,mdy(01,01,1990)),'%d%m%Y'),
nvl(b.cantidad_inicio,0),nvl(b.pago_parcial,0),nvl(b.pago_final,0),nvl(b.cantidad_total,0),
f.referencia,f.modulo,b.id_conv_resto
into v_tipo,v_subtipo,v_fecha,v_inicio,v_parcial,v_final,v_total,v_referencia,v_modulo,v_idresto
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_tipos d,ta_17_subtipo_conv e,
outer ta_17_referencia f
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet 
and a.numero_exp=pnum and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.tipo=a.tipo and e.tipo=a.tipo and e.subtipo=a.subtipo and f.id_conv_resto=b.id_conv_resto

if v_referencia is null then
   let v_referencia='';
end if;
if v_modulo is null then
   let v_modulo=0;
end if;

if (ptipo=3) and (psubt=1) then
   if v_modulo<>10 then
      return v_tipo with resume;
      return v_subtipo with resume;
      return v_fecha with resume;
      return v_inicio with resume;
      return v_parcial with resume;
      return v_final with resume;
      return v_total with resume; 
      return v_referencia with resume;
   end if;
else
   return v_tipo with resume;
   return v_subtipo with resume;
   return v_fecha with resume;
   return v_inicio with resume;
   return v_parcial with resume;
   return v_final with resume;
   return v_total with resume; 
   return v_referencia with resume;
end if;
end foreach;

foreach
select pago_parcial,
(case when axo_desde>0 then (lpad(mes_desde,2,'0')||'/'||axo_desde||' al '||lpad(mes_hasta,2,'0')||'/'||axo_hasta)
else '' end) into v_parc,v_periodo 
from ta_17_adeudos_div
where id_conv_resto=v_idresto and (clave_pago<>'P' or clave_pago is null)
let v_cont=v_cont+1;
return v_periodo with resume;
end foreach;

for v_resto=1 to (18-v_cont)
return '' with resume;
end for

end procedure;

create procedure "informix".sp_pub_ade_men(  ) 
returning   int as v_numesta , varchar(100) as nombre , char(2) as  categoria , varchar(80) as descripcion ,
   char(1) as sector , varchar(10) as  sectornom,  varchar(100) as calle ,
 varchar(10) as numext , int as Cajones , int as axo_adeudo , int as mes_ini_adeudo , 
 money(14,2)as adeudo_anterior , money(14,2) as adeudo_vencido , money(14,2) as adeudo_recargos ;  
 --money(12,2) as adeudo_act ;

define  v_id  int;
define  v_categoria_id int; 
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_numesta int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_nombre varchar(100);
 
define v_calle varchar(80);
define v_numext varchar(10);
define v_cupo int;
define v_axo_adeudo int;
define v_mes_ini_adeudo int; 
define  v_adeudo_anterior money(14,2);
 define v_adeudo_vencido money(14,2);
define v_adeudo_recargos money(14,2);

--set debug file to 'pub.log';
--trace on;

foreach 
  select  a.id, 
     a.pubcategoria_id ,
     b.categoria,
     b.descripcion,
     a.numesta ,
     a.sector, 
    case when sector = 'J' then 'JUAREZ'  when sector = 'H' then 'HIDALGO'
     when sector = 'L' then 'LIBERTAD'  when sector = 'R' then 'REFORMA' else 'S/N' end ,
    trim(a.nombre) ,
    trim(a.calle) ,
    trim(a.numext) ,
    a.cupo, 
    (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ,
    (select min(d.mes) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10
     and axo = (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ) ,
 
    dbestacion:fn_pub_ade_ant(a.id) ,
    dbestacion:fn_pub_ade_act1( a.id )  ,
    dbestacion:fn_pub_recargos(2 , a.id, year(today) , month(today) )
  into 
  v_id ,
  v_categoria_id ,
  v_categoria ,
  v_descripcion ,
  v_numesta ,
  v_sector , 
  v_sectornom,
  v_nombre ,
  v_calle ,
  v_numext ,
   v_cupo ,
  v_axo_adeudo ,
  v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos
   from dbestacion:pubmain a, dbestacion:pubcategoria b 
    where  b.id =  a.pubcategoria_id and a.movto_cve <> 'C'  and (fn_pub_ade_ant(a.id) + fn_pub_ade_act1( a.id ) ) > 0


return   v_numesta , v_nombre , v_categoria , v_descripcion ,  v_sector , v_sectornom ,
  v_calle , v_numext , v_cupo , v_axo_adeudo , v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos with resume;

end foreach;
--trace off;
end procedure;

create procedure "informix".fn_pub_ade_act1( p_contrato_id int ) 
returning  money(12,2) as adeudo_act ;
 define v_adeudo money(12,2)     ;
select sum(c.ade_importe) into v_adeudo from dbestacion:pubadeudo c 
 where c.pubmain_id = p_contrato_id and c.axo = year(today) and
 (c.axo * 100) + c.mes <= ((year(today) * 100) + month(today)-1) ;


 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_pub_ade_ant( p_contrato_id int ) 
returning  money(12,2) as adeudo ;
 define v_adeudo money(12,2)     ;

 select sum(c.ade_importe)  into v_adeudo  from dbestacion:pubadeudo c
 where c.pubmain_id = p_contrato_id and axo < year(today);

 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_pub_recargos(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning    money(10,2) as recargos;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define tot_recgos money(10,2);
let tot_recgos = 0;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;
  FOREACH
  select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
   into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
  from dbestacion:pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,2,3
   if v_tipo = 10 then
   select sum(porcentaje_mes) into v_porcentaje from dbestacion:recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_recargos is null then
       let v_recargos = 0;
    end if;
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
 let tot_recgos = tot_recgos + v_recargos;

end foreach;

return  tot_recgos ;
end procedure;

create procedure "informix".fn_exc_axomin( p_contrato_id int ) 
returning  int as axomin ;
 define v_axomin int     ;
   select min(axo) into v_axomin from  dbestacion:ex_adeudo  where ex_contrato_id = p_contrato_id and tipo = 20; 
--if v_axomin is null then
--  let v_axomin = year(today) +1;
-- end if;
 return v_axomin ;
END PROCEDURE;

create procedure "informix".fn_exc_mesmin( p_contrato_id int ) 
returning  int as mesmin ;
 define v_mesmin int     ;

  select min(mes) into v_mesmin from dbestacion:ex_adeudo where ex_contrato_id = p_contrato_id and tipo = 20
     and axo = fn_exc_axomin(p_contrato_id);
 
-- if v_mesmin is null then
--    let v_mesmin = 1;
--end if;
 return v_mesmin ;
END PROCEDURE;

create procedure "informix".fn_exc_ade_act1( p_contrato_id int ) 
returning  money(12,2) as adeudo_act ;
 define v_adeudo money(12,2)     ;
 select sum(ade_importe) into v_adeudo from dbestacion:ex_adeudo 
  where ex_contrato_id = p_contrato_id and axo = year(today) 
 and (axo * 100) + mes <= (year(today) * 100) + (month(today)-1) ;
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_exc_ade_ant( p_contrato_id int ) 
returning  money(12,2) as adeudo ;
 define v_adeudo money(12,2)     ;
 select sum(ade_importe) into v_adeudo from dbestacion:ex_adeudo  where ex_contrato_id = p_contrato_id and axo < year(today);
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_exc_calcrecgos_ref( p_contrato_id int , p_axof int , p_mesf int ) 
returning  money(12,2) as recargo ;
 define v_adeudo money(12,2)     ;
define v_calcrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2);
 define per_recgos int;

define axovig int ;
define mesvig int ; define diavig  int;
define v_fecha_limite date;
--set debug file to 'exreca.log';
--trace on;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_calcrec = 1;
-- select fecha_descuento  from db_ingresos:ta_11_fecha_desc where mes = month(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
 if mesvig < 3 then
   let axovig = axovig -1;
   let mesvig = 12;
 else
   if (v_fecha_limite ) > today then
      let mesvig = mesvig -1;
   end if;
 end if;
let per_recgos =  (axovig *100 )+mesvig;

 select  ade_importe into v_adeudo from dbestacion:ex_adeudo 
  where ex_contrato_id = p_contrato_id and axo  = p_axof and  mes = p_mesf and tipo in ( 26 , 27)  ;
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 select porcentaje into v_porc_recgos from dbestacion:ex_descrec where ex_contrato_id = p_contrato_id
    and ((p_axof * 100)+p_mesf) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
  select sum(porcentaje_mes) into v_porcentaje from dbestacion:recargos
     where (axo * 100 + mes) between  ((p_axof * 100)+p_mesf) and per_recgos;
          
      if v_calcrec = 0 then
      let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       let  v_recargos =   v_recargos - v_descto_recgos;

  end if;

 return v_recargos ;

--trace off;
END PROCEDURE;

create procedure "informix".fn_exc_recargos(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning    money(10,2) as recargos;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);
define v_totrecgos money(10,2);
define v_id_adeudo int;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

let v_totrecgos = 0;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from dbestacion:ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
  
  FOREACH
  select case when tipo <> 20 then axo || '00' else axo || lpad(mes,2,'0') end ,tipo , Axo, mes, (axo  * 100 )+ mes , 
    concepto, ade_importe , id 
   into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo , v_id_adeudo
  from dbestacion:ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,3,4
   select porcentaje into v_porc_recgos from dbestacion:ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
  
 if v_tipo = 20 then
   select sum(porcentaje_mes) into v_porcentaje from dbestacion:recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
          
      if v_calrec = 0 then
     let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
   if (v_tipo = 26) or (v_tipo = 27) then
     execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
     let v_recargos =   v_recargos + v_recgos_ref;
   end if;

 let v_totrecgos =  v_totrecgos + v_recargos ;
end foreach;

return  v_totrecgos ;
end procedure;

create procedure "informix".sp_exc_ade_men( v int) 
returning   int as no_exclusivo , varchar(80) as propiestario ,
   varchar(100) as domicilio , varchar(30)  as colonia , char(2) as Zona , decimal(6,2) as Total_bateria , decimal(6,2) as Total_Cordon,
  decimal(5,2) as Factor , varchar(50) as Clasificacion , 
  int as axo_adeudo , int as mes_ini_adeudo , 
 money(14,2)as adeudo_anterior , money(14,2) as adeudo_vencido , money(14,2) as adeudo_recargos ;  


define  v_id  int;
define  v_categoria_id int; 
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_no_exclusivo int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_propietario varchar(100);
 
define v_domicilio varchar(80);
define v_colonia varchar(20);
define v_zona char(2) ;
define v_total_bateria decimal(6,2) ; 
define v_total_cordon decimal(6,2) ; 
define  v_factor  decimal(5,2) ; 
define  v_clasificacion varchar(50);
define v_cupo int;
define v_axo_adeudo int;
define v_mes_ini_adeudo int; 
define  v_adeudo_anterior money(14,2);
 define v_adeudo_vencido money(14,2);
define v_adeudo_recargos money(14,2);



foreach 
select a.no_exclusivo , b.propietario, b.domicilio , b.colonia , a.zona, a.total_bateria, a.total_cordon, a.factor 
, c.concepto ,
fn_exc_axomin(a.id) , fn_exc_mesmin(a.id)  , 
fn_exc_ade_ant(a.id) ,
fn_exc_ade_act1(a.id)  
,fn_exc_recargos(2 , a.id , year(today) , month(today)) 
into 
 v_no_exclusivo , v_propietario, v_domicilio , v_colonia , v_zona, v_total_bateria, v_total_cordon, v_factor 
, v_clasificacion ,v_axo_adeudo ,
  v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos
from dbestacion:ex_contrato a, dbestacion:ex_propietario b , dbestacion:ex_clasificacion c 
where  a.ex_propietario_id  = b.id
and a.estatus <> 'C' and a.id_clasificacion in ( 1,3 ) and c.id = a.id_clasificacion
and (fn_exc_ade_ant(a.id) + fn_exc_ade_act1(a.id)) > 0 



return    v_no_exclusivo , v_propietario, v_domicilio , v_colonia , v_zona, v_total_bateria, v_total_cordon, v_factor 
, v_clasificacion , v_axo_adeudo ,  v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos with resume;

end foreach;
--return 0 , 'Fin archivo', '' , '' ,'', 0, 0, 0, '' , 0 ,  0 ,   0 , 0 , 0;
end procedure;

CREATE PROCEDURE "informix".fecha_letras(p_fecha date,p_formato integer)
{######################################################################
#  Procedimiento:    fecha_letras
#  Descripcion:      Convierte una fecha a letras con diferentes formatos
#
#  Parametros        p_fecha     = fecha a convertir
#  de entrada:       p_formato   = 1 formato normal ( 1 DE ENERO DE 2014)
                                   2 FORMATO CORTO  ( 1 DE ENE DE 2014)
# 
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            05 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_adeudos_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
varchar(50) as fecha;
-----------Define las variables de retorno----------------
define v_dia integer;
define v_mes integer;
define v_axo integer;
define v_meslet varchar(15);
----------------------------------------------------------
LET v_dia = day(p_fecha);
LET v_mes = month(p_fecha);
LET v_axo = year(p_fecha);

if p_formato = 1 then
   if v_mes = 1  then let v_meslet = ' ENERO ';      end if;
   if v_mes = 2  then let v_meslet = ' FEBRERO ';    end if;
   if v_mes = 3  then let v_meslet = ' MARZO ';      end if;
   if v_mes = 4  then let v_meslet = ' ABRIL ';      end if;
   if v_mes = 5  then let v_meslet = ' MAYO ';       end if;
   if v_mes = 6  then let v_meslet = ' JUNIO ';      end if;
   if v_mes = 7  then let v_meslet = ' JULIO ';      end if;
   if v_mes = 8  then let v_meslet = ' AGOSTO ';     end if;
   if v_mes = 9  then let v_meslet = ' SEPTIEMBRE '; end if;
   if v_mes = 10 then let v_meslet = ' OCTUBRE ';    end if;
   if v_mes = 11 then let v_meslet = ' NOVIEMBRE ';  end if;
   if v_mes = 12 then let v_meslet = ' DICIEMBRE ';  end if;
end if;

if p_formato = 2 then
   if v_mes = 1  then let v_meslet = ' ENE '; end if;
   if v_mes = 2  then let v_meslet = ' FEB '; end if;
   if v_mes = 3  then let v_meslet = ' MAR '; end if;
   if v_mes = 4  then let v_meslet = ' ABR '; end if;
   if v_mes = 5  then let v_meslet = ' MAY '; end if;
   if v_mes = 6  then let v_meslet = ' JUN '; end if;
   if v_mes = 7  then let v_meslet = ' JUL '; end if;
   if v_mes = 8  then let v_meslet = ' AGO '; end if;
   if v_mes = 9  then let v_meslet = ' SEP '; end if;
   if v_mes = 10 then let v_meslet = ' OCT '; end if;
   if v_mes = 11 then let v_meslet = ' NOV '; end if;
   if v_mes = 12 then let v_meslet = ' DIC '; end if;
end if;

return v_dia || ' DE'||v_meslet||'DE '||v_axo;

end procedure;

CREATE PROCEDURE "informix".sp42_consulta (plet varchar(30),pid_centro int,pnum int,paxo int,pid int)
returning       integer as idcentro,
                varchar(150) as titular,
                varchar(10) as abreviatura,
                varchar(100) as correo,
                varchar(100) as centro,
                integer as idcontrol,
                integer as ejercicio,
                integer as numero,
                integer as documento,
                varchar(50) as nomdocumento,
                varchar(50) as nombregenerico,
                date as fechadocto,
                datetime year to second as fecharegistro,
                datetime year to second as fechalimite,
                char(1) as tipocontrol,
               integer as respuesta,
                integer as estado,
                varchar(50) as nomestado,
                integer as prioridad,
                varchar(50) as nomprioridad,
                references text as texto,
                varchar(10) as usuario,
                datetime year to second as actual,
                integer as status,
                varchar(100) as mensaje;

define v_idcentro,v_idcontrol,v_ejercicio,v_numero,v_documento,v_status,v_prioridad,
       v_estado,v_respuesta int;
define v_titular varchar(150);
define v_abreviatura,v_usuario varchar(10); 
define v_correo,v_centro,v_mensaje varchar(100);
define v_nomdocumento,v_nombregenerico,v_nomestado,v_nomprioridad varchar(50);
define v_fechadocto date;
define v_fecharegistro,v_fechalimite datetime year to second;
define v_tipocontrol char(1);
define v_texto references text;
define v_actual datetime year to second;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

let v_idcentro='';
let v_idcontrol='';
let v_ejercicio='';
let v_numero='';
let v_documento='';
let v_status='';
let v_prioridad='';
let v_estado='';
let v_respuesta='';

let v_titular = '';
let v_abreviatura = '';
let v_usuario = '';
let v_actual = current;
let v_nomdocumento='';
let v_nombregenerico='';
let v_nomestado='';
let v_nomprioridad='';
let v_texto=null;
let v_tipocontrol='';

let v_correo='';
let v_centro='';
let v_mensaje='';

let v_fechadocto=null;
let v_fecharegistro=null;
let v_fechalimite=null;

if pid>0 then

    select d.id,d.ejercicico,d.numero,d.t42_tipodocs_id,
                (select descripcion from t42_tipodocs where id=d.t42_tipodocs_id) Tipo_Documento,
                d.nombre_generico,d.fec_docto,d.fec_rgs,d.fec_limite,d.tipo_control,d.t42_control_id_resp,d.t42_status_id,
                (select descripcion from t42_status where id=d.t42_status_id) Status,d.t42_prioridad_id,
                (select descripcion from t42_prioridad where id=d.t42_status_id) Prioridad, d.texto, d.usuario_mov, d.fec_mov, t42_centros_id
    into v_idcontrol, v_ejercicio, v_numero, v_documento, v_nomdocumento,
                v_nombregenerico, v_fechadocto, v_fecharegistro, v_fechalimite, v_tipocontrol, v_respuesta, v_estado,
                v_nomestado, v_prioridad, v_nomprioridad, v_texto, v_usuario, v_actual, v_idcentro
    from t42_control d
    where d.id = pid;  -- BUSQUEDA DE DOCUMENTO

                select b.nombre into v_centro   from t42_centros b  where b.id = v_idcentro;  -- BUSQUEDA DE CENTRO

                               select (trim(a.a_paterno)||' '||trim(a.a_materno)||' '||trim(a.nombres)) Titular, a.abreviatura, a.e_mail   into v_titular,v_abreviatura,v_correo  -- BUSQUEDA DEL TITULAR DEL CENTRO
                               from t42_personas a  where a.t42_centros_id = v_idcentro;

   if v_idcontrol is null then
                return v_idcentro,v_titular,v_abreviatura,v_correo,v_centro,0,0,0,0,'','',null,null,null,'',
                0,0,'',0,'',v_texto,'',null,0,'NO EXISTE EL OFICIO CAPTURADO';
   else
                               return v_idcentro,v_titular,v_abreviatura,v_correo,v_centro,v_idcontrol,v_ejercicio,v_numero,v_documento,
                                v_nomdocumento,v_nombregenerico,v_fechadocto,v_fecharegistro,v_fechalimite,v_tipocontrol,v_respuesta,
                               v_estado,v_nomestado,v_prioridad,v_nomprioridad,v_texto,v_usuario,v_actual,1,'OFICIO CAPTURADO';
   end if;
else
    foreach
    select d.id,d.ejercicico,d.numero,d.t42_tipodocs_id,
                (select descripcion from t42_tipodocs where id=d.t42_tipodocs_id) Tipo_Documento,
                d.nombre_generico,d.fec_docto,d.fec_rgs,d.fec_limite,d.tipo_control,d.t42_control_id_resp,d.t42_status_id,
                (select descripcion from t42_status where id=d.t42_status_id) Status,d.t42_prioridad_id,
                (select descripcion from t42_prioridad where id=d.t42_status_id) Prioridad, d.texto, d.usuario_mov, d.fec_mov
    into v_idcontrol, v_ejercicio, v_numero, v_documento, v_nomdocumento,
                v_nombregenerico, v_fechadocto, v_fecharegistro, v_fechalimite, v_tipocontrol, v_respuesta, v_estado,
                v_nomestado, v_prioridad, v_nomprioridad, v_texto, v_usuario, v_actual
    from t42_control d
    where d.ejercicico = paxo and d.t42_centros_id = pid_centro and d.nombre_generico = plet  -- BUSQUEDA DE DOCUMENTO
    end foreach;

                select b.id, b.nombre into v_idcentro, v_centro   from t42_centros b  where b.id = pid_centro;  -- BUSQUEDA DE CENTRO

                               select (trim(a.a_paterno)||' '||trim(a.a_materno)||' '||trim(a.nombres)) Titular, a.abreviatura, a.e_mail   into v_titular,v_abreviatura,v_correo  -- BUSQUEDA DEL TITULAR DEL CENTRO
                               from t42_personas a  where a.t42_centros_id = pid_centro;

   if v_idcontrol is null then
                return v_idcentro,v_titular,v_abreviatura,v_correo,v_centro,0,0,0,0,'','',null,null,null,'',
                0,0,'',0,'',v_texto,'',null,0,'NO EXISTE EL OFICIO CAPTURADO';
   else
                if v_idcentro is null then
                               return 0,'','','','',0,0,0,0,'','',null,null,null,'',0,0,'',0,'',v_texto,'',null,-1,'NO EXISTE UNIDAD RESPONSABLE (DEPENDENCIA)';
                else
                               return v_idcentro,v_titular,v_abreviatura,v_correo,v_centro,v_idcontrol,v_ejercicio,v_numero,v_documento,
                                v_nomdocumento,v_nombregenerico,v_fechadocto,v_fecharegistro,v_fechalimite,v_tipocontrol,v_respuesta,
                               v_estado,v_nomestado,v_prioridad,v_nomprioridad,v_texto,v_usuario,v_actual,1,'OFICIO CAPTURADO';
                end if;
   end if;
end if;
end procedure;

CREATE PROCEDURE "informix".spd_ultimo_dia_mes(	
				par_Mes Integer,
				par_Ayo Integer)
{######################################################################
#  Procedimiento:    spd_ultimo_dia_mes
#  Descripcion:      regresa la fecha del ultimo dia del mes
#
#  Parametros       
#  de entrada:       par_Mes      = Mes 
#		     par_Ayo      = A�o 
# 
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            21 de Octubre 2014   
#
#  Llamado por:      
#  Llama a:          
#  
######################################################################}
returning 
date          as fecha;
-----------Define las variables de retorno----------------
define v_ultimodiames date;
-----------------------------------------------------------


let v_ultimodiames =(MDY(par_Mes,1,par_Ayo) + 1 UNITS MONTH - (DAY(MDY(par_Mes,1,par_Ayo))) UNITS DAY);

return v_ultimodiames;

end procedure;

create procedure "informix".cajero_afecmerconv(vidlocal int,vaxodsd smallint,vmesdsd smallint,
vaxohst smallint,vmeshst smallint,vfecha date,vid_rec smallint,vcaja char(02),voper int,
vconv varchar(18),vuser int,vmov char(1),vgastos money(16,2))

returning int as id_pago, varchar(30) as mensaje;

define vidpago,vidadeudo,v_idcontrol,v_folio int;
define vmsg varchar(30);
define vpagos,vadeudos int;
define aidlocal,pidlocal int;
define aaxo,paxo int;
define ames,pmes int;
define aimporte,pimporte,v_gastos money(16,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'cajero_afecmerconv ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

if vmov='P' then
   -- verifica que no esten pagados los periodos
--   select nvl(count(id_local),0) into vpagos
--   from ta_11_pagos_local
--   where id_local=vidlocal
--   and ((axo>vaxodsd or (periodo>=vmesdsd  and axo=vaxodsd)) and
--       ( axo<vaxohst or (periodo<=vmeshst  and axo=vaxohst)));

   -- verifica que tenga periodos de adeudos 
   select nvl(count(id_local),0) into vadeudos
   from ta_11_adeudo_local
   where id_local=vidlocal
   and ((axo>vaxodsd or (periodo>=vmesdsd  and axo=vaxodsd)) and
       ( axo<vaxohst or (periodo<=vmeshst  and axo=vaxohst)));

   if vadeudos>0 then
      foreach
      -- selecciona los periodos a pagar 
      select id_local,axo,periodo,importe into aidlocal,aaxo,ames,aimporte
      from ta_11_adeudo_local
      where id_local=vidlocal
      and ((axo>vaxodsd or (periodo>=vmesdsd  and axo=vaxodsd)) and
           (axo<vaxohst or (periodo<=vmeshst  and axo=vaxohst)))
      order by axo,periodo

      -- afecta como pagados los periodos
      insert into ta_11_pagos_local(id_pago_local,id_local,axo,periodo,fecha_pago,
             oficina_pago,caja_pago,operacion_pago,importe_pago,folio,fecha_modificacion,id_usuario)
             values(0,vidlocal,aaxo,ames,vfecha,vid_rec,vcaja,voper,aimporte,vconv,current,vuser);
      let vidpago=dbinfo("sqlca.sqlerrd1");
      let vmsg="EL PAGO SE AFECTO CORRECTAMENTE"; 
      end foreach;

      -- Elimina los adeudos pagados
      delete from ta_11_adeudo_local 
      where id_local=vidlocal
      and ((axo>vaxodsd or (periodo>=vmesdsd  and axo=vaxodsd)) and
           (axo<vaxohst or (periodo<=vmeshst  and axo=vaxohst)));

      if vgastos>0 then
         -- seleccionar los folios vigentes y practicados
         foreach
         select nvl(id_control,0),nvl(folio,0),importe_gastos 
         into v_idcontrol,v_folio,v_gastos
         from    ta_15_apremios a  
         where modulo=11
         and control_otr=vidlocal
         and vigencia='1'
         and clave_practicado='P'

         -- poner como pagados los folios vigentes y practicados
         update ta_15_apremios set fecha_pago=vfecha,recaudadora=vid_rec,caja=vcaja,
         operacion=voper,vigencia='2',clave_mov='P',importe_pago=v_gastos
         where modulo=11 and Id_control=v_idcontrol; 
         end foreach
      end if;
   else
      let vidpago=-2;
      let vmsg="LOS PERIODOS SE ENCUENTRAN PAGADOS";
   end if; -- cierre de la pregunta si tienen pagos 
return vidpago,vmsg with resume; 
end if; -- cierre del if de movimiento

if vmov='C' then
   -- verifica que no existan adeudos por los periodo
   select nvl(count(id_local),0) into vadeudos
   from ta_11_adeudo_local
   where id_local=vidlocal
   and ((axo>vaxodsd or (periodo>=vmesdsd  and axo=vaxodsd)) and
       ( axo<vaxohst or (periodo<=vmeshst  and axo=vaxohst)));

   if vadeudos=0 then
      foreach
      -- selecciona los periodos a cancelar 
      select id_local,axo,periodo,importe_pago into pidlocal,paxo,pmes,pimporte
      from ta_11_pagos_local
      where id_local=vidlocal
      and fecha_pago=vfecha and oficina_pago=vid_rec 
      and caja_pago=vcaja and operacion_pago=voper
      and ((axo>vaxodsd or (periodo>=vmesdsd  and axo=vaxodsd)) and
           (axo<vaxohst or (periodo<=vmeshst  and axo=vaxohst)))
      order by axo,periodo

      -- genera los periodos como adeudos
      insert into ta_11_adeudo_local(id_adeudo_local,id_local,axo,periodo,importe,fecha_alta,id_usuario)
             values(0,vidlocal,paxo,pmes,pimporte,current,vuser);
      let vidadeudo=dbinfo("sqlca.sqlerrd1");
      let vmsg="LA CANCELACION SE AFECTO CORRECTAMENTE"; 
      end foreach;

      -- Elimina los periodos pagados
      delete from ta_11_pagos_local 
      where id_local=vidlocal
      and ((axo>vaxodsd or (periodo>=vmesdsd  and axo=vaxodsd)) and
           (axo<vaxohst or (periodo<=vmeshst  and axo=vaxohst)));

         -- seleccionar los folios pagodos
      foreach
      select nvl(id_control,0),nvl(folio,0),importe_gastos 
      into v_idcontrol,v_folio,v_gastos
      from    ta_15_apremios a  
      where modulo=11
      and control_otr=vidlocal
      and vigencia='2' and fecha_pago=vfecha and recaudadora=vid_rec
      and caja=vcaja and operacion=voper

      -- poner como pagados los folios vigentes y practicados
      update ta_15_apremios set fecha_pago=null,recaudadora=0,caja='',
      operacion=0,vigencia='1',clave_mov='1',importe_pago=0
      where modulo=11 and Id_control=v_idcontrol; 
      end foreach
   else
      let vidadeudo=-2;
      let vmsg="LOS PERIODOS SE ENCUENTRAN NO ESTAN PAGADOS";
   end if; -- cierre de la pregunta si tienen ADEUDOS 
return vidadeudo,vmsg with resume; 
end if; -- cierre del if de movimiento
    
end procedure;

CREATE PROCEDURE "informix".sp42_seguim_doc ( pdoctos int, pcentro int, pid_usuario_seg int, p_usuario char(10), p_origen int )

returning  varchar(50) as status_mov,
                               Datetime year to second as fecha_seguimiento,
                               varchar(10) as usuario_seguim,
                               varchar(10) as usuario_mov,
                               int as id_seguim;

define v_Id_usuario, v_Id_Dependo, v_autorizado, v_Id_Centro int;
define v1_Id_usuario, v1_centro, v1_persona    int;
define v1_usuario char(10);
define v1_nombre, v1_nombramiento   VARCHAR(200);
define vStatus  varchar(50);
define vFechaSeg datetime year to second;
define vUsuario, vUsuario_mov   char(10);
define vIdSeg int;
define vCentrosMas      int;


SELECT  a.id, a.t42_personas_id, a.autorizado, b.t42_centros_id   INTO                 v_Id_usuario, v_Id_Dependo, v_autorizado, v_Id_Centro  -- de que persona y centro depende
FROM t42_deleg a, OUTER t42_personas b   WHERE a.usuario = p_usuario  AND a.id = b.t42_deleg_id;

IF p_origen = 1 then

IF v_autorizado = 1 then ----- titular o suplente de centro
                FOREACH
                SELECT  a.id, a.usuario  INTO      v1_Id_usuario, v1_usuario   FROM   t42_deleg a, outer t42_personas b   
                WHERE a.t42_personas_id = v_Id_Dependo and a.autorizado = 1  and a.id = b.t42_deleg_id
                               foreach
                               SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                               FROM  t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v1_Id_usuario
                               and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                               RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume;
                               end foreach;
                END FOREACH;
                LET vCentrosMas = 0;
                SELECT count(*) INTO vCentrosMas from t42_personas a, t42_centros b  WHERE a.id = v_Id_Dependo  and b.centros_dep = a.t42_centros_id;
                IF vCentrosMas > 0 then
                               FOREACH
                               SELECT b.id, c.id  INTO v1_centro, v1_persona  FROM t42_personas a, t42_centros b, t42_personas c 
                               WHERE a.id = v_Id_Dependo and b.centros_dep = a.t42_centros_id  and c.t42_centros_id = b.id
                                               FOREACH
                                               SELECT  a.id, a.usuario  INTO      v1_Id_usuario, v1_usuario   FROM   t42_deleg a, outer t42_personas b   
                                               WHERE a.t42_personas_id = v1_persona and a.autorizado = 1  and a.id = b.t42_deleg_id
                                                               foreach
                                                               SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                                                               FROM  t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v1_Id_usuario
                                                               and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                                                               RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume;
                                                               end foreach;
                                               END FOREACH;
                               LET vCentrosMas = 0;
                               SELECT count(*) INTO vCentrosMas from t42_personas a, t42_centros b  WHERE a.id = v1_persona  and b.centros_dep = a.t42_centros_id;
                               IF vCentrosMas > 0 then
                                               FOREACH
                                               SELECT b.id, c.id  INTO v1_centro, v1_persona  FROM t42_personas a, t42_centros b, t42_personas c 
                                               WHERE a.id = v1_persona and b.centros_dep = a.t42_centros_id  and c.t42_centros_id = b.id
                                                               FOREACH
                                                               SELECT  a.id, a.usuario  INTO      v1_Id_usuario, v1_usuario   FROM   t42_deleg a, outer t42_personas b   
                                                               WHERE a.t42_personas_id = v1_persona and a.autorizado = 1  and a.id = b.t42_deleg_id
                                                                              foreach
                                                                              SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                                                                              FROM  t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v1_Id_usuario
                                                                              and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                                                                              RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume;
                                                                              end foreach;
                                                               END FOREACH;
                                               LET vCentrosMas = 0;
                                               SELECT count(*) INTO vCentrosMas from t42_personas a, t42_centros b  WHERE a.id = v1_persona  and b.centros_dep = a.t42_centros_id;
                                               IF vCentrosMas > 0 then
                                                               FOREACH
                                                               SELECT b.id, c.id  INTO v1_centro, v1_persona  FROM t42_personas a, t42_centros b, t42_personas c 
                                                               WHERE a.id = v1_persona and b.centros_dep = a.t42_centros_id  and c.t42_centros_id = b.id
                                                                              FOREACH
                                                                              SELECT  a.id, a.usuario  INTO      v1_Id_usuario, v1_usuario   FROM   t42_deleg a, outer t42_personas b   
                                                                              WHERE a.t42_personas_id = v1_persona and a.autorizado = 1  and a.id = b.t42_deleg_id
                                                                                              foreach
                                                                                              SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                                                                                              FROM  t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v1_Id_usuario
                                                                                              and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                                                                                              RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume;
                                                                                              end foreach;
                                                                              END FOREACH;
                                                               END FOREACH
                                               ELSE
                                                               FOREACH
                                                               SELECT  a.id, a.usuario  INTO      v1_Id_usuario, v1_usuario   FROM   t42_deleg a, outer t42_personas b   
                                                               WHERE a.t42_personas_id = v1_persona and a.autorizado = 0  and a.id = b.t42_deleg_id
                                                                              foreach
                                                                              SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                                                                              FROM t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v1_Id_usuario
                                                                              and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                                                                              RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume;  -- delegado tercer nivel
                                                                              end foreach;
                                                               END FOREACH;
                                               END IF;
                                               END FOREACH
                               ELSE
                                               FOREACH
                                               SELECT  a.id, a.usuario  INTO      v1_Id_usuario, v1_usuario   FROM   t42_deleg a, outer t42_personas b   
                                               WHERE a.t42_personas_id = v1_persona and a.autorizado = 0  and a.id = b.t42_deleg_id
                                                               foreach
                                                               SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                                                               FROM t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v1_Id_usuario
                                                               and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                                                               RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume;  -- delegado segundo nivel
                                                               end foreach;
                                               END FOREACH;
                               END IF;
                               END FOREACH;
                ELSE
                               FOREACH
                               SELECT  a.id, a.usuario  INTO      v1_Id_usuario, v1_usuario   FROM   t42_deleg a, outer t42_personas b   
                               WHERE a.t42_personas_id = v_Id_Dependo and a.autorizado = 0  and a.id = b.t42_deleg_id
                                               foreach
                                               SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                                               FROM t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v1_Id_usuario
                                               and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                                               RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume;  -- delegado del primer nivel
                                               end foreach;
                               END FOREACH;
                END IF;
ELSE
                foreach
                SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                FROM t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.usuario_seg = v_Id_usuario
                and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume; -- delegado primario
                end foreach;
END IF;

ELSE
                foreach
                SELECT c.descripcion, a.fec_seg , b.usuario, a.usuario_mov, a.id  INTO vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
                FROM t42_seguimiento a, t42_deleg b, t42_statusseg c  WHERE a.t42_doctos_id= pdoctos  and a.t42_centros_id = pcentro
                and b.id = a.usuario_seg  and c.id = a.t42_statusseg_id  order by a.usuario_seg, a.t42_statusseg_id

                RETURN vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg    with resume; -- delegado primario
                end foreach;
END IF;

end procedure;

create procedure "informix".opercompacum(p_fecini date, p_fecfin date) 
    RETURNING int as id_orden , char(30) as descripcion, int as operantes, int as operactual, int as operdif,
        money(16,2) as impantes, money(16,2) as impactual, money(16,2) as impdif ;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_operantes int;
define  v_operactual int;
define  v_operdif int ;
define  v_impantes money(16,2);
 define v_impactual money(16,2); 
 define v_impdif money(16,2);
define  v_importe money(16,2);
define v_fechatime datetime year to fraction(3) ;
define feciniant date; define fecfinant date;
define axo_actual int;
define axo_antes int;
define v_orden int;
define dia  int;
define mes int;
define v_dia_fin_act date;
define v_dia_ini_act date;
define v_cero int;

let dia = day(p_fecini);
let mes = month(p_fecini);
let axo_antes = year(p_fecini) - 1;
--if  p_fecini > mdy(6,30,2014) then
--    let v_cero = 1;
--    let v_dia_ini_act = mdy(6,30,2014);
-- else
    let v_cero = 0;
    let v_dia_ini_act = p_fecini ;
-- end if;
--  if  p_fecfin > mdy(6,30,2014) then
--    let v_dia_fin_act = mdy(6,30,2014);
-- else
    let v_dia_fin_act = p_fecfin ;
-- end if;
let feciniant = mdy(mes,dia,axo_antes);
let dia = day(p_fecfin);
let mes = month(p_fecfin);
let axo_antes = year(p_fecfin) - 1;

let fecfinant = mdy(mes,dia,axo_antes);

     foreach 
     select x1.orden, x1.id_modulo , x1.descripcion , nvl(antes.operantes,0) , nvl(actual.operactual,0),
     (nvl(actual.operactual,0) - nvl(antes.operantes,0)) DifOper ,
     nvl(antes.impantes,0) , nvl(actual.impactual,0) , (nvl(actual.impactual,0) - nvl(antes.impantes,0)) difimpor
     into  v_orden , v_id_modulo , v_descripcion, v_operantes , v_operactual , v_operdif, v_impantes , v_impactual , v_impdif 
     from ta_12_moduloscat x1 ,
     outer 
    ( select an.modulo modantes , sum(an.operaciones) operantes, sum(an.importe) impantes 
      from ta12_ingrexmodulo an  where an.fecha between feciniant and fecfinant group by 1 )  antes , 
     outer
    ( select ac.modulo modactual , sum(ac.operaciones) operactual, sum(ac.importe) impactual 
      from ta12_ingrexmodulo ac  where ac.fecha between v_dia_ini_act and v_dia_fin_act group by 1 )  actual 

     where 
     -- x1.id_modulo not in (4,12,18,22) and 
        x1.id_modulo = antes.modantes and x1.id_modulo = actual.modactual order by 1

    if v_cero = 1 then
       let v_operactual = 0 ; let v_impactual = 0; let v_operdif = 0; let  v_impdif = 0;
    end if;
    if v_id_modulo = 12 and year(v_dia_ini_act) > 2014 then
        let v_operactual = 0 ; let v_impactual = 0; let v_operdif = 0; let  v_impdif = 0;
    end if;
    if ( v_impantes <> 0 )or ( v_impactual <> 0) then
     return  v_orden , v_descripcion , v_operantes , v_operactual,  v_operdif, v_impantes , v_impactual , v_impdif   with resume;
     end if;
    end foreach    ;

 
end procedure;

CREATE PROCEDURE "informix".kio_pagolicgiro3(
  parlinea varchar(28),
  parImpCertificado money(15,2),
  parColonia  varchar(25),
  parCP           int,
  parTelefono  varchar(30)  ,
  parCalle1     varchar(48) ,
  parCalle2     varchar(48) ,
  parTarBanco   int,
  partarconfir  int,
  partartarjeta varchar(30),
  partartipo    int,
  parKiosco	int
        )
  returning smallint , char(2), integer , char(28);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define parlic integer ;
define parlican  integer;
define paranun integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(50); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define v_id_licencia int;
define v_id int;
define paraxodesde int;
define paraxohasta int;
define varcvepago int;
define v_descriprbo varchar(60);
define v_colonia_ubic char(20) ;define  v_cvecatnva char(15) ;
define v_subpredio int ;define v_rfc char(15);
define v_axo int; define v_id_giro int ; define v_actividad char(92);
define v_id_anuncio int; define v_linea char(28); define partipoLic char(1);
define estatus int ; define mensaje varchar(100);
define varcruces varchar(100);
--on exception
--rollback work;
--return 9, ' ', 0 , '';
--end exception;
let parlic =0; let paranun = 0; let v_id = 0; 
set debug file to "pagokioLICac";
trace on;
let v_linea = parlinea ;
--datos de la  Licencia .
--begin work;
 select nvl(a.licencia,0) , nvl(a.anuncio,0) , nvl(a.desde,0), nvl(a.hasta,0), a.linea
  into parlic , paranun , paraxodesde, paraxohasta , v_linea
   from catastro_gdl:linea_capturalic a 
   where trim(a.linea) = trim(parlinea);
if v_linea = '' then 
return 0, '', 0 , parlinea;

else

if (parlic > 0) and ( paranun = 0) then   --cuando es licencia
    select nvl(l.id_licencia,0),year(l.fecha_otorgamiento),l.id_giro,l.propietario,
    "Licencia" || trim(l.actividad),
    trim(l.ubicacion) || ' Ext:'|| l.numext_ubic||' '|| trim(l.letraext_ubic)
          || l.numint_ubic || ' '|| trim(l.letraint_ubic),
           trim(l.colonia_ubic)
           ,   cc.cvecatnva,cc.subpredio,l.rfc
           into v_id_licencia,v_axo,v_id_giro,v_nombre,v_actividad,
           v_ubicacion ,
           v_colonia_ubic,
           v_cvecatnva,v_subpredio,v_rfc
   from         catastro_gdl:licencias l,
          outer catastro_gdl:convcta cc
   where licencia= parlic 
            and cc.cvecuenta = l.cvecuenta ;
   let v_id = v_id_licencia;
let parlican = parlic;
let partipoLic = 'L';
   
end if;
if (paranun > 0) and ( parLic = 0) then  --cuando es anuncio
   select nvl(a.id_anuncio,0),year(a.fecha_otorgamiento),a.id_giro,l.propietario,
           'MEDIDAS ' || medidas1 || ' X ' || medidas2 || ' area: ' || area_anuncio || ' CARAS: ' || num_caras
           ,trim(a.ubicacion)|| ' Ext ' || a.numext_ubic || ' ' ||  trim(a.letraext_ubic)|| ' Int ' || 
           a.numint_ubic||  ' Ext ' || trim(a.letraint_ubic),
           a.colonia_ubic,'',0,l.rfc
           into v_id_anuncio,v_axo,v_id_giro,v_nombre,v_actividad,
    v_ubicacion, v_colonia_ubic, v_cvecatnva,v_subpredio,v_rfc
   from catastro_gdl:anuncios a, 
        catastro_gdl:licencias l 
   where a.anuncio=paranun and l.id_licencia=a.id_licencia;
   let v_id = v_id_anuncio;
  let parlican = paranun;
let partipoLic = 'A';
 end if;

  select id_rec , caja  into varrec , varcaja
  from ta12_operacKiosco where id_usuario = parkiosco; 
let v_descriprbo = 'PAGO DE LICENCIA:   Id_licencia : ' || v_id;

  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 9, parlican, 0, '',
              1, parAxodesde, 12, parAxohasta,
                v_Nombre, v_ubicacion,
           v_actividad , '',v_id,0,
                0,0,parkiosco,current,0,0,0,'',0,'I',v_descriprbo)
 into spoperacion;

  let varoperacion = spoperacion;
 -- para afectar catastro del pago;
 let us = 'Kiosco ' || parkiosco;
  let v_hora = extend(current, hour to minute);
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,v_id, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 8);
   let varcvepago = dbinfo("sqlca.sqlerrd1");   
                
let linea = 1;     
let v_suma =0;

-- si es pago con tarjeta afectar
if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag)
    values(today ,varrec , varcaja, spoperacion, parTarBanco  ,
  partarconfir ,  partartarjeta, parImpCertificado,  partartipo);
  end if;

--

FOREACH
execute procedure  catastro_gdl:kiosco_lic_totales( v_id , partipoLic,'R','D') 
    into v_cuenta , v_ob , v_concepto , v_importe 
insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );
-- insertar en auditoria
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (v_id, varcvepago, v_cuenta,varrec ,v_importe,
'N',0,0);
       let linea = linea +1 ;
       let v_suma = v_suma + v_importe;
end FOREACH;
let v_redondeo = parImpCertificado - v_suma;
if v_redondeo <> 0 then
 if (parImpCertificado - (v_suma)) > 0 then
     let cuenta = 55080000;
      else
     let cuenta = 55080000;
    end if;
 
 insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
 'Ajuste ART. 14 de ley de ingresos ' , 55080000, v_redondeo );
  insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  values (v_id, varcvepago, 55080000,varrec ,v_redondeo,
'N',0,0);
end if;
-- grabar datos adicionales
let varcruces = trim(parcalle1) || ' y ' || trim(parcalle2);
 if not exists ( select licencia from catastro_gdl:lic_web_dom where licencia = parlic) then
      insert into catastro_gdl:lic_web_dom (licencia ,colonia ,cp ,telefono, cruces , fecha )
      values( parlic , parcolonia , parcp,partelefono, varcruces , today);
 end if;
-- quitar los adeudos
if upper(partipoLic) = 'L' then
    update catastro_gdl:detsal_lic   set cvepago=varcvepago
     	where id_licencia=v_id
       	and cvepago = 0 ;

    execute procedure catastro_gdl:calc_sdosl(v_id);
end if;
if upper(partipoLic) = 'A' then
    update catastro_gdl:detsal_lic  set cvepago=varcvepago
     	where id_anuncio=v_id
       	and cvepago = 0 ;
end if;
execute  PROCEDURE linea_pagok(v_linea, parKiosco, parImpCertificado, 'K',varcvepago,
    today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje ;
--commit work;

return varrec, varcaja, spoperacion , v_linea;
end if;
trace off;
end procedure;

CREATE PROCEDURE "informix".admin_terceros_can(pidcobro integer,pfolio varchar(10),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_terceros_can
#  Descripcion:      Interfaz de cancelacion del pago de terceros para admin
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            15 agosto 2014   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_id_modulo int;
define v_id  int;
define v_cvepagorbo CHAR(1);
define v_axo,v_id_rec_cta int;
define v_cvecanc,v_cvepago,v_cvecuenta int;
define v_superficie decimal(7,2);
define v_statusdescto dec(16,2);
define v_msjdescto varchar(100);
DEFINE v_iduser CHAR(8);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de terceros ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica si existe el pago 
if NOT exists (select * from ta_12_recibos where operacion = pidcobro 
               and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

--if v_id_modulo <> 12 then
--   let v_leyenda = 'EL RECIBO NO ES DE TERCEROS';
--   let v_estatus = 3;
--   RETURN v_estatus,v_leyenda;
--end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

select cvepago,cvecuenta into v_cvepago,v_cvecuenta from catastro_gdl:pagos 
where recaud = v_rec_pag and caja= v_caja_pag and fecha=v_fecha_pag and folio=pidcobro;


-- cancela recibo
if v_id_modulo = 9 then
   execute procedure catastro_gdl:admin_cancela_12(pidcobro,pfolio,puser) into v_estatus,v_leyenda;
end if;

if v_id_modulo = 5 then
   execute procedure catastro_gdl:admin_cancela_08(pidcobro,pfolio,puser) into v_estatus,v_leyenda;
end if;
BEGIN WORK;
if v_id_modulo = 12 then
   update ta_12_recibos set cvepago='C', fecha_act=today,id_usuario=v_iduser 
   where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and 
   operacion = pidcobro and foliorecibo=trim(pfolio);

   insert into catastro_gdl:pagoscan (cvecanc,cvepago,autorizo,fechacan ) values (0,v_cvepago,puser,today);
   let v_cvecanc = dbinfo("sqlca.sqlerrd1");
end if;

if exists (select * from linea_pagos where cvepago=v_cvepago) then
   update linea_pagos set estatus="N",cvepago=0,fecha_pago=null,id_rec=0,caja='',operacion=0
   where cvepago=v_cvepago; 
end if;

if exists (select * from catastro_gdl:bco_carga1 where cvepago=v_cvepago) then
   update catastro_gdl:bco_carga1 set cvepago=0,estatus="N" where cvepago=v_cvepago;
end if;

if exists (select * from catastro_gdl:lic_pago_alt where cvepago=v_cvepago) then
   update catastro_gdl:lic_pago_alt set cvepago=0 where cvepago=v_cvepago;
end if;
COMMIT WORK; 

return v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".admin_adeudos_detalle_14x(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10), p_Apagar char(20))
                returning  int as sNoRubro, int as sNoConcepto, int as sCuenta_aplicacion,
                varchar(50) as sreferencia1, varchar(50) as sDescripcion, dec(14,2) as sMonto, dec(14,2) as sAcumulado;


define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_mon  integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_vigencia CHAR(1);
define  v_imptot money(15,2);
define  v_impmonto money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  var_axo    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapl3     int;
define v_ctaapl4     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define  v_acumula     money(15,2);



let v_axo=year(today);
let v_mes=month(today);
let v_obs ='';
let v_impmonto = 0;
let v_desctot  = 0;
let v_axo_mon  = 0;
let v_acumula  = 0;

let v_control= p_segmento1;
let var_axo= nvl((p_Apagar),0);
let v_imptot=0;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   return 0,0,0,' ',' ',0,0; 
end if;      

select cementerio,axo_pagado,vigencia
into  v_cementerio,v_axo_pagado,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

select  cta_aplicacion, cta_vencido, cta_descto,cta_desctopens into v_ctaapl1, v_ctaapl2 , v_ctaapl3 ,v_ctaapl4
from tc_13_cementerios where cementerio=v_cementerio;

if v_axo_pagado=v_axo  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if v_vigencia='B'  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;

if v_axo<>var_axo then
   let v_axo=var_axo;
end if;

    let v_desctot = 0;
    let v_desctotre = 0;

if v_imptot>0 then
foreach 
    select b.axo_adeudo, (b.importe+b.importe_recargos) - (b.descto_impote+ b.descto_recargos)
          into vpar_axo, vpar_impte
           from ta_13_adeudosrcm b where  b.control_rcm=v_control and b.axo_adeudo between v_axodesde and v_axo
          order by 1
    let v_impmonto = v_impmonto + vpar_impte;
    if  v_impmonto <= v_imptot then
        let v_axo_mon =  vpar_axo; 
    end if;
end foreach;
   let v_axo=v_axo_mon;
end if;

foreach 
    select b.axo_adeudo,b.importe,b.importe_recargos, nvl(d.descuento,0),b.descto_impote, b.descto_recargos
          into vpar_axo,vpar_impte, vpar_recar , v_descuento,v_impdesc,v_recardesc     
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and  b.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
          order by 1

    if  v_descuento <> 0 then         
        let v_ctaapldi=v_ctaapl4;
        let v_desctot  = v_desctot  + v_impdesc;
           let v_obs = 'INCLUYE DESC. '||v_descuento||'% POR PENSIONADO'; 
    else
           let v_obs = ''; 
     end if;
     let v_desctotre  =  v_recardesc;
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
        if v_impdesc=0 then
          let v_desctot  =v_desctot+ trunc(((vpar_impte-v_impdesc) * 0.1),2);
          let v_ctaapldi=v_ctaapl3;
          if  v_obs = '' then
             let v_obs = v_obs || 'INCLUYE DESC. 10% POR PRONTO PAGO'; 
          else
              let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
          end if;
          end if;
     end if;
     if vpar_axo=year(today) then
        let v_ctaapli=v_ctaapl1;
     else
        let v_ctaapli=v_ctaapl2;
     end if;   
     if vpar_recar>0 then
        let v_ctaaplr=390300000;
     end if;   
     if v_desctot>0 then
--        let v_ctaapldi=v_ctaapl3;
        let v_desctot= v_desctot * -1;
     end if;   
     if v_desctotre>0 then
        let v_ctaapldr=390340000;
        let v_desctotre= v_desctotre* -1;
     end if;   

  let v_acumula=v_acumula +vpar_impte;
  return 0,0,v_ctaapli, vpar_axo, 'Mantenimiento' ||vpar_axo,  vpar_impte, v_acumula with resume;

  if  v_desctot <>0 then
     let v_acumula= v_acumula + v_desctot;
  return 0,0,v_ctaapldi,vpar_axo, v_obs || vpar_axo,   (v_desctot ), v_acumula with resume;
     let v_desctot=0;
  end if;
  if vpar_recar>0 then
     let v_acumula=v_acumula+vpar_recar;
  return 0,0,v_ctaaplr,vpar_axo , 'Recargos ' || vpar_axo , vpar_recar, v_acumula with resume;
  end if;
  if v_desctotre <>0 then
     let v_acumula=v_acumula + v_desctotre;
  return 0,0,v_ctaapldr, vpar_axo, v_obs||'Descto Recarg ' || vpar_axo,  v_desctotre , v_acumula with resume;
  end if;

end foreach;
end procedure;

CREATE PROCEDURE "informix".admin_adeudos_detalle_14(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10), p_Apagar char(20))
                returning  int as sNoRubro, int as sNoConcepto, int as sCuenta_aplicacion,
                varchar(50) as sreferencia1, varchar(50) as sDescripcion, dec(14,2) as sMonto, dec(14,2) as sAcumulado;


define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_mon  integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_vigencia CHAR(1);
define  v_imptot money(15,2);
define  v_impmonto money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  var_axo    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapl3     int;
define v_ctaapl4     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define  v_acumula     money(15,2);



let v_axo=year(today);
let v_mes=month(today);
let v_obs ='';
let v_impmonto = 0;
let v_desctot  = 0;
let v_axo_mon  = 0;
let v_acumula  = 0;

let v_control= p_segmento1;
let var_axo= nvl((p_Apagar),0);
let v_imptot=0;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   return 0,0,0,' ',' ',0,0; 
end if;      

select cementerio,axo_pagado,vigencia
into  v_cementerio,v_axo_pagado,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

select  cta_aplicacion, cta_vencido, cta_descto,cta_desctopens into v_ctaapl1, v_ctaapl2 , v_ctaapl3 ,v_ctaapl4
from tc_13_cementerios where cementerio=v_cementerio;

if v_axo_pagado=v_axo  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if v_vigencia='B'  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;

if v_axo<>var_axo then
   let v_axo=var_axo;
end if;

    let v_desctot = 0;
    let v_desctotre = 0;

if v_imptot>0 then
foreach 
    select b.axo_adeudo, (b.importe+b.importe_recargos) - (b.descto_impote+ b.descto_recargos)
          into vpar_axo, vpar_impte
           from ta_13_adeudosrcm b where  b.control_rcm=v_control and b.axo_adeudo between v_axodesde and v_axo
          order by 1
    let v_impmonto = v_impmonto + vpar_impte;
    if  v_impmonto <= v_imptot then
        let v_axo_mon =  vpar_axo; 
    end if;
end foreach;
   let v_axo=v_axo_mon;
end if;

foreach 
    select b.axo_adeudo,b.importe,b.importe_recargos, nvl(d.descuento,0),b.descto_impote, b.descto_recargos
          into vpar_axo,vpar_impte, vpar_recar , v_descuento,v_impdesc,v_recardesc     
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and  b.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
          order by 1

    if  v_descuento <> 0 then         
        let v_ctaapldi=v_ctaapl4;
        let v_desctot  = v_desctot  + v_impdesc;
           let v_obs = 'INCLUYE DESC. '||v_descuento||'% POR PENSIONADO'; 
    else
           let v_obs = ''; 
     end if;
     let v_desctotre  =  v_recardesc;
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
        if v_impdesc=0 then
          let v_desctot  =v_desctot+ trunc(((vpar_impte-v_impdesc) * 0.1),2);
          let v_ctaapldi=v_ctaapl3;
          if  v_obs = '' then
             let v_obs = v_obs || 'INCLUYE DESC. 10% POR PRONTO PAGO'; 
          else
              let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
          end if;
          end if;
     end if;
     if vpar_axo=year(today) then
        let v_ctaapli=v_ctaapl1;
     else
        let v_ctaapli=v_ctaapl2;
     end if;   
     if vpar_recar>0 then
        let v_ctaaplr=390300000;
     end if;   
     if v_desctot>0 then
--        let v_ctaapldi=v_ctaapl3;
        let v_desctot= v_desctot * -1;
     end if;   
     if v_desctotre>0 then
        let v_ctaapldr=390340000;
        let v_desctotre= v_desctotre* -1;
     end if;   

  let v_acumula=v_acumula +vpar_impte;
  return 0,0,v_ctaapli, vpar_axo, 'Mantenimiento' ||vpar_axo,  vpar_impte, v_acumula with resume;

  if  v_desctot <>0 then
     let v_acumula= v_acumula + v_desctot;
  return 0,0,v_ctaapldi,vpar_axo, v_obs || vpar_axo,   (v_desctot ), v_acumula with resume;
     let v_desctot=0;
  end if;
  if vpar_recar>0 then
     let v_acumula=v_acumula+vpar_recar;
  return 0,0,v_ctaaplr,vpar_axo , 'Recargos ' || vpar_axo , vpar_recar, v_acumula with resume;
  end if;
  if v_desctotre <>0 then
     let v_acumula=v_acumula + v_desctotre;
  return 0,0,v_ctaapldr, vpar_axo, v_obs||'Descto Recarg ' || vpar_axo,  v_desctotre , v_acumula with resume;
  end if;

end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_canpredkio(
p_cvepago integer,
p_operacion integer,
p_usuario_canc varchar(10)
)
{######################################################################
#  Procedimiento:    spd_canPredKio
#  Descripcion:      Interfaz de cancelacion del pago de predial en el sistema Kioscos. se tiene que cancelar 
#        en automatico por tiempo de respuesta mayor al programado en kioscos.
#
#  Parametros        P_cvepago     = clave de pago de pagos catastro
#  de entrada:       P_operacion   = Numero de operacion de ta12_recibos
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            2 Febrero 2015   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_CVECUENTA   int;
define v_cvepagorbo       integer;
define v_operacion  integer;
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);
--set debug file to 'marco.log';
--trace on;

--RETURN -1, 'Error en cancelacion de Predial ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
    -- ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -11, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE PREDIAL ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
  let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Predial)
if not exists ( select * from catastro_gdl:pagos where cvepago = p_cvepago) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = -1;
   RETURN v_estatus,v_leyenda;
end if;
select fecha ,  recaud , caja , folio , cvecanc , cvecuenta , cveconcepto, cvepago
into  v_fecha_pag,v_rec_pag,v_caja_pag,v_operacion, v_cvepagorbo  ,v_CVECUENTA,v_id_modulo,v_cvepago
 from catastro_gdl:pagos where cvepago = p_cvepago;
--select fecha ,id_rec ,caja,rfcnumero,id_modulo,cvepago 
--into v_fecha_pag,v_rec_pag,v_caja_pag,v_operacion ,v_CVECUENTA,v_id_modulo,v_cvepagorbo
--from db_ingresos:ta_12_recibos where   operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);
  if v_cvepagorbo is null then
     let v_cvepagorbo = 0; 
  end if;
if v_cvepagorbo > 0 then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = -2;
   RETURN v_estatus,v_leyenda;
end if;
if v_id_modulo <> 1 then
   let v_leyenda = 'EL RECIBO NO ES DE UN PAGO DE PREDIAL';
   let v_estatus = -3;
   RETURN v_estatus,v_leyenda;
end if;

   
      -- BEGIN WORK;
      let v_r = 'S';
      update db_ingresos: ta_12_recibos set cvepago='C', fecha_act=today
      where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag 
       and operacion = v_operacion ;

      insert into catastro_gdl:pagoscan (cvecanc, cvepago, autorizo, fechacan ) 
	values      (0,v_cvepago,p_usuario_canc,today);
    
 
    --  COMMIT WORK; 


return 0, 'Operacion cancelada';
--trace off;
END PROCEDURE
;

create procedure "informix".admin_adeudo_20(pid int,pparc int,pfuncion int)

returning   varchar(50) as colonia,
            varchar(100) as calle,
            varchar(20) as tipoobra,
            varchar(100) as nombreobra,
            decimal(8,2) as pagototal,
            decimal(8,2) as pagoinicial,
            decimal(8,2) as pagoparcial,
            decimal(8,2) as pagos, 
            decimal(8,2) as adeudo,
            date as vencimiento,
            integer as parcialidad,
            integer as restan,
            integer as apagar,
            integer as cuentaapl,
            varchar(30) as referencia,
            varchar(50) as descripcion,
            decimal(12,2) as monto,
            decimal(12,2) as acumulado;

define  v_descripcionrecibo lvarchar(500);
define  v_parcialidad,v_parctot,v_restan,v_apagar,v_cuentaapl,v_cve_desc,v_devolucion integer;
define  a_pagos_parciales,g_pagos_parciales,v_hist,p_pagos,v_cve20,v_numpagos,v_axo int;
define  v_referencia varchar(30);
define  v_tipoobra varchar(20);
define  v_descripcion,v_colonia varchar(50);
define  v_vencimiento,v_firma,v_fecha_pago date;
define  a_vencimiento,a_firma,g_vencimiento,g_firma,p_vencimiento,p_firma date;
define  v_monto,v_acumulado,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pago_final money(12,2);
define  a_pago_total,a_pago_inicial,a_pago_quincenal,g_pago_total,g_pago_inicial,g_pago_quincenal money(12,2); 
define  p_pago_total,p_pago_inicial,p_pago_quincenal,p_pago_final,v_saldo money(12,2);
define  v_parc,a_parc,g_parc,v_cont,v_pagt,v_axomax,v_mesmax,v_actual,v_rezago,v_cuenta,v_col,v_call int; 
define  v_importe,v_recant,v_recact,v_pagos,v_adeudo,v_acumtot,v_recargos money(12,2); 
define  v_calle,v_nombreobra varchar(100);
define  v_vigencia,p_tipo_pago char(1);
define  v_ctarec,v_ctadescrec int;

let v_pagos=0;
let v_numpagos=0;
let v_acumulado=0;
let v_cve_desc=0;
let v_apagar=0;
let v_acumtot=0;
-- consulta datos generales y programa de descuentos
select a.pago_total,a.pago_inicial,a.pago_quincenal,a.pagos_parciales,a.fecha_firma,a.fecha_vencimiento,
a.vigencia,a.clave_historia,b.descripcion,d.descripcion,f.desc_calle,f.axo_obra,
g.pago_total,g.pago_inicial,g.pago_quincenal,g.pagos_parciales,g.fecha_firma,g.fecha_vencimiento,
f.cuenta_ingreso,f.cuenta_rezago,a.colonia,a.calle,l.descripcion,f.cuenta_recargos,f.cuenta_descrecargos
into a_pago_total,a_pago_inicial,a_pago_quincenal,a_parc,a_firma,a_vencimiento,v_vigencia,v_hist,v_colonia,
v_tipoobra,v_calle,v_axo,g_pago_total,g_pago_inicial,g_pago_quincenal,g_parc,g_firma,g_vencimiento,
v_actual,v_rezago,v_col,v_call,v_nombreobra,v_ctarec,v_ctadescrec
from ta_17_convenios a,ta_17_colonias b,ta_17_tipos d,ta_17_calles f, outer ta_17_hist_conv g,
ta_17_servicios l
where a.id_convenio=pid
and a.colonia=f.colonia and a.calle=f.calle and f.colonia=b.colonia 
and l.servicio=f.servicio
and f.tipo=d.tipo and g.id_convenio=a.id_convenio and g.clave_historia=1;
--if v_hist=1 then
   let v_pago_total=a_pago_total;
   let v_pago_inicial=a_pago_inicial;
   let v_pago_quincenal=a_pago_quincenal;
   let v_pago_final=0;
   let v_parc=a_parc;
   let v_vencimiento=a_vencimiento;
   let v_firma=a_firma;
--else
--   let v_pago_total=g_pago_total;
--   let v_pago_inicial=g_pago_inicial;
--   let v_pago_quincenal=g_pago_quincenal;
--   let v_pago_final=0;
--   let v_parc=g_parc;
--   let v_vencimiento=g_vencimiento;
--   let v_firma=g_firma;
--end if;
-- checa si hay apliaciones de plazo
    -- para sacar el a�o minimo
select  max(axo_oficio) into v_axomax from ta_17_amp_plazo where id_convenio=pid and vigencia='A';
    -- para sacar el mes minimo       
select max(folio_oficio) into v_mesmax from ta_17_amp_plazo where id_convenio=pid and vigencia='A'
and axo_oficio=v_axomax;

select nvl(total,0),nvl(pago_inicial,0),nvl(pago_parcial,0),nvl(pago_final,0),nvl(pagos,0),
nvl(tipo_pago,''),fecha_inicio,fecha_fin
into p_pago_total,p_pago_inicial,p_pago_quincenal,p_pago_final,p_pagos,
p_tipo_pago,p_firma,p_vencimiento
from ta_17_amp_plazo where id_convenio=pid and vigencia='A' and axo_oficio=v_axomax and folio_oficio=v_mesmax; 
if  v_vencimiento<p_vencimiento then
    let v_pago_total=p_pago_total;
    let v_pago_inicial=p_pago_inicial;
    let v_pago_quincenal=p_pago_quincenal;
    let v_pago_final=p_pago_final;
    let v_parc=p_pagos;
    let v_vencimiento=p_vencimiento;
    let v_firma=p_firma;
    let v_hist=2;
end if;

-- checa sus pagos
foreach
select fecha_pago,nvl(importe,0),nvl(cve_descuento,0),nvl((select sum(importe) 
from ta_12_recibosdet where fecha=a.fecha_pago and id_rec=a.oficina_pago and caja=a.caja_pago 
and operacion=a.operacion_pago and cuenta in (46210,570200000)),0),0
into v_fecha_pago,v_importe,v_cve_desc,v_recant,v_recact
from ta_17_pagos a where a.id_convenio=pid  and a.fecha_pago>=v_firma order by a.fecha_pago
let v_cve20=v_cve_desc;
let v_numpagos=v_numpagos+1;
if v_hist=1 then
   let v_pagos=v_pagos+v_importe;
else
if v_fecha_pago>=v_firma then
   let v_pagos=v_pagos+v_importe+v_recant+v_recact;
end if;
end if;   
end foreach;

-- checa sus devoluciones
select nvl(sum(importe),0) into v_devolucion from ta_17_devoluciones
where id_convenio=pid;

let v_pagos=v_pagos-v_devolucion;
if (v_numpagos =1 and v_cve_desc=20) or (v_axo <1995 and v_cve_desc=20 ) then
   let v_adeudo=0;
   return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
          null,0,0,0,0,'','',0,0;
end if;
let v_adeudo=v_pago_total-v_pagos;
if v_adeudo<=0 then
   return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
          null,0,0,0,0,'','',0,0;
end if;

if pfuncion=1 then
   return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
          null,0,0,0,0,'','',0,0;
else
let v_parcialidad=v_parc;
if v_pago_inicial>0 then
   let v_parcialidad=v_parcialidad+1;
end if;

if v_pago_final>0 then
   let v_parcialidad=v_parcialidad+1;
end if;
let v_parctot=v_parcialidad;

if today>v_vencimiento then
   let v_cuenta=v_rezago;
else
   let v_cuenta=v_actual;
end if;

if pparc>0 then
   let v_parcialidad=pparc; 
end if;

if v_adeudo=v_pago_total then
   for v_cont= 1 to v_parcialidad
       let v_apagar=v_apagar+1;
       let v_restan=v_parctot-v_cont;
       if (v_cont=1) and (v_pago_inicial>0) then
          let v_monto=v_pago_inicial;
       else
       if (v_cont=v_parctot) and (v_pago_final>0) then
          let v_monto=v_pago_final;
       else
          let v_monto=v_pago_quincenal;
       end if;
       end if;  
       let v_acumulado=v_acumulado+v_monto;
       let v_acumtot=v_acumtot+v_monto; 
       return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
       null,v_parctot,v_restan,v_apagar,v_cuenta,v_cont,'CONTRATO',v_monto,v_acumtot with resume;
       if today>v_vencimiento then
          execute procedure admin_recargos_20(v_monto,v_vencimiento) into v_recargos;
          if (v_col=107) and (v_call=47) then
              let v_recargos=0;
          else
              let v_acumtot=v_acumtot+v_recargos;
              return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
              v_vencimiento,v_parctot,v_restan,v_apagar,v_ctarec,v_cont,'RECARGOS',v_recargos,v_acumtot with resume;
          end if;
       end if;
   end for;
else
   let v_saldo=v_pagos-v_pago_inicial;
   if  v_saldo>0 then 
       let v_pagt=(v_saldo/v_pago_quincenal)+1;
   else
   if  v_saldo=0 then
       let v_pagt=1;
   else
       let v_pagt=0;
   end if;
   end if; 
   for v_cont=(v_pagt+1) to v_parcialidad
       let v_apagar=v_apagar+1;
       let v_restan=v_parctot-v_cont;
       if (v_cont=1) and (v_pago_inicial>0) then
          let v_monto=v_pago_inicial;
       else
       if (v_cont=v_parctot) and (v_pago_final>0) then
          let v_monto=v_pago_final;
       else
          let v_monto=v_pago_quincenal;
       end if;
       end if;
       let v_acumulado=v_acumulado+v_monto;
       let v_acumtot=v_acumtot+v_monto;
       if  v_adeudo>v_acumulado then  
           return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
           v_vencimiento,v_parctot,v_restan,v_apagar,v_cuenta,v_cont,'CONTRATO',v_monto,v_acumtot with resume;
           if today>v_vencimiento then
              execute procedure admin_recargos_20(v_monto,v_vencimiento) into v_recargos;
              if (v_col=107) and (v_call=47) then
                 let v_recargos=0;
              else
                 let v_acumtot=v_acumtot+v_recargos;
                 return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
                 v_vencimiento,v_parctot,v_restan,v_apagar,v_ctarec,v_cont,'RECARGOS',v_recargos,v_acumtot with resume;
              end if;
           end if; 
       else
           let v_acumulado=v_acumulado-v_monto;
           let v_acumtot=v_acumtot-v_monto;
           let v_monto=v_adeudo-v_acumulado;
           let v_acumulado=v_acumulado-v_monto;
           let v_acumtot=v_acumtot+v_monto;
           return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
           v_vencimiento,v_parctot,v_restan,v_apagar,v_cuenta,v_cont,'CONTRATO',v_monto,v_acumtot with resume;
           if today>v_vencimiento then
              execute procedure admin_recargos_20(v_monto,v_vencimiento) into v_recargos;
              if (v_col=107) and (v_call=47) then
                 let v_recargos=0;
              else
                 let v_acumtot=v_acumtot+v_recargos;
                 return v_colonia,v_calle,v_tipoobra,v_nombreobra,v_pago_total,v_pago_inicial,v_pago_quincenal,v_pagos,v_adeudo,
                 v_vencimiento,v_parctot,v_restan,v_apagar,v_ctarec,v_cont,'RECARGOS',v_recargos,v_acumtot with resume;
              end if;
           end if;
       end if;
   end for;
end if;
end if;

end procedure;

CREATE PROCEDURE "informix".admin_verif_cancela_13(pidcobro integer,pfolio varchar(10),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_verif_cancela_13
#  Descripcion:      Interfaz de verificacion de cancelacion del pago de Mercados para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          IVNA DE LA TORRE / SOBRE SP CANCELA DE Benita Cabrera Toscano
#  Fecha:            10 Febrero 2015   
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus,v_statmerc 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag,v_seccion char(2);
define v_cvepago,v_categoria,v_clave_cuota,v_mercado int;
define v_id_modulo    int;
define v_id,v_cvecuenta   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta,v_col,v_obra int;
define v_mes,v_iduser,varpar,v_axop,v_mesp int;
define v_adeudo_id,v_cvecanc int;
define v_res,v_dsd,v_hst int; 
define v_res1 varchar(100);
define v_resto,v_idref,v_pagpar,v_axod,v_mesd,v_axoh,v_mesh,v_cta int;
define v_importe,v_impp,vrenta money(14,2);
define v_superficie decimal(7,2);
define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 --ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de Mercados ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Mercados)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,mesdesde,axodesde,meshasta,axohasta 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_mesd,v_axod,v_mesh,v_axoh
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 11 then
   let v_leyenda = 'EL RECIBO NO ES POR MERCADOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

-- obtiene el datos para calcular la renta
select categoria,seccion,clave_cuota,superficie,num_mercado into
v_categoria,v_seccion,v_clave_cuota,v_superficie,v_mercado
from ta_11_locales where id_local=v_id;

   let v_leyenda = 'PROCEDE PAGO DEL RECIBO';
   let v_estatus = 0;

return v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".admin_verif_cancela_14(p_idcobro int, p_foliorbo varchar(10), p_cajero varchar(08))
                 RETURNING int as sbien, varchar(255) as mensage;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa, par_caja      varchar(30);
define vcvepago     int;
define v_axop,par_control     int;
define v_axof, par_rec,v_idusu     int;
define par_fecp   date;


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en cancelacion de Panteones ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let par_control=0;
let v_idusu=0;

  select nvl(id_regmodulo,0), fecha,id_rec,caja, axodesde,axohasta
  into par_control, par_fecp, par_rec, par_caja,v_axop,v_axof 
  from ta_12_recibos  
--  where fecha>mdy(10,01,2013) and operacion=p_idcobro and cvepago='P' and foliorecibo=p_foliorbo;
  where operacion=p_idcobro and cvepago='P' and foliorecibo=trim(p_foliorbo);

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;


if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if par_control>0 then
   
   return 0,'PROCEDE CANCELACION DEL RECIBO';
else
   return 1,'Pago No encontrado o no Vigente ';

end if;
END PROCEDURE;

CREATE PROCEDURE "informix".admin_verif_cancela_18 ( par_Id_Cobro Integer, par_Folio_rcbo Char(10), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    admin_verif_cancela_18
#  Descripcion:      Interfaz de verificacion de cancelacion para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros        	par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#  de entrada:        	par_Folio_rcbo = Folio del recibo
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:         ivan de la TOrre sobre SP del Gilberto Moreno
#  Fecha:           10 Febrero
#
#  Llamado por:      Procedimiento admin_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_id_usuario	int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 --ROLLBACK WORK;
RETURN -1, 'Error en transaccion de Aseo Contratado ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda    	= 'CANCELACION DE RECIBO Y REACTIVACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************

if exists( SELECT a.* FROM ta_16_pagos a WHERE a.consec_operacion = par_Id_Cobro AND a.folio_rcbo = par_Folio_rcbo AND status_vigencia = 'P'  ) then
       let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
     	let v_estatus  = 0;
	
else
      	let v_leyenda = 'NO EXISTE CONTRATO';
      	let v_estatus  = 1;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "informix".admin_verif_cancela_20(pidcobro integer,pfolio varchar(10),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_verif_cancela_20
#  Descripcion:      Interfaz de verificacion de cancelacion del pago de Convenios de obra publica para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            10 Febrero 2015
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_id   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta int;
define v_mes,v_iduser int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);


define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de Contratos de Obra publica' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Convenio obra publica)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,id_rec_cta 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_id_rec_cta
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 17 then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DE OBRA PUBLICA';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

if (v_id_modulo = 17) and (v_id_rec_cta  not in (16,15,11)) then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DE OBRA PUBLICA';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

 let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
   let v_estatus = 0;

return v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".admin_verif_cancela_22(pidcobro integer,pfolio varchar(10),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_verif_cancela_22
#  Descripcion:      Interfaz de verificacion de cancelacion del pago de Convenios diversos para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre sobre sp de Benita Cabrera Toscano
#  Fecha:            10 Febrero 2015   
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus,v_statmerc 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo    int;
define v_id,v_cvecuenta   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta,v_col,v_obra int;
define v_mes,v_iduser,varpar int;
define v_adeudo_id,v_cvecanc int;
define v_res,v_dsd,v_hst int; 
define v_res1 varchar(100);
define v_resto,v_idref,v_pagpar,v_axod,v_mesd,v_axoh,v_mesh,v_cta int;
define v_importe money(14,2);

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de Convenios diversos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Convenio obra publica)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,id_rec_cta,rfccolonia,obra,mesdesde,axodesde 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_id_rec_cta,v_col,v_obra,v_dsd,v_hst
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 17 then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DIVERSOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

if (v_id_modulo = 17) and (v_id_rec_cta in (16,15,11)) then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DIVERSOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

-- VALIDACION DE TENER UN CERTIFICADO DE NO ADEUDO DENTRO DE EL PERIODO PAGADO EN CONVENIO
if v_obra=1  then
   if exists (select * from catastro_gdl:pagos where recaud = v_rec_pag and caja= v_caja_pag 
              and fecha=v_fecha_pag and folio = pidcobro) then
      select cvepago,cvecuenta into v_cvepago,v_cvecuenta from catastro_gdl:pagos where recaud = v_rec_pag and 
      caja= v_caja_pag and fecha=v_fecha_pag and folio=pidcobro;
      if v_cvepago > 0 then
         select COUNT(A.CVECUENTA) INTO V_CONTAR_CVECUENTA 
         from catastro_gdl:noadeudo a,catastro_gdl:pagos p,catastro_gdl:imprecpre i
         where p.cvecuenta= v_cvecuenta and p.cvepago=v_cvepago and a.cvecuenta=p.cvecuenta
         and i.cvepago=p.cvepago and a.axo=i.axopago and a.bimestre <= i.bimfin
         and a.cvepago > p.cvepago and a.cvepago not in (select cvepago from catastro_gdl:pagos 
         where cvecuenta=v_cvecuenta and cvepago > v_cvepago and cveconcepto=3 and cvecanc is not null);
         if V_CONTAR_CVECUENTA > 0 THEN
            let v_leyenda = 'LA CUENTA PREDIAL TIENE UN CERTIFICADO DE NO ADEUDO DENTRO DEL PERIODO CONVENIADO A CANCELAR';
            let v_estatus = 3;
            RETURN v_estatus,v_leyenda;
         end if;
      end if;
   end if;
end if;

            let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
            let v_estatus = 0;

return v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".admin_verif_cancela_24(p_idcobro int, p_foliorbo varchar(10), p_cajero varchar(08))
                 RETURNING int as sbien, varchar(255) as mensage;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa, par_caja      varchar(30);
define vcvepago,v_idusu     int;
define v_axop,par_control     int;
define v_axof, par_rec     int;
define par_fecp   date;


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'admin_cancela_24 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let par_control=0;
   let v_idusu=0;

  select nvl(id_regmodulo,0), fecha,id_rec,caja, axodesde,axohasta
  into par_control, par_fecp, par_rec, par_caja,v_axop,v_axof 
  from ta_12_recibos  
--  where fecha>mdy(10,01,2013) and operacion=p_idcobro and cvepago='P' and foliorecibo=p_foliorbo;
  where operacion=p_idcobro and cvepago='P' and foliorecibo=p_foliorbo;

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;


if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if par_control>0 then
    	
   return 0,'PROCEDE CANCELACION DEL RECIBO ';
else
   return 1,'Pago No encontrado o no Vigente ';

end if;
END PROCEDURE;

CREATE PROCEDURE "informix".admin_verif_cancela_25 ( par_Id_Cobro Integer, par_Folio_rcbo Char(10), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    admin_verif_cancela_25
#  Descripcion:      Interfaz de pago para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros        	par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#  de entrada:        	par_Folio_rcbo = Folio del recibo
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la Torre sobre sp de Gilberto Moreno
#  Fecha:            10 de Febrero 2015   
#
#  Llamado por:      Procedimiento admin_verf_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus, v_id_34_stat 	int;
define v_id_usuario	int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 --ROLLBACK WORK;
RETURN -1, 'Error en transaccion de Otras Obligaciones ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda    	= 'CANCELACION DE RECIBO Y REACTIVACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
--************************************************************************ STATUS
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
--************************************************************************

if exists( SELECT a.* FROM t34_pagos a, t34_status b WHERE a.operacion = par_Id_Cobro AND a.folio_recibo = par_Folio_rcbo 
	AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('P')  ) then

	let v_leyenda    	= 'PROCEDE CANCELACION DEL RECIBO';
        let v_estatus	= 0;
else
         	let v_leyenda = 'NO EXISTE REGISTRO CON ESTE DATO';
         	let v_estatus  = 1;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "informix".admin_verif_cancela_30(pidcobro integer,pfolio varchar(10),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_verif_cancela_30
#  Descripcion:      Interfaz de cancelacion del pago certificadi de N/Adeudo de Mercados para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la TOrre sobre sp de cancelacion de Benita Cabrera Toscano
#  Fecha:            10 Febrero 2015 
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus,v_statmerc 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag,v_seccion char(2);
define v_cvepago,v_categoria,v_clave_cuota,v_mercado int;
define v_id_modulo    int;
define v_id,v_cvecuenta   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta,v_col,v_obra int;
define v_mes,v_iduser,varpar,v_axop,v_mesp int;
define v_adeudo_id,v_cvecanc int;
define v_res,v_dsd,v_hst int; 
define v_res1 varchar(100);
define v_resto,v_idref,v_pagpar,v_axod,v_mesd,v_axoh,v_mesh,v_cta int;
define v_importe,v_impp,vrenta money(14,2);
define v_superficie decimal(7,2);
define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'Error en cancelacion Certificado de N/A de Mercados ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;
let v_cvepagorbo='';
let v_clave_cuota=0;

--Verifica el tipo de pago (Mercados)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,mesdesde,axodesde,meshasta,axohasta 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_mesd,v_axod,v_mesh,v_axoh
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 11 then
   let v_leyenda = 'EL RECIBO NO ES POR MERCADOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
   let v_estatus = 0;

return v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".admin_verif_terceros_can(pidcobro integer,pfolio varchar(10),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_verif_terceros_can
#  Descripcion:      Interfaz de verificaicon de cancelacion del pago de terceros para admin
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la TOrre sobre SP de cancelacion de Benita Cabrera Toscano
#  Fecha:            10 de Febrero 2015     /     15 agosto 2014   
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_id_modulo int;
define v_id  int;
define v_cvepagorbo CHAR(1);
define v_axo,v_id_rec_cta int;
define v_cvecanc,v_cvepago,v_cvecuenta int;
define v_superficie decimal(7,2);
define v_statusdescto dec(16,2);
define v_msjdescto varchar(100);
DEFINE v_iduser CHAR(8);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de terceros ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica si existe el pago 
if NOT exists (select * from ta_12_recibos where operacion = pidcobro 
               and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

--if v_id_modulo <> 12 then
--   let v_leyenda = 'EL RECIBO NO ES DE TERCEROS';
--   let v_estatus = 3;
--   RETURN v_estatus,v_leyenda;
--end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

select cvepago,cvecuenta into v_cvepago,v_cvecuenta from catastro_gdl:pagos 
where recaud = v_rec_pag and caja= v_caja_pag and fecha=v_fecha_pag and folio=pidcobro;

if v_cvepago > 0 then
   let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
   let v_estatus = 0;
else
   let v_leyenda = 'NO HAY REGISTRO EN BASE CATASTRO';
   let v_estatus = 3;
end if;
return v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".spd_17_adeudo_venc(
parm_alo smallint,
parm_fondo smallint)
returning smallint,
               smallint,
               integer,
               char(60),
               char(11),
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2),
               integer,
               date,
               char(15);
define    v_control integer;
define    v_tipo smallint;
define    v_axo smallint;
define    v_colonia smallint;
define    v_calle smallint;
define    v_folio   integer;
define    v_nombre char(60);
define    v_numero char(11);
define    v_costo money(10,2);
define    v_pago_inicial money(10,2);
define    v_pago_quincenal money(10,2);
define    v_pagos_parciales smallint;
define    v_fecha_firma date;
define    v_pagos money(10,2);
define    v_devolucion money(10,2);
define    v_recargos_conv,v_recargosnvo money(10,2);
define    v_saldo money(10,2);
define    v_importe_venc money(10,2);
define    v_importe_paso money(10,2);
define    v_parc_venc smallint;
define    v_parc_pagos smallint;
define    v_parc_vencimiento smallint;
define    v_id_pago integer;
define    v_id_convenio integer;
define    v_fecha_venc date;
define    v_desc_desc char(15);
define    v_fecha_pago date;
define    v_fecha_pago2 date;
define    v_oficina_pago smallint;
define    v_caja_pago  char(1);
define    v_operacion_pago integer;
define    v_pago_parc smallint;
define    v_total_parc smallint;
define    v_importe  money(10,2);
define    v_cve_descuento smallint;
define    v_cve_descuento2 smallint;
define    v_cve_bonificacion smallint;
define    v_id_usuario integer;
define    v_actual date;
define    v_contador smallint;
define    v_cont smallint;
define    v_parc_hoy integer;
define    v_per_firma integer;
define    v_per_hoy integer;
define    v_per_venc integer;
define    v_axo_firma smallint;
define    v_mes_firma smallint;
define    v_dia_firma smallint;
define    v_axo_hoy smallint;
define    v_mes_hoy smallint;
define    v_dia_hoy smallint;
define    v_clave_hist smallint;
let v_clave_hist=0;
let v_pagos=0;
let v_devolucion=0;
let v_recargos_conv=0;
let v_recargosnvo=0;
let v_saldo=0;
let v_importe_venc=0;
let v_importe_paso=0;
let v_parc_venc=0;
let v_parc_pagos=0;
let v_parc_hoy=0;
let v_contador=0;
foreach
   select a.tipo,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,b.nombre,b.numero,b.pago_total,b.pago_inicial,b.pago_quincenal,b.pagos_parciales,
             b.fecha_firma,b.fecha_vencimiento,sum(c.importe),count(c.id_convenio),sum(c.cve_descuento),max(fecha_pago),b.clave_historia into                         v_tipo,v_axo,v_control,v_colonia,v_calle,v_folio,v_nombre,v_numero,v_costo,v_pago_inicial,v_pago_quincenal,v_pagos_parciales,
            v_fecha_firma,v_fecha_venc,v_pagos,v_contador,v_cve_descuento,v_fecha_pago,v_clave_hist
             from ta_17_calles a,ta_17_convenios b,outer(ta_17_pagos c)
            where a.tipo=parm_fondo 
                and a.axo_obra=parm_alo
                and a.colonia=b.colonia and a.calle=b.calle
                and b.vigencia='A'
                and b.id_convenio=c.id_convenio
                and c.fecha_pago>=b.fecha_firma 
            group by a.tipo,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,b.nombre,b.numero,b.pago_total,b.pago_inicial,b.pago_quincenal,b.pagos_parciales,
             b.fecha_firma,b.fecha_vencimiento,b.clave_historia
            order by b.colonia,b.calle,b.folio
            let v_axo_firma=year(v_fecha_firma);
            let v_mes_firma=month(v_fecha_firma);
            let v_dia_firma=day(v_fecha_firma);
            let v_axo_hoy=year(today);
            let v_mes_hoy=month(today);
            let v_dia_hoy=day(today);
            if   v_pagos is null then
                 let v_pagos=0;
            end if;
            let v_saldo=0;
            let v_devolucion=0;
            let v_recargos_conv=0;
            let v_cve_descuento2=0;
            let v_importe_venc=0;
            let v_importe_paso=0;
            let v_parc_venc=0;
            let v_parc_pagos=0;
            foreach
            select nvl(sum(g.importe),0) into v_recargos_conv from ta_17_convenios h,ta_17_pagos f,ta_12_recibosdet g 
            where h.id_convenio=v_control and f.id_convenio=h.id_convenio and h.clave_historia=2  and f.fecha_pago>=h.fecha_firma 
            and f.fecha_pago<=h.fecha_vencimiento and g.fecha=f.fecha_pago and g.id_rec=f.oficina_pago and g.caja=f.caja_pago and 
            g.operacion=f.operacion_pago and g.cuenta in(46210,570200000)
            end foreach
            let v_pagos=v_pagos+v_recargos_conv;
            if  v_fecha_firma is null then
                 let v_importe_venc=0;
                 let v_parc_venc=0;
            else
                if   v_mes_firma < 10 then
                     let v_per_firma=v_axo_firma || 0 || v_mes_firma;
                else
                     let v_per_firma=v_axo_firma || v_mes_firma;
                end if;
                if   v_mes_hoy < 10 then
                     let v_per_hoy=v_axo_hoy || 0 || v_mes_hoy;
                else 
                     let v_per_hoy=v_axo_hoy || v_mes_hoy;
                end if;
                let v_parc_hoy=0;
                let v_cont=0;
                if   v_clave_hist=2 then
                     let v_parc_vencimiento=v_pagos_parciales;
                else
                     let v_parc_vencimiento=v_pagos_parciales + 1;
                end if;
                for v_cont= 1 to v_parc_vencimiento 
                    if  v_mes_firma =12 then
                        let v_mes_firma =1;
                        let v_axo_firma=v_axo_firma + 1;
                        let v_parc_hoy=v_parc_hoy + 1;
                    else
                        let v_mes_firma=v_mes_firma + 1;
                        if   v_mes_firma < 10 then
                             let v_per_firma=v_axo_firma || 0 || v_mes_firma;
                        else
                             let v_per_firma=v_axo_firma || v_mes_firma;
                        end if;
                        if  v_per_firma = v_per_hoy then
                            if  v_dia_firma < v_dia_hoy then
                                let v_mes_firma=v_mes_firma + 1;
                                let v_parc_hoy=v_parc_hoy + 1;
                            else
                                let v_mes_firma=v_mes_firma + 1; 
                            end if;
                       else
                        if  v_per_firma < v_per_hoy then
                            let v_parc_hoy=v_parc_hoy + 1;
                       end if;    
                       end if;
                   end if;
                end for;
            end if;
            if  v_pagos = 0 then
                let v_parc_pagos=0;
            else
                let v_importe_paso=v_pagos - v_pago_inicial;
                if  v_importe_paso = 0 then
                    let v_parc_pagos=1;
                else
                if  v_importe_paso > 0 then
                    let v_parc_pagos=1;
                    let v_parc_pagos=v_parc_pagos + (v_importe_paso / v_pago_quincenal);
                else
                    let v_parc_pagos=v_parc_pagos + 0;
                end if;
                end if; 
            end if;
            let v_parc_venc=v_parc_hoy - v_parc_pagos;
            if  v_axo<=1995 then
                foreach
                select fecha_pago,sum(cve_descuento) into v_fecha_pago2,v_cve_descuento2 from ta_17_pagos
                where id_convenio=v_control and fecha_pago=v_fecha_pago
                group by fecha_pago
                end foreach
           end if; 
           if  (v_axo <= 1995 and v_cve_descuento2 = 20) then
                let v_saldo=0;
                let v_desc_desc='20% DESCUENTO';
                let v_importe_venc=0;
                let v_parc_venc=0;
           else
           if   (v_contador = 1 and v_cve_descuento = 20) then
                let v_saldo=0;
                let v_desc_desc='20% DESCUENTO';
                let v_importe_venc=0;
                let v_parc_venc=0;
           else
                let v_desc_desc='';
                foreach
                select sum(importe) into v_devolucion from ta_17_devoluciones
                where id_convenio=v_control
                end foreach
                if   v_devolucion is null then
                     let v_devolucion=0;
                end if;
                let v_pagos=v_pagos - v_devolucion;
                let v_saldo=v_costo - v_pagos;
                if   v_saldo < 1 then
                     let v_importe_venc=0;
                     let v_parc_venc=0;
                else                      
                if  v_parc_venc < 1 then
                    let v_parc_venc=0;
                    let v_importe_venc=0;
               else
               if  v_pagos = 0 then
                   let v_importe_venc=v_pago_inicial + (v_pago_quincenal * (v_parc_venc -1));
               else
                   let v_importe_venc=v_pago_quincenal * v_parc_venc;
               end if;
               end if;
               end if;
           end if;
           end if;
return v_colonia,v_calle,v_folio,v_nombre,v_numero,v_costo,v_pagos,v_saldo,v_importe_venc,v_parc_venc,v_fecha_venc,v_desc_desc
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_17_cta_publica(
parm_alo smallint,
parm_fondo smallint)
returning smallint,
               smallint,
               integer,
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2),
               char(50),
               char(50),
               char(1);
define    v_control integer;
define    v_tipo smallint;
define    v_axo smallint;
define    v_colonia smallint;
define    v_calle smallint;
define    v_folio   integer;
define    v_vigencia char(1);
define    v_costo money(10,2);
define    v_pagos_ing money(10,2);
define    v_pagos_dev money(10,2);
define    v_pagos_dif money(10,2);
define    v_pagos_real money(10,2); 
define    v_saldo_real money(10,2);
define    v_desc_col char(50);
define    v_desc_tipo char(50); 
define    v_id_pago integer;
define    v_id_conv_dev integer;
define    v_cve_descuento smallint;
define    v_cve_bonificacion smallint;
define    v_contador smallint;
define    v_cont smallint;
define    v_clave_hist smallint;
define    v_recargos_conv,v_recargosnvo money(10,2);
let v_recargos_conv=0;
let v_recargosnvo=0;
let v_pagos_ing=0;
let v_pagos_dev=0;
let v_pagos_dif=0;
let v_pagos_real=0; 
let v_saldo_real=0;
let v_contador=0;
foreach
   select a.tipo,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,b.pago_total,sum(c.importe),count(c.id_convenio),sum(c.cve_descuento),d.descripcion,e.descripcion,b.vigencia,b.clave_historia into  v_tipo,v_axo,v_control,v_colonia,v_calle,v_folio,v_costo,v_pagos_ing,v_contador,v_cve_descuento,v_desc_col,v_desc_tipo,v_vigencia,v_clave_hist
             from ta_17_calles a,ta_17_convenios b,outer(ta_17_pagos c),ta_17_colonias d,ta_17_tipos e
            where a.tipo=parm_fondo 
                and a.axo_obra=parm_alo
                and a.colonia=b.colonia and a.calle=b.calle
                and b.id_convenio=c.id_convenio
                and c.fecha_pago>=b.fecha_firma
                and a.colonia=d.colonia
                and a.tipo=e.tipo
            group by a.tipo,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,b.pago_total,d.descripcion,e.descripcion,b.vigencia,b.clave_historia
            order by b.colonia,b.calle,b.folio
            if   v_pagos_ing is null then
                 let v_pagos_ing=0;
            end if;
            let v_pagos_dev=0;
            let v_recargos_conv=0;
            foreach
            select nvl(sum(g.importe),0) into v_recargos_conv from ta_17_convenios h,ta_17_pagos f,ta_12_recibosdet g 
            where h.id_convenio=v_control and f.id_convenio=h.id_convenio and h.clave_historia=2  and f.fecha_pago>=h.fecha_firma 
            and f.fecha_pago<=h.fecha_vencimiento and g.fecha=f.fecha_pago and g.id_rec=f.oficina_pago and g.caja=f.caja_pago and 
            g.operacion=f.operacion_pago and g.cuenta in (46210,570200000)
            end foreach
            let v_pagos_ing=v_pagos_ing+v_recargos_conv;
            foreach
            select id_convenio,sum(importe) into v_id_conv_dev,v_pagos_dev
                     from ta_17_devoluciones where id_convenio=v_control
            group by id_convenio     
            end foreach;
            if   (v_contador = 1 and v_cve_descuento = 20) or (v_axo < 1995 and v_cve_descuento = 20) then
                 if  v_pagos_dev > 0 then
                     let v_pagos_dif=0;
                 else    
                     let v_pagos_dif=v_costo - v_pagos_ing;
                 end if;
            else
                 let v_pagos_dif=0; 
            end if;
            let v_pagos_real=((v_pagos_ing - v_pagos_dev) + v_pagos_dif);
            let v_saldo_real=v_costo - v_pagos_real;
return v_colonia,v_calle,v_folio,v_costo,v_pagos_ing,v_pagos_dev,v_pagos_dif,v_pagos_real,v_saldo_real,v_desc_tipo,v_desc_col,v_vigencia
with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_17_est_periodo(
parm_alo smallint,
parm_adeudo money(10,2))
returning smallint,
               char(1),
               smallint,
               smallint,
               money(10,2),
               smallint,
               money(10,2),
               char(15),
               smallint,
               smallint,
               smallint;
define    v_control integer;
define    v_tipo smallint;
define    v_plazo smallint;
define    v_cve_plazo char(1);
define    v_firma smallint;
define    v_axo smallint;
define    v_colonia smallint;
define    v_calle smallint;
define    v_folio   integer;
define    v_vigencia char(15);
define    v_vencimiento date;
define    v_costo money(10,2);
define    v_pagos_ing money(10,2);
define    v_pagos_dev money(10,2);
define    v_pagos_dif money(10,2);
define    v_pagos_real money(10,2); 
define    v_saldo_real money(10,2);
define    v_desc_col char(50);
define    v_desc_tipo char(50); 
define    v_id_pago integer;
define    v_id_conv_dev integer;
define    v_cve_descuento smallint;
define    v_cve_bonificacion smallint;
define    v_contador smallint;
define    v_cont smallint;
define    v_parc_pagos smallint;
define    v_importe_paso money(10,2);
define    v_pago_quincenal money(10,2);
define    v_pago_inicial money(10,2);
define    v_recargos_conv,v_recargosnvo money(10,2);
define    v_clave_hist smallint;
let v_clave_hist=0;
let v_recargos_conv=0;
let v_recargosnvo=0;
let v_pagos_ing=0;
let v_parc_pagos=0;
let v_importe_paso=0;
let v_pagos_dev=0;
let v_pagos_dif=0;
let v_pagos_real=0; 
let v_saldo_real=0;
let v_contador=0;
foreach
   select a.plazo,a.clave_plazo,a.tipo,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,year(b.fecha_firma) Firma,b.fecha_vencimiento,b.pago_total,b.pago_inicial,b.pago_quincenal,sum(c.importe),count(c.id_convenio),sum(c.cve_descuento),e.descripcion,b.vigencia,b.clave_historia into  v_plazo,v_cve_plazo,v_tipo,v_axo,v_control,v_colonia,v_calle,v_folio,v_firma,v_vencimiento,v_costo,v_pago_inicial,v_pago_quincenal,v_pagos_ing,v_contador,v_cve_descuento,v_desc_tipo,v_vigencia,v_clave_hist
             from ta_17_calles a,ta_17_convenios b,outer(ta_17_pagos c),ta_17_tipos e
                where a.axo_obra=parm_alo
                and a.colonia=b.colonia and a.calle=b.calle
                and b.id_convenio=c.id_convenio
                and b.vigencia='A'
                and c.fecha_pago>=b.fecha_firma
                and a.tipo=e.tipo
            group by a.plazo,a.clave_plazo,a.tipo,a.axo_obra,b.id_convenio,b.colonia,b.calle,b.folio,b.fecha_firma,b.fecha_vencimiento,b.pago_total,b.pago_inicial,b.pago_quincenal,e.descripcion,b.vigencia,b.clave_historia
            order by a.plazo,a.clave_plazo,firma,b.colonia,b.calle,b.folio
            if   v_pagos_ing is null then
                 let v_pagos_ing=0;
            end if;
            let v_recargos_conv=0;
            foreach
            select nvl(sum(g.importe),0) into v_recargos_conv from ta_17_convenios h,ta_17_pagos f,ta_12_recibosdet g 
            where h.id_convenio=v_control and f.id_convenio=h.id_convenio and h.clave_historia=2  and f.fecha_pago>=h.fecha_firma 
            and f.fecha_pago<=h.fecha_vencimiento and g.fecha=f.fecha_pago and g.id_rec=f.oficina_pago and g.caja=f.caja_pago and 
            g.operacion=f.operacion_pago and g.cuenta in(46210,570200000)
            end foreach
            let v_pagos_ing=v_pagos_ing+v_recargos_conv;
            if   today > v_vencimiento then
                 let v_vigencia = 'PLAZO VENCIDO';
            else
                 let v_vigencia = 'PLAZO VIGENTE';
            end if;
            let v_pagos_dev=0;
            let v_parc_pagos=0;
            let v_importe_paso=0;
            foreach
            select id_convenio,sum(importe) into v_id_conv_dev,v_pagos_dev
                     from ta_17_devoluciones where id_convenio=v_control
            group by id_convenio     
            end foreach;
            if   v_pagos_dev is null then
                 let v_pagos_dev=0;
            end if;
            if   (v_contador = 1 and v_cve_descuento = 20) or (v_axo < 1995 and v_cve_descuento = 20) then
                 if  v_pagos_dev > 0 then
                     let v_pagos_dif=0;
                 else    
                     let v_pagos_dif=v_costo - v_pagos_ing;
                 end if;
            else
                 let v_pagos_dif=0; 
            end if;
            let v_pagos_real=((v_pagos_ing - v_pagos_dev) + v_pagos_dif);
            if  v_pagos_real = 0 then
                let v_parc_pagos=0;
            else
                let v_importe_paso=v_pagos_real - v_pago_inicial;
                if  v_importe_paso = 0 then
                    let v_parc_pagos=1;
                else
                if  v_importe_paso > 0 then
                    if v_clave_hist=2 then
                       let v_parc_pagos=0;
                    else
                       let v_parc_pagos=1;
                    end if;
                    let v_parc_pagos=v_parc_pagos + (v_importe_paso / v_pago_quincenal);
                else
                    let v_parc_pagos=v_parc_pagos + 0;
                end if;
                end if;
            end if;
            let v_saldo_real=v_costo - v_pagos_real;
if v_saldo_real >= parm_adeudo then
   return v_plazo,v_cve_plazo,v_axo,v_firma,v_costo,v_parc_pagos,v_saldo_real,v_vigencia,v_colonia,v_calle,v_folio
   with resume;
end if;
end foreach;
end procedure;

CREATE PROCEDURE "informix".act_datos_comp_elect(p_fecha date)
returning  int as errores ;
define v_rowid integer ;
define v_recaud integer;
define  v_urbrus char(1) ;
define  v_cuenta integer ;
define v_cvecuenta integer ;
define v_nombre varchar(80) ;
define  v_calleU varchar(80) ; define v_domicilio varchar(80) ; define v_ubicacion varchar(100) ;
define catdescrip varchar(250); define v_error int ;
let v_error = 0;
FOREACH
select rowid , rfcnumero 
into v_rowid , v_cvecuenta 
from ta_12_recibos where fecha = p_fecha    
and id_modulo = 5 and domicilio is null and descripcion is null


 select  a.recaud , a.urbrus , a.cuenta , a.nombre_completo , a.u_calle ,
    trim(nvl(a.c_calle,'.')) || ' # Ext ' || trim(nvl(a.c_noexterior,'.')) || ' # Int ' || trim(nvl(a.c_interior,'.')),
   trim(nvl(a.u_calle,'.')) || ' Ext ' || trim(nvl(a.u_noexterior,'.')) || ' # Int ' || trim(nvl(a.u_interior,'.')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
    trim(nvl(a.u_calle,'.')) || ' Ext ' || trim(nvl(a.u_noexterior,'.')) || ' # Int ' || trim(nvl(a.u_interior,'.'))
   || '@CVECATASTRAL ' || CVECATNVA || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa 
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_calleU , v_domicilio , v_ubicacion,
 catdescrip 
 from catastro_gdl:datos_gralKio a 
 where a.cvecuenta = v_cvecuenta ;
 
 if v_calleU is null  then
    let v_error = v_error +1; 
  else

   update ta_12_recibos 
   set domicilio =  v_ubicacion , descripcion = catdescrip
   where rowid = v_rowid;

end if;

end FOREACH;

return v_error;
end procedure ;

CREATE PROCEDURE "informix".spd_pagpredkio3(
    		parcvecuenta    integer,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		parKiosco	integer,
                parIdTransKio   integer
        )
		returning smallint , char(2), integer, char(28), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int; 
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
          
       RETURN 0,'' , 0 , ' ',0;
  ELIF  v_lError = -236   THEN
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
    --   RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
-- set debug file to "pago13";
-- trace on;
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;

 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo , 
   trim(nvl(a.c_calle,'.')) || ' # Ext ' || trim(nvl(a.c_noexterior,'.')) || ' # Int ' || trim(nvl(a.c_interior,'.')),
   trim(nvl(a.u_calle,'.')) || ' Ext ' || trim(nvl(a.u_noexterior,'.')) || ' # Int ' || trim(nvl(a.u_interior,'.')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
    trim(nvl(a.u_calle,'.')) || ' Ext ' || trim(nvl(a.u_noexterior,'.')) || ' # Int ' || trim(nvl(a.u_interior,'.'))
   || '@CVECATASTRAL ' || CVECATNVA || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa 

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip 

  , v_hora
 from catastro_gdl:datos_gralKio a 
 where a.cvecuenta = parcvecuenta;

  select id_rec , caja  into varrec , varcaja
  
  from ta12_operacKiosco
  where id_usuario = parkiosco; 
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial por Kiosco de la cuenta ' || parcvecuenta , '',parcvecuenta,0,
                0,0,parkiosco,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'Kiosco ' || parkiosco;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1"); 
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)
                
let linea = 1;     
let v_suma =0;

--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
execute procedure  catastro_gdl:kiosco_totalespred_nvo( parcvecuenta , parAxohasta, parMeshasta, 1) 
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 
if v_ob = 'D' then 

insert into ta_12_recibosdet
( fecha ,id_rec , caja , operacion ,linea , descripcion , cuenta ,importe
)
  values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );

     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea +1 ;
 end if;
if v_ob = 'T' then 
  let v_suma = v_importe;
  let linea = linea +1 ;
 if (parImpCertificado - v_suma ) <> 0 then
     insert into ta_12_recibosdet(fecha ,id_rec , caja , operacion ,linea , descripcion , cuenta ,importe)
     values(today ,varrec , varcaja ,  varoperacion , linea , 'AJuste redondeo Kiosco'  ,   550800000 , (parImpCertificado - v_suma) );
  end if;
end if;




end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
 select   s.multa,  s.gasto,  s.multavir 
    into   v_mulpag,  v_gaspag,  v_multasvir 
      from  catastro_gdl:saldos s  where  s.cvecuenta= parcvecuenta;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq) 
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta 
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor , 
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

 execute PROCEDURE catastro_gdl:linea_capturapred(parcvecuenta, p_desde , p_hasta ,
         parImpCertificado, 0,0,0,parImpCertificado , today) 
       into v_lineacapt, v_lineacapt2;
       let estatus = 0;
    execute  PROCEDURE linea_pagok(v_lineacapt2, parKiosco, parImpCertificado, 'K',varcvepago,
             today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje ;
	-- COMMIT WORK;   
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago;
--trace off;
end procedure
;

CREATE PROCEDURE "informix".grafphp_catadeudo(p_reca int , p_tipo char(1) , p_cuenta int)
returning 
money(16,2) as act_impuesto,
money(16,2) as act_imp_descto,
money(16,2) as act_recargos,
money(16,2) as act_rec_descto,
money(16,2) as act_gastos,
money(16,2) as act_multa,
money(16,2) as act_multa_descto,
money(16,2) as act_tot,
money(16,2) as tot_impuesto,
money(16,2) as tot_imp_descto,
money(16,2) as tot_recargos,
money(16,2) as tot_rec_descto,
money(16,2) as tot_tot;

-----------Define las variables de retorno----------------
DEFINE v_act_impuesto money(16,2); 
DEFINE v_act_imp_descto  money(16,2); 
DEFINE v_act_recargos  money(16,2); 
DEFINE v_act_rec_descto  money(16,2); 
DEFINE v_act_gastos  money(16,2); 
DEFINE v_act_multa  money(16,2); 
DEFINE v_act_multa_descto  money(16,2); 
DEFINE v_tot_impuesto  money(16,2); 
DEFINE v_tot_imp_descto  money(16,2); 
DEFINE v_tot_recargos  money(16,2); 
DEFINE v_tot_rec_descto  money(16,2); 
DEFINE v_act_tot money(16,2); 
DEFINE v_tot_tot money(16,2); 


--
define v_cvecuenta int;
define periodo_act int;
define axo_act int;
define bim_act int;

let axo_act = year(today);
let bim_Act = month(today)/2 + 0.5; 
let periodo_Act = (axo_act *10) + bim_Act; 
 
select cvecuenta into v_cvecuenta from catastro_gdl:convcta
 where recaud = p_reca and urbrus = p_tipo and cuenta = p_cuenta;
 execute procedure catastro_gdl:calc_recgos(v_cvecuenta);
 execute procedure catastro_gdl:calc_sdos(v_cvecuenta);
-- Multas y gastos
 select nvl(gasto,0)  , nvl(multa,0) , nvl(multavir,0) 
  into  v_act_gastos ,v_act_multa ,v_act_multa_descto
  from catastro_gdl:saldos where cvecuenta = v_cvecuenta ;

-- adeudos actuales.
select sum(impfac - imppag) , sum(impvir) ,
       sum(recfac - recpag) , sum(recvir) 
  into v_act_impuesto , v_act_imp_descto  , v_act_recargos , v_act_rec_descto
  from catastro_gdl:detsaldos 
  where cvecuenta = v_cvecuenta and saldo > 0 and ((axosal * 10) + bimsal) <= periodo_Act;
--select *   from catastro_gdl:detsaldos 

--adeudos totales.

select sum(impfac - imppag) , sum(impvir), sum(recfac - recpag) , sum(recvir) 
  into v_tot_impuesto , v_tot_imp_descto, v_tot_recargos, v_tot_rec_descto
  from catastro_gdl:detsaldos 
  where cvecuenta = v_cvecuenta and saldo > 0 and ((axosal * 10) + bimsal) <= ((year(today) *10) + 6);


let v_act_tot = (v_act_impuesto - v_act_imp_descto)  + ( v_act_recargos ) + v_act_gastos + (v_act_multa - v_act_multa_descto);
let v_tot_tot = (v_tot_impuesto - v_tot_imp_descto)  + ( v_tot_recargos - v_tot_rec_descto) + v_act_gastos + (v_act_multa - v_act_multa_descto);

return v_act_impuesto , v_act_imp_descto  , v_act_recargos , v_act_rec_descto ,
v_act_gastos ,v_act_multa ,v_act_multa_descto , v_act_tot ,
v_tot_impuesto , v_tot_imp_descto, v_tot_recargos, v_tot_rec_descto ,v_tot_tot ;

end procedure;

create procedure "pgcabrer".spd_17_folreqconv(pmod int,pid int,pfdsd date,pfhst date)
returning   int as folio,
            int as ejecutor,
            date as fecprac,
            char(1) as vigencia,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst,
            date as fecpag,
            varchar(100) as datos;

define vfolio,vcvepago,vaxodsd,vmesdsd,vaxohst,vmeshst,vejec int;
define vfecpra,vfecpag,vfeccan date;
define vvig char(1);
define vdatos varchar(100);
let vdatos='';

if pmod=3 then -- multas municipales
   foreach
   select a.folioreq,a.cvepago,a.fecpract,a.vigencia,a.feccan,b.fecha,a.cveejecut
   into vfolio,vcvepago,vfecpra,vvig,vfeccan,vfecpag,vejec 
   from catastro_gdl:reqmultas a,outer catastro_gdl:pagos b where a.id_multa=pid and b.cvepago=a.cvepago
   if (vvig='V') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,0,0,0,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='P') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,0,0,0,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='C') and (vfecpra<=pfdsd) and 
      ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,0,0,0,0,vfecpag,trim(vdatos) with resume;
   end if;   
   end foreach;
end if;

if pmod=5 then -- predial
   foreach
   select a.folioreq,a.cvepago,a.fecent,a.axoini,a.bimini,a.axofin,a.bimfin,a.vigencia,a.feccan,b.fecha,a.cveejecut
   into vfolio,vcvepago,vfecpra,vaxodsd,vmesdsd,vaxohst,vmeshst,vvig,vfeccan,vfecpag,vejec 
   from catastro_gdl:reqpredial a,outer catastro_gdl:pagos b where a.cvecuenta=pid and b.cvepago=a.cvepago
   let vdatos='';
   if (vvig='V') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='P') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='C') and (vfecpra<=pfdsd) and 
      ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach; 
end if;

if pmod=9 then -- licencias
   foreach
   select a.folioreq,a.cvepago,a.fecprac,a.axoini,a.axofin,a.vigencia,a.feccan,b.fecha,a.cveejecut
   into vfolio,vcvepago,vfecpra,vaxodsd,vaxohst,vvig,vfeccan,vfecpag,vejec 
   from catastro_gdl:reqlicencias a,outer catastro_gdl:pagos b where a.id_licencia=pid and b.cvepago=a.cvepago
   if (vvig='V') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='P') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='C') and (vfecpra<=pfdsd) and 
      ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;

if pmod=10 then -- anuncios
   foreach
   select a.folioreq,a.cvepago,a.fecprac,a.axoini,a.axofin,a.vigencia,a.feccan,b.fecha,a.cveejecut
   into vfolio,vcvepago,vfecpra,vaxodsd,vaxohst,vvig,vfeccan,vfecpag,vejec 
   from catastro_gdl:reqanuncios a,outer catastro_gdl:pagos b where a.id_anuncio=pid and b.cvepago=a.cvepago
   if (vvig='V') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='P') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='C') and (vfecpra<=pfdsd) and 
      ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;

if pmod=11 then -- mercados
   foreach
   select a.folio,a.fecha_practicado,
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   a.vigencia,a.fecha_pago,a.ejecutor
   into vfolio,vfecpra,vaxodsd,vmesdsd,vaxohst,vmeshst,vvig,vfecpag,vejec 
   from ta_15_apremios a where control_otr=pid and modulo=11 
   if (vvig='1') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='2') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='3') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;

if pmod=16 then -- aseo
   foreach
   select a.folio,a.fecha_practicado,
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   a.vigencia,a.fecha_pago,a.ejecutor
   into vfolio,vfecpra,vaxodsd,vmesdsd,vaxohst,vmeshst,vvig,vfecpag,vejec 
   from ta_15_apremios a where control_otr=pid and modulo=16 
   if (vvig='1') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='2') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='3') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;
end procedure;

CREATE PROCEDURE "informix".con16_detcont_03 ( p_Ctrol_aseo Integer, p_Adeudos Char(1), p_Rep Char(1), p_Fecha_fin Char(7))
    RETURNING CHAR(2) as OFNA,               -- RECAUDADORA
              VARCHAR(20) as TIPO_ASEO,    -- TIPO DE ASEO
              INTEGER as NUM_CONTRATO,              -- NUMERO DE CONTRATO
              VARCHAR(200) as NOM_EMPRESA,                 -- A NOMBRE DE QUIEN ESTA EL CONTRATO
              VARCHAR(200) as DOMICILIO,                 -- DOMICILIO
              CHAR(2) as VIGENCIA,               -- VIGENCIA   HASTA AQUI DATOS DEL CONTRATO

              Money(12,2) as ADEUDOS_2007,    -- ADEUDOS 2007
              Money(12,2) as RECARGOS_2007,    -- RECARGOS 2007
              Money(12,2) as ADEUDOS_2008,    -- ADEUDOS 2008
              Money(12,2) as RECARGOS_2008,    -- RECARGOS 2008
              Money(12,2) as ADEUDOS_2009,    -- ADEUDOS 2009
              Money(12,2) as RECARGOS_2009,    -- RECARGOS 2009
              Money(12,2) as ADEUDOS_2010,    -- ADEUDOS 2010
              Money(12,2) as RECARGOS_2010,    -- RECARGOS2010
              Money(12,2) as ADEUDOS_2011,    -- ADEUDOS 2011
              Money(12,2) as RECARGOS_2011,    -- RECARGOS 2011
              Money(12,2) as ADEUDOS_2012,    -- ADEUDOS 2012
              Money(12,2) as RECARGOS_2012,    -- RECARGOS 2012
              Money(12,2) as ADEUDOS_2013,    -- ADEUDOS 2013
              Money(12,2) as RECARGOS_2013,    -- RECARGOS 2013
              Money(12,2) as ADEUDOS_2014,    -- ADEUDOS 2014
              Money(12,2) as RECARGOS_2014,    -- RECARGOS 2014
                      Money(12,2) as ADEUDOS_2015,    -- ADEUDOS 2015
              Money(12,2) as RECARGOS_2015,    -- RECARGOS 2015
              Money(12,2) as GASTOS,    -- TOTAL DE GASTOS
              Money(12,2) as MULTAS,    -- TOTAL DE MULTAS

              varchar(255) as DATOS_DOCTOS;      -- DATOS DE REQUERIMIENTOS

{
#  Procedimiento: Con16_F4DetCont
#  Descripcion:  Genera una consulta del Contrato con control de importe
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#                                        p_Control_adeudo : solo imprime si existe contrato
#  Parametros de salida:   todos los datos del contrato
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec      Integer;
  define v_nombre, v_domicilio, v_tipo_aseo                                         varchar(80);
  define v_tipo_recolec                                                             varchar(20);
  define v_sector, v_status_vigencia                                                Char(1);
  define v_fecha_ini, v_fecha_hora_baja                                             Date;

  define v_importe_multa, v_importe_gastos, v_tot_gastos                            Money(12,2);
  define v_totAdeudos2007, v_TotRecargos2007         Money(12,2);
  define v_totAdeudos2008, v_TotRecargos2008         Money(12,2);
  define v_totAdeudos2009, v_TotRecargos2009         Money(12,2);
  define v_totAdeudos2010, v_TotRecargos2010         Money(12,2);
  define v_totAdeudos2011, v_TotRecargos2011         Money(12,2);
  define v_totAdeudos2012, v_TotRecargos2012         Money(12,2);
  define v_totAdeudos2013, v_TotRecargos2013         Money(12,2);
  define v_totAdeudos2014, v_TotRecargos2014         Money(12,2);
  define v_totAdeudos2015, v_TotRecargos2015         Money(12,2);
  define v_Datos                                     varchar(120);


----------------------
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;
LET v_Datos = '';

FOREACH
       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, 
                  a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja, a.status_vigencia
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, 
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja, v_status_vigencia
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.ctrol_aseo = p_Ctrol_aseo       
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec
       Order by a.num_contrato
       
     FOREACH
                EXECUTE PROCEDURE con16_detade_05 ( v_Control, p_Rep, p_Fecha_fin) 
                               INTO v_totAdeudos2007, v_TotRecargos2007, 
                                               v_totAdeudos2008, v_TotRecargos2008, 
                                               v_totAdeudos2009, v_TotRecargos2009, 
                                               v_totAdeudos2010, v_TotRecargos2010, 
                                               v_totAdeudos2011, v_TotRecargos2011, 
                                               v_totAdeudos2012, v_TotRecargos2012, 
                                               v_totAdeudos2013, v_TotRecargos2013, 
                                               v_totAdeudos2014, v_TotRecargos2014, 
                                               v_totAdeudos2015, v_TotRecargos2015, 
                                                                                              v_importe_multa, v_tot_gastos, v_Datos
     END FOREACH;

IF p_Adeudos = 'S' THEN  -- CON ADEUDO ALGUNO
  IF (v_totAdeudos2007 <> 0 or v_TotRecargos2007 <> 0 or
       v_totAdeudos2008 <> 0 or v_TotRecargos2008 <> 0 or
       v_totAdeudos2009 <> 0 or v_TotRecargos2009 <> 0 or 
       v_totAdeudos2010 <> 0 or v_TotRecargos2010 <> 0 or 
       v_totAdeudos2011 <> 0 or v_TotRecargos2011 <> 0 or
       v_totAdeudos2012 <> 0 or v_TotRecargos2012 <> 0 or 
       v_totAdeudos2013 <> 0 or v_TotRecargos2013 <> 0 or 
       v_totAdeudos2014 <> 0 or v_TotRecargos2014 <> 0 or
       v_totAdeudos2015 <> 0 or v_TotRecargos2015 <> 0 or         
       v_importe_multa <> 0 or v_tot_gastos <> 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2009, v_TotRecargos2009, 
                               v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2012, v_TotRecargos2012, 
                                       v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2015, v_TotRecargos2015,
                                                                                              v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'R' THEN  -- CON SOLO ADEUDOS DE PERIODOS Y REQUERIMIENTOS EN CEROS
  IF ((v_totAdeudos2007 <> 0) or (v_TotRecargos2007 <> 0) or
       (v_totAdeudos2008 <> 0) or (v_TotRecargos2008 <> 0) or
       (v_totAdeudos2009 <> 0) or (v_TotRecargos2009 <> 0) or 
       (v_totAdeudos2010 <> 0) or (v_TotRecargos2010 <> 0) or 
       (v_totAdeudos2011 <> 0) or (v_TotRecargos2011 <> 0) or
       (v_totAdeudos2012 <> 0) or (v_TotRecargos2012 <> 0) or
       (v_totAdeudos2013 <> 0) or (v_TotRecargos2013 <> 0) or 
       (v_totAdeudos2014 <> 0) or (v_TotRecargos2014 <> 0) or 
       (v_totAdeudos2015 <> 0) or (v_TotRecargos2015 <> 0)) AND
      ( v_importe_multa = 0 AND v_tot_gastos = 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2009, v_TotRecargos2009, 
                               v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2012, v_TotRecargos2012, 
                                       v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2015, v_TotRecargos2015,
                                                                                              v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'U' THEN  -- CON SOLO ADEUDOS DE REQUERIMIENTOS Y PERIODOS EN CEROS
  IF (v_totAdeudos2007 = 0 AND v_TotRecargos2007 = 0 AND
       v_totAdeudos2008 = 0 AND v_TotRecargos2008 = 0 AND
       v_totAdeudos2009 = 0 AND v_TotRecargos2009 = 0 AND 
       v_totAdeudos2010 = 0 AND v_TotRecargos2010 = 0 AND 
       v_totAdeudos2011 = 0 AND v_TotRecargos2011 = 0 AND
       v_totAdeudos2012 = 0 AND v_TotRecargos2012 = 0 AND 
       v_totAdeudos2013 = 0 AND v_TotRecargos2013 = 0 AND 
       v_totAdeudos2014 = 0 AND v_TotRecargos2014 = 0 AND
       v_totAdeudos2015 = 0 AND v_TotRecargos2015 = 0) AND 
       ((v_importe_multa <> 0) OR (v_tot_gastos <> 0))  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2009, v_TotRecargos2009, 
                               v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2012, v_TotRecargos2012, 
                                       v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2015, v_TotRecargos2015, 
                                                                                              v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'W' THEN  -- SIN ADEUDO ALGUNO
  IF (v_totAdeudos2007 = 0 AND v_TotRecargos2007 = 0 AND
       v_totAdeudos2008 = 0 AND v_TotRecargos2008 = 0 AND
       v_totAdeudos2009 = 0 AND v_TotRecargos2009 = 0 AND 
       v_totAdeudos2010 = 0 AND v_TotRecargos2010 = 0 AND 
       v_totAdeudos2011 = 0 AND v_TotRecargos2011 = 0 AND
       v_totAdeudos2012 = 0 AND v_TotRecargos2012 = 0 AND 
       v_totAdeudos2013 = 0 AND v_TotRecargos2013 = 0 AND 
       v_totAdeudos2014 = 0 AND v_TotRecargos2014 = 0 AND
       v_totAdeudos2015 = 0 AND v_TotRecargos2015 = 0 AND 
       v_importe_multa = 0     AND v_tot_gastos = 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2009, v_TotRecargos2009, 
                               v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2012, v_TotRecargos2012, 
                                       v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2015, v_TotRecargos2015, 
                                                                                              v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'T' THEN  -- TODOS
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
                           v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2009, v_TotRecargos2009, 
                               v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2012, v_TotRecargos2012, 
                                       v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2015, v_TotRecargos2015, 
                                                                                              v_importe_multa, v_tot_gastos, v_Datos  with resume;
END IF;

Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;
LET v_Datos = '';

END FOREACH;

end procedure;

CREATE PROCEDURE "pgmoreno".con34_gpagado_01 ( p_Control Integer, par_Axo Integer, par_Mes Integer )
{######################################################################
#  Procedimiento:    con34_GPagado_01
#  Descripcion:      Interfaz de consulta de detalle Adeudos por contrato de OTRAS OBLIGACIONES
#
#  Parametros         p_Control  = Id del Registro de Control
#  de entrada:        p_Axo      = Axo de Corte
#                     p_Mes 	 = Mes de Corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning Money(12,2) as Adeudos_pagados,
                          Money(12,2) as Recargos_pagados,
                          Money(12,2) as DesctoRgos_pagados;
                                                                                        
  define v_Adeudos_pagados, v_Recargos_pagados, v_DesctoRgos_pagados			Money(12,2);
  define v_TotAdeudos_pagados, v_TotRecargos_pagados, v_TotDesctoRgos_pagados		Money(12,2);
  
  
LET v_Adeudos_pagados = 0;
LET v_Recargos_pagados = 0;
LET v_DesctoRgos_pagados = 0;

LET v_TotAdeudos_pagados = 0;
LET v_TotRecargos_pagados = 0;
LET v_TotDesctoRgos_pagados = 0;


	FOREACH 
 
	SELECT a.importe, a.recargo  INTO v_Adeudos_pagados, v_Recargos_pagados
	FROM t34_pagos a, t34_status b    
	WHERE a.id_datos = p_Control  AND a.periodo <= par_Axo || '-' || par_Mes
	AND b.id_34_stat = a.id_stat  AND b.cve_tab = 'E'  AND b.cve_stat in ('P')
	ORDER BY a.periodo

		LET v_TotAdeudos_pagados = v_TotAdeudos_pagados + v_Adeudos_pagados;
		LET v_TotRecargos_pagados = v_TotRecargos_pagados + v_Recargos_pagados;

	LET v_Adeudos_pagados = 0;
	LET v_Recargos_pagados = 0;
	END FOREACH;

        return  v_TotAdeudos_pagados, v_TotRecargos_pagados, v_TotDesctoRgos_pagados   with resume;

end procedure;

CREATE PROCEDURE "informix".linea_cargax(
    p_linea VARCHAR(50),
    p_recaud INT,
    p_fecha_pagobco DATE,
    p_pagado MONEY(16,2),
    p_forma_carga CHAR(1),
    p_bco_recibo VARCHAR(100),
    p_bco_suc VARCHAR(30),
    p_bco_caj VARCHAR(30),
    p_bco_oper VARCHAR(30),
    p_bco_lineatxt VARCHAR(255),
    p_usuario CHAR(8)
)
--** Carga de la linea de captura ya sea por banco o de forma individual por cajero en recaudadoras
--** p_recaud es el numero de banco que se le asigno en C_recaud 100-119
--** Forma de carga C=Cajas Recaudadora, A=Archivo Banco
--** p_bco_recibo,p_bco_suc,p_bco_caj,p_bco_oper datos de recibo bancario si cuenta con ellos o vacios
--** p_bco_lineatxt es la linea completa del archivo, vacio se es por caja
--** ESTATUS para linea_pago C=carga, A=aplicado, N=conciliado sin error, D=diferencia en importes 
returning int,varchar(200);
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_id int;
define v_linea VARCHAR(50);
define v_id_linea int;
define v_folio int;
define v_foliotrans int;
define v_modulo int;
define v_id_cont int;
define v_estatus char(1);
define v_fecha_pago date;
define v_fecha_impresion datetime year to second;
define v_importe money(16,2);
define v_difimp money(16,2);
define v_cvepago char(1);
define v_importe_conc money(16,2);
define v_fecha_concilia datetime year to second;
define v_recppag  money(16,2);
define v_imppag  money(16,2);
define v_multa  money(16,2);
define v_gasto money(16,2);
define v_axodesde int;
define v_axohasta int;
define v_bimdesde int;
define v_bimhasta int;
define v_lrecargos  money(16,2);
define v_limpuestos  money(16,2);
define v_lmultas  money(16,2);
define v_lgastos money(16,2);
define v_clavepago int;
define v_folioanun int;
define v_impformas  money(16,2);

define v_difimpl money(16,2);
define v_difimpp money(16,2);

--set debug file to "lineacarga.log";
--   trace on;
--** Obtener datos de la linea de captura
--3538 4610 9610 0000 0101 8512 1278 '0000070000000000011285116291'
--select * from linea_capturadiv where trim(linea) = trim('0000070000000000011285116291')

let v_modulo = substr(p_linea,19,2)*1;
let v_difimp = 0;
let v_difimpl = 0;
let v_difimpp = 0;
------------------------------------------------------------------------------------------------------------------
if v_modulo = 1 then --predial
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturapred where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO EXISTE";
   end if;
   --obtener los datos del registro de predial  
   select id,linea,cvecuenta,total,substr(desde,2,2)*1,substr(hasta,2,2)*1,substr(desde,1,1)*1,substr(hasta,1,1)*1 ,
          recargos,impuestos,gastos,multas into 
	  v_id_linea,v_linea,v_folio,v_importe,v_axodesde ,v_axohasta,v_bimdesde,v_bimhasta,
          v_lrecargos,v_limpuestos,v_lgastos,v_lmultas  
          from catastro_gdl:linea_capturapred where linea = p_linea;  

   if v_axodesde > 80 then
      let v_axodesde = v_axodesde + 1900;
   else  
      let v_axodesde = v_axodesde + 2000;
   end if;
   if v_axohasta > 80 then
      let v_axohasta = v_axohasta + 1900;
   else  
      let v_axohasta = v_axohasta + 2000;
   end if;
   --calcula si es el primer bimestre
   --if p_fecha_pagobco >= "01/01/2014" and p_fecha_pagobco <= "28/02/2014" then
   if p_fecha_pagobco >= TO_DATE("01/01/"||year(today),"%d/%m/%Y") and p_fecha_pagobco <= LAST_DAY(DATE(TO_DATE("01/02/"||year(today),"%d/%m/%Y"))) then
      execute procedure catastro_gdl:calc_dppban(v_folio);
   else
      execute procedure catastro_gdl:gen_sdoscaja(v_folio);
   end if;
--  Dejar pasar el pago aunque tenga diferencias, para que se cargue a pagos
--   if v_importe <> p_pagado then
--         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
--   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa la informacion de saldos
      if exists (SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  

			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4) then
	if v_bimhasta = 6 then
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         else
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         end if;
-- Se verifica como diferencia en importe
--         if v_imppag = 0 then
--            return 5,"LA CUENTA PREDIAL NO TIENE SALDO";
--         end if;
         let estatus = 0;
         let mensaje = "CUENTA PREDIAL CON SALDO";
         if v_importe <> p_pagado then
            let v_difimpp = v_importe - p_pagado;
            let v_estatus = "D";
            let estatus = 1;
	    let mensaje = "IMPORTE DE LINEA DE CAPTURA INCORRECTO";
         else
           if (v_imppag <> v_limpuestos) then
	    let v_difimpl = v_imppag - v_limpuestos;
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN IMPORTE";
             if v_imppag = 0 then
                let estatus = 5;
	        let mensaje = "LA CUENTA PREDIAL NO TIENE SALDO";
             end if; 
           else   
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
           end if;
         end if; 
         if v_multa <> v_lmultas then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN MULTAS";
         else
            if v_estatus <> "D" then
               let v_estatus = "N";
	       let v_fecha_concilia = current;
               let estatus = 0;
	       let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
	    end if;
         end if;
         if v_gasto <> v_lgastos then
            let v_estatus = "D";
            let estatus = 6;
            let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN GASTOS";
         else
            if v_estatus <> "D" then
               let v_estatus = "N";
	       let v_fecha_concilia = current;
               let estatus = 0;
	       let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
            end if;
         end if;
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL PREDIAL";
      end if; --existe en SALDOS

   else --si no esta cargada la linea de captura en pagos
      if exists (SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4) then
	if v_bimhasta = 6 then
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         else
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         end if;
--         if v_imppag = 0 then
--            return 5,"LA CUENTA PREDIAL NO TIENE SALDO";
--         end if;
         let estatus = 0;
         let mensaje = "CUENTA PREDIAL CON SALDO";
	 let v_difimp = (v_imppag + v_multa + v_gasto)  - (v_limpuestos+v_lgastos+v_lmultas);
         if v_importe <> p_pagado then --dif en linea y pagado en bco
            let v_estatus = "D";
            let estatus = 1;
	    let mensaje = "IMPORTE DE LINEA DE CAPTURA INCORRECTO";
         else
          --verifica la direfencia de importes en linea vs adeudo actual, dif en linea de captura o importe pagado
          if ((v_difimp <> 0) or (v_difimpp <> 0) or (v_difimpl <> 0)) then
            --se actualiza la variable que regresa el procedimiento con la diferencia en cualquier caso
            if (v_difimpp <> 0) then
		let v_difimp = v_difimpp;
            end if;
            if (v_difimpl <> 0) then
		let v_difimp = v_difimpl;
            end if;
            let v_estatus = "D";
	    let	v_fecha_concilia = null;
            let estatus = 6;
	    let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN IMPORTE";
          else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
          end if; --v_importe <> p_pagado
         end if; -- dif en linea de cap 
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
	 let v_difimp =v_importe - p_pagado;
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,"D",0 ,null,0 ,"" ,0 ,p_usuario);
         return 7,"NO EXISTE EL SALDO DEL PREDIAL";
      end if; --existe en SALDOS
   end if;--no existe linea captura en pagos
end if; --modulo 01 predial
------------------------------------------------------------------------------------------------------------------
if v_modulo = 2 then --transmisiones
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturatrans where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE TRANSMISION NO EXISTE";
   end if;
   --obtener los datos del registro de transmision
   select id,linea,cvecuenta,folio,total,impuesto into 
	  v_id_linea,v_linea,v_folio,v_foliotrans,v_importe,v_limpuestos  
          from catastro_gdl:linea_capturatrans where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE TRANSMISION ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa la informacion de TRANSMISIONES
      if exists (SELECT * FROM catastro_gdl:impuestotransp where folio=v_foliotrans) then
	 SELECT imptopagar into v_imppag FROM catastro_gdl:impuestotransp where folio=v_foliotrans;
	 select nvl(cvepago,0) into v_clavepago FROM catastro_gdl:ACTOSTRANSM where folio=v_foliotrans;
         if v_clavepago > 0 then
            return 3,"LA TRANSMISION YA HA SIDO PAGADA";
         end if;
         let estatus = 0;
         let mensaje = "TRANSMISION CON ADEUDO";
         if v_imppag <> v_limpuestos then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA TRANSMISION TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "TRANSMISION CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL PREDIAL";
      end if; --existe en transmisiones

   else --si no esta cargada la linea de captura en pagos
      if exists (SELECT * FROM catastro_gdl:impuestotransp where folio=v_foliotrans) then
	 SELECT imptopagar into v_imppag FROM catastro_gdl:impuestotransp where folio=v_foliotrans;
	 select nvl(cvepago,0) into v_clavepago FROM catastro_gdl:ACTOSTRANSM where folio=v_foliotrans;

         if v_clavepago > 0 then
            return 3,"LA TRANSMISION YA HA SIDO PAGADA";
         end if;
         let estatus = 0;
         let mensaje = "TRANSMISION CON ADEUDO";
	 let v_difimp = v_imppag  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA TRANSMISION TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "TRANSMISION CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 

         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE LA TRANSMISION";
      end if; --existe en TRANSMISIONES
   end if;--no existe linea captura en pagos
end if; --modulo 02 transmisiones
------------------------------------------------------------------------------------------------------------------
if v_modulo = 8 then --licencias
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturalic where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE LICENCIA NO EXISTE";
   end if;
   --obtener los datos del registro de licencias
   select id,linea,licencia,anuncio,total,imp_derechos+imp_formas into 
	  v_id_linea,v_linea,v_folio,v_folioanun,v_importe,v_limpuestos  
          from catastro_gdl:linea_capturalic where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa la informacion de LICENCIAS
      if v_folio > 0 then --es licencia
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_licencia in 
			(select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_licencia in
		 (select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "LICENCIA CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA LICENCIA TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "LICENCIA CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL LICENCIAS";
      end if; --existe en LICENCIAS
      end if; --es licenciA
      if v_folioanun > 0 then --es anuncio
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_anuncio in 
			(select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_anuncio in
		 (select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "ANUNCIO CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA ANUNCIO TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "ANUNCIO CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL ANUNCIO";
      end if; --existe en ANUNCIO
      end if; --es ANUNCIO

   else --si no esta cargada la linea de captura en pagos
      if v_folio > 0 then --es licencia
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_licencia in 
			(select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_licencia in
		 (select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "LICENCIA CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA LICENCIA TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "LICENCIA CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL LICENCIAS";
      end if; --existe en LICENCIAS
      end if; --es licencia
      if v_folioanun > 0 then --es anuncio
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_anuncio in 
			(select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_anuncio in
		 (select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "ANUNCIO CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA ANUNCIO TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "ANUNCIO CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL ANUNCIO";
      end if; --existe en ANUNCIO
      end if; --es ANUNCIO
   end if;--no existe linea captura en pagos
end if; --modulo 08 licencias
------------------------------------------------------------------------------------------------------------------
if v_modulo = 12 then
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from linea_capturadiv where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE DIVERSOS NO EXISTE";
   end if;
   --obtener los datos del registro de diversos  
   select id,linea,modulo,folio,total into 
	  v_id_linea,v_modulo,v_folio,v_importe,v_linea 
          from linea_capturadiv where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliaciada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE DIVERSOS ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa el estatus del recibo de diversos
      if exists (select * from ta_12_recibosdiv where id_recibo=v_folio) then
	 select importe,cvepago into v_importe,v_cvepago  from ta_12_recibosdiv where id_recibo=v_folio; 
         if v_cvepago = "P" then
            return 5,"EL RECIBO DE DIVERSOS YA FUE PAGADO";
         end if;
         let estatus = 0;
         let mensaje = "EL RECIBO DE DIVERSOS YA EXISTE";
         if v_importe <> p_pagado then
            let v_estatus = "D";
	    let	v_fecha_concilia = null;
            let estatus = 6;
	    let mensaje = "EL RECIBO DE DIVERSOS TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "RECIBO DE DIVERSOS CONCILIADO, PROCEDE APLICACION DE PAGO";
         end if; --v_importe <> p_pagado
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = v_fecha_concilia,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"EL RECIBO DE DIVERSOS NO EXISTE";
      end if; --existe en recibosdiv

   else --si no esta cargada la linea de captura en pagos
      if exists (select * from ta_12_recibosdiv where id_recibo=v_folio) then
	 select importe,cvepago into v_importe,v_cvepago  from ta_12_recibosdiv where id_recibo=v_folio; 
         let v_estatus = "C"; -- cargado
         let estatus = 0;
         let mensaje = "EL RECIBO DE DIVERSOS YA FUE PAGADO";
         if v_cvepago = "P" then
	    let estatus = 5;
            let mensaje = "EL RECIBO DE DIVERSOS YA FUE PAGADO";
	    return estatus,mensaje;
         end if;
         if v_importe <> p_pagado then
            let v_estatus = "D";
	    let	v_fecha_concilia = null;
            let estatus = 6;
	    let mensaje = "EL RECIBO DE DIVERSOS TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "RECIBO DE DIVERSOS CONCILIADO, PROCEDE APLICACION DE PAGO";
         end if; --v_importe <> p_pagado
	 let v_difimp = v_importe - p_pagado;
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,null ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"EL RECIBO DE DIVERSOS NO EXISTE";
      end if; --existe en recibosdiv
   end if;--no existe linea captura en pagos
end if; --modulo 12
--trace off;
end procedure;

CREATE PROCEDURE "informix".linea_carga(
    p_linea VARCHAR(50),
    p_recaud INT,
    p_fecha_pagobco DATE,
    p_pagado MONEY(16,2),
    p_forma_carga CHAR(1),
    p_bco_recibo VARCHAR(100),
    p_bco_suc VARCHAR(30),
    p_bco_caj VARCHAR(30),
    p_bco_oper VARCHAR(30),
    p_bco_lineatxt VARCHAR(255),
    p_usuario CHAR(8)
)
--** Carga de la linea de captura ya sea por banco o de forma individual por cajero en recaudadoras
--** p_recaud es el numero de banco que se le asigno en C_recaud 100-119
--** Forma de carga C=Cajas Recaudadora, A=Archivo Banco
--** p_bco_recibo,p_bco_suc,p_bco_caj,p_bco_oper datos de recibo bancario si cuenta con ellos o vacios
--** p_bco_lineatxt es la linea completa del archivo, vacio se es por caja
--** ESTATUS para linea_pago C=carga, A=aplicado, N=conciliado sin error, D=diferencia en importes 
returning int,varchar(200);
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_id int;
define v_linea VARCHAR(50);
define v_id_linea int;
define v_folio int;
define v_foliotrans int;
define v_modulo int;
define v_id_cont int;
define v_estatus char(1);
define v_fecha_pago date;
define v_fecha_impresion datetime year to second;
define v_importe money(16,2);
define v_difimp money(16,2);
define v_cvepago char(1);
define v_importe_conc money(16,2);
define v_fecha_concilia datetime year to second;
define v_recppag  money(16,2);
define v_imppag  money(16,2);
define v_multa  money(16,2);
define v_gasto money(16,2);
define v_axodesde int;
define v_axohasta int;
define v_bimdesde int;
define v_bimhasta int;
define v_lrecargos  money(16,2);
define v_limpuestos  money(16,2);
define v_lmultas  money(16,2);
define v_lgastos money(16,2);
define v_clavepago int;
define v_folioanun int;
define v_impformas  money(16,2);

define v_difimpl money(16,2);
define v_difimpp money(16,2);

--set debug file to "lineacarga.log";
--   trace on;
--** Obtener datos de la linea de captura
--3538 4610 9610 0000 0101 8512 1278 '0000070000000000011285116291'
--select * from linea_capturadiv where trim(linea) = trim('0000070000000000011285116291')

let v_modulo = substr(p_linea,19,2)*1;
let v_difimp = 0;
let v_difimpl = 0;
let v_difimpp = 0;
------------------------------------------------------------------------------------------------------------------
if v_modulo = 1 then --predial
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturapred where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO EXISTE";
   end if;
   --obtener los datos del registro de predial  
   select id,linea,cvecuenta,total,substr(desde,2,2)*1,substr(hasta,2,2)*1,substr(desde,1,1)*1,substr(hasta,1,1)*1 ,
          recargos,impuestos,gastos,multas into 
	  v_id_linea,v_linea,v_folio,v_importe,v_axodesde ,v_axohasta,v_bimdesde,v_bimhasta,
          v_lrecargos,v_limpuestos,v_lgastos,v_lmultas  
          from catastro_gdl:linea_capturapred where linea = p_linea;  

   if v_axodesde > 80 then
      let v_axodesde = v_axodesde + 1900;
   else  
      let v_axodesde = v_axodesde + 2000;
   end if;
   if v_axohasta > 80 then
      let v_axohasta = v_axohasta + 1900;
   else  
      let v_axohasta = v_axohasta + 2000;
   end if;
   --calcula si es el primer bimestre
   --if p_fecha_pagobco >= "01/01/2014" and p_fecha_pagobco <= "28/02/2014" then
   if p_fecha_pagobco >= TO_DATE("01/01/"||year(today),"%d/%m/%Y") and p_fecha_pagobco <= LAST_DAY(DATE(TO_DATE("01/02/"||year(today),"%d/%m/%Y"))) then
      execute procedure catastro_gdl:calc_dppban(v_folio);
   else
      execute procedure catastro_gdl:gen_sdoscaja(v_folio);
   end if;
--  Dejar pasar el pago aunque tenga diferencias, para que se cargue a pagos
--   if v_importe <> p_pagado then
--         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
--   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa la informacion de saldos
      if exists (SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  

			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4) then
	if v_bimhasta = 6 then
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         else
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         end if;
-- Se verifica como diferencia en importe
--         if v_imppag = 0 then
--            return 5,"LA CUENTA PREDIAL NO TIENE SALDO";
--         end if;
         let estatus = 0;
         let mensaje = "CUENTA PREDIAL CON SALDO";
         if v_importe <> p_pagado then
            let v_difimpp = v_importe - p_pagado;
            let v_estatus = "D";
            let estatus = 1;
	    let mensaje = "IMPORTE DE LINEA DE CAPTURA INCORRECTO";
         else
           if (v_imppag <> v_limpuestos) then
	    let v_difimpl = v_imppag - v_limpuestos;
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN IMPORTE";
             if v_imppag = 0 then
                let estatus = 5;
	        let mensaje = "LA CUENTA PREDIAL NO TIENE SALDO";
             end if; 
           else   
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
           end if;
         end if; 
         if v_multa <> v_lmultas then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN MULTAS";
         else
            if v_estatus <> "D" then
               let v_estatus = "N";
	       let v_fecha_concilia = current;
               let estatus = 0;
	       let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
	    end if;
         end if;
         if v_gasto <> v_lgastos then
            let v_estatus = "D";
            let estatus = 6;
            let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN GASTOS";
         else
            if v_estatus <> "D" then
               let v_estatus = "N";
	       let v_fecha_concilia = current;
               let estatus = 0;
	       let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
            end if;
         end if;
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL PREDIAL";
      end if; --existe en SALDOS

   else --si no esta cargada la linea de captura en pagos
      if exists (SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4) then
	if v_bimhasta = 6 then
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         else
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         end if;
--         if v_imppag = 0 then
--            return 5,"LA CUENTA PREDIAL NO TIENE SALDO";
--         end if;
         let estatus = 0;
         let mensaje = "CUENTA PREDIAL CON SALDO";
	 let v_difimp = (v_imppag + v_multa + v_gasto)  - (v_limpuestos+v_lgastos+v_lmultas);
         if v_importe <> p_pagado then --dif en linea y pagado en bco
            let v_estatus = "D";
            let estatus = 1;
	    let mensaje = "IMPORTE DE LINEA DE CAPTURA INCORRECTO";
         else
          --verifica la direfencia de importes en linea vs adeudo actual, dif en linea de captura o importe pagado
          if ((v_difimp <> 0) or (v_difimpp <> 0) or (v_difimpl <> 0)) then
            --se actualiza la variable que regresa el procedimiento con la diferencia en cualquier caso
            if (v_difimpp <> 0) then
		let v_difimp = v_difimpp;
            end if;
            if (v_difimpl <> 0) then
		let v_difimp = v_difimpl;
            end if;
            let v_estatus = "D";
	    let	v_fecha_concilia = null;
            let estatus = 6;
	    let mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN IMPORTE";
          else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "CUENTA DE PREDIAL CONCILIADA, PROCEDE APLICACION DE PAGO";
          end if; --v_importe <> p_pagado
         end if; -- dif en linea de cap 
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
	 let v_difimp =v_importe - p_pagado;
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,"D",0 ,null,0 ,"" ,0 ,p_usuario);
         return 7,"NO EXISTE EL SALDO DEL PREDIAL";
      end if; --existe en SALDOS
   end if;--no existe linea captura en pagos
end if; --modulo 01 predial
------------------------------------------------------------------------------------------------------------------
if v_modulo = 2 then --transmisiones
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturatrans where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE TRANSMISION NO EXISTE";
   end if;
   --obtener los datos del registro de transmision
   select id,linea,cvecuenta,folio,total,impuesto into 
	  v_id_linea,v_linea,v_folio,v_foliotrans,v_importe,v_limpuestos  
          from catastro_gdl:linea_capturatrans where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE TRANSMISION YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE TRANSMISION ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa la informacion de TRANSMISIONES
      if exists (SELECT * FROM catastro_gdl:impuestotransp where folio=v_foliotrans) then
	 SELECT imptopagar into v_imppag FROM catastro_gdl:impuestotransp where folio=v_foliotrans;
	 select nvl(cvepago,0) into v_clavepago FROM catastro_gdl:ACTOSTRANSM where folio=v_foliotrans;
         if v_clavepago > 0 then
            return 3,"LA TRANSMISION YA HA SIDO PAGADA";
         end if;
         let estatus = 0;
         let mensaje = "TRANSMISION CON ADEUDO";
         if v_imppag <> v_limpuestos then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA TRANSMISION TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "TRANSMISION CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL PREDIAL";
      end if; --existe en transmisiones

   else --si no esta cargada la linea de captura en pagos
      if exists (SELECT * FROM catastro_gdl:impuestotransp where folio=v_foliotrans) then
	 SELECT imptopagar into v_imppag FROM catastro_gdl:impuestotransp where folio=v_foliotrans;
	 select nvl(cvepago,0) into v_clavepago FROM catastro_gdl:ACTOSTRANSM where folio=v_foliotrans;

         if v_clavepago > 0 then
            return 3,"LA TRANSMISION YA HA SIDO PAGADA";
         end if;
         let estatus = 0;
         let mensaje = "TRANSMISION CON ADEUDO";
	 let v_difimp = v_imppag  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA TRANSMISION TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "TRANSMISION CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 

         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE LA TRANSMISION";
      end if; --existe en TRANSMISIONES
   end if;--no existe linea captura en pagos
end if; --modulo 02 transmisiones
------------------------------------------------------------------------------------------------------------------
if v_modulo = 8 then --licencias
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturalic where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE LICENCIA NO EXISTE";
   end if;
   --obtener los datos del registro de licencias
   select id,linea,licencia,anuncio,total,imp_derechos+imp_formas into 
	  v_id_linea,v_linea,v_folio,v_folioanun,v_importe,v_limpuestos  
          from catastro_gdl:linea_capturalic where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,l.estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos l where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE LICENCIA/ANUNCIO ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa la informacion de LICENCIAS
      if v_folio > 0 then --es licencia
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_licencia in 
			(select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_licencia in
		 (select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "LICENCIA CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA LICENCIA TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "LICENCIA CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL LICENCIAS";
      end if; --existe en LICENCIAS
      end if; --es licenciA
      if v_folioanun > 0 then --es anuncio
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_anuncio in 
			(select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_anuncio in
		 (select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "ANUNCIO CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA ANUNCIO TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "ANUNCIO CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = current,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL ANUNCIO";
      end if; --existe en ANUNCIO
      end if; --es ANUNCIO

   else --si no esta cargada la linea de captura en pagos
      if v_folio > 0 then --es licencia
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_licencia in 
			(select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_licencia in
		 (select id_licencia from catastro_gdl:licencias where licencia=v_folio)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "LICENCIA CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA LICENCIA TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "LICENCIA CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL LICENCIAS";
      end if; --existe en LICENCIAS
      end if; --es licencia
      if v_folioanun > 0 then --es anuncio
      if exists (SELECT * FROM catastro_gdl:detsal_lic where id_anuncio in 
			(select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0) then
	 SELECT sum(derechos),sum(forma) into v_imppag,v_impformas  FROM catastro_gdl:detsal_lic where id_anuncio in
		 (select id_anuncio from catastro_gdl:anuncios where anuncio=v_folioanun)
			and cvepago=0;	
           
         let estatus = 0;
         let mensaje = "ANUNCIO CON ADEUDO";
			--derechos + forma para obtener total sin recargos
	 let v_difimp =  (v_imppag +v_impformas)  - v_limpuestos;
         if v_difimp <> 0 then
            let v_estatus = "D";
            let estatus = 6;
	    let mensaje = "LA ANUNCIO TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "ANUNCIO CONCILIADA, PROCEDE APLICACION DE PAGO";
         end if; 
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,current ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"NO EXISTE EL SALDO DEL ANUNCIO";
      end if; --existe en ANUNCIO
      end if; --es ANUNCIO
   end if;--no existe linea captura en pagos
end if; --modulo 08 licencias
------------------------------------------------------------------------------------------------------------------
if v_modulo = 12 then
   let v_estatus = "";
   --Verifica que exista la linea de captura
   if NOT exists (select * from linea_capturadiv where linea = p_linea) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE DIVERSOS NO EXISTE";
   end if;
   --obtener los datos del registro de diversos  
   select id,linea,modulo,folio,total into 
	  v_id_linea,v_modulo,v_folio,v_importe,v_linea 
          from linea_capturadiv where linea = p_linea;  

   if v_importe <> p_pagado then
         return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
   end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliaciada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE DIVERSOS YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE DIVERSOS ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
      --si el estatus es C=carga o D=diferencia en Imp, Revisa el estatus del recibo de diversos
      if exists (select * from ta_12_recibosdiv where id_recibo=v_folio) then
	 select importe,cvepago into v_importe,v_cvepago  from ta_12_recibosdiv where id_recibo=v_folio; 
         if v_cvepago = "P" then
            return 5,"EL RECIBO DE DIVERSOS YA FUE PAGADO";
         end if;
         let estatus = 0;
         let mensaje = "EL RECIBO DE DIVERSOS YA EXISTE";
         if v_importe <> p_pagado then
            let v_estatus = "D";
	    let	v_fecha_concilia = null;
            let estatus = 6;
	    let mensaje = "EL RECIBO DE DIVERSOS TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "RECIBO DE DIVERSOS CONCILIADO, PROCEDE APLICACION DE PAGO";
         end if; --v_importe <> p_pagado
	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = v_fecha_concilia,
		        usuario=p_usuario
	 where id = v_id;
         return estatus,mensaje;
      else		         
         return 7,"EL RECIBO DE DIVERSOS NO EXISTE";
      end if; --existe en recibosdiv

   else --si no esta cargada la linea de captura en pagos
      if exists (select * from ta_12_recibosdiv where id_recibo=v_folio) then
	 select importe,cvepago into v_importe,v_cvepago  from ta_12_recibosdiv where id_recibo=v_folio; 
         let v_estatus = "C"; -- cargado
         let estatus = 0;
         let mensaje = "EL RECIBO DE DIVERSOS YA FUE PAGADO";
         if v_cvepago = "P" then
	    let estatus = 5;
            let mensaje = "EL RECIBO DE DIVERSOS YA FUE PAGADO";
	    return estatus,mensaje;
         end if;
         if v_importe <> p_pagado then
            let v_estatus = "D";
	    let	v_fecha_concilia = null;
            let estatus = 6;
	    let mensaje = "EL RECIBO DE DIVERSOS TIENE DIFERENCIA EN IMPORTE";
         else
            let v_estatus = "N";
	    let	v_fecha_concilia = current;
            let estatus = 0;
	    let mensaje = "RECIBO DE DIVERSOS CONCILIADO, PROCEDE APLICACION DE PAGO";
         end if; --v_importe <> p_pagado
	 let v_difimp = v_importe - p_pagado;
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,null ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
         return estatus,mensaje;
      else		         
         return 7,"EL RECIBO DE DIVERSOS NO EXISTE";
      end if; --existe en recibosdiv
   end if;--no existe linea captura en pagos
end if; --modulo 12
--trace off;
end procedure;

create function "pgcabrer".fn_17_calc_venc(pinicio date,ptipo char(1))
returning date as vencimiento,
          date as mensual;

define v_axo,v_mes,v_dia,dias_cuantos,dias_habil int;
define v_vencimiento,v_mensual date;

let v_vencimiento=pinicio;
let v_dia=day(pinicio);      
let v_mes=month(pinicio);
let v_axo=year(pinicio);
if ptipo='M' then
   if  v_mes=12 then
       let v_mes=1;
       let v_axo=v_axo + 1;
   else
       let v_mes=v_mes + 1;
   end if;
   if v_dia = 31 then
      if  (v_mes = 4 or v_mes =6 or v_mes =9 or v_mes =11) then   
          let v_dia=30;
      else
          if v_mes = 2 then  
             let v_dia = 28;
          end if;
      end if;
   end if;
   if v_dia = 30 then
      if v_mes = 2 then  
         let v_dia = 28;
      end if;
   end if;
   if v_dia = 29 then
      if v_mes = 2 then  
         let v_dia = 28;
      end if;
   end if;
   let v_vencimiento=mdy(v_mes,v_dia,v_axo);
   let v_mensual=v_vencimiento;
else
   if ptipo='Q' then
      let v_vencimiento=v_vencimiento+15;
      let v_mensual=v_vencimiento;
   else
      if ptipo='S' then
         let v_vencimiento=v_vencimiento+7;
         let v_mensual=v_vencimiento;
      end if;
   end if;
end if;

select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales where fecha=v_vencimiento;
if dias_habil>0 then
   let dias_cuantos=dias_habil;
   While dias_cuantos>0    
     begin
     let v_vencimiento=v_vencimiento+1;
     select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales where fecha=v_vencimiento; 
     let dias_cuantos=dias_habil; 
     continue;  
     end begin; 
   end while; 
end if; 
return v_vencimiento,v_mensual;
end function;

CREATE PROCEDURE "informix".sp42_asignar (pcontrol int,pcentro int,ppersona int,presp char(1),pusudel int,
pdoctos int,pestseg int,popc char(1))
returning   int as estado,
            varchar(100) as mensaje;

define vestatus,vest1,vest2, v_iduser_rec int;
define vmensaje varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define Cont_Existe  int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp42_asignar ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

if pcontrol<0 then -- validacion del control
   return -1,'Error en numero de control del oficio';
end if;
if pcentro<=0 then -- validacion del centro (letras del oficio)
   return -1,'El numero de centro no es valido';
end if;
if ppersona<=0 then -- validacion del titular
   return -1,'El numero de persona no es valido';
end if;
if presp<>'S' then -- validacion de respuesta
   if presp<>'N' then
      return -1,'Error en respuesta, Solo se acepta (S)-Respuesta � (N)-Informativo';
   end if;
end if;
if pusudel<=0 then -- validacion del usuario
   return -1,'No existe el usuario';
end if;

Let Cont_Existe = 0;

select t42_deleg_id  into v_iduser_rec -- LINEA ADICIONADA PARA DARLE SEGUIMIENTO POR DELEGADO
from t42_personas 
where t42_centros_id = pcentro;
if v_iduser_rec is null then
   return -1,'Error falta dar de alta en personas al titular del centro o delegado del mismo ';
end if;


let vest1=0;
let vest2=0;

if popc='A' then
                SELECT count(*) INTO Cont_Existe FROM t42_doctos 
                WHERE t42_control_id = pcontrol and t42_centros_id = pcentro and t42_personas_id_recibe = ppersona;
                if Cont_Existe > 0 then
                               let vestatus = -1;
                               let vmensaje = 'Ya existe Asignacion de este documento con anterioridad';
                else
                               insert into t42_doctos (id,t42_control_id,t42_centros_id,t42_personas_id_recibe,fec_notif,
                               req_resp,usuario_mov,fec_mov,t42_status_id) 
                                                                              values (0,pcontrol,pcentro,ppersona,current,presp,user,current,1);
                               let vest1=dbinfo("sqlca.sqlerrd1");

                               insert into t42_seguimiento(id,t42_doctos_id,t42_centros_id,usuario_seg,fec_seg,t42_statusseg_id,usuario_mov) 
                                                                              values (0,vest1,pcentro,v_iduser_rec,current,pestseg,user);   -- pusudel por v_iduser_rec
                               let vest2=dbinfo("sqlca.sqlerrd1");
                               let vestatus=1;
                               let vmensaje='Se asigno correctamente el numero de oficio';
                end if;
end if;

if popc='S' then
   update t42_doctos set t42_status_id=pestseg where id=pdoctos;

   insert into t42_seguimiento(id,t42_doctos_id,t42_centros_id,usuario_seg,fec_seg,t42_statusseg_id,
   usuario_mov) values (0,pdoctos,pcentro,v_iduser_rec,current,pestseg,user);
   let vest2=dbinfo("sqlca.sqlerrd1");
   let vestatus=1;
   let vmensaje='Seguimineto modificado correctamente';
end if;
return vestatus,vmensaje;
end procedure;

CREATE PROCEDURE "pgmoreno".sp42_seguim_doctos ( pUsuario char(10), pStatSeguim int, pOpBuscar int, pBusqueda varchar(100), pPrioridad int, pOrden int, pStatCtrol int, pStatDoc int )
{######################################################################
#  Procedimiento:    sp42_seguim_doctos
#  Descripcion:      Interfaz de consulta de Documentacion tanto RECIBIDA como ENVIADA - GESTION DE DOCUMENTOS -
#
#  Parametros   pUsuario  	= Usuario
#  de entrada:  pStatSeguim	= Status de Seguimiento deseado de Documentos
#			opc : 0 todos los documentos
#			opc : 1 documentos aun sin recibir
#			opc : 2 documentos recibidos sin terminar
#			opc : 3 documentos terminados o rechazados
#  		pOpBuscar	= Opcion de Busqueda
#			opc : 0 todos
#			opc : 1 Busqueda por Numero de Documento
#			opc : 2 Busqueda por Fecha de Documento
#			opc : 3 Busqueda por Nombre Generico del Documento
#			opc : 4 Busqueda por Centro de Origen del Documento
#               pBusqueda	= Texto de Busqueda
#               pPrioridad	= Prioridad del Documento
#			opc : 0 = Todos
#			opc : 1 = Ordinario
#			opc : 2 = Urgente
#			opc : 3 = extra urgente
#			opc : 4 = inmediato
#               pOrden		= Order del Query
#               pStatCtrol	= Status del Control del Documento -t42_control-
#               pStatDoc	= Status del Documento -t42_doctos-
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            1 de mayo del 2015
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
Returning   int as estatus,
            varchar(255) as mensaje,
                varchar(100) as centro,
                int as ejercicio,
                int as numero,
                varchar(30) as nombre_generico,
                varchar(50) as tipo_docto,
                date as fecha_docto,
                date as fecha_registro,
                Datetime year to second as fecha_limite,
                int as id_centro_orden,
                int as id_control,
                char(10) as control,
                int as id_doctos,
                int as usuario_seg,
                int as Orden,
                int as id_centro_dependo,
		int as prioridad_id;

define v_status                       int;
define v_mensaje                      varchar(255);
define v_lError                       int;
define v_lISAMError                   varchar(255);
define v_vcMensaje                    varchar(255);

define v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo int;

define vv_id_control, vv_id_centro, VV_t42_tipodocs_id, vv_ejercicico, vv_numero, VV_t42_prioridad_id, VV_t42_status_id Int;
define vv_control                                                  Char(10);
define vv_nombre_generico                                          char(30);
define vv_fec_docto, vv_fec_rgs                                    Date;
define vv_fec_limite, VV_fec_mov                                   datetime year to second;

define vv_centro_origen                                            char(100);
define vv_tipo_documento                                           char(50);
define vv_id_doctos, vv_Usuario_seg, vv_contador		   int;
define Cont_Seguim, Cont_Seguim_Recib, Cont_Seguim_Term			int;

define v_imprime							char(2);

--ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--RETURN -1, 'sp42_seguim_doctos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
--END EXCEPTION

Let v_status = 0;
Let v_mensaje = 'CONSULTA CORRECTA';

Let v_id_usuario_delegado = 0;
Let v_autorizado = 0;
Let v_id_persona_dependo = 0;
Let v_id_delegado_titular_centro = 0;
Let v_id_centro_dependo = 0;

Let vv_centro_origen = '';
Let vv_tipo_documento = '';
Let vv_id_doctos = 0;
Let vv_Usuario_seg = 0;

Let vv_control = '';
Let vv_id_centro = 0;
Let VV_t42_tipodocs_id = 0;
Let vv_ejercicico = 0;
Let vv_numero = 0;
Let vv_nombre_generico = '';
Let vv_fec_docto = Null;
Let vv_fec_rgs = Null;
Let vv_fec_limite = Null;
Let VV_t42_prioridad_id = 0;
Let VV_fec_mov = Null;
Let VV_t42_status_id = 0;

Let Cont_Seguim = 0;
	Let Cont_Seguim_Recib = 0;
	Let Cont_Seguim_Term = 0;

Let vv_contador = 0;
Let v_imprime = 'No';


if exists( SELECT *  FROM t42_deleg WHERE usuario = Trim(pUsuario) ) then
    SELECT nvl(a.id,0) id_usuario_delegado, a.autorizado, (a.t42_personas_id) id_persona_dependo, nvl(b.t42_deleg_id,0) id_delegado_titular_centro, nvl(c.id,0) id_centro_dependo
         INTO  v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo
         FROM t42_deleg a, t42_personas b, t42_centros c    WHERE a.usuario = Trim(pUsuario)  and a.t42_personas_id = b.id  and b.t42_centros_id = c.id;
else
    Let v_id_usuario_delegado = 0;
end if;

if  (v_id_usuario_delegado = 0) or (v_id_usuario_delegado is Null) then
    Let v_status = -1;
    Let v_mensaje = 'Usuario Inexistente';
else
	
      	if v_autorizado = 1 then
		if v_id_centro_dependo = 51 then         --            PARA OFICINA DEL TESORERO
			foreach
			SELECT c.id, "RECIBIDO" CONTROL, c.t42_centros_id, c.t42_tipodocs_id, c.ejercicico, c.numero, c.nombre_generico,
				c.fec_docto, c.fec_rgs, c.fec_limite, c.t42_prioridad_id, c.fec_mov, c.t42_status_id, d.nombre, e.descripcion
			INTO vv_id_control, vv_control, vv_id_centro, VV_t42_tipodocs_id, vv_ejercicico, vv_numero, vv_nombre_generico, 
				vv_fec_docto, vv_fec_rgs, vv_fec_limite, VV_t42_prioridad_id, VV_fec_mov, VV_t42_status_id, vv_centro_origen, vv_tipo_documento

                        FROM t42_control c, t42_centros d, t42_tipodocs e 
			WHERE c.t42_centros_id <> v_id_centro_dependo AND c.t42_centro_id_captura = v_id_centro_dependo AND c.t42_status_id = pStatCtrol
  			  AND d.id = c.t42_centros_id  			AND d.t42_status_id = 1
  			  AND e.id = c.t42_tipodocs_id 			AND e.t42_status_id = 1
			ORDER BY c.fec_docto desc, c.ejercicico, c.numero
					
				foreach	
                               	SELECT id INTO vv_id_doctos FROM T42_doctos 
					WHERE t42_control_id = vv_id_control and t42_centros_id = v_id_centro_dependo and t42_status_id = pStatDoc
				end foreach;
				
				foreach
				EXECUTE PROCEDURE sp42_seguim_doctxx ( pStatSeguim, Cont_Seguim_Recib, Cont_Seguim_Term, pOpBuscar, pBusqueda, pPrioridad, VV_t42_prioridad_id, vv_id_control, vv_id_centro ) 
							INTO v_imprime

				if v_imprime = 'Si' then
					RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicico, vv_numero, vv_nombre_generico, 
					vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
					vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, 1, v_id_centro_dependo, VV_t42_prioridad_id  with resume;
				end if;
				end foreach;

			end foreach;

			foreach
			SELECT c.id, "ENVIADO" CONTROL, c.t42_centros_id, c.t42_tipodocs_id, c.ejercicico, c.numero, c.nombre_generico,
				c.fec_docto, c.fec_rgs, c.fec_limite, c.t42_prioridad_id, c.fec_mov, c.t42_status_id, d.nombre, e.descripcion
			INTO vv_id_control, vv_control, vv_id_centro, VV_t42_tipodocs_id, vv_ejercicico, vv_numero, vv_nombre_generico, 
				vv_fec_docto, vv_fec_rgs, vv_fec_limite, VV_t42_prioridad_id, VV_fec_mov, VV_t42_status_id, vv_centro_origen, vv_tipo_documento

			FROM t42_control c, t42_centros d, t42_tipodocs e 
			WHERE c.t42_centros_id = v_id_centro_dependo and c.t42_status_id = pStatCtrol
  			  AND d.id = c.t42_centros_id  			AND d.t42_status_id = 1
  			  AND e.id = c.t42_tipodocs_id 			AND e.t42_status_id = 1
			ORDER BY c.fec_docto desc, c.ejercicico, c.numero

				foreach	
                               	SELECT id INTO vv_id_doctos FROM T42_doctos 
					WHERE t42_control_id = vv_id_control and t42_centros_id = v_id_centro_dependo and t42_status_id = pStatDoc
				end foreach;

				foreach
				EXECUTE PROCEDURE sp42_seguim_doctxx ( pStatSeguim, Cont_Seguim_Recib, Cont_Seguim_Term, pOpBuscar, pBusqueda, pPrioridad, VV_t42_prioridad_id, vv_id_control, vv_id_centro ) 
							INTO v_imprime

				if v_imprime = 'Si' then
					RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicico, vv_numero, vv_nombre_generico, 
					vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
					vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, 2, v_id_centro_dependo, VV_t42_prioridad_id  with resume;
				end if;
				end foreach;

			end foreach;

		else	-- aqui va cuando es centro diferente de 51
			foreach
			SELECT b.id, c.id, "RECIBIDO" CONTROL, c.t42_centros_id, c.t42_tipodocs_id, c.ejercicico, c.numero, c.nombre_generico,
				c.fec_docto, c.fec_rgs, c.fec_limite, c.t42_prioridad_id, c.fec_mov, c.t42_status_id, d.nombre, e.descripcion
			INTO vv_id_doctos, vv_id_control, vv_control, vv_id_centro, VV_t42_tipodocs_id, vv_ejercicico, vv_numero, vv_nombre_generico, 
				vv_fec_docto, vv_fec_rgs, vv_fec_limite, VV_t42_prioridad_id, VV_fec_mov, VV_t42_status_id, vv_centro_origen, vv_tipo_documento  
			FROM t42_seguimiento a, t42_doctos b, t42_control c, t42_centros d, t42_tipodocs e
			WHERE a.t42_centros_id = v_id_centro_dependo    AND a.usuario_seg = v_id_delegado_titular_centro AND a.t42_statusseg_id = 1 -- adicionado AND a.usuario_seg = v_id_delegado_titular_centro
  			  AND b.id = a.t42_doctos_id   			AND b.t42_status_id = pStatDoc
			  AND c.id = b.t42_control_id  			AND c.t42_status_id = pStatCtrol
  			  AND d.id = c.t42_centros_id  			AND d.t42_status_id = 1
  			  AND e.id = c.t42_tipodocs_id 			AND e.t42_status_id = 1
			ORDER BY c.fec_docto desc, c.ejercicico, c.numero
			
				Let Cont_Seguim = 0;
				Let Cont_Seguim_Recib = 0;
				Let Cont_Seguim_Term = 0;

				foreach
				SELECT t42_statusseg_id INTO Cont_Seguim FROM t42_seguimiento WHERE t42_doctos_id = vv_id_doctos
						AND t42_centros_id = v_id_centro_dependo AND usuario_seg = v_id_delegado_titular_centro AND t42_statusseg_id > 1

					if (Cont_Seguim = 2) or (Cont_Seguim = 4) then Let Cont_Seguim_Recib = 1; end if;
					if (Cont_Seguim = 3) or (Cont_Seguim = 5) then Let Cont_Seguim_Term = 1;  end if;
				end foreach;
			
				foreach
				EXECUTE PROCEDURE sp42_seguim_doctxx ( pStatSeguim, Cont_Seguim_Recib, Cont_Seguim_Term, pOpBuscar, pBusqueda, pPrioridad, VV_t42_prioridad_id, vv_id_control, vv_id_centro ) 
							INTO v_imprime

				if v_imprime = 'Si' then
					RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicico, vv_numero, vv_nombre_generico, 
					vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
					vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, 1, v_id_centro_dependo, VV_t42_prioridad_id  with resume;
				end if;
				end foreach;

			end foreach;

			foreach
			SELECT c.id, "ENVIADO" CONTROL, c.t42_centros_id, c.t42_tipodocs_id, c.ejercicico, c.numero, c.nombre_generico,
					c.fec_docto, c.fec_rgs, c.fec_limite, c.t42_prioridad_id, c.fec_mov, c.t42_status_id, d.nombre, e.descripcion
				INTO vv_id_control, vv_control, vv_id_centro, VV_t42_tipodocs_id, vv_ejercicico, vv_numero, vv_nombre_generico, 
					vv_fec_docto, vv_fec_rgs, vv_fec_limite, VV_t42_prioridad_id, VV_fec_mov, VV_t42_status_id, vv_centro_origen, vv_tipo_documento

			FROM t42_control c, t42_centros d, t42_tipodocs e 
			WHERE c.t42_centros_id = v_id_centro_dependo and c.t42_status_id = pStatCtrol
  			  AND d.id = c.t42_centros_id  			AND d.t42_status_id = 1
  			  AND e.id = c.t42_tipodocs_id 			AND e.t42_status_id = 1
			ORDER BY c.fec_docto desc, c.ejercicico, c.numero

				foreach	
                               	SELECT id INTO vv_id_doctos FROM T42_doctos 
					WHERE t42_control_id = vv_id_control and t42_centros_id = v_id_centro_dependo and t42_status_id = pStatDoc
				end foreach;

				foreach
				EXECUTE PROCEDURE sp42_seguim_doctxx ( pStatSeguim, Cont_Seguim_Recib, Cont_Seguim_Term, pOpBuscar, pBusqueda, pPrioridad, VV_t42_prioridad_id, vv_id_control, vv_id_centro ) 
							INTO v_imprime

				if v_imprime = 'Si' then
					RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicico, vv_numero, vv_nombre_generico, 
					vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
					vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, 2, v_id_centro_dependo, VV_t42_prioridad_id  with resume;
				end if;
				end foreach;

			end foreach;

		end if;
	else
		foreach
		SELECT b.id, c.id, "RECIBIDO" CONTROL, c.t42_centros_id, c.t42_tipodocs_id, c.ejercicico, c.numero, c.nombre_generico,
			c.fec_docto, c.fec_rgs, c.fec_limite, c.t42_prioridad_id, c.fec_mov, c.t42_status_id, d.nombre, e.descripcion
		INTO vv_id_doctos, vv_id_control, vv_control, vv_id_centro, VV_t42_tipodocs_id, vv_ejercicico, vv_numero, vv_nombre_generico, 
			vv_fec_docto, vv_fec_rgs, vv_fec_limite, VV_t42_prioridad_id, VV_fec_mov, VV_t42_status_id, vv_centro_origen, vv_tipo_documento  
		FROM t42_seguimiento a, t42_doctos b, t42_control c, t42_centros d, t42_tipodocs e
		WHERE a.t42_centros_id = v_id_centro_dependo    AND a.usuario_seg = v_id_usuario_delegado  AND a.t42_statusseg_id = 1
  	  	  AND b.id = a.t42_doctos_id   			AND b.t42_status_id = pStatDoc
	  	  AND c.id = b.t42_control_id  			AND c.t42_status_id = pStatCtrol
  	  	  AND d.id = c.t42_centros_id  			AND d.t42_status_id = 1
  	  	  AND e.id = c.t42_tipodocs_id 			AND e.t42_status_id = 1
		ORDER BY c.fec_docto desc, c.ejercicico, c.numero

			Let Cont_Seguim = 0;
			Let Cont_Seguim_Recib = 0;
			Let Cont_Seguim_Term = 0;

			foreach
			SELECT t42_statusseg_id INTO Cont_Seguim FROM t42_seguimiento WHERE t42_doctos_id = vv_id_doctos
				AND t42_centros_id = v_id_centro_dependo AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id > 1

				if (Cont_Seguim = 2) or (Cont_Seguim = 4) then Let Cont_Seguim_Recib = 1; end if;
				if (Cont_Seguim = 3) or (Cont_Seguim = 5) then Let Cont_Seguim_Term = 1;  end if;
			end foreach;
			
			foreach
			EXECUTE PROCEDURE sp42_seguim_doctxx ( pStatSeguim, Cont_Seguim_Recib, Cont_Seguim_Term, pOpBuscar, pBusqueda, pPrioridad, VV_t42_prioridad_id, vv_id_control, vv_id_centro ) 
							INTO v_imprime

			if v_imprime = 'Si' then
				RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicico, vv_numero, vv_nombre_generico, 
				vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
				vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, 1, v_id_centro_dependo, VV_t42_prioridad_id  with resume;
			end if;
			end foreach;

		end foreach;
      	end if;
end if;
end procedure;

CREATE PROCEDURE "pgmoreno".sp42_doctos_pba ( pCentro int )

Returning   int as estatus,
            varchar(255) as mensaje,
                varchar(100) as centro,
                int as ejercicio,
                int as numero,
                varchar(30) as nombre_generico,
                varchar(50) as tipo_docto,
                date as fecha_docto,
                date as fecha_registro,
                Datetime year to second as fecha_limite,
		varchar(10) as vigencia;

define v_status                       int;
define v_mensaje                      varchar(255);
define v_lError                       int;
define v_lISAMError                   varchar(255);
define v_vcMensaje                    varchar(255);

define v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo int;

define vv_id_control, vv_id_centro, VV_t42_tipodocs_id, vv_ejercicico, vv_numero, VV_t42_prioridad_id, VV_t42_status_id Int;
define vv_control													Char(10);
define vv_nombre_generico 												char(30);
define vv_fec_docto, vv_fec_rgs 											Date;
define vv_fec_limite, VV_fec_mov 											datetime year to second;

define vv_centro_origen													char(100);
define vv_tipo_documento												char(50);
define vv_id_doctos, vv_Usuario_seg											int;
define vv_vigente_terminado												char(10);
define vv_encontrato													int;


--ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--RETURN -1, 'sp42_seguim_doctos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
--END EXCEPTION

Let v_status = 0;
Let v_mensaje = 'CONSULTA CORRECTA';

Let v_id_usuario_delegado = 0;
Let v_autorizado = 0;
Let v_id_persona_dependo = 0;
Let v_id_delegado_titular_centro = 0;
Let v_id_centro_dependo = 0;

Let vv_centro_origen = '';
Let vv_tipo_documento = '';
Let vv_id_doctos = 0;
Let vv_Usuario_seg = 0;
Let vv_vigente_terminado = '';
Let vv_encontrato = 0;

foreach
SELECT c.ejercicico, c.numero, c.nombre_generico, e.descripcion, 
c.fec_docto, c.fec_rgs, c.fec_limite, d.nombre, a.t42_doctos_id

INTO vv_ejercicico, vv_numero, vv_nombre_generico, vv_tipo_documento, 
vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_centro_origen, vv_id_doctos

FROM t42_seguimiento a, t42_doctos b, t42_control c, t42_centros d, t42_tipodocs e
WHERE a.t42_centros_id = pCentro AND a.t42_statusseg_id = 1
AND b.id = a.t42_doctos_id
AND c.id = b.t42_control_id
AND d.id = c.t42_centros_id  			AND d.t42_status_id = 1
AND e.id = c.t42_tipodocs_id 			AND e.t42_status_id = 1
ORDER BY c.fec_docto desc, c.ejercicico, c.numero

	select count(*) into vv_encontrato from t42_seguimiento where t42_doctos_id = vv_id_doctos and t42_statusseg_id = 5;
	if (vv_encontrato = 0) or (vv_encontrato is Null) then
		Let vv_vigente_terminado = 'Vigente';
	else
		Let vv_vigente_terminado = 'Terminado';
	end if;


 return v_status, v_mensaje, vv_centro_origen, vv_ejercicico, vv_numero, vv_nombre_generico, vv_tipo_documento, 
	vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_vigente_terminado  with resume;
end foreach;

end procedure;

CREATE PROCEDURE "pgmoreno".sp42_seguim_doctxx ( pStatSeguim int, Cont_Seguim_Recib int, Cont_Seguim_Term int,  pOpBuscar int, pBusqueda varchar(100), 
					pPrioridad int, p_t42_prioridad_id int, p_id_control int, p_id_centro int )

Returning   char(2) as imprime;

define Cont_Numero, Cont_FecDocto, Cont_NomGen, Cont_NomCtro		int;
define pBusqueda_dia, pBusqueda_mes, pBusqueda_axo, pBusqueda_Num	int;
define v_imprime							char(2);

Let Cont_Numero = 0;
Let Cont_FecDocto = 0;
Let Cont_NomGen = 0;
Let Cont_NomCtro = 0;

if pOpBuscar = 1 then
	if trim(pBusqueda)='' then
		let pBusqueda_Num = 1111111;
	else
   		let pBusqueda_Num = substr(pBusqueda,1,10);
	end if;
end if
if pOpBuscar = 2 then
	if trim(pBusqueda)='' then
		let pBusqueda_dia = 99;
		let pBusqueda_mes = 99;
		let pBusqueda_axo = 9999;
	else
   		let pBusqueda_dia = substr(pBusqueda,1,2);
   		let pBusqueda_mes = substr(pBusqueda,4,2);
   		let pBusqueda_axo = substr(pBusqueda,7,4);
	end if;
end if;

Let v_imprime = 'No';

if pStatSeguim = 1 then  -- solo documentos aun sin recibir
	if (Cont_Seguim_Recib = 0) and (Cont_Seguim_Term = 0) then -- solo documentos para recibir
		if pOpBuscar > 0 then  -- buscar por el filtro
			if pOpBuscar = 1 then
				SELECT count(*) INTO Cont_Numero FROM t42_control WHERE id = p_id_control AND numero = pBusqueda_Num;
				if Cont_Numero > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if; 
			if pOpBuscar = 2 then
				SELECT count(*) INTO Cont_FecDocto FROM t42_control WHERE id = p_id_control 
					AND c.fec_docto = mdy(pBusqueda_mes,pBusqueda_dia,pBusqueda_axo);
				if Cont_FecDocto > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 3 then
				SELECT count(*) INTO Cont_NomGen FROM t42_control WHERE id = p_id_control AND nombre_generico like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomGen > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 4 then
				select count(*) INTO Cont_NomCtro FROM T42_CENTROS where id = p_id_centro  AND nombre like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomCtro > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
		else
			if pPrioridad = 0 then -- todos
				Let v_imprime = 'Si';
			else
				if pPrioridad = p_t42_prioridad_id then
					Let v_imprime = 'Si';
				end if;
			end if;
		end if;
	end if;
end if;


if pStatSeguim = 2 then  -- documentos recibidos sin terminar
	if (Cont_Seguim_Recib > 0) and (Cont_Seguim_Term = 0) then 
		if pOpBuscar > 0 then  -- buscar por el filtro
			if pOpBuscar = 1 then
				SELECT count(*) INTO Cont_Numero FROM t42_control WHERE id = p_id_control AND numero = pBusqueda_Num;
				if Cont_Numero > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if; 
			if pOpBuscar = 2 then
				SELECT count(*) INTO Cont_FecDocto FROM t42_control WHERE id = p_id_control 
					AND c.fec_docto = mdy(pBusqueda_mes,pBusqueda_dia,pBusqueda_axo);
				if Cont_FecDocto > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 3 then
				SELECT count(*) INTO Cont_NomGen FROM t42_control WHERE id = p_id_control AND nombre_generico like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomGen > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 4 then
				select count(*) INTO Cont_NomCtro FROM T42_CENTROS where id = p_id_centro  AND nombre like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomCtro > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
		else
			if pPrioridad = 0 then -- todos
				Let v_imprime = 'Si';
			else
				if pPrioridad = p_t42_prioridad_id then
					Let v_imprime = 'Si';
				end if;
			end if;
		end if;
	end if;
end if;


if pStatSeguim = 3 then  -- terminados
	if (Cont_Seguim_Recib >= 0) and (Cont_Seguim_Term > 0) then  
		if pOpBuscar > 0 then  -- buscar por el filtro
			if pOpBuscar = 1 then
				SELECT count(*) INTO Cont_Numero FROM t42_control WHERE id = p_id_control AND numero = pBusqueda_Num;
				if Cont_Numero > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if; 
			if pOpBuscar = 2 then
				SELECT count(*) INTO Cont_FecDocto FROM t42_control WHERE id = p_id_control 
					AND c.fec_docto = mdy(pBusqueda_mes,pBusqueda_dia,pBusqueda_axo);
				if Cont_FecDocto > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 3 then
				SELECT count(*) INTO Cont_NomGen FROM t42_control WHERE id = p_id_control AND nombre_generico like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomGen > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 4 then
				select count(*) INTO Cont_NomCtro FROM T42_CENTROS where id = p_id_centro  AND nombre like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomCtro > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
		else
			if pPrioridad = 0 then -- todos
				Let v_imprime = 'Si';
			else
				if pPrioridad = p_t42_prioridad_id then
					Let v_imprime = 'Si';
				end if;
			end if;
		end if;
	end if;
end if;


if pStatSeguim = 0 then
		if pOpBuscar > 0 then  -- buscar por el filtro
			if pOpBuscar = 1 then
				SELECT count(*) INTO Cont_Numero FROM t42_control WHERE id = p_id_control AND numero = pBusqueda_Num;
				if Cont_Numero > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if; 
			if pOpBuscar = 2 then
				SELECT count(*) INTO Cont_FecDocto FROM t42_control WHERE id = p_id_control 
					AND c.fec_docto = mdy(pBusqueda_mes,pBusqueda_dia,pBusqueda_axo);
				if Cont_FecDocto > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 3 then
				SELECT count(*) INTO Cont_NomGen FROM t42_control WHERE id = p_id_control AND nombre_generico like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomGen > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
			if pOpBuscar = 4 then
				select count(*) INTO Cont_NomCtro FROM T42_CENTROS where id = p_id_centro  AND nombre like '%'|| Trim(pBusqueda) ||'%';
				if Cont_NomCtro > 0 then
					if pPrioridad = 0 then -- todos
						Let v_imprime = 'Si';
					else
						if pPrioridad = p_t42_prioridad_id then
							Let v_imprime = 'Si';
						end if;
					end if;
				end if;
			end if;
		else
			if pPrioridad = 0 then -- todos
				Let v_imprime = 'Si';
			else
				if pPrioridad = p_t42_prioridad_id then
					Let v_imprime = 'Si';
				end if;
			end if;
		end if;
end if;

RETURN v_imprime;

end procedure;

CREATE PROCEDURE "pgmoreno".sp42_doctos_terminar()

Returning   int as estatus,
            varchar(255) as mensaje;

define v_status                       int;
define v_mensaje                      varchar(255);
define v_centros_dep			int;
define v_t42_doctos_id			int;
define v_delegaciones			int;
define v_delegaciones_b 		int;
define v_delegados_dep			int;
define v_terminado			int;

define v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo	int;

Let v_status = 0;
Let v_mensaje = 'DOCUMENTOS TERMINADOS CORRECTAMENTE';

Let v_id_usuario_delegado = 0;
Let v_autorizado = 0;
Let v_id_persona_dependo = 0;
Let v_id_delegado_titular_centro = 0;
Let v_id_centro_dependo = 0;

Let v_centros_dep = 0;
Let v_t42_doctos_id = 0;
Let v_delegaciones = 0;
Let v_delegaciones_b = 0;
Let v_delegados_dep = 0;
Let v_terminado = 0;

if exists( SELECT *  FROM t42_deleg WHERE usuario = User ) then
    SELECT nvl(a.id,0) id_usuario_delegado, a.autorizado, (a.t42_personas_id) id_persona_dependo, nvl(b.t42_deleg_id,0) id_delegado_titular_centro, nvl(c.id,0) id_centro_dependo
         INTO  v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo
         FROM t42_deleg a, t42_personas b, t42_centros c    WHERE a.usuario = User  and a.t42_personas_id = b.id  and b.t42_centros_id = c.id;
else
    Let v_id_usuario_delegado = 0;
end if;

if  (v_id_usuario_delegado = 0) or (v_id_usuario_delegado is Null) then
    Let v_status = -1;
    Let v_mensaje = 'Usuario Inexistente';
else
      if v_autorizado = 1 then                                        
		SELECT COUNT(*) INTO v_centros_dep FROM t42_centros a, t42_personas b, t42_deleg c  -- centros dependientes
		WHERE a.centros_dep = v_id_centro_dependo
		AND b.t42_centros_id = a.id  AND c.id = b.t42_deleg_id;

		if v_centros_dep > 0 then  -- si tengo centros que dependen de mi entonces busco todos los documentos que tengo asignados y que por ende delegue
			foreach  
			SELECT t42_doctos_id INTO v_t42_doctos_id FROM t42_seguimiento -- documentos asignados
			WHERE t42_centros_id = v_id_centro_dependo  
			AND usuario_seg = v_id_delegado_titular_centro 
			AND t42_statusseg_id = 1 order by t42_doctos_id
				
				Let v_delegaciones = 0;  -- busca delegaciones asignadas
				SELECT COUNT(*) INTO v_delegaciones FROM t42_centros a, t42_personas b, t42_deleg c, t42_seguimiento d  
				WHERE a.centros_dep = v_id_centro_dependo  AND b.t42_centros_id = a.id  AND c.id = b.t42_deleg_id
				AND d.t42_centros_id = b.t42_centros_id  AND d.usuario_seg = b.t42_deleg_id
				AND d.t42_doctos_id = v_t42_doctos_id AND d.t42_statusseg_id = 1;

				if v_delegaciones > 0 then -- tiene el documento delegacion

					if v_delegaciones > 1 then
						Let v_delegaciones_b = 0;  -- busca si ya estan terminadas
						SELECT COUNT(*) INTO v_delegaciones_b FROM t42_centros a, t42_personas b, t42_deleg c, t42_seguimiento d  
						WHERE a.centros_dep = v_id_centro_dependo  AND b.t42_centros_id = a.id  AND c.id = b.t42_deleg_id
						AND d.t42_centros_id = b.t42_centros_id  AND d.usuario_seg = b.t42_deleg_id
						AND d.t42_doctos_id = v_t42_doctos_id AND ((d.t42_statusseg_id = 5) or (d.t42_statusseg_id = 3));

						if v_delegaciones_b = v_delegaciones then  -- terminar el seguimiento
							-- verificar si ya lo termine, de lo contrario terminarlo
							Let v_terminado = 0;
							SELECT count(*) INTO v_terminado  FROM t42_seguimiento 
							WHERE t42_doctos_id = v_t42_doctos_id AND t42_centros_id = v_id_centro_dependo  
							AND usuario_seg = v_id_delegado_titular_centro AND t42_statusseg_id = 5;

							if v_terminado = 0 then
								insert into t42_seguimiento(id, t42_doctos_id, t42_centros_id, usuario_seg, 
												fec_seg, t42_statusseg_id, observacion, usuario_mov) 
								values (0, v_t42_doctos_id, v_id_centro_dependo, v_id_delegado_titular_centro, 
												current, 5, 'Delegacion terminada previamente', user);
							end if;
						end if;
					else
						if v_delegaciones = 1 then
							Let v_delegaciones_b = 0;  -- busca si ya estan terminadas
							SELECT COUNT(*) INTO v_delegaciones_b FROM t42_centros a, t42_personas b, t42_deleg c, t42_seguimiento d  
							WHERE a.centros_dep = v_id_centro_dependo  AND b.t42_centros_id = a.id  AND c.id = b.t42_deleg_id
							AND d.t42_centros_id = b.t42_centros_id  AND d.usuario_seg = b.t42_deleg_id
							AND d.t42_doctos_id = v_t42_doctos_id AND ((d.t42_statusseg_id = 5) or (d.t42_statusseg_id = 3));

							if v_delegaciones_b = v_delegaciones then  -- terminar el seguimiento
								-- verificar si ya lo termine, de lo contrario terminarlo
								Let v_terminado = 0;
								SELECT count(*) INTO v_terminado  FROM t42_seguimiento 
								WHERE t42_doctos_id = v_t42_doctos_id AND t42_centros_id = v_id_centro_dependo  
								AND usuario_seg = v_id_delegado_titular_centro AND t42_statusseg_id = 5;

								if v_terminado = 0 then
									insert into t42_seguimiento(id, t42_doctos_id, t42_centros_id, usuario_seg, 
												fec_seg, t42_statusseg_id, observacion, usuario_mov) 
									values (0, v_t42_doctos_id, v_id_centro_dependo, v_id_delegado_titular_centro, 
												current, 5, 'Delegacion terminada previamente', user);
								end if;
							end if;
						end if;
					end if;
				end if;

 			end foreach;

		else	
			
			SELECT count(*)  INTO v_delegados_dep	FROM t42_deleg a, t42_deleg b  --  busco si tengo delegados
			WHERE a.id = v_id_delegado_titular_centro  
			AND b.t42_personas_id = a.t42_personas_id  AND b.autorizado = 0;

			if v_delegados_dep > 0 then  
				foreach
				SELECT t42_doctos_id INTO v_t42_doctos_id FROM t42_seguimiento -- busco si tengo documentos para delegar
				WHERE t42_centros_id = v_id_centro_dependo  
				AND usuario_seg = v_id_delegado_titular_centro 
				AND t42_statusseg_id = 1 order by t42_doctos_id

					Let v_delegaciones = 0;  
					SELECT count(*) INTO v_delegaciones FROM t42_deleg a, t42_deleg b, t42_seguimiento c  -- busco uno a uno de los documentos si lo delegue
					WHERE a.id = v_id_delegado_titular_centro   AND b.t42_personas_id = a.t42_personas_id  AND b.autorizado = 0
					AND c.usuario_seg = b.id AND c.t42_doctos_id = v_t42_doctos_id AND c.t42_statusseg_id = 1;

					if v_delegaciones > 0 then -- tiene el documento delegacion

						if v_delegaciones > 1 then
							Let v_delegaciones_b = 0;  -- busca si ya estan terminadas
							SELECT count(*) INTO v_delegaciones_b FROM t42_deleg a, t42_deleg b, t42_seguimiento c
							WHERE a.id = v_id_delegado_titular_centro   AND b.t42_personas_id = a.t42_personas_id  AND b.autorizado = 0
							AND c.usuario_seg = b.id AND c.t42_doctos_id = v_t42_doctos_id AND ((c.t42_statusseg_id = 5) or (c.t42_statusseg_id = 3));

							if v_delegaciones_b = v_delegaciones then  -- terminar el seguimiento
								-- verificar si ya lo termine, de lo contrario terminarlo
								Let v_terminado = 0;
								SELECT count(*) INTO v_terminado  FROM t42_seguimiento 
								WHERE t42_doctos_id = v_t42_doctos_id AND t42_centros_id = v_id_centro_dependo  
								AND usuario_seg = v_id_delegado_titular_centro AND t42_statusseg_id = 5;

								if v_terminado = 0 then
									insert into t42_seguimiento(id, t42_doctos_id, t42_centros_id, usuario_seg, 
												fec_seg, t42_statusseg_id, observacion, usuario_mov) 
									values (0, v_t42_doctos_id, v_id_centro_dependo, v_id_delegado_titular_centro, 
												current, 5, 'Delegacion terminada previamente', user);
								end if;
							end if;
						else
							if v_delegaciones = 1 then
								Let v_delegaciones_b = 0;  -- busca si ya estan terminadas
								SELECT count(*) INTO v_delegaciones_b FROM t42_deleg a, t42_deleg b, t42_seguimiento c
								WHERE a.id = v_id_delegado_titular_centro   AND b.t42_personas_id = a.t42_personas_id  AND b.autorizado = 0
								AND c.usuario_seg = b.id AND c.t42_doctos_id = v_t42_doctos_id AND ((c.t42_statusseg_id = 5) or (c.t42_statusseg_id = 3));

								if v_delegaciones_b = v_delegaciones then  -- terminar el seguimiento
									-- verificar si ya lo termine, de lo contrario terminarlo
									Let v_terminado = 0;
									SELECT count(*) INTO v_terminado  FROM t42_seguimiento 
									WHERE t42_doctos_id = v_t42_doctos_id AND t42_centros_id = v_id_centro_dependo  
									AND usuario_seg = v_id_delegado_titular_centro AND t42_statusseg_id = 5;

									if v_terminado = 0 then
										insert into t42_seguimiento(id, t42_doctos_id, t42_centros_id, usuario_seg, 
												fec_seg, t42_statusseg_id, observacion, usuario_mov) 
										values (0, v_t42_doctos_id, v_id_centro_dependo, v_id_delegado_titular_centro, 
												current, 5, 'Delegacion terminada previamente', user);
									end if;
								end if;
							end if;
						end if;
					end if;
				end foreach;
			end if;
		end if;
      end if;
end if;
  return v_status,v_mensaje  with resume;

end procedure;

CREATE PROCEDURE "pgmoreno".con16_detcont_04 ( p_tipo char(1), p_Adeudos Char(1), pref varchar(20))
{######################################################################
#  Procedimiento:    con16_detcont_04
#  Descripcion:      Interfaz de consulta del Padron de ASEO CONTRATADO en el m�dulo de ModulosGdl
#  Parametros de entrada: p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#                         p_Adeudos  = tipo de adeudo deseado
#                                      'C' THEN  -- CON ADEUDO ALGUNO
#                                      'S' THEN  -- SIN ADEUDO ALGUNO
#                                      'T' THEN  -- TODOS
#                         pref   = Hasta el periodo requerido         ejem: '2013-10'
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            17 Marzo 2015   
#
#  Llamado por:      Procedimiento desde modulo de ASEO CONTRATADO
#  Llama a:          
#  
######################################################################}
    RETURNING CHAR(2) 		as OFNA,
              VARCHAR(20) 	as TIPO_ASEO,
              INTEGER 		as NUM_CONTRATO,
              VARCHAR(200) 	as NOM_EMPRESA,
              VARCHAR(200) 	as DOMICILIO,
              CHAR(2) 		as VIGENCIA,
	      DATE    		as INICIO_OBLIGACION,
	      DATE    		as FECHA_BAJA,
	      DATE    		as PRIMER_ADEUDO,

              Money(12,2) 	as TOTAL_ADEUDOS,
              Money(12,2) 	as TOTAL_RGOS,
              Money(12,2) 	as TOTAL_DSCTO_RGOS,
	      Money(12,2) 	as TOTAL_PAGOS,

	      Money(12,2)	AS MULTAS,
              Money(12,2)	AS DSCTO_MULTAS,
	      Money(12,2)	AS GASTOS,
	      varchar(255)	AS DOCUMENTOS;


  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec      Integer;
  define v_nombre, v_domicilio, v_tipo_aseo                                         varchar(80);
  define v_tipo_recolec                                                             varchar(20);
  define v_sector, v_status_vigencia                                                Char(1);
  define v_fecha_ini, v_fecha_hora_baja, v_fecha_primer_adeudo, v_aso_mes_pago      Date;

  define v_DetFolReq								    varchar(120);
  define v_total_adeudos, v_total_recargos, v_dscto_recargos, v_total_pagos         Money(12,2);
  define v_tot_multas, v_tot_dscto_multas, v_tot_gastos, v_importe_multa, v_importe_gastos Money(12,2);
  define v_porcentaje_multa							    smallint;
  define v_folio_req, v_id_control						    Integer;
  define v_diligencia								    char(1);

  define v_Periodo_CN, v_Periodo_EXE, v_ref					    varchar(7);
  define v_contador, v_axo, v_Mes, v_ctrol_oper, v_FolReq			    Integer;
  define v_importe, v_importe_recargo, v_importe_rec1, v_importe_rec2		    Money(12,2);
  define v_mensaje_proc                                                             varchar(255);

----------------------
Let v_contador = 0;
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_total_adeudos = 0;
LET v_total_recargos= 0;
LET v_dscto_recargos= 0;
LET v_total_pagos   = 0;

Let v_fecha_ini = '';
Let v_fecha_hora_baja = '';
Let v_fecha_primer_adeudo = '';

Let v_ctrol_oper = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;
if trim(pref)='' then
   let v_ref=9999 || '-' || 12;
else
   let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;


FOREACH
	SELECT a.control_contrato, a.num_contrato, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, 
       	       a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja, a.status_vigencia 
          Into  v_Control, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, 
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja, v_status_vigencia

	FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d 
	WHERE b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo
		and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
		and d.ctrol_recolec = a.ctrol_recolec
	Order by a.num_contrato
   
	Let v_tot_multas = 0;
	Let v_tot_dscto_multas = 0;
        Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
     FOREACH
                Select id_control,   folio,	    diligencia,	  importe_multa,   importe_gastos,   porcentaje_multa
                Into   v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos, v_porcentaje_multa 
                from ta_15_apremios
                     Where modulo = 16  And control_otr = v_Control
                     And vigencia = "1" and clave_practicado = "P"
                     Order By id_control

		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
		else
		   Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
		end if;
     END FOREACH;
		Let v_tot_multas = v_importe_multa;
                if v_porcentaje_multa < 100 then
                	Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                else
                	Let v_tot_dscto_multas = 0;
		end if;

    
     FOREACH
      		Select Year(h.aso_mes_pago), h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago), ctrol_operacion
                  Into v_axo, v_aso_mes_pago, v_importe, v_Mes, v_ctrol_oper 
                From ta_16_pagos H
                  Where H.Control_Contrato = v_Control 
                    and H.aso_mes_pago <= ( v_ref )  and H.Status_Vigencia = 'V'
		    Order By h.aso_mes_pago

                               if v_importe > 0 then
                                  if v_contador = 0 then
				     Let v_fecha_primer_adeudo = v_aso_mes_pago;
				     Let v_contador = v_contador + 1;
				  end if;
				  LET v_total_adeudos = v_total_adeudos + v_importe;

				  if v_ctrol_oper = 6 then
                                  	Select sum(porc_recargo) 
                                  	Into v_Importe_recargo
                                  	From ta_16_recargos 
                                  	Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);
				  else
                                  	Select sum(porc_recargo) 
                                  	Into v_Importe_recargo
                                  	From ta_16_recargos 
                                  	Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);
				  end if;

                                   if v_Importe_recargo > 0 then
                                      LET v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                      LET v_total_recargos = v_total_recargos + v_importe_rec1;

                                      EXECUTE PROCEDURE sp_desctomerc (v_Control, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
								INTO v_importe_rec2, v_mensaje_proc;
                                      if v_importe_rec2 > 0 then
					 LET v_dscto_recargos = v_dscto_recargos + v_importe_rec2;
                                      end if;
                                   end if;
                               end if;
     END FOREACH;
     FOREACH
      		Select sum(h.importe)  Into v_importe
                From ta_16_pagos H
                  Where H.Control_Contrato = v_Control 
                    and H.aso_mes_pago <= ( v_ref )  and H.Status_Vigencia = 'P'

                               if v_importe > 0 then
				  LET v_total_pagos = v_total_pagos + v_importe;
                               end if;
     END FOREACH;

IF p_Adeudos = 'C' THEN  -- CON ADEUDO ALGUNO
  IF (v_total_adeudos <> 0 or v_total_recargos <> 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
			v_fecha_ini, v_fecha_hora_baja, v_fecha_primer_adeudo, 
			v_total_adeudos, v_total_recargos, v_dscto_recargos, v_total_pagos, 
			v_tot_multas, v_tot_dscto_multas, v_tot_gastos, v_DetFolReq with resume; 
  END IF;
END IF;

IF p_Adeudos = 'S' THEN  -- SIN ADEUDO ALGUNO
  IF (v_total_adeudos = 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
			v_fecha_ini, v_fecha_hora_baja, v_fecha_primer_adeudo, 
			v_total_adeudos, v_total_recargos, v_dscto_recargos, v_total_pagos, 
			v_tot_multas, v_tot_dscto_multas, v_tot_gastos, v_DetFolReq with resume; 
  END IF;
END IF;

IF p_Adeudos = 'T' THEN  -- TODOS
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
			v_fecha_ini, v_fecha_hora_baja, v_fecha_primer_adeudo, 
			v_total_adeudos, v_total_recargos, v_dscto_recargos, v_total_pagos, 
			v_tot_multas, v_tot_dscto_multas, v_tot_gastos, v_DetFolReq with resume; 
END IF;

Let v_contador = 0;
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
Let v_fecha_ini = ' ';
Let v_fecha_hora_baja = ' ';
Let v_fecha_primer_adeudo = ' ';

LET v_total_adeudos = 0;
LET v_total_recargos= 0;
LET v_dscto_recargos= 0;
LET v_total_pagos   = 0;

Let v_FolReq = 0;
Let v_tot_multas = 0;
Let v_tot_dscto_multas = 0;
Let v_tot_gastos = 0;
Let v_importe_multa = 0;
Let v_importe_gastos = 0;


END FOREACH;

end procedure;

CREATE PROCEDURE "informix".sp42_ctro_titular ( popc char(1), pc_num int, pc_nom varchar(100), pc_abrev varchar(40), pc_dom varchar(200), pc_origen char(1), pc_ctro_dep int, pc_status int,
                                                                              pt_paterno varchar(50), pt_materno varchar(50), pt_nombre varchar(50), pt_nombra varchar(200), pt_abrev varchar(10), pt_trato varchar(10), 
                                                                              pt_fecini date, pt_fecfin date, pt_email varchar(100), pt_status int, p_usuario varchar(10), p_deleg int )

returning   int as estatus,
            varchar(100) as mensaje;

define v_status, v_per_dep, v_centro_nvo, persona_nvo, delegado_nvo  int;
define v_mensaje varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp42_ctro_titular ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

if pc_ctro_dep = 0 then
  let v_per_dep = 0;
else
   select b.id  into v_per_dep 
   from t42_centros a, t42_personas b
   where a.id = pc_ctro_dep
   and b.t42_centros_id = a.id;
   if v_per_dep is null then
      return -1,'Error no dio dato de la persona que depende';
   end if;
end if;

if popc='A' then
                insert into t42_centros ( id, numero, nombre, abreviatura, domicilio, origen, centros_dep, usuario_mov, fec_mov,                 t42_status_id )
                                               values(0, pc_num, pc_nom, pc_abrev, pc_dom, pc_origen, pc_ctro_dep, p_usuario, current, pc_status );
                let v_centro_nvo = dbinfo("sqlca.sqlerrd1");

                if v_centro_nvo <> 0 then          
                               if pc_origen = 'I' then
                                               insert into t42_personas ( id, a_paterno, a_materno, nombres, nombramiento, t42_centros_id, t42_personas_id, abreviatura, trato, 
                                                                              fec_inicio, fec_fin, e_mail, usuario_mov, fec_mov, t42_status_id, t42_deleg_id )
                                                               values(0,             pt_paterno, pt_materno, pt_nombre, pt_nombra, v_centro_nvo, v_per_dep, pt_abrev, pt_trato, 
                                                                              pt_fecini, pt_fecfin, pt_email, p_usuario, current, pt_status, p_deleg );
                                                               let persona_nvo = dbinfo("sqlca.sqlerrd1");
                                               if persona_nvo <> 0 then
                                                               let v_status = 0;
                                                               let v_mensaje = 'SE CREO CORRECTAMENTE EL CENTRO Y SU TITULAR';
                                               else
                                                               let v_status = -1;
                                                               let v_mensaje = 'NO SE CREO EL TITULAR DEL CENTRO';
                                               end if;
                               else
                                               let v_status = 0;
                                               let v_mensaje = 'SE CREO CORRECTAMENTE EL CENTRO';
                               end if;
                else
                               let v_status = -1;
                               let v_mensaje = 'NO SE CREO EL CENTRO';
                end if;
end if;
   return v_status, v_mensaje;

end procedure;

CREATE PROCEDURE "informix".sp42_captura (pid int,paxo int, pcentro_env int, pcentro_rec int, ptdoc int,pnum int,pnombre varchar(30),pfdoc date,
pfreg datetime year to second,pflim datetime year to minute,ptcontrol char(1),pprior int,presp int,pstatus int,
ptexto references text,popc char(1),preqresp char(1))

returning   int as estatus,
            varchar(100) as mensaje;

define v_status_g, v_status, v_status2, v_status3, v_status4, v_iduser, v_ctrouser, v_iduser_rec, v_iduser_env, v_iduser_existe  int;
define v_mensaje varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_origen_centro Char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp42_captura ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

if paxo<2012 then -- validacion del ejercicio
   return -1,'Error en a�o de ejercicio, el a�o debe ser igual � mayor a 2013';
end if;

if pcentro_rec<=0 then -- validacion del centro (letras del oficio)
   return -1,'Error en letras del oficio, no existe el titular de la unidad responsable';
end if;

if ptdoc<=0 then -- validacion del tipo de documento
   return -1,'Error en tipo de documento, falta seleccionar el documento';
end if;
                --if pnum<=0 then -- validacion del numero de oficio    -- omitiendo la validacion para poder capturar documentos con numero de documento 0
                --return -1,'Error en numero de oficio, falta capturar el numero';
                --end if;

if trim(pnombre)='' then -- validacion del numero de oficio
   return -1,'Error, oficio no valido';
end if;

if pfdoc<mdy(10,1,2012) then -- validacion de fecha documento
   return -1,'Error en fecha del documento, la fecha debe ser igual � mayor a 1/10/2012';
end if;

--if date(pfreg)<mdy(10,1,2012) then -- validacion de fecha registro
--   return -1,'Error en fecha del registro, la fecha debe ser igual � mayor a 1/10/2012';
--end if;
--if not date(pflim) is null  then -- validacion de fecha limite
--   if date(pflim)<mdy(10,1,2012) then
--      return -1,'Error en fecha limite, la fecha debe ser igual � mayor a 1/10/2012';
--   end if;
--else
--   let pflim=null;
--end if;

if ptcontrol<>'E' then -- validacion tipo de control
   if ptcontrol<>'R' then
      return -1,'Error en tipo de control, Solo se acepta (E)-envio � (R)-recepci�n';
   end if;
end if;

if pprior<=0 then -- validacion de prioridad
   return -1,'Error en prioridad, falta seleccionar la prioridad';
end if;

if pstatus<=0 then -- validacion del estatus
   return -1,'Error en vigencia, falta seleccionar el estado del documento';
end if;

if length(ptexto)<=9 then -- validacion del texto
  return -1,'Error en texto del oficio, la informacion de texto debe ser mas explicita';
end if;

select b.id, d.id into v_iduser, v_ctrouser 
from t42_deleg a,           t42_personas b,              t42_centros d
where a.usuario=user and a.t42_status_id=1 and b.id=a.t42_personas_id and d.id=b.t42_centros_id;
if v_ctrouser is null then
   return -1,'Error falta dar de alta en delegados al usuario que da de alta';
end if;

-- generado para centros externos
select origen  INTO v_origen_centro
from t42_centros
where id = pcentro_env;
if v_origen_centro is null then
   return -1,'Error No existe el centro que envia';
end if;


if ptcontrol = 'R' then
                if substr(pnombre,1,5) = 'DJ/OP' then
                               Let v_iduser_existe = 1;
                               lET v_iduser_env = 1;
                else
                                               if v_origen_centro = 'E' then     -- generado para centros externos
                               Let v_iduser_existe = 1;
                               lET v_iduser_env = 1;
                                               else
                               select c.id  INTO v_iduser_existe
                               from t42_centros a, t42_personas b, t42_deleg c
                               where a.id = pcentro_env  and b.t42_centros_id = a.id  and c.id = b.t42_deleg_id and c.autorizado = 1;
                               if v_iduser_existe is null then
                                               return -1,'Error ya existe centro con delegado responsable por lo tanto tu no puedes generar';
                               end if;

                               select id  into v_iduser_env 
                               from t42_personas 
                               where t42_centros_id = pcentro_env;
                               if v_iduser_env is null then
                                               return -1,'Error falta dar de alta en personas al titular del centro que genera el envio ';
                               end if;
                                               end if;
                end if;
else
                select c.id  INTO v_iduser_existe
                from t42_centros a, t42_personas b, t42_deleg c
                where a.id = pcentro_env  and b.t42_centros_id = a.id  and c.id = b.t42_deleg_id and c.autorizado = 1;
                if v_iduser_existe is null then
                               return -1,'Error ya existe centro con delegado responsable por lo tanto tu no puedes generar';
                end if;

                select id  into v_iduser_env 
                from t42_personas 
                where t42_centros_id = pcentro_env;
                if v_iduser_env is null then
                               return -1,'Error falta dar de alta en personas al titular del centro que genera el envio ';
                end if;

end if;


select t42_deleg_id  into v_iduser_rec -- TENIA ID Y CAMBIE A T42_DELEG_ID
from t42_personas 
where t42_centros_id = pcentro_rec;
if v_iduser_rec is null then
   return -1,'Error falta dar de alta en personas al titular del centro o delegado del mismo ';
end if;

Let v_status_g = 0;
Let v_status = 0;
Let v_status2 = 0;
Let v_status3 = 0;
Let v_status4 = 0;

if popc='A' then
                insert into t42_control (id,ejercicico,t42_centros_id,t42_tipodocs_id,numero,nombre_generico,fec_docto,
                                fec_rgs,fec_limite,tipo_control,t42_prioridad_id,t42_control_id_resp,usuario_mov,fec_mov,t42_status_id,
                               texto,t42_centro_id_captura)
                values(0,paxo,pcentro_env,ptdoc,pnum,pnombre,pfdoc,
                               pfreg,pflim,ptcontrol,pprior,presp,user,current,pstatus,
                               ptexto,v_ctrouser);
                let v_status=dbinfo("sqlca.sqlerrd1");

                if v_status <> 0 then
                                Let v_status_g = v_status;
                               Let v_mensaje = 'OFICIO CAPTURADO CORRECTAMENTE';
                               if ptcontrol = 'E' then
                                               EXECUTE PROCEDURE sp42_doctos ( 'E', v_status, pcentro_rec, v_iduser_rec, preqresp, pstatus )  INTO v_status2, v_mensaje;
                                               if v_status2 <> 0 then
                                                               Let v_mensaje = 'OFICIO CAPTURADO CORRECTAMENTE';
                                                               EXECUTE PROCEDURE sp42_seguim ( v_status2, pcentro_rec, v_iduser_rec, 1, '' )  INTO v_status3, v_mensaje;
                                                               if v_status3 <> 0 then
                                                                              Let v_mensaje = 'OFICIO CAPTURADO CORRECTAMENTE';
                                                               else
                                                                              Let v_status_g = -1;
                                                                              Let v_mensaje = 'NO SE CREO EL SEGUIMIENTO DE ENVIO';
                                                               end if;
                                               else
                                                               Let v_status_g = -1;
                                                               Let v_mensaje = 'NO SE CREO EL DOCUMENTO';
                                               end if;
                               else
                                               EXECUTE PROCEDURE sp42_doctos ( 'R', v_status, pcentro_rec, v_iduser_rec, preqresp, pstatus )  INTO v_status2, v_mensaje;
                                               if v_status2 <> 0 then
                                                               Let v_mensaje = 'OFICIO CAPTURADO CORRECTAMENTE';
                                                               EXECUTE PROCEDURE sp42_seguim ( v_status2, pcentro_rec, v_iduser_rec, 1, '' )  INTO v_status3, v_mensaje;  -- ENVIO
                                                               if v_status3 <> 0 then
                                                                              Let v_mensaje = 'OFICIO CAPTURADO CORRECTAMENTE';
                                                                              EXECUTE PROCEDURE sp42_seguim ( v_status2, pcentro_rec, v_iduser_rec, 2, '' )  INTO v_status4, v_mensaje;  -- RECEPCION
                                                                              if v_status4 <> 0 then
                                                                                              Let v_mensaje = 'OFICIO CAPTURADO CORRECTAMENTE';
                                                                              else
                                                                                              Let v_status_g = -1;
                                                                                              Let v_mensaje = 'NO SE CREO EL SEGUIMIENTO DE RECEPCION';
                                                                              end if;
                                                               else
                                                                              Let v_status_g = -1;
                                                                              Let v_mensaje = 'NO SE CREO EL SEGUIMIENTO DE ENVIO';
                                                               end if;
                                               else
                                                               Let v_status_g = -1;
                                                               Let v_mensaje = 'NO SE CREO EL DOCUMENTO';
                                               end if;
                               end if;
                else
                               Let v_status_g = -1;
                               Let v_mensaje = 'NO SE REALIZO LA CREACION DEL REGISTRO DE CONTROL';   
                end if;
end if;

if popc='M' then
   if pid=0 then -- validacion de id control
                Let v_status_g = -1;
                Let v_mensaje = 'CONTROL NO VALIDO';            
   end if;
   if date(pflim)<mdy(10,1,2012) then
      update t42_control set 
                nombre_generico = pnombre, 
                t42_tipodocs_id=ptdoc, 
                fec_docto=pfdoc, 
                fec_rgs=null,
                fec_limite=null, 
                tipo_control=ptcontrol, 
                t42_prioridad_id=pprior, 
                t42_control_id_resp=presp, 
                usuario_mov=user, 
                fec_mov=current, 
                t42_status_id=pstatus, 
                texto=ptexto 
                               where id=pid;
                Let v_status_g = 1;
                Let v_mensaje = 'OFICIO MODIFICADO CORRECTAMENTE';       
   else
      update t42_control set 
                numero = pnum, 
                nombre_generico = pnombre, 
                t42_tipodocs_id=ptdoc, 
                fec_docto=pfdoc, 
                fec_rgs=pfreg, 
                fec_limite=pflim, 
                tipo_control=ptcontrol, 
                t42_prioridad_id=pprior, 
                t42_control_id_resp=presp, 
                usuario_mov=user, 
                fec_mov=current, 
                t42_status_id=pstatus, 
                texto=ptexto 
                               where id=pid;
                Let v_status_g = 1;
                Let v_mensaje = 'OFICIO MODIFICADO CORRECTAMENTE';       
   end if;   
end if; 

                return v_status_g, v_mensaje;
end procedure;

CREATE PROCEDURE "informix".spfacele_contrib_abc(
    p_RFC varchar(13),
    p_razon varchar(100),
    p_calle  VARCHAR(80),
    p_no_ext VARCHAR(10),
    p_no_int VARCHAR(10),
    p_colonia VARCHAR(30),
    p_municipio VARCHAR(30),
    p_estado VARCHAR(30),
    p_email  varchar(100),
    p_cp INT , p_opc char(1) )
returning  integer as clave , varchar(100) as observacion  ;

define v_contrfc int; 
define v_id_persona int;
define v_cont_fact int;

--altas

if p_opc = 'A' then
     -- verificar que el RFC no exita.
   select count(rfc) into v_contrfc from ta_12_personas_fiscal where rfc = p_rfc;
   if v_contrfc > 0 then
    return -1 , 'YA EXISTE EL RFC,  VERFICAR' ;
   end if;
   insert into ta_12_personas_fiscal ( id_persona , RFC , Razon_social , fecha )
   values(0, p_RFC , p_razon , today  );
   let v_id_persona = dbinfo("sqlca.sqlerrd1");
   insert into ta_12_domicilio_fiscal (id_domicilio,
    id_persona , calle  , no_ext , no_int , colonia , municipio , estado, email, cp , fecha , vigente )
    values(0, v_id_persona , p_calle ,p_no_ext , p_no_int, p_colonia , p_municipio, p_estado,
    p_email  , p_cp , today , 'V');
    return 0,'REGISTRO CORRECTO...';
end if;
if p_opc = 'B' then
    -- verificar que no existan facturas con este rfc  select rowid ,* from ta_12_fact_elec
     select count(*) into v_cont_fact from ta_12_fact_elec where rfc = p_rfc;
    if v_cont_fact > 0 then
      return -4  , 'HAY FACTURAS HECHAS A ESTE RFC, NO SE PUEDE DAR ELIMINAR EL REGISTRO.';
    end if;
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       delete ta_12_personas_fiscal where rfc = p_rfc;
       delete ta_12_domicilio_fiscal  where id_persona = v_id_persona ;
    return 0,'REGISTRO DADO DE BAJA CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;
if p_opc = 'M' then
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       update ta_12_personas_fiscal set razon_social = p_razon where rfc = trim(p_rfc);
    update ta_12_domicilio_fiscal set calle = p_calle , no_ext = p_no_ext , no_int = p_no_int, 
   colonia = p_colonia , municipio = p_municipio, estado = p_estado, email = p_email, cp = p_cp 
   where id_persona = v_id_persona and vigente = 'V' ;
   
   return 0,'REGISTRO ACTUALIZADO CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;

if p_opc = 'W' then --registro por web
     -- verificar que el RFC no exita.
   select id_persona,count(rfc) into v_id_persona,v_contrfc from ta_12_personas_fiscal where rfc = p_rfc group by id_persona;
   if v_contrfc > 0 then
    return v_id_persona , 'YA EXISTE EL RFC' ;
   end if;

   if length(trim(p_RFC))<12 then
      return -1 , 'RFC INCORRECTO, VERIFIQUE' ;
   end if;

   if trim(p_RFC)='' or trim(p_razon)='' or trim(p_calle)='' or trim(p_no_ext)='' or trim(p_colonia)='' or trim(p_municipio)='' or
      trim(p_estado)='' or trim(p_email)='' or p_cp=0 OR p_cp IS NULL then
      return -1 , 'CAPTURE LOS DATOS COMPLETOS' ;
   end if;

   insert into ta_12_personas_fiscal ( id_persona , RFC , Razon_social , fecha )
   values(0, p_RFC , p_razon , today  );
   let v_id_persona = dbinfo("sqlca.sqlerrd1");
   insert into ta_12_domicilio_fiscal (id_domicilio,
    id_persona , calle  , no_ext , no_int , colonia , municipio , estado, email, cp , fecha , vigente )
    values(0, v_id_persona , p_calle ,p_no_ext , p_no_int, p_colonia , p_municipio, p_estado,
    p_email  , p_cp , today , 'V');
    return v_id_persona,'REGISTRO CORRECTO...';
end if;

if p_opc = 'E' then --Edicion desde web, no se actualiza rfc, razon y email
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       update ta_12_personas_fiscal set razon_social = p_razon where rfc = trim(p_rfc);
       update ta_12_domicilio_fiscal set calle = p_calle , no_ext = p_no_ext , no_int = p_no_int, 
       colonia = p_colonia , municipio = p_municipio, estado = p_estado, cp = p_cp 
       where id_persona = v_id_persona and vigente = 'V' ;
   
   return 0,'REGISTRO ACTUALIZADO CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;

 return -2,'OPCION INCORRECTA, VERIFICAR...';

end procedure;

CREATE PROCEDURE "pgmoreno".sp42_reportes ( par_aut char(1), par_usuario char(10), par_opc char(1), p_Fec_Ini Date, p_Fec_Fin Date)

Returning   int as status,
	    varchar(50) as mensaje,
	    int as t42_doctos_id,
            int as t42_centros_id,
	    int as usuario_seg,
	    int as t42_control_id,
	    varchar(100) as centro_origen,
	    int as ejercicio,
	    int as numero,
	    varchar(30) as nombre_generico,
	    varchar(50) as tipo_documento,
            date as fecha_docto,
            date as fecha_registro,
            datetime year to second as fecha_limite;

       
define vv_id_docto, vv_id_centro, vv_id_control, vv_ejercicio, vv_numero, v_terminado, v_terminado_1, v_status		int; 
define vv_centro_origen													varchar(100); 
define vv_nombre_generico												varchar(30);
define VV_tipo_documento												varchar(50);
define vv_fec_docto, vv_fec_rgs												date;
define vv_fec_limite													datetime year to second;
define v_mensaje, vv_texto												varchar(255);
define v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo	int;


Let v_id_usuario_delegado = 0;
Let v_autorizado = 0;
Let v_id_persona_dependo = 0;
Let v_id_delegado_titular_centro = 0;
Let v_id_centro_dependo = 0;

Let vv_ejercicio = 0;
Let vv_numero = 0;
Let vv_id_centro = 0;
Let vv_id_control = 0;
Let vv_id_docto = 0;
Let v_terminado = 0;
Let v_terminado_1 = 0;

Let vv_centro_origen = '';
Let vv_nombre_generico = '';
Let vv_centro_origen = '';
Let vv_fec_docto = Null;
Let vv_fec_rgs = Null;
Let vv_fec_limite = Null;
Let vv_texto = '';


Let v_status = 0;
Let v_mensaje = 'CONSULTA CORRECTA';

if exists( SELECT *  FROM t42_deleg WHERE usuario = par_usuario ) then
    SELECT nvl(a.id,0) id_usuario_delegado, a.autorizado, (a.t42_personas_id) id_persona_dependo, nvl(b.t42_deleg_id,0) id_delegado_titular_centro, nvl(c.id,0) id_centro_dependo
         INTO  v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo
         FROM t42_deleg a, t42_personas b, t42_centros c    WHERE a.usuario = par_usuario  
         and a.t42_personas_id = b.id  and b.t42_centros_id = c.id;
else
    Let v_id_usuario_delegado = 0;
end if;

if  (v_id_usuario_delegado = 0) or (v_id_usuario_delegado is Null) then
    Let v_status = -1;
    Let v_mensaje = 'Usuario Inexistente';
else
      if par_aut = 'A' then
		FOREACH
		SELECT a.t42_doctos_id, a.t42_centros_id, b.t42_control_id, (n.nombre) centro_origen,  
			c.ejercicico, c.numero, c.nombre_generico, (g.descripcion) tipo_documento, c.fec_docto, c.fec_rgs, c.fec_limite

		INTO	vv_id_docto, vv_id_centro, vv_id_control, vv_centro_origen, 
			vv_ejercicio, vv_numero, vv_nombre_generico, VV_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite

		FROM t42_seguimiento a, t42_doctos b, t42_control c, t42_centros n, t42_tipodocs g
		WHERE a.usuario_seg = v_id_usuario_delegado and a.t42_statusseg_id = 1
		AND a.t42_doctos_id = b.id 
		AND b.t42_control_id = c.id  and c.fec_docto between p_Fec_Ini and p_Fec_Fin
		AND n.id = c.t42_centros_id  and g.id = c.t42_tipodocs_id

			Let v_terminado = 0;
			SELECT count(*) INTO v_terminado  FROM t42_seguimiento 
			WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id in (3,5);

			if par_opc = 'Z' then -- Z .- TODOS
				return v_status, v_mensaje, vv_id_docto, vv_id_centro, v_id_usuario_delegado, vv_id_control, vv_centro_origen, 
				vv_ejercicio, vv_numero, vv_nombre_generico, VV_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
			else
				if par_opc = 'A' then -- A .- SOLO ENVIADOS
					Let v_terminado = 0;
					SELECT count(*) INTO v_terminado  FROM t42_seguimiento
					WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id > 1;
					if  v_terminado = 0 then
						return v_status, v_mensaje, vv_id_docto, vv_id_centro, v_id_usuario_delegado, vv_id_control, vv_centro_origen, 
						vv_ejercicio, vv_numero, vv_nombre_generico, VV_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
					end if;
				end if;

				if par_opc = 'B' then -- B .- HASTA RECIBIDOS
					Let v_terminado = 0;
					SELECT count(*) INTO v_terminado  FROM t42_seguimiento
					WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id = 2;
					if  v_terminado > 0 then
						Let v_terminado_1 = 0;
						SELECT count(*) INTO v_terminado_1  FROM t42_seguimiento
						WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id > 2;
						if v_terminado_1 = 0 then
							return v_status, v_mensaje, vv_id_docto, vv_id_centro, v_id_usuario_delegado, vv_id_control, vv_centro_origen, 
							vv_ejercicio, vv_numero, vv_nombre_generico, VV_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
						end if;
					end if;
				end if;

				if par_opc = 'D' then -- D .- RECHAZADOS
					Let v_terminado = 0;
					SELECT count(*) INTO v_terminado  FROM t42_seguimiento
					WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id = 3;
					if  v_terminado > 0 then
						return v_status, v_mensaje, vv_id_docto, vv_id_centro, v_id_usuario_delegado, vv_id_control, vv_centro_origen, 
						vv_ejercicio, vv_numero, vv_nombre_generico, VV_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
					end if;
				end if;

				if par_opc = 'C' then -- C .- EN PROCESO
					Let v_terminado = 0;
					SELECT count(*) INTO v_terminado  FROM t42_seguimiento
					WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id = 4;
					if  v_terminado > 0 then
						Let v_terminado_1 = 0;
						SELECT count(*) INTO v_terminado_1  FROM t42_seguimiento
						WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id in (3,5);
						if v_terminado_1 = 0 then
							return v_status, v_mensaje, vv_id_docto, vv_id_centro, v_id_usuario_delegado, vv_id_control, vv_centro_origen, 
							vv_ejercicio, vv_numero, vv_nombre_generico, VV_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
						end if;
					end if;
				end if;

				if par_opc = 'E' then -- E .- TERMINADOS
					Let v_terminado = 0;
					SELECT count(*) INTO v_terminado  FROM t42_seguimiento
					WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id = 5;
					if  v_terminado > 0 then
						return v_status, v_mensaje, vv_id_docto, vv_id_centro, v_id_usuario_delegado, vv_id_control, vv_centro_origen, 
						vv_ejercicio, vv_numero, vv_nombre_generico, VV_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
					end if;
				end if;

			end if;
                end foreach;
      end if;
end if;

end procedure;

CREATE PROCEDURE "informix".sp42_seguim ( pdoctos int, pcentro int, pid_usuario_seg int, pstatus int, pjustifica varchar(255) )

Returning   int as estatus,
            varchar(100) as mensaje;

define v_status, vid, vid_Rec, vid_Rec2               int;
define v_mensaje                        varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define v_id_usuario_delegado, v_autorizado, v_id_persona_dependo              int;
define v_id_delegado_titular_centro, v_id_centro_dependo                 int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp42_seguim ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

SELECT nvl(a.id,0) id_usuario_delegado, a.autorizado, (a.t42_personas_id) id_persona_dependo, 
nvl(b.t42_deleg_id,0) id_delegado_titular_centro, nvl(c.id,0) id_centro_dependo

INTO  v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, 
v_id_delegado_titular_centro, v_id_centro_dependo

FROM t42_deleg a, t42_personas b, t42_centros c    
WHERE a.usuario = User  and a.t42_personas_id = b.id  and b.t42_centros_id = c.id;

Let vid = 0;
Let vid_Rec = 0;
lET vid_Rec2 = 0;
Let v_status = 0;


if pstatus = 1 then
                               --select count(*)  into vid_Rec from t42_seguimiento where t42_doctos_id = pdoctos 
                               --and t42_centros_id = v_id_centro_dependo and usuario_seg = v_id_delegado_titular_centro and t42_statusseg_id = 2;
                               --if vid_Rec = 0 then
                               --insert into t42_seguimiento (id, t42_doctos_id, t42_centros_id, usuario_seg, fec_seg, t42_statusseg_id, observacion, usuario_mov) 
                               --                values (0, pdoctos, v_id_centro_dependo, v_id_delegado_titular_centro, current, 2, ' ', user);
                               --         let vid_Rec2 = 1;
                               --end if;

                select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = pstatus;
                if vid > 0 then
                               let v_status = -1;
                               let v_mensaje = 'YA EXISTE EL -ENVIO- DEL DOCUMENTO';
                else
                               insert into t42_seguimiento (id, t42_doctos_id, t42_centros_id, usuario_seg, fec_seg, t42_statusseg_id, observacion, usuario_mov) 
                                                               values (0, pdoctos, pcentro, pid_usuario_seg, current, pstatus, ' ', user);
                                                                              if vid_Rec2 = 1 then
                                                                                              let v_status=dbinfo("sqlca.sqlerrd1");
                                                let v_mensaje = 'SEGUIMIENTO DE -RECEPCION Y ENVIO- CORRECT0';
                                                                              else
                                                                                              let v_status=dbinfo("sqlca.sqlerrd1");
                                                let v_mensaje = 'SEGUIMIENTO DE -ENVIO- CORRECT0';
                                                                              end if;
                end if;
end if;
if pstatus = 2 then
                select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id > pstatus;
                if vid > 0 then
                               let v_status = -1;
                               let v_mensaje = 'YA FUE -RECHAZADO-, -EN PROCESO- �  -TERMINADO-, POR LO TANTO NO PUEDE HABER -RECEPCION- DEL DOCUMENTO';
                else
                               Let vid = 0;
                               select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = pstatus;
                               if vid > 0 then
                                               let v_status = -1;
                                               let v_mensaje = 'YA EXISTE LA -RECEPCION- DEL DOCUMENTO';
                               else
                                               insert into t42_seguimiento (id, t42_doctos_id, t42_centros_id, usuario_seg, fec_seg, t42_statusseg_id, observacion, usuario_mov) 
                                                                                              values (0, pdoctos, pcentro, pid_usuario_seg, current, pstatus, ' ', user);
                                                                                              let v_status=dbinfo("sqlca.sqlerrd1");
                                                                                              let v_mensaje = 'SEGUIMIENTO DE -RECEPCION- CORRECT0';
                               end if;
                end if;
end if;
if pstatus = 3 then
                select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id > pstatus;
                if vid > 0 then
                               let v_status = -1;
                               let v_mensaje = 'NO PUEDES -RECHAZAR- EL DOCUMENTO SI EXISTE SEGUIMIENTO DE  -EN PROCESO-  �  -TERMINADO-';
                else
                               Let vid = 0;
                               select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = pstatus;
                               if vid > 0 then
                                               let v_status = -1;
                                               let v_mensaje = 'YA EXISTE EL -RECHAZO- DEL DOCUMENTO';
                               else
                                               insert into t42_seguimiento (id, t42_doctos_id, t42_centros_id, usuario_seg, fec_seg, t42_statusseg_id, observacion, usuario_mov) 
                                                                              values (0, pdoctos, pcentro, pid_usuario_seg, current, pstatus, pjustifica, user);
                                                                              let v_status=dbinfo("sqlca.sqlerrd1");
                                                                              let v_mensaje = 'SEGUIMIENTO DE -RECHAZO- CORRECT0';
                               end if;
                end if;
end if;
if pstatus = 4 then
                select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = 2;
                if vid > 0 then
                               Let vid = 0;
                               select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = 3;
                               if vid > 0 then
                                               let v_status = -1;
                                               let v_mensaje = 'NO PUEDES PONER TU SEGUIMIENTO -EN PROCESO- SI YA ESTA -RECHAZADO-';
                               else
                                               Let vid = 0;
                                               select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = 5;
                                               if vid > 0 then
                                                               let v_status = -1;
                                                               let v_mensaje = 'NO PUEDES PONER TU SEGUIMIENTO -EN PROCESO- SI YA ESTA -TERMINADO-';
                                               else
                                                               Let vid = 0;
                                                               select id  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = pstatus;
                                                               if vid > 0 then
                                                                              insert into t42_seguimiento_a (id, t42_seguimiento_id, observaciones, usuario_mov, fec_mov, t42_status_id ) 
                                                                                                              values (0, vid, pjustifica, user, current, 1);
                                                                                                              let v_status=dbinfo("sqlca.sqlerrd1");
                                                                                                              let v_mensaje = 'SEGUIMIENTO DE -EN PROCESO- CORRECT0';
                                                               else
                                                                              insert into t42_seguimiento (id, t42_doctos_id, t42_centros_id, usuario_seg, fec_seg, t42_statusseg_id, observacion, usuario_mov) 
                                                                                                              values (0, pdoctos, pcentro, pid_usuario_seg, current, pstatus, ' ', user);
                                                                                                              let v_status=dbinfo("sqlca.sqlerrd1");

                                                                              insert into t42_seguimiento_a (id, t42_seguimiento_id, observaciones, usuario_mov, fec_mov, t42_status_id ) 
                                                                                                              values (0, v_status, pjustifica, user, current, 1);

                                                                                                              let v_status=dbinfo("sqlca.sqlerrd1");
                                                                                                              let v_mensaje = 'SEGUIMIENTO DE -EN PROCESO- CORRECT0';
                                                               end if;
                                               end if;
                               end if;
                else
                               let v_status = -1;
                               let v_mensaje = 'NO PUEDES PONER TU SEGUIMIENTO -EN PROCESO-  SI AUN NO LO HAS -RECIBIDO-';
                end if;
end if;
if pstatus = 5 then
                select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = 2;
                if vid > 0 then
                               Let vid = 0;
                               select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = 3;
                               if vid > 0 then
                                               let v_status = -1;
                                               let v_mensaje = 'NO PUEDES PONER TU SEGUIMIENTO -TERMINADO- SI YA ESTA -RECHAZADO-';
                               else
                                                               select count(*)  into vid from t42_seguimiento where t42_doctos_id = pdoctos and t42_centros_id = pcentro and usuario_seg = pid_usuario_seg and t42_statusseg_id = pstatus;
                                                               if vid > 0 then
                                                                              let v_status = -1;
                                                                              let v_mensaje = 'YA EXISTE EL SEGUIMIENTO DE -TERMINADO- DEL DOCUMENTO';
                                                               else
                                                                              insert into t42_seguimiento (id, t42_doctos_id, t42_centros_id, usuario_seg, fec_seg, t42_statusseg_id, observacion, usuario_mov) 
                                                                                              values (0, pdoctos, pcentro, pid_usuario_seg, current, pstatus, pjustifica, user);
                                                                                              let v_status=dbinfo("sqlca.sqlerrd1");
                                                                                              let v_mensaje = 'SEGUIMIENTO DE -TERMINADO- CORRECT0';
                                                               end if;
                               end if;
                else
                               let v_status = -1;
                               let v_mensaje = 'NO PUEDES PONER TU SEGUIMIENTO -TERMINADO-  SI AUN NO LO HAS -RECIBIDO-';
                end if;
end if;
   return v_status,v_mensaje;

end procedure;

create procedure "pgcabrer".spd_11_pagosmercado(pdsd date,phst date)
returning   int as merc,
            varchar(60) as nombre,
            int as locales,
            money(16,2) as adeudo;

define v_merc,v_locales,v_id int;
define v_nombre varchar(60);
define v_adeudo money(16,2);

foreach
select a.num_mercado,d.descripcion,nvl(count(distinct a.id_local),0),sum(b.importe_pago)
into v_merc,v_nombre,v_locales,v_adeudo
from ta_11_locales a,ta_11_pagos_local b,ta_11_mercados d
where a.vigencia='A' and d.tipo_emision<>'B'
and (b.fecha_pago between pdsd and phst) 
and b.id_local=a.id_local and d.num_mercado_nvo=a.num_mercado
group by a.num_mercado,d.descripcion order by a.num_mercado

return v_merc,v_nombre,v_locales,v_adeudo with resume;
end foreach;
end procedure;

CREATE PROCEDURE "informix".sp42_seguim_doctos_lim ()

Returning   int as estatus,
            varchar(255) as mensaje,
                int as ejercicio,
                int as numero,
                varchar(30) as nombre_generico,
                int as id_centro_orden,
                varchar(100) as centro,
                int as id_control,
                date as fecha_docto,
                date as fecha_registro,
                Datetime year to second as fecha_limite;

define v_status                       int;
define v_mensaje                      varchar(255);
define v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo int;
define vv_ejercicio, vv_numero, vv_id_centro, vv_id_control, vv_id_docto, v_terminado                                                                      int; 
define vv_nombre_generico                                                                                                                                                                                 varchar(30);
define vv_centro_origen                                                                                                                                                                                                        varchar(100); 
define vv_fec_docto, vv_fec_rgs                                                                                                                                                                                        date;
define vv_fec_limite                                                                                                                                                                                                 datetime year to second;

Let v_id_usuario_delegado = 0;
Let v_autorizado = 0;
Let v_id_persona_dependo = 0;
Let v_id_delegado_titular_centro = 0;
Let v_id_centro_dependo = 0;
Let vv_ejercicio = 0;
Let vv_numero = 0;
Let vv_id_centro = 0;
Let vv_id_control = 0;
Let vv_id_docto = 0;
Let v_terminado = 0;

Let vv_nombre_generico = '';
Let vv_centro_origen = '';
Let vv_fec_docto = Null;
Let vv_fec_rgs = Null;
Let vv_fec_limite = Null;


Let v_status = 0;
Let v_mensaje = 'CONSULTA CORRECTA';

if exists( SELECT *  FROM t42_deleg WHERE usuario = User ) then
    SELECT nvl(a.id,0) id_usuario_delegado, a.autorizado, (a.t42_personas_id) id_persona_dependo, nvl(b.t42_deleg_id,0) id_delegado_titular_centro, nvl(c.id,0) id_centro_dependo
         INTO  v_id_usuario_delegado, v_autorizado, v_id_persona_dependo, v_id_delegado_titular_centro, v_id_centro_dependo
         FROM t42_deleg a, t42_personas b, t42_centros c    WHERE a.usuario = User  
         and a.t42_personas_id = b.id  and b.t42_centros_id = c.id;
else
    Let v_id_usuario_delegado = 0;
end if;

if  (v_id_usuario_delegado = 0) or (v_id_usuario_delegado is Null) then
    Let v_status = -1;
    Let v_mensaje = 'Usuario Inexistente';
else
      if v_autorizado = 1 then  --            PARA TITULAR O SUPLENTE DEL CENTRO
                               foreach
                               SELECT c.ejercicico, c.numero, c.nombre_generico, (f.id) id_centro, (f.nombre) centro_origen, 
                                               (c.id) id_control, c.fec_docto, c.fec_rgs, c.fec_limite, b.id
                               INTO     vv_ejercicio, vv_numero, vv_nombre_generico, vv_id_centro, vv_centro_origen, 
                                               vv_id_control, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_docto
                               FROM t42_seguimiento a, t42_doctos b, t42_control c, t42_centros f
                                               WHERE a.usuario_seg = v_id_delegado_titular_centro AND a.t42_statusseg_id = 1
                                               AND a.t42_doctos_id = b.id
                                               AND b.t42_control_id = c.id
                                               AND c.t42_status_id = 1 AND c.fec_limite is Not Null
                                               AND c.t42_centros_id = f.id
                               ORDER BY c.fec_docto desc, c.ejercicico, c.numero

                                               Let v_terminado = 0;
                                               SELECT count(*) INTO v_terminado  FROM t42_seguimiento 
                                               WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_delegado_titular_centro AND t42_statusseg_id in (3,5);
                                               if v_terminado = 0 then
                                                               return v_status,v_mensaje, vv_ejercicio, vv_numero, vv_nombre_generico, vv_id_centro, vv_centro_origen, vv_id_control, 
                                                               vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
                                               end if;
                               end foreach;

      else                     --            PARA CUALQUIER DELEGADO  *****************************************

                foreach
                               SELECT c.ejercicico, c.numero, c.nombre_generico, (f.id) id_centro, (f.nombre) centro_origen, 
                                               (c.id) id_control, c.fec_docto, c.fec_rgs, c.fec_limite, b.id 
                               INTO     vv_ejercicio, vv_numero, vv_nombre_generico, vv_id_centro, vv_centro_origen, 
                                               vv_id_control, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_docto
                               FROM t42_seguimiento a, t42_doctos b, t42_control c, t42_centros f
                                               WHERE a.usuario_seg = v_id_usuario_delegado AND a.t42_statusseg_id = 1
                                               AND a.t42_doctos_id = b.id
                                               AND b.t42_control_id = c.id
                                               AND c.t42_status_id = 1 AND c.fec_limite is Not Null
                                               AND c.t42_centros_id = f.id
                               ORDER BY c.fec_docto desc, c.ejercicico, c.numero

                                               Let v_terminado = 0;
                                               SELECT count(*) INTO v_terminado  FROM t42_seguimiento 
                                               WHERE t42_doctos_id = vv_id_docto AND usuario_seg = v_id_usuario_delegado AND t42_statusseg_id in (3,5);
                                               if v_terminado = 0 then
                                                               return v_status,v_mensaje, vv_ejercicio, vv_numero, vv_nombre_generico, vv_id_centro, vv_centro_origen, vv_id_control, 
                                                               vv_fec_docto, vv_fec_rgs, vv_fec_limite  with resume;
                                               end if;
                end foreach;
      end if;
end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_licgiro_apl (p_tipo char(1), p_numero int, p_LicGiro int )
{######################################################################
#  Procedimiento:    sp16_LicGiro_apl
#  Descripcion:      Aplicacion - relacion de Licencias de Giro con ASEO CONTRATADO
#
#  Parametros        p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:       p_numero   = Numero de Contrato
#  		     p_LicGiro	= Licencia de Giro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning  	int as status,
				varchar(255) as leyenda;

define v_status, v_grabado	int;
define v_leyenda		varchar(255);
        
define v_control_contrato	Int;

Let v_grabado		= 0;
Let v_status 		= 0;
let v_leyenda    	= '';
Let v_control_contrato 	= 0;


if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
		SELECT a.control_contrato INTO  v_control_contrato  FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero 
			and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

	if exists( select * from catastro_gdl:Licencias  where licencia = p_LicGiro ) then

		if not exists( SELECT * from ta_16_rel_licgiro where num_licencia = p_LicGiro and control_contrato = v_control_contrato  ) then
			insert into ta_16_rel_licgiro values ( 0, p_LicGiro, v_control_contrato, 'V' );
			let v_grabado = dbinfo("sqlca.sqlerrd1");

			if  v_grabado <> 0 then
				let v_status 		= 0;
				let v_leyenda    	= 'SE CREO RELACION DE LICENCIA DE GIRO CON EL CONTRATO';
			else
 				let v_status 		= -1;
				let v_leyenda    	= 'HUBO ERROR EN LA CREACION';
			end if;

		else
			let v_status 		= 3;
			let v_leyenda    	= 'YA EXISTE LA RELACION DE LICENCIA DE GIRO Y CONTRATO';
		end if;

	else
		Let v_status  = 2;
		Let v_leyenda = 'NO EXISTE LA LICENCIA DE GIRO';
	end if;

else
	let v_status 		= 1;	
	let v_leyenda    	= 'NO EXISTE EL CONTRATO';
end if;

	RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "informix".adeudo_consesta(
    p_placa varchar(10),
    p_fecha DATE,
    p_id_rec SMALLINT,
    p_caja CHAR(2),
    p_operacion INT
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;

--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);

--****** variables locales
define v_cvecuenta int;
define v_cvepago int;
define v_caja char(2);--
define v_operacion int;--
define v_fecha date;--
define v_id_rec smallint;--
define v_estatus char(1);
define v_linea char(33);

--Validar en ta_12_recibos

       if NOT exists (select * from ta_12_recibos where id_modulo=14 AND kio_num_terceros = p_placa
			and fecha = p_fecha and caja = p_caja and operacion=p_operacion and cvepago="P" ) then --recibos
	return -1,"NO EXISTEN PAGOS PARA ESTA PLACA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos

  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 
  where id_modulo=14 AND kio_num_terceros = p_placa
	and fecha = p_fecha and caja = p_caja and operacion=p_operacion and cvepago="P" ;

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"CUENTA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;
end procedure;

CREATE PROCEDURE "saranda".spd_13_abcpens(v_control int,v_axo int, v_porc int, v_usu int, v_reac char(1), v_opc int)
                returning smallint as par_ok, varchar(255)as par_observ;  
define      Vcontrol_des    int;
define      Vcontrol_rcm	INTEGER;
define      Vaxo_alta   	INTEGER;
define      Vdecuento   	INTEGER;
define      Vusuario    	INTEGER;
define      Vfecha_mov  	DATE;
define      Vaxo_ini    	INTEGER;
define      vini    	INTEGER;
define      vreac    	char(1);


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_altapens ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION



if v_opc=1 then
  if not exists(select * from ta_13_descpens where control_rcm=v_control and axo_descto=v_axo and vigencia='V') then
    insert into ta_13_descpens(
     control_des ,
     control_rcm ,
     axo_descto ,
     descuento ,
     usuario ,
     fecha_alta ,
     fecha_mov ,
     vigencia ,
     reactivar,tipo_descto
     )
 values(0, v_control, v_axo, v_porc, v_usu, today, today,'V',v_reac,'P'); 
    update ta_13_adeudosrcm  set descto_impote=(importe*v_porc/100) where control_rcm=v_control and axo_adeudo=v_axo;
     return 1,'Se ha dado de alta ';
  end if;
end if;

if v_opc=2 then
  update ta_13_descpens set fecha_mov=today, vigencia='B',reactivar=v_reac, usuario_mov=v_usu 
  where control_rcm=v_control and axo_descto=v_axo and vigencia='V'; 
  update ta_13_adeudosrcm  set descto_impote=0 where control_rcm=v_control and axo_adeudo=v_axo and vigencia='V';
   return 1,'Se ha dado de baja ';
end if;

if v_opc=3 then
  update ta_13_descpens set fecha_mov=today, reactivar=v_reac, usuario_mov=v_usu, descuento=v_porc 
   where control_rcm=v_control and axo_descto=v_axo and vigencia='V'; 
  update ta_13_adeudosrcm  set descto_impote=(importe*v_porc/100) where control_rcm=v_control and axo_adeudo=v_axo and vigencia='V';
   return 1,'Se ha Modificado ';
end if;

if v_opc=4 then
  update ta_13_descpens set fecha_mov=today, reactivar=v_reac, usuario_mov=v_usu 
   where control_rcm=v_control and axo_descto=v_axo and vigencia='P'; 
   return 1,'Se ha Modificado S ';
end if;
end procedure;

CREATE PROCEDURE "informix".spd_13_abcdesctos(v_control int,v_axo int, v_porc int, v_usu int, v_reac char(1),v_tipo_descto char(1), v_opc int)
{######################################################################
#  Procedimiento:    spd_13_abcdesctos
#  Descripcion:      ABC de descuentos de cementerios
#
#  Parametros        v_control     = control_rcm
#  de entrada:       v_axo         = A�o de descuento
#		     v_porc        = Porcentaje de descuento
#                    v_usu         = Usuario que hace el movimiento
#                    v_reac        = Reactivar el siguiente a�o
#                    v_tipo_descto = Tipo de Descuento
#                    v_opc         = Evento a realizar Alta Baja Pago
# 
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            21 Enero 2016   
#
#  Llamado por:      Modulo de Cementerios en descuentos
#  Llama a:          
#  
######################################################################}
                returning smallint as par_ok, varchar(255)as par_observ;  
define      Vcontrol_des    int;
define      Vcontrol_rcm	INTEGER;
define      Vaxo_alta   	INTEGER;
define      Vdecuento   	INTEGER;
define      Vusuario    	INTEGER;
define      Vfecha_mov  	DATE;
define      Vaxo_ini    	INTEGER;
define      vini    	INTEGER;
define      vreac    	char(1);


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, ('spd_13_altapens ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje);
END EXCEPTION



if v_opc=1 then
  if not exists(select * from ta_13_descpens where control_rcm=v_control and axo_descto=v_axo and vigencia='V') then
    insert into ta_13_descpens(
     control_des ,
     control_rcm ,
     axo_descto ,
     descuento ,
     usuario ,
     fecha_alta ,
     fecha_mov ,
     vigencia ,
     reactivar,tipo_descto
     )
 values(0, v_control, v_axo, v_porc, v_usu, today, today,'V',v_reac,v_tipo_descto); 
    update ta_13_adeudosrcm  set descto_impote=(importe*v_porc/100) where control_rcm=v_control and axo_adeudo=v_axo;
     return 1,'Se ha dado de alta ';
  end if;
end if;

if v_opc=2 then
  update ta_13_descpens set fecha_mov=today, vigencia='B',reactivar=v_reac, usuario_mov=v_usu 
  where control_rcm=v_control and axo_descto=v_axo and vigencia='V'; 
  update ta_13_adeudosrcm  set descto_impote=0 where control_rcm=v_control and axo_adeudo=v_axo and vigencia='V';
   return 1,'Se ha dado de baja ';
end if;

if v_opc=3 then
  update ta_13_descpens set fecha_mov=today, reactivar=v_reac, usuario_mov=v_usu, descuento=v_porc 
   where control_rcm=v_control and axo_descto=v_axo and vigencia='V'; 
  update ta_13_adeudosrcm  set descto_impote=(importe*v_porc/100) where control_rcm=v_control and axo_adeudo=v_axo and vigencia='V';
   return 1,'Se ha Modificado ';
end if;

if v_opc=4 then
  update ta_13_descpens set fecha_mov=today, reactivar=v_reac, usuario_mov=v_usu 
   where control_rcm=v_control and axo_descto=v_axo and vigencia='P'; 
   return 1,'Se ha Modificado S ';
end if;
end procedure;

create procedure "informix".fn_exc_ade_axo( p_contrato_id int , p_axo int) 
returning  money(12,2) as adeudo_act ;
 define v_adeudo money(12,2)     ;
 select sum(ade_importe) into v_adeudo from dbestacion:ex_adeudo 
  where ex_contrato_id = p_contrato_id and axo = p_axo   ;
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_exc_recargos_axo( p_pubid int, p_axo_adeudo int   )
returning    money(10,2) as recargos;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);
define v_totrecgos money(10,2);
define v_id_adeudo int;

let diavig = day(today);

let v_totrecgos = 0;

let axovig = year(today) ;
let mesvig = month(today);

let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from dbestacion:ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
  
  FOREACH
  select case when tipo <> 20 then axo || '00' else axo || lpad(mes,2,'0') end ,tipo , Axo, mes, (axo  * 100 )+ mes , 
    concepto, ade_importe , id 
   into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo , v_id_adeudo
  from dbestacion:ex_adeudo where ex_contrato_id = p_pubid  and  axo = p_axo_adeudo and mes between 1 and 12 
  order by 1,3,4
   select porcentaje into v_porc_recgos from dbestacion:ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
  
 if v_tipo = 20 then
   select sum(porcentaje_mes) into v_porcentaje from dbestacion:recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
          
      if v_calrec = 0 then
     let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
   if (v_tipo = 26) or (v_tipo = 27) then
     execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
     let v_recargos =   v_recargos + v_recgos_ref;
   end if;

 let v_totrecgos =  v_totrecgos + v_recargos ;
end foreach;

return  v_totrecgos ;
end procedure;

CREATE PROCEDURE "informix".sp_maq_consulta(p_hostname VARCHAR(255),p_mac varchar(255),p_usuario CHAR(10))
{######################################################################
#  Procedimiento:    sp_maq_consulta
#  Descripcion:      Verifica equipos registrados
#
#  Parametros        
#  de entrada:       p_hostname          = nombre de la maquina
#                    p_mac          = mac de la maquina
#		     p_usuario      = usuario que la utiliza	
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            27 Enero 2015   
#
#  Llamado por:      ModulosGDL       
#  Llama a:          security:sp_maq_consulta
#  
######################################################################}
	returning 
INT AS id,
VARCHAR(255) as hostname,
CHAR(25) as ip,
DATETIME YEAR TO SECOND as fecha_at,
DATETIME YEAR TO SECOND as fecha_in,
CHAR(10) as realizo,
VARCHAR(255) as mac;

--Parametros de salida:
define v_id INT;
define v_hostname VARCHAR(255);
define v_ip CHAR(25);
define v_fecha_at DATETIME YEAR TO SECOND;
define v_fecha_in DATETIME YEAR TO SECOND;
define v_realizo CHAR(10);
define v_mac VARCHAR(255);
-- fin Parametros de Salida
--hace el llamado al procedimiento en la base se seguridad

FOREACH
execute PROCEDURE security:sp_maq_consulta(p_hostname,p_mac,p_usuario)
into
     v_id ,
     v_hostname ,
     v_ip ,
     v_fecha_at ,
     v_fecha_in ,
     v_realizo ,
     v_mac 

return 
     v_id ,
     v_hostname ,
     v_ip ,
     v_fecha_at ,
     v_fecha_in ,
     v_realizo ,
     v_mac  with resume;

END FOREACH;

END PROCEDURE
;

CREATE PROCEDURE "informix".sp_maq_eventconsulta(p_hostname VARCHAR(255),p_mac varchar(255),p_usuario CHAR(10))
{######################################################################
#  Procedimiento:    sp_maq_eventconsulta
#  Descripcion:      Verifica equipos registrados
#
#  Parametros        
#  de entrada:       p_hostname          = nombre de la maquina
#                    p_mac          = mac de la maquina
#		     p_usuario      = usuario que la utiliza	
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            27 Enero 2015   
#
#  Llamado por:      ModulosGDL       
#  Llama a:          security:sp_maq_eventconsulta
#  
######################################################################}
	returning 
INT AS id,
VARCHAR(255) as hostname,
CHAR(25) as ip,
DATETIME YEAR TO SECOND as hora_intento,
CHAR(10) as usuario_intento,
VARCHAR(255) as mac;

--Parametros de salida:
define v_id INT;
define v_hostname VARCHAR(255);
define v_ip CHAR(25);
define v_hora_intento DATETIME YEAR TO SECOND;
define v_usuario_intento CHAR(10);
define v_mac VARCHAR(255);
-- fin Parametros de Salida

FOREACH
execute PROCEDURE security:sp_maq_eventconsulta(p_hostname,p_mac,p_usuario)
into
     v_id ,
     v_hostname ,
     v_ip ,
     v_hora_intento ,
     v_usuario_intento ,
     v_mac 
return 
     v_id ,
     v_hostname ,
     v_ip ,
     v_hora_intento ,
     v_usuario_intento ,
     v_mac   with resume;

END FOREACH;

END PROCEDURE
;

CREATE PROCEDURE "informix".sp_maq_registramaq(p_hostname CHAR(256),p_ip CHAR(25),p_mac varchar(255))
{######################################################################
#  Procedimiento:    sp_maq_registramaq
#  Descripcion:      Registra la maquina que tienen acceso a los modulos desde la aplicacion de modulos
#
#  Parametros        p_hostname          = nombre de la maquina
#  de entrada:       p_ip        = ip de la maquina
#		     p_mac =mac adress de la maquina	
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            28 de Enero de 2016    
#
#  Llamado por:      ModulosGDL        
#  Llama a:          security:sp_maq_registramaq
#  
######################################################################}
	returning 
int AS estatus,
varchar(255) AS mensaje;

--Parametros de salida:
define v_estatus		int;
define v_mensaje 		varchar(255);
-- fin Parametros de Salida
execute PROCEDURE security:sp_maq_registramaq(p_hostname,p_ip,p_mac) into v_estatus,v_mensaje;

return v_estatus,v_mensaje;
END PROCEDURE
;

create function "pgcabrer".fn_getpagmercaxo(pmerc int,pini date,pfin date)
returning   money(16,2) as pagos;

define v_pagos money(16,2);

select nvl(sum(importe_pago),0) into v_pagos 
from ta_11_pagos_local a,ta_11_locales b
where (fecha_pago between pini and pfin)
and b.num_mercado=pmerc
and b.id_local=a.id_local; 
return v_pagos;

end function;

create procedure "pgcabrer".spd_11_padpagos(paxo int,pmes int,ptip char(1))
returning   smallint as Merc,
            char(30) as mercado,       
            MONEY(16,2) as pagos2010,
            MONEY(16,2) as pagos2011,
            MONEY(16,2) as pagos2012,
            MONEY(16,2) as pagos2013,
            MONEY(16,2) as pagos2014,
            MONEY(16,2) as pagos2015,
            MONEY(16,2) as pagos2016,
            MONEY(16,2) as total;
  
define v_pag2001,v_pag2002,v_pag2003,v_pag2004,v_pag2005,v_pag2006,
       v_pag2007,v_pag2008,v_pag2009,v_pag2010,v_pag2011,v_pag2012,v_pag2013,
       v_pag2014,v_pag2015,v_pag2016 MONEY(16,2);  
define v_total MONEY(16,2);
define v_mer char(30);        
define v_nme smallint;        

let v_total=0;

foreach
select num_mercado_nvo,descripcion
,fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2010),mdy(12,31,2010)),fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2011),mdy(12,31,2011))
,fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2012),mdy(12,31,2012)),fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2013),mdy(12,31,2013))
,fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2014),mdy(12,31,2014)),fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2015),mdy(12,31,2015))
,fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2016),mdy(1,31,2016))
into v_nme,v_mer,v_pag2010,v_pag2011,v_pag2012,v_pag2013,v_pag2014,v_pag2015,v_pag2016
from ta_11_mercados
where tipo_emision='M'
group by num_mercado_nvo,descripcion
having (fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2010),mdy(12,31,2010)))>0 or (fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2011),mdy(12,31,2011)))>0
or (fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2012),mdy(12,31,2012)))>0 or (fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2013),mdy(12,31,2013)))>0
or (fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2014),mdy(12,31,2014)))>0 or (fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2015),mdy(12,31,2015)))>0 
or (fn_getpagmercaxo(num_mercado_nvo,mdy(1,1,2016),mdy(1,31,2016)))>0
order by num_mercado_nvo

let v_total=v_pag2010+v_pag2011+v_pag2012+v_pag2013+v_pag2014+v_pag2015+v_pag2016;

return v_nme,trim(v_mer),v_pag2010,v_pag2011,v_pag2012,v_pag2013,v_pag2014,v_pag2015,v_pag2016,v_total
with resume;
end foreach; -- cierre del principal

end procedure;

CREATE PROCEDURE "informix".multatop20( )
returning 
int as axo_acta , int as num_acta , date as fecha_acta ,  
money(15,2) as calificacion ,  money(15,2) as multa,  
money(15,2) as gastos,  money(15,2) as total ,
varchar(80) as contribuyente , 
varchar(80) as domicilio ,
varchar(80) as dependencia,
varchar(80) as giro,
varchar(150) as observacion;

-----------Define las variables de retorno----------------
define  v_axo_acta int;
define v_num_acta  int; 
define v_fecha_acta date ; 
define v_calificacion  money(15,2); 
define v_multa money(15,2) ; 
define v_gastos money(15,2); 
define v_total  money(15,2); 
define v_contribuyente varchar(80) ; 
define v_domicilio varchar(80);
define v_dependencia  varchar(80);
define v_comentario varchar(150);
define v_giro varchar(80);
FOREACH

SELECT first 20
      a.axo_acta, a.num_acta , a.fecha_acta , 
        a.calificacion , a.multa, a.gastos, a.total ,
        a.contribuyente , a.domicilio , 
        d.descripcion , a.giro , a.comentario
     into 
    v_axo_acta, v_num_acta , v_fecha_acta , 
        v_calificacion , v_multa, v_gastos, v_total ,
        v_contribuyente , v_domicilio , 
        v_dependencia , v_giro , v_comentario 

 from catastro_gdl:multas a, catastro_gdl:c_dependencias d 
        where a.fecha_acta between mdy(10,1,2012) and today -1
        and a.cvepago is null and a.fecha_cancelacion is null and a.id_prescri is null and a.fec_condonar is null and
        a.id_dependencia = d.id_dependencia
        order by a.total desc

 


return v_axo_acta, v_num_acta , v_fecha_acta ,  v_calificacion , v_multa, v_gastos, v_total ,
        v_contribuyente , v_domicilio ,  v_dependencia , v_giro , v_comentario with resume;

end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".spfacele_contrib_abcx(
    p_RFC varchar(13),
    p_razon varchar(100),
    p_calle  VARCHAR(80),
    p_no_ext VARCHAR(10),
    p_no_int VARCHAR(10),
    p_colonia VARCHAR(30),
    p_municipio VARCHAR(30),
    p_estado VARCHAR(30),
    p_email  varchar(100),
    p_cp INT , p_opc char(1) )
returning  integer as clave , varchar(100) as observacion  ;

define v_contrfc int; 
define v_id_persona int;
define v_cont_fact int;
define v_rfc varchar(13); --para registro en web
--altas

if p_opc = 'A' then
     -- verificar que el RFC no exita.
   select count(rfc) into v_contrfc from ta_12_personas_fiscal where rfc = p_rfc;
   if v_contrfc > 0 then
    return -1 , 'YA EXISTE EL RFC,  VERFICAR' ;
   end if;
   insert into ta_12_personas_fiscal ( id_persona , RFC , Razon_social , fecha )
   values(0, p_RFC , p_razon , today  );
   let v_id_persona = dbinfo("sqlca.sqlerrd1");
   insert into ta_12_domicilio_fiscal (id_domicilio,
    id_persona , calle  , no_ext , no_int , colonia , municipio , estado, email, cp , fecha , vigente )
    values(0, v_id_persona , p_calle ,p_no_ext , p_no_int, p_colonia , p_municipio, p_estado,
    p_email  , p_cp , today , 'V');
    return 0,'REGISTRO CORRECTO...';
end if;
if p_opc = 'B' then
    -- verificar que no existan facturas con este rfc  select rowid ,* from ta_12_fact_elec
     select count(*) into v_cont_fact from ta_12_fact_elec where rfc = p_rfc;
    if v_cont_fact > 0 then
      return -4  , 'HAY FACTURAS HECHAS A ESTE RFC, NO SE PUEDE DAR ELIMINAR EL REGISTRO.';
    end if;
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       delete ta_12_personas_fiscal where rfc = p_rfc;
       delete ta_12_domicilio_fiscal  where id_persona = v_id_persona ;
    return 0,'REGISTRO DADO DE BAJA CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;
if p_opc = 'M' then
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       update ta_12_personas_fiscal set razon_social = p_razon where rfc = trim(p_rfc);
    update ta_12_domicilio_fiscal set calle = p_calle , no_ext = p_no_ext , no_int = p_no_int, 
   colonia = p_colonia , municipio = p_municipio, estado = p_estado, email = p_email, cp = p_cp 
   where id_persona = v_id_persona and vigente = 'V' ;
   
   return 0,'REGISTRO ACTUALIZADO CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;

if p_opc = 'W' then --registro por web
     -- verificar que el RFC no exista.
   select id_persona,count(rfc) into v_id_persona,v_contrfc from ta_12_personas_fiscal where rfc = p_rfc group by id_persona;
   if v_contrfc > 0 then
    return v_id_persona , 'YA EXISTE EL RFC' ;
   end if;
   --verifica rfc
      
   if length(trim(p_RFC))<12 then
      return -1 , 'RFC INCORRECTO, VERIFIQUE' ;
   end if;
   Let v_rfc = REPLACE(trim(p_RFC),' ','');
   Let v_rfc = REPLACE(v_rfc,'-','');

   if trim(v_rfc)='' or trim(p_razon)='' or trim(p_calle)='' or trim(p_no_ext)='' or trim(p_colonia)='' or trim(p_municipio)='' or
      trim(p_estado)='' or trim(p_email)='' or p_cp=0 OR p_cp IS NULL then
      return -1 , 'CAPTURE LOS DATOS COMPLETOS' ;
   end if;

   insert into ta_12_personas_fiscal ( id_persona , RFC , Razon_social , fecha )
   values(0, v_rfc , p_razon , today  );
   let v_id_persona = dbinfo("sqlca.sqlerrd1");
   insert into ta_12_domicilio_fiscal (id_domicilio,
    id_persona , calle  , no_ext , no_int , colonia , municipio , estado, email, cp , fecha , vigente )
    values(0, v_id_persona , p_calle ,p_no_ext , p_no_int, p_colonia , p_municipio, p_estado,
    p_email  , p_cp , today , 'V');
    return v_id_persona,'REGISTRO CORRECTO...';
end if;

if p_opc = 'E' then --Edicion desde web, no se actualiza rfc, razon y email
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       update ta_12_personas_fiscal set razon_social = p_razon where rfc = trim(p_rfc);
       update ta_12_domicilio_fiscal set calle = p_calle , no_ext = p_no_ext , no_int = p_no_int, 
       colonia = p_colonia , municipio = p_municipio, estado = p_estado, cp = p_cp 
       where id_persona = v_id_persona and vigente = 'V' ;
   
   return 0,'REGISTRO ACTUALIZADO CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;

 return -2,'OPCION INCORRECTA, VERIFICAR...';

end procedure;

create procedure "pgmoreno".sp_pub_ade_anual2(  ) 
returning   int as numesta , varchar(100) as nombre , char(2) as  categoria , varchar(80) as descripcion ,
   char(1) as sector , varchar(10) as  sectornom,  varchar(100) as calle ,
 varchar(10) as numext , int as Cajones , int as axo_adeudo , int as mes_ini_adeudo , 
 money(14,2) as adeudo_2008 , money(14,2) as recargos_2008 , money(14,2) as adeudo_2009 ,money(14,2) as recargos_2009  ,
 money(14,2) as adeudo_2010 ,money(14,2) as recargos_2010   ,  money(14,2)as adeudo_2011 ,money(14,2) as recargos_2011  ,
 money(14,2) as adeudo_2012 ,money(14,2)as recargos_2012  , money(14,2) as adeudo_2013 ,money(14,2) as recargos_2013  ,
 money(14,2) as adeudo_2014 ,money(14,2)as recargos_2014  , money(14,2) as adeudo_2015 ,money(14,2)as recargos_2015  ,
 money(14,2) as adeudo_2016  , money(14,2)as recargos_2016  , money(14,2) as recargos;
 --money(12,2) as adeudo_act ;

define  v_id  int;
define  v_categoria_id int; 
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_numesta int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_nombre varchar(100);
 
define v_calle varchar(80);
define v_numext varchar(10);
define v_cupo int;
define v_axo_adeudo int;
 define v_mes_ini_adeudo int; 
 define  v_adeudo_2008 money(14,2);
 define v_adeudo_2009 money(14,2);
  define v_adeudo_2010 money(14,2);
  define  v_adeudo_2011 money(14,2);
  define v_adeudo_2012 money(14,2);
  define v_adeudo_2013 money(14,2);
  define  v_adeudo_2014 money(14,2);
 define v_adeudo_2015 money(14,2);
  define v_adeudo_2016 money(14,2);
define  v_recgos_2008 money(14,2);
 define v_recgos_2009 money(14,2);
define v_recgos_2010 money(14,2);
define  v_recgos_2011 money(14,2);
 define v_recgos_2012 money(14,2);
define v_recgos_2013 money(14,2);
define  v_recgos_2014 money(14,2);
 define v_recgos_2015 money(14,2);
define v_recgos_2016 money(14,2);
define v_adeudo_recgos money(14,2);
--set debug file to 'pub.log';
--trace on;

foreach 
  select  a.id, 
     a.pubcategoria_id ,
     b.categoria,
     b.descripcion,
     a.numesta ,
     a.sector, 
    case when sector = 'J' then 'JUAREZ'  when sector = 'H' then 'HIDALGO'
     when sector = 'L' then 'LIBERTAD'  when sector = 'R' then 'REFORMA' else 'S/N' end ,
    trim(a.nombre) ,
    trim(a.calle) ,
    trim(a.numext) ,
    a.cupo, 
    (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ,
    (select min(d.mes) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10
     and axo = (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ) ,

    dbestacion:fn_pub_ade_axo(a.id ,2008) ,
    dbestacion:fn_pub_ade_axo(a.id ,2009) ,
    dbestacion:fn_pub_ade_axo(a.id ,2010) ,
    dbestacion:fn_pub_ade_axo(a.id ,2011) ,
    dbestacion:fn_pub_ade_axo(a.id ,2012) ,
    dbestacion:fn_pub_ade_axo(a.id ,2013) ,
    dbestacion:fn_pub_ade_axo(a.id ,2014) ,
    dbestacion:fn_pub_ade_axo(a.id ,2015) ,
    dbestacion:fn_pub_ade_axo(a.id ,2016) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2008) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2009) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2010) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2011) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2012) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2013) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2014) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2015) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2016) ,
    dbestacion:fn_pub_recargos(2 , a.id, year(today) , month(today) )
  into 
  v_id ,
  v_categoria_id ,
  v_categoria ,
  v_descripcion ,
  v_numesta ,
  v_sector , 
  v_sectornom,
  v_nombre ,
  v_calle ,
  v_numext ,
   v_cupo ,
  v_axo_adeudo ,
  v_mes_ini_adeudo , 
  v_adeudo_2008 ,  v_adeudo_2009 , v_adeudo_2010 ,
v_adeudo_2011 , v_adeudo_2012 , v_adeudo_2013 ,
v_adeudo_2014 , v_adeudo_2015 , v_adeudo_2016 ,
v_recgos_2008 ,   v_recgos_2009 , v_recgos_2010 ,
v_recgos_2011 , v_recgos_2012 , v_recgos_2013 ,
v_recgos_2014 , v_recgos_2015 , v_recgos_2016 , v_adeudo_recgos
   from dbestacion:pubmain a, dbestacion:pubcategoria b 
    where  b.id =  a.pubcategoria_id and a.movto_cve <> 'C'--  and (fn_pub_ade_ant(a.id) + fn_pub_ade_act1( a.id ) ) > 0
        order by a.numesta


return   v_numesta , v_nombre , v_categoria , v_descripcion ,  v_sector , v_sectornom ,
  v_calle , v_numext , v_cupo , v_axo_adeudo , v_mes_ini_adeudo , 
  v_adeudo_2008, v_recgos_2008 , v_adeudo_2009, v_recgos_2009 , v_adeudo_2010, v_recgos_2010 ,
v_adeudo_2011, v_recgos_2011 , v_adeudo_2012, v_recgos_2012 , v_adeudo_2013, v_recgos_2013 ,
v_adeudo_2014, v_recgos_2014 , v_adeudo_2015, v_recgos_2015 , v_adeudo_2016, v_recgos_2016, 
v_adeudo_recgos with resume;

end foreach;
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".sp16_convpago ( parControl int, parAxo_ini int, parMes_ini int, parAxo_fin int, parMes_fin int, parOpcApremios char(1), 
				par_Operacion Int, parFolioConvenio Char(15), par_Fecha Date, par_Id_Rec Int, 
				par_Caja Char(2), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    sp16_ConvPago
#  Descripcion:      Interfaz de pago de ASEO CONTRATADO por CONVENIOS
#
#  Parametros        	parControl	= id del contrato
#  de entrada:        	parAxi_ini, parMes_ini, parAxo_fin parMes_fin	= periodo de inicio y fin de afectacion de periodos
#		     	parOpcApremios	= Opcion 'S' Si se afecta, 'N' No se afecta APREMIOS
#
#		     	parOperacion = numero de operacion
#                    	parFolioConvenio = Folio o Dato del Convenio � Folio del recibo
#                    	par_Fecha = Fecha del recibo
#                    	par_Id_Rec = recaudadora donde se realiza el pago
#                    	par_Caja = caja de pago
#                    	par_Cve_Usuario = usuario de cajero(a)
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento control de convenios
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;

-----------Define las variables de retorno----------------
define v_leyenda    			varchar(255);
define v_estatus 			int;

define v_id_control, v_id_usuario	int;
define v_importe_gastos			money(12,2);

let v_leyenda    	= 'PAGO REALIZADO';
let v_estatus	= 0;

Let v_id_control = 0;
Let v_importe_gastos = 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************


if exists( SELECT * FROM ta_16_contratos WHERE control_contrato = parControl  ) then

               	UPDATE ta_16_pagos set
                	status_vigencia = 'P',  fecha_hora_pago = par_Fecha,  id_rec = par_Id_Rec,  
			caja = par_Caja,  consec_operacion = par_Operacion,  folio_rcbo = parFolioConvenio,  usuario = v_id_usuario
               	WHERE control_contrato = parControl 
		AND aso_mes_pago between parAxo_ini||'-'||parMes_ini and parAxo_fin||'-'||parMes_fin and status_vigencia = 'V';

		if parOpcApremios = 'S' then
			FOREACH
			SELECT id_control, importe_gastos INTO V_id_control, v_importe_gastos FROM ta_15_apremios 
				WHERE modulo = 16 AND control_otr = parControl And vigencia = "1" and clave_practicado = "P"

			UPDATE ta_15_apremios SET 
				fecha_pago = par_Fecha,  recaudadora = par_Id_Rec, caja = par_Caja,  
				operacion = par_Operacion, vigencia='2', clave_mov = 'P', importe_pago = v_importe_gastos
				WHERE id_control = V_id_control;
			END FOREACH;
		end if;

else
         	let v_leyenda = 'NO EXISTE CONTRATO';
         	let v_estatus  = 1;
end if;

	RETURN v_estatus,v_leyenda;

END PROCEDURE
;

CREATE PROCEDURE "pgmoreno".sp16_convcancela ( par_Operacion Int, parFolioConvenio Char(15), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    sp16_ConvCancela
#  Descripcion:      Interfaz de Cancelacion para ASEO CONTRATADO en el sistema CONVENIOS
#
#  Parametros        	parOperacion = numero de operacion
#  de entrada:        	parFolioConvenio = Dato del Convenio � Folio del recibo
#			par_Cve_Usuario = usuario de cajero(a)
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;

-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_id_usuario	int;

let v_leyenda    	= 'CANCELACION DE RECIBO Y REACTIVACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************

if exists( SELECT * FROM ta_16_pagos WHERE consec_operacion = par_Operacion AND folio_rcbo = parFolioConvenio AND status_vigencia = 'P'  ) then

               	UPDATE ta_16_pagos set
                	status_vigencia = 'V',  fecha_hora_pago = Null,  id_rec = 0,  
			caja = ' ',  consec_operacion = 0,  folio_rcbo = ' ',  usuario = v_id_usuario
               		WHERE consec_operacion = par_Operacion AND folio_rcbo = parFolioConvenio AND status_vigencia = 'P';

		UPDATE ta_15_apremios SET
			fecha_pago = Null, recaudadora = 0,  caja = ' ',  
			operacion = 0,  importe_pago = 0,  vigencia = '1'
                       	WHERE modulo = 16 AND operacion = par_Operacion;

else
         	let v_leyenda = 'NO EXISTE CONTRATO';
         	let v_estatus  = 1;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

create procedure "pgcabrer".admin_adeudos_detalle_22a(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(50) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia varchar(30);
define  v_cveparc char(1);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses decimal(14,2);
define  v_cuentaapl,v_folreq,dias_cuantos,dias_habil,v_ctarec,v_ctaint,v_ctaing int;
define  v_vencimiento,v_fecreq date;
define  v_id,v_idresto,v_idadeudo,v_ref,v_parc,v_min,v_max int;

begin
    on exception in (-958)
       delete from tmp_totalesconv;
    end exception;
create temp table tmp_totalesconv(
  rubro int,
  concepto int,
  cuenta int,
  referencia int,
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;

if trim(pref)='' then
   let v_ref=999;
else
   let v_ref=pref;
end if;

select b.id_conv_resto,nvl(e.cuenta_recargos,0),nvl(min(d.pago_parcial),0),nvl(max(d.pago_parcial),0)
,nvl(e.cuenta_intereses,0),nvl(e.cuenta_ingreso,0) 
into v_id,v_ctarec,v_min,v_max,v_ctaint,v_ctaing
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d,ta_17_subtipo_conv e
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref and e.tipo=a.tipo and e.subtipo=a.subtipo
group by 1,2,5,6;

 -- para obtener el datos de multa y gastos
foreach
select nvl(b.folio,0), nvl(b.importe_multa,0),nvl(sum(importe_gastos),0),nvl(b.porcentaje_multa,0),
nvl(b.fecha_practicado,null)
into v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
from ta_15_apremios b
where b.modulo=17 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
group by 1,2,4,5 order by  1
end foreach;

let dias_cuantos=0;

select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales 
where fecha between v_fecreq and today;
    
let dias_cuantos=(today-v_fecreq)-dias_habil;
if  v_porcmul=100 then
    if dias_cuantos <=6 then
       let v_multa=v_multa*50/100;
    else
       if (dias_cuantos >=7) and (dias_cuantos<=16) then
          let v_multa=v_multa*80/100;
       else  
          let v_multa=(v_multa*(100-v_porcmul))/100;
       end if;
    end if;
else
    let v_multa=(v_multa*(100-v_porcmul))/100;
end if;

if v_multa>0 then
   let v_acumulado=v_acumulado+v_multa;
   return 0,0,0,v_min,'MULTA',v_multa,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,v_min,'MULTA',v_multa,v_acumulado);
end if;

if v_gastos>0 then
   let v_acumulado=v_acumulado+v_gastos;
   return 0,0,0,v_min,'GASTOS',v_gastos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,v_min,'GASTOS',v_gastos,v_acumulado);  
end if;

foreach
select b.id_conv_resto,d.id_adeudo,d.pago_parcial,d.importe,d.fecha_venc,d.cve_parcialidad
into v_idresto,v_idadeudo,v_parc,v_importe,v_vencimiento,v_cveparc
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref 
order by d.pago_parcial

  foreach  
  select cuenta_apl,importe into v_cuentaapl,v_monto
  from ta_17_desg_parcial 
  where id_adeudo=v_idadeudo
  order by id_desgloce

  let v_acumulado=v_acumulado+v_monto;
  return 0,0,v_cuentaapl,v_parc,'CONVENIO',v_monto,v_acumulado with resume;
  insert into tmp_totalesconv values(0,0,v_cuentaapl,v_parc,'CONVENIO',v_monto,v_acumulado);
  end foreach;

execute procedure admin_intereses_22(v_idresto,v_vencimiento,v_parc,v_cveparc) into v_intereses;
let v_recargos=0;
if today>v_vencimiento then
   execute procedure admin_recargos_20((v_importe+v_intereses),v_vencimiento) into v_recargos;
end if;

if v_recargos>0 then
   let v_acumulado=v_acumulado+v_recargos;
   return 0,0,v_ctarec,v_parc,'RECARGOS',v_recargos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctarec,v_parc,'RECARGOS',v_recargos,v_acumulado);
end if;

if v_intereses>0 then
   let v_acumulado=v_acumulado+v_intereses;
   return 0,0,v_ctaint,v_parc,'INTERESES',v_intereses,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctaint,v_parc,'INTERESES',v_intereses,v_acumulado);
end if;

end foreach;

end procedure;

CREATE PROCEDURE "informix".web_encabezados_14(p_control integer)
               returning  varchar(92) as sNombreCompleto, varchar(80) as scalle, varchar(10) as sNoExt,
               VARCHAR(10) as sInt, VARCHAR(50) as scolonia, VARCHAR(10)as scodigo_postal, VARCHAR(13) as sRFC, 
               VARCHAR(50) as sMunicipio, varchar(50) as sEstado, varchar(18) as sCURP,                                      
               --lvarchar(500)as sDescripcion_recibo,
smallint as sporCobrar, Varchar(255) as          Leyenda,
                Varchar(255) as         Leyenda_rbo, smallint as Impide_cobro;


define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define  v_axo_pagado INTEGER;
define  v_nombre VARCHAR(60) ;
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_vigencia CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_exte      VARCHAR(10);
define  v_inte      VARCHAR(10);


let v_axo=year(today);
let v_mes=month(today);

let v_control= p_control;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   return ' ',' ',' ' ,' ' ,' ',' ',' ', ' ',' ',' ',0,' No Existe ',' ',1; 
end if;      
  
select axo_pagado, nombre,domicilio, exterior, interior ,colonia ,
vigencia
into v_axo_pagado, v_nombre,v_domcompleto,v_exte,v_inte, v_colonia ,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

if v_axo_pagado=v_axo  then
   return v_nombre,v_domcompleto,v_exte, v_inte, v_colonia,' ',' ', ' ',' ',' ',0,'Al corriente de pagos ',' ',1; 
end if;     
if v_vigencia='B'  then
   return v_nombre,v_domcompleto,v_exte, v_inte, v_colonia,' ',' ', ' ',' ',' ',0,'Dado de Baja ',' ',1; 
end if;     

EXECUTE PROCEDURE spd_13_recargos(v_control, v_mes);

return v_nombre,v_domcompleto,v_exte, v_inte, v_colonia,' ',' ',' ',' ',' ',1,'Listo para cobro  ',' ',0; 

end procedure;

CREATE PROCEDURE "informix".web_datos_varios_14(p_control integer)
               returning  varchar(150) as sdato_vario;

define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_tipo CHAR(10);
define  v_vigencia CHAR(1);
define  v_reg_cem varchar(100);
define  v_nomcem VARCHAR(60);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);

let v_axo=year(today);
let v_mes=month(today);
let v_control= p_control;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   return ' '; 
end if;      

select cementerio, cementerio ||' '|| clase||' '||clase_alfa ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
axo_pagado, metros, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ' '
end, vigencia
into v_cementerio,v_reg_cem,
v_axo_pagado, v_metros,v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa,v_tipo,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

select  nombre into v_nomcem
from tc_13_cementerios where cementerio=v_cementerio;

--if v_axo_pagado=v_axo  then
--   return ' '; 
--end if;  
   
if v_vigencia='B'  then
   return ' '; 
end if;     
--foreach
return v_nomcem  with resume;
return v_reg_cem with resume; 
 return v_metros  with resume; 
 return v_tipo with resume; 
  return v_clase    with resume; 
  return v_seccion  with resume; 
 return v_linea    with resume; 
 return v_fosa || v_falfa  with resume; 
--end foreach; 
end procedure;

CREATE PROCEDURE "informix".web_adeudos_detalle_14(p_control integer, p_Apagar char(20))
                returning  int as sNoRubro, int as sNoConcepto, int as sCuenta_aplicacion,
                varchar(50) as sreferencia1, varchar(50) as sDescripcion, dec(14,2) as sMonto, dec(14,2) as sAcumulado;


define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_mon  integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_vigencia CHAR(1);
define  v_imptot money(15,2);
define  v_impmonto money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  var_axo    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapl3     int;
define v_ctaapl4     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define  v_acumula     money(15,2);



let v_axo=year(today);
let v_mes=month(today);
let v_obs ='';
let v_impmonto = 0;
let v_desctot  = 0;
let v_axo_mon  = 0;
let v_acumula  = 0;

let v_control= p_control;
let var_axo= nvl((p_Apagar),0);
let v_imptot=0;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   return 0,0,0,' ',' ',0,0; 
end if;      

select cementerio,axo_pagado,vigencia
into  v_cementerio,v_axo_pagado,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

select  cta_aplicacion, cta_vencido, cta_descto,cta_desctopens into v_ctaapl1, v_ctaapl2 , v_ctaapl3 ,v_ctaapl4
from tc_13_cementerios where cementerio=v_cementerio;

if v_axo_pagado=v_axo  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if v_vigencia='B'  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;

if v_axo<>var_axo then
   let v_axo=var_axo;
end if;

    let v_desctot = 0;
    let v_desctotre = 0;

if v_imptot>0 then
foreach 
    select b.axo_adeudo, (b.importe+b.importe_recargos) - (b.descto_impote+ b.descto_recargos)
          into vpar_axo, vpar_impte
           from ta_13_adeudosrcm b where  b.control_rcm=v_control and b.axo_adeudo between v_axodesde and v_axo
          order by 1
    let v_impmonto = v_impmonto + vpar_impte;
    if  v_impmonto <= v_imptot then
        let v_axo_mon =  vpar_axo; 
    end if;
end foreach;
   let v_axo=v_axo_mon;
end if;

foreach 
    select b.axo_adeudo,b.importe,b.importe_recargos, nvl(d.descuento,0),b.descto_impote, b.descto_recargos
          into vpar_axo,vpar_impte, vpar_recar , v_descuento,v_impdesc,v_recardesc     
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and  b.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
          order by 1

    if  v_descuento <> 0 then         
        let v_ctaapldi=v_ctaapl4;
        let v_desctot  = v_desctot  + v_impdesc;
           let v_obs = 'INCLUYE DESC. '||v_descuento||'% POR PENSIONADO'; 
    else
           let v_obs = ''; 
     end if;
     let v_desctotre  =  v_recardesc;
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
        if v_impdesc=0 then
          let v_desctot  =v_desctot+ trunc(((vpar_impte-v_impdesc) * 0.1),2);
          let v_ctaapldi=v_ctaapl3;
          if  v_obs = '' then
             let v_obs = v_obs || 'INCLUYE DESC. 10% POR PRONTO PAGO'; 
          else
              let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
          end if;
          end if;
     end if;
     if vpar_axo=year(today) then
        let v_ctaapli=v_ctaapl1;
     else
        let v_ctaapli=v_ctaapl2;
     end if;   
     if vpar_recar>0 then
        let v_ctaaplr=390300000;
     end if;   
     if v_desctot>0 then
--        let v_ctaapldi=v_ctaapl3;
        let v_desctot= v_desctot * -1;
     end if;   
     if v_desctotre>0 then
        let v_ctaapldr=390340000;
        let v_desctotre= v_desctotre* -1;
     end if;   

  let v_acumula=v_acumula +vpar_impte;
  return 0,0,v_ctaapli, vpar_axo, 'Mantenimiento' ||vpar_axo,  vpar_impte, v_acumula with resume;

  if  v_desctot <>0 then
     let v_acumula= v_acumula + v_desctot;
  return 0,0,v_ctaapldi,vpar_axo, v_obs || vpar_axo,   (v_desctot ), v_acumula with resume;
     let v_desctot=0;
  end if;
  if vpar_recar>0 then
     let v_acumula=v_acumula+vpar_recar;
  return 0,0,v_ctaaplr,vpar_axo , 'Recargos ' || vpar_axo , vpar_recar, v_acumula with resume;
  end if;
  if v_desctotre <>0 then
     let v_acumula=v_acumula + v_desctotre;
  return 0,0,v_ctaapldr, vpar_axo, v_obs||'Descto Recarg ' || vpar_axo,  v_desctotre , v_acumula with resume;
  end if;

end foreach;
end procedure;

CREATE PROCEDURE "informix".kio_pagodiverso(
    		parnumDiv  int,
                parnombre char(60),
                pardomicilio char(60),
                parImpCertificado money(15,2),
    		parKiosco	integer,
                parcantidad   integer
        )
		returning smallint , char(2), integer , char(28);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define v_cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_orden int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);define v_importex  money(15,2) ;
define v_hora datetime hour to minute;
define  v_linea100 varchar(110);
define v_linea28 varchar(28);
define v_id int;
define v_contrato int; 
define v_long int;
define v_contratost char(8);
define v_opcion int;
--set debug file to "pagokioDIV.TXT";
--trace on;
let v_opcion = 0;
if parcantidad = 0 then
   let parcantidad = 1;
end if;
   if parnombre = '' then
      return 0, '', 0 , '';
   end if;
--  verificar contrato siapa
 if  parnumDiv = 3 then
    let v_long = length(trim(pardomicilio));
    let v_contratost = substring(pardomicilio from 35 for 8);
    let v_contrato = v_contratost *1;
      if (v_contrato > 10000000) and (v_contrato < 12000000) then
           let v_opcion = 0;
          else
           let v_opcion = 1;
      end if;
  end if;

 let parnombre = REPLACE(parnombre, 'Ñ', '�');
-- 
if v_opcion = 1 then
       return 0, '', 0 , '';
else
    select tramite , id_dependencia
    into v_concepto , v_id
    from ta00_tramites where numtramite = parnumDiv;
  
    select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parkiosco; 

    execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 12, parnumDiv, 0, '',
              1, 0, 12, 0,  parNombre, pardomicilio,
           v_concepto, '',v_id,0,
                0,0,parkiosco,current,0,0,0,'',0,'I','')
 into spoperacion;



  let varoperacion = spoperacion;
              
   let linea = 1;     
    let v_suma =0;
  let v_importex = 0;
  FOREACH
     select orden, cta_aplicacion, concepto , importe   
     into  v_orden ,v_cuenta ,  v_concepto , v_importe 
       from ta00_conceptocobro where numtramite = parnumDiv 
         and kiosco = 'S' and vigente = 'V'
         order by orden
     if parnumDiv = 3 then
       let v_importe = parImpCertificado;
       let parcantidad = 1;
     end if;
  if parnumDiv = 4 then
       let v_importe = parImpCertificado;
       let parcantidad = 1;
    end if;
   let v_importex = v_importe * parcantidad;
   insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta, v_importex );
       let linea = linea +1 ;
       let v_suma = v_suma + v_importex;
   end FOREACH;
   let v_redondeo = parImpCertificado - v_suma;
  if v_redondeo <> 0 then
   if (parImpCertificado - (v_suma)) > 0 then
       let v_cuenta = 55080000;
        else
       let v_cuenta = 55080000;
       end if;
 
   insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea , 
   'Ajuste ART. 4 de ley de ingresos ' , 55080000, v_redondeo );

  end if;


  execute PROCEDURE linea_capturadiv(varoperacion, parKiosco,parImpCertificado ,today ) into
    v_linea100, v_linea28;

  return varrec, varcaja, spoperacion , v_linea28;
 end if;
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".sp16_ade_x_contrato ( parControl_Contrato int )
{######################################################################
#  Procedimiento:    sp16_LicenciaGiro
#  Descripcion:      Interfaz de consulta de Adeudo en ASEO CONTRATADO
#
#  Parametros        parControl_Contrato     = Control del Contrato
#  de entrada:       
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            15 Septiembre 2015   
#
#  Llamado por:      Procedimiento 
#  
######################################################################}
                returning  int as status,
                                            varchar(255) as leyenda;
        
define v_importe_multa, v_importe_gastos, v_tot_gastos	Money(12,2);   -- requerimientos
define v_importe, v_importe_CN, v_importe_Exe		Money(12,2);

define v_status                                                                            	Int;
define v_leyenda                                                                        	varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                   	varchar(7);

Let v_status      = 0;
let v_leyenda    = 'NO TIENE ADEUDO';

Let v_importe = 0;
Let v_importe_CN = 0;
Let v_importe_Exe = 0;

-- APREMIOS
Let v_importe_multa = 0;
Let v_importe_gastos = 0;
Let v_tot_gastos = 0;

FOREACH
SELECT importe_multa,     importe_gastos  INTO v_importe_multa, v_importe_gastos 
	FROM ta_15_apremios
                  WHERE modulo = 16  AND control_otr = parControl_Contrato  AND vigencia = "1" AND clave_practicado = "P"
                  Order By id_control
Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
END FOREACH;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

if exists( SELECT * FROM ta_16_pagos WHERE control_contrato = parControl_Contrato  and status_vigencia = 'V' ) then
	SELECT sum(importe)  INTO v_importe_CN  FROM ta_16_pagos WHERE control_contrato = parControl_Contrato 
                  	and ctrol_operacion = 6 and aso_mes_pago <= v_Periodo_CN  and status_vigencia = 'V';
	if v_importe_CN is Null then
                  	Let  v_importe_CN = 0;
	end if;
	
                  SELECT sum(importe)  INTO v_importe_Exe  FROM ta_16_pagos WHERE control_contrato = parControl_Contrato 
                  	and ctrol_operacion = 7 and aso_mes_pago <= v_Periodo_EXE  and status_vigencia = 'V';
	if v_importe_Exe is Null then
                  	Let  v_importe_Exe = 0;
	end if;

	Let v_importe = v_importe_CN + v_importe_Exe;

	if v_importe > 0 then
                  	let v_status                       = 1;
                                    let v_leyenda    = 'TIENE ADEUDO POR ASEO';
	else
                  	if v_importe_multa > 0 or v_tot_gastos > 0 then
                                    	let v_status                       = 1;
                                                      let v_leyenda    = 'TIENE ADEUDO POR REQUERIMIENTOS';
		else
                                    	let v_status                       = 0;
                                                      let v_leyenda    = 'NO TIENE ADEUDO';
		end if;
	end if;
else
	if v_importe_multa > 0 or v_tot_gastos > 0 then
                  	let v_status                       = 1;
                                    let v_leyenda    = 'TIENE ADEUDO POR REQUERIMIENTOS';
	end if;
end if;

RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_cancelacontrato ( parControl_Contrato int, parFechaCanc date, parPeriodo char(7), parDocto char(15),  parDescrip varchar(100) )
{######################################################################
#  Procedimiento:    sp16_CancelaContrato
#  Descripcion:      Interfaz de Cancelacion de Contrato, Adeudos, Requerimientos en ASEO CONTRATADO
#
#  Parametros        	parControl_Contrato = Control del Contrato
#  		parPeriodo	= Periodo a partir de donde los adeudos se Cancelaran
#  		parDocto		= Documentos que avale la Cancelaci�n
#  		parDescrip	= Argumento de la Cancelaci�n
#  de entrada:       
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            15 Septiembre 2015   
#
#  Llamado por:      Procedimiento 
#  
######################################################################}
                returning  int as status,
                                            varchar(255) as leyenda;
        
define v_id_usuario, v_idcontrol 	int;
define v_status 			int;
define v_leyenda    			varchar(255);

Let v_status      = 0;
Let v_leyenda    = 'NO TIENE ADEUDO';
Let v_idcontrol = 0;

Let  v_id_usuario = 0;
if exists( SELECT *  FROM ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 50; 	-- Usuario general
end if;

UPDATE ta_16_contratos set  -- Cancelaci�n del Contrato
	Status_Vigencia = 'C',
	Fecha_hora_baja = parFechaCanc
WHERE Control_contrato = parControl_Contrato;

UPDATE ta_16_pagos SET  -- Cancelaci�n de Adeudos a partir del periodo solicitado
	Status_vigencia = 'C'
where Control_contrato = parControl_Contrato  and aso_mes_pago >= parPeriodo and Status_vigencia = 'V';

foreach
SELECT a.id_control  INTO v_idcontrol  FROM    ta_15_apremios a, ta_15_periodos b
WHERE a.modulo = 16 and a.control_otr = parControl_Contrato and a.vigencia = '1' and a.clave_practicado = 'P'
and b.control_otr = a.id_control and b.ayo||'-'||b.periodo >= parPeriodo
group by a.id_control
order by a.id_control
		
	update ta_15_apremios set   -- Cancelaci�n de Apremios a partir del periodo solicitado
		fecha_pago = Current, recaudadora = 0, caja = '', operacion = 0, vigencia = '3', importe_pago = 0
   	where modulo=16 and Id_control = v_idcontrol;
end foreach;

insert into ta_16_Contratos_H (Control, Control_Contrato, Documento, Descripcion, id_usuario, fecha_movto)
                                values ( 0, parControl_Contrato, parDocto, Trim(parDescrip)||' desde '||parPeriodo, v_id_usuario, current );

Let v_status      = 0;
let v_leyenda    = 'CONTRATO, ADEUDOS y REQUERIMIENTOS si los tuviese fueron CANCELADOS';

RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "informix".upd16_contrato_01 ( par_Control_Cont Integer, par_Num_Emp Integer, par_Ctrol_Emp Integer, par_Cve_recolec Char(1), par_Cant_recolec Integer, 
                                                                        par_Domicilio Char(80), par_Sector Char(1), par_Ctrol_Zona Integer, par_Id_Rec Integer, 
                                                                        par_Axo_Ini Integer, par_Mes_Ini Integer, par_Opcion Smallint, par_Docto Char(15), par_Descrip Char(100))
                returning Integer as Status,
                               varchar(100) as Concepto;
               

{
#  Procedimiento: upd16_contrato_01
#  Descripcion:  Opciones de Contratos para actualizar
#  Parametros de entrada: Todos los datos del contrato mas Opcion de mantenimiento
#  Parametros de salida:   Status del Procedimiento
#                                      Concepto del Procedimiento
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

define v_id_usuario										int;
define v_status										int;
define v_leyenda										varchar(100);
define aso_inicio, aso_actual									int;
define c_status_vigencia									char(1);
define c_cantidad_recolec									int;
define a_axo, a_mes, a_exedencia, a_ctrol_operacion						int;
define u_ctrol_recolec									int;
define u_costo_unidad, u_costo_exed								money(12,2);
define v_contador, v1_contador								int;
define vf_mes										int;

Let v_id_usuario = 0;
Let v_status = 0;
Let v_leyenda = 'Actualizacion del Contrato CORRECTA';
Let c_status_vigencia = '';
Let c_cantidad_recolec = 0;
Let a_axo = 0;
Let a_mes = 0;
Let a_exedencia = 0;
Let a_ctrol_operacion = 0;
Let u_ctrol_recolec = 0;
Let u_costo_unidad = 0;
Let u_costo_exed = 0;
Let v_contador = 0;
Let v1_contador = 0;
Let vf_mes = 0;

Let aso_inicio = par_Axo_Ini;
if par_Axo_Ini = Year(Current) then
   Let aso_actual = par_Axo_Ini;
else
   Let aso_actual = Year(Current);
end if;

--************************************************************************
SELECT id_usuario INTO v_id_usuario FROM ta_12_passwords WHERE usuario = user;
--************************************************************************

if exists(Select * From ta_16_contratos  Where Control_contrato = par_Control_Cont) then
	Select status_vigencia, cantidad_recolec INTO c_status_vigencia, c_cantidad_recolec From ta_16_contratos  Where Control_contrato = par_Control_Cont;
	if c_status_vigencia = 'V' then
		--
		if par_Opcion = 0 then	--            UNIDADES DE RECOLECCION
			FOREACH
			SELECT Year(aso_mes_pago), Month(aso_mes_pago), exedencias, ctrol_operacion INTO a_axo, a_mes, a_exedencia, a_ctrol_operacion 
				FROM ta_16_pagos  WHERE Control_contrato = par_Control_Cont  
				and aso_mes_pago >= par_Axo_Ini || '-' || par_Mes_Ini and Status_vigencia = 'V'
				order by aso_mes_pago, ctrol_operacion

				SELECT ctrol_recolec, costo_unidad, costo_exed INTO u_ctrol_recolec, u_costo_unidad, u_costo_exed
					FROM ta_16_unidades WHERE ejercicio_recolec = a_axo and cve_recolec = par_Cve_recolec;
				
				if a_ctrol_operacion = 6 then
					UPDATE ta_16_pagos SET
                                                               			importe = a_exedencia * u_costo_unidad 
                                               				Where Control_contrato = par_Control_Cont 
						and aso_mes_pago = a_axo || '-' || a_mes 
						and ctrol_operacion = a_ctrol_operacion
						and status_vigencia = 'V';
				else
					UPDATE ta_16_pagos SET
                                                               			importe = a_exedencia * u_costo_exed 
                                               				Where Control_contrato = par_Control_Cont 
						and aso_mes_pago = a_axo || '-' || a_mes 
						and ctrol_operacion = a_ctrol_operacion
						and status_vigencia = 'V';
				end if;

			END FOREACH;

			INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                                               	UPDATE ta_16_contratos SET
                                                      	Ctrol_recolec = u_ctrol_recolec
                                               		Where Control_contrato = par_Control_Cont;
		end if;

                		if par_Opcion = 1 then	--            PERIODO DE INICIO DE OBLIGACION
			SELECT count(*) INTO v_contador  FROM ta_16_pagos  
			WHERE Control_contrato = par_Control_Cont and aso_mes_pago < par_Axo_Ini || '-' || par_Mes_Ini and Status_vigencia <> 'V';
			if v_contador = 0 then
				SELECT count(*) INTO v1_contador  FROM ta_16_pagos  
				WHERE Control_contrato = par_Control_Cont and aso_mes_pago >= par_Axo_Ini || '-' || par_Mes_Ini and Status_vigencia <> 'V';
				if v1_contador = 0 then
					DELETE FROM ta_16_pagos where control_contrato = par_Control_Cont;
                               				if par_Axo_Ini < aso_actual then

						SELECT c.ctrol_recolec, c.costo_unidad, c.costo_exed  INTO u_ctrol_recolec, u_costo_unidad, u_costo_exed
							FROM ta_16_contratos a, ta_16_unidades b, ta_16_unidades c
							WHERE a.control_contrato = par_Control_Cont and b.ctrol_recolec = a.ctrol_recolec
							AND c.cve_recolec = b.cve_recolec and c.ejercicio_recolec = par_Axo_Ini;

						FOR vf_mes = par_Mes_Ini to 12
                                                                              			Insert into ta_16_Pagos values 
							( par_Control_Cont, mdy(vf_mes, 01, par_Axo_Ini), 6, c_cantidad_recolec * u_costo_unidad, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec);
                                               				END FOR;

						SELECT c.ctrol_recolec, c.costo_unidad, c.costo_exed  INTO u_ctrol_recolec, u_costo_unidad, u_costo_exed
							FROM ta_16_contratos a, ta_16_unidades b, ta_16_unidades c
							WHERE a.control_contrato = par_Control_Cont and b.ctrol_recolec = a.ctrol_recolec
							AND c.cve_recolec = b.cve_recolec and c.ejercicio_recolec = aso_actual;

                                               				FOR vf_mes = 1 to 12
                                                                              			Insert into ta_16_Pagos values  
							( par_Control_Cont, mdy(vf_mes, 01, aso_actual), 6, c_cantidad_recolec * u_costo_unidad, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec);
                                               				END FOR;
                               				end if;
                               				if par_Axo_Ini = aso_actual then

						SELECT c.ctrol_recolec, c.costo_unidad, c.costo_exed  INTO u_ctrol_recolec, u_costo_unidad, u_costo_exed
							FROM ta_16_contratos a, ta_16_unidades b, ta_16_unidades c
							WHERE a.control_contrato = par_Control_Cont and b.ctrol_recolec = a.ctrol_recolec
							AND c.cve_recolec = b.cve_recolec and c.ejercicio_recolec = par_Axo_Ini;

						FOR vf_mes = par_Mes_Ini to 12
                                                                              			Insert into ta_16_Pagos values 
							( par_Control_Cont, mdy(vf_mes, 01, par_Axo_Ini), 6, c_cantidad_recolec * u_costo_unidad, 'V', Null, 0, Null, 0, Null, v_id_usuario, par_Cant_recolec);
                                               				END FOR;
                               				end if;
					INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                                               			UPDATE ta_16_contratos SET
                                                               			aso_mes_oblig = mdy(par_Mes_Ini, 01, par_Axo_Ini)
                                               				Where Control_contrato = par_Control_Cont;
				else
					Let v_status = -1;
					Let v_leyenda = 'Tiene Adeudos no VIGENTES posterior o igual a la fecha de Inicio deseada por lo tanto no puede ser MODIFICADA, avisa a DPD';
				end if;
			else
				Let v_status = -1;
				Let v_leyenda = 'Tiene Adeudos no VIGENTES anteriores a la fecha de Inicio deseada por lo tanto no puede ser MODIFICADA, avisa a DPD';
			end if;
		end if;

                		if par_Opcion = 2 then	--            CANTIDAD DE UNIDADES A RECOLECTAR
			FOREACH
			SELECT Year(aso_mes_pago), Month(aso_mes_pago), exedencias, ctrol_operacion INTO a_axo, a_mes, a_exedencia, a_ctrol_operacion 
				FROM ta_16_pagos  WHERE Control_contrato = par_Control_Cont  
				and aso_mes_pago >= par_Axo_Ini || '-' || par_Mes_Ini and Status_vigencia = 'V' and ctrol_operacion = 6
				order by aso_mes_pago, ctrol_operacion

				SELECT c.ctrol_recolec, c.costo_unidad, c.costo_exed  INTO u_ctrol_recolec, u_costo_unidad, u_costo_exed
					FROM ta_16_contratos a, ta_16_unidades b, ta_16_unidades c
					WHERE a.control_contrato = par_Control_Cont and b.ctrol_recolec = a.ctrol_recolec
					AND c.cve_recolec = b.cve_recolec and c.ejercicio_recolec = a_axo;

				UPDATE ta_16_pagos SET
                                                               		importe = par_Cant_recolec * u_costo_unidad,
					exedencias = par_Cant_recolec 
                                               			Where Control_contrato = par_Control_Cont 
					and aso_mes_pago = a_axo || '-' || a_mes 
					and ctrol_operacion = a_ctrol_operacion
					and status_vigencia = 'V';

			END FOREACH;

			INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                                               	UPDATE ta_16_contratos SET
                                                      	cantidad_recolec = par_Cant_recolec
                                               		Where Control_contrato = par_Control_Cont;
		end if;

                		if par_Opcion = 3 then	--            EMPRESA
				INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                               			UPDATE ta_16_contratos SET
                                    			num_empresa = par_Num_Emp, ctrol_emp = par_Ctrol_Emp
                               				Where Control_contrato = par_Control_Cont;
		end if;

                		if par_Opcion = 4 then	--            DOMICILIO
                               			INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                               			UPDATE ta_16_contratos SET
                                    			domicilio = par_Domicilio
                               				Where Control_contrato = par_Control_Cont;
                		end if;

                		if par_Opcion = 5 then	--            ZONA
                             			INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                               			UPDATE ta_16_contratos SET
                                    			ctrol_zona = par_Ctrol_Zona
                               				Where Control_contrato = par_Control_Cont;
                		end if;

                		if par_Opcion = 6 then	--            SECTOR
                             			INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                               			UPDATE ta_16_contratos SET
                                    			sector = par_Sector
                               				Where Control_contrato = par_Control_Cont;
                		end if;

                		if par_Opcion = 7 then	--            RECA
                             			INSERT into ta_16_Contratos_H values (0, par_Control_Cont, Trim(par_Docto), Trim(par_Descrip), v_id_usuario, Today);
                               			UPDATE ta_16_contratos SET
                                    			id_rec = par_Id_Rec
                               				Where Control_contrato = par_Control_Cont;
		end if;

		--
	else
		Let v_status = -1;
		Let v_leyenda = 'NO esta VIGENTE el Contrato';
	end if;
else
	Let v_status = -1;
	Let v_leyenda = 'NO existe el Contrato';
end if;

RETURN v_status, v_leyenda;

END PROCEDURE
;

CREATE PROCEDURE "informix".recibos_det(
  p_fecha DATE,
  p_id_rec SMALLINT,
  p_caja CHAR(2),
  p_operacion INT
)
returning 
INT as estatus,
VARCHAR(50) as mensaje,
DATE as fecha,
SMALLINT as id_rec,
CHAR(2) as caja,
INT as operacion,
SMALLINT as linea,
VARCHAR(60) as descripcion,
INT as cuenta,
MONEY(16,2) as importe;

define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_linea SMALLINT;
define o_descripcion VARCHAR(60);
define o_cuenta INT;
define o_importe MONEY(16,2);

define v_id int;
define v_linea VARCHAR(50);
define v_estatus char(1);
define v_fecha_pago date;
define v_importe money(16,2);
define v_lugar_pago int;
define v_id_modulo int;
--set debug file to "det_recibo.txt";
--trace on;
   if NOT exists (select * from ta_12_recibosdet where fecha = p_fecha and id_rec = p_id_rec
	and caja = p_caja and operacion = p_operacion) then --Recibos
         return -1,"LA REFERENCIA DE PAGO NO TIENE DETALLES DE RECIBO",
		null,null,null,null,null,null,null,null;
   end if; --Fin Recibos

   foreach
	select fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe
	into o_fecha,o_id_rec,o_caja,o_operacion,o_linea,o_descripcion,o_cuenta,o_importe
	from ta_12_recibosdet 
	where fecha = p_fecha
	and id_rec = p_id_rec
	and caja = p_caja
	and operacion = p_operacion
	
	return 0,"OK",
		o_fecha,o_id_rec,o_caja,o_operacion,o_linea,o_descripcion,o_cuenta,o_importe WITH RESUME;
   end foreach;
   if exists(select *
	from ta_12_cheques 
	where fecha = p_fecha
	and id_rec = p_id_rec
	and caja = p_caja
	and operacion = p_operacion) then
      foreach
	select fecha,id_rec,caja,operacion,"",case when tipo_pag=6 then "EFECTIVO" ELSE "" end,"0","0.00"
	into o_fecha,o_id_rec,o_caja,o_operacion,o_linea,o_descripcion,o_cuenta,o_importe
	from ta_12_cheques 
	where fecha = p_fecha
	and id_rec = p_id_rec
	and caja = p_caja
	and operacion = p_operacion
	
	return 0,"OK",
		o_fecha,o_id_rec,o_caja,o_operacion,o_linea,o_descripcion,o_cuenta,o_importe WITH RESUME;
      end foreach; 
   else --no existe en forma de pago
        let v_lugar_pago = 0;
        let v_id_modulo = 0;
        select lugar_pago,id_modulo into v_lugar_pago,v_id_modulo from  ta_12_recibos 	
        where fecha = p_fecha
	and id_rec = p_id_rec
	and caja = p_caja
	and operacion = p_operacion;
        if v_lugar_pago = 0 then 
           --verifica si es de cementerios en kioscos
           if (v_id_modulo = 13) and (p_caja = "K1" or p_caja = "K2" or p_caja = "K3" or p_caja = "K4" or p_caja = "K5") then
              let o_descripcion = "EFECTIVO";  --kiosco paga en efectivo
           else
             let o_descripcion = "";
           end if;
        else
            select 'DEPOSITO EN ' || trim(descripcion) into  o_descripcion from catastro_gdl:c_recaud where recaud = v_lugar_pago;
  
        --   if v_lugar_pago = 102 then --por internet
          --    let o_descripcion = "CHEQUE/TARJETA";
        --   else
        --      let o_descripcion = "EFECTIVO";  --por los demas bancos y tiendas
          -- end if; 
        end if;
	return 0,"OK",
		o_fecha,o_id_rec,o_caja,o_operacion,"",o_descripcion,0,0 WITH RESUME;

   end if;
--trace off;
end procedure;

CREATE PROCEDURE "informix".adeudo_cons_trans(
   p_reca int , p_tipo char(1) , p_cuenta int , p_folio int
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(100);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);

--****** variables locales
define v_estatus char(1);
define v_fecha_pago date;
define v_id_rec smallint;--
define v_caja char(2);--
define v_operacion int;--
define v_modulo int;
define v_mod int;
define  v_operacion_admin int ;
define  v_lugar_pago int;
define v_idnotaria int;
define v_notario varchar(60);
define v_numnotaria int;
define v_mpio int;
define municipio_not varchar(20);

   --Verifica que exista la linea de captura en diversos
   if NOT exists (select * from db_ingresos:ta_12_recibos where id_rec_cta = p_reca and regmunur =  p_tipo and
                 id_regmodulo = p_cuenta and axofolio = p_folio and caja = 'I2' and cvepago = 'P') then 
         return -1,"No existe pago electronico para estos datos!",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   end if; 

 select cvepago ,  fecha , id_rec , caja , operacion , kio_trans , lugar_pago
into v_estatus,v_fecha_pago,v_id_rec,v_caja,v_operacion , v_operacion_admin , v_lugar_pago
from ta_12_recibos where id_rec_cta = p_reca and regmunur =  p_tipo and
                 id_regmodulo = p_cuenta and axofolio = p_folio and caja = "I2" and cvepago = "P";

  if v_operacion_admin = 0 then
         return -1,"SU PAGO NO HA SIDO CONCILIADO, INTENTE EN UNOS 2 DIAS.",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
        end if;

--SET LOCK MODE TO WAIT;
  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 

  where  fecha=v_fecha_pago and id_rec = v_id_rec and caja=v_caja 
	 and operacion=v_operacion and cvepago="P";


 
	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;
-- datos de la Transmision
    select idnotaria into v_idnotaria from catastro_gdl:actostransm where folio = o_axofolio;
select 'NOTARIO: ' || trim(nombres) || ' ' || trim(paterno) || ' '|| trim(materno) , notaria ,  mpionot
  into v_notario , v_numnotaria , v_mpio
   from catastro_gdl:notario  where idnotaria = v_idnotaria ;
if v_mpio > 0 then
   select municipio into municipio_not from catastro_gdl:c_mpios where cvemunicipio = v_mpio;
else
   let municipio_not = '';
end if;
--select * from catastro_gdl:ubicacion where cvecuenta = 189938 o_rfcnumero
--select * from catastro_gdl:c_colonia where cvecolonia = 1
--select * from catastro_gdl:c_mpios

 let o_desc = trim(o_desc) || '@' ||v_notario || ' No. NOT: ' || v_numnotaria || '    DE ' || municipio_not;

        return 0,"REGISTRO VALIDO",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,
              --  o_mesdesde,o_axodesde,o_meshasta,o_axohasta,
               null , null , null, null , 
                o_nombre,o_domicilio,o_concepto,o_rfcini, null,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;


end procedure;

create procedure "informix".admin_adeudos_detalle_30(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(120) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia,v_mensaje varchar(30);
define  v_cveparc char(1);
define  v_letra1,v_let varchar(3);
define  v_bloque1,v_blq varchar(2);
define  v_solicitud,v_monto,v_acumulado decimal(14,2);
define  v_id,v_idresto,v_idadeudo,v_contador,v_axo,v_mes int;
define  v_ref char(7);
define  v_recargos date;

begin
    on exception in (-958)
       delete from tmp_totcertificado;
    end exception;
create temp table tmp_totcertificado(
  rubro int,
  concepto int,
  cuenta int,
  axo int,
  mes int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_contador=0;

foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    -- sacar el periodo d pago
--    select fecha_recargos into v_recargos from ta_11_fecha_desc where mes=month(today);
--    let v_axo=year(today);
--    let v_mes=month(today);
--    if today<v_recargos then
--       if v_mes=1 then
--          let v_mes=12;
--          let v_axo=year(today)-1;
--       else
--          let v_mes=month(today)-1;
--       end if;
--    end if;

    select nvl(Max(axo),0) into v_axo from ta_11_pagos_local where id_local=v_id;
    select nvl(max(periodo),0) into v_mes from ta_11_pagos_local where id_local=v_id 
     and axo=(select nvl(Max(axo),0) from ta_11_pagos_local where id_local=v_id);

    -- obtiene el costo del certificado
    select costo_noadeudo into v_monto from catastro_gdl:parametros; 
    -- obtiene el costo de la solicitud  
    select costo_solnoadeudo into v_solicitud from ta_12_parametros;
    
    let v_acumulado=v_acumulado+v_monto;
    return 0,0,330200000,v_axo||'/'||lpad(v_mes,2,'0'),'CERTIFICADO DE NO ADEUDO',v_monto,v_acumulado with resume;
    insert into tmp_totcertificado values(0,0,330200000,v_axo,v_mes,v_axo||'/'||lpad(v_mes,2,'0'),
                'CERTIFICADO DE NO ADEUDO ',v_monto,v_acumulado);
    let v_acumulado=v_acumulado+v_solicitud;
    return 0,0,421100007,v_axo||'/'||lpad(v_mes,2,'0'),'SOLICITUD',v_solicitud,v_acumulado with resume;
    insert into tmp_totcertificado values(0,0,421100007,v_axo,v_mes,v_axo||'/'||lpad(v_mes,2,'0'),
                'SOLICITUD ',v_solicitud,v_acumulado);
end if;
end foreach;

end procedure;

create procedure "informix".admin_datos_varios_30(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10))

returning   varchar(150) as datovario;

define  v_id,v_contador,v_zona,v_giro,v_axo,v_mes integer;
define  v_mercado,v_seccion,v_adicional varchar(30);
define  v_domicilio varchar(100);
define  v_sector char(1);
define  v_let,v_letra1 varchar(3);
define  v_blq,v_bloque1 varchar(2);
define  v_superficie decimal(6,2);
define  v_recargos date; 

let v_contador=0;
foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    select b.descripcion,d.descripcion,a.domicilio,a.descripcion_local,a.sector,a.zona,a.giro,a.superficie,
    (select Max(axo) from ta_11_pagos_local where id_local=v_id),
    (select max(periodo) from ta_11_pagos_local where id_local=v_id and axo=
    (select Max(axo) from ta_11_pagos_local where id_local=v_id) ) 
    into v_mercado,v_seccion,v_domicilio,v_adicional,v_sector,v_zona,v_giro,v_superficie,v_axo,v_mes 
    from ta_11_locales a,ta_11_mercados b,ta_11_secciones d
    where a.id_local=v_id
    and b.oficina=a.oficina  and b.num_mercado_nvo=a.num_mercado
    and d.seccion=a.seccion;

--    select fecha_recargos into v_recargos from ta_11_fecha_desc where mes=month(today);
--    let v_axo=year(today);
--    let v_mes=month(today);
--    if today<v_recargos then
--       if v_mes=1 then
--          let v_mes=12;
--          let v_axo=year(today)-1;
--       else
--          let v_mes=month(today)-1;
--       end if;
--    end if;

    return v_axo with resume;
    return v_mes with resume;    
    return v_mercado with resume;
    return v_seccion with resume;
    if v_domicilio is null then
       return ' ' with resume;
    else
       return v_domicilio with resume;
    end if;
    return v_adicional with resume;
    return v_sector with resume;
    return v_zona with resume; 
    return v_giro with resume;
    return v_superficie with resume;
end if;
end foreach;
end procedure;

create procedure "informix".admin_encabezados_30(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10))

returning   varchar(92) as Nombrecompleto,
            varchar(80) as calle,
            varchar(10) as Exterior,
            varchar(10) as interior,
            varchar(50) as colonia,
            varchar(10) as codigopostal,
            varchar(13) as RFC,
            varchar(50) as municipio,
            varchar(50) as estado,
            varchar(18) as curp,
            integer as carteraxcobar,
            varchar(255) as leyenda,
            VARCHAR(255) as leyendarecibo,
            integer as codigo;

define  v_descripcionrecibo lvarchar(500);
define  v_carteraxcobar,v_codigo,v_id,v_contador,v_bloqueo,v_axo,v_mes,v_local,vidlocal integer;
define  v_leyenda varchar(255);
define  v_desc,v_mercado varchar(60);
define  v_nombre varchar(92);
define  v_calle varchar(80);
define  v_ext,v_int varchar(10);
define  v_vig char(1);
define  v_let,v_letra1,v_l,v_la varchar(3);
define  v_blq,v_bloque1,v_b,v_ba varchar(2);
define  v_recargos date;
define  v_adeudo money(18,6);

LET v_axo=0;
let v_mes=0;
let v_contador=0;
if not exists(select * from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc) then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'NO EXISTE NUMERO DE LOCAL','',-1;
else
   foreach
   select id_local,letra_local,bloque into v_id,v_let,v_blq 
   from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
   if v_let is null then
      let v_letra1='0';
   else
      let v_letra1=v_let;
   end if;
   if v_blq is null then
      let v_bloque1='0';
   else
      let v_bloque1=v_blq;
   end if;
   if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
       let v_contador=v_contador+1;

--       select fecha_recargos into v_recargos from ta_11_fecha_desc where mes=month(today);
--       let v_axo=year(today);
--       let v_mes=month(today);
--       if today<v_recargos then
--          if v_mes=1 then
--             let v_mes=12;
--             let v_axo=year(today)-1;
--          else
--             let v_mes=month(today)-1;
--          end if;
--       end if; 

       select a.nombre,a.vigencia,a.bloqueo,nvl(d.descripcion,''),
       nvl((select Max(axo) from ta_11_pagos_local where id_local=v_id),0),
       nvl((select max(periodo) from ta_11_pagos_local where id_local=v_id and axo=
       nvl((select Max(axo) from ta_11_pagos_local where id_local=v_id),0) ),0),b.descripcion,
      a.local,letra_local,bloque,a.id_local
       into v_nombre,v_vig,v_bloqueo,v_desc,v_axo,v_mes,v_mercado,v_local,v_l,v_b,vidlocal
       from ta_11_locales a, outer ta_11_cvebloqueo d,ta_11_mercados b
       where a.id_local=v_id and d.cve_bloqueo=a.bloqueo and b.num_mercado_nvo=a.num_mercado
       group by a.nombre,a.vigencia,a.bloqueo,d.descripcion,5,6,b.descripcion,a.local,letra_local,bloque,a.id_local;
       if v_l is null then
          let v_la='';
       else
          let v_la=v_l;
       end if;
       if v_b is null then
          let v_ba='';
       else
          let v_ba=v_b;
       if v_axo is null then
          let v_axo=0;
       end if;
       if v_mes is null then
          let v_mes=0;
       end if;
   end if;
   select nvl(sum(b.importe),0) into v_adeudo from ta_11_energia a,ta_11_adeudo_energ b
    where a.id_local=vidlocal and b.id_energia=a.id_energia;
       if v_vig<>'A' then
          return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONVENIO DADO DE BAJA','',-1;
       end if;
       if v_bloqueo>0 then
          return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'LOCAL BLOQUEADO-'||v_desc,'',-1;
       end if;
       if (v_vig='A') and (v_bloqueo=0) and (v_axo>0) and (v_adeudo=0) then 
          return v_nombre,v_mercado,v_axo||'/'||v_mes,' ',v_local||' LET. '||v_la||' BLQ. '||v_ba,
' ',' ','GUADALAJARA','JALISCO ',' ',1,'PUEDE EMITIR CERTIFICADO','',0;
       end if;
       if (v_vig='A') and (v_bloqueo=0) and (v_axo=0) then 
          return v_nombre,v_mercado,v_axo||'/'||v_mes,' ',v_local||' LET. '||v_la||' BLQ. '||v_ba,
' ',' ','GUADALAJARA ','JALISCO ',' ',1,'PUEDE EMITIR CERTIFICADO - LOCAL SIN PAGOS (NUEVO)','',0;
       end if;
       if (v_vig='A') and (v_bloqueo=0) and (v_adeudo>0) then 
          return v_nombre,' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'EL LOCAL ADEUDA '||v_adeudo||' DE ENERGIA ELECTRICA','',0;
       end if;
   end if;
   end foreach;
if v_contador=0 then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'NO EXISTE NUMERO DE LOCAL','',-1;
end if;
end if;
end procedure;

create procedure "informix".admin_datos_varios_13(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10))

returning   varchar(150) as datovario;

define  v_id,v_contador,v_zona,v_giro integer;
define  v_mercado,v_seccion,v_adicional varchar(30);
define  v_domicilio varchar(100);
define  v_sector  char(1);
define  v_superficie decimal(6,2);
define  v_let,v_letra1 varchar(3);
define  v_blq,v_bloque1 varchar(2);

let v_contador=0;
foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    select b.descripcion,d.descripcion,a.domicilio,a.descripcion_local,a.sector,a.zona,a.giro,a.superficie
    into v_mercado,v_seccion,v_domicilio,v_adicional,v_sector,v_zona,v_giro,v_superficie 
    from ta_11_locales a,ta_11_mercados b,ta_11_secciones d
    where a.id_local=v_id
    and b.oficina=a.oficina  and b.num_mercado_nvo=a.num_mercado
    and d.seccion=a.seccion;
    
    return v_mercado with resume;
    return v_seccion with resume;
    if v_domicilio is null then
       return ' ' with resume;
    else
       return v_domicilio with resume;
    end if;
    return v_adicional with resume;
    return v_sector with resume;
    return v_zona with resume; 
    return v_giro with resume;
    return v_superficie with resume;
end if;
end foreach;
end procedure;

create procedure "pgcabrer".spd_15_mercperexcel(pfemi date)
returning    int as cvereq,
             int as axo,
             varchar(30) as meses,
             money(18,2) as renta,
             money(18,2) as adeudo,
             money(18,2) as recargos;

define  v_cvereq, v_axo, v_mes, v_axo1 int;
define  v_meses varchar(30);
define  v_adeudo, v_recargos, v_renta money(18,2);

foreach
    select b.control_otr,b.cantidad,b.ayo,sum(b.importe),sum(b.recargos)  
    into v_cvereq, v_renta, v_axo, v_adeudo, v_recargos
    from ta_15_apremios a, ta_15_periodos b
    where a.fecha_emision=pfemi and a.modulo=11 and a.vigencia='1'
    and b.control_otr=a.id_control 
    group by 1,2,3 order by b.control_otr,b.ayo 
    let v_meses='';

    foreach
        select ayo,periodo into v_axo1, v_mes
        from ta_15_periodos 
        where control_otr=v_cvereq and ayo=v_axo 
        order by ayo,periodo

        let v_meses=trim(v_meses)||v_mes||',';
    end foreach;
    let v_meses=substr(v_meses,1,(length(v_meses)-1));
    return v_cvereq, v_axo, v_meses, v_renta,v_adeudo, v_recargos   with resume;
end foreach;

end procedure;

create procedure "pgcabrer".spd_15_mercexcel(pfemi date)
returning    int as cvereq,
             int as folio,
             int as recreq,
             int as idlocal,
             date as emision,
             int as ejecutor,
             date as entrega,
             varchar(60) as nombre,
             int as giro,
             int as oficina,
             int as mercado,
             int as categoria,
             char(2) as seccion,
             int as local,
             varchar(3) as letra,
             varchar(2) as bloque,
             varchar(20) as adicionales,
             varchar(30) as nommercado,
             int as zona,
             decimal(7,2) as superficie,
             int as cvecuota,
             money(18,2) as adeudo,
             money(18,2) as recargos,
             money(18,2) as multa,
             money(18,2) as gastos,
             money(18,2) as total;

define  v_cvereq, v_folio, v_recreq, v_idlocal, v_ejecutor, v_giro int;
define  v_oficina, v_mercado, v_categoria, v_local, v_zona, v_cvecuota int;
define  v_emision, v_entrega date;
define  v_seccion, v_bloque varchar(2);
define  v_letra varchar(3);
define  v_nombre varchar(60);
define  v_adicionales varchar(20);
define  v_nommercado varchar(30);
define  v_adeudo, v_recargos, v_multa, v_gastos, v_total money(18,2);
define  v_superficie decimal(7,2);

foreach
select a.id_control,a.folio,a.zona,a.control_otr,a.fecha_emision,a.ejecutor,a.fecha_entrega1,
b.nombre,b.giro,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
b.descripcion_local,d.descripcion,b.zona,a.importe_global,a.importe_recargo,a.importe_multa,
a.importe_gastos,(a.importe_global+a.importe_recargo+a.importe_multa+a.importe_gastos),b.superficie,b.clave_cuota
into v_cvereq, v_folio, v_recreq, v_idlocal, v_emision, v_ejecutor, v_entrega, v_nombre, v_giro,
v_oficina, v_mercado, v_categoria, v_seccion, v_local, v_letra, v_bloque, v_adicionales, v_nommercado,
v_zona, v_adeudo, v_recargos, v_multa, v_gastos, v_total, v_superficie, v_cvecuota
from ta_15_apremios a, ta_11_locales b, ta_11_mercados d
where a.fecha_emision=pfemi and a.modulo=11 and a.vigencia='1'
and b.id_local=a.control_otr and d.num_mercado_nvo=b.num_mercado

return v_cvereq, v_folio, v_recreq, v_idlocal, v_emision, v_ejecutor, v_entrega, v_nombre, v_giro,
v_oficina, v_mercado, v_categoria, v_seccion, v_local, v_letra, v_bloque, v_adicionales, v_nommercado,
v_zona, v_superficie, v_cvecuota, v_adeudo, v_recargos, v_multa, v_gastos, v_total with resume;
end foreach;

end procedure;

CREATE PROCEDURE "informix".kio_pagodiverso3ros(
    		parnumDiv  int,   -- 548 Transmisiones , 533  Tianguis , 551  Registro civil , 549 Avaluos 
                parReferencia varchar(28),
                parnombre char(60),
                parRFC varchar(13),
                pardomicilio char(60),
                parImpCertificado money(15,2),
    		parLugarpago	integer,
                parExtra1         integer,  
                parextra2       integer,
                parextra3       integer
               
        )
		returning smallint , char(2), integer , char(28);
-- parExtra1  para registro civil es el lugar y horario   1 oficina en horario , 2 oficina fuera de horario , 3 domicilio en horario, 4 domicilio fuera de horario
-- parExtra2  para registro civil es el tipo de contrato 1  separacion de bienes ,2 sociedad legal
-- parextra3   para registro civil es la cantidad de anotaciones marginales.


define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define v_cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_orden int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);define v_importex  money(15,2) ;
define v_hora datetime hour to minute;
define  v_linea100 varchar(110);
define v_linea28 varchar(28);
define v_id int;
define v_bco int;
define v_contrato int; 
define v_long int;
define v_contratost char(8);
define v_opcion int;
--set debug file to "pagokioDIV.TXT";
--trace on;
let v_opcion = 0;

   if parnombre = '' then
      return 0, '', 0 , '';
   end if;


 let parnombre = REPLACE(parnombre, '�?', '�');
-- 
if v_opcion = 1 then
       return 0, '', 0 , '';
end if;
 -- select * from ta_12_recibos where caja = 'I1'
 -- select * from catastro_gdl:c_recaud
 --  update ta12_operacKiosco set id_usuario = 549 where rowid = 267

 -- select rowid ,* from ta12_operacKiosco 

   select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parnumDiv; 
 if parnumdiv = 549 then
    let v_concepto = parRFC ||'-Pago AVALUOS';
    let v_bco = 102; -- bbva
 end if; 
 if parnumdiv = 551 then
    let v_concepto = parRFC ||'-Pago REGISTRO CIVIL';
    let v_bco = 102; -- bbva
 end if; 

 if parnumDiv = 533 then  
    let v_concepto = parRFC ||'-Pago Tianguis';
     if parLugarpago = 1 then 
     let v_bco = 166; -- bbva
    end if;
 if parLugarpago = 2 then 
     let v_bco = 164; -- bmx  con respecto a c_reacud catastro
    end if;
 if parLugarpago = 3 then 
     let v_bco = 160;  -- hsbc
    end if;
 if parLugarpago = 4 then 
     let v_bco = 106; -- oxxo
    end if;
 if parLugarpago = 5 then 
     let v_bco = 165; -- guga21
    end if;
 if parLugarpago = 6 then 
     let v_bco = 0;  --Recaudadora
    end if;
       
 end if;

if parLugarpago <> 6 then 
    execute procedure spd_abcrebospagos3ros1(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 12, parnumDiv, 0, '',
              1, 0, 12, 0,  parNombre, pardomicilio,
           v_concepto, '',parnumDiv,0, 
                0,0, parnumDiv ,current,v_bco,0,0,'',0,'I','',parReferencia )
 into spoperacion;



  let varoperacion = spoperacion;
              
   let linea = 1;     
     
     if parnumDiv = 548 then             -- Transmisiones Patrimoniales
       let v_importe = parImpCertificado;
    
     end if;
  if parnumDiv = 533 then               --  para Tianguis Electronico  pago anticipado
 -- select * from ta00_conceptocobro
 -- insert into ta00_conceptocobro values(0, 
    --   select * from 
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 363099999 , parImpCertificado );
    end if;
  if parnumDiv = 551 then               -- para registro civil pago electronico
     -- todos cobran Solicitud 
     --1110	Solicitud de matrimonio		421300002 
      insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 421300002 , parImpCertificado );
    
  --832	Separacion de Bienes Absolutos	421300006
  if parextra2 = 1 then     
      insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 2 , v_concepto, 421300006 , parImpCertificado );
    end if;
    --833	Contrato de Sociedad Legal	421300007
    if parextra2 = 2 then     
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 2 , v_concepto, 421300007 , parImpCertificado );
     end if;
   --988	Anotacion marginal	        310400000
   if parextra3 > 0 then
      insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 3 , v_concepto, 310400000 , parImpCertificado );
    end if;
  -- 1053	$511.00	Matrimonio en Oficina Fuera de Horario
   if parextra1 = 2 then
      insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 3 , v_concepto, 310100000 , parImpCertificado );
    end if;
  -- 1051	$1,407.00	Matrimonio a Domicilio Fuera de Horario
    if parextra1 = 3 then
         insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 310200000 , parImpCertificado );
      end if;
  -- 1050	$736.00	Matrimonio a Domicilio en Horas Habiles
      if parextra1 = 4 then
         insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 310200000 , parImpCertificado );
      end if;
 
 let v_importe = parImpCertificado;

    end if;
   if parnumDiv = 549 then               -- para AVALUOS pago electronico
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 320300000 , parImpCertificado );
    end if;
   let v_linea28 = parReferencia;
  return varrec, varcaja, spoperacion , v_linea28 ;
  else

  return 0, '', 0 , 'RECA 6' ;
  end if;   
     

--trace off;
end procedure;

CREATE PROCEDURE "informix".kio_pagodiverso3ros(
    		parnumDiv  int,   -- 548 Transmisiones , 533  Tianguis , 551  Registro civil , 549 Avaluos 
                parReferencia varchar(28),
                parnombre char(60),
                parRFC varchar(13),
                pardomicilio char(60),
                parImpCertificado money(15,2),
    		parLugarpago	integer
               
               
        )
		returning smallint as Reca, char(2) as caja, integer as operacion  , char(28) as linea;
-- parExtra1  para registro civil es el lugar y horario   1 oficina en horario , 2 oficina fuera de horario , 3 domicilio en horario, 4 domicilio fuera de horario
-- parExtra2  para registro civil es el tipo de contrato 1  separacion de bienes ,2 sociedad legal
-- parextra3   para registro civil es la cantidad de anotaciones marginales.


define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define v_cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_orden int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);define v_importex  money(15,2) ;
define v_hora datetime hour to minute;
define  v_linea100 varchar(110);
define v_linea28 varchar(28);
define v_id int;
define v_bco int;
define v_contrato int; 
define v_long int;
define v_contratost char(8);
define v_opcion int;
--set debug file to "pagokioDIV.TXT";
--trace on;
let v_opcion = 0;

   if parnombre = '' then
      return 0, '', 0 , '';
   end if;


 let parnombre = REPLACE(parnombre, '�?', '�');
-- 
if v_opcion = 1 then
       return 0, '', 0 , '';
end if;
 -- select * from ta_12_recibos where caja = 'I1'
 -- select * from catastro_gdl:c_recaud
 --  update ta12_operacKiosco set id_usuario = 549 where rowid = 267

 -- select rowid ,* from ta12_operacKiosco 
 -- insert into ta12_operacKiosco values (1,'I4',0, 549 , 'L')

   select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parnumDiv; 
 if parnumdiv = 549 then
    let v_concepto = parRFC ||'-Pago AVALUOS';
    let v_bco = 102; -- bbva
 end if; 
 if parnumdiv = 551 then
    let v_concepto = parRFC ||'-Pago REGISTRO CIVIL';
    let v_bco = 102; -- bbva
 end if; 

 if parnumDiv = 533 then  
    let v_concepto = parRFC ||'-Pago Tianguis';
     if parLugarpago = 1 then 
     let v_bco = 166; -- bbva
    end if;
 if parLugarpago = 2 then 
     let v_bco = 164; -- bmx  con respecto a c_reacud catastro
    end if;
 if parLugarpago = 3 then 
     let v_bco = 160;  -- hsbc
    end if;
 if parLugarpago = 4 then 
     let v_bco = 106; -- oxxo
    end if;
 if parLugarpago = 5 then 
     let v_bco = 165; -- guga21
    end if;
 if parLugarpago = 6 then 
     let v_bco = 0;  --Recaudadora
    end if;
       
 end if;

if parLugarpago <> 6 then 
    execute procedure spd_abcrebospagos3ros1(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 12, parnumDiv, 0, '',
              1, 0, 12, 0,  parNombre, pardomicilio,
           v_concepto, '',parnumDiv,0, 
                0,0, parnumDiv ,current,v_bco,0,0,'',0,'I','',parReferencia )
 into spoperacion;



  let varoperacion = spoperacion;
              
   let linea = 1;     
     
     if parnumDiv = 548 then             -- Transmisiones Patrimoniales
       let v_importe = parImpCertificado;
    
     end if;
  if parnumDiv = 533 then               --  para Tianguis Electronico  pago anticipado
 -- select * from ta00_conceptocobro
 -- insert into ta00_conceptocobro values(0, 
    --   select * from 
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 363099999 , parImpCertificado );
    end if;
 
   if parnumDiv = 549 then               -- para AVALUOS pago electronico
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 320300000 , parImpCertificado );
    end if;
   let v_linea28 = parReferencia;
  return varrec, varcaja, spoperacion , v_linea28 ;
  else

  return 0, '', 0 , 'RECA 6' ;
  end if;   
     

--trace off;
end procedure;

create procedure "pgcabrer".ins_apremiosfea(psec int,pdigver varchar(5),pcvereg int,pfalta date,pvig char(1),pfirmante varchar(50),
pcargo varchar(50),pvalidez varchar(80),pffirma varchar(25),phash varchar(200))

returning   int as graba,
            int as existe;

if not exists(select * from ta_15_apremios_fea where id_control_req=pcvereg) then
   insert into ta_15_apremios_fea values (psec,trim(pdigver),pcvereg,pfalta,pvig,trim(pfirmante),trim(pcargo),
   trim(pvalidez),trim(pffirma),trim(phash));

   update ta_15_apremios set fea_secuencia=psec where id_control=pcvereg;
   return 1,0;
else
   return 0,1;
end if;

end procedure;

CREATE PROCEDURE "informix".spd_abcrebospagos3ros1(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo 	integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta      	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia     	integer,
		parObra                 integer,
		parAxofolio               integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                                Partipo_che            smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc char(1),
                pardescripcion varchar(255),
                parREFERENCIA  varchar(30)
		)
		returning integer;

		define varOperacion integer;
 define varuap_rcm  integer;
 define varpar  smallint;
 define vgrupo integer;
--set debug file to "ivan.log";
--trace on;

--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;
let vgrupo = 12;
--si la opcion fue insertar
if parId_modulo = 12 then
   if parId_regmodulo = 1 then
      let vgrupo = 1207; 
   end if;
   if parId_regmodulo = 2 then
      let vgrupo = 1207; 
   end if;
  if parId_regmodulo = 3 then
      let vgrupo = 12003; 
   end if ;
if parId_regmodulo = 532 then
      let vgrupo = 0; 
   end if;
   if parId_regmodulo = 533 then
      let vgrupo = 12533; 
   end if;
  if parId_regmodulo = 534 then
      let vgrupo = 12534; 
   end if ;
end if;


	
	select nvl(operacion,0) + 1
		into varOperacion 
		from ta12_operacKiosco
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario;

	
 
	insert into ta_12_recibos (fecha,
    id_rec ,
    caja ,
    operacion ,
    importe,
    cvepago ,
    id_modulo,
    id_regmodulo,
    id_rec_cta,
    regmunur ,
    mesdesde,
    axodesde ,
    meshasta ,
    axohasta ,
    nombre ,
    domicilio ,
    concepto,
    rfcini ,
    rfcnumero,
    rfccolonia ,
    obra ,
    axofolio ,
    id_usuario ,
    fecha_act ,
    descripcion, lugar_pago,kio_num_terceros,grupo, fec_pagobco) values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current, 
                pardescripcion, parId_banco,parREFERENCIA, vgrupo ,  parFecha );


	update	ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario;
	


return varOperacion;
--trace off;

end procedure;

CREATE PROCEDURE "informix".spd_abcrebospagos3ros(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo 	integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta      	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia     	integer,
		parObra                 integer,
		parAxofolio               integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                                Partipo_che            smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc char(1),
                pardescripcion varchar(255),
                parREFERENCIA  varchar(30)
		)
		returning integer;

		define varOperacion integer;
 define varuap_rcm  integer;
 define varpar  smallint;
 define vgrupo integer;
--set debug file to "ivan.log";
--trace on;

--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;
let vgrupo = 12;
--si la opcion fue insertar
if parId_modulo = 12 then
   if parId_regmodulo = 1 then
      let vgrupo = 1207; 
   end if;
   if parId_regmodulo = 2 then
      let vgrupo = 1207; 
   end if;
  if parId_regmodulo = 3 then
      let vgrupo = 12003; 
   end if ;
if parId_regmodulo = 532 then
      let vgrupo = 0; 
   end if;
   if parId_regmodulo = 533 then
      let vgrupo = 12533; 
   end if;
  if parId_regmodulo = 534 then
      let vgrupo = 12534; 
   end if ;
end if;


	
	select nvl(operacion,0) + 1
		into varOperacion 
		from ta12_operacKiosco
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario;

	
 
	insert into ta_12_recibos (fecha,
    id_rec ,
    caja ,
    operacion ,
    importe,
    cvepago ,
    id_modulo,
    id_regmodulo,
    id_rec_cta,
    regmunur ,
    mesdesde,
    axodesde ,
    meshasta ,
    axohasta ,
    nombre ,
    domicilio ,
    concepto,
    rfcini ,
    rfcnumero,
    rfccolonia ,
    obra ,
    axofolio ,
    id_usuario ,
    fecha_act ,
    descripcion, lugar_pago,kio_num_terceros,grupo , fec_pagobco) values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current, 
                pardescripcion, parid_usuario,parREFERENCIA, vgrupo, parFecha );


	update	ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario;
	


return varOperacion;
--trace off;

end procedure;

create procedure "pgcabrer".gen_foliosgral_fea(pmod int,pfec date)
returning  int as cvereq , date as fecemi , int as folio , int as diligencia, --lvarchar(500) as  cadenaoriginal ;
           varchar(250) as cadena1, varchar(250) as cadena2;

define  v_cvereq int;
define  v_fecemi date;
define  v_folio  int;
define  v_diligencia int;
define  v_cadenaoriginal lvarchar(500);
define  v_cad1, v_cad2 varchar(250);

if pmod=14 then
   foreach
    execute procedure gen_inf_fea(pfec) into v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2
    return v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2 with resume; 
   end foreach;
end if;

if pmod=24 then
   foreach
    execute procedure gen_pub_fea(pfec) into v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2
    return v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2 with resume; 
   end foreach;
end if;

if pmod=28 then
   foreach
    execute procedure gen_exc_fea(pfec) into v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2
    return v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2 with resume; 
   end foreach;
end if;

end procedure;

CREATE PROCEDURE "pgcabrer".gen_exc_fea(pfec date)
returning  int as cvereq , date as fecemi , int as folio , int as diligencia, --lvarchar(500) as  cadenaoriginal ;
           varchar(250) as cadena1, varchar(250) as cadena2; 

define  v_cvereq int;
define  v_fecemi date;
define  v_folio  int;
define  v_diligencia int;
define  v_cadenaoriginal lvarchar(500);
define  v_cad1, v_cad2 varchar(250);


 begin
    on exception in (-958)
       delete from tmp_exc_fea;
    end exception;
    create temp table tmp_exc_fea(
       cve  int ,           
       tip  varchar(16) ,            
       FOL  int,           
       exclusivo  int,           
       pro  varchar(80),      
       dom  varchar(80),                          
       imp  decimal(15,2),
       rec  decimal(15,2), 
       mul  decimal(15,2),
       gto  decimal(15,2),      
       TOT  decimal(15,2),   
       F_EMI date                   
      ) with no log;
  end;

insert into tmp_exc_fea
select a.id_control , (CASE 
          WHEN A.diligencia = 'R' THEN 'REQUERIMIENTO' 
          WHEN A.diligencia = 'S' THEN 'SECUESTRO'
          WHEN A.diligencia = 'N' THEN 'NOTIFICACION' 
          ELSE 'ERROR' END ) ,
          A.FOLIO , C.no_exclusivo, e.propietario,trim(f.calle) ,
          A.importe_global, a.importe_recargo, a.importe_multa, a.importe_gastos, 
         (A.importe_global+a.importe_recargo+a.importe_multa+a.importe_gastos), a.fecha_emision   
          from ta_15_apremios A, dbestacion:ex_contrato C, dbestacion:ex_ubicacion f, dbestacion:ex_propietario e 
          where  a.fecha_entrega1 = pfec  and (a.fea_secuencia is null or a.fea_secuencia=0) and a.modulo=28 AND A.control_otr = C.id and 
          a.vigencia = '1' and a.fecha_citatorio is null and a.ejecutor is not null and a.fecha_pago is null
          and a.recaudadora is null and a.caja is null and a.operacion is null and a.fecha_practicado is null
          and f.ex_contrato_id=c.id and e.id=c.ex_propietario_id;
 foreach
  select   p.id_control , p.fecha_emision , p.folio ,(CASE 
          WHEN p.diligencia = 'R' THEN 2 WHEN p.diligencia = 'S' THEN 3
          WHEN p.diligencia = 'N' THEN 1 ELSE 0 END ) ,
   (  select  genxml(reqfirmar, 'ApremioExclusivo') from ( select cve , tip , FOL , exclusivo, pro , dom , imp , rec, mul , gto , TOT, F_EMI 
     from tmp_exc_fea where cve = P.id_control ) 
          as reqfirmar ) 
     into v_cvereq , v_fecemi , v_folio , v_diligencia , v_cadenaoriginal
     from ta_15_apremios p where p.fecha_entrega1 = pfec and  p.modulo=28 and (p.fea_secuencia is null or p.fea_secuencia=0) and
          p.vigencia = '1' and p.fecha_citatorio is null and p.ejecutor is not null and p.fecha_pago is null
          and p.recaudadora is null and p.caja is null and p.operacion is null and p.fecha_practicado is null
          and p.fecha_practicado is null 
  let v_cad1='';
  let v_cad2='';  
  let v_cad1=substr(v_cadenaoriginal,1,250);
  let v_cad2=substr(v_cadenaoriginal,251,250); 
  return v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2 with resume;

--  return v_cvereq , v_axoreq , v_folioreq , v_cveproceso , v_cadenaoriginal with resume;
   end foreach;

END PROCEDURE;

CREATE PROCEDURE "pgcabrer".gen_pub_fea(pfec date)
returning  int as cvereq , date as fecemi , int as folio , int as diligencia, --lvarchar(500) as  cadenaoriginal ;
           varchar(250) as cadena1, varchar(250) as cadena2; 

define  v_cvereq int;
define  v_fecemi date;
define  v_folio  int;
define  v_diligencia int;
define  v_cadenaoriginal lvarchar(500);
define  v_cad1, v_cad2 varchar(250);


 begin
    on exception in (-958)
       delete from tmp_pub_fea;
    end exception;
    create temp table tmp_pub_fea(
       cve  int ,           
       tip  varchar(16) ,            
       FOL  int,           
       publico  int,           
       pro  varchar(80),      
       dom  varchar(80),                          
       imp  decimal(15,2),
       rec  decimal(15,2), 
       mul  decimal(15,2),
       gto  decimal(15,2),      
       TOT  decimal(15,2),   
       F_EMI date                   
      ) with no log;
  end;

insert into tmp_pub_fea
select a.id_control , (CASE 
          WHEN A.diligencia = 'R' THEN 'REQUERIMIENTO' 
          WHEN A.diligencia = 'S' THEN 'SECUESTRO'
          WHEN A.diligencia = 'N' THEN 'NOTIFICACION' 
          ELSE 'ERROR' END ) ,
          A.FOLIO , C.numesta, c.nombre,(trim(c.calle)||' No. '||c.numext) ,
          A.importe_global, a.importe_recargo, a.importe_multa, a.importe_gastos, 
         (A.importe_global+a.importe_recargo+a.importe_multa+a.importe_gastos), a.fecha_emision   
          from ta_15_apremios A, dbestacion:pubmain C
          where  a.fecha_entrega1 = pfec  and (a.fea_secuencia is null or a.fea_secuencia=0) and a.modulo=24 AND A.control_otr = C.id and 
          a.vigencia = '1' and a.fecha_citatorio is null and a.ejecutor is not null and a.fecha_pago is null
          and a.recaudadora is null and a.caja is null and a.operacion is null and a.fecha_practicado is null;
 foreach
  select   p.id_control , p.fecha_emision , p.folio ,(CASE 
          WHEN p.diligencia = 'R' THEN 2 WHEN p.diligencia = 'S' THEN 3
          WHEN p.diligencia = 'N' THEN 1 ELSE 0 END ) ,
   (  select  genxml(reqfirmar, 'ApremioPublico') from ( select cve , tip , FOL , publico, pro , dom , imp , rec, mul , gto , TOT, F_EMI 
     from tmp_pub_fea where cve = P.id_control ) 
          as reqfirmar ) 
     into v_cvereq , v_fecemi , v_folio , v_diligencia , v_cadenaoriginal
     from ta_15_apremios p where p.fecha_entrega1 = pfec and  p.modulo=24 and (p.fea_secuencia is null or p.fea_secuencia=0) and
          p.vigencia = '1' and p.fecha_citatorio is null and p.ejecutor is not null and p.fecha_pago is null
          and p.recaudadora is null and p.caja is null and p.operacion is null and p.fecha_practicado is null
          and p.fecha_practicado is null 
  let v_cad1='';
  let v_cad2='';  
  let v_cad1=substr(v_cadenaoriginal,1,250);
  let v_cad2=substr(v_cadenaoriginal,251,250); 
  return v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2 with resume;

--  return v_cvereq , v_axoreq , v_folioreq , v_cveproceso , v_cadenaoriginal with resume;
   end foreach;

END PROCEDURE;

CREATE PROCEDURE "pgcabrer".gen_inf_fea(pfec date)
returning  int as cvereq , date as fecemi , int as folio , int as diligencia, --lvarchar(500) as  cadenaoriginal ;
           varchar(250) as cadena1, varchar(250) as cadena2; 

define  v_cvereq int;
define  v_fecemi date;
define  v_folio  int;
define  v_diligencia int;
define  v_cadenaoriginal lvarchar(500);
define  v_cad1, v_cad2 varchar(250);


 begin
    on exception in (-958)
       delete from tmp_inf_fea;
    end exception;
    create temp table tmp_inf_fea(
       cve  int ,           
       tip  varchar(16) ,            
       FOL  int,           
       placa  char(7),           
       pro  varchar(80),      
       dom  varchar(80),                          
       imp  decimal(15,2),      
       gto  decimal(15,2),      
       TOT  decimal(15,2),   
       F_EMI date                   
      ) with no log;
  end;

insert into tmp_inf_fea
select a.id_control , (CASE 
          WHEN A.diligencia = 'R' THEN 'REQUERIMIENTO' 
          WHEN A.diligencia = 'S' THEN 'SECUESTRO'
          WHEN A.diligencia = 'N' THEN 'NOTIFICACION' 
          ELSE 'ERROR' END ) ,
          A.FOLIO , C.placa, c.nombre, 
         (trim( c.domicilio) || ' ' || trim(num_ext) || ' ' || trim(num_int1) || ' ' || trim(num_int2)) ,
          A.importe_global, a.importe_gastos,(A.importe_global+a.importe_gastos), a.fecha_emision   
          from ta_15_apremios A, dbestacion:ta_padron C 
          where  a.fecha_entrega1 = pfec  and (a.fea_secuencia is null or a.fea_secuencia=0) and a.modulo=14 AND A.control_otr = C.id and 
          a.vigencia = '1' and a.fecha_citatorio is null and a.ejecutor is not null and a.fecha_pago is null
          and a.recaudadora is null and a.caja is null and a.operacion is null and a.fecha_practicado is null;
 foreach
  select   p.id_control , p.fecha_emision , p.folio ,(CASE 
          WHEN p.diligencia = 'R' THEN 2 WHEN p.diligencia = 'S' THEN 3
          WHEN p.diligencia = 'N' THEN 1 ELSE 0 END ) ,
   (  select  genxml(reqfirmar, 'ApremioInfraccion') from ( select cve , tip , FOL , placa, pro , dom , imp , gto , TOT, F_EMI 
     from tmp_inf_fea where cve = P.id_control )
          as reqfirmar ) 
     into v_cvereq , v_fecemi , v_folio , v_diligencia , v_cadenaoriginal
     from ta_15_apremios p where p.fecha_entrega1 = pfec and p.modulo=14 and (p.fea_secuencia is null or p.fea_secuencia=0) and
          p.vigencia = '1' and p.fecha_citatorio is null and p.ejecutor is not null and p.fecha_pago is null
          and p.recaudadora is null and p.caja is null and p.operacion is null and p.fecha_practicado is null
          and p.fecha_practicado is null 
  let v_cad1='';
  let v_cad2='';  
  let v_cad1=substr(v_cadenaoriginal,1,250);
  let v_cad2=substr(v_cadenaoriginal,251,250); 
  return v_cvereq , v_fecemi , v_folio , v_diligencia , v_cad1 , v_cad2 with resume;

--  return v_cvereq , v_axoreq , v_folioreq , v_cveproceso , v_cadenaoriginal with resume;
   end foreach;

END PROCEDURE;

CREATE PROCEDURE "informix".ws_lic_consxprop(p_propietario VARCHAR(120))
{######################################################################
#  Procedimiento:    ws_lic_consxprop
#  Descripcion:      Consulta licencias por propietario
#
#  Parametros        p_propietario    = propietario de la licencia
#  de entrada:      
# 
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            18 Octubre 2017   
#  Modificado:       
#  Llamado por:      
#  Llama a:          
#  
######################################################################}
returning 
int         as licencia,
varchar(120) as propietario,
VARCHAR(130) as actividad,
VARCHAR(50) as calle,
int         as num_ext,
VARCHAR(4)  as let_ext,
int         as num_int,
VARCHAR(4)  as let_int;
-----------Define las variables de retorno----------------
define v_licencia       int;
define v_propietario    varchar(120);
define v_actividad      varchar(130);
define v_calle 		VARCHAR(50);
define v_num_ext	int;
define v_let_ext 	VARCHAR(4);
define v_num_int	int;
define v_let_int 	VARCHAR(4);
-----------------------------------------------------------
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

--set debug file to 'marcoprueba.log';
--trace on;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje

RETURN -1, 'Error al consultar ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje,'','',0,'',0,'';

END EXCEPTION;

let v_licencia = 0;
let v_propietario = '';
let v_actividad = '';
let v_calle = '';
let v_num_ext = 0;
let v_let_ext = '';
let v_num_int = 0;
let v_let_int = '';

if trim(p_propietario) = '' then
   let v_propietario = "Capture el propietario";
   return v_licencia,v_propietario,v_actividad,v_calle,v_num_ext,v_let_ext,v_num_int,v_let_int;
end if;

FOREACH
select licencia,trim(trim(nvl(primer_ap,""))||" "||trim(nvl(segundo_ap,""))||" "||trim(propietario)) as propietario
       ,actividad,ubicacion,numext_ubic,letraext_ubic,numint_ubic,letraint_ubic INTO
       v_licencia,v_propietario,v_actividad,v_calle,v_num_ext,v_let_ext,v_num_int,v_let_int
from licencias where vigente="V" and
trim(trim(nvl(primer_ap,""))||" "||trim(nvl(segundo_ap,""))||" "||trim(propietario)) matches p_propietario

return v_licencia,v_propietario,v_actividad,v_calle,v_num_ext,v_let_ext,v_num_int,v_let_int with resume;
END FOREACH;

--trace off;
END PROCEDURE;

create procedure "pgcabrer".spd_11_traspaso(pid int,paxo int,pofi int,puser int)
returning   int as adeudos,
            int as estado,
            varchar(60) as mensaje;

define vid,vaxo,vmes,vadeudos,vestado int;
define vimp money(18,2);
define vmensaje varchar(60);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN 0,-1,'spd_11_traspaso ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let vadeudos=0;
let vestado=0;
let vmensaje='';

foreach
 select id_local,axo,periodo,importe into vid,vaxo,vmes,vimp
 from ta_11_adeudo_local  where id_local=pid
 let vadeudos=vadeudos+1;
 
 insert into ta_11_ade_loc_canc values(0,vid,vaxo,vmes,vimp,'T','ADEUDO CONGELADO POR TRASPASO DE LOCAL OFICIO DI/01/6186/2017', 
 current,puser);

 delete from ta_11_adeudo_local where id_local=vid and axo=vaxo and periodo=vmes;

 
 let vestado=0;
 let vmensaje='Traspaso de adeudo correcto';
end foreach;

update ta_15_apremios set vigencia='S',observaciones='SUSPENDIDO POR TRASPASO DE LOCAL OFICIO DI/01/6186/2017' 
where modulo=11 and control_otr=pid and vigencia='1';

return vadeudos,vestado,vmensaje;

end procedure;

CREATE PROCEDURE "pgmoreno".spivan_2017_aseo (p_tipo char(1), p_numero int)
{######################################################################
#  Procedimiento:    spIvan_2017_Aseo
#  Descripcion:      Interfaz de consulta de Adeudo en ASEO CONTRATADO
#
#  Parametros        parControl_Contrato     = Control del Contrato
#  de entrada:       
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            15 Septiembre 2015   
#
#  Llamado por:      Procedimiento 
#  
######################################################################}
                returning  int as status;
        
define v_importe_multa, v_importe_gastos, v_tot_gastos	Money(12,2);   -- requerimientos
define v_importe, v_importe_CN, v_importe_Exe		Money(12,2);

define v_status                                                                            	Int;
define v_leyenda                                                                        	varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                   	varchar(7);

define v_control_contrato           Integer;   
define v_status_vigencia              Char(1);

Let v_control_contrato = 0;
Let v_status_vigencia = '';

Let v_status      = 0;
Let v_leyenda    = 'NO TIENE ADEUDO';

Let v_importe = 0;
Let v_importe_CN = 0;
Let v_importe_Exe = 0;

-- APREMIOS
Let v_importe_multa = 0;
Let v_importe_gastos = 0;
Let v_tot_gastos = 0;


if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo ) then
	SELECT a.control_contrato, a.status_vigencia  INTO  v_control_contrato, v_status_vigencia
                              FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c  
                              WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp;

	
	FOREACH
	SELECT importe_multa,     importe_gastos  INTO v_importe_multa, v_importe_gastos 
		FROM ta_15_apremios
                  	WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                  	Order By id_control
	Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
	END FOREACH;

	EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

	SELECT sum(importe)  INTO v_importe_CN  FROM ta_16_pagos WHERE control_contrato = v_control_contrato 
                  	and ctrol_operacion = 6 and aso_mes_pago <= v_Periodo_CN  and status_vigencia = 'V';
	if v_importe_CN is Null then
                  	Let  v_importe_CN = 0;
	end if;

                  SELECT sum(importe)  INTO v_importe_Exe  FROM ta_16_pagos WHERE control_contrato = v_control_contrato 
                  	and ctrol_operacion = 7 and aso_mes_pago <= v_Periodo_EXE  and status_vigencia = 'V';
	if v_importe_Exe is Null then
                  	Let  v_importe_Exe = 0;
	end if;

	Let v_importe = v_importe_CN + v_importe_Exe;

	if v_importe > 0 then
                  	let v_status                       = 1;
                                    let v_leyenda    = 'TIENE ADEUDO POR ASEO';
	else
                  	if v_importe_multa > 0 or v_tot_gastos > 0 then
                                    	let v_status                       = 1;
                                                      let v_leyenda    = 'TIENE ADEUDO POR REQUERIMIENTOS';
		else
                                    	let v_status                       = 0;
                                                      let v_leyenda    = 'NO TIENE ADEUDO';
		end if;
	end if;
else
	if v_importe_multa > 0 or v_tot_gastos > 0 then
                  	let v_status                       = 1;
                                    let v_leyenda    = 'TIENE ADEUDO POR REQUERIMIENTOS';
	end if;
end if;

--RETURN v_status, v_leyenda;
RETURN v_status;

end procedure;

CREATE PROCEDURE "informix".spfacele_contrib_abcv33(
    p_RFC varchar(13),
    p_razon varchar(100),
    p_email  varchar(100),
    p_opc char(1)
    )
returning  integer as clave , varchar(100) as observacion  ;

define v_contrfc int; 
define v_id_persona int;
define v_cont_fact int;
--parametros no utilizados en esta version 3.3
define    p_calle  VARCHAR(80);
define    p_no_ext VARCHAR(10);
define    p_no_int VARCHAR(10);
define    p_colonia VARCHAR(30);
define    p_municipio VARCHAR(30);
define    p_estado VARCHAR(30);
define    p_cp int;
let p_calle='';
let p_no_ext='';
let p_no_int='';
let p_colonia='';
let p_municipio='';
let p_estado='';
let p_cp=0;
--altas

if p_opc = 'A' then
     -- verificar que el RFC no exita.
   select count(rfc) into v_contrfc from ta_12_personas_fiscal where rfc = p_rfc;
   if v_contrfc > 0 then
    return -1 , 'YA EXISTE EL RFC,  VERFICAR' ;
   end if;
   insert into ta_12_personas_fiscal ( id_persona , RFC , Razon_social , fecha )
   values(0, p_RFC , p_razon , today  );
   let v_id_persona = dbinfo("sqlca.sqlerrd1");
   insert into ta_12_domicilio_fiscal (id_domicilio,
    id_persona , calle  , no_ext , no_int , colonia , municipio , estado, email, cp , fecha , vigente )
    values(0, v_id_persona , p_calle ,p_no_ext , p_no_int, p_colonia , p_municipio, p_estado,
    p_email  , p_cp , today , 'V');
    return 0,'REGISTRO CORRECTO...';
end if;
if p_opc = 'B' then
    -- verificar que no existan facturas con este rfc  select rowid ,* from ta_12_fact_elec
     select count(*) into v_cont_fact from ta_12_fact_elec where rfc = p_rfc;
    if v_cont_fact > 0 then
      return -4  , 'HAY FACTURAS HECHAS A ESTE RFC, NO SE PUEDE DAR ELIMINAR EL REGISTRO.';
    end if;
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       delete ta_12_personas_fiscal where rfc = p_rfc;
       delete ta_12_domicilio_fiscal  where id_persona = v_id_persona ;
    return 0,'REGISTRO DADO DE BAJA CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;
if p_opc = 'M' then
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       update ta_12_personas_fiscal set razon_social = p_razon where rfc = trim(p_rfc);
    update ta_12_domicilio_fiscal set calle = p_calle , no_ext = p_no_ext , no_int = p_no_int, 
   colonia = p_colonia , municipio = p_municipio, estado = p_estado, email = p_email, cp = p_cp 
   where id_persona = v_id_persona and vigente = 'V' ;
   
   return 0,'REGISTRO ACTUALIZADO CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;

if p_opc = 'W' then --registro por web
     -- verificar que el RFC no exita.
   select id_persona,count(rfc) into v_id_persona,v_contrfc from ta_12_personas_fiscal where rfc = p_rfc group by id_persona;
   if v_contrfc > 0 then
    return v_id_persona , 'YA EXISTE EL RFC' ;
   end if;

   if length(trim(p_RFC))<12 then
      return -1 , 'RFC INCORRECTO, VERIFIQUE' ;
   end if;

   if trim(p_RFC)='' or trim(p_razon)='' or trim(p_email)='' then
      return -1 , 'CAPTURE LOS DATOS COMPLETOS' ;
   end if;

   insert into ta_12_personas_fiscal ( id_persona , RFC , Razon_social , fecha )
   values(0, p_RFC , p_razon , today  );
   let v_id_persona = dbinfo("sqlca.sqlerrd1");
   insert into ta_12_domicilio_fiscal (id_domicilio,
    id_persona , calle  , no_ext , no_int , colonia , municipio , estado, email, cp , fecha , vigente )
    values(0, v_id_persona , p_calle ,p_no_ext , p_no_int, p_colonia , p_municipio, p_estado,
    p_email  , p_cp , today , 'V');
    return v_id_persona,'REGISTRO CORRECTO...';
end if;

if p_opc = 'E' then --Edicion desde web, no se actualiza rfc, razon y email
     -- verificar que el RFC  exita.
   select id_persona into v_id_persona from ta_12_personas_fiscal where rfc = p_rfc;
   if v_id_persona > 0 then
       update ta_12_personas_fiscal set razon_social = p_razon where rfc = trim(p_rfc);
       update ta_12_domicilio_fiscal set calle = p_calle , no_ext = p_no_ext , no_int = p_no_int, 
       colonia = p_colonia , municipio = p_municipio, estado = p_estado, cp = p_cp 
       where id_persona = v_id_persona and vigente = 'V' ;
   
   return 0,'REGISTRO ACTUALIZADO CORRECTAMENTE...';
    else
    return -3, 'NO EXISTE REGISTRO, VERIFICAR .....';
   end if;
end if;

 return -2,'OPCION INCORRECTA, VERIFICAR...';

end procedure;

create procedure "informix".spd_adeudoloc(pidlic int,paxo int,pmes int)
returning   money(18,2) as adeudo,
            int as status,
            varchar(100) as mensaje;

define v_status,v_idlic,v_local,v_merc,aaxo int;
define v_adeudo money(18,2);
define v_mensaje varchar(100);
define avig char(1);

let v_adeudo=null;
let v_local=0;
let v_merc=0;
let aaxo=0;

foreach
select nvl(a.id_local,0) into v_local from ta_11_licencias a,ta_11_adeudo_local b,ta_11_locales d
where a.id_licencia=pidlic and a.vigencia='V' and a.fecha_baja is null
and b.id_local=a.id_local and d.id_local=a.id_local and b.axo in(2002,2004)
and d.num_mercado in(68,46) group by a.id_local
if v_local is null then
   let v_local=0;
end if;
end foreach;

if v_local=0 then

   foreach
   select d.num_mercado into v_merc from ta_11_licencias a,ta_11_locales d
   where a.id_licencia=pidlic and a.vigencia='V' and a.fecha_baja is null
   and d.id_local=a.id_local group by d.num_mercado
   end foreach;
   -- solo valida adeudos hasta este periodo decreto 24837/LX/14 
   if v_merc=14 then
      let paxo=2013;
      let pmes=9;
   end if;
   -- solo valida adeudos hasta este periodo decreto 24895/LX/14.
   if v_merc=61 then
      let paxo=2013;
      let pmes=12;
   end if;
   -- poder cobrar locales del corona pagados al 2014-4 Decreto No. 24901/LX/14
--   if v_merc=70 then
--      let paxo=2014;
--      let pmes=4;
--   end if;

   -- Consulta si existe autorizacion de pago
   select axo,vigencia into aaxo,avig from ta_11_autcobrolic 
   where id_licencia=pidlic and vigencia='V' and fecha_baja is null and axo=year(today);
 
   -- Consulta si tiene adeudo el local
   if v_merc=70 then -- por peticion de Claudia Jara en correo electronico dia 29/12/2017 solo validar adeudos del 2017 en adelante
      select nvl(sum(a.importe),0) into v_adeudo from ta_11_adeudo_local a,ta_11_locales b
      where b.id_local=a.id_local --and b.bloqueo<>1 
      and a.id_local in (select id_local from ta_11_licencias 
      where id_licencia=pidlic and vigencia='V' and fecha_baja is null)
      and ((axo=2017 and periodo>=1) or (axo>2017))
      and ((axo=paxo and periodo<=pmes) or (axo<paxo));
   else
      select nvl(sum(a.importe),0) into v_adeudo from ta_11_adeudo_local a,ta_11_locales b
      where b.id_local=a.id_local --and b.bloqueo<>1 
      and a.id_local in (select id_local from ta_11_licencias 
      where id_licencia=pidlic and vigencia='V' and fecha_baja is null)
      and ((axo=paxo and periodo<=pmes) or (axo<paxo));
   end if;

   if v_adeudo=0 then
      let v_status=0;
      let v_mensaje='Licencia sin adeudo en mercados';
   else   -- se icrementa para la utorizacion del cobro de licencias sin importar el adeudo en el local
   if (v_adeudo)>0 and (aaxo>0) then 
      let v_status=0;
      let v_mensaje='Licencia Autorizada para cobro por motivo de adeudo en mercados'; 
   else
      let v_status=-1;
      let v_mensaje='la licencia pertenece a un local de mercados con adeudo de a�os anteriores por '||v_adeudo; 
   end if;
   end if;
else
   let v_status=0;
   let v_mensaje='Licencia sin adeudo en mercados';
end if;
return v_adeudo,v_status,v_mensaje;
end procedure;

create procedure "pgcabrer".admin_adeudos_detalle_13a(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(120) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia,v_mensaje varchar(30);
define  v_cveparc char(1);
define  v_letra1,v_let varchar(3); 
define  v_bloque1,v_blq varchar(2);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses decimal(14,2);
define  v_aimporte,v_descuento,v_porc,v_gastost,v_impdesc,v_muldesc decimal(14,2);
define  v_folreq,dias_cuantos,dias_habil,v_axomin,v_mesmin int;
define  v_fecreq,v_fecha_desc,v_fecha_rec,v_fecemi date;
define  v_id,v_idresto,v_idadeudo,v_parc,v_aaxo,v_aperiodo,v_dmes,v_desc,v_contador,v_porcdesc,v_cvecuo int;
define  v_ref char(7);
define  v_cuentaapl,v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp int;

begin
    on exception in (-958)
       delete from tmp_totalesmerc;
    end exception;
create temp table tmp_totalesmerc(
  rubro int,
  concepto int,
  cuenta int,
  axo int,
  mes int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;
let v_contador=0;
let v_gastost=0;
let v_aperiodo=0;
let v_impdesc=0;
let v_muldesc=0;

if trim(pref)='' then
   let v_ref=year(today)||'/12';
--   let v_ref='9999/12';
else
   let v_ref=trim(pref);
end if;

foreach
select id_local,letra_local,bloque,clave_cuota into v_id,v_let,v_blq,v_cvecuo 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    -- obtiene las cuentas de aplicacion para el mercado
    select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,
           cuenta_descmulta,cuenta_gastos,cuenta_descpp 
    into v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp
    from ta_11_mercados where num_mercado_nvo=pmer;
    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id;
    -- para sacar el mes minimo       
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id and axo=v_axomin;

    if pmer=70 then
       let v_axomin=2017;
       let v_mesmin=1;
    end if;

    -- para obtener el datos de multa y gastos
    foreach
    select b.fecha_emision,nvl(b.folio,0), nvl(b.importe_multa,0),nvl(importe_gastos,0),
    nvl(b.porcentaje_multa,0),nvl(b.fecha_practicado,null)
    into v_fecemi,v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
    from ta_15_apremios b
    where b.modulo=11 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
    order by  1,2 
    let v_gastost=v_gastost+v_gastos;
    end foreach;

    let dias_cuantos=0;

    select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales 
    where fecha between v_fecreq and today;
    
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
--           let v_multa=v_multa*50/100;
           let v_muldesc=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
--              let v_multa=v_multa*80/100;
              let v_muldesc=v_multa*20/100;
           end if;
        end if;
    else
--        let v_multa=(v_multa*(100-v_porcmul))/100;
        let v_muldesc=(v_multa*v_porcmul)/100;
    end if;

    if v_multa>0 then
       let v_acumulado=v_acumulado+v_multa;
       return 0,0,v_ctamul,v_axomin||'/'||lpad(v_mesmin,2,'0'),'MULTA '||v_folreq,v_multa,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctamul,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'MULTA '||v_folreq,v_multa,v_acumulado);
    end if;

    if v_muldesc>0 then
       let v_muldesc=v_muldesc*-1;
       let v_acumulado=v_acumulado+v_muldesc;
       return 0,0,v_ctadesmul,v_axomin||'/'||lpad(v_mesmin,2,'0'),'DESCUENTO MULTA '||v_folreq,v_muldesc,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctadesmul,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'DESCUENTO MULTA '||v_folreq,v_muldesc,v_acumulado);
    end if;

    if v_gastost>0 then
       let v_acumulado=v_acumulado+v_gastost;
       return 0,0,v_ctagst,v_axomin||'/'||lpad(v_mesmin,2,'0'),'GASTOS '||v_folreq,v_gastost,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctagst,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'GASTOS '||v_folreq,v_gastost,v_acumulado);
    end if;

    foreach
    select a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos,
           d.id_contribuy_renta
    into   v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec,v_desc
    from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d
    where a.id_local=v_id and 
    ( (a.axo>v_axomin  or (periodo>=v_mesmin  and axo=v_axomin)) and
   ((a.axo=substr(v_ref,1,4)  and a.periodo<=substr(v_ref,6,2)) or (a.axo<substr(v_ref,1,4))) )   

    and b.mes=month(today) and d.id_local=a.id_local 
    order by a.axo,a.periodo
    let v_porc=0;
    let v_monto=0;
    let v_impdesc=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    if (pmer=90) or (v_cvecuo=19) then
       let v_monto=v_aimporte;
    else
    if pmer=214 then
       let v_impdesc=(v_aimporte*v_desc)/100;
       let v_monto=v_aimporte;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_monto=v_aimporte;
             else
                let v_impdesc=v_aimporte*.10;
                let v_monto=v_aimporte;
             end if;
          else
             let v_impdesc=v_aimporte*.10;
             let v_monto=v_aimporte;   
          end if;
       else
          let v_monto=v_aimporte;
       end if;   
    end if;
    end if;
    if  v_aaxo=year(today) then
        let v_cuentaapl=v_ctaact;
    else
        let v_cuentaapl=v_ctarzg;
    end if;
    let v_acumulado=v_acumulado+v_monto;
    if pmer=214 then
       return 0,0,v_cuentaapl,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'PAGO TRIMESTRAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'PAGO TRIMESTRAL',v_monto,v_acumulado);
    else
       return 0,0,v_cuentaapl,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado);
    end if;

    if v_impdesc>0 then
       let v_impdesc=v_impdesc*-1;
       let v_acumulado=v_acumulado+v_impdesc;
       if pmer=214 then
          return 0,0,v_ctadespp,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado);
       else
          return 0,0,v_ctadespp,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado);
       end if;
    end if;

    if (v_cvecuo=19) and (v_aaxo=2018) and (v_aperiodo=1) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2018 peticion de Claudia Jara por correo
       execute procedure admin_recargos_13(pmer,v_folreq,(v_monto+v_impdesc),mdy(v_aperiodo,18,v_aaxo)) into v_recargos;
    else
       execute procedure admin_recargos_13(pmer,v_folreq,(v_monto+v_impdesc),mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos;
    end if;

    if v_recargos>0 then
       let v_acumulado=v_acumulado+v_recargos;
       if pmer=214 then
          return 0,0,v_ctarec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO TRIMESTRAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO TRIMESTRAL',v_recargos,v_acumulado);
       else 
          return 0,0,v_ctarec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO MENSUAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO MENSUAL',v_recargos,v_acumulado);
       end if;
       let v_descuento=0; 
       execute procedure sp_desctomerc(v_id,v_aaxo,v_aperiodo,1,v_recargos,null,0,'',0,11) into v_descuento,v_mensaje;
       if v_descuento>0 then
          let v_porcdesc=substr(v_mensaje,length(v_mensaje)-2,3);
          let v_descuento=v_descuento*-1;
          let v_acumulado=v_acumulado+v_descuento;
          if pmer=214 then
             return 0,0,v_ctadesrec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          else 
             return 0,0,v_ctadesrec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          end if;
       end if;
    end if;
    end foreach;
end if;
end foreach;

end procedure;

CREATE PROCEDURE "informix".kio_pagodiverso3ros_ava(
    		parnumDiv  int,   --  549 Avaluos 
                parReferencia varchar(28),
                parnombre char(60),
                parRFC varchar(13),
                pardomicilio char(60),
                parImpCertificado money(15,2),
    		parLugarpago	integer,
                parconcepto      integer,   -- 228 ,229 , 230
                pardescripcion   varchar(80)
               
        )
		returning smallint , char(2), integer , char(28);
-- parextra3   para registro civil es la cantidad de anotaciones marginales.


define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define v_cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_orden int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);define v_importex  money(15,2) ;
define v_hora datetime hour to minute;
define  v_linea100 varchar(110);
define v_linea28 varchar(28);
define v_id int;
define v_bco int;
define v_contrato int; 
define v_long int;
define v_contratost char(8);
define v_opcion int;
--set debug file to "pagokioDIV.TXT";
--trace on;
let v_opcion = 0;

   if parnombre = '' then
      return 0, '', 0 , '';
   end if;


 let parnombre = REPLACE(parnombre, '�?', '�');
-- 
if v_opcion = 1 then
       return 0, '', 0 , '';
end if;
 -- select * from ta_12_recibos where caja = 'I1'
 -- select * from catastro_gdl:c_recaud
 --  update ta12_operacKiosco set id_usuario = 549 where rowid = 267

 -- select rowid ,* from ta12_operacKiosco 

   select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parnumDiv; 
 if parnumdiv = 549 then
    let v_concepto = parRFC ||'-Pago AVALUOS';
    let v_bco = 102; -- bbva
 end if; 




if parLugarpago <> 6 then 
    execute procedure spd_abcrebospagos3ros1(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 12, parnumDiv, 0, '',
              1, 0, 12, 0,  parNombre, pardomicilio,
           v_concepto, '',parnumDiv,0, 
                0,0, parnumDiv ,current,v_bco,0,0,'',0,'I','',parReferencia )
 into spoperacion;



  let varoperacion = spoperacion;
              
   let linea = 1;     


               -- para AVALUOS pago electronico
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , pardescripcion, 320300000 , parImpCertificado );
   
 -- cta aplic  avaluos    320300000

   let v_linea28 = parReferencia;
  return varrec, varcaja, spoperacion , v_linea28 ;
  else

  return 0, '', 0 , 'RECA 6' ;
  end if;   
     

--trace off;
end procedure;

CREATE PROCEDURE "informix".sp_arregla_error( p_operacion int , p_opcion char(1))
RETURNING int as recibo ,  varchar(60) as mensaje;
define v_mensaje varchar(60);
if p_opcion = 'R' then

update ses_facturausuario set estatus = 'SOLICITADA' 
where operacion = p_operacion and estatus = 'ERROR'; 

delete from ta_12_fact_elec where  operacion = p_operacion ; 
let v_mensaje = 'OPERACION SOLICITADA NUEVAMENTE';
else

delete from ta_12_fact_elec where  operacion = p_operacion ;
delete from ses_facturausuario where  operacion = p_operacion and estatus = 'ERROR'; 

let v_mensaje = 'OPERACION ELIMINADA';
end if;

RETURN p_operacion, v_mensaje;
END PROCEDURE;

create PROCEDURE "informix".sp_fe_timbre33(
    p_operacion int,
    p_recibo varCHAR(8)
   )

returning 
 VARCHAR(19)  as fec_hora_solic ,
 DATE         as fecha_solicitud ,
 VARCHAR(10)  as serie,  
 int          as folio,
 VARCHAR(100) as nocertificado ,
 varchar(255) as sellocfd_1 ,
 varchar(255) as sellocfd_2 ,
 VARCHAR(20)  as fechatimbrado,
 VARCHAR(100) as uuid ,
 VARCHAR(100) as nocertificadosat ,
 varchar(255) as sellosat_1,
 varchar(255) as sellosat_2 , 
 varchar(14)  as RFC,
 decimal(15,2) as importe, 
 char(3) as uso_cfdi, 
 integer as operacion;
define v_fec_hora_solic VARCHAR(19);
define v_fecha_solicitud DATE;
define v_serie VARCHAR(10);
define v_folio INT;
define v_nocertificado VARCHAR(100);
define v_sellocfd_1 varchar(255);
define v_sellocfd_2 varchar(255);
define v_fechatimbrado VARCHAR(20);
define v_uuid VARCHAR(100);
define v_nocertificadosat varchar(100);
define v_sellosat_1 varchar(255);
define v_sellosat_2 varchar(255);
define v_rfc  varchar(14);
define v_importe decimal(15,2);
define v_operacion integer;
define v_uso_cfdi char(3);

select fec_hora_solic ,
    fecha_solicitud ,
    serie,
    folio ,
    nocertificado,
     SUBSTRB(sellocfd,0,254) ,
     SUBSTRB(sellocfd,255,254) ,
    fechatimbrado,
    uuid,
    nocertificadosat ,
     SUBSTRB(sellosat,0,254) ,
     SUBSTRB(sellosat,255,254), rfc , importe , operacion
     
into
    v_fec_hora_solic ,
    v_fecha_solicitud ,
    v_serie,
    v_folio ,
    v_nocertificado ,
   
    v_sellocfd_1,
    v_sellocfd_2 ,
    v_fechatimbrado,
    v_uuid,
    v_nocertificadosat ,
    v_sellosat_1 ,
     v_sellosat_2 , v_rfc , v_importe , v_operacion 
    from ta_12_fact_elec where operacion = p_operacion and recibo = p_recibo and can_fecha is null;
   
if v_folio is null then
    return '' , null , '', 0 , '','' , '' ,'', '', '' , '','' ,'' , 0 , '' , 0;
else
    select uso_cfdi into v_uso_cfdi  from ses_facturausuario where operacion = p_operacion and recibo = p_recibo and estatus = 'ELABORADA';
   
    return v_fec_hora_solic , v_fecha_solicitud , v_serie, v_folio , v_nocertificado ,
    v_sellocfd_1, v_sellocfd_2 , v_fechatimbrado, v_uuid,  v_nocertificadosat , v_sellosat_1, v_sellosat_2 , v_rfc , v_importe , v_uso_cfdi , v_operacion ;
end if
--trace off;
end procedure;

CREATE PROCEDURE "informix".adeudo_conslic(
    p_licencia int,
    p_rfc CHAR(13),
    p_axo INT
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;

--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);

--****** variables locales
define v_cvecuenta int;
define v_cvepago int;
define v_caja char(2);--
define v_operacion int;--
define v_fecha date;--
define v_id_rec smallint;--
define v_estatus char(1);
define v_linea char(33);
--Validar licencia y rfc

if not exists(select * from catastro_gdl:licencias where licencia=p_licencia and trim(rfc)=trim(p_rfc)) then
	return -1,"EL NUMERO DE LICENCIA Y R.F.C. NO CORRESPONDEN, CAPTURAR RFC COMO ESTA IMPRESO EN LA LICENCIA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;

end if;


--Validar en ta_12_recibos

       if NOT exists (select * from catastro_gdl:lic_pago_alt l 
				inner join catastro_gdl:pagos p on p.cvepago=l.cvepago and cvecanc is null
				inner join db_ingresos:ta_12_recibos r on r.id_modulo=9 
				and r.fecha = p.fecha and r.caja = p.caja and r.operacion=p.folio 
				and r.id_rec=p.recaud and r.cvepago="P"
		     where l.fecha_registro>"01/01/2018" and l.licencia = p_licencia
			  	and l.cvepago>0 and year(l.fecha_registro)=p_axo ) then --recibos
	return -2,"NO EXISTEN PAGOS PARA ESTA LICENCIA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos
	--COMPROBANTES ELECTRONICOS DESDE 2018
	FOREACH
  	select 	r.fecha,r.id_rec,r.caja,r.operacion,r.importe,r.cvepago,r.id_modulo,r.id_regmodulo,r.id_rec_cta,r.regmunur,
    	 	r.mesdesde,r.axodesde,r.meshasta,r.axohasta,r.nombre,r.domicilio,r.concepto,r.rfcini,r.rfcnumero,r.rfccolonia,
	 	r.obra,r.axofolio,r.id_usuario,r.fecha_act,r.descripcion,r.foliorecibo

  	into   	o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
		o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
		o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  	from catastro_gdl:lic_pago_alt l 
				inner join catastro_gdl:pagos p on p.cvepago=l.cvepago and cvecanc is null
				inner join db_ingresos:ta_12_recibos r on r.id_modulo=9 
				and r.fecha = p.fecha and r.caja = p.caja and r.operacion=p.folio 
				and r.id_rec=p.recaud and r.cvepago="P"
  	where l.fecha_registro>"01/01/2018" and l.licencia = p_licencia
			  	and l.cvepago>0 and year(l.fecha_registro)=p_axo ORDER BY fecha_registro
	END FOREACH;
	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"CUENTA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;
end procedure;

CREATE PROCEDURE "informix".spd_siapa_23hrs( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;

   foreach
select  a.cvecuenta , k.fecha ,  k.importe ,  a.bim_ini  ,   a.axo_ini  ,  a.bim_fin  ,  a.axo_fin  ,   a.id_transaccion 
 into v_cvecuenta , v_fecha ,  v_importe ,  v_bim_ini  ,   v_axo_ini  ,  v_bim_fin  ,  v_axo_fin  ,   v_id_transaccion 
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal = 'SIAPA' and a.cancelacion is null
 and k.cvekiosco = a.cvepago 

execute procedure db_ingresos:spd_pagpredkioSiapa5( v_cvecuenta, v_fecha,  v_importe, v_bim_ini, v_axo_ini, v_bim_fin , v_axo_fin , v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

create procedure "informix".admin_detalle_kiosco2(pfecha date,prec int,pcaja char(8),poper int)
returning   int as rubro,
            int as concepto,
            int as cuenta,
            varchar(120) as descripcion,
            money(14,2) as monto;

define v_cuenta,v_modulo int;
define v_descripcion,v_desc varchar(120);
define v_monto money(14,2);
define v_parte varchar(9);
define v_fecharecibo  date;
let v_parte='';
let v_desc='';
let v_modulo=0;


if pcaja = 'I3'  then
     select fecha into v_fecharecibo from ta_12_recibos where fec_pagobco = pfecha and id_rec=prec and caja=pcaja 
          and operacion=poper;
    if not exists(select * from ta_12_recibosdet 
              where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper) then
    return 0,0,0,'No existe ',0;
    end if;

-- obtiene el numero de modulo
 


select id_modulo into v_modulo from ta_12_recibos
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper; 

foreach
select cuenta,descripcion,importe,substring(descripcion from 1 for locate(descripcion,' ')) 
into v_cuenta,v_descripcion,v_monto,v_parte from ta_12_recibosdet 
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper
order by linea
if (v_parte MATCHES '*[a-zA-Z!^]*') or (v_parte='') then
   let v_parte='';
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+1),120);
else
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+2),120);
end if;

if (v_cuenta>0) and (v_monto<>0) then
   if v_modulo <> 9 then
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   else
      let v_descripcion=lpad(trim(v_parte),9,' ')||v_desc;
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   end if;
end if;

end foreach;

else
   select fecha into v_fecharecibo from ta_12_recibos where fec_pagobco = pfecha and id_rec=prec and caja=pcaja 
          and operacion=poper;
   if not exists(select * from ta_12_recibosdet 
              where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper) then
        return 0,0,0,'No existe ',0;
   end if;

select id_modulo into v_modulo from ta_12_recibos
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper; 
foreach
select cuenta,descripcion,importe,substring(descripcion from 1 for locate(descripcion,' ')) 
into v_cuenta,v_descripcion,v_monto,v_parte from ta_12_recibosdet 
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper
order by linea
if (v_parte MATCHES '*[a-zA-Z!^]*') or (v_parte='') then
   let v_parte='';
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+1),120);
else
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+2),120);
end if;

if (v_cuenta>0) and (v_monto<>0) then
   if v_modulo <> 9 then
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   else
      let v_descripcion=lpad(trim(v_parte),9,' ')||v_desc;
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   end if;
end if;

end foreach;


end if;



end procedure;

create procedure "informix".admin_detalle_kiosco(pfecha date,prec int,pcaja char(8),poper int)
returning   int as rubro,
            int as concepto,
            int as cuenta,
            varchar(120) as descripcion,
            money(14,2) as monto;

define v_cuenta,v_modulo int;
define v_descripcion,v_desc varchar(120);
define v_monto money(14,2);
define v_parte varchar(9);
define v_fecharecibo  date;
let v_parte='';
let v_desc='';
let v_modulo=0;


if pcaja = 'I3'  then
     select fecha into v_fecharecibo from ta_12_recibos where fec_pagobco = pfecha and id_rec=prec and caja=pcaja 
          and operacion=poper;
    if not exists(select * from ta_12_recibosdet 
              where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper) then
    return 0,0,0,'No existe ',0;
    end if;

-- obtiene el numero de modulo
 


select id_modulo into v_modulo from ta_12_recibos
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper; 

foreach
select cuenta,descripcion,importe,substring(descripcion from 1 for locate(descripcion,' ')) 
into v_cuenta,v_descripcion,v_monto,v_parte from ta_12_recibosdet 
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper
order by linea
if (v_parte MATCHES '*[a-zA-Z!^]*') or (v_parte='') then
   let v_parte='';
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+1),120);
else
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+2),120);
end if;

if (v_cuenta>0) and (v_monto<>0) then
   if v_modulo <> 9 then
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   else
      let v_descripcion=lpad(trim(v_parte),9,' ')||v_desc;
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   end if;
end if;

end foreach;

else
   select fecha into v_fecharecibo from ta_12_recibos where fec_pagobco = pfecha and id_rec=prec and caja=pcaja 
          and operacion=poper;
   if not exists(select * from ta_12_recibosdet 
              where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper) then
        return 0,0,0,'No existe ',0;
   end if;

select id_modulo into v_modulo from ta_12_recibos
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper; 
foreach
select cuenta,descripcion,importe,substring(descripcion from 1 for locate(descripcion,' ')) 
into v_cuenta,v_descripcion,v_monto,v_parte from ta_12_recibosdet 
where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper
order by linea
if (v_parte MATCHES '*[a-zA-Z!^]*') or (v_parte='') then
   let v_parte='';
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+1),120);
else
   let v_desc=substr(v_descripcion,(length(trim(v_parte))+2),120);
end if;

if (v_cuenta>0) and (v_monto<>0) then
   if v_modulo <> 9 then
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   else
      let v_descripcion=lpad(trim(v_parte),9,' ')||v_desc;
      return 0,0,v_cuenta,v_descripcion,v_monto with resume;
   end if;
end if;

end foreach;


end if;



end procedure;

create procedure "informix".admin_encabezado_kiosco3tot(pcaja char(8), pfecha date )
returning       int as interface,
                char(10) as segmento1,
                char(10) as segmento2,
                char(10) as segmento3,
                char(10) as segmento4,
                char(10) as segmento5,
                char(10) as segmento6,
                varchar(250) as descripcionrbo,
                varchar(92) as nombre,
                varchar(80) as calle,
                int as recaudadora,
                int as operacionmpio,
                money(14,2) as importerecibido, 
                money(14,2) as importedetalle,
                int as LugarCobro ;

define v_interface,v_rec,v_oper,v_idregmodulo,v_rfcnumero,v_idreccta,v_modulo,v_grupo int;
define v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_knterceros varchar(10);
define v_descrbo varchar(250);
define v_nombre varchar(92);
define v_calle varchar(80);
define v_importe money(14,2);
define v_importedet money(14,2);
define v_ur char(1);
define v_placa varchar(7);
define v_lugar int;
define v_axofolio int;
define v_fecharecibo date;

let pcaja = upper(pcaja);


   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , lugar_pago , axofolio , fecha
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_lugar , v_axofolio , v_fecharecibo
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans=0 
   order by operacion
 
select sum(importe)  
into v_importedet from ta_12_recibosdet 
where fecha=v_fecharecibo and id_rec=v_rec and caja=pcaja and operacion=v_oper ;

   return 8,v_idreccta,v_ur,v_rfcnumero,0,0,0,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe , v_importedet , v_lugar with resume;
   end foreach;
 

end procedure
;

CREATE PROCEDURE "informix".spd_pagpredkiosiapa5(
    		parcvecuenta    integer,
                parfechaPAgo    date ,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		
                parIdTransKio   integer
        )
		returning smallint , char(2), integer, char(28), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int; 
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define pg_recaud int;
define pg_caja char(2);
define pg_folio int;
define pg_fecha date ;
define pg_cvecuenta int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
  
   if varcvepago > 0 then
      select recaud , caja , folio , fecha , cvecuenta into
             pg_recaud , pg_caja , pg_folio , pg_cvecuenta
      from catastro_gdl:pagos where cvepago = varcvepago ;

       update db_ingresos:ta_12_recibos set cvepago = 'C' 
       where fecha = pg_fecha and id_rec = pg_recaud and caja =  pg_caja and operacion = pg_folio and id_modulo = 5 
        and rfcnumero = pg_cvecuenta and cvepago = 'P';
       insert into catastro_gdl:pagoscan values(0,varcvepago , 'SIAPA' ,parfechaPAgo);
    end if;
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
 --set debug file to "pago13";
 --trace on;
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;

 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo , 
   trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior),
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior)
   || '@CVECATASTRAL ' || CVECATNVA || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa 

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip   , v_hora
 from catastro_gdl:datos_gralKio a 
 where a.cvecuenta = parcvecuenta;

  select id_rec , caja  into varrec , varcaja
  
  from ta12_operacKiosco
  where id_usuario = 171; 
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(parfechaPAgo ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial en SIAPA de la cuenta ' || parcvecuenta , '',parcvecuenta,0,
                0,0,171,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'SIAPA' ;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, parfechaPAgo, v_hora , 
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1"); 
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)
                
let linea = 1;     
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
execute procedure  catastro_gdl:kiosco_totalespred_nvo( parcvecuenta , parAxohasta, parMeshasta, 1) 
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 
if v_ob = 'D' then 
     if v_cuenta <> 550800000   then
  insert into ta_12_recibosdet
        ( fecha       , id_rec , caja    , operacion     , linea , descripcion , cuenta    , importe )
  values( parfechaPAgo, varrec , varcaja ,  varoperacion , linea ,  v_concepto ,   v_cuenta, v_importe );
     end if;
     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea +1 ;
 end if;
if v_ob = 'T' then 
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
 select   s.multa,  s.gasto,  s.multavir 
    into   v_mulpag,  v_gaspag,  v_multasvir 
      from  catastro_gdl:saldos s  where  s.cvecuenta= parcvecuenta;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq) 
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta 
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
-- insertar la detalle de lugar de pago en este caso los datos del siapa. select * from catastro_gdl:banamex
 --select * from catastro_gdl:k_pagos where llave = 525535
    insert into catastro_gdl:banamex(cvepago,cvecuenta,recaud,folio ,caja,operacion,fecha,fechapago,
       importe,importepago, tipopago, fecarga) 
     values (varcvepago,parcvecuenta, 171, varoperacion , 'KS', varoperacion,parfechaPAgo, 
              parfechaPAgo, parImpCertificado, parImpCertificado,5,parfechaPAgo);
   
if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor , 
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);
 
--select * from liga_linea_trans where id_transaccion =  parIdTransKio;
select a.linea into v_lineacapt2 from catastro_gdl:linea_capturapred a, catastro_gdl:liga_linea_trans t 
where  t.id_transaccion = parIdTransKio and t.refer_id = a.id;

--select * from catastro_gdl:linea_capturapred 
--select * from catastro_gdl:liga_linea_trans 

    execute  PROCEDURE linea_pagok(v_lineacapt2, 171, parImpCertificado, 'K',varcvepago,
             parfechaPAgo, varrec , varcaja, varoperacion, 'SIAPA') into  estatus ,mensaje ;
	-- COMMIT WORK;   
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago;
--trace off;
end procedure
;

create procedure "informix".spd_11_padadeudos(paxo int,pmes int,ptip char(1))
returning   char(30) as mercado,
            smallint as Merc,
            integer as idlocal,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo_anterior,
            MONEY(16,2) as recargos_anterior,
            MONEY(16,2) as adeudo2001,
            MONEY(16,2) as recargos2001,
            MONEY(16,2) as adeudo2002,
            MONEY(16,2) as recargos2002,
            MONEY(16,2) as adeudo2003,
            MONEY(16,2) as recargos2003,
            MONEY(16,2) as adeudo2004,
            MONEY(16,2) as recargos2004,
            MONEY(16,2) as adeudo2005,
            MONEY(16,2) as recargos2005,
            MONEY(16,2) as adeudo2006,
            MONEY(16,2) as recargos2006,
            MONEY(16,2) as adeudo2007,
            MONEY(16,2) as recargos2007,
            MONEY(16,2) as adeudo2008,
            MONEY(16,2) as recargos2008,
            MONEY(16,2) as adeudo2009,
            MONEY(16,2) as recargos2009,
            MONEY(16,2) as adeudo2010,
            MONEY(16,2) as recargos2010,
            MONEY(16,2) as adeudo2011,
            MONEY(16,2) as recargos2011,
            MONEY(16,2) as adeudo2012,
            MONEY(16,2) as recargos2012,
            MONEY(16,2) as adeudo2013,
            MONEY(16,2) as recargos2013,
            MONEY(16,2) as adeudo2014,
            MONEY(16,2) as recargos2014,
            MONEY(16,2) as adeudo2015,
            MONEY(16,2) as recargos2015,
            MONEY(16,2) as adeudo2016,
            MONEY(16,2) as recargos2016,
            MONEY(16,2) as adeudo2017,
            MONEY(16,2) as recargos2017,
            MONEY(16,2) as adeudo2018,
            MONEY(16,2) as recargos2018,
            MONEY(16,2) as multa,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total;
  
define v_recargostotal,v_rec2001,v_rec2002,v_rec2003,v_rec2004,v_rec2005,v_rec2006,
       v_rec2007,v_rec2008,v_rec2009,v_rec2010,v_rec2011,v_rec2012,v_rec2013,
       v_rec2014,v_rec2015,v_rec2016,v_rec2017,v_rec2018 MONEY(16,2);
define v_ade2001,v_ade2002,v_ade2003,v_ade2004,v_ade2005,v_ade2006,
       v_ade2007,v_ade2008,v_ade2009,v_ade2010,v_ade2011,v_ade2012,v_ade2013,
       v_ade2014,v_ade2015,v_ade2016,v_ade2017,v_ade2018 MONEY(16,2);  
define v_multa MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer char(30);          define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(1);           define v_blq char(1);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);       define v_zona int;
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 


foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,nvl(sum(d.importe),0)
,fn_getademerc(a.id_local,2001,12),fn_getrecmerc(a.id_local,2001,12)
,fn_getademerc(a.id_local,2002,12),fn_getrecmerc(a.id_local,2002,12)
,fn_getademerc(a.id_local,2003,12),fn_getrecmerc(a.id_local,2003,12)
,fn_getademerc(a.id_local,2004,12),fn_getrecmerc(a.id_local,2004,12)
,fn_getademerc(a.id_local,2005,12),fn_getrecmerc(a.id_local,2005,12)
,fn_getademerc(a.id_local,2006,12),fn_getrecmerc(a.id_local,2006,12)
,fn_getademerc(a.id_local,2007,12),fn_getrecmerc(a.id_local,2007,12) 
,fn_getademerc(a.id_local,2008,12),fn_getrecmerc(a.id_local,2008,12)
,fn_getademerc(a.id_local,2009,12),fn_getrecmerc(a.id_local,2009,12)
,fn_getademerc(a.id_local,2010,12),fn_getrecmerc(a.id_local,2010,12)
,fn_getademerc(a.id_local,2011,12),fn_getrecmerc(a.id_local,2011,12)
,fn_getademerc(a.id_local,2012,12),fn_getrecmerc(a.id_local,2012,12)
,fn_getademerc(a.id_local,2013,12),fn_getrecmerc(a.id_local,2013,12)
,fn_getademerc(a.id_local,2014,12),fn_getrecmerc(a.id_local,2014,12)
,fn_getademerc(a.id_local,2015,12),fn_getrecmerc(a.id_local,2015,12)
,fn_getademerc(a.id_local,2016,12),fn_getrecmerc(a.id_local,2016,12)
,fn_getademerc(a.id_local,2017,12),fn_getrecmerc(a.id_local,2017,12)
,fn_getademerc(a.id_local,2018,pmes),fn_getrecmerc(a.id_local,2018,pmes)
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_zona,v_superf,v_est,v_bloqueo,v_cvecuo,
v_ade,v_ade2001,v_rec2001,v_ade2002,v_rec2002,
v_ade2003,v_rec2003,v_ade2004,v_rec2004,v_ade2005,v_rec2005,v_ade2006,v_rec2006,v_ade2007,v_rec2007,
v_ade2008,v_rec2008,v_ade2009,v_rec2009,v_ade2010,v_rec2010,v_ade2011,v_rec2011,v_ade2012,v_rec2012,
v_ade2013,v_rec2013,v_ade2014,v_rec2014,v_ade2015,v_rec2015,v_ade2016,v_rec2016,v_ade2017,v_rec2017,
v_ade2018,v_rec2018
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where b.tipo_emision=ptip and a.vigencia='A'
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
and d.id_local=a.id_local and (d.axo<2000  or (d.periodo<=12 and d.axo=2000))
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,bloqueo,a.clave_cuota
having (sum(d.importe)>0) or (fn_getademerc(a.id_local,2001,12))>0 or (fn_getademerc(a.id_local,2002,12))>0
or (fn_getademerc(a.id_local,2003,12))>0 or (fn_getademerc(a.id_local,2004,12))>0
or (fn_getademerc(a.id_local,2005,12))>0 or (fn_getademerc(a.id_local,2006,12))>0 
or (fn_getademerc(a.id_local,2007,12))>0 or (fn_getademerc(a.id_local,2008,12))>0 
or (fn_getademerc(a.id_local,2009,12))>0 or (fn_getademerc(a.id_local,2010,12))>0
or (fn_getademerc(a.id_local,2011,12))>0 or (fn_getademerc(a.id_local,2012,12))>0
or (fn_getademerc(a.id_local,2013,12))>0 or (fn_getademerc(a.id_local,2014,12))>0
or (fn_getademerc(a.id_local,2015,12))>0 or (fn_getademerc(a.id_local,2016,12))>0
or (fn_getademerc(a.id_local,2017,12))>0 or (fn_getademerc(a.id_local,2018,pmes))>0 
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

if v_est='A' then
   if v_bloqueo=4 then
      let v_estado='VIGENTE-BLOQUEADO';
   else
      let v_estado='VIGENTE';
   end if;
else
   let v_estado='BAJA';
end if;

select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  
let v_total=0;

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=v_idl and (a.axo<2000  or (a.periodo<=12 and a.axo=2000)) 
and b.mes=month(today)
order by axo,periodo

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if today>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

-- verifica los periodos de adeudo
select a.id_local, ( 
(select min(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo)))),
((select Max(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo))))
into v_ida,v_ini,v_fin
from   ta_11_adeudo_local a   
where  a.id_local=v_idl 
group by a.id_local;
let v_periodo=trim(v_ini);

-- verifica los folios de requerimientos
let v_requerimientos='';
foreach
select id_control,fecha_emision,folio,fecha_practicado,( 
(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
from   ta_15_apremios a   
where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
and a.fecha_emision>=mdy(1,1,2013)
order by a.fecha_emision,a.folio
let v_requerimientos=trim(v_requerimientos)||v_fol||',';
end foreach; -- cierre de apremios

let v_requerimientos=substr(v_requerimientos,1,(length(v_requerimientos)-1));
let v_total=v_ade+v_recargostotal+v_ade2001+v_rec2001+v_ade2002+v_rec2002+
v_ade2003+v_rec2003+v_ade2004+v_rec2004+v_ade2005+v_rec2005+v_ade2006+v_rec2006+v_ade2007+v_rec2007+
v_ade2008+v_rec2008+v_ade2009+v_rec2009+v_ade2010+v_rec2010+v_ade2011+v_rec2011+v_ade2012+v_rec2012+
v_ade2013+v_rec2013+v_ade2014+v_rec2014+v_ade2015+v_rec2015+v_ade2016+v_rec2016+v_ade2017+v_rec2017+
v_ade2018+v_rec2018+v_multa+v_gastos;

return trim(v_mer),v_nme,v_idl,trim(v_estado),trim(v_periodo),v_ade,v_recargostotal,v_ade2001,v_rec2001,v_ade2002,v_rec2002,
v_ade2003,v_rec2003,v_ade2004,v_rec2004,v_ade2005,v_rec2005,v_ade2006,v_rec2006,v_ade2007,v_rec2007,
v_ade2008,v_rec2008,v_ade2009,v_rec2009,v_ade2010,v_rec2010,v_ade2011,v_rec2011,v_ade2012,v_rec2012,
v_ade2013,v_rec2013,v_ade2014,v_rec2014,v_ade2015,v_rec2015,v_ade2016,v_rec2016,v_ade2017,v_rec2017,
v_ade2018,v_rec2018,v_multa,v_gastos,v_total
with resume;
end foreach; -- cierre del principal

end procedure;

CREATE PROCEDURE "pgmoreno".con16_costo_und ( in_cve_recolec Char(1), in_axo Integer )
{######################################################################
#  Procedimiento:    con16_costo_und
#  Descripcion:      ASEO CONTRATADO
#
--  Parametros	
--  de entrada:
--		in_cve_recolec	= clave de recoleccion
--		in_axo		= a�o de ejercicico
--		
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            Marzo 2018   
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
	returning Money(12,2),	-- Costo de Unidad en CN
		Money(12,2);    	-- Costo de Unidad en EXE

define v_costo_unidad, v_costo_exed	Money(12,2);

Let v_costo_unidad = 0;
Let v_costo_exed = 0;


--****************************************************************************************************************************** 
SELECT costo_unidad, costo_exed 
INTO      v_costo_unidad, v_costo_exed 
FROM ta_16_unidades  
	WHERE cve_recolec = par_Cve_recolec AND ejercicio_recolec = par_Axo;
--****************************************************************************************************************************** 

RETURN v_costo_unidad, v_costo_exed;

end procedure;

CREATE PROCEDURE "pgmoreno".ins16_adeudos_02 ( in_control_contrato Int, 
in_cve_recolec char(1), in_cant_recolec int, 
in_axo int, in_mes int )
               
{######################################################################
#  Procedimiento:    ins16_adeudos_02
#  Descripcion:      ASEO CONTRATADO
#
--  Parametros	
--  de entrada:
--  		in_control_contrato	= control del contrato

--		in_cve_recolec	= clave de recoleccion
--		in_cant_recolec	= cantidad de recoleccion
--		in_axo		= a�o de ejercicico
--		in_mes		= mes de inicio
--		
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            Marzo 2018   
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning Integer,                     -- Status
                               varchar(100);     -- Concepto status

define v_costo_unidad, v_costo_exed, v_importe	Money(12,2);
define v_mes, v_ctrol_operacion int;
define v_id_usuario INT;

Let v_costo_unidad = 0;
Let v_costo_exed = 0;
Let v_importe = 0;
Let v_mes = 0;
Let v_ctrol_operacion = 0;
lET v_id_usuario = 0;

EXECUTE PROCEDURE con16_Costo_Und ( in_cve_recolec, in_axo ) INTO v_costo_unidad, v_costo_exed;
SELECT ctrol_operacion  INTO  v_ctrol_operacion FROM ta_16_operacion WHERE cve_operacion = 'C';
SELECT id_usuario INTO v_id_usuario FROM ta_12_passwords WHERE usuario = user;	-- obtiene Id USUARIO


Let v_importe = in_cant_recolec * v_costo_unidad;
FOR v_mes = in_mes to 12

	INSERT INTO ta_16_Pagos VALUES  ( in_control_contrato, mdy(v_mes, 01, in_axo), v_ctrol_operacion, v_importe, 'V', Null, 0, Null, 0, Null, v_id_usuario, in_cant_recolec);

END FOR;

	RETURN 1,'Genero Adeudos, revisar';

end procedure;

CREATE PROCEDURE "informix".linea_capturamrc(p_id_local int, p_desde int, p_hasta int,
p_adeudo money(16,2),p_recargos money(16,2),p_gastos money(16,2),p_multas money(16,2),p_total money(16,2),p_fecha date)

returning varchar(110),varchar(28);

define linea1 varchar(110);
define resultado varchar(110);
define v_codigo1 varchar(20);
define v1_7 smallint;
define v1_3 smallint;
define v1_1 smallint;
define vt1    int;
define i int;
define fecha int;
define fecha_st char(5);
define fechax date;
define control int;
define v_id int;
define v2_11 smallint;
define v2_13 smallint;
define v2_17 smallint;
define v2_19 smallint;
define v2_23 smallint;
define vt2    int;

--set debug file to "banamex.log";
--   trace on;

let linea1 = substr((p_id_local/10000000),4,6) || '000000';

insert into linea_capturamrc (id,linea,fecha,fecha_vig,id_local,desde,hasta,adeudo,recargos,gastos,multas,total)
 values (0,linea1,current,null,p_id_local,p_desde,p_hasta,p_adeudo,p_recargos,p_gastos,p_multas,p_total);

LET v_id = dbinfo("sqlca.sqlerrd1");
--LET v_id = 999999;

let linea1 = linea1|| substr((v_id/1000000),3,6)  ;

let linea1 = linea1 || "11"; --pago de diversos

---- codifica fecha
-- let fechax = TO_DATE("26/02/2010", "%d/%m/%iY");
let fechax = p_fecha;

--let fecha = ((year(fechax) - 1988) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1);
--let linea1 = linea1 || fecha;
let fecha = (((year(fechax) - 2013) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1)) + 10000;  -- se modifica el a�o base a 2013
let fecha_st = '' || fecha;

let linea1 = linea1 || fecha_st[2,5];

------digito verificador de importe
let v_codigo1 = trunc(p_total*100) ;
let vt1 = 0;

for i =   length(v_codigo1) to 1 step -3
  let v1_7 = 0;
  let v1_3 = 0;
  let v1_1 = 0;

  if i >= 1 then
     let v1_7 = substr(v_codigo1,i , 1)  * 7;
  end if;
  if i >= 2 then
     let v1_3 = substr(v_codigo1,(i -1) , 1)  * 3;
  end if;
  if i >= 3 then
     let v1_1 = substr(v_codigo1,(i -2), 1)  * 1;
  end if;

  let  vt1 = vt1+ v1_7 + v1_3 + v1_1;

end for;
let vt1 = mod(vt1,10);
let linea1 = linea1 || vt1;

-----controles
let control = 2; ---valida fecha e importe
let linea1 = linea1 || control;

---control global
let vt2 = 0;

for i =   length(linea1) to 1 step -5
  let v2_11 = 0;
  let v2_13 = 0;
  let v2_17 = 0;
  let v2_19 = 0;
  let v2_23 = 0;

  if i >= 1 then
     let v2_11 = substr(linea1,i , 1)  * 11;
  end if;
  if i >= 2 then
     let v2_13 = substr(linea1,(i -1) , 1)  * 13;
  end if;
  if i >= 3 then
     let v2_17 = substr(linea1,(i -2), 1)  * 17;
  end if;
  if i >= 4 then
     let v2_19 = substr(linea1,(i -3), 1)  * 19;
  end if;  
  if i >= 5 then
     let v2_23 = substr(linea1,(i -4), 1)  * 23;
  end if;
  let  vt2 = vt2+ v2_11 + v2_13 + v2_17 + v2_19 + v2_23;

end for;
let vt2 = mod(vt2,97) +1;
if vt2 < 10 then
   let linea1 = linea1 || "0" || vt2;
else
   let linea1 = linea1 || vt2;
end if;
-----divide la linea en grupos de cuatro caracteres
let resultado = "";

for i = 1 to length(linea1) step 4
   let resultado = resultado || substr(linea1,i , 4) || "   ";
end for;

--trace off;
let resultado = resultado || "     " || p_total;

update linea_capturamrc set linea = linea1, fecha_vig = fechax where id = v_id;

return resultado,linea1;

end procedure;

CREATE PROCEDURE "informix".linea_capturamrc(p_id_local int, p_desde int, p_hasta int,
p_adeudo money(16,2),p_recargos money(16,2),p_gastos money(16,2),p_multas money(16,2),p_total money(16,2),p_fecha date,p_foliocpagos varchar(10),p_auth varchar(10))

returning varchar(110),varchar(28);

define linea1 varchar(110);
define resultado varchar(110);
define v_codigo1 varchar(20);
define v1_7 smallint;
define v1_3 smallint;
define v1_1 smallint;
define vt1    int;
define i int;
define fecha int;
define fecha_st char(5);
define fechax date;
define control int;
define v_id int;
define v2_11 smallint;
define v2_13 smallint;
define v2_17 smallint;
define v2_19 smallint;
define v2_23 smallint;
define vt2    int;

--set debug file to "banamex.log";
--   trace on;

let linea1 = substr((p_id_local/10000000),4,6) || '000000';

insert into linea_capturamrc (id,linea,fecha,fecha_vig,id_local,desde,hasta,adeudo,recargos,gastos,multas,total,foliocpagos,auth)
 values (0,linea1,current,null,p_id_local,p_desde,p_hasta,p_adeudo,p_recargos,p_gastos,p_multas,p_total,p_foliocpagos,p_auth);

LET v_id = dbinfo("sqlca.sqlerrd1");
--LET v_id = 999999;

let linea1 = linea1|| substr((v_id/1000000),3,6)  ;

let linea1 = linea1 || "11"; --pago de diversos

---- codifica fecha
-- let fechax = TO_DATE("26/02/2010", "%d/%m/%iY");
let fechax = p_fecha;

--let fecha = ((year(fechax) - 1988) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1);
--let linea1 = linea1 || fecha;
let fecha = (((year(fechax) - 2013) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1)) + 10000;  -- se modifica el a�o base a 2013
let fecha_st = '' || fecha;

let linea1 = linea1 || fecha_st[2,5];

------digito verificador de importe
let v_codigo1 = trunc(p_total*100) ;
let vt1 = 0;

for i =   length(v_codigo1) to 1 step -3
  let v1_7 = 0;
  let v1_3 = 0;
  let v1_1 = 0;

  if i >= 1 then
     let v1_7 = substr(v_codigo1,i , 1)  * 7;
  end if;
  if i >= 2 then
     let v1_3 = substr(v_codigo1,(i -1) , 1)  * 3;
  end if;
  if i >= 3 then
     let v1_1 = substr(v_codigo1,(i -2), 1)  * 1;
  end if;

  let  vt1 = vt1+ v1_7 + v1_3 + v1_1;

end for;
let vt1 = mod(vt1,10);
let linea1 = linea1 || vt1;

-----controles
let control = 2; ---valida fecha e importe
let linea1 = linea1 || control;

---control global
let vt2 = 0;

for i =   length(linea1) to 1 step -5
  let v2_11 = 0;
  let v2_13 = 0;
  let v2_17 = 0;
  let v2_19 = 0;
  let v2_23 = 0;

  if i >= 1 then
     let v2_11 = substr(linea1,i , 1)  * 11;
  end if;
  if i >= 2 then
     let v2_13 = substr(linea1,(i -1) , 1)  * 13;
  end if;
  if i >= 3 then
     let v2_17 = substr(linea1,(i -2), 1)  * 17;
  end if;
  if i >= 4 then
     let v2_19 = substr(linea1,(i -3), 1)  * 19;
  end if;  
  if i >= 5 then
     let v2_23 = substr(linea1,(i -4), 1)  * 23;
  end if;
  let  vt2 = vt2+ v2_11 + v2_13 + v2_17 + v2_19 + v2_23;

end for;
let vt2 = mod(vt2,97) +1;
if vt2 < 10 then
   let linea1 = linea1 || "0" || vt2;
else
   let linea1 = linea1 || vt2;
end if;
-----divide la linea en grupos de cuatro caracteres
let resultado = "";

for i = 1 to length(linea1) step 4
   let resultado = resultado || substr(linea1,i , 4) || "   ";
end for;

--trace off;
let resultado = resultado || "     " || p_total;

update linea_capturamrc set linea = linea1, fecha_vig = fechax where id = v_id;

return resultado,linea1;

end procedure;

CREATE PROCEDURE "informix".linea_cargaavaluos(
    p_linea VARCHAR(50),
    p_recaud INT,
    p_fecha_pagobco DATE,
    P_fecha_dispercion date,
    p_pagado MONEY(16,2),
    p_forma_carga CHAR(1),
    p_bco_recibo VARCHAR(100),
    p_bco_suc VARCHAR(30),
    p_bco_caj VARCHAR(30),
    p_bco_oper VARCHAR(30),
    p_bco_lineatxt VARCHAR(255),
    p_usuario CHAR(8)
)
--** Carga de la linea de captura ya sea por banco o de forma individual por cajero en recaudadoras
--** p_recaud es el numero de banco que se le asigno en C_recaud 100-119
--** Forma de carga C=Cajas Recaudadora, A=Archivo Banco
--** p_bco_recibo,p_bco_suc,p_bco_caj,p_bco_oper datos de recibo bancario si cuenta con ellos o vacios
--** p_bco_lineatxt es la linea completa del archivo, vacio se es por caja
--** ESTATUS para linea_pago C=carga, A=aplicado, N=conciliado sin error, D=diferencia en importes 
returning int,varchar(200);
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_id int;
define v_linea VARCHAR(50);
define v_id_linea int;
define v_folio int;
define v_foliotrans int;
define v_modulo int;
define v_id_cont int;
define v_estatus char(1);
define v_fecha_pago date;
define v_fecha_impresion datetime year to second;
define v_importe money(16,2);
define v_difimp money(16,2);
define v_cvepago char(1);
define v_importe_conc money(16,2);
define v_fecha_concilia datetime year to second;
define v_recppag  money(16,2);
define v_imppag  money(16,2);
define v_multa  money(16,2);
define v_gasto money(16,2);
define v_axodesde int;
define v_axohasta int;
define v_bimdesde int;
define v_bimhasta int;
define v_lrecargos  money(16,2);
define v_limpuestos  money(16,2);
define v_lmultas  money(16,2);
define v_lgastos money(16,2);
define v_clavepago int;
define v_folioanun int;
define v_impformas  money(16,2);

define v_difimpl money(16,2);
define v_difimpp money(16,2);
define v_contador integer;
define v_rowid integer;
define v_fec_recibo date;
define v_operacion integer;

--set debug file to "lineacarga.log";
--   trace on;
--** Obtener datos de la linea de captura
--3538 4610 9610 0000 0101 8512 1278 '0000070000000000011285116291'
--select * from linea_capturadiv where trim(linea) = trim('0000070000000000011285116291')

let v_modulo = substr(p_linea,19,2)*1;
let v_difimp = 0;
let v_difimpl = 0;
let v_difimpp = 0;
let v_importe = p_pagado;
------------------------------------------------------------------------------------------------------------------
if v_modulo = 49 then
   let v_estatus = "";
   
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pagobco;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pagobco,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliaciada y su estatus
 -- select * from linea_pagos
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea=p_linea and modulo = v_modulo) then
      select id,estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pagobco
	      and linea=p_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE AVALUOS YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE AVALUOS YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE AVALUOS YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE AVALUOS ESTA CONCILIADA";
         return estatus,mensaje;
      end if;

	 update  linea_pagos set
     			pagado= p_pagado,
		        adeudo= v_importe,
     			diferencia= (v_importe - p_pagado),
     			bco_recibo= p_bco_recibo,
     			bco_suc= p_bco_suc ,
     			bco_caj= p_bco_caj,
     			bco_oper= p_bco_oper ,
     			bco_lineatxt= p_bco_lineatxt ,
     			estatus=v_estatus ,
		        fecha_concilia = v_fecha_concilia,
		        usuario=p_usuario
	 where id = v_id;
       select count(operacion) into v_contador from ta_12_recibos 
       where fecha = p_fecha_pagobco and caja = 'I4' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
    if v_contador = 1 then 
       select rowid , fecha , operacion  into v_rowid , v_fec_recibo , v_operacion from ta_12_recibos 
       where fec_pagobco = p_fecha_pagobco and caja = 'I4' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
       update linea_pagos  set  fecha_pago = v_fec_recibo , id_rec = 1 , caja = 'I4' , operacion = v_operacion where id = v_id;
       update ta_12_recibos set grupo = 12549 , fec_pagobco = P_fecha_dispercion  where rowid = v_rowid and foliorecibo is null;
       let estatus = 0 ;
       let mensaje = 'Solo un resgistro conciliado';
   end if;
if v_contador > 1 then 
       select rowid , fecha , operacion  into v_rowid , v_fec_recibo , v_operacion from ta_12_recibos 
       where fec_pagobco = p_fecha_pagobco and caja = 'I4' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
       update ta_12_recibos set grupo = 0 , fec_pagobco = P_fecha_dispercion  where fec_pagobco = p_fecha_pagobco and caja = 'I6' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
       let estatus = 1 ;
       let mensaje = 'Registros duplicados';
   end if;
   if v_contador = 0 then 
       let estatus = 2 ;
       let mensaje = 'No hay registro en ingreso';
   end if;

         return estatus,mensaje;
    

   else --si no esta cargada la linea de captura en pagos
    
     Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,0 ,v_modulo ,p_recaud ,p_fecha_pagobco ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,null ,null ,p_bco_recibo ,p_bco_suc ,p_bco_caj ,p_bco_oper ,p_bco_lineatxt ,v_estatus,0 ,null,0 ,"" ,0 ,p_usuario);
     LET v_id = dbinfo("sqlca.sqlerrd1");
    -- validar si existe registro en ta_12_recibos para terminar la concilicion inicial

       select count(operacion) into v_contador from ta_12_recibos 
       where fecha = p_fecha_pagobco and caja = 'I4' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
    if v_contador = 1 then 
       select rowid , fecha , operacion  into v_rowid , v_fec_recibo , v_operacion from ta_12_recibos 
       where fec_pagobco = p_fecha_pagobco and caja = 'I4' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
       update linea_pagos  set  fecha_pago = v_fec_recibo , id_rec = 1 , caja = 'I4' , operacion = v_operacion where id = v_id;
       update ta_12_recibos set grupo = 12549 , fec_pagobco = P_fecha_dispercion  where rowid = v_rowid and foliorecibo is null;
       let estatus = 0 ;
       let mensaje = 'Solo un resgistro conciliado';
   end if;
if v_contador > 1 then 
       select rowid , fecha , operacion  into v_rowid , v_fec_recibo , v_operacion from ta_12_recibos 
       where fec_pagobco = p_fecha_pagobco and caja = 'I4' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
       update ta_12_recibos set grupo = 0 , fec_pagobco = P_fecha_dispercion  where fec_pagobco = p_fecha_pagobco and caja = 'I6' and cvepago = 'P' and kio_num_terceros = trim(p_linea);
       let estatus = 1 ;
       let mensaje = 'Registros duplicados';
   end if;
   if v_contador = 0 then 
       let estatus = 2 ;
       let mensaje = 'No hay registro en ingreso';
   end if;





         return estatus,mensaje;
   end if;--no existe linea captura en pagos
end if; --modulo 12

--trace off;
end procedure;

CREATE PROCEDURE "informix".kio_13_pago(
    		parcontrol    integer,
                parImpCertificado money(15,2),
    		parAxohasta  	smallint,
    		parKiosco	integer,
 -- valores para captar otros datos.   
             par_nombre varchar(60),
                par_domicilio varchar(60),
                par_correo    VARCHAR(30),
                par_telefono VARCHAR(18),
                parparentesco char(25),
-- valores si paga con tarjeta.
                parTarBanco   int, 
                partarconfir  int,
                partartarjeta varchar(30), 
                partartipo    int
        )
		returning smallint , char(2), integer, char(28), int , char(50);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;

define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define v_concrecibo char(60);
define v_concelargo char(255);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_metros dec(5,3);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define v_totim money(15,2);
define v_totre money(15,2);
define v_totdi money(15,2);
define v_totdr money(15,2);
define xresu int;
define xmensa char(30);


define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_clase SMALLINT;
define  v_clase_alfa VARCHAR(10);
define  v_seccion SMALLINT;
define  v_seccion_alfa VARCHAR(10);
define  v_linea SMALLINT;
define  v_linea_alfa VARCHAR(20);
define  v_linea100 VARCHAR(100);
define  v_linea28 VARCHAR(28);
define  v_fosa SMALLINT;
define  v_fosa_alfa VARCHAR(20);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define v_axof int;
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_reg_cem varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_tipodesc VARCHAR(10);
define  v_nomcem VARCHAR(60);
define rlinea integer ;
define xcuenta integer;
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_axohasta    integer;
define  v_obs varchar(60);
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define vcvepago int;
define v_ctaaplic int;

let varcvepago = 0;
let v_mes=month(today);

--set debug file to "kio13pago.log";
--trace on;
 if parAxohasta = 0 then
    let parAxohasta = year(today);
 end if;

 -- Leer datos del Cementerio
   select control_rcm, cementerio, cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
          clase, clase_alfa,seccion, seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
          ,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,metros,
        case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
   end
   into v_control, v_cementerio, v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
   ,v_axo_pagado,v_metros,v_nombre,v_ubicacion, v_colonia ,vpar_metros,v_tipodesc
   from ta_13_datosrcm where control_rcm=parcontrol;
---Para calcular el importe total
select  nombre  into v_nomcem from tc_13_cementerios where cementerio = v_cementerio;
select max(axo_adeudo) into v_axohasta from ta_13_adeudosrcm where control_rcm = v_control and vigencia = 'V';

    if parAxohasta < v_axohasta then
       let v_axohasta = paraxohasta;
    end if;
 
    if (v_axo_pagado + 1) < (year(today) - 5) then
        let v_axodesde =(year(today) - 5);
    else
        let v_axodesde = v_axo_pagado + 1;
    end if;

let v_imptot = 0;
let v_desctot  = 0;
let  v_totim=0;
let  v_totre=0;
let  v_totdi=0;
let  v_totdr=0;
foreach 
select b.axo_adeudo,nvl(b.importe,0),nvl(b.importe_recargos,0),d.axo_descto,nvl(d.descuento,0),nvl(b.descto_impote,0), 
           nvl(b.descto_recargos,0)
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d
           where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axohasta
           order by 1
    let v_obs='.';
    let v_desctot = 0;
    let v_desctotre = 0;
    if  v_impdesc>0 then
           let v_obs='Desc Pensionado 50%';
    end if;
     --se aplica descuento de pesionado
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
     if  v_impdesc=0 then
           let v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
           let v_obs=v_obs||' Incluye 10% Desc por pronto pago ';
     end if;
     end if;
     let v_desctot  =  v_impdesc;
     let v_desctotre  =   v_recardesc;
     let v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) ; 
     let v_totim = (v_totim + vpar_impte); 
     let v_totre = (v_totre + vpar_recar); 
     let v_totdi = (v_totdi + v_desctot); 
     let v_totdr = (v_totdr + v_desctotre); 


end foreach;
if v_totim > 0 then

let v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || v_axohasta;
let v_concrecibo = 'MANT. CEMENTERIO '|| v_nomcem || ' PERIODO '||  v_axodesde || ' - ' || v_axohasta || ' DE ' ||v_reg_cem ;
let v_concelargo = 'MANT. CEMENTERIO '|| v_nomcem || ' PERIODO '||  v_axodesde || ' - ' || v_axohasta || ' DE ' || v_metros || ' MTS. ';
let v_concelargo = trim(v_concelargo) || ' DE '|| v_clase ||' CLASE ' || v_clase_alfa || ' SECC. '|| v_seccion || ' ' || v_seccion_alfa || 'LINEA ' ||v_linea || ' ' || v_linea_alfa || ' FOSA ' || v_fosa;

--
  select id_rec , caja  into varrec , varcaja
  
  from ta12_operacKiosco
  where id_usuario = parKiosco; 
  
  select nvl(operacion,0) + 1
		into varOperacion 
		from ta12_operacKiosco
		where 	id_rec=varrec and
			caja=varCaja and
			id_usuario=parKiosco;

  
--  id_regmodulo INT,    id_rec_cta SMALLINT,    regmunur CHAR(1),    mesdesde SMALLINT,    axodesde SMALLINT,
--  meshasta SMALLINT,    axohasta SMALLINT,    nombre VARCHAR(60),    domicilio VARCHAR(60),    concepto VARCHAR(60),
--  rfcini CHAR(3),    rfcnumero INT,    rfccolonia SMALLINT,       axofolio INT,    id_usuario INT not null,
--  fecha_act ,  descripcion VARCHAR(255), lugar_pago INT default 0, kio_trans INT default 0, kio_num_terceros VARCHAR(30),
  
    insert into ta_12_recibos (fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, id_regmodulo ,id_rec_cta , mesdesde  ,
         axodesde, meshasta, axohasta, nombre,domicilio, concepto ,rfcini,rfcnumero,rfccolonia, axofolio ,
          id_usuario ,  fecha_act, descripcion , fec_pagobco) 
         values( today, varrec, varCaja, varOperacion, parImpCertificado,'P', 13,v_control,0,1,
      v_axodesde, 12,v_axohasta , v_nombre, v_ubicacion,  v_concrecibo,'ID',v_control , 0,0   ,
      parKiosco, current, v_concelargo , today);

   
	update	ta12_operacKiosco set operacion= varOperacion
		where id_rec=varrec and caja=varCaja and id_usuario=parKiosco;
	

execute PROCEDURE linea_capturadiv(varoperacion, parKiosco, parImpCertificado ,today ) into
 v_linea100, v_linea28;
  if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today, varrec, varCaja, varOperacion , parTarBanco  ,
    partarconfir ,  partartarjeta, parImpCertificado,  partartipo, "");
  end if;
 let rlinea = 1;     
let v_suma =0;

FOREACH
execute procedure  kio13_total( parcontrol , parAxohasta) 
    into v_ob, v_idtrans , v_importe  , v_ctaaplic ,  v_concepto 
if v_ob = 'D' then 
    insert into ta_12_recibosdet
          (fecha ,id_rec , caja   , operacion   ,linea ,descripcion , cuenta  ,importe )
    values(today ,varrec ,varcaja ,varoperacion ,rlinea ,v_concepto  ,v_ctaaplic ,v_importe );
 
  end if;
       let rlinea = rlinea +1 ;

if v_ob = 'T' then 
   let v_suma = v_importe;
end if;
end FOREACH;
--Cementerio Actualizar pago
  let us = 'Kiosco ' || parkiosco;
let v_axof=0;

   SELECT axofin
   into  v_axof
   FROM ta_13_descrec where id_folio =parcontrol and vigencia='V';

  INSERT INTO ta_13_pagosrcm  VALUES(today, varrec, varCaja, varOperacion, 0, v_control,
              v_cementerio, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, v_fosa, v_fosa_alfa,
              v_axodesde, v_axohasta, (v_totim - v_totdi), (v_totre-v_totdr), 'A', parKiosco, today);

         --     v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa

   let vcvepago=dbinfo("sqlca.sqlerrd1");

   update ta_13_adeudosrcm set  vigencia='P', id_pago=vcvepago
     where control_rcm=v_control and axo_adeudo between v_axodesde and v_axohasta and vigencia='V';

 if v_axohasta>=v_axof then
    update ta_13_descrec
     set vigencia='P', fec_pag=today, id_rec=varrec, caja=varCaja, operac=varOperacion
    where id_folio =v_control and vigencia='V';
   end if;

    
    update ta_13_datosrcm set axo_pagado=v_axohasta where control_rcm=v_control;
 
    update ta_13_descpens set vigencia='P' where control_rcm=v_control and axo_descto between v_axodesde and v_axohasta and vigencia='V';
   execute procedure spd_13_insextra(v_control, par_nombre , par_domicilio ,par_correo,
                   par_telefono , parparentesco) into xresu , xmensa;

   
return varrec, varcaja, varOperacion , v_linea28,0,'PAGO EFECTUADO';
else
return 0,'', 0 , '',-1,'NO TIENE ADEUDO PARA ESTE PERIODO';
end if;
--trace off;
end procedure;

CREATE PROCEDURE "informix".spfacele_serie_folio_egreso( p_operacion integer , p_recibo varchar(10) , p_rfc varchar(13) , p_caja varchar(13) , p_lugar varchar(20),p_tipo char(1))
returning varchar(3) as serie , integer as folio , varchar(19) as fec_hora_solic;
define v_folio integer;
define v_serie  char(3);
define v_letras char(2); 
define v_no_axo char(2);
define v_l_axo char(4);
define v_contar int;
define v_contar2 int;
define v_fec_hora_solic varchar(19);


let v_l_axo = to_char(year(today));
let v_no_axo = v_l_axo[3,4];
-- verificar que el recibo no exista
   Select count(operacion) into v_contar  from ta_12_fact_egreso
   where operacion = p_operacion and recibo = p_recibo and can_fecha is null;
   if v_contar > 1 then
    return '000' , 0 ,'';
   end if;
-- determinar la serie dependiendo de la caja donde se cobro. y el a�o de expedicion.
if v_contar = 0 then
      let v_serie = 'E' || v_no_axo;
   
      select folio into v_folio from ta_12_ctrol_folio_fis where serie = v_serie ;
      let v_folio = v_folio + 1;
 
 -- select  to_char(extend (today, year to day)) from parametros

  let v_fec_hora_solic =  replace( (to_char(extend (today, year to day))) ||'T'|| (to_char(extend (current, hour to second),'%H:%M:%S')) ,' 00:00:00','' );
  
 
   insert into ta_12_fact_egreso (operacion , recibo ,tipo, fecha_solicitud , fec_hora_solic,  serie, folio , RFC , usr_alta)
          values( p_operacion , p_recibo , p_tipo, today , v_fec_hora_solic , v_serie, v_folio, p_rfc , user);
  
  update ta_12_ctrol_folio_fis set folio = v_folio , fecha = today where serie = v_serie ;
     return v_serie , v_folio , v_fec_hora_solic ;
end if;

if v_contar = 1 then 
   Select count(operacion) into v_contar2  from ta_12_fact_egreso
   where operacion = p_operacion and recibo = p_recibo and can_fecha is null and nocertificado is null;
    if v_contar2 = 1 then
       select serie  , folio  , fec_hora_solic 
        into  v_serie , v_folio , v_fec_hora_solic 
        from  ta_12_fact_egreso
        where operacion = p_operacion and recibo = p_recibo and can_fecha is null and nocertificado is null;
     return v_serie , v_folio , v_fec_hora_solic ;
    else
     return '000' , 0 ,'';

    end if; 
      
   
end if;



end procedure;

create PROCEDURE "informix".sp_fe_timbre33egreso(
    p_operacion int,
    p_recibo varCHAR(8)
   )

returning 
 VARCHAR(19)  as fec_hora_solic ,
 DATE         as fecha_solicitud ,
 VARCHAR(10)  as serie,  
 int          as folio,
 VARCHAR(100) as nocertificado ,
 varchar(255) as sellocfd_1 ,
 varchar(255) as sellocfd_2 ,
 VARCHAR(20)  as fechatimbrado,
 VARCHAR(100) as uuid ,
 VARCHAR(100) as nocertificadosat ,
 varchar(255) as sellosat_1,
 varchar(255) as sellosat_2 , 
 varchar(14)  as RFC,
 decimal(15,2) as importe, 
 char(3) as uso_cfdi, 
 integer as operacion, varchar(100) as uuid_global;
define v_fec_hora_solic VARCHAR(19);
define v_fecha_solicitud DATE;
define v_serie VARCHAR(10);
define v_folio INT;
define v_nocertificado VARCHAR(100);
define v_sellocfd_1 varchar(255);
define v_sellocfd_2 varchar(255);
define v_fechatimbrado VARCHAR(20);
define v_uuid VARCHAR(100);
define v_uuid_global varchar(100);
define v_nocertificadosat varchar(100);
define v_sellosat_1 varchar(255);
define v_sellosat_2 varchar(255);
define v_rfc  varchar(14);
define v_importe decimal(15,2);
define v_operacion integer;
define v_uso_cfdi char(3);

select fec_hora_solic ,
    fecha_solicitud ,
    serie,
    folio ,
    nocertificado,
     SUBSTRB(sellocfd,0,254) ,
     SUBSTRB(sellocfd,255,254) ,
    fechatimbrado,
    uuid,
    nocertificadosat ,
     SUBSTRB(sellosat,0,254) ,
     SUBSTRB(sellosat,255,254), rfc , importe , operacion , uuid_global
     
into
    v_fec_hora_solic ,
    v_fecha_solicitud ,
    v_serie,
    v_folio ,
    v_nocertificado ,
   
    v_sellocfd_1,
    v_sellocfd_2 ,
    v_fechatimbrado,
    v_uuid,
    v_nocertificadosat ,
    v_sellosat_1 ,
     v_sellosat_2 , v_rfc , v_importe , v_operacion , v_uuid_global
    from ta_12_fact_egreso where operacion = p_operacion and recibo = p_recibo and can_fecha is null;
   
if v_folio is null then
    return '' , null , '', 0 , '','' , '' ,'', '', '' , '','' ,'' , 0 , '' , 0 , '' ;
else
    let v_uso_cfdi = 'P1';
   
    return v_fec_hora_solic , v_fecha_solicitud , v_serie, v_folio , v_nocertificado ,
    v_sellocfd_1, v_sellocfd_2 , v_fechatimbrado, v_uuid,  v_nocertificadosat , v_sellosat_1, v_sellosat_2 , v_rfc , v_importe , v_uso_cfdi , v_operacion , v_uuid_global ;
end if
--trace off;
end procedure;

CREATE PROCEDURE "informix".kio_pagodiverso3ros_avar(
    		parnumDiv  int,   --  549 Avaluos 
                parReferencia varchar(28),
                parnombre char(60),
                parRFC varchar(13),
                pardomicilio char(60),
                parImpCertificado money(15,2),
    		parLugarpago	integer,
                parconcepto      integer,   -- 228 ,229 , 230
                pardescripcion   varchar(80), 
                parfec_pagobco   date
               
        )
		returning date as fecha_reg , smallint as reca , char(2) as caja , integer as Operacion, char(28) as Linea , date as fecha_pagobco ;
-- parextra3   para registro civil es la cantidad de anotaciones marginales.


define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define v_cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_orden int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);define v_importex  money(15,2) ;
define v_hora datetime hour to minute;
define  v_linea100 varchar(110);
define v_linea28 varchar(28);
define v_id int;
define v_bco int;
define v_contrato int; 
define v_long int;
define v_contratost char(8);
define v_opcion int;
define res_fecha date ;
define res_reca int;
define res_caja char(2);
define res_operacion int; 
define res_pagobco date;
define res_error int;
--set debug file to "pagokioDIV.TXT";
--trace on;
let v_opcion = 0;

   if parnombre = '' then
      return today , 0, '', 0 , '' , today;
   end if;


 let parnombre = REPLACE(parnombre, '�?', '�');
-- 
if v_opcion = 1 then
       return today , 0, '', 0 , '' , today;
end if;
 -- select * from ta_12_recibos where caja = 'I1'
 -- select * from catastro_gdl:c_recaud
 --  update ta12_operacKiosco set id_usuario = 549 where rowid = 267

 -- select rowid ,* from ta12_operacKiosco 
--  verificar si existe la operacion ya actualizada.
select count(*) into
   res_error
 from ta_12_recibos where caja = 'I4' and kio_num_terceros = parReferencia and cvepago = 'P' ;
if res_error = 1 then
--'0451000009400450004919557231'

select fecha , id_rec , caja , operacion , fec_pagobco into
res_fecha , res_reca , res_caja ,   res_operacion , res_pagobco 
 from ta_12_recibos where caja = 'I4' and kio_num_terceros = parReferencia and cvepago = 'P';

  return res_fecha , res_reca , res_caja ,res_operacion , parReferencia , res_pagobco;
  
end if;

if res_error > 1 then
  return today , 0 , '' , 0, 'Pagos duplicados verificar con ingresos' , today;
end if;
if res_error = 0 then
   select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parnumDiv; 
 if parnumdiv = 549 then
    let v_concepto = parRFC ||'-Pago AVALUOS';
    let v_bco = 102; -- bbva
 end if; 

--select * from ta12_operacKiosco where id_rec = 1 and caja = 'I4'


   select nvl(operacion,0) + 1
		into varOperacion 
		from ta12_operacKiosco
		where 	id_rec=varrec and
			caja=varcaja and
			id_usuario=549;
  insert into ta_12_recibos (fecha,
    id_rec ,
    caja ,
    operacion ,
    importe,
    cvepago ,
    id_modulo,
    id_regmodulo,
    id_rec_cta,
    regmunur ,
    mesdesde,
    axodesde ,
    meshasta ,
    axohasta ,
    nombre ,
    domicilio ,
    concepto,
    rfcini ,
    rfcnumero,
    rfccolonia ,
    obra ,
    axofolio ,
    id_usuario ,
    fecha_act ,
    descripcion, lugar_pago,kio_num_terceros,grupo ) values(
    		today,
    		varrec,
    		varcaja,
    		varOperacion,
    		parImpCertificado,
    		'P',
    		12,
    		parnumDiv,
    		0,
    		0,
    		1,
    		0,
    		12,
    		0,
    		parNombre,
    		parDomicilio,
    		v_concepto,
    		'',
    		0,
    		0,
		0,
		0,
    		542,
		current, 
                pardescripcion, 102 ,parREFERENCIA, 12549 );


	update	ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varrec and
			caja=varcaja and
			id_usuario=549;
	
  


-- se le quita la fec_pagobco  por que no se puede realizar la conciliacion directa, 
-- se requeiere empatar el archivo entregado por el banco.

-- let varoperacion = spoperacion;
              
   let linea = 1;     


               -- para AVALUOS pago electronico
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 320300000 , parImpCertificado );
   
 -- cta aplic  avaluos    320300000

   let v_linea28 = parReferencia;
  return today , varrec, varcaja, varoperacion , v_linea28  , parfec_pagobco;
  

end if;     

--trace off;
end procedure;

create function "pgcabrer".fn_getadeinfraccion(ffolio int,finf int,faxo int,faxoh int,ffec date,fplaca varchar(7),fcved int,fcveh int,fopc char(1))
returning   money(16,2) as adeudo;

define v_adeudo money(16,2);

if fopc='F' then
select nvl((tarifa+costo_fijo01),0) into v_adeudo from dbestacion:ta14_tarifas 
where num_clave=finf
and (ffec between fecha_inicial and fecha_fin);
end if;

if fopc='A' then 
   if fcved=0 then
      select nvl(sum(b.tarifa+b.costo_fijo01),0) into v_adeudo from dbestacion:ta14_folios_adeudo a, dbestacion:ta14_tarifas b 
      where (a.axo between faxo and faxoh) 
      and a.placa=fplaca and b.num_clave=a.infraccion 
      and (a.fecha_folio between b.fecha_inicial and b.fecha_fin);
   else
      select nvl(sum(b.tarifa+b.costo_fijo01),0) into v_adeudo from dbestacion:ta14_folios_adeudo a, dbestacion:ta14_tarifas b 
      where (a.axo between faxo and faxoh) and (a.infraccion between fcved and fcveh)   
      and a.placa=fplaca and b.num_clave=a.infraccion 
      and (a.fecha_folio between b.fecha_inicial and b.fecha_fin);
   end if;
end if;

if fopc='P' then
   if fcved=0 then
      select nvl(sum(b.tarifa+b.costo_fijo01),0) into v_adeudo from dbestacion:ta14_folios_adeudo a, dbestacion:ta14_tarifas b 
      where a.placa=fplaca and (a.axo between faxo and faxoh) and b.num_clave=a.infraccion
      and (a.fecha_folio between b.fecha_inicial and b.fecha_fin);
   else
      select nvl(sum(b.tarifa+b.costo_fijo01),0) into v_adeudo from dbestacion:ta14_folios_adeudo a, dbestacion:ta14_tarifas b 
      where a.placa=fplaca and (a.axo between faxo and faxoh) and (a.infraccion between fcved and fcveh) and b.num_clave=a.infraccion
      and (a.fecha_folio between b.fecha_inicial and b.fecha_fin);
   end if;
end if;

return v_adeudo;
end function;

CREATE PROCEDURE "pgmoreno".sp16_licenciagiro_abc ( par_Opc Char(1), par_LicenciaGiro int, par_Control_Contrato int )
{######################################################################
#  Procedimiento:    sp16_LicenciaGiro_ABC
#  Descripcion:      Interfaz de consulta de Adeudo en ASEO CONTRATADO para el cobro de Licencia de Giro
#
#  Parametros        	par_Opc			=	'A'= ALTA/REACTIVA, 'D'=ELIMINA/DESLIGA, 'C'=CANCELA 
#  de entrada:	par_Control_Contrato	=	Control del Contrato       
#		par_LicenciaGiro     		= 	Numero de Licencia de Giro  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            16 Mayo 2017   
#
#  Llamado por:      Procedimiento Modulo de ASEO CONTRATADO
#  
######################################################################}
                returning  int as status,
                                            varchar(255) as leyenda;
define v_leyenda                                                                        	varchar(255);
define v_status, v_id_usuario, v_numero			Int;
define v_vigencia					char(1);

Let v_numero = 0;
Let v_id_usuario = 0;
Let v_status = 0;
Let v_leyenda = 'NO TIENE ADEUDO';
Let v_vigencia = ' ';

if exists( SELECT *  FROM ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 50;  -- Id Usuario de Gilberto Moreno
end if;

if exists( SELECT * FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro ) then
               SELECT count(*) INTO v_numero FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro;

	if v_numero > 1 then
                  	let v_status                       = -1;
                              	let v_leyenda    = 'LA LICENCIA DE GIRO ESTA LIGADA A MAS DE UN CONTRATO';
	else
		if exists( SELECT * FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro and Control_Contrato = par_Control_Contrato ) then
			SELECT vigencia INTO v_vigencia FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro and Control_Contrato = par_Control_Contrato;
			
			if par_Opc = 'A' then
				if v_vigencia = 'V' then
                  				let v_status                       = 0;
                              				let v_leyenda    = 'LA LICENCIA DE GIRO DEL CONTRATO YA  ESTABA  ACTIVA';
				else
					UPDATE ta_16_Rel_LicGiro SET
						vigencia = 'V'  
					WHERE Num_Licencia = par_LicenciaGiro and Control_Contrato = par_Control_Contrato;
					Insert into ta_16_contratos_h values (0,par_Control_Contrato, 'Sin Documento', 'LICENCIA DE GIRO ' || par_LicenciaGiro || ' REACTIVADA', v_id_usuario, current);
                  				let v_status                       = 1;
                              				let v_leyenda    = 'LA LICENCIA DE GIRO FUE REACTIVADA EN EL CONTRATO';
				end if;
			end if;

			if par_Opc = 'D' then
				DELETE FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro and Control_Contrato = par_Control_Contrato;
				Insert into ta_16_contratos_h values (0,par_Control_Contrato, 'Sin Documento', 'LICENCIA DE GIRO ' || par_LicenciaGiro || ' ELIMINADA/DESLIGADA', v_id_usuario, current);
                  			let v_status                       = 1;
                              			let v_leyenda    = 'LA LICENCIA DE GIRO FUE ELIMINADA/DESLIGADA DEL CONTRATO';
			end if;

			if par_Opc = 'C' then
				if v_vigencia = 'C' then
                  				let v_status                       = 0;
                              				let v_leyenda    = 'LA LICENCIA DE GIRO DEL CONTRATO YA  ESTABA CANCELADA';
				else
					UPDATE ta_16_Rel_LicGiro SET
						vigencia = 'C'  
					WHERE Num_Licencia = par_LicenciaGiro and Control_Contrato = par_Control_Contrato;
					Insert into ta_16_contratos_h values (0,par_Control_Contrato, 'Sin Documento', 'LICENCIA DE GIRO ' || par_LicenciaGiro || ' CANCELADA', v_id_usuario, current);
                  				let v_status                       = 1;
                              				let v_leyenda    = 'LA LICENCIA DE GIRO FUE CANCELADA';
				end if;
			end if;
		else
                              		let v_status                       = -1;
                              		let v_leyenda    = 'LA LICENCIA DE GIRO ESTA LIGADA A OTRO CONTRATO';
		end if;
               	end if;
else
	if par_Opc = 'A' then
		INSERT INTO ta_16_Rel_LicGiro values ( 0, par_LicenciaGiro, par_Control_Contrato, 'V' );
		Insert into ta_16_contratos_h values (0,par_Control_Contrato, 'Sin Documento', 'LICENCIA DE GIRO ' || par_LicenciaGiro || ' LIGADA', v_id_usuario, current);
                  	let v_status                       = 1;
                              	let v_leyenda    = 'LA LICENCIA DE GIRO FUE LIGADA  AL CONTRATO';
	else
                  	let v_status                       = -1;
                              	let v_leyenda    = 'LA LICENCIA DE GIRO NO PUEDE SER ELIMINADA/DESLIGADA � CANCELADA PUES NO EXISTE';
	end if;
end if;
               RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".con16_detcont_04b ( p_tipo char(1), pref varchar(20))
{######################################################################
#  Procedimiento:    con16_detcont_04
#  Descripcion:      Interfaz de consulta del Padron de ASEO CONTRATADO en el m�dulo de ModulosGdl
#  Parametros de entrada: p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#                         p_Adeudos  = tipo de adeudo deseado
#                                      'C' THEN  -- CON ADEUDO ALGUNO
#                                      'S' THEN  -- SIN ADEUDO ALGUNO
#                                      'T' THEN  -- TODOS
#                         pref   = Hasta el periodo requerido         ejem: '2013-10'
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            17 Marzo 2015   
#
#  Llamado por:      Procedimiento desde modulo de ASEO CONTRATADO
#  Llama a:          
#  
######################################################################}
    RETURNING CHAR(2) 		as OFNA,
              VARCHAR(20) 	as TIPO_ASEO,
              INTEGER 		as NUM_CONTRATO,
              VARCHAR(200) 	as NOM_EMPRESA,
              VARCHAR(200) 	as DOMICILIO,
              CHAR(2) 		as VIGENCIA,
	      DATE    		as INICIO_OBLIGACION,
	      DATE    		as FECHA_BAJA,
	      DATE    		as PRIMER_ADEUDO,

              Money(12,2) 	as TOTAL_ADEUDOS,
              Money(12,2) 	as TOTAL_RGOS,
              Money(12,2) 	as TOTAL_DSCTO_RGOS,
	      Money(12,2) 	as TOTAL_PAGOS,

	      Money(12,2)	AS MULTAS,
              Money(12,2)	AS DSCTO_MULTAS,
	      Money(12,2)	AS GASTOS,
	      varchar(255)	AS DOCUMENTOS;


  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec      Integer;
  define v_nombre, v_domicilio, v_tipo_aseo                                         varchar(80);
  define v_tipo_recolec                                                             varchar(20);
  define v_sector, v_status_vigencia                                                Char(1);
  define v_fecha_ini, v_fecha_hora_baja, v_fecha_primer_adeudo, v_aso_mes_pago      Date;

  define v_DetFolReq								    varchar(120);
  define v_total_adeudos, v_total_recargos, v_dscto_recargos, v_total_pagos         Money(12,2);
  define v_tot_multas, v_tot_dscto_multas, v_tot_gastos, v_importe_multa, v_importe_gastos Money(12,2);
  define v_porcentaje_multa							    smallint;
  define v_folio_req, v_id_control						    Integer;
  define v_diligencia								    char(1);

  define v_Periodo_CN, v_Periodo_EXE, v_ref					    varchar(7);
  define v_contador, v_axo, v_Mes, v_ctrol_oper, v_FolReq			    Integer;
  define v_importe, v_importe_recargo, v_importe_rec1, v_importe_rec2		    Money(12,2);
  define v_mensaje_proc                                                             varchar(255);

----------------------
Let v_contador = 0;
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_total_adeudos = 0;
LET v_total_recargos= 0;
LET v_dscto_recargos= 0;
LET v_total_pagos   = 0;

Let v_fecha_ini = '';
Let v_fecha_hora_baja = '';
Let v_fecha_primer_adeudo = '';

Let v_ctrol_oper = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;
if trim(pref)='' then
   let v_ref=9999 || '-' || 12;
else
   let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;


FOREACH
	SELECT a.control_contrato, a.num_contrato, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion, 
       	       a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja, a.status_vigencia 
          Into  v_Control, v_Num_Contrato, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec, 
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja, v_status_vigencia

	FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d 
	WHERE b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo
		and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
		and d.ctrol_recolec = a.ctrol_recolec
	Order by a.num_contrato
   
	Let v_tot_multas = 0;
	Let v_tot_dscto_multas = 0;
        Let v_tot_gastos = 0;
	Let v_importe_multa = 0;
	Let v_importe_gastos = 0;
	Let v_FolReq = 0;
	Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
     FOREACH
                Select id_control,   folio,	    diligencia,	  importe_multa,   importe_gastos,   porcentaje_multa
                Into   v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos, v_porcentaje_multa 
                from ta_15_apremios
                     Where modulo = 16  And control_otr = v_Control
                     And vigencia = "1" and clave_practicado = "P"
                     Order By id_control

		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		if v_FolReq > 0 then
		   Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
		else
		   Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
		end if;
     END FOREACH;
		Let v_tot_multas = v_importe_multa;
                if v_porcentaje_multa < 100 then
                	Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                else
                	Let v_tot_dscto_multas = 0;
		end if;

    
     FOREACH
      		Select Year(h.aso_mes_pago), h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago), ctrol_operacion
                  Into v_axo, v_aso_mes_pago, v_importe, v_Mes, v_ctrol_oper 
                From ta_16_pagos H
                  Where H.Control_Contrato = v_Control 
                    and H.aso_mes_pago <= ( v_ref )  and H.Status_Vigencia = 'V'
		    Order By h.aso_mes_pago

                               if v_importe > 0 then
                                  if v_contador = 0 then
				     Let v_fecha_primer_adeudo = v_aso_mes_pago;
				     Let v_contador = v_contador + 1;
				  end if;
				  LET v_total_adeudos = v_total_adeudos + v_importe;

				  if v_ctrol_oper = 6 then
                                  	Select sum(porc_recargo) 
                                  	Into v_Importe_recargo
                                  	From ta_16_recargos 
                                  	Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);
				  else
                                  	Select sum(porc_recargo) 
                                  	Into v_Importe_recargo
                                  	From ta_16_recargos 
                                  	Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);
				  end if;

                                   if v_Importe_recargo > 0 then
                                      LET v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                      LET v_total_recargos = v_total_recargos + v_importe_rec1;

                                      EXECUTE PROCEDURE sp_desctomerc (v_Control, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
								INTO v_importe_rec2, v_mensaje_proc;
                                      if v_importe_rec2 > 0 then
					 LET v_dscto_recargos = v_dscto_recargos + v_importe_rec2;
                                      end if;
                                   end if;
                               end if;
     END FOREACH;
     FOREACH
      		Select sum(h.importe)  Into v_importe
                From ta_16_pagos H
                  Where H.Control_Contrato = v_Control 
                    and H.aso_mes_pago <= ( v_ref )  and H.Status_Vigencia = 'P'

                               if v_importe > 0 then
				  LET v_total_pagos = v_total_pagos + v_importe;
                               end if;
     END FOREACH;

  IF v_total_adeudos <> 0  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia, 
			v_fecha_ini, v_fecha_hora_baja, v_fecha_primer_adeudo, 
			v_total_adeudos, v_total_recargos, v_dscto_recargos, v_total_pagos, 
			v_tot_multas, v_tot_dscto_multas, v_tot_gastos, v_DetFolReq with resume; 
  END IF;

Let v_contador = 0;
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
Let v_fecha_ini = ' ';
Let v_fecha_hora_baja = ' ';
Let v_fecha_primer_adeudo = ' ';

LET v_total_adeudos = 0;
LET v_total_recargos= 0;
LET v_dscto_recargos= 0;
LET v_total_pagos   = 0;

Let v_FolReq = 0;
Let v_tot_multas = 0;
Let v_tot_dscto_multas = 0;
Let v_tot_gastos = 0;
Let v_importe_multa = 0;
Let v_importe_gastos = 0;


END FOREACH;

end procedure;

create procedure "informix".admin_encabezado_kiosco(pcaja char(8),pfecha date,ptipo char(1))
returning       int as interface,
                char(10) as segmento1,
                char(10) as segmento2,
                char(10) as segmento3,
                char(10) as segmento4,
                char(10) as segmento5,
                char(10) as segmento6,
                varchar(250) as descripcionrbo,
                varchar(92) as nombre,
                varchar(80) as calle,
                int as recaudadora,
                int as operacionmpio,
                money(14,2) as importerecibido;

define v_interface,v_rec,v_oper,v_idregmodulo,v_rfcnumero,v_idreccta,v_modulo,v_grupo int;
define v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6 varchar(10);
define v_knterceros varchar(32);
define v_descrbo varchar(250);
define v_nombre varchar(92);
define v_calle varchar(80);
define v_importe money(14,2);
define v_ur char(1);
define v_placa varchar(7);
define v_descrip_corta varchar(15);

let pcaja = upper(pcaja);
let ptipo = upper(ptipo);

if not pcaja='K1' then -- validacion solo de cajas de kiosco e internet
   if not pcaja='K2' then
      if not pcaja='K3' then
         if not pcaja='K4' then
            if not pcaja='K5' then
              if not pcaja='K6' then
               if not pcaja='K7' then
               if not pcaja='K8' then
               if not pcaja='KS' then
                if not pcaja='I1' then 
                  if not pcaja='I2' then 
                    if not pcaja='I3' then 
                      if not pcaja='I4' then 
                       if not pcaja='I6' then 
                      return 0,' ',' ',' ',' ',' ',' ',' ',' ',' ',0,0,0;
                      end if;  end if;
                   end if;
                  end if;
                 end if;
                end if;
               end if;
              end if;
              end if;
            end if;
         end if;      
       end if;
   end if;   
end if;

if ptipo='P' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe, kio_num_terceros ,grupo , nombre[48,57] ,  descripcion[1,14]
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo ,v_nombre,v_calle,v_rec,v_oper,v_importe, v_knterceros ,v_grupo , v_placa , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans=0
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
      let v_descrbo='';
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      else
         let v_descrbo= v_knterceros  || '  ' || v_descrip_corta;
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=upper(v_nombre);
   else 
   if v_modulo = 55 then 
      let v_interface=55;
      let v_descrbo=upper( v_knterceros   || '  ' || v_descrip_corta);
    else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;
 
if ptipo='A' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe, kio_num_terceros ,grupo , nombre[48,57] , descripcion[1,14]
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo ,v_nombre,v_calle,v_rec,v_oper,v_importe, v_knterceros ,v_grupo , v_placa , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans>0
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      else
         let v_descrbo=upper( v_knterceros  || '  ' || v_descrip_corta);
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
  else
 if v_modulo = 55 then 
      let v_interface=55;
      let v_descrbo=upper( v_knterceros  || '  ' || v_descrip_corta);

   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;

if ptipo='T' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe, kio_num_terceros ,grupo , nombre[48,57] , descripcion[1,14]
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo ,v_nombre,v_calle,v_rec,v_oper,v_importe, v_knterceros ,v_grupo , v_placa , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and  fec_pagobco=pfecha and caja=pcaja 
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      else
         let v_descrbo= upper( v_knterceros  || '  ' || v_descrip_corta);
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else
  if v_modulo = 55 then 
      let v_interface=55;
      let v_descrbo=upper( v_knterceros || '  ' || v_descrip_corta);


   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;


end procedure;

create procedure "informix".admin_encabezado_kiosco2a(pcaja char(8),pfecha date,ptipo char(1), pLugarCobroExterno int)
returning       int as interface,
                char(10) as segmento1,
                char(10) as segmento2,
                char(10) as segmento3,
                char(10) as segmento4,
                char(10) as segmento5,
                char(10) as segmento6,
                varchar(250) as descripcionrbo,
                varchar(92) as nombre,
                varchar(80) as calle,
                int as recaudadora,
                int as operacionmpio,
                money(14,2) as importerecibido;

define v_interface,v_rec,v_oper,v_idregmodulo,v_rfcnumero,v_idreccta,v_modulo,v_grupo int;
define v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_knterceros varchar(10);
define v_descrbo varchar(250);
define v_nombre varchar(92);
define v_calle varchar(80);
define v_importe money(14,2);
define v_ur char(1);
define v_placa varchar(7);
define v_axofolio int;

let pcaja = upper(pcaja);
let ptipo = upper(ptipo);
let v_axofolio = 0;

if not pcaja='K1' then -- validacion solo de cajas de kiosco e internet
   if not pcaja='K2' then
      if not pcaja='K3' then
         if not pcaja='K4' then
            if not pcaja='K5' then
              if not pcaja='K6' then
               if not pcaja='K7' then
                if not pcaja='K8' then
              if not pcaja='KS' then
               if not pcaja='I1' then 
                  if not pcaja='I2' then 
                    if not pcaja='I3' then 
                     if not pcaja='I4' then 
                      return 0,' ',' ',' ',' ',' ',' ',' ',' ',' ',0,0,0;
                    end if;
                   end if;
                   end if;
                  end if;
                end if;
               end if;
               end if;
              end if;
            end if;
         end if;      
       end if;
   end if;   
end if;

if ptipo='P' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , axofolio 
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_axofolio
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans=0 
   and lugar_pago = pLugarCobroExterno 
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
      let v_descrbo='';
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
      if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if v_grupo=12533 then
         let v_descrbo='PAGO DE TIANGUIS MODELO';
      end if;
        
      
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=upper(v_nombre);
   else 
   if v_modulo = 48 then 
      let v_interface=10;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;
 
if ptipo='A' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo ,  nombre[48,57] , axofolio
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_axofolio
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans>0 
   and lugar_pago = pLugarCobroExterno 
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if v_grupo=12533 then
         let v_descrbo='PAGO DE TIANGUIS MODELO';
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
   if v_modulo = 48 then 
      let v_interface=10;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
      
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;

if ptipo='T' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , axofolio
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_axofolio
   from ta_12_recibos where cvepago = 'P' and  fec_pagobco=pfecha and caja=pcaja 
   and lugar_pago = pLugarCobroExterno 
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if v_grupo=12533 then
         let v_descrbo='PAGO DE TIANGUIS MODELO';
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
   if v_modulo = 48 then 
      let v_interface=10;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
      

   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;


end procedure;

create procedure "informix".admin_encabezado_kiosco2(pcaja char(8),pfecha date,ptipo char(1), pLugarCobroExterno int)
returning       int as interface,
                char(10) as segmento1,
                char(10) as segmento2,
                char(10) as segmento3,
                char(10) as segmento4,
                char(10) as segmento5,
                char(10) as segmento6,
                varchar(250) as descripcionrbo,
                varchar(92) as nombre,
                varchar(80) as calle,
                int as recaudadora,
                int as operacionmpio,
                money(14,2) as importerecibido;

define v_interface,v_rec,v_oper,v_idregmodulo,v_rfcnumero,v_idreccta,v_modulo,v_grupo int;
define v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_knterceros varchar(10);
define v_descrbo varchar(250);
define v_descrbo1 varchar(250);
define v_nombre varchar(92);
define v_calle varchar(80);
define v_importe money(14,2);
define v_ur char(1);
define v_placa varchar(7);
define v_axofolio int;

let pcaja = upper(pcaja);
let ptipo = upper(ptipo);
let v_axofolio = 0;

if not pcaja='K1' then -- validacion solo de cajas de kiosco e internet
   if not pcaja='K2' then
      if not pcaja='K3' then
         if not pcaja='K4' then
            if not pcaja='K5' then
              if not pcaja='K6' then
               if not pcaja='K7' then
                if not pcaja='K8' then
               if not pcaja='KS' then
               if not pcaja='I1' then 
                  if not pcaja='I2' then 
                    if not pcaja='I3' then 
                      if not pcaja='I4' then
                      return 0,' ',' ',' ',' ',' ',' ',' ',' ',' ',0,0,0;
                   end if 
                   end if;
                  end if; 
                  end if;
                end if;
               end if;
               end if;
              end if;
            end if;
         end if;      
       end if;
   end if;   
end if;

if ptipo='P' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , axofolio 
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_axofolio
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans=0 
   and lugar_pago = pLugarCobroExterno 
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_descrbo1 = v_descrbo;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
      let v_descrbo='';
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
      if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if v_grupo=12533 then
         let v_descrbo='PAGO DE TIANGUIS MODELO -' || v_knterceros[1,7] ;
      end if;
      if v_grupo=12548 then
         let v_descrbo=v_descrbo1;
      end if;  
      
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=upper(v_nombre);
   else 
   if v_modulo = 48 then 
      let v_interface=29;
     -- let v_seg1=v_idreccta;
     -- let v_seg2=v_ur;
     -- let v_seg3=v_idregmodulo;
     -- let v_seg4=v_axofolio;
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;
 
if ptipo='A' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo ,  nombre[48,57] , axofolio
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_axofolio
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans>0 
   and lugar_pago = pLugarCobroExterno 
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_descrbo1 = v_descrbo;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if v_grupo=12533 then
         let v_descrbo='PAGO DE TIANGUIS MODELO -' || v_knterceros[1,7] ;
      end if;
      if v_grupo=12548 then
         let v_descrbo=v_descrbo1;
      end if; 
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
   if v_modulo = 48 then 
      let v_interface=29;
     -- let v_seg1=v_idreccta;
     -- let v_seg2=v_ur;
     -- let v_seg3=v_idregmodulo;
     -- let v_seg4=v_axofolio;
      
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;

if ptipo='T' then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , axofolio
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_axofolio
   from ta_12_recibos where cvepago = 'P' and  fec_pagobco=pfecha and caja=pcaja 
   and lugar_pago = pLugarCobroExterno 
   order by operacion
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_descrbo1 = v_descrbo;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if v_grupo=12533 then
         let v_descrbo='PAGO DE TIANGUIS MODELO -' || v_knterceros[1,7] ;
      end if;
       if v_grupo=12548 then
         let v_descrbo=v_descrbo1;
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
   if v_modulo = 48 then 
      let v_interface=29;
     -- let v_seg1=v_idreccta;
     -- let v_seg2=v_ur;
     -- let v_seg3=v_idregmodulo;
     -- let v_seg4=v_axofolio;
      

   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe with resume;
   end foreach;
end if;


end procedure;

CREATE PROCEDURE "informix".linea_consx(
    p_linea VARCHAR(50)
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);

--****** variables locales
define v_estatus char(1);
define v_fecha_pago date;
define v_id_rec smallint;--
define v_caja char(2);--
define v_operacion int;--
define v_modulo int;
define v_mod int;

let v_mod = substr(p_linea,19,2)*1;

if v_mod = 12 then

   --Verifica que exista la linea de captura en diversos
   if NOT exists (select * from linea_capturadiv where trim(linea) = trim(p_linea)) then --Captura div
         return -1,"LA L�NEA DE CAPTURA DE PAGO DE DIVERSOS NO EXISTE!",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   end if; --Fin Captura div

   --obtener los datos del registro de diversos  
   select fecha, folio, modulo 
   into v_fecha_pago ,v_operacion , v_modulo
   from linea_capturadiv where trim(linea) = trim(p_linea);  

   --obtener los datos de id_recaudadora y caja
   select id_rec , caja  into v_id_rec , v_caja 
   from ta12_operacKiosco where id_usuario = v_modulo;

   if v_fecha_pago is null then
        return -1,"EL RECIBO DE LA L�NEA DE CAPTURA DE PAGO NO HA SIDO PAGADO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
    end if;
 
end if; -- fin v_modulo==12

if v_mod <> 12 then

  -- Verifica que exista la linea de captura en linea pagos
  if NOT exists (select * from linea_pagos where trim(linea) = trim(p_linea)) then --linea_pagos      
      return -1,"LA L�NEA DE CAPTURA DE PAGO NO EXISTE_",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   end if; --Fin linea_pagos



  --obtener los datos del registro de linea_pagos
  foreach
  select estatus,fecha_pago,id_rec,caja,operacion
  into v_estatus,v_fecha_pago,v_id_rec,v_caja,v_operacion
  from linea_pagos 
  where trim(linea) = trim(p_linea) and estatus = "A" and cvepago>0 
  order by id desc
  end foreach;



  if v_estatus <> "A" then
         return -1,"LA L�NEA DE CAPTURA DE PAGO DE DIVERSOS NO HA SIDO APLICADA, PARA PAGO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
        end if;



  if v_fecha_pago is null then
        return -1,"EL RECIBO DE LA L�NEA DE CAPTURA DE PAGO NO HA SIDO PAGADO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
	end if;
end if; -- fin v_mod<>12


--Validar en ta_12_recibos
       if NOT exists (select * from ta_12_recibos where fecha=v_fecha_pago and id_rec = v_id_rec and caja=v_caja 
	and operacion=v_operacion and cvepago="P") then--recibos
	
	return -1,"EL RECIBO NO EXISTE EN EL REGISTRO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos
--SET LOCK MODE TO WAIT;
  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 

  where  fecha=v_fecha_pago and id_rec = v_id_rec and caja=v_caja 
	 and operacion=v_operacion and cvepago="P";

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

	if o_foliorecibo IS NULL then
        return -1,"ESTE PAGO NO HA SIDO PROCESADO POR EL AREA DE BANCOS",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"L�NEA DE CAPTURA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;






end procedure;

CREATE PROCEDURE "informix".linea_cons(
    p_linea VARCHAR(50)
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);

--****** variables locales
define v_estatus char(1);
define v_fecha_pago date;
define v_id_rec smallint;--
define v_caja char(2);--
define v_operacion int;--
define v_modulo int;
define v_mod int;

let v_mod = substr(p_linea,19,2)*1;

if v_mod = 12 then

   --Verifica que exista la linea de captura en diversos
   if NOT exists (select * from linea_capturadiv where trim(linea) = trim(p_linea)) then --Captura div
         return -1,"LA L�NEA DE CAPTURA DE PAGO DE DIVERSOS NO EXISTE!",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   end if; --Fin Captura div

   --obtener los datos del registro de diversos  
   select fecha, folio, modulo 
   into v_fecha_pago ,v_operacion , v_modulo
   from linea_capturadiv where trim(linea) = trim(p_linea);  

   --obtener los datos de id_recaudadora y caja
   select id_rec , caja  into v_id_rec , v_caja 
   from ta12_operacKiosco where id_usuario = v_modulo;

   if v_fecha_pago is null then
        return -1,"EL RECIBO DE LA L�NEA DE CAPTURA DE PAGO NO HA SIDO PAGADO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
    end if;
 
end if; -- fin v_modulo==12

if v_mod <> 12 then

  -- Verifica que exista la linea de captura en linea pagos
  if NOT exists (select * from linea_pagos where trim(linea) = trim(p_linea)) then --linea_pagos      
      return -1,"LA L�NEA DE CAPTURA DE PAGO NO EXISTE_",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   end if; --Fin linea_pagos



  --obtener los datos del registro de linea_pagos
  foreach
  select estatus,fecha_pago,id_rec,caja,operacion
  into v_estatus,v_fecha_pago,v_id_rec,v_caja,v_operacion
  from linea_pagos 
  where trim(linea) = trim(p_linea) and estatus = "A" and cvepago>0 
  order by id desc
  end foreach;



  if v_estatus <> "A" then
         return -1,"LA L�NEA DE CAPTURA DE PAGO DE DIVERSOS NO HA SIDO APLICADA, PARA PAGO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
        end if;



  if v_fecha_pago is null then
        return -1,"EL RECIBO DE LA L�NEA DE CAPTURA DE PAGO NO HA SIDO PAGADO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
	end if;
end if; -- fin v_mod<>12


--Validar en ta_12_recibos
       if NOT exists (select * from ta_12_recibos where fecha=v_fecha_pago and id_rec = v_id_rec and caja=v_caja 
	and operacion=v_operacion and cvepago="P") then--recibos
	
	return -1,"EL RECIBO NO EXISTE EN EL REGISTRO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos
--SET LOCK MODE TO WAIT;
  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 

  where  fecha=v_fecha_pago and id_rec = v_id_rec and caja=v_caja 
	 and operacion=v_operacion and cvepago="P";

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

	if o_foliorecibo IS NULL then
        return -1,"ESTE PAGO NO HA SIDO PROCESADO POR EL AREA DE BANCOS",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"L�NEA DE CAPTURA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;






end procedure;

CREATE PROCEDURE "informix".multasvigdep( )
returning 
int as iddependencia , 
varchar(60) as dependencia,
int as cuantas ,
money(15,2) as calificacion ,  money(15,2) as multa,  
money(15,2) as gastos,  money(15,2) as total ;

-----------Define las variables de retorno----------------
define  v_id_dependencia int;
define v_cuantas int;
define v_dependencia varchar(80); 
define v_calificacion  money(15,2); 
define v_multa money(15,2) ; 
define v_gastos money(15,2); 
define v_total  money(15,2); 

FOREACH

select a.id_dependencia , d.descripcion, count(a.id_multa) ,  sum(a.calificacion) ,sum(a.multa) , 
sum(a.gastos) , sum(a.total)
into 
v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
 from catastro_gdl:multas a, catastro_gdl:c_dependencias d 
 where a.fecha_acta between mdy(10,1,2015) and today 
and a.cvepago is null and a.fecha_cancelacion is null and a.id_prescri is null and a.fec_condonar is null and 
a.id_dependencia = d.id_dependencia
group by 1,2
order by 3 desc


return v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
       with resume;

end FOREACH;
end procedure
;

CREATE PROCEDURE "informix".multaspagdep(opc int )
returning 
int as iddependencia , 
varchar(60) as dependencia,
int as cuantas ,
money(15,2) as calificacion ,  money(15,2) as multa,  
money(15,2) as gastos,  money(15,2) as total ;

-----------Define las variables de retorno----------------
define  v_id_dependencia int;
define v_cuantas int;
define v_dependencia varchar(80); 
define v_calificacion  money(15,2); 
define v_multa money(15,2) ; 
define v_gastos money(15,2); 
define v_total  money(15,2); 
if opc = 1 then
FOREACH

select a.id_dependencia , d.descripcion, count(a.id_multa) ,  sum(a.calificacion) ,sum(a.multa) , 
sum(a.gastos) , sum(a.total)
into v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
 from catastro_gdl:multas a, catastro_gdl:c_dependencias d , catastro_gdl:pagos p 
 where a.fecha_acta between mdy(10,1,2015) and today 
and p.cvepago = a.cvepago and p.fecha  between mdy(10,1,2015) and today and a.fecha_cancelacion is null and  
a.id_dependencia = d.id_dependencia
group by 1,2
order by 3 desc


return v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
       with resume;

end FOREACH;

end if;
if opc = 2 then
FOREACH

select a.id_dependencia , d.descripcion, count(a.id_multa) ,  sum(a.calificacion) ,sum(a.multa) , 
sum(a.gastos) , sum(a.total)
into v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
 from catastro_gdl:multas a, catastro_gdl:c_dependencias d , catastro_gdl:pagos p 
 where a.fecha_acta between mdy(10,1,2015) and today 
and p.cvepago = a.cvepago and p.fecha  between mdy(1,1,year(today)) and today and a.fecha_cancelacion is null and  
a.id_dependencia = d.id_dependencia
group by 1,2
order by 3 desc


return v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
       with resume;

end FOREACH;

end if;
if opc = 3 then
FOREACH

select a.id_dependencia , d.descripcion, count(a.id_multa) ,  sum(a.calificacion) ,sum(a.multa) , 
sum(a.gastos) , sum(a.total)
into v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
 from catastro_gdl:multas a, catastro_gdl:c_dependencias d , catastro_gdl:pagos p 
 where a.fecha_acta < mdy(10,1,2015) 
and p.cvepago = a.cvepago and p.fecha  between mdy(1,1,year(today)) and today and a.fecha_cancelacion is null and  
a.id_dependencia = d.id_dependencia
group by 1,2
order by 3 desc
return v_id_dependencia, v_dependencia , v_cuantas ,  v_calificacion , v_multa, v_gastos, v_total 
       with resume;

end FOREACH;

end if;
end procedure
;

CREATE PROCEDURE "informix".spfacele_serie_folio( p_operacion integer , p_recibo varchar(10) , p_rfc varchar(13) , p_caja varchar(13) , p_lugar varchar(20),p_tipo char(1))
returning varchar(3) as serie , integer as folio , varchar(19) as fec_hora_solic;
define v_folio integer;
define v_serie  char(3);
define v_letras char(2); 
define v_no_axo char(2);
define v_l_axo char(4);
define v_contar int;
define v_fec_hora_solic varchar(19);


let v_l_axo = to_char(year(today));
let v_no_axo = v_l_axo[3,4];
-- verificar que el recibo no exista
   Select count(operacion) into v_contar  from ta_12_fact_elec
   where operacion = p_operacion and recibo = p_recibo and can_fecha is null;

   if v_contar > 1 then
     return '000' , 0 ,'';
   end if;

   if v_contar = 1 then
     
         Select serie , folio  into v_serie , v_folio  from ta_12_fact_elec
          where operacion = p_operacion and recibo = p_recibo and can_fecha is null and cadena is null and timbrado is null;
      if v_serie is null then
          return '000' , 0 ,'';
       
      else
        let v_fec_hora_solic =  replace( (to_char(extend (today, year to day))) ||'T'|| (to_char(extend (current, hour to second),'%H:%M:%S')) ,' 00:00:00','' );
        return v_serie , v_folio , v_fec_hora_solic ; 
    
     end if;
  end if;


 if v_contar = 0 then
-- determinar la serie dependiendo de la caja donde se cobro. y el a�o de expedicion.
-- B15    bancos;
-- I15    internet ;
-- K15    kioscos; 
-- R15    recaudadoras ;
     let v_letras = p_caja[1,2];  
     if  p_lugar = ''  then 
      let v_serie = 'R' || v_no_axo;
   end if;
     if  p_lugar <> ''  then 
      let v_serie = 'B' || v_no_axo;
   end if;

   if (v_letras = 'K1') or (v_letras = 'K2') or (v_letras = 'K3') or (v_letras = 'K4') or (v_letras = 'K5') then
       let v_serie ='K' || v_no_axo;
   end if;
   if (v_letras = 'I1')  then
       let v_serie ='I' || v_no_axo;
   end if;
   
      select folio into v_folio from ta_12_ctrol_folio_fis where serie = v_serie ;
      let v_folio = v_folio + 1;
 
 -- select  to_char(extend (today, year to day)) from parametros

  let v_fec_hora_solic =  replace( (to_char(extend (today, year to day))) ||'T'|| (to_char(extend (current, hour to second),'%H:%M:%S')) ,' 00:00:00','' );
  
 
   insert into ta_12_fact_elec (operacion , recibo ,tipo, fecha_solicitud , fec_hora_solic,  serie, folio , RFC , usr_alta)
          values( p_operacion , p_recibo , p_tipo, today , v_fec_hora_solic , v_serie, v_folio, p_rfc , user);
  
  update ta_12_ctrol_folio_fis set folio = v_folio , fecha = today where serie = v_serie ;
     return v_serie , v_folio , v_fec_hora_solic ;
end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_ind_aseo_contratado_01()
{######################################################################
#  Procedimiento:    sp16_ind_aseo_contratado_01
#  Descripcion:      Interfaz de consulta de ASEO CONTRATADO para INDICADORES
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento vencidos dentro de ASEO CONTRATADO
#  Llama a:          
#  
######################################################################}
                returning char(50) as concepto,
                               integer as cant_contratos,
                               Money(12,2) as importe_derechos;
               

define v_contador, v_control_contrato					Integer;
define v_sum_importe_p, v_sum_importe_CN, v_sum_importe_EXE, v_TOT_importe		Money(12,2);
define v_Periodo_CN, v_Periodo_EXE					VarChar(7);
  
Let v_contador = 0;
Let v_control_contrato = 0;
Let v_sum_importe_CN = 0;
Let v_sum_importe_EXE = 0;
Let v_sum_importe_p = 0;
Let v_tot_importe = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

foreach
SELECT control_contrato INTO v_control_contrato FROM ta_16_contratos WHERE status_vigencia = 'V'

	SELECT sum(importe) INTO v_sum_importe_CN FROM ta_16_pagos 
	WHERE control_contrato = v_control_contrato and ctrol_operacion = 6 and status_vigencia = 'V' and aso_mes_pago <= ( v_Periodo_CN );

	SELECT sum(importe) INTO v_sum_importe_EXE FROM ta_16_pagos 
	WHERE control_contrato = v_control_contrato and ctrol_operacion <> 6 and status_vigencia = 'V' and aso_mes_pago <= ( v_Periodo_EXE );

	Let v_sum_importe_p = v_sum_importe_CN + v_sum_importe_EXE;
	if v_sum_importe_p > 0 then
		Let v_contador 	= v_contador + 1;
		Let v_tot_importe	= v_tot_importe + v_sum_importe_p;
	end if;

	Let v_control_contrato = 0;
	Let v_sum_importe_CN = 0;
	Let v_sum_importe_EXE = 0;
	Let v_sum_importe_p = 0;

end foreach;

return 'ASEO CONTRATADO' , v_contador, v_tot_importe   with resume;

end procedure;

CREATE PROCEDURE "pgmoreno".sp34_ind_otras_oblig_01(par_cve_tab char(1))
{######################################################################
#  Procedimiento:    sp34_ind_otras_oblig_01
#  Descripcion:      Interfaz de consulta de OTRAS OBLIGACIONES para INDICADORES
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento vencidos dentro de OTRAS OBLIGACIONES
#  Llama a:          
#  
######################################################################}
                returning char(100) as concepto,
                               integer as cant_contratos,
                               Money(12,2) as importe_derechos;

define v_id_34_datos						Integer;
define v_contador							Integer;
define v_Periodo_CN, v_Periodo_EXE					varchar(7);
define v_sum_importe, v_tot_importe					Money(12,2);       
define v_nombre							varchar(100);        

Let v_id_34_datos	= 0;
Let v_contador 	= 0;
Let v_sum_importe	= 0;
Let v_tot_importe	= 0;
Let v_nombre	= '';

EXECUTE PROCEDURE con34_glperiodo ( par_cve_tab ) INTO v_Periodo_CN;

foreach
SELECT id_34_datos  INTO  v_id_34_datos FROM t34_datos a, t34_status b 
WHERE a.cve_tab = par_cve_tab  AND b.id_34_stat = a.id_stat AND b.cve_stat = 'V'

	SELECT sum(importe) INTO v_sum_importe  FROM t34_pagos a, t34_status b 
	WHERE a.id_datos = v_id_34_datos AND a.periodo <= v_Periodo_CN  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V');
	if v_sum_importe > 0 then
		Let v_contador 	= v_contador + 1;
		Let v_tot_importe	= v_tot_importe + v_sum_importe;
	end if;

	Let v_id_34_datos = 0;
	Let v_sum_importe = 0;

end foreach;
	SELECT nombre INTO v_nombre FROM t34_tablas WHERE cve_tab = par_cve_tab;

	return v_nombre , v_contador, v_tot_importe   with resume;

end procedure;

create procedure "pgcabrer".spd_11_pagosmermes(paxo int)
returning   int as merc,
            varchar(60) as nombre,
            int as locales,
            int as axo,
            int as mes,
            money(16,2) as pagos;

define v_merc, v_locales, v_id, v_axo, v_mes int;
define v_nombre varchar(60);
define v_pagos money(16,2);

foreach
  select a.num_mercado, d.descripcion, nvl(count(distinct a.id_local),0), year(b.fecha_pago), month(b.fecha_pago), nvl(sum(b.importe_pago),0)
  into v_merc, v_nombre, v_locales, v_axo, v_mes, v_pagos
  from ta_11_locales a,ta_11_pagos_local b,ta_11_mercados d
  where a.vigencia='A' and d.tipo_emision<>'B'
--  and year(b.fecha_pago)=paxo 
  and b.fecha_pago between mdy(01,01,paxo) and mdy(12,31,paxo) 
  and b.id_local=a.id_local and d.num_mercado_nvo=a.num_mercado
  group by a.num_mercado,d.descripcion,4,5 order by a.num_mercado,5

  return v_merc, v_nombre, v_locales, v_axo, v_mes, v_pagos with resume;
end foreach;
end procedure;

create procedure "pgcabrer".spd_11_ablicencias (pid int, pidlic int, puser varchar(10), popc char(1))
returning   int as estado,
            varchar(100) as mensaje;

define vestado, vexiste int;
define vmensaje varchar(100);
define v_r char(1);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
   end if;
   if v_lError = -239  THEN 
      RETURN -1, 'YA EXISTE LA LICENCIA CAPTURADA... VERIFICA ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   end if;
END EXCEPTION;

let v_r = 'N';

if pid=0 then
   return -1, 'Falta el id local... verifica ';
end if;

if pidlic=0 then
   return -1, 'Falta el id licencia... verifica ';
end if;


if popc='A' then
   if exists (select * from ta_11_licencias where id_local=pid and id_licencia=pidlic and vigencia='V') then
      return -1, 'Ya existe la licencia capturada... Verifica ';
   else
      BEGIN WORK;
      let v_r = 'S';
      insert into ta_11_licencias (id_control, id_local, id_licencia, vigencia, fecha_alta, fecha_baja, fecha_act, id_usuario)
       values (0, pid, pidlic, 'V', today, null, current, puser);
      let vestado=0;
      let vmensaje='Captura de licencia correcta';
      return vestado, vmensaje;  
      COMMIT WORK;
   end if; 
end if;

if popc='B' then
   if not exists (select * from ta_11_licencias where id_local=pid and id_licencia=pidlic and vigencia='V') then
      return -1, 'No existe la registro de licencia... Verifica ';
   else
      BEGIN WORK;
      let v_r = 'S';
      update ta_11_licencias set vigencia='B', fecha_baja=today, fecha_act=current, id_usuario=puser 
      where id_local=pid and id_licencia=pidlic and vigencia='V';
      let vestado=0;
      let vmensaje='Baja de licencia correcta';
      return vestado, vmensaje;  
      COMMIT WORK;
   end if; 
end if;

end procedure;

create function "pgcabrer".fn_getadetotalmerc(fmerc int,fmes int, fopc char(1))
returning   money(16,2) as total;

define v_total money(16,2);

if fopc='R' then -- "R" = adeudo rezago 
   select nvl(sum(b.importe),0) into v_total
   from ta_11_locales a,ta_11_adeudo_local b 
   where  a.num_mercado=fmerc and a.vigencia='A' and a.bloqueo<>4
   and b.id_local=a.id_local and (b.axo<(year(today)-1)  or (b.periodo<=12 and b.axo=(year(today)-1)));
end if;

if fopc='A' then -- "A" = adeudo actual
   select nvl(sum(b.importe),0) into v_total
   from ta_11_locales a,ta_11_adeudo_local b 
   where  a.num_mercado=fmerc and a.vigencia='A' and a.bloqueo<>4
   and b.id_local=a.id_local and (b.periodo<=fmes and b.axo=year(today));
end if;

return v_total;
end function;

create function "pgcabrer".fn_getpagtotalmerc(fmerc int,fmes int, pcuenta int, fopc char(1))
returning   money(16,2) as total;

define v_total, v_pagos, v_descuento money(16,2);

if fopc='R' then -- "R" = pagos rezago 
   select nvl(sum(b.importe_pago),0) into v_total
   from ta_11_locales a,ta_11_pagos_local b 
   where  a.num_mercado=fmerc and a.vigencia='A' and a.bloqueo<>4
   and b.id_local=a.id_local and (b.fecha_pago between mdy(1,1,year(today)) and today) 
   and (b.axo<(year(today)-1)  or (b.periodo<=12 and b.axo=(year(today)-1)));
end if;

if fopc='A' then -- "A" = pagos actual
   select nvl(sum(b.importe_pago),0) into v_total
   from ta_11_locales a,ta_11_pagos_local b 
   where  a.num_mercado=fmerc and a.vigencia='A' and a.bloqueo<>4
   and b.id_local=a.id_local and (b.fecha_pago between mdy(1,1,year(today)) and today)
   and (b.periodo<=fmes and b.axo=year(today));
end if;

if fopc='D' then -- "D" = Descuentos 
   select nvl(sum(b.importe),0) into v_total from ta_12_recibos a, ta_12_recibosdet b, ta_11_locales d 
   where (a.fecha between mdy(1,1,year(today)) and today) and a.id_modulo=11 and cvepago='P' and b.importe<0 and b.cuenta=pcuenta
   and a.axohasta=year(today) and meshasta<=fmes and d.id_local=a.id_regmodulo and d.vigencia='A' and d.bloqueo<>4
   and b.fecha=a.fecha and b.id_rec=a.id_rec and b.caja=a.caja and b.operacion=a.operacion;
   let v_total=(v_total*-1);
end if;

return v_total;
end function;

create procedure "pgcabrer".spd_11_totalesmerc(paxo int, pmes int)
returning   int as mercado,
            varchar(100) as nombre,
            int as vigentes,
            money(18,2) as renta,
            money(18,2) as adeudorezago,
            money(18,2) as adeudoactual,
            money(18,2) as pagosrezago,
            money(18,2) as pagosactual,
            money(18,2) as descuento;

define vmerc, vvigentes, vcuenta, vrpago, vopago int;
define vnombre varchar(100);
define vaderzg, vadeact, vpagrzg, vpagact, vrenta, vdescuento, v_desc money(18,2);
define v_renta,v_rentalocal,v_ren, vimporte money(16,2);
define v_merc,v_cat,v_cvecuo, v_vig, v_mesade, v_mespag, v_id int;
define v_secc, vcpago char(2);
define v_sup decimal(7,2);
define v_alta, vfpago date;

let vaderzg=0; let vadeact=0; let vpagrzg=0; let vpagact=0; let vdescuento=0;

foreach
  select num_mercado_nvo, descripcion, cuenta_descpp into vmerc, vnombre, vcuenta
  from ta_11_mercados where tipo_emision<>'B' and num_mercado_nvo <>214 
  order by num_mercado_nvo

  -- "L" = locales vigentes
  select nvl(count(distinct id_local),0) into vvigentes
  from ta_11_locales where num_mercado=vmerc and vigencia='A' and bloqueo<>4;

  -- "R" = renta
   execute function fn_getrentavigmerc(paxo, vmerc, pmes, 'R') into vrenta;

  -- "R" = adeudo rezago 
   select nvl(sum(b.importe),0) into vaderzg
   from ta_11_locales a,ta_11_adeudo_local b 
   where  a.num_mercado=vmerc and a.vigencia='A' and a.bloqueo<>4
   and b.id_local=a.id_local and (b.axo<(year(today)-1)  or (b.periodo<=12 and b.axo=(year(today)-1)));

  -- "A" = adeudo actual
   select nvl(sum(b.importe),0) into vadeact
   from ta_11_locales a,ta_11_adeudo_local b 
   where  a.num_mercado=vmerc and a.vigencia='A' and a.bloqueo<>4
   and b.id_local=a.id_local and (b.periodo<=pmes and b.axo=year(today));

  -- "R" = pagos rezago 
   select nvl(sum(b.importe_pago),0) into vpagrzg
   from ta_11_locales a,ta_11_pagos_local b 
   where  a.num_mercado=vmerc and a.vigencia='A' and a.bloqueo<>4
   and b.id_local=a.id_local and (b.fecha_pago between mdy(1,1,year(today)) and today) 
   and (b.axo<(year(today)-1)  or (b.periodo<=12 and b.axo=(year(today)-1)));
   let vimporte=0;
   let vpagact=0;
   let vdescuento=0;

   -- "A" = pagos actual
   foreach
     select b.fecha_pago, b.oficina_pago, b.caja_pago, b.operacion_pago, nvl(sum(b.importe_pago),0) 
     into vfpago, vrpago, vcpago, vopago, vimporte
     from ta_11_locales a,ta_11_pagos_local b 
     where  a.num_mercado=vmerc and a.vigencia='A' and a.bloqueo<>4
     and b.id_local=a.id_local --and (b.fecha_pago between mdy(1,1,year(today)) and today)
     and (b.periodo<=pmes and b.axo=year(today))
     group by  b.fecha_pago, b.oficina_pago, b.caja_pago, b.operacion_pago
     let vpagact=vpagact+vimporte;

     -- "D" = Descuentos 
     let v_desc=0;
     select nvl(sum(importe),0) into v_desc from ta_12_recibosdet  
     where importe<0 and cuenta=vcuenta and fecha=vfpago and id_rec=vrpago and caja=vcpago and operacion=vopago;
     let v_desc=v_desc*-1;
     let vdescuento=vdescuento+v_desc;
  end foreach;
--  let vdescuento=(vdescuento*-1);   
  return vmerc, vnombre, vvigentes, vrenta, vaderzg, vadeact, vpagrzg, vpagact, vdescuento with resume;

end foreach;

end procedure;

create function "pgcabrer".fn_getrentavigmerc(paxo int, pmerc int, pmes int, popc char(1))
returning   money(16,2) as renta;

define v_renta,v_rentalocal,v_ren money(16,2);
define v_merc, v_cat, v_cvecuo, v_vig, v_mesade, v_mespag, v_id, v_meses, h_cvecuo, v_mesaxo, v_dup int;
define v_secc char(2);
define v_sup, h_sup decimal(7,2);
define v_alta, h_fecha, b_fecha, h_alta  date;

let v_renta=0;
let v_rentalocal=0;

if popc='R' then  -- "R" = renta
   foreach
     select id_local,num_mercado,categoria,seccion,clave_cuota,superficie,fecha_alta into v_id,v_merc,v_cat,v_secc,v_cvecuo,v_sup,v_alta
     from ta_11_locales where num_mercado=pmerc and vigencia='A' and bloqueo<>4
     let v_mesaxo=0;
     let v_dup=0;
     if exists (select * from ta_11_movimientos where id_local=v_id and tipo_movimiento=7 and year(fecha)=year(today) ) then
        select first 1 a.fecha_alta into h_alta from ta_11_movimientos a, ta_11_locales b where a.id_local=v_id and b.id_local=a.id_local 
        and a.tipo_movimiento=7 and year(fecha)=year(today);

        if year(h_alta)=year(today) then
           let b_fecha=h_alta;-- v_alta; antes
        else
           let b_fecha=mdy(1,1,year(today));
        end if;
     else
        if year(v_alta)=year(today) then
           let b_fecha=v_alta;
        else
           let b_fecha=mdy(1,1,year(today));
        end if;        
     end if;
     -- busca cambios de superficie
     if exists (select * from ta_11_movimientos where id_local=v_id and tipo_movimiento=7 and year(fecha)=year(today) ) then
          foreach
          select clave_cuota, superficie, date(fecha)  into h_cvecuo, h_sup, h_fecha
          from ta_11_movimientos where id_local=v_id and tipo_movimiento=7 and year(fecha)=year(today) order by id_movimiento
          let v_ren=0;
          let v_meses=0;
           if exists (select * from ta_11_movimientos where id_local=v_id and tipo_movimiento in (11,13) and year(fecha)=year(today) ) then 
              execute procedure spd_11_calc_renta(paxo,v_cat,v_secc,v_cvecuo,v_sup,v_merc,0) into v_ren;
              let b_fecha=v_alta;
           else
              if h_sup=v_sup then
                 if v_dup=0 then
                    execute procedure spd_11_calc_renta(paxo,v_cat,v_secc,v_cvecuo,v_sup,v_merc,0) into v_ren;
                    let v_dup=1; 
                 end if;
              else
                 execute procedure spd_11_calc_renta(paxo,v_cat,v_secc,h_cvecuo,h_sup,v_merc,0) into v_ren;
              end if; 
           end if; 
          if v_dup=0 then
     --     execute procedure spd_11_calc_renta(paxo,v_cat,v_secc,h_cvecuo,h_sup,v_merc,0) into v_ren;
             let v_meses=month(h_fecha) - month(b_fecha);
             let v_meses=v_meses+1;
             let v_rentalocal=v_ren*v_meses;
             let v_renta=v_renta+v_rentalocal;
             let b_fecha=h_fecha;
          end if;       
        end foreach;
        let v_ren=0;
        execute procedure spd_11_calc_renta(paxo,v_cat,v_secc,v_cvecuo,v_sup,v_merc,0) into v_ren;
        select nvl(count(*),0) into v_mesade from ta_11_adeudo_local where id_local=v_id and axo=paxo and periodo<=pmes;
        select nvl(count(*),0) into v_mespag from ta_11_pagos_local where id_local=v_id and axo=paxo and periodo<=pmes; 
        let v_mesaxo=v_mesade+v_mespag;
        let v_rentalocal=v_ren*(v_mesaxo-v_meses);
        let v_renta=v_renta+v_rentalocal; 
     else
        let v_ren=0;
        execute procedure spd_11_calc_renta(paxo,v_cat,v_secc,v_cvecuo,v_sup,v_merc,0) into v_ren;
        select nvl(count(*),0) into v_mesade from ta_11_adeudo_local where id_local=v_id and axo=paxo and periodo<=pmes;
        select nvl(count(*),0) into v_mespag from ta_11_pagos_local where id_local=v_id and axo=paxo and periodo<=pmes; 
        let v_rentalocal=v_ren*(v_mesade+v_mespag);
        let v_renta=v_renta+v_rentalocal;
     end if;
   end foreach;
end if;

if popc='L' then   -- "L" = locales
   foreach
     select nvl(count(distinct id_local),0) into v_vig
     from ta_11_locales where num_mercado=pmerc and vigencia='A' and bloqueo<>4
     let v_ren=0;
     let v_renta=v_vig; 
   end foreach;
end if;

return v_renta;
end function;

CREATE PROCEDURE "pgmoreno".sp42_seguim_doctos_quien ( pUsuario char(10), pStatSeguim int, pOpBuscar int, pBusqueda varchar(100), pPrioridad int, pOrden int, pStatCtrol int, pStatDoc int, pOpcion int )
Returning	int as estatus,
	varchar(255) as mensaje,
                	varchar(100) as centro,
                	int as ejercicio,
                	int as numero,
                	varchar(30) as nombre_generico,
                	varchar(50) as tipo_docto,
                	date as fecha_docto,
                	date as fecha_registro,
                	Datetime year to second as fecha_limite,
                	int as id_centro_orden,
                	int as id_control,
                	char(10) as control,
                	int as id_doctos,
                	int as usuario_seg,
                	int as Orden,
                	int as id_centro_dependo,
	int as prioridad_id,

	varchar(50) as status_mov,
                  Datetime year to second as fecha_seguimiento,
                  varchar(10) as usuario_seguim,
                  varchar(10) as usuario_mov,
                  int as id_seguim;

define v_status                       int;
define v_mensaje                      varchar(255);
define v_lError                       int;
define v_lISAMError                   varchar(255);
define v_vcMensaje                    varchar(255);

define vv_centro_origen						char(100);
define vv_ejercicio, vv_numero, vv_id_centro, vv_id_control, vv_id_doctos	int;
define v_id_delegado_titular_centro, v_id_centro_dependo, VV_t42_prioridad_id	int;
define vv_nombre_generico                                          			char(30);
define vv_tipo_documento                                           				char(50);
define vv_fec_docto, vv_fec_rgs					date;
define vv_fec_limite, VV_fec_mov                                   			datetime year to second;
define vv_control                                                  				char(10);
define vv_orden							int;

define vStatus  varchar(50);
define vFechaSeg datetime year to second;
define vUsuario, vUsuario_mov   char(10);
define vIdSeg int;

Let v_status = 0;
Let v_mensaje = 'CONSULTA CORRECTA';

Let vv_centro_origen 	= '';
Let vv_ejercicio		= 0;
Let vv_numero		= 0;
Let vv_nombre_generico	= '';
Let vv_tipo_documento	= '';
Let vv_fec_docto		= Null;
Let vv_fec_rgs		= Null;
Let vv_fec_limite		= Null;
Let vv_id_centro		= 0;
Let vv_id_control		= 0;
Let vv_control		= '';
Let vv_id_doctos		= 0;
Let v_id_delegado_titular_centro	= 0;
Let vv_t42_prioridad_id	= 0;
Let vv_orden		= 0;

Let vStatus		= '';
Let vFechaSeg		= Null;
Let vUsuario		= '';
Let vUsuario_mov		= '';
Let vIdSeg		= 0;

	foreach
	execute PROCEDURE sp42_seguim_doctos ( pUsuario, pStatSeguim, pOpBuscar, pBusqueda, pPrioridad, pOrden, pStatCtrol, pStatDoc )
	into  v_status, v_mensaje, vv_centro_origen, vv_ejercicio, vv_numero, vv_nombre_generico, vv_tipo_documento, vv_fec_docto, vv_fec_rgs, 
		vv_fec_limite, vv_id_centro, vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, vv_orden, v_id_centro_dependo, VV_t42_prioridad_id

		foreach
		execute PROCEDURE sp42_seguim_doc ( vv_id_doctos, v_id_centro_dependo, v_id_delegado_titular_centro, pUsuario, 1 ) 
		into vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg
		end foreach;

	if pOpcion = 0 then
		RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicio, vv_numero, vv_nombre_generico, vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
			vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, vv_orden, v_id_centro_dependo, VV_t42_prioridad_id, 
			vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg  with resume;
	end if;
	if pOpcion = 1 then
		if vv_control = "RECIBIDO" then
			RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicio, vv_numero, vv_nombre_generico, vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
			vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, vv_orden, v_id_centro_dependo, VV_t42_prioridad_id, 
			vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg  with resume;
		end if;
	end if;
	if pOpcion = 2 then
		if vv_control = "ENVIADO" then
			RETURN v_status,v_mensaje, vv_centro_origen, vv_ejercicio, vv_numero, vv_nombre_generico, vv_tipo_documento, vv_fec_docto, vv_fec_rgs, vv_fec_limite, vv_id_centro, 
			vv_id_control, vv_control, vv_id_doctos, v_id_delegado_titular_centro, vv_orden, v_id_centro_dependo, VV_t42_prioridad_id, 
			vStatus, vFechaSeg, vUsuario, vUsuario_mov, vIdSeg  with resume;
		end if;
	end if;
	end foreach;

end procedure;

CREATE PROCEDURE "informix".sp_abc_34_etiq (p_opc char(1), 
    p_cve_tab CHAR(2),
    p_abreviatura CHAR(4),
    p_etiq_control VARCHAR(20),
    p_concesionario VARCHAR(20),
    p_ubicacion VARCHAR(20),
    p_superficie VARCHAR(20),
    p_fecha_inicio VARCHAR(20),
    p_fecha_fin VARCHAR(20),
    p_recaudadora VARCHAR(20),
    p_sector VARCHAR(20),
    p_zona VARCHAR(20),
    p_licencia VARCHAR(20),
    p_fecha_cancelacion VARCHAR(20),
    p_unidad VARCHAR(20),
    p_categoria VARCHAR(20),
    p_seccion VARCHAR(20),
    p_bloque VARCHAR(20),
    p_nombre_comercial VARCHAR(20),
    p_lugar VARCHAR(20),
    p_obs VARCHAR(20)
)
{######################################################################
#  Procedimiento:    sp_abc_34_etiq
#  Descripcion:      ABC para la tabla t34_etiq
#
#  Parametros       p_opc = I=insertar, E=Editar, B=Borrar 
#  de entrada:     
#                   p_cve_tab     = clave de tabla
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco Ortega
#  Fecha:            20 Agosto 2018   
#
#  Llamado por:      modulos.guadalajara.gob.mx/apps
#  Llama a:          
#  
######################################################################}
returning 
int         as estatus,
varchar(100) as mensaje;
-----------Define las variables de retorno----------------
define v_estatus       int;
define v_mensaje       varchar(100);
-----------------------------------------------------------
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define v_auto       int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
      RETURN -100, 'NO FUE POSIBLE REALIZAR ACTUALIZACI�N ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION; 

let v_estatus = 1;
let v_mensaje = "Opcion no disponible";

--si la opcion fue insertar
if p_opc='E' then
   if not exists(select * from t34_etiq where cve_tab=p_cve_tab) then
   insert into t34_etiq(
     cve_tab ,
     abreviatura ,
     etiq_control ,
     concesionario ,
     ubicacion ,
     superficie ,
     fecha_inicio ,
     fecha_fin ,
     recaudadora ,
     sector ,
     zona ,
     licencia ,
     fecha_cancelacion ,
     unidad ,
     categoria ,
     seccion ,
     bloque ,
     nombre_comercial ,
     lugar ,
     obs
   ) values (
     p_cve_tab ,
     p_abreviatura ,
     p_etiq_control ,
     p_concesionario ,
     p_ubicacion ,
     p_superficie ,
     p_fecha_inicio ,
     p_fecha_fin ,
     p_recaudadora ,
     p_sector ,
     p_zona ,
     p_licencia ,
     p_fecha_cancelacion ,
     p_unidad ,
     p_categoria ,
     p_seccion ,
     p_bloque ,
     p_nombre_comercial ,
     p_lugar ,
     p_obs
   );
   let v_estatus = 0;
   let v_mensaje = "Registro agregado";
   else
      update t34_etiq set
     	abreviatura  =             p_abreviatura ,
     	etiq_control  =            p_etiq_control ,
     	concesionario  =           p_concesionario ,
     	ubicacion  =               p_ubicacion ,
     	superficie  =              p_superficie ,
     	fecha_inicio  =            p_fecha_inicio ,
     	fecha_fin  =               p_fecha_fin ,
     	recaudadora  =             p_recaudadora ,
     	sector  =                  p_sector ,
     	zona  =                    p_zona ,
     	licencia  =                p_licencia ,
     	fecha_cancelacion  =       p_fecha_cancelacion ,
     	unidad  =                  p_unidad ,
     	categoria  =               p_categoria ,
     	seccion  =                 p_seccion ,
     	bloque  =                  p_bloque ,
     	nombre_comercial  =        p_nombre_comercial ,
     	lugar  =                   p_lugar ,
     	obs    =                   p_obs
      where cve_tab=p_cve_tab;
      let v_estatus = 0;
      let v_mensaje = "Registro actualizado";
   end if; 
end if;

if p_opc='B' then
   if exists(select * from t34_etiq where cve_tab=p_cve_tab) then
      delete from t34_etiq where cve_tab=p_cve_tab;
      let v_estatus = 0;
      let v_mensaje = "Registro borrado";
   else
      let v_estatus = -1;
      let v_mensaje = "El registro no existe";
   end if; 
end if;
return v_estatus,v_mensaje;
end procedure;

CREATE PROCEDURE "informix".sp_abc_34_status (p_opc char(1), 
    p_id_34_stat INT,
    p_cve_tab CHAR(1),
    p_cve_stat CHAR(1),
    p_descripcion VARCHAR(50),
    p_usuario CHAR(10)
)
{######################################################################
#  Procedimiento:    sp_abc_34_status
#  Descripcion:      ABC para la tabla t34_status
#
#  Parametros       p_opc = I=insertar, E=Editar, B=Borrar 
#  de entrada:      p_id_34_stat  = id del registro
#                   p_cve_tab     = clave de tabla
#                   p_cve_stat    = clave de estatus
#                   p_descripcion = descripcion 
#                   p_usuario     = clave de tabla
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco Ortega
#  Fecha:            20 Agosto 2018   
#
#  Llamado por:      modulos.guadalajara.gob.mx/apps
#  Llama a:          
#  
######################################################################}
returning 
int         as estatus,
varchar(100) as mensaje;
-----------Define las variables de retorno----------------
define v_estatus       int;
define v_mensaje       varchar(100);
-----------------------------------------------------------
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define v_auto       int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
      RETURN -100, 'NO FUE POSIBLE REALIZAR ACTUALIZACI�N ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION; 

let v_estatus = 1;
let v_mensaje = "Opcion no disponible";

--si la opcion fue insertar
if p_opc='I' then
	insert into t34_status(
     		id_34_stat ,
     		cve_tab ,
     		cve_stat ,
     		descripcion ,
     		usuario
	) values (0 ,p_cve_tab ,p_cve_stat ,p_descripcion ,p_usuario);

	--let v_id=dbinfo("sqlca.sqlerrd1");
   let v_estatus = 0;
   let v_mensaje = "Registro agregado";
end if;

if p_opc='E' then
   if exists(select * from t34_status where id_34_stat=p_id_34_stat) then
      update t34_status set
        cve_tab=p_cve_tab, 
        cve_stat=p_cve_stat, 
        descripcion=p_descripcion, 
        usuario=p_usuario
      where id_34_stat=p_id_34_stat;
      let v_estatus = 0;
      let v_mensaje = "Registro actualizado";
   else
      let v_estatus = -1;
      let v_mensaje = "El registro no existe";
   end if; 
end if;

if p_opc='B' then
   if exists(select * from t34_status where id_34_stat=p_id_34_stat) then
      delete from t34_status where id_34_stat=p_id_34_stat;
      let v_estatus = 0;
      let v_mensaje = "Registro borrado";
   else
      let v_estatus = -1;
      let v_mensaje = "El registro no existe";
   end if; 
end if;
return v_estatus,v_mensaje;
end procedure;

CREATE PROCEDURE "informix".sp_abc_34_tablas (p_opc char(1), 
    p_id_34_tab INT,
    p_nombre VARCHAR(100)
)
{######################################################################
#  Procedimiento:    sp_abc_34_tablas
#  Descripcion:      ABC para la tabla t34_tablas
#
#  Parametros       p_opc = I=insertar, E=Editar, B=Borrar 
#  de entrada:      p_id_34_tab  = id del registro
#                   p_nombre     = nombre de tabla
#                   
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco Ortega
#  Fecha:            16 Agosto 2018   
#
#  Llamado por:      modulos.guadalajara.gob.mx/apps
#  Llama a:          
#  
######################################################################}
returning 
int         as estatus,
varchar(100) as mensaje;
-----------Define las variables de retorno----------------
define v_estatus       int;
define v_mensaje       varchar(100);
-----------------------------------------------------------
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define v_auto       int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
      RETURN -100, 'NO FUE POSIBLE REALIZAR ACTUALIZACI�N ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION; 

let v_estatus = 1;
let v_mensaje = "Opcion no disponible";

--si la opcion fue insertar
if p_opc='I' then
	select max(auto_tab)+1 into v_auto from t34_tablas;
	insert into t34_tablas(
     		id_34_tab ,
     		cve_tab ,
     		nombre ,
    		cajero ,
     		auto_tab
	) values (0 ,
     		v_auto ,
     		p_nombre ,
     		'N' ,
     		v_auto
	);
	--let v_id=dbinfo("sqlca.sqlerrd1");
   let v_estatus = 0;
   let v_mensaje = "Registro agregado";
end if;

if p_opc='E' then
   if exists(select * from t34_tablas where id_34_tab=p_id_34_tab) then
      update t34_tablas set
        nombre=p_nombre 
      where id_34_tab=p_id_34_tab;
      let v_estatus = 0;
      let v_mensaje = "Registro actualizado";
   else
      let v_estatus = -1;
      let v_mensaje = "El registro no existe";
   end if; 
end if;

if p_opc='B' then
   if exists(select * from t34_tablas where id_34_tab=p_id_34_tab) then
      delete from t34_tablas where id_34_tab=p_id_34_tab;
      let v_estatus = 0;
      let v_mensaje = "Registro borrado";
   else
      let v_estatus = -1;
      let v_mensaje = "El registro no existe";
   end if; 
end if;
return v_estatus,v_mensaje;
end procedure;

CREATE PROCEDURE "informix".ins34_gen_forma ( par_tabla Char(1), par_id_34_datos Integer, par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_usuario char(10) )
{######################################################################
#  Procedimiento:    ins34_gen_forma
#  Descripcion:      Interfaz de ALTA a registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		     	par_id_34_datos = id de control del registro
#                    		par_Axo_Ini = a�o de inicio de obligacion
#                    		par_Mes_Ini = mes de inicio de obligacion
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;


-----------Define las variables de retorno----------------
define v_estatus 	int;
define v_leyenda    	varchar(255);
define v_registro	int;

define v_id_34_stat	int;
define v_costo	money(12,2);
define v_tipo_var	Char(1);
               
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion ins34_gen_forma ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

Let v_leyenda    	= 'NO SE CREO EL REGISTRO DE LA FORMA';
Let v_estatus	= -1;

Let v_id_34_stat	= 0;
Let v_costo	= 0;
Let v_tipo_var 	= '';

if par_tabla = '5' then  -- REGISTRO DEL VALOR DE LA FORMA 
	SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';

	SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla and ejercicio = par_Axo_Ini  AND cve_unidad = 'F';

	INSERT INTO t34_pagos VALUES  ( 0, par_id_34_datos, mdy(par_Mes_Ini,01,par_Axo_Ini), v_costo, 0, Null, Null, Null, Null, Null, par_usuario, v_id_34_stat, 'F');

	Let v_registro = dbinfo("sqlca.sqlerrd1");
	if v_registro > 0 then
		Let v_estatus = v_registro;
		Let v_leyenda = 'SE CREO EL REGISTRO DE LA FORMA';
	end if;
end if;
	RETURN v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".ins34_gen_adeudos ( par_tabla Char(1), par_id_34_datos Integer, 
par_sup Money(7,2), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_Descrip Char(100), par_tipo_var char(1), par_usuario char(10) )
{######################################################################
#  Procedimiento:    ins34_gen_adeudos
#  Descripcion:      Interfaz de ALTA a registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		     	par_id_34_datos = id de registro de control
#                    		par_sup = superficie
#                    		par_Axo_Ini = a�o de inicio de obligacion
#                    		par_Mes_Ini = mes de inicio de obligacion
#                    		par_Descrip = descripcion de la unidad a calculo para adeudos
#                    		par_tipo_var = tipo de variable
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    		varchar(255);
define v_estatus 		int;
define v_registro		int;

define v_importe_reg, v_costo, v_importe_rec1	Money(12,2);             
define v_mes		int;
define v_id_34_stat		int;
  
define v_lError     		int;
define v_lISAMError 		int;
define v_vcMensaje  	varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion ins34_gen_adeudos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_leyenda    	= 'SE CREARON ADEUDOS CORRECTAMENTE';
Let v_estatus	= 0;
Let v_registro	= 0;

Let v_importe_reg = 0;
Let v_costo = 0;
Let v_importe_rec1 = 0;
Let v_mes = 0;
Let v_id_34_stat = 0;
				
SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = par_Axo_Ini  
AND cve_unidad = par_tipo_var  AND descripcion = par_Descrip ;

SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
Let v_importe_reg = par_sup * v_costo;
FOR v_mes = par_Mes_Ini to 12
	--Let v_Importe_recargo = 0;
                  --Let v_importe_rec1 = 0;
                  --EXECUTE PROCEDURE con16_Rcgos ('CN', par_Axo_Ini || '-' || v_mes ) INTO v_Importe_recargo;  
                  --Let v_importe_rec1 = (v_importe_reg * v_Importe_recargo) / 100;    

	INSERT INTO t34_pagos VALUES
                  ( 0, par_id_34_datos, mdy(v_mes,01,par_Axo_Ini), v_importe_reg, v_importe_rec1, Null, Null, Null, Null, Null, par_usuario, v_id_34_stat, par_tipo_var);
	Let v_estatus = dbinfo("sqlca.sqlerrd1");
	if v_estatus > 0 then
		Let v_estatus	= 1;
	else
		Let v_registro	= v_registro -1;
	end if;
END FOR;
	if v_registro < 0 then
		Let v_leyenda    	= 'NO CREARON LOS ADEUDOS, REVISAR';
		Let v_estatus	= -1;
	else
		Let v_leyenda    	= 'SE CREARON ADEUDOS CORRECTAMENTE';
		Let v_estatus	= 1;
	end if;
		
	RETURN v_estatus,v_leyenda;
end procedure;

CREATE PROCEDURE "informix".con34_glperiodo ( par_tabla Char(1) )
                returning varchar(7) as periodo;    -- Periodo Cuota Normal

{
#  Procedimiento: con34_Glperiodo
#  Descripcion:  Genera una consulta del Periodo Limite de CN y EXE actual.
#  Parametros de entrada: TABLA
#  Parametros de salida:   A�o y mes de la CUOTA
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

  define v_Periodo_CN				varchar(7);
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy		varchar(4);
  define fecha_tabla_v				date;

  SELECT Month(fechalimite), Day(fechalimite), fechalimite  INTO Mes_v, Dia_v, fecha_tabla_v
	FROM t34_fechalimite
	WHERE cve_tab = par_tabla
	AND Month(fechalimite) = Month(Current)  AND Year(fechalimite) = Year(Current);

	Let Aso_Hoy = Year(Current);
      	Let Mes_Hoy = Month(Current);
	if  Mes_v is null then
		Let v_Periodo_CN = Year(Current) - 1||'-12';
	else
		if (par_tabla = '1') or (par_tabla = '2') then
			if Current > fecha_tabla_v then          --  CUOTA NORMAL
         				Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      			else
          				if Month(Current) = 1 then
             					Let v_Periodo_CN = Year(Current) - 1||'-12';
          				else
             					Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          				end if;
      			end if;
		else
			if Current >= fecha_tabla_v then          --  CUOTA NORMAL
         				Let v_Periodo_CN = Year(Current) || '-' || Month(Current);
      			else
          				if Month(Current) = 1 then
             					Let v_Periodo_CN = Year(Current) - 1||'-12';
          				else
             					Let v_Periodo_CN = Year(Current) || '-' || Month(Current) - 1;
          				end if;
      			end if;
		end if;
	end if;

RETURN v_Periodo_CN;

end procedure;

CREATE PROCEDURE "informix".cob34_gctaaplic_01 ( par_tabla Char(2), par_tipo Char(1) )
{######################################################################
#  Procedimiento:    cob34_gctaaplic_01
#  Descripcion:      Interfaz de CONSULTA de cuentas y tipo de obligacion para OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		par_tipo = T = Tarifa, A = Autorizacion, F = Forma
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por cualquier procedimiento del modulo
#  Llama a:          
#  
######################################################################}
                returning	Integer	as	cta_multas, 
		Integer	as	cta_gastos, 
		Integer	as	cta_adeudos_act, 
		Integer	as	cta_adeudos_dev, 
		Integer	as	cta_adeudos_reza, 
		Integer	as	cta_exced_act, 
		Integer	as	cta_exced_dev, 
		Integer	as	cta_exced_reza, 
		Integer	as	cta_rcgos_ade, 
		Integer	as	cta_rcgos_exced, 
		Integer	as	cta_dcto_rcgos_ade, 
		Integer	as	cta_dcto_rcgos_exced, 
		VarChar(50)	as	tipo_obligacion;

define v_cta_multas, v_cta_gastos, v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza		int;
define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza, v_cta_rcgos_ade, v_cta_rcgos_exced	int;
define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced						int;
define v_tipo_obligacion									varchar(50);

Let v_cta_multas = 0;
Let v_cta_gastos = 0;
Let v_cta_adeudos_act = 0;
Let v_cta_adeudos_dev = 0;
Let v_cta_adeudos_reza = 0;
Let v_cta_exced_act = 0;
Let v_cta_exced_dev = 0; 
Let v_cta_exced_reza = 0;
Let v_cta_rcgos_ade = 0;
Let v_cta_rcgos_exced = 0;
Let v_cta_dcto_rcgos_ade = 0;
Let v_cta_dcto_rcgos_exced = 0;
Let v_tipo_obligacion = '';


  SELECT cta_multas, cta_gastos, cta_adeudos_act, cta_adeudos_dev, cta_adeudos_reza, 
	cta_exced_act, cta_exced_dev, cta_exced_reza, cta_rcgos_ade, cta_rcgos_exced, 
	cta_dcto_rcgos_ade, cta_dcto_rcgos_exced, tipo_obligacion
  INTO     v_cta_multas, v_cta_gastos, v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza, 
	v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza, v_cta_rcgos_ade, v_cta_rcgos_exced, 
	v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced, v_tipo_obligacion
  FROM t34_ctasaplic where cve_tab = par_tabla and tipo_var = par_tipo;


	RETURN v_cta_multas, v_cta_gastos, v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza, 
		v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza, v_cta_rcgos_ade, v_cta_rcgos_exced, 
		v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced, v_tipo_obligacion ; -- with resume;
                                           
end procedure;

CREATE PROCEDURE "informix".cob34_gtotade_01 ( par_tabla Char(1), par_Id Integer, par_Axo Smallint, par_Mes Smallint )
{######################################################################
#  Procedimiento:    cob34_gtotade_01
#  Descripcion:      Interfaz de TOTALES de adeudos de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		     	par_Id = Id de control del registro
#                    		par_Axo = a�o de corte
#                    		par_Mes = mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Cuenta,
		Char(1) as Obliga,
		VarChar(200) as Concepto,
		Money(12,2) as Importe;

--**********************************************************************************************
  define v_Periodo_CN								varchar(7);
  define v_importe, v_recargo, v_por_recargo, v_importe_rgo, v_importe_total			Money(12,2);
  define vF_totimporte_rgo, vF_totimporte_actual, vF_totimporte_devengado, vF_totimporte_rezago	Money(12,2);
  define v_totimporte_rgo, v_totimporte_rezago, v_totimporte_devengado, v_totimporte_actual	Money(12,2);
  define v_Axo, v_Mes, Dia_v, Mes_v, Axo_v						Integer;
  define v_limite, v_tipo_var								Char(1);
  define v_periodo, r_Periodo_CN							Date;

  define v_importe_multa, v_importe_gastos, v_tot_gastos					Money(12,2);
  define v_total_importes, v_redondeado							Money(15,2);
  define v_redondear								Money(5,2);

--****************************************************************************************************************************************** ctas de aplicacion
  define v_cta_multas, v_cta_gastos							Integer;
  define v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza			Integer;
  define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza				Integer;
  define v_cta_rcgos_ade, v_cta_rcgos_exced						Integer;
  define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced					Integer;
  define v_tipo_obligacion								Char(50);
--******************************************************************************************************************************************

  SELECT Year(fechalimite), Month(fechalimite), Day(fechalimite)  INTO Axo_v, Mes_v, Dia_v
	FROM t34_fechalimite
	WHERE cve_tab = par_tabla
	AND Month(fechalimite) = Month(Current)  AND Year(fechalimite) = Year(Current);

      if Day(Current) <= Dia_v then
	if Mes_v = 1 then
		Let Mes_v = 12;
		Let Axo_v = Axo_v - 1;
	else
		Let Mes_v = Mes_v - 1;
	end if;
      end if;

                EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  
  -- pedazo adicionado
  --Let r_Periodo_CN = v_Periodo_CN;

Let v_tipo_var = '';

--************************************************REQUERIMIENTOS
Let v_totimporte_actual = 0;
Let v_totimporte_devengado = 0;
Let v_totimporte_rezago = 0;
Let v_totimporte_rgo = 0;

	Let v_importe_multa = 0;
	Let v_importe_gastos =0;
	Let v_tot_gastos = 0;
FOREACH
                     --Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos
                     --  Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos 
	SELECT importe_multa, importe_gastos INTO v_importe_multa, v_importe_gastos
                      from ta_15_apremios
                       Where modulo = 34  And control_otr = par_Id
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		--if v_FolReq > 0 then
		--   Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
		--else
		--   Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
		--Let v_FolReq = v_FolReq + 1;
		--end if;
END FOREACH;
                       --if v_FolReq > 0 then
	       --	return v_DetFolReq, Null, Null, v_importe_multa, v_tot_gastos  with resume;
                       --         Let v_Contador = v_Contador + 1;
                       --end if;
		EXECUTE PROCEDURE cob34_gctaaplic_01 ( par_tabla, 'T' ) INTO v_cta_multas, v_cta_gastos, 
				v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza, v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza, 
				v_cta_rcgos_ade, v_cta_rcgos_exced, v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced, v_tipo_obligacion;
		if v_importe_multa > 0 then
			RETURN v_cta_multas, 'S', 'MULTAS  ', v_importe_multa   with resume;
		end if;
		if v_tot_gastos > 0 then
			RETURN v_cta_gastos, 'S', 'GASTOS  ', v_tot_gastos   with resume;
		end if;

--*********************************************** FORMA DE APERTURA
Let v_importe =0;
Let v_recargo =0;
Let v_por_recargo =0;
Let v_importe_rgo =0;
Let v_cta_adeudos_act = 0;
Let v_cta_adeudos_dev = 0;
Let v_cta_adeudos_reza = 0;
Let v_cta_rcgos_ade = 0;
Let v_cta_dcto_rcgos_ade = 0;
Let vF_totimporte_rgo = 0;
Let vF_totimporte_actual = 0;
Let vF_totimporte_devengado = 0;
Let vF_totimporte_rezago = 0;

FOREACH
                SELECT Year(a.periodo), Month(a.periodo), a.periodo, a.importe, a.recargo, a.tipo_var  INTO v_Axo, v_Mes, v_periodo, v_importe, v_recargo, v_tipo_var  
		FROM t34_pagos a, t34_status b    WHERE id_datos = par_Id  AND periodo <= par_Axo || '-' || par_Mes AND a.tipo_var = 'F'
			AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('V')
			ORDER BY a.periodo, a.id_34_pagos
		if v_tipo_var = 'F' then
			Let v_importe_rgo = 0;
		else
			if v_importe > 0 then 
                                                	Select sum(por_recargo) 
                                                                Into v_por_recargo
                                                                From t34_porcentajes 
                                                                Where periodo_porc between v_Axo || '-' || v_Mes and (v_Periodo_CN);

				if v_por_recargo > 0 then
                                                                	Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
				else
                                                                	Let v_importe_rgo = 0;
				end if;
			else
				Let v_importe_rgo = 0;
			end if;
		end if;
	if v_Axo  < Year(Current) then
		Let vF_totimporte_rgo = vF_totimporte_rgo + v_importe_rgo;
		Let vF_totimporte_rezago = vF_totimporte_rezago + v_importe;
	end if;
	if v_Axo  = Year(Current) then
		--if v_Mes > Mes_v then
			Let vF_totimporte_rgo = vF_totimporte_rgo + v_importe_rgo;
			Let vF_totimporte_actual = vF_totimporte_actual + v_importe;
		--else
		--	Let vF_totimporte_rgo = vF_totimporte_rgo + v_importe_rgo;
		--	Let vF_totimporte_devengado = vF_totimporte_devengado + v_importe;
		--end if;
	end if;
END FOREACH;
		EXECUTE PROCEDURE cob34_gctaaplic_01 ( par_tabla, v_tipo_var ) INTO v_cta_multas, v_cta_gastos, 
				v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza, v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza, 
				v_cta_rcgos_ade, v_cta_rcgos_exced, v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced, v_tipo_obligacion;

		if vF_totimporte_actual > 0 then
			RETURN v_cta_adeudos_act, 'S', Trim(v_tipo_obligacion) || ' ACTUAL ', vF_totimporte_actual   with resume;
		end if;
		if vF_totimporte_devengado > 0 then
			RETURN v_cta_adeudos_dev, 'S', Trim(v_tipo_obligacion) || ' DEVENGADO ', vF_totimporte_devengado   with resume;
		end if;
		if vF_totimporte_rezago > 0 then
			RETURN v_cta_adeudos_reza, 'S', Trim(v_tipo_obligacion) || ' REZAGO ', vF_totimporte_rezago   with resume;
		end if;
		if vF_totimporte_rgo > 0 then
			RETURN v_cta_rcgos_ade, 'S', ' RECARGOS ', vF_totimporte_rgo   with resume;
		end if;

--**************************************** ADEUDOS
Let v_importe =0;
Let v_recargo =0;
Let v_por_recargo =0;
Let v_importe_rgo =0;
Let v_cta_adeudos_act = 0;
Let v_cta_adeudos_dev = 0;
Let v_cta_adeudos_reza = 0;
Let v_cta_rcgos_ade = 0;
Let v_cta_dcto_rcgos_ade = 0;
Let v_totimporte_actual = 0;
Let v_totimporte_devengado = 0;
Let v_totimporte_rezago = 0;
Let v_totimporte_rgo = 0;

FOREACH
                SELECT Year(a.periodo), Month(a.periodo), a.periodo, a.importe, a.recargo, a.tipo_var  INTO v_Axo, v_Mes, v_periodo, v_importe, v_recargo, v_tipo_var  
		FROM t34_pagos a, t34_status b    WHERE id_datos = par_Id  AND periodo <= par_Axo || '-' || par_Mes AND a.tipo_var <>  'F'
			AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('V')
			ORDER BY a.periodo, a.id_34_pagos
		
			if v_importe > 0 then 
                                                	Select sum(por_recargo) 
                                                                Into v_por_recargo
                                                                From t34_porcentajes 
                                                                Where periodo_porc between v_Axo || '-' || v_Mes and (v_Periodo_CN);

				if v_por_recargo > 0 then
                                                                	Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
				else
                                                                	Let v_importe_rgo = 0;
				end if;
			else
				Let v_importe_rgo = 0;
			end if;
	if v_Axo  < Year(Current) then
		Let v_totimporte_rgo = v_totimporte_rgo + v_importe_rgo;
		Let v_totimporte_rezago = v_totimporte_rezago + v_importe;
	end if;
	if v_Axo  = Year(Current) then
		--if v_Mes > Mes_v then
			Let v_totimporte_rgo = v_totimporte_rgo + v_importe_rgo;
			Let v_totimporte_actual = v_totimporte_actual + v_importe;
		--else
		--	Let v_totimporte_rgo = v_totimporte_rgo + v_importe_rgo;
		--	Let v_totimporte_devengado = v_totimporte_devengado + v_importe;
		--end if;
	end if;
END FOREACH;
		EXECUTE PROCEDURE cob34_gctaaplic_01 ( par_tabla, v_tipo_var ) INTO v_cta_multas, v_cta_gastos, 
				v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza, v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza, 
				v_cta_rcgos_ade, v_cta_rcgos_exced, v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced, v_tipo_obligacion;

		if v_totimporte_actual > 0 then
			RETURN v_cta_adeudos_act, 'S', Trim(v_tipo_obligacion) || ' ACTUAL ', v_totimporte_actual   with resume;
		end if;
		if v_totimporte_devengado > 0 then
			RETURN v_cta_adeudos_dev, 'S', Trim(v_tipo_obligacion) || ' DEVENGADO ', v_totimporte_devengado   with resume;
		end if;
		if v_totimporte_rezago > 0 then
			RETURN v_cta_adeudos_reza, 'S', Trim(v_tipo_obligacion) || ' REZAGO ', v_totimporte_rezago   with resume;
		end if;
		if v_totimporte_rgo > 0 then
			RETURN v_cta_rcgos_ade, 'S', ' RECARGOS ', v_totimporte_rgo   with resume;
		end if;

                 

	Let v_total_importes = v_totimporte_actual + vF_totimporte_actual + 
			    v_totimporte_devengado + vF_totimporte_devengado + 
			    v_totimporte_rezago + vF_totimporte_rezago + 
			    v_totimporte_rgo + vF_totimporte_rgo;
   
	EXECUTE PROCEDURE redondeocaja (v_total_importes) INTO v_redondeado, v_redondear;

	if v_redondear <> 0 then
		RETURN 550800000, 'S', 'REDONDEO  ', v_redondear   with resume;
	end if;
end procedure;

CREATE PROCEDURE "informix".upd34_gen_adeudos ( par_tabla Char(1), par_id_34_datos Integer, 
par_sup Money(7,2), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_Descrip Char(100), par_tipo_var char(1), par_usuario char(10) )
{######################################################################
#  Procedimiento:    upd34_gen_adeudos
#  Descripcion:      Interfaz de ACTUALIZA los registros de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		     	par_id_34_datos = id de registro de control
#                    		par_sup = superficie
#                    		par_Axo_Ini = a�o de inicio de obligacion
#                    		par_Mes_Ini = mes de inicio de obligacion
#                    		par_Descrip = descripcion de la unidad a calculo para adeudos
#                    		par_tipo_var = tipo de variable
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:              
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    		varchar(255);
define v_estatus 		int;
define v_registro		int;

define v_importe_reg, v_costo, v_importe_rec1	Money(12,2);             
define v_mes		int;
define v_id_34_stat		int;
  
define v_lError     		int;
define v_lISAMError 		int;
define v_vcMensaje  	varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion ins34_gen_adeudos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_leyenda    	= 'SE ACTUALIZARON ADEUDOS CORRECTAMENTE';
Let v_estatus	= 0;
Let v_registro	= 0;

Let v_importe_reg = 0;
Let v_costo = 0;
Let v_importe_rec1 = 0;
Let v_mes = 0;
Let v_id_34_stat = 0;
	
SELECT costo INTO v_costo FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = par_Axo_Ini  
AND cve_unidad = par_tipo_var  AND descripcion = par_Descrip ;

SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
Let v_importe_reg = par_sup * v_costo;

UPDATE t34_pagos SET
	importe = 	v_importe_reg,  usuario = par_usuario,  tipo_var = par_tipo_var
WHERE id_datos = par_id_34_datos  AND Year(periodo) = par_Axo_Ini 
AND periodo >= par_Axo_Ini || '-' || par_Mes_Ini  AND id_stat = v_id_34_stat AND tipo_var <> 'F';

		
RETURN 1, 'SE ACTUALIZARON ADEUDOS CORRECTAMENTE';

end procedure;

CREATE PROCEDURE "informix".upd34_gen_unds ( par_tabla Char(1), par_id_34_datos Integer, par_sup Money(7,2), par_Descrip Char(100), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_usuario char(10) )
{######################################################################
#  Procedimiento:    upd34_gen_unds
#  Descripcion:      Interfaz de ACTUALIZA datos en registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	
#		     	par_id_34_datos = id del registro a cambio de datos
#		     	par_sup = superficie
#                    		par_Descrip = descripcion del la unidad
#                    		par_Axo_Ini = A�o de inicio de la superficie
#                    		par_Mes_Ini = Mes de inicio de la superficie
#  			par_usuario = usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
	returning Integer as Status,    	          -- Status
		varchar(100) as Concepto_Status;     -- Concepto status
-----------Define las variables de retorno----------------
define v_leyenda    		varchar(255);
define v_estatus 		int;

define v1_estatus 		int;
define v1_leyenda    		varchar(255);
define v2_estatus 		int;
define v2_leyenda    		varchar(255);

define v_contador		int;
define v_cuento		int;
define v_tipo_var		char(1);
define v_tipo_var_fijo	char(1);
define axo_actual		int;
define axo_penultimo	int;
define v_id_34_stat_c 	int;
define v_id_34_stat_v 	int;
define v_id_unidad_cont	int;
define v_id_unidad_und	int;
define v_descrip_cont	char(100);
define v_descrip_und	char(100);
define v_superficie		decimal(7,2);

define v_lError     		int;
define v_lISAMError 		int;
define v_vcMensaje  	varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion upd34_gen_unds ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_leyenda    	= 'No se actualizo';
Let v_estatus	= -1;

Let v1_estatus 	= 0;
Let v1_leyenda    	= 'NO CREARON LOS ADEUDOS, REVISAR';
Let v2_estatus 	= 0;
Let v2_leyenda    	= 'NO CREARON LOS ADEUDOS, REVISAR';

Let v_contador	= 0;
Let v_cuento	= 0;
Let v_tipo_var 	= '';
Let v_tipo_var_fijo	= '';
Let axo_actual 	= Year(Current);
Let axo_penultimo	= axo_actual - 2;
Let v_id_34_stat_c	= 0;
Let v_id_34_stat_v	= 0;

Let v_superficie	= 0;
Let v_id_unidad_cont	= 0;
Let v_id_unidad_und	= 0;

SELECT id_34_stat INTO v_id_34_stat_c from t34_status where cve_tab = 'E' and cve_stat = 'C';
SELECT id_34_stat INTO v_id_34_stat_v from t34_status where cve_tab = 'E' and cve_stat = 'V';

SELECT count(*) INTO v_contador FROM t34_pagos a, t34_status b  
WHERE a.id_datos = par_id_34_datos AND a.periodo >= par_Axo_Ini || '-' || par_Mes_Ini  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('P','R','S');
if v_contador > 0 then
	Let v_estatus = -1;
	Let v_leyenda = 'Tiene registros PAGADO,PRESCRITO � CONDONADO igual � posterior al periodo, no es posible el CAMBIO';
else
	if par_Axo_Ini > axo_actual then
		Let v_leyenda = 'El A�o de Inicio no puede ser Mayor al A�o Actual';
		Let v_estatus = -1;
	else
		if par_Axo_Ini <= axo_penultimo then
			Let v_leyenda = 'El A�o de Inicio no puede ser Menor 2 � m�s a�os que el A�o Actual';
			Let v_estatus = -1;
		else
			-- busca unidad del contrato
			SELECT a.id_unidad, b.descripcion INTO v_id_unidad_cont, v_descrip_cont  
			FROM t34_datos a, t34_unidades b  WHERE a.id_34_datos = par_id_34_datos and b.id_34_unidad = a.id_unidad;

			-- buscar el registro tipo_var del a�o de inicio
			foreach
			SELECT tipo_var INTO v_tipo_var FROM t34_pagos a, t34_status b  WHERE a.id_datos = par_id_34_datos 
			AND Year(periodo) = par_Axo_Ini  AND a.periodo >= par_Axo_Ini || '-' || par_Mes_Ini   AND tipo_var in ('A','T')  
			AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V')
			if v_cuento = 0 then
				Let v_tipo_var_fijo = v_tipo_var;
				Let v_cuento = 1;
			end if;
			end foreach;
			if v_tipo_var is Null then
				Let v_leyenda = 'No se encontro periodo alguno vigente para ACTUALIZARa partir del A�o de Inicio';
				Let v_estatus = -1;
			else
				-- buscar el id de la unidad para Actualizar el contrato
				SELECT id_34_unidad  INTO v_id_unidad_und  
				FROM t34_unidades Where cve_tab = par_tabla AND ejercicio = par_Axo_Ini  AND cve_unidad = v_tipo_var_fijo  AND descripcion = par_Descrip;

				if v_descrip_cont = par_Descrip then
					Let v_leyenda = 'La Unidad es la misma, no hay nada que Actualizar';
					Let v_estatus = -1;
				else
					--INICIO ACTUALIZAR PERIODOS
					-- A�O ACTUAL
					if par_Axo_Ini = axo_actual then
						-- actualizar el id_unidad del contrato
						UPDATE t34_datos SET  id_unidad = v_id_unidad_und, usuario = par_usuario  WHERE id_34_datos = par_id_34_datos;

						-- buscar v_tipo_var del par_Axo_Ini
						foreach
						SELECT tipo_var INTO v_tipo_var FROM t34_pagos  WHERE id_datos = par_id_34_datos  
						AND Year(periodo) = par_Axo_Ini  AND tipo_var in ('A','T')
						if v_cuento = 0 then
							Let v_tipo_var_fijo = v_tipo_var;
							Let v_cuento = 1;
						end if;
						end foreach;

						-- actualizar adeudos con el nuevo importe
						EXECUTE PROCEDURE upd34_gen_adeudos ( par_tabla, par_id_34_datos, 
						par_sup, par_Axo_Ini, par_Mes_Ini, par_Descrip, v_tipo_var_fijo, par_usuario )  INTO v1_estatus, v1_leyenda;
						if v1_estatus = 1 then
							Let v_leyenda    	= v1_leyenda;
							Let v_estatus	= v1_estatus;
						else
							Let v_leyenda    	= v1_leyenda;
							Let v_estatus	= v1_estatus;
						end if;
					end if;

					-- A�O ANTERIOR Y ACTUAL
					if par_Axo_Ini < axo_actual then
						-- actualizar el id_unidad del contrato
						UPDATE t34_datos SET  id_unidad = v_id_unidad_und, usuario = par_usuario  WHERE id_34_datos = par_id_34_datos;

						-- buscar v_tipo_var del par_Axo_Ini
						foreach
						SELECT tipo_var INTO v_tipo_var FROM t34_pagos  WHERE id_datos = par_id_34_datos  
						AND Year(periodo) = par_Axo_Ini  AND tipo_var in ('A','T')
						if v_cuento = 0 then
							Let v_tipo_var_fijo = v_tipo_var;
							Let v_cuento = 1;
						end if;
						end foreach;

  						-- actualizar adeudos con el nuevo importe
						EXECUTE PROCEDURE upd34_gen_adeudos ( par_tabla, par_id_34_datos, par_sup, par_Axo_Ini, par_Mes_Ini, 
						par_Descrip, v_tipo_var_fijo, par_usuario )  INTO v1_estatus, v1_leyenda;
						if v1_estatus = 1 then
							-- REGISTRAR ADEUDOS DEL EJERCICIO ACTUAL
							EXECUTE PROCEDURE upd34_gen_adeudos ( par_tabla, par_id_34_datos, par_sup, axo_actual, 01, 
							par_Descrip, 'T', par_usuario )  INTO v2_estatus, v2_leyenda;
							if v2_estatus = 1 then
								Let v_leyenda    	= v2_leyenda;
								Let v_estatus	= v2_estatus;
							else
								Let v_leyenda    	= v2_leyenda;
								Let v_estatus	= v2_estatus;
							end if;
						else
							Let v_leyenda    	= v1_leyenda;
							Let v_estatus	= v1_estatus;
						end if;


					end if;
					-- FIN ACTUALIZAR PERIODOS
				end if;
			end if;	

		end if;
	end if;
end if;

	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "informix".upd34_gen_sup ( par_tabla Char(1), par_id_34_datos Integer, par_sup Money(7,2), par_Descrip Char(100), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_usuario char(10) )
{######################################################################
#  Procedimiento:    upd34_gen_sup
#  Descripcion:      Interfaz de ACTUALIZA datos en registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	
#		     	par_id_34_datos = id del registro a cambio de datos
#		     	par_sup = superficie
#                    		par_Descrip = descripcion del la unidad
#                    		par_Axo_Ini = A�o de inicio de la superficie
#                    		par_Mes_Ini = Mes de inicio de la superficie
#  			par_usuario = usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
	returning Integer as Status,    	          -- Status
		varchar(100) as Concepto_Status;     -- Concepto status
-----------Define las variables de retorno----------------
define v_leyenda    		varchar(255);
define v_estatus 		int;

define v1_estatus 		int;
define v1_leyenda    		varchar(255);
define v2_estatus 		int;
define v2_leyenda    		varchar(255);

define v_contador		int;
define v_cuento		int;
define v_tipo_var		char(1);
define v_tipo_var_fijo	char(1);
define axo_actual		int;
define axo_penultimo	int;
define v_id_34_stat_c 	int;
define v_id_34_stat_v 	int;
define v_id_34_unidad	int;
define v_superficie		decimal(7,2);
define v_id_unidad		int;

define v_lError     		int;
define v_lISAMError 		int;
define v_vcMensaje  	varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion upd34_gen_superficie ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_leyenda    	= 'No se actualizo';
Let v_estatus	= -1;

Let v1_estatus 	= 0;
Let v1_leyenda    	= 'NO SE ACTUALIZARON ADEUDOS, REVISAR';
Let v2_estatus 	= 0;
Let v2_leyenda    	= 'NO SE ACTUALIZARON ADEUDOS, REVISAR';

Let v_contador	= 0;
Let v_cuento	= 0;
Let v_tipo_var 	= '';
Let v_tipo_var_fijo	= '';
Let axo_actual 	= Year(Current);
Let axo_penultimo	= axo_actual - 2;
Let v_id_34_stat_c	= 0;
Let v_id_34_stat_v	= 0;

Let v_superficie	= 0;
Let v_id_unidad	= 0;
Let v_id_34_unidad	= 0;

SELECT id_34_stat INTO v_id_34_stat_c from t34_status where cve_tab = 'E' and cve_stat = 'C';
SELECT id_34_stat INTO v_id_34_stat_v from t34_status where cve_tab = 'E' and cve_stat = 'V';

SELECT count(*) INTO v_contador FROM t34_pagos a, t34_status b  
WHERE a.id_datos = par_id_34_datos AND a.periodo >= par_Axo_Ini || '-' || par_Mes_Ini  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('P','R','S');
if v_contador > 0 then
	Let v_estatus = -1;
	Let v_leyenda = 'Tiene registros PAGADO,PRESCRITO � CONDONADO igual � posterior al periodo, no es posible el CAMBIO';
else
	if par_Axo_Ini > axo_actual then
		Let v_leyenda = 'El A�o de Inicio no puede ser Mayor al A�o Actual';
		Let v_estatus = -1;
	else
		if par_Axo_Ini <= axo_penultimo then
			Let v_leyenda = 'El A�o de Inicio no puede ser Menor 2 a�os que el A�o Actual';
			Let v_estatus = -1;
		else
			-- buscar el registro tipo_var del a�o de inicio
			foreach
			SELECT tipo_var INTO v_tipo_var FROM t34_pagos a, t34_status b  WHERE a.id_datos = par_id_34_datos 
			AND Year(periodo) = par_Axo_Ini  AND a.periodo >= par_Axo_Ini || '-' || par_Mes_Ini   AND tipo_var in ('A','T')  
			AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V')
			if v_cuento = 0 then
				Let v_tipo_var_fijo = v_tipo_var;
				Let v_cuento = 1;
			end if;
			end foreach;
			if v_tipo_var is Null then
				Let v_leyenda = 'No se encontro periodo alguno vigente para ACTUALIZARa partir del A�o de Inicio';
				Let v_estatus = -1;
			else
				-- busca superficie
				SELECT superficie INTO v_superficie  FROM t34_datos  WHERE id_34_datos = par_id_34_datos;
				if par_sup = v_superficie then
					Let v_leyenda = 'La Superficie es igual, no hay nada que Actualizar';
					Let v_estatus = -1;
				else
					--INICIO ACTUALIZAR PERIODOS
					-- A�O ACTUAL
					if par_Axo_Ini = axo_actual then 
						-- actualizar el superficie del contrato 
						UPDATE t34_datos SET  superficie = par_sup, usuario = par_usuario  WHERE id_34_datos = par_id_34_datos;

						-- buscar v_tipo_var del par_Axo_Ini
						foreach
						SELECT tipo_var INTO v_tipo_var FROM t34_pagos  WHERE id_datos = par_id_34_datos  
						AND Year(periodo) = par_Axo_Ini  AND tipo_var in ('A','T')
						if v_cuento = 0 then
							Let v_tipo_var_fijo = v_tipo_var;
							Let v_cuento = 1;
						end if;
						end foreach;

						-- actualizar adeudos con el nuevo importe
						EXECUTE PROCEDURE upd34_gen_adeudos ( par_tabla, par_id_34_datos, 
						par_sup, par_Axo_Ini, par_Mes_Ini, par_Descrip, v_tipo_var_fijo, par_usuario )  INTO v1_estatus, v1_leyenda;
						if v1_estatus = 1 then
							Let v_leyenda    	= v1_leyenda;
							Let v_estatus	= v1_estatus;
						else
							Let v_leyenda    	= v1_leyenda;
							Let v_estatus	= v1_estatus;
						end if;
					end if;

					-- A�O ANTERIOR Y ACTUAL
					if par_Axo_Ini < axo_actual then  
						-- actualizar el superficie del contrato 
						UPDATE t34_datos SET  superficie = par_sup, usuario = par_usuario  WHERE id_34_datos = par_id_34_datos;

						EXECUTE PROCEDURE upd34_gen_adeudos ( par_tabla, par_id_34_datos, 
						par_sup, par_Axo_Ini, par_Mes_Ini, par_Descrip, v_tipo_var_fijo, par_usuario )  INTO v1_estatus, v1_leyenda;
						if v1_estatus = 1 then
							-- REGISTRAR ADEUDOS DEL EJERCICIO ACTUAL
							EXECUTE PROCEDURE upd34_gen_adeudos ( par_tabla, par_id_34_datos, 
							par_sup, axo_actual, 01, par_Descrip, 'T', par_usuario )  INTO v2_estatus, v2_leyenda;
							if v2_estatus = 1 then
								Let v_leyenda    	= v2_leyenda;
								Let v_estatus	= v2_estatus;
							else
								Let v_leyenda    	= v2_leyenda;
								Let v_estatus	= v2_estatus;
							end if;
						else
							Let v_leyenda    	= v1_leyenda;
							Let v_estatus	= v1_estatus;
						end if;
					end if;
					-- FIN ACTUALIZAR PERIODOS
				end if;
			end if;
		end if;
	end if;
end if;

	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "informix".upd34_gen_oblig ( par_tabla Char(1), par_id_34_datos Integer, 
par_sup Money(7,2), par_Descrip Char(100), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_usuario char(10) )
{######################################################################
#  Procedimiento:    upd34_gen_oblig
#  Descripcion:      Interfaz de ACTUALIZA datos en registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	
#		     	par_id_34_datos = id del registro a cambio de datos
#		     	par_sup = superficie
#                    		par_Descrip = descripcion del la unidad
#                    		par_Axo_Ini = A�o de inicio de la superficie
#                    		par_Mes_Ini = Mes de inicio de la superficie
#  			par_usuario = usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
	returning Integer as Status,    	          -- Status
		varchar(100) as Concepto_Status;     -- Concepto status
-----------Define las variables de retorno----------------
define v_leyenda    		varchar(255);
define v_estatus 		int;

define vf_estatus 		int;
define vf_leyenda    		varchar(255);
define v1_estatus 		int;
define v1_leyenda    		varchar(255);
define v2_estatus 		int;
define v2_leyenda    		varchar(255);

define v_contador		int;
define v_cuento		int;
define v_tipo_var		char(1);
define v_tipo_var_fijo	char(1);
define axo_actual		int;
define axo_penultimo	int;
define v_id_34_stat_c 	int;
define v_id_34_stat_v 	int;
define v_id_unidad_cont	int;
define v_id_unidad_und	int;
define v_descrip_cont	char(100);
define v_descrip_und	char(100);
define v_superficie		decimal(7,2);
define v_periodo_inicio	int;
define v_axo_inicio, v_mes_inicio	int;
define v_lError     		int;
define v_lISAMError 		int;
define v_vcMensaje  	varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion upd34_gen_oblig ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_leyenda    	= 'No se actualizo';
Let v_estatus	= -1;

Let vf_estatus	= 0;
Let vf_leyenda    	= 'NO SE CREO EL REGISTRO DE LA FORMA';
Let v1_estatus 	= 0;
Let v1_leyenda    	= 'NO CREARON LOS ADEUDOS, REVISAR';
Let v2_estatus 	= 0;
Let v2_leyenda    	= 'NO CREARON LOS ADEUDOS, REVISAR';

Let v_contador	= 0;
Let v_cuento	= 0;
Let v_tipo_var 	= '';
Let v_tipo_var_fijo	= '';
Let axo_actual 	= Year(Current);
Let axo_penultimo	= axo_actual - 2;
Let v_id_34_stat_c	= 0;
Let v_id_34_stat_v	= 0;

Let v_superficie	= 0;
Let v_id_unidad_cont	= 0;
Let v_id_unidad_und	= 0;
Let v_periodo_inicio		= 0;
Let v_axo_inicio	= 0;
Let v_mes_inicio	= 0;

SELECT id_34_stat INTO v_id_34_stat_c from t34_status where cve_tab = 'E' and cve_stat = 'C';
SELECT id_34_stat INTO v_id_34_stat_v from t34_status where cve_tab = 'E' and cve_stat = 'V';

SELECT count(*) INTO v_contador FROM t34_pagos a, t34_status b  
WHERE a.id_datos = par_id_34_datos AND b.id_34_stat = a.id_stat AND b.cve_stat <> ('V');
if v_contador > 0 then
	Let v_estatus = -1;
	Let v_leyenda = 'Tiene adeudos PAGADOS,PRESCRITOS � CONDONADOS no es posible el CAMBIO';
else
	if par_Axo_Ini > axo_actual then
		Let v_leyenda = 'El A�o de Inicio no puede ser Mayor al A�o Actual';
		Let v_estatus = -1;
	else
		if par_Axo_Ini <= axo_penultimo then
			Let v_leyenda = 'El A�o de Inicio no puede ser Menor 2 � m�s a�os que el A�o Actual';
			Let v_estatus = -1;
		else
			SELECT Year(fecha_inicio), Month(fecha_inicio) INTO v_axo_inicio, v_mes_inicio FROM t34_datos WHERE id_34_datos = par_id_34_datos;
			Let v_periodo_inicio =  (v_axo_inicio *100 ) + v_mes_inicio;
			if v_periodo_inicio = (par_Axo_Ini *100 ) + par_Mes_Ini then
				Let v_leyenda = 'El Periodo de inicio de Obligaci�n es igual, por lo tanto no hay CAMBIO a realizar';	
				Let v_estatus = -1;
			else

				--  INICIO
				-- elimina todo adeudo generado con anterioridad
				DELETE FROM t34_pagos  WHERE id_datos = par_id_34_datos;

				-- buscar el id_unidad
				if par_tabla = '5' then  
					Let v_tipo_var = 'A';
				else
					Let v_tipo_var = 'T';
				end if;

				SELECT id_34_unidad INTO v_id_unidad_und 
				FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip and cve_unidad = v_tipo_var;

				-- actualiza el periodo de inicio de obligacion en el contrato
				UPDATE t34_datos SET  id_unidad = v_id_unidad_und, fecha_inicio = mdy(par_Mes_Ini,01,par_Axo_Ini), usuario = par_usuario  WHERE id_34_datos = par_id_34_datos;

				-- GENERACION DE EL ADEUDO POR LA FORMA
				EXECUTE PROCEDURE ins34_gen_forma ( par_tabla, par_id_34_datos, par_Axo_Ini, par_Mes_Ini ) INTO vf_estatus, vf_leyenda;

				if par_Axo_Ini = axo_actual then
					-- REGISTRAR ADEUDOS DEL EJERCICIO ACTUAL
					if par_tabla = '5' then  
						Let v_tipo_var = 'A';
					else
						Let v_tipo_var = 'T';
					end if;
					EXECUTE PROCEDURE ins34_gen_adeudos ( par_tabla, par_id_34_datos, par_sup, par_Axo_Ini, par_Mes_Ini, par_Descrip, v_tipo_var ) 
					INTO v1_estatus, v1_leyenda;
					if v1_estatus = 1 then
						Let v_leyenda    	= v1_leyenda;
						Let v_estatus	= v1_estatus;
					else
						Let v_leyenda    	= v1_leyenda;
						Let v_estatus	= v1_estatus;
					end if;
				end if;

				if par_Axo_Ini < axo_actual then
					-- REGISTRAR ADEUDOS DEL EJERCICIO ANTERIOR
					if par_tabla = '5' then  
						Let v_tipo_var = 'A';
					else
						Let v_tipo_var = 'T';
					end if;
					EXECUTE PROCEDURE ins34_gen_adeudos ( par_tabla, par_id_34_datos, par_sup, par_Axo_Ini, par_Mes_Ini, par_Descrip, v_tipo_var ) 
					INTO v1_estatus, v1_leyenda;
					if v1_estatus = 1 then
						-- REGISTRAR ADEUDOS DEL EJERCICIO ACTUAL
						EXECUTE PROCEDURE ins34_gen_adeudos ( par_tabla, par_id_34_datos, par_sup, axo_actual, 01, par_Descrip, 'T' ) 
						INTO v2_estatus, v2_leyenda;
						if v2_estatus = 1 then
							Let v_leyenda    	= v2_leyenda;
							Let v_estatus	= v2_estatus;
						else
							Let v_leyenda    	= v2_leyenda;
							Let v_estatus	= v2_estatus;
						end if;
					else
						Let v_leyenda    	= v1_leyenda;
						Let v_estatus	= v1_estatus;
					end if;
				end if;
				--  FIN
			end if;

		end if;
	end if;
end if;

	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "informix".upd34_gen_grales ( par_id_34_datos Integer, par_conces Char(200), par_ubica Char (200), 
par_lic Integer, par_nomcom Char (200), par_lugar Char (200), par_obs Char (200), par_usuario char(10) )
{######################################################################
#  Procedimiento:    upd34_gen_grales
#  Descripcion:      Interfaz de ACTUALIZA datos en registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	
#		     	par_id_34_datos = id del registro a cambio de datos
#		     	par_conces = concesionario
#                    		par_ubica = ubicacion
#                    		par_lic = licencia del giro
#                    		par_NomCom = nombre comercial
#                    		par_Lugar = lugar
#                    		par_Obs = observaciones
#  				par_usuario = usuario modifica
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
	returning Integer as status,    	          -- Status
		varchar(100) as concepto;     -- Concepto status
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define v_id_34_stat_concep_v	int;
define v_id_34_stat_concep_c	int;
define v_concesionario, v_ubicacion			char(200);
define v_licencia					int;
define v_concepto_N, v_concepto_L, v_concepto_O	char(200);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion upd34_gen_grales ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_leyenda    	= 'No se actualizo';
Let v_estatus	= -1;

Let v_id_34_stat_concep_v	= 0;
Let v_id_34_stat_concep_c	= 0;

Let v_concesionario		= '';
Let v_ubicacion		= '';
Let v_licencia		= 0;

SELECT id_34_stat INTO v_id_34_stat_concep_v FROM t34_status WHERE cve_tab = 'D' and cve_stat = 'V';
SELECT id_34_stat INTO v_id_34_stat_concep_c FROM t34_status WHERE cve_tab = 'D' and cve_stat = 'C';

SELECT concesionario, ubicacion, licencia INTO  v_concesionario, v_ubicacion, v_licencia  FROM t34_datos WHERE id_34_datos = par_id_34_datos;
SELECT concepto INTO  v_concepto_N  FROM t34_conceptos WHERE id_datos = par_id_34_datos and tipo = 'N';
SELECT concepto INTO  v_concepto_L   FROM t34_conceptos WHERE id_datos = par_id_34_datos and tipo = 'L';
SELECT concepto INTO  v_concepto_O  FROM t34_conceptos WHERE id_datos = par_id_34_datos and tipo = 'O';


-- CONCESIONARIO
if Trim(v_concesionario) <> Trim(par_conces) then
	if char_length(par_conces) >= 10 then
		UPDATE t34_datos SET  concesionario = par_conces, usuario = par_usuario	Where id_34_datos = par_id_34_datos;
		Let v_estatus = 1;
		Let v_leyenda = 'Se actualizo el dato del Concesionario';
	else
		Let v_estatus = -1;
		Let v_leyenda = 'El dato de Concesionario debe ser mayor a 10 digitos';
	end if;
end if;
	
-- UBICACION
if Trim(v_ubicacion) <> Trim(par_ubica) then
	if char_length(par_ubica) >= 10 then
		UPDATE t34_datos SET  ubicacion = par_ubica, usuario = par_usuario		Where id_34_datos = par_id_34_datos;
		Let v_estatus = 1;
		Let v_leyenda = 'Se actualizo el dato de Ubicacion';
	else
		Let v_estatus = -1;
		Let v_leyenda = 'El dato de Ubicacion debe ser mayor a 10 digitos';
	end if;
end if;
		

-- LICENCIA
if v_licencia <> par_lic then
	UPDATE t34_datos SET  licencia = par_lic, usuario = par_usuario		Where id_34_datos = par_id_34_datos;
	Let v_estatus = 1;
	Let v_leyenda = 'Se actualizo el dato de la Licencia';
end if;
		

-- NOMBRE COMERCIAL
if Trim(v_concepto_N) <>  Trim(par_nomcom) then
	if exists ( SELECT * from t34_conceptos Where id_datos = par_id_34_datos and tipo = 'N' ) then
		if Trim(par_nomcom) = 'nada' then
			UPDATE t34_conceptos SET  id_stat = v_id_34_stat_concep_c, usuario = par_usuario	Where id_datos = par_id_34_datos and tipo = 'N';
		else
                  		UPDATE t34_conceptos SET  concepto = par_nomcom, usuario = par_usuario		Where id_datos = par_id_34_datos and tipo = 'N';
		end if;
	else
		insert into t34_conceptos values ( 0, par_id_34_datos, 'N', par_nomcom, par_usuario, v_id_34_stat_concep_v );
	end if;
	Let v_estatus = 1;
	Let v_leyenda = 'Se actualizo el dato de Nombre Comercial';
end if;
		

-- LUGAR
if Trim(v_concepto_L) <> Trim(par_lugar) then
	if exists ( SELECT * from t34_conceptos Where id_datos = par_id_34_datos and tipo = 'L' ) then
		if par_lugar = 'nada' then
			UPDATE t34_conceptos SET  id_stat = v_id_34_stat_concep_c, usuario = par_usuario	Where id_datos = par_id_34_datos and tipo = 'L';
		else
                   		UPDATE t34_conceptos SET  concepto = par_lugar, usuario = par_usuario		Where id_datos = par_id_34_datos and tipo = 'L';
		end if;
	else
		insert into t34_conceptos values ( 0, par_id_34_datos, 'L', par_lugar, par_usuario, v_id_34_stat_concep_v );
	end if;
	Let v_estatus = 1;
	Let v_leyenda = 'Se actualizo el dato de Lugar';
end if;
		

-- OBSERVACIONES
if Trim(v_concepto_O) <> Trim(par_obs) then
	if exists ( SELECT * from t34_conceptos Where id_datos = par_id_34_datos and tipo = 'O' ) then
		if par_obs = 'nada' then
			UPDATE t34_conceptos SET  id_stat = v_id_34_stat_concep_c, usuario = par_usuario	Where id_datos = par_id_34_datos and tipo = 'O';
		else
                  		UPDATE t34_conceptos SET  concepto = par_obs, usuario = par_usuario		Where id_datos = par_id_34_datos and tipo = 'O';
		end if;
	else
		insert into t34_conceptos values ( 0, par_id_34_datos, 'O', par_obs, par_usuario, v_id_34_stat_concep_v );
	end if;
	Let v_estatus = 1;
	Let v_leyenda = 'Se actualizo el dato de Observaciones';
end if;


	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "informix".sp34_upd_actas ( par_Opc Char(1), par_Dep_Multa integer, par_Id_34_datos integer, par_AxoActa integer, par_NumActa integer )
{######################################################################
#  Procedimiento:    sp34_upd_actas
#  Descripcion:      Interfaz de consulta de OTRAS OBLIGACIONES
#
#  Parametros        	par_Opc			=	'A'= ALTA/REACTIVA, 'D'=ELIMINA/DESLIGA, 'C'=CANCELA, 'P'=PAGADA 
#  de entrada:	par_Id_34_datos		=	Id del registro de datos
#		par_AxoActa		= 	A�o de Acta
#		par_NumActa		= 	Numero de Acta
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento Modulo de OTRAS OBLIGACIONES Mantenimiento de Multas Ligadas
#  
######################################################################}
                returning  int as status,
		varchar(255) as leyenda;
define v_leyenda                                                                        	varchar(255);
define v_status, v_id_usuario, v_numero, v_id_multa	Int;
define v_vigencia					char(1);
define v_id_alta					Int;

define v_cvepago, v_id_prescri			int;
define v_fecha_cancelacion				date;

Let v_id_alta = 0;
Let v_id_multa = 0;
Let v_numero = 0;
Let v_id_usuario = 0;
Let v_status = 0;
Let v_leyenda = 'NO TIENE ADEUDO';
Let v_vigencia = ' ';

if exists( SELECT * FROM t34_rel_multas WHERE id_34_datos = par_Id_34_datos ) then

	if exists( SELECT * from catastro_gdl:multas
     		WHERE id_dependencia = par_Dep_Multa and axo_acta = par_AxoActa and num_acta = par_NumActa ) then

		SELECT id_multa  INTO v_id_multa  FROM catastro_gdl:multas
     		WHERE id_dependencia = par_Dep_Multa and axo_acta = par_AxoActa and num_acta = par_NumActa;
			
			if exists( SELECT * FROM t34_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and id_34_datos = par_Id_34_datos ) then

				SELECT count(*) INTO v_numero FROM t34_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and id_34_datos = par_Id_34_datos;

				SELECT vigencia INTO v_vigencia FROM t34_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and id_34_datos = par_Id_34_datos;

				if v_numero = 1 then
					if par_Opc = 'D' then
						DELETE FROM t34_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
						AND axo_acta = par_AxoActa and num_acta = par_NumActa  and id_34_datos = par_Id_34_datos;
                  					Let v_status	= 1;
						Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO ELIMINADA/DESLIGADA ';
					end if;
					if par_Opc = 'C' then
						if v_vigencia <> 'C' then
							UPDATE t34_rel_multas  SET  vigencia = 'C'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and id_34_datos = par_Id_34_datos;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO CANCELADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA CANCELADA';
						end if;
					end if;
					if par_Opc = 'P' then
						if v_vigencia <> 'P' then
							UPDATE t34_rel_multas  SET  vigencia = 'P'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and id_34_datos = par_Id_34_datos;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO DADA COMO PAGADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA COMO PAGADA';
						end if;
					end if;
					if par_Opc = 'A' then
						if v_vigencia <> 'V' then
							UPDATE t34_rel_multas  SET  vigencia = 'V'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and id_34_datos = par_Id_34_datos;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO REACTIVADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA  ACTIVA';
						end if;
					end if;
				else
					Let v_status	= -1;
					Let v_leyenda	= 'El Acta '||par_AxoActa||' - '||par_NumActa|| ' esta relacionada con mas de 1 Estacionamiento, avisar a DPD';
				end if;
			else
				if exists( SELECT * FROM t34_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
					AND axo_acta = par_AxoActa and num_acta = par_NumActa ) then
                  				Let v_status	= -1;
					Let v_leyenda	= 'LA MULTA EXISTE RELACIONADA  A OTRO ESTACIONAMIENTO';
				else
					if par_Opc = 'A' then			
						INSERT INTO t34_rel_multas values ( v_id_multa, par_Dep_Multa, par_AxoActa, par_NumActa, par_Id_34_datos, 'V' );
						Let v_status	= 1;
						Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO ACTIVADA';
					else
                  					Let v_status	= -1;
						Let v_leyenda	= 'EL MANNTO. A LA MULTA NO PUEDE SER, NO ESTA  ACTIVADA/REGISTRADA';
					end if;
				end if;
			end if;
	else
                  	Let v_status	= -1;
		Let v_leyenda	= 'NO EXISTE LA MULTA EN CATASTRO';
	end if;
else
                  Let v_status	= -1;
	Let v_leyenda	= 'NO EXISTE EL ESTACIONAMIENTO DIGITADO';
end if;
               RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "informix".sp34_padron ( par_Tabla Char(1), par_Vigencia VarChar(50) )
{######################################################################
#  Procedimiento:    sp34_padron
#  Descripcion:      Interfaz de PADRON de registros de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		par_Vigencia = 'VIGENTE', 'CANCELADO', 'SUSPENDIDO', 'TODOS'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:              
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
	returning	Integer as Id_34_Datos,
		char(15) as Control,
                               	VarChar(200) as Concesionario,
                               	VarChar(200) as Ubicacion,
                               	VarChar(200) as NomComercial,
                               	VarChar(200) as Lugar,
                               	VarChar(200) as Obs,
		VarChar(50) as StatusRegistro,

		VarChar(100) as Unidades,
		Char(15) as Categoria,
		Char(10) as Seccion,
		Char(10) as Bloque,

		Char(1) as Sector,
                               	Decimal(7,2) as Superficie,
		Date as FechaInicio,
		Date as FechaFin,

                               	Integer as Recaudadora,
                               	Integer as Zona,
                               	Integer as Licencia,
                               	Integer as Giro,
		VarChar(50) as tipoObligacion;
               

  define v_control							Char(15);
  define v_seccion, v_bloque 						Char(10);
  define v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs		VarChar(200);
  define v_status, v_tipoObligacion					VarChar(50);
  define v_unidades 							VarChar(100);
  define v_categoria 							Char(15);
  define v_sector							Char(1);
  define v_superficie							Decimal(7,2);
  define v_fecha_inicio, v_fecha_fin					Date;
  define v_id_34_datos, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro	Integer;


Let v_id_34_datos = 0;
Let v_id_recaudadora = 0;
Let v_id_zona = 0;
Let v_licencia = 0;
Let v_id_giro = 0;
Let v_superficie = 0;

Let v_concesionario = '';
Let v_ubicacion = '';
Let v_nom_comercial = '';
Let v_lugar = '';
Let v_obs = '';
Let v_sector = '';
Let v_status = '';
Let v_unidades = '';
Let v_categoria = '';
Let v_control = '';
Let v_seccion = '';
Let v_bloque = '';
Let v_tipoObligacion = '';

Let v_fecha_inicio = mdy(01,01,1900);
Let v_fecha_fin = mdy(01,01,1900);

if Trim(par_Vigencia) = 'TODOS' then 
	foreach 
                	SELECT a.id_34_datos, a.control, a.concesionario, a.ubicacion, (z.descripcion) status, (f.descripcion) unidades, a.sector, a.superficie, a.fecha_inicio, a.fecha_fin, 
	a.id_recaudadora, a.id_zona, a.licencia

	INTO v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_status, v_unidades, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, 
	v_id_recaudadora, v_id_zona, v_licencia

	FROM t34_datos A, t34_status Z, t34_unidades F
	WHERE a.cve_tab = par_Tabla
	AND Z.id_34_stat = A.id_stat and z.descripcion <> 'TODOS'
	AND F.id_34_unidad = A.id_unidad
	Order by a.id_34_datos, a.control

		SELECT (a.concepto) nom_comercial  INTO  v_nom_comercial  FROM t34_conceptos a, t34_status b 
		where a.id_datos = v_id_34_datos and a.tipo = 'N'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		SELECT (a.concepto) lugar  INTO  v_lugar  FROM t34_conceptos a, t34_status b 
		where a.id_datos = v_id_34_datos and a.tipo = 'L'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		SELECT (a.concepto) obs  INTO  v_obs  FROM t34_conceptos a, t34_status b 
		where a.id_datos = v_id_34_datos and a.tipo = 'O'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		SELECT a.categoria, a.seccion, a.bloque INTO v_categoria, v_seccion, v_bloque  FROM t34_adicionales a, t34_status b 
		where a.id_datos = v_id_34_datos  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		if v_licencia > 0 then
			if exists( SELECT * FROM catastro_gdl:licencias where licencia = v_licencia ) then
				SELECT id_giro INTO v_id_giro  FROM catastro_gdl:licencias where licencia = v_licencia;
			else
				Let v_id_giro = 0;
			end if;
		else
			Let v_id_giro = 0;
		end if;
	
		SELECT tipo_Obligacion INTO v_tipoObligacion FROM t34_ctasaplic WHERE cve_tab = par_Tabla AND tipo_var = 'T';

	RETURN v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs, v_status, v_unidades, v_categoria, 
		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion	with resume;
	end foreach;
else
	foreach 
                	SELECT a.id_34_datos, a.control, a.concesionario, a.ubicacion, (z.descripcion) status, (f.descripcion) unidades, a.sector, a.superficie, a.fecha_inicio, a.fecha_fin, 
	a.id_recaudadora, a.id_zona, a.licencia

	INTO v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_status, v_unidades, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, 
	v_id_recaudadora, v_id_zona, v_licencia

	FROM t34_datos A, t34_status Z, t34_unidades F
	WHERE a.cve_tab = par_Tabla
	AND Z.id_34_stat = A.id_stat and z.descripcion = Trim(par_Vigencia)
	AND F.id_34_unidad = A.id_unidad
	Order by a.id_34_datos, a.control

		SELECT (a.concepto) nom_comercial  INTO  v_nom_comercial  FROM t34_conceptos a, t34_status b 
		where a.id_datos = v_id_34_datos and a.tipo = 'N'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		SELECT (a.concepto) lugar  INTO  v_lugar  FROM t34_conceptos a, t34_status b 
		where a.id_datos = v_id_34_datos and a.tipo = 'L'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		SELECT (a.concepto) obs  INTO  v_obs  FROM t34_conceptos a, t34_status b 
		where a.id_datos = v_id_34_datos and a.tipo = 'O'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		SELECT a.categoria, a.seccion, a.bloque INTO v_categoria, v_seccion, v_bloque  FROM t34_adicionales a, t34_status b 
		where a.id_datos = v_id_34_datos  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

		if v_licencia > 0 then
			if exists( SELECT * FROM catastro_gdl:licencias where licencia = v_licencia ) then
				SELECT id_giro INTO v_id_giro  FROM catastro_gdl:licencias where licencia = v_licencia;
			else
				Let v_id_giro = 0;
			end if;
		else
			Let v_id_giro = 0;
		end if;
	
		SELECT tipo_Obligacion INTO v_tipoObligacion FROM t34_ctasaplic WHERE cve_tab = par_Tabla AND tipo_var = 'T';

	RETURN v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs, v_status, v_unidades, v_categoria, 
		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion	with resume;
	end foreach;
end if;
                                          
end procedure;

CREATE PROCEDURE "informix".con34_gfact_02 ( par_Tabla Char(1), par_Ade Char(1), par_Rcgo Char(1), par_Axo Smallint, par_Mes Smallint )
                returning Char(10) as Control,
                               VarChar(200) as Concesionario,
                               Decimal(7,2) as Superficie,
                               VarChar(100) as Tipo,
                               Integer as Licencia,
                               Money(15,2) as Importe;
               

{
#  Procedimiento: con34_Gfact_02
#  Descripcion:  Opciones : Consulta_Facturacion
#  Parametros de entrada: opci�n de reporte, con o sin recargos y periodo de corte
#  Parametros de salida:   Control, concesionario, superficie, tipo de local, licencia e importe con y sin recargos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--**********************************************************************************************
  define v_control							Char(10);
  define v_concesionario                                                                                         VarChar(200);
  define v_superficie                                                                                                Decimal(7,2);
  define v_descripcion                                                                                             VarChar(100);
  define v_licencia, v_id_34_datos, v_id_34_pagos                                               Integer;
  define v_importe, v_recargo, v_por_recargo, v_importe_rgo, v_importe_total      Money(12,2);
  define v_cve_stat, v_limite                                                                                   Char(1);
  define v_periodo                                                                                                   Date;

  define v_Periodo_CN, r_Periodo_CN					varchar(7);
  define Dia_v, Mes_v                                                                                             Smallint;
--set debug file to "rfact01";
--trace on;
--************************************************************************

  SELECT Month(fechalimite), Day(fechalimite)  INTO Mes_v, Dia_v
	FROM t34_fechalimite
	WHERE cve_tab = par_tabla
	AND Month(fechalimite) = Month(Current)  AND Year(fechalimite) = Year(Current);

     if Day(Current) > Dia_v then
         Let v_limite = 'S';
      else
         Let v_limite = 'N';
      end if;

                EXECUTE PROCEDURE con34_glperiodo ( par_Tabla ) INTO v_Periodo_CN;  
  -- pedazo adicionado
  Let r_Periodo_CN = v_Periodo_CN;



FOREACH
                SELECT a.id_34_datos, a.control, a.concesionario, a.superficie, a.licencia, b.descripcion  INTO v_id_34_datos, v_control, v_concesionario, v_superficie, v_licencia, v_descripcion 
                               FROM t34_datos a, t34_unidades b
                              WHERE a.cve_tab = par_Tabla  AND b.id_34_unidad = a.id_unidad
                               ORDER BY a.control
                
                               if par_Ade = 'A' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
                                               Let v_recargo = 0;
                                               if exists( SELECT a.*  FROM t34_pagos a, t34_status b   WHERE a.id_datos = v_id_34_datos 
                                                               AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V','P') ) then
                                                               SELECT a.periodo, a.importe, a.recargo, a.id_34_pagos, b.cve_stat  INTO v_periodo, v_importe, v_recargo, v_id_34_pagos, v_cve_stat 
                                                               FROM t34_pagos a, t34_status b 
                                                               WHERE a.id_datos = v_id_34_datos AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V','P');

                                                               if v_cve_stat = 'V'  then
                                                                              if par_Rcgo = 'S' then
                                                                                                              if v_importe > 0 then 
                                                                                                                             --if v_limite = 'S' then
                                                                                                                                             Select sum(por_recargo) 
                                                                                                                                             Into v_por_recargo
                                                                                                                                             From t34_porcentajes 
                                                                                                                                             Where periodo_porc between (v_periodo) and (v_Periodo_CN);

                                                                                                                             		if v_por_recargo > 0 then
                                                                                                                                                             	Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
                                                                                                                                             	else
                                                                                                                                                             	Let v_importe_rgo = 0;
                                                                                                                                             	end if;
                                                                                                              		--else
                                                                                                                             		--Let v_importe_rgo = 0;
                                                                                                                             	--end if;
                                                                                              		else
                                                                                                              		Let v_importe_rgo = 0;
                                                                                              		end if;
                                                                              else
                                                                                              Let v_importe_rgo = 0;
                                                                              end if;
                                                                              Let v_importe_total = v_importe + v_importe_rgo;
                                                               else
                                                                              Let v_importe_total = v_importe + v_recargo;
                                                               end if;
                                                                              RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, v_importe_total  with resume;
                                               else
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, 0  with resume;
                                                end if;
                               end if;
                               if par_Ade = 'B' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
                                               Let v_recargo = 0;
                                               if exists( SELECT a.*  FROM t34_pagos a, t34_status b   WHERE a.id_datos = v_id_34_datos 
                                                               AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V') ) then
                                                               SELECT a.periodo, a.importe, a.recargo, a.id_34_pagos, b.cve_stat  INTO v_periodo, v_importe, v_recargo, v_id_34_pagos, v_cve_stat 
                                                               FROM t34_pagos a, t34_status b 
                                                               WHERE a.id_datos = v_id_34_datos AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V');

                                                                              if par_Rcgo = 'S' then
						if v_importe > 0 then 
							--if v_limite = 'S' then
                                                                                                                	Select sum(por_recargo) 
                                                                                                                                Into v_por_recargo
                                                                                                                                From t34_porcentajes 
                                                                                                                                Where periodo_porc between (v_periodo) and (v_Periodo_CN);

								if v_por_recargo > 0 then
                                                                                                                                	Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
								else
									Let v_importe_rgo = 0;
								end if;
							--else
								--Let v_importe_rgo = 0;
							--end if;
						else
                                                                                                	Let v_importe_rgo = 0;
                                                                                              	end if;
                                                                              	else
                                                                                              Let v_importe_rgo = 0;
                                                                              	end if;
                                                               Let v_importe_total = v_importe + v_importe_rgo;
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, v_importe_total  with resume;
                                               else
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, 0  with resume;
                                               end if;
                               end if;
                               if par_Ade = 'C' then
                                               Let v_importe = 0;
                                               Let v_recargo = 0;
                                               Let v_importe_rgo = 0;
                                               Let v_por_recargo = 0;
                                               Let v_importe_total = 0;
                                               Let v_recargo = 0;
                                               if exists( SELECT a.*  FROM t34_pagos a, t34_status b   WHERE a.id_datos = v_id_34_datos 
                                                               AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('P') ) then
                                                               SELECT a.periodo, a.importe, a.recargo, a.id_34_pagos, b.cve_stat  INTO v_periodo, v_importe, v_recargo, v_id_34_pagos, v_cve_stat 
                                                               FROM t34_pagos a, t34_status b 
                                                               WHERE a.id_datos = v_id_34_datos AND periodo = par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('P');

                                                               if v_importe > 0 then
                                                                              Let v_importe_total = v_importe + v_recargo;
                                                               else
                                                                              Let v_importe_total = 0;
                                                               end if;                                                                 
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, v_importe_total  with resume;
                                               else
                                                               RETURN v_control, v_concesionario, v_superficie, v_descripcion, v_licencia, 0  with resume;
                                               end if;
                               end if;

END FOREACH;
--trace off;

                                           
end procedure;

CREATE PROCEDURE "informix".con34_gcont_01 ( par_Tabla Char(1), p_Adeudos Char(1), p_Axo Integer, p_Mes Integer )
{######################################################################
#  Procedimiento:    con34_GCont_01
#  Descripcion:      Interfaz Estadistico de Adeudos por Rubro de Ingreso de OTRAS OBLIGACIONES 
#
#  Parametros        par_Tabla     = Rubro de ingreso 
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            07 Enero 2014   
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning Char(10) as Control,
		VarChar(200) as Concesionario,
                               	VarChar(200) as Ubicacion,
                               	VarChar(200) as NomComercial,
                               	VarChar(200) as Lugar,
                               	VarChar(200) as Obs,
                               	VarChar(200) as Adicionales,
		VarChar(50) as StatusRegistro,
                                    VarChar(100) as Unidades,
                                    Char(15) as Categoria,
                               	Char(10) as Seccion,
                               	Char(10) as Bloque,
                               	Char(1) as Sector,
                		Decimal(7,2) as Superficie,
                               	Date as FechaInicio,
                               	Date as FechaFin,
                               	Integer as Recaudadora,
                               	Integer as Zona,
                               	Integer as Licencia,
                               	Integer as Giro,
                               	VarChar(50) as tipoObligacion,

              Money(12,2) as ADEUDOS_2007,    -- ADEUDOS 2007
              Money(12,2) as RECARGOS_2007,    -- RECARGOS 2007
              Money(12,2) as TOTAL_2007,
              Money(12,2) as ADEUDOS_2008,    -- ADEUDOS 2008
              Money(12,2) as RECARGOS_2008,    -- RECARGOS 2008
              Money(12,2) as TOTAL_2008,
              Money(12,2) as ADEUDOS_2009,    -- ADEUDOS 2009
              Money(12,2) as RECARGOS_2009,    -- RECARGOS 2009
              Money(12,2) as TOTAL_2009,
              Money(12,2) as ADEUDOS_2010,    -- ADEUDOS 2010
              Money(12,2) as RECARGOS_2010,    -- RECARGOS2010
              Money(12,2) as TOTAL_2010,
              Money(12,2) as ADEUDOS_2011,    -- ADEUDOS 2011
              Money(12,2) as RECARGOS_2011,    -- RECARGOS 2011
              Money(12,2) as TOTAL_2011,
              Money(12,2) as ADEUDOS_2012,    -- ADEUDOS 2012
              Money(12,2) as RECARGOS_2012,    -- RECARGOS 2012
              Money(12,2) as TOTAL_2012,
              Money(12,2) as ADEUDOS_2013,    -- ADEUDOS 2013
              Money(12,2) as RECARGOS_2013,    -- RECARGOS 2013
              Money(12,2) as TOTAL_2013,
              Money(12,2) as ADEUDOS_2014,    -- ADEUDOS 2014
              Money(12,2) as RECARGOS_2014,    -- RECARGOS 2014
              Money(12,2) as TOTAL_2014,
              Money(12,2) as ADEUDOS_2015,    -- ADEUDOS 2015
              Money(12,2) as RECARGOS_2015,    -- RECARGOS 2015
              Money(12,2) as TOTAL_2015,
              Money(12,2) as ADEUDOS_2016,    -- ADEUDOS 2016
              Money(12,2) as RECARGOS_2016,    -- RECARGOS 2016
              Money(12,2) as TOTAL_2016,
              Money(12,2) as ADEUDOS_2017,    -- ADEUDOS 2017
              Money(12,2) as RECARGOS_2017,    -- RECARGOS 2017
              Money(12,2) as TOTAL_2017,
              Money(12,2) as ADEUDOS_2018,    -- ADEUDOS 2018
              Money(12,2) as RECARGOS_2018,    -- RECARGOS 2018
              Money(12,2) as TOTAL_2018,

              Money(12,2) as TOTAL_ADEUDOS,          -- TOTAL DE ADEUDOS
              Money(12,2) as TOTAL_RECARGOS,    -- TOTAL DE RECARGOS
              Money(12,2) as TOTAL_GENERAL,

              Money(12,2) as MULTAS,    -- TOTAL DE MULTAS
              Money(12,2) as GASTOS,    -- TOTAL DE GASTOS

              varchar(255) as DATOS_DOCTOS,      -- DATOS DE REQUERIMIENTOS

                      Money(12,2) as TOTAL_PAGADO,
              Date as Primer_Adeudo;      -- FECHA DEL PRIMER ADEUDO

--**********************************************************************************************
  define v_id_34_datos, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro                    Integer;
  define v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs                          VarChar(200);
  define v_superficie                                                                                                                   Decimal(7,2);
  define v_fecha_inicio, v_fecha_fin, v_periodo_adeudo                                                          Date;
  define v_sector                                                                                                                           Char(1);
  define v_status, v_tipoObligacion                                                                                       VarChar(50);
  define v_unidades                                                                                                     VarChar(100);
  define v_categoria                                                                                                     Char(15);
  define v_control, v_seccion, v_bloque                                                                                             Char(10);
--************************************************************************
  define v_totAdeudos2007, v_TotRecargos2007                                            Money(12,2);
  define v_totAdeudos2008, v_TotRecargos2008                                            Money(12,2);
  define v_totAdeudos2009, v_TotRecargos2009                                            Money(12,2);
  define v_totAdeudos2010, v_TotRecargos2010                                            Money(12,2);
  define v_totAdeudos2011, v_TotRecargos2011                                            Money(12,2);
  define v_totAdeudos2012, v_TotRecargos2012                                            Money(12,2);
  define v_totAdeudos2013, v_TotRecargos2013                                            Money(12,2);
  define v_totAdeudos2014, v_TotRecargos2014                                            Money(12,2);
  define v_totAdeudos2015, v_TotRecargos2015                                            Money(12,2);
  define v_totAdeudos2016, v_TotRecargos2016                                            Money(12,2);
  define v_totAdeudos2017, v_TotRecargos2017                                            Money(12,2);
  define v_totAdeudos2018, v_TotRecargos2018                                            Money(12,2);

  define v_importe_multa, v_importe_gastos, v_tot_gastos     Money(12,2);
  define v_Datos                                                                                            varchar(120);
  define v_TotAdeudos_pagados, v_TotRecargos_pagados, v_TotDesctoRgos_pagados                            Money(12,2);

-- set debug file to 'Gil3.log';
-- trace on;   

Let v_id_34_datos = 0;
Let v_id_recaudadora = 0;
Let v_id_zona = 0;
Let v_licencia = 0;
Let v_id_giro = 0;
Let v_superficie = 0;

Let v_concesionario = '';
Let v_ubicacion = '';
Let v_nom_comercial = '';
Let v_lugar = '';
Let v_obs = '';
Let v_sector = '';
Let v_status = '';
Let v_unidades = '';
Let v_categoria = '';
Let v_control = '';
Let v_seccion = '';
Let v_bloque = '';
Let v_tipoObligacion = '';

LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_totAdeudos2016 = 0;
LET v_TotRecargos2016 = 0;
LET v_totAdeudos2017 = 0;
LET v_TotRecargos2017 = 0;
LET v_totAdeudos2018 = 0;
LET v_TotRecargos2018 = 0;

LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;
LET v_Datos = '';

LET v_TotAdeudos_pagados = 0;
LET v_TotRecargos_pagados = 0;
LET v_TotDesctoRgos_pagados = 0;

Let v_fecha_inicio = mdy(01,01,1900);
Let v_fecha_fin = mdy(01,01,1900);
Let v_periodo_adeudo = Null;

FOREACH
                SELECT a.id_34_datos, a.control, a.concesionario, a.ubicacion, (c.concepto) nom_comercial, (d.concepto) lugar, (e.concepto) obs, 
                               (z.descripcion) status, (f.descripcion) unidades, b.categoria, b.seccion, b.bloque, a.sector, a.superficie, a.fecha_inicio, a.fecha_fin, 
                               a.id_recaudadora, a.id_zona, a.licencia

                               INTO v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs, 
                               v_status, v_unidades, v_categoria, v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, 
                               v_id_recaudadora, v_id_zona, v_licencia

                               FROM t34_datos A, t34_status Z, t34_unidades F, OUTER t34_adicionales B, OUTER t34_conceptos C, OUTER t34_conceptos D,OUTER t34_conceptos E
                                               WHERE a.cve_tab = par_Tabla
                                               AND B.id_datos = A.id_34_datos  
                                               AND C.id_datos = A.id_34_datos and C.tipo = 'N'
                                               AND D.id_datos = A.id_34_datos and D.tipo = 'L'
                                               AND E.id_datos = A.id_34_datos and E.tipo = 'O'
                                               AND Z.id_34_stat = A.id_stat
                                               AND F.id_34_unidad = A.id_unidad
                                               ORDER BY a.control

		if v_licencia > 0 then
                                    	if exists( SELECT * FROM catastro_gdl:licencias where licencia = v_licencia ) then
                                                      	SELECT id_giro INTO v_id_giro  FROM catastro_gdl:licencias where licencia = v_licencia;
			else
                                                      	Let v_id_giro = 0;
			end if;
		else
                                    	Let v_id_giro = 0;
		end if;   
                               	SELECT tipo_Obligacion INTO v_tipoObligacion FROM t34_ctasaplic WHERE cve_tab = par_Tabla AND tipo_var = 'T';

		FOREACH  
                                    EXECUTE PROCEDURE con34_GAdeudos_01 ( par_Tabla, v_id_34_datos, p_Axo , p_Mes ) 
                                    	INTO     v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2008, v_TotRecargos2008, 
                                                      	v_totAdeudos2009, v_TotRecargos2009, v_totAdeudos2010, v_TotRecargos2010, 
                                                                        v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2012, v_TotRecargos2012, 
                                                                        v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2014, v_TotRecargos2014,
                                                                        v_totAdeudos2015, v_TotRecargos2015, v_totAdeudos2016, v_TotRecargos2016, 
                                                                        v_totAdeudos2017, v_TotRecargos2017, v_totAdeudos2018, v_TotRecargos2018,
				v_importe_multa, v_tot_gastos, v_Datos, v_periodo_adeudo
                               	END FOREACH;
		FOREACH  
                                    EXECUTE PROCEDURE con34_GPagado_01 ( v_id_34_datos, p_Axo , p_Mes ) 
                                    		INTO     v_TotAdeudos_pagados, v_TotRecargos_pagados, v_TotDesctoRgos_pagados
                               	END FOREACH;

IF p_Adeudos = 'S' THEN  -- CON ADEUDO ALGUNO
	IF (v_totAdeudos2007 <> 0 or v_TotRecargos2007 <> 0 or
       		v_totAdeudos2008 <> 0 or v_TotRecargos2008 <> 0 or
       		v_totAdeudos2009 <> 0 or v_TotRecargos2009 <> 0 or 
       		v_totAdeudos2010 <> 0 or v_TotRecargos2010 <> 0 or 
       		v_totAdeudos2011 <> 0 or v_TotRecargos2011 <> 0 or
       		v_totAdeudos2012 <> 0 or v_TotRecargos2012 <> 0 or 
       		v_totAdeudos2013 <> 0 or v_TotRecargos2013 <> 0 or 
       		v_totAdeudos2014 <> 0 or v_TotRecargos2014 <> 0 or 
       		v_totAdeudos2015 <> 0 or v_TotRecargos2015 <> 0 or 
       		v_totAdeudos2016 <> 0 or v_TotRecargos2016 <> 0 or
       		v_totAdeudos2017 <> 0 or v_TotRecargos2017 <> 0 or
               		v_totAdeudos2018 <> 0 or v_TotRecargos2018 <> 0 or 
		v_importe_multa <> 0 or v_tot_gastos <> 0)  THEN
                		RETURN v_control, Trim(v_concesionario), Trim(v_ubicacion), Trim(v_nom_comercial), Trim(v_lugar), Trim(v_obs), Null, v_status, v_unidades, v_categoria, 
                               		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion, 
                               	v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2007 + v_TotRecargos2007, 
                               	v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2008 + v_TotRecargos2008, 
                               	v_totAdeudos2009, v_TotRecargos2009, v_totAdeudos2009 + v_TotRecargos2009,  
                               	v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2010 + v_TotRecargos2010, 
                               	v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2011 + v_TotRecargos2011, 
                               	v_totAdeudos2012, v_TotRecargos2012, v_totAdeudos2012 + v_TotRecargos2012,  
                               	v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2013 + v_TotRecargos2013,  
                               	v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2014 + v_TotRecargos2014, 
                               	v_totAdeudos2015, v_TotRecargos2015, v_totAdeudos2015 + v_TotRecargos2015,
                               	v_totAdeudos2016, v_TotRecargos2016, v_totAdeudos2016 + v_TotRecargos2016,
		v_totAdeudos2017, v_TotRecargos2017, v_totAdeudos2017 + v_TotRecargos2017,
		v_totAdeudos2018, v_TotRecargos2018, v_totAdeudos2018 + v_TotRecargos2018,

                               	v_totAdeudos2007 + v_totAdeudos2008 + v_totAdeudos2009 + 
                               	v_totAdeudos2010 + v_totAdeudos2011 + v_totAdeudos2012 + 
                               	v_totAdeudos2013 + v_totAdeudos2014 + v_totAdeudos2015 +
                                    v_totAdeudos2016 + v_totAdeudos2017,

                               	v_TotRecargos2007 + v_TotRecargos2008 + v_TotRecargos2009 + 
                               	v_TotRecargos2010 + v_TotRecargos2011 + v_TotRecargos2012 + 
                               	v_TotRecargos2013 + v_TotRecargos2014 + v_TotRecargos2015 +
                                    v_TotRecargos2016 + v_TotRecargos2017 + v_TotRecargos2018,

                               	v_totAdeudos2007 + v_TotRecargos2007 + v_totAdeudos2008 + v_TotRecargos2008 + v_totAdeudos2009 + v_TotRecargos2009 + 
                               	v_totAdeudos2010 + v_TotRecargos2010 + v_totAdeudos2011 + v_TotRecargos2011 + v_totAdeudos2012 + v_TotRecargos2012 + 
                               	v_totAdeudos2013 + v_TotRecargos2013 + v_totAdeudos2014 + v_TotRecargos2014 + v_totAdeudos2015 + v_TotRecargos2015 +
                                    v_totAdeudos2016 + v_TotRecargos2016 + v_totAdeudos2017 + v_TotRecargos2017 + v_totAdeudos2018 + v_TotRecargos2018,

                               	v_importe_multa, v_tot_gastos, v_Datos, 
                               	(v_TotAdeudos_pagados + v_TotRecargos_pagados) - v_TotDesctoRgos_pagados, 
                               	v_periodo_adeudo  with resume;
	END IF;
END IF;

IF p_Adeudos = 'R' THEN  -- CON SOLO ADEUDOS DE PERIODOS Y REQUERIMIENTOS EN CEROS
	IF ((v_totAdeudos2007 <> 0) or (v_TotRecargos2007 <> 0) or
       		(v_totAdeudos2008 <> 0) or (v_TotRecargos2008 <> 0) or
       		(v_totAdeudos2009 <> 0) or (v_TotRecargos2009 <> 0) or 
       		(v_totAdeudos2010 <> 0) or (v_TotRecargos2010 <> 0) or 
       		(v_totAdeudos2011 <> 0) or (v_TotRecargos2011 <> 0) or
       		(v_totAdeudos2012 <> 0) or (v_TotRecargos2012 <> 0) or
       		(v_totAdeudos2013 <> 0) or (v_TotRecargos2013 <> 0) or 
       		(v_totAdeudos2014 <> 0) or (v_TotRecargos2014 <> 0) or 
       		(v_totAdeudos2015 <> 0) or (v_TotRecargos2015 <> 0) or
               		(v_totAdeudos2016 <> 0) or (v_TotRecargos2016 <> 0) or 
		(v_totAdeudos2017 <> 0) or (v_TotRecargos2017 <> 0) or 
		(v_totAdeudos2018 <> 0) or (v_TotRecargos2018 <> 0)) AND
      		( v_importe_multa = 0 AND v_tot_gastos = 0)  THEN
                		RETURN v_control, Trim(v_concesionario), Trim(v_ubicacion), Trim(v_nom_comercial), Trim(v_lugar), Trim(v_obs), Null, v_status, v_unidades, v_categoria, 
                               		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion, 
                               	v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2007 + v_TotRecargos2007, 
                               	v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2008 + v_TotRecargos2008, 
                               	v_totAdeudos2009, v_TotRecargos2009, v_totAdeudos2009 + v_TotRecargos2009,  
                               	v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2010 + v_TotRecargos2010, 
                               	v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2011 + v_TotRecargos2011, 
                               	v_totAdeudos2012, v_TotRecargos2012, v_totAdeudos2012 + v_TotRecargos2012,  
                               	v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2013 + v_TotRecargos2013,  
                               	v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2014 + v_TotRecargos2014, 
                               	v_totAdeudos2015, v_TotRecargos2015, v_totAdeudos2015 + v_TotRecargos2015,
                               	v_totAdeudos2016, v_TotRecargos2016, v_totAdeudos2016 + v_TotRecargos2016,
		v_totAdeudos2017, v_TotRecargos2017, v_totAdeudos2017 + v_TotRecargos2017,
		v_totAdeudos2018, v_TotRecargos2018, v_totAdeudos2018 + v_TotRecargos2018,

                               	v_totAdeudos2007 + v_totAdeudos2008 + v_totAdeudos2009 + 
                               	v_totAdeudos2010 + v_totAdeudos2011 + v_totAdeudos2012 + 
                               	v_totAdeudos2013 + v_totAdeudos2014 + v_totAdeudos2015 +
                                    v_totAdeudos2016 + v_totAdeudos2017 + v_totAdeudos2018,

                               	v_TotRecargos2007 + v_TotRecargos2008 + v_TotRecargos2009 + 
                               	v_TotRecargos2010 + v_TotRecargos2011 + v_TotRecargos2012 + 
                               	v_TotRecargos2013 + v_TotRecargos2014 + v_TotRecargos2015 +
                                    v_TotRecargos2016 + v_TotRecargos2017 + v_TotRecargos2018,
 
                               	v_totAdeudos2007 + v_TotRecargos2007 + v_totAdeudos2008 + v_TotRecargos2008 + v_totAdeudos2009 + v_TotRecargos2009 + 
                               	v_totAdeudos2010 + v_TotRecargos2010 + v_totAdeudos2011 + v_TotRecargos2011 + v_totAdeudos2012 + v_TotRecargos2012 + 
                               	v_totAdeudos2013 + v_TotRecargos2013 + v_totAdeudos2014 + v_TotRecargos2014 + v_totAdeudos2015 + v_TotRecargos2015 +
                                    v_totAdeudos2016 + v_TotRecargos2016 + v_totAdeudos2017 + v_TotRecargos2017 + v_totAdeudos2018 + v_TotRecargos2018, 

                               	v_importe_multa, v_tot_gastos, v_Datos, 
                               	(v_TotAdeudos_pagados + v_TotRecargos_pagados) - v_TotDesctoRgos_pagados, 
                               	v_periodo_adeudo  with resume;
	END IF;
END IF;

IF p_Adeudos = 'U' THEN  -- CON SOLO ADEUDOS DE REQUERIMIENTOS Y PERIODOS EN CEROS
	IF (v_totAdeudos2007 = 0 AND v_TotRecargos2007 = 0 AND
       		v_totAdeudos2008 = 0 AND v_TotRecargos2008 = 0 AND
       		v_totAdeudos2009 = 0 AND v_TotRecargos2009 = 0 AND 
       		v_totAdeudos2010 = 0 AND v_TotRecargos2010 = 0 AND 
       		v_totAdeudos2011 = 0 AND v_TotRecargos2011 = 0 AND
       		v_totAdeudos2012 = 0 AND v_TotRecargos2012 = 0 AND 
       		v_totAdeudos2013 = 0 AND v_TotRecargos2013 = 0 AND 
       		v_totAdeudos2014 = 0 AND v_TotRecargos2014 = 0 AND 
       		v_totAdeudos2015 = 0 AND v_TotRecargos2015 = 0 AND 
       		v_totAdeudos2016 = 0 AND v_TotRecargos2016 = 0 AND 
		v_totAdeudos2017 = 0 AND v_TotRecargos2017 = 0 AND 
		v_totAdeudos2018 = 0 AND v_TotRecargos2018 = 0) AND
               		((v_importe_multa <> 0) OR (v_tot_gastos <> 0))  THEN
                		RETURN v_control, Trim(v_concesionario), Trim(v_ubicacion), Trim(v_nom_comercial), Trim(v_lugar), Trim(v_obs), Null, v_status, v_unidades, v_categoria, 
                               		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion, 
                               	v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2007 + v_TotRecargos2007, 
                               	v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2008 + v_TotRecargos2008, 
                               	v_totAdeudos2009, v_TotRecargos2009, v_totAdeudos2009 + v_TotRecargos2009,  
                               	v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2010 + v_TotRecargos2010, 
                               	v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2011 + v_TotRecargos2011, 
                               	v_totAdeudos2012, v_TotRecargos2012, v_totAdeudos2012 + v_TotRecargos2012,  
                               	v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2013 + v_TotRecargos2013,  
                               	v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2014 + v_TotRecargos2014, 
                               	v_totAdeudos2015, v_TotRecargos2015, v_totAdeudos2015 + v_TotRecargos2015, 
                               	v_totAdeudos2016, v_TotRecargos2016, v_totAdeudos2016 + v_TotRecargos2016, 
		v_totAdeudos2017, v_TotRecargos2017, v_totAdeudos2017 + v_TotRecargos2017, 
		v_totAdeudos2018, v_TotRecargos2018, v_totAdeudos2018 + v_TotRecargos2018, 

                               	v_totAdeudos2007 + v_totAdeudos2008 + v_totAdeudos2009 + 
                               	v_totAdeudos2010 + v_totAdeudos2011 + v_totAdeudos2012 + 
                               	v_totAdeudos2013 + v_totAdeudos2014 + v_totAdeudos2015 +
                                    v_totAdeudos2016 + v_totAdeudos2017 + v_totAdeudos2018,

                               	v_TotRecargos2007 + v_TotRecargos2008 + v_TotRecargos2009 + 
                               	v_TotRecargos2010 + v_TotRecargos2011 + v_TotRecargos2012 + 
                               	v_TotRecargos2013 + v_TotRecargos2014 + v_TotRecargos2015 +
                                    v_TotRecargos2016 + v_TotRecargos2017 + v_TotRecargos2018,

                               	v_totAdeudos2007 + v_TotRecargos2007 + v_totAdeudos2008 + v_TotRecargos2008 + v_totAdeudos2009 + v_TotRecargos2009 + 
                               	v_totAdeudos2010 + v_TotRecargos2010 + v_totAdeudos2011 + v_TotRecargos2011 + v_totAdeudos2012 + v_TotRecargos2012 + 
                               	v_totAdeudos2013 + v_TotRecargos2013 + v_totAdeudos2014 + v_TotRecargos2014 + v_totAdeudos2015 + v_TotRecargos2015 +
                                    v_totAdeudos2016 + v_TotRecargos2016 + v_totAdeudos2017 + v_TotRecargos2017 + v_totAdeudos2018 + v_TotRecargos2018, 

                               	v_importe_multa, v_tot_gastos, v_Datos, 
                               	(v_TotAdeudos_pagados + v_TotRecargos_pagados) - v_TotDesctoRgos_pagados, 
                               	v_periodo_adeudo  with resume;
	END IF;
END IF;

IF p_Adeudos = 'W' THEN  -- SIN ADEUDO ALGUNO
	IF (v_totAdeudos2007 = 0 AND v_TotRecargos2007 = 0 AND
       		v_totAdeudos2008 = 0 AND v_TotRecargos2008 = 0 AND
       		v_totAdeudos2009 = 0 AND v_TotRecargos2009 = 0 AND 
       		v_totAdeudos2010 = 0 AND v_TotRecargos2010 = 0 AND 
       		v_totAdeudos2011 = 0 AND v_TotRecargos2011 = 0 AND
       		v_totAdeudos2012 = 0 AND v_TotRecargos2012 = 0 AND 
       		v_totAdeudos2013 = 0 AND v_TotRecargos2013 = 0 AND 
       		v_totAdeudos2014 = 0 AND v_TotRecargos2014 = 0 AND 
       		v_totAdeudos2015 = 0 AND v_TotRecargos2015 = 0 AND 
       		v_totAdeudos2016 = 0 AND v_TotRecargos2016 = 0 AND 
		v_totAdeudos2017 = 0 AND v_TotRecargos2017 = 0 AND 
		v_totAdeudos2018 = 0 AND v_TotRecargos2018 = 0 AND 
       		v_importe_multa = 0     AND v_tot_gastos = 0)  THEN
                		RETURN v_control, Trim(v_concesionario), Trim(v_ubicacion), Trim(v_nom_comercial), Trim(v_lugar), Trim(v_obs), Null, v_status, v_unidades, v_categoria, 
                               		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion, 
                               	v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2007 + v_TotRecargos2007, 
                               	v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2008 + v_TotRecargos2008, 
                               	v_totAdeudos2009, v_TotRecargos2009, v_totAdeudos2009 + v_TotRecargos2009,  
                               	v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2010 + v_TotRecargos2010, 
                               	v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2011 + v_TotRecargos2011, 
                               	v_totAdeudos2012, v_TotRecargos2012, v_totAdeudos2012 + v_TotRecargos2012,  
                               	v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2013 + v_TotRecargos2013,  
                               	v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2014 + v_TotRecargos2014, 
                               	v_totAdeudos2015, v_TotRecargos2015, v_totAdeudos2015 + v_TotRecargos2015, 
                               	v_totAdeudos2016, v_TotRecargos2016, v_totAdeudos2016 + v_TotRecargos2016, 
		v_totAdeudos2017, v_TotRecargos2017, v_totAdeudos2017 + v_TotRecargos2017, 
		v_totAdeudos2018, v_TotRecargos2018, v_totAdeudos2018 + v_TotRecargos2018, 

                               	v_totAdeudos2007 + v_totAdeudos2008 + v_totAdeudos2009 + 
                               	v_totAdeudos2010 + v_totAdeudos2011 + v_totAdeudos2012 + 
                               	v_totAdeudos2013 + v_totAdeudos2014 + v_totAdeudos2015 +
                                    v_totAdeudos2016 + v_totAdeudos2017 + v_totAdeudos2018,

                               	v_TotRecargos2007 + v_TotRecargos2008 + v_TotRecargos2009 + 
                               	v_TotRecargos2010 + v_TotRecargos2011 + v_TotRecargos2012 + 
                               	v_TotRecargos2013 + v_TotRecargos2014 + v_TotRecargos2015 +
                                    v_TotRecargos2016 + v_TotRecargos2017 + v_TotRecargos2018,

                               	v_totAdeudos2007 + v_TotRecargos2007 + v_totAdeudos2008 + v_TotRecargos2008 + v_totAdeudos2009 + v_TotRecargos2009 + 
                               	v_totAdeudos2010 + v_TotRecargos2010 + v_totAdeudos2011 + v_TotRecargos2011 + v_totAdeudos2012 + v_TotRecargos2012 + 
                               	v_totAdeudos2013 + v_TotRecargos2013 + v_totAdeudos2014 + v_TotRecargos2014 + v_totAdeudos2015 + v_TotRecargos2015 +
                                    v_totAdeudos2016 + v_TotRecargos2016 + v_totAdeudos2017 + v_TotRecargos2017 + v_totAdeudos2018 + v_TotRecargos2018, 

                               	v_importe_multa, v_tot_gastos, v_Datos, 
                               	(v_TotAdeudos_pagados + v_TotRecargos_pagados) - v_TotDesctoRgos_pagados, 
                               	v_periodo_adeudo  with resume;
	END IF;
END IF;

IF p_Adeudos = 'T' THEN  -- TODOS
	RETURN v_control, Trim(v_concesionario), Trim(v_ubicacion), Trim(v_nom_comercial), Trim(v_lugar), Trim(v_obs), Null, v_status, v_unidades, v_categoria, 
                  v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion, 
                  v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2007 + v_TotRecargos2007, 
                  v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2008 + v_TotRecargos2008, 
                  v_totAdeudos2009, v_TotRecargos2009, v_totAdeudos2009 + v_TotRecargos2009,  
                  v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2010 + v_TotRecargos2010, 
                  v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2011 + v_TotRecargos2011, 
                  v_totAdeudos2012, v_TotRecargos2012, v_totAdeudos2012 + v_TotRecargos2012,  
                  v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2013 + v_TotRecargos2013,  
                  v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2014 + v_TotRecargos2014, 
                  v_totAdeudos2015, v_TotRecargos2015, v_totAdeudos2015 + v_TotRecargos2015, 
                  v_totAdeudos2016, v_TotRecargos2016, v_totAdeudos2016 + v_TotRecargos2016, 
	v_totAdeudos2017, v_TotRecargos2017, v_totAdeudos2017 + v_TotRecargos2017, 
	v_totAdeudos2018, v_TotRecargos2018, v_totAdeudos2018 + v_TotRecargos2018, 

	v_totAdeudos2007 + v_totAdeudos2008 + v_totAdeudos2009 + 
                  v_totAdeudos2010 + v_totAdeudos2011 + v_totAdeudos2012 + 
                  v_totAdeudos2013 + v_totAdeudos2014 + v_totAdeudos2015 +
                  v_totAdeudos2016 + v_totAdeudos2017 + v_totAdeudos2018,

	v_TotRecargos2007 + v_TotRecargos2008 + v_TotRecargos2009 + 
                  v_TotRecargos2010 + v_TotRecargos2011 + v_TotRecargos2012 + 
                  v_TotRecargos2013 + v_TotRecargos2014 + v_TotRecargos2015 +
                  v_TotRecargos2016 + v_TotRecargos2017 + v_TotRecargos2018,

	v_totAdeudos2007 + v_TotRecargos2007 + v_totAdeudos2008 + v_TotRecargos2008 + v_totAdeudos2009 + v_TotRecargos2009 + 
                  v_totAdeudos2010 + v_TotRecargos2010 + v_totAdeudos2011 + v_TotRecargos2011 + v_totAdeudos2012 + v_TotRecargos2012 + 
                  v_totAdeudos2013 + v_TotRecargos2013 + v_totAdeudos2014 + v_TotRecargos2014 + v_totAdeudos2015 + v_TotRecargos2015 +
                  v_totAdeudos2016 + v_TotRecargos2016 + v_totAdeudos2017 + v_TotRecargos2017 + v_totAdeudos2018 + v_TotRecargos2018, 

	v_importe_multa, v_tot_gastos, v_Datos, 
                  (v_TotAdeudos_pagados + v_TotRecargos_pagados) - v_TotDesctoRgos_pagados, 
                  v_periodo_adeudo  with resume;
END IF;

Let v_id_34_datos = 0;
Let v_id_recaudadora = 0;
Let v_id_zona = 0;
Let v_licencia = 0;
Let v_id_giro = 0;
Let v_superficie = 0;

Let v_concesionario = '';
Let v_ubicacion = '';
Let v_nom_comercial = '';
Let v_lugar = '';
Let v_obs = '';
Let v_sector = '';
Let v_status = '';
Let v_unidades = '';
Let v_categoria = '';
Let v_control = '';
Let v_seccion = '';
Let v_bloque = '';
Let v_tipoObligacion = '';

LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_totAdeudos2016 = 0;
LET v_TotRecargos2016 = 0;
LET v_totAdeudos2017 = 0;
LET v_TotRecargos2017 = 0;
LET v_totAdeudos2018 = 0;
LET v_TotRecargos2018 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;
LET v_Datos = '';

LET v_TotAdeudos_pagados = 0;
LET v_TotRecargos_pagados = 0;
LET v_TotDesctoRgos_pagados = 0;

Let v_periodo_adeudo = Null;

END FOREACH;
-- trace off;
                                         
end procedure;

CREATE PROCEDURE "pgmoreno".admin_adeudos_detalle_25x ( par_Tabla Char(2), par_Control Char(10), pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_25
#  Descripcion:      Interfaz de consulta de detalle para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros         par_Tabla     = Rubro de ingreso 
#  de entrada:         par_Control   = Dato de Control del registro
#                             pref   = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning  Integer as Rubro,
                               Integer as Concepto,
                               Integer as Cuenta_Aplicacion,
                               VarChar(30) as Referencia,
                               VarChar(120) as Descripcion,
                               Money(12,2) as Monto,
                               Money(12,2) as Acumulado;

define v_tipo_var                                                                                                                        Char(1);               
define v_id_34_datos, v_id_control_req                                                                                          Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas            Money(12,2);
define v_porcentaje_multa                                                                                                     Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           Money(12,2);
define v_aso_mes_pago                                                                                                          Date;
define v_Axo, v_Mes, Axo_v, Mes_v, Dia_v                                                                    Integer;
define v_mensaje_proc                                                                                                            varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                                               varchar(7);
define v_contador                                                                                                                       Smallint;
define  v_ref     char(7);
--****************************************************************************************************************************************** ctas de aplicacion
  define v_cta_multas, v_cta_dscto_multas, v_cta_gastos                                                                        Integer;
  define v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza                                           Integer;
  define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza                                                           Integer;
  define v_cta_rcgos_ade, v_cta_rcgos_exced                                                                                Integer;
  define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced                                                                        Integer;
  define v_tipo_obligacion                                                                                                                        Char(50);
  define v_concepto                                                                                                                                    VarChar(100);
--******************************************************************************************************************************************
define v_importe_gral, v_importe_20porciento				Money(12,2);	-- adicionado/modificado para el recargo adicional del 20% modificacion para ejercicio 2019


begin
    on exception in (-958)
       delete from tmp_total_otras_oblig;
    end exception;
create temp table tmp_total_otras_oblig(
  rubro int,
  concepto int,
  cuenta int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
       delete from tmp_detalle_otras_oblig;
    end exception;
create temp table tmp_detalle_otras_oblig(
  control_contrato int,
  aso_mes_pago char(7),
  ctrol_operacion int,
  tipo_movto char(1) ) with no log;
end;

  SELECT Year(fechalimite), Month(fechalimite), Day(fechalimite)  INTO Axo_v, Mes_v, Dia_v
                FROM t34_fechalimite
                WHERE cve_tab = par_tabla
                AND Month(fechalimite) = Month(Current)  AND Year(fechalimite) = Year(Current);

      if Day(Current) <= Dia_v then
                if Mes_v = 1 then
                               Let Mes_v = 12;
                               Let Axo_v = Axo_v - 1;
                else
                               Let Mes_v = Mes_v - 1;
                end if;
      end if;

EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  


if trim(pref)='' then
   let v_ref=9999 || '-' || 12;
else
   let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;

let v_id_34_datos = 0;
if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
                SELECT a.id_34_datos  INTO v_id_34_datos  FROM t34_datos A    WHERE a.cve_tab = par_Tabla and a.control = par_Control;

                -- VARIABLES A 0
                Let v_concepto = '';
                Let v_cta_multas = 0;
                Let v_cta_dscto_multas = 0;
                Let v_cta_gastos = 0;
                Let v_cta_adeudos_act = 0;
                Let v_cta_adeudos_dev = 0;
                Let v_cta_adeudos_reza = 0;
               Let v_cta_rcgos_ade = 0;
                Let v_cta_dcto_rcgos_ade = 0;

                Let v_tipo_var = '';
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               Let v_tot_gastos = 0;
                Let v_acumulado = 0;
                Let v_importe = 0;
                Let v_Importe_recargo = 0;
                Let v_importe_rec1 = 0;
                Let v_importe_rec2 = 0;
                Let v_contador = 0;

                -- adicionado/modificado para el recargo adicional del 20% modificacion para ejercicio 2019
	Let v_importe_gral = 0;
	Let v_importe_20porciento = 0;


                -- APREMIOS
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_porcentaje_multa
                               FROM ta_15_apremios
                               WHERE modulo = 34  AND control_otr = v_id_34_datos  AND vigencia = "1" AND clave_practicado = "P"
                               Order By id_control

		-- adicionado/modificado para el recargo adicional del 20% modificacion para ejercicio 2019
                               --Let v_tot_multas = v_importe_multa;
                               --if v_porcentaje_multa < 100 then
                               --                Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                               --                Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                               --else
                               --                Let v_tot_dscto_multas = 0;
                               --end if;
                               Let v_tot_multas = 0;
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                               insert into tmp_detalle_otras_oblig values ( v_id_control_req, v_ref, 0, 'R' );
                end foreach;
                
                -- TERMINA APREMIOS

                               -- INICIAN PERIODOS
                               foreach
                                               SELECT a.periodo, a.importe, Year(a.periodo), Month(a.periodo), a.tipo_var   INTO  v_aso_mes_pago, v_importe, v_Axo, v_Mes, v_tipo_var  
                                                               FROM t34_pagos a, t34_status b    WHERE id_datos = v_id_34_datos  and periodo <= v_ref
                                                               AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('V')
                                                               ORDER BY a.periodo

                                               insert into tmp_detalle_otras_oblig values ( v_id_34_datos, v_Axo || '-' || v_Mes, 0, 'A' );
                                               if v_importe > 0 then

			Let v_importe_gral = v_importe_gral + v_importe;	-- adicionado/modificado para el recargo adicional del 20% modificacion para ejercicio 2019

                                                               if v_contador = 0 then
                                                                              --if v_tot_multas > 0 then
                                                                              --                EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
                                                                              --                Let v_acumulado = v_acumulado + v_tot_multas;
                                                                              --                                RETURN 0,0, v_cta_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                              --                                               v_tot_multas, v_acumulado with resume;
                                                                              --                insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_multas, v_acumulado );
                                                                              --end if;
                                                                              --if v_tot_dscto_multas <> 0 then
                                                                              --                EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
                                                                              --                Let v_acumulado = v_acumulado + v_tot_dscto_multas;
                                                                              --                                RETURN 0,0, v_cta_dscto_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                              --                                               v_tot_dscto_multas, v_acumulado        with resume;
                                                                              --                insert into tmp_total_otras_oblig values ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_dscto_multas, v_acumulado );
                                                                              --end if;
                                                                              if v_tot_gastos > 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_gastos;
                                                                                                              RETURN 0,0, v_cta_gastos, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                                                                             v_tot_gastos, v_acumulado                      with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, v_concepto, v_tot_gastos, v_acumulado );
                                                                              end if;
                                                                              Let v_contador = 1;
                                                               end if;

                                                               if v_tipo_var = 'T' then
                                                                              if Year(v_aso_mes_pago) < Year(Current) then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ADEUDO REZAGO' ) INTO v_cta_adeudos_reza, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                              RETURN 0,0, v_cta_adeudos_reza, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                                                                             v_importe, v_acumulado            with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_reza, v_Axo || '/' || v_Mes, v_concepto, 
                                                                                              v_importe, v_acumulado );
                                                                              else
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ADEUDO ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                             RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                                                                             v_importe, v_acumulado            with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, 
                                                                                              v_importe, v_acumulado );
                                                                              end if;

                                                                              SELECT sum(por_recargo)   INTO v_Importe_recargo  FROM t34_porcentajes  
                                                                                              WHERE periodo_porc BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

                                                                              if v_Importe_recargo <> 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'RCGO. ADEUDO' ) INTO v_cta_rcgos_ade, v_concepto;
                                                                                              Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                                                                              Let v_acumulado = v_acumulado + v_importe_rec1;
                                                                                              RETURN 0,0, v_cta_rcgos_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                                                                             v_importe_rec1, v_acumulado                with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, 
                                                                                                                             v_importe_rec1, v_acumulado );
                                                                                                                                             --EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 34) 
                                                                                                                                                                            --INTO v_importe_rec2, v_mensaje_proc;
                                                                              end if;
                                                                              if v_importe_rec2 > 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. RECARGO' ) INTO v_cta_dcto_rcgos_ade, v_concepto;
                                                                                              Let v_importe_rec2 = v_importe_rec2 * -1;
                                                                                              Let v_acumulado = v_acumulado + v_importe_rec2;
                                                                                              RETURN 0,0, v_cta_dcto_rcgos_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                                                                             v_importe_rec2, v_acumulado                with resume;
                                                                              end if;
                                                               else
                                                                              if v_tipo_var = 'F' then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'F', 'FORMA' ) INTO v_cta_adeudos_act, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                              RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                                                                             v_importe, v_acumulado            with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, 
                                                                                              v_importe, v_acumulado );
                                                                              end if;
                                                                              if v_tipo_var = 'A' then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'A', 'AUTORIZACION ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                              RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, 
                                                                                                                             v_importe, v_acumulado            with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, 
                                                                                              v_importe, v_acumulado );
                                                                              end if;
                                                               end if;
                                                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                               Let v_importe_rec1 = 0;
                               Let v_importe_rec2 = 0;
                               end foreach;
                               -- TERMINAN PERIODOS
                                                               if v_contador = 0 then
                                                                              --if v_tot_multas > 0 then
                                                                              --                EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
                                                                              --                Let v_acumulado = v_acumulado + v_tot_multas;
                                                                              --                                RETURN 0,0, v_cta_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'MULTAS ', 
                                                                              --                                               v_tot_multas, v_acumulado with resume;
                                                                              --                insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, 'MULTAS ', v_tot_multas, v_acumulado );
                                                                              --end if;
                                                                              --if v_tot_dscto_multas <> 0 then
                                                                              --                EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
                                                                              --                Let v_acumulado = v_acumulado + v_tot_dscto_multas;
                                                                              --                                RETURN 0,0, v_cta_dscto_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'DSCTO. MULTAS ', 
                                                                              --                                               v_tot_dscto_multas, v_acumulado        with resume;
                                                                              --                insert into tmp_total_otras_oblig values ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado );
                                                                              --end if;
                                                                              if v_tot_gastos > 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_gastos;
                                                                                                              RETURN 0,0, v_cta_gastos, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'GASTOS ', 
                                                                                                                             v_tot_gastos, v_acumulado                      with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, 'GASTOS ', v_tot_gastos, v_acumulado );
                                                                              end if;
                                                               end if;

		-- adicionado/modificado para el recargo adicional del 20% modificacion para ejercicio 2019
		Let v_importe_20porciento = ( v_importe_gral * 20 ) / 100;
		Let v_acumulado = v_acumulado + v_importe_20porciento;
		EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
		RETURN 0,0, v_cta_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'MULTAS ', v_importe_20porciento, v_acumulado with resume;

		insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, 'MULTAS ', v_importe_20porciento, v_acumulado );
		--insert into tmp_detalle_otras_oblig values ( v_id_34_datos, v_Axo || '-' || v_Mes, 0, 'A' );  -- ?????????????????????????????????

end if;
end procedure;

CREATE PROCEDURE "pgmoreno".sp16_descto_multaadeudo ( par_opc char(1), par_id_modulo int, par_control int, 
par_axoini int, par_mesini int, par_axofin int, par_mesfin int, 
par_porcentaje int, par_usuario_aplica char(10), par_autoriza int, par_rec_usuario int )

RETURNING int as descuento,
          varchar(255) as mensage;


define v_porcentaje  int;
define v_id_descmulta int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp16_descto_multaadeudo ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_porcentaje=0;
Let v_id_descmulta = 0;

if par_opc = 'A' then	-- alta de descuento
	if ((par_axofin * 100)+par_mesfin) >= ((par_axoini * 100)+par_mesini) then
		if not exists ( SELECT * FROM ta_16_descmulta WHERE id_modulo = par_id_modulo and id_control = par_control and vigencia = 'V' ) then
			INSERT INTO ta_16_descmulta VALUES ( 0, par_id_modulo, par_control, par_axoini, par_mesini, par_axofin, par_mesfin, 
							current, par_usuario_aplica, null, null, null, null, null, null,
							'V', par_porcentaje, par_autoriza, par_rec_usuario );
			Let v_id_descmulta = dbinfo("sqlca.sqlerrd1");
			if v_id_descmulta > 0 then
				return 0,'El Descuento se creo correctamente';
			else
				return -1,'Ocurrio error al crear el descuento, avisa al administrador';
			end if;
		else
			return -1,'El Control ya tiene un Descuento Vigente, debes cancelarlo primero';
		end if;	
	else
		return -1,'El periodo final no es mayor o igual al periodo inicial, intenta de nuevo';
	end if;
end if;

if par_opc = 'C' then  -- cancelacion del descuento
	if exists ( SELECT * from ta_16_descmulta where id_modulo = par_id_modulo and id_control = par_control and vigencia = 'V' ) then
		UPDATE ta_16_descmulta SET
			fecha_baja = current, usuario_baja = par_usuario_aplica, vigencia = 'C'
			WHERE id_modulo = par_id_modulo and id_control = par_control and vigencia = 'V';
		return 0,'El Descuento ha sido cancelado';
	else
		return -1,'No existe Descuento Vigente con ese control, intenta de nuevo';
	end if;
end if;

if par_opc = 'O' then  -- consulta para calculo
	if exists ( SELECT * from ta_16_descmulta where id_modulo = par_id_modulo and id_control = par_control and vigencia = 'V' ) then
		if exists ( SELECT * from ta_16_descmulta 
			WHERE id_modulo = par_id_modulo and id_control = par_control 
			AND (( par_axoini * 100) + par_mesini ) between ((axoini * 100)+mesini) and ((axofin * 100)+mesfin) and vigencia = 'V' ) then

			SELECT NVL((sum(porcentaje)),0) INTO v_porcentaje FROM ta_16_descmulta
			WHERE id_modulo = par_id_modulo and id_control = par_control 
			AND (( par_axoini * 100) + par_mesini ) between ((axoini * 100)+mesini) and ((axofin * 100)+mesfin) and vigencia = 'V';
			
			return v_porcentaje,'Existe descuento';
		else
			return -1,'Si existe el control pero,,,,No existe Descuento en el periodo solicitado';
		end if;
	else
		return -1,'No existe Descuento con ese control, intenta de nuevo';
	end if;
end if;
 
END PROCEDURE;

CREATE PROCEDURE "pgmoreno".sp_mul20_desmlta20 ( par_id_modulo int, p_Control Int, p_Axo Int, p_Mes Int, p_importe Money )
{######################################################################
#  Procedimiento:    sp1634_mul20_DesMlta20
#  Descripcion:      Interfaz de consulta de porcentaje de Multa
#  Parametros de entrada:	
#			par_Id_Modulo	= modulo de origen
#			p_Control	= id de control del registro
#                                       	p_Axo	= A�o de periodo de consulta
#                                       	p_Mes	= Mes de periodo de consulta
#			p_importe	= Importe del adeudo
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento vencidos dentro de 
#  Llama a:          
#  
######################################################################}
RETURNING	int as descuento,
money(12,2) as Multa20,
money(12,2) as DsctoMulta,
         	varchar(255) as mensaje;
              
define v_porcdescto	int;
define v_Multa20, v_DsctoMulta money(12,2);
define v_mensaje	varchar(255);

Let v_porcdescto	= 0;
Let v_Multa20		= 0;
Let v_DsctoMulta	= 0;

Let v_Multa20 = p_importe * 0.20;
execute PROCEDURE sp16_descto_multaadeudo ( 'O', par_id_modulo, p_Control, p_Axo, p_Mes, 0, 0, 0, 'pgmoreno', 1, 1 ) INTO v_porcdescto, v_mensaje;
if v_porcdescto > 0 then
	Let v_DsctoMulta = ( v_Multa20 * v_porcdescto ) / 100;
end if;

-- al inhibir las siguientes lineas dejas sin efecto la multa de 30% y el descuento a la misma
--if Year(current) <= 2018 then
	Let v_Multa20		= 0;
	Let v_DsctoMulta	= 0;
--end if;

RETURN v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;

end procedure;

CREATE PROCEDURE "pgmoreno".admin_encabezados_18z (p_tipo char(1), p_numero int)
{######################################################################
#  Procedimiento:    admin_encabezados_18
#  Descripcion:      Interfaz de consulta de encabezados para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros        p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:       p_numero   = Numero de Contrato
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_encabezados en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning  varchar(92) as propietario,
                              varchar(80) as calle,
                              varchar(10) as numext,
                              varchar(10) as numint,
                              varchar(50) as colonia,
                              varchar(10) as cp,
                              varchar(13) as rfc,
                              varchar(50) as municipio,
                              varchar(50) as estado,
                              varchar(18) as curp,
                              char(500) as descripcion,
                              int as cartera,
                              varchar(255) as leyenda,
                              varchar(255) as leyendaRecibo,
                              int as impidecobro;
        
define v_importe_multa, v_importe_gastos, v_tot_gastos Money(12,2);   -- requerimientos

define v_control_contrato           Integer;   
define v_importe                            Money(15,2);

define v_propietario       varchar(92);
define v_calle                  varchar(80);
define v_numext              varchar(10);
define v_numint               varchar(10);
define v_colonia              varchar(50);
define v_cp                       varchar(10);
define v_rfc                       varchar(13);
define v_municipio          varchar(50);
define v_estado               varchar(50);
define v_curp                    varchar(18);
define v_descripcion       varchar(10);
define v_cartera                             int; --1 si la Cuenta espec�fica tiene adeudos y 0 en caso contrario
define v_leyenda             varchar(50);
define v_leyendaRecibo varchar(255);
define v_codigo                              int;

define v_Axo                     Integer;
define v_status_vigencia              Char(1);

let v_propietario              = ' ';
let v_calle                         = ' ';
let v_numext                     = ' ';
let v_numint                      = ' ';
let v_colonia                     = ' ';
let v_cp                              = ' ';
let v_rfc                             = ' ';
let v_municipio                 = ' ';
let v_estado       = ' ';
let v_curp                          = ' ';
let v_descripcion              = ' ';
let v_cartera                     = 0;
let v_leyenda    = 'NO PROCEDE COBRO';
let v_leyendaRecibo     = ' ';
let v_codigo                      = -1;

Let v_control_contrato = 0;
Let v_importe = 0;
Let v_Axo = Year(Current);



if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato, (c.descripcion) nom_emp, a.domicilio, a.status_vigencia  INTO  v_control_contrato, v_propietario, v_calle, v_status_vigencia
                              FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c  
                              WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp;
                                            let v_colonia                     = 'COL. CENTRO';
                                            let v_municipio                 = 'GUADALAJARA';
                                            let v_estado                      = 'JALISCO';
                              
               -- APREMIOS
               Let v_importe_multa = 0;
               Let v_importe_gastos = 0;
               Let v_tot_gastos = 0;
                foreach
                     SELECT importe_multa,     importe_gastos  INTO v_importe_multa, v_importe_gastos 
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                end foreach;

                                                                          if exists( SELECT * FROM ta_16_pagos WHERE control_contrato = v_control_contrato ) then
                                                                                         SELECT sum(importe)  INTO v_importe  FROM ta_16_pagos WHERE control_contrato = v_control_contrato and status_vigencia = 'V';
                                                                                         if v_importe > 0 then
                                                                                                       let v_cartera      = 1;
                                                                                                       let v_leyenda    = 'PROCEDE COBRO';
                                                                                                       let v_codigo       = 0;
                                                                                         else
                                                                                                       if v_importe_multa > 0 or v_tot_gastos > 0 then
                                                                                                                      let v_cartera      = 1; 
                                                                                                                      let v_leyenda    = 'requerimientos PROCEDE COBRO';
                                                                                                                      let v_codigo       = 0;
                                                                                                       else
                                                                                                                      let v_cartera      = 0;
                                                                                                                      let v_leyenda     = 'NO TIENE ADEUDOS';
                                                                                                                      Let v_codigo      = -1;
                                                                                                       end if;
                                                                                         end if;
                                                                          else
                                                                                         if v_importe_multa > 0 or v_tot_gastos > 0 then
                                                                                                       let v_cartera      = 1;  
                                                                                                       let v_leyenda    = 'PROCEDE COBRO';
                                                                                                       let v_codigo       = 0;
                                                                                         end if;
                                                                          end if;
               if v_status_vigencia = 'C' then
                              let v_cartera                     = 0;
                              let v_leyenda    = 'NO PROCEDE COBRO CONTRATO CANCELADO';
               end if;
               if v_status_vigencia = 'N' then
                              let v_cartera                     = 0;
                              let v_leyenda    = 'NO PROCEDE COBRO CONTRATO CONVENIADO';
               end if;


               RETURN v_propietario, v_calle, v_numext, v_numint, v_colonia, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_descripcion, v_cartera, v_leyenda, v_leyendaRecibo, v_codigo;
else
               RETURN v_propietario, v_calle, v_numext, v_numint, v_colonia, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_descripcion, v_cartera, v_leyenda, v_leyendaRecibo, v_codigo;
end if;
end procedure;

CREATE PROCEDURE "pgmoreno".sp16_contratos_ind ( p_tipo char(1), p_numero int )
{######################################################################
#  Procedimiento:    sp16_contrato_Consulta_Ind
#  Descripcion:      Interfaz de consulta  ASEO CONTRATADO
#
#  Parametros	p_tipo	= Tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:	p_numero	= Numero de Contrato
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
	returning	int as Control_Contrato,
		int as Num_Contrato,
		varchar(80) as Calle,
		varchar(10) as Numext,
		varchar(10) as Numint,
		varchar(50) as Colonia,
		char(1) as Sector,
		varchar(10) as Cp,
		varchar(13) as Rfc,
		varchar(50) as Municipio,
		varchar(50) as Estado,
		varchar(18) as Curp,
		char(10) as Status_Contrato,

		int as Num_Empresa,
		varchar(80) as Nombre_Empresa,
		varchar(80) as Representante_Empresa,

		char(1) as Tipo_Aseo,
		varchar(80) as Tipo_Aseo_Descripcion,

		char(1) as Cve_Recoleccion,
		varchar(80) as Unidad_Recoleccion,
		int as Cantidad_Recoleccion,

		int as status,
		varchar(255) as leyenda;
		
        
define v_status	int;
define v_leyenda	varchar(255);

define v_control_contrato	int;
define v_calle		varchar(80);
define v_numext		varchar(10);
define v_numint               	varchar(10);
define v_colonia              	varchar(50);
define v_sector		char(1);
define v_cp                       	varchar(10);
define v_rfc                       	varchar(13);
define v_municipio          	varchar(50);
define v_estado               	varchar(50);
define v_curp                    	varchar(18);
define v_Status_Contrato	char(10);

define v_num_empresa	int;
define v_Nombre_Empresa, v_Representante_Empresa	varchar(80);

define v_ctrol_aseo, v_ctrol_emp, v_ctrol_recolec, v_cantidad_recolec, v_id_rec int;
define v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja	date;

define v_Cve_Recoleccion			char(1);
define v_Tipo_Aseo_Descripcion, v_Unidad_Recoleccion	varchar(80);


Let v_status = 0;
Let v_leyenda =' ';

Let v_control_contrato = 0;
Let v_calle = ' ';
Let v_numext = ' ';
Let v_numint = ' ';
Let v_colonia = ' ';
Let v_sector = ' ';
Let v_cp = ' ';
Let v_rfc = ' ';
Let v_municipio = ' ';
Let v_estado = ' ';
Let v_curp = ' ';
Let v_status_contrato = ' ';

Let v_num_empresa = 0;
Let v_nombre_empresa = ' ';
Let v_representante_empresa = ' ';

Let v_ctrol_aseo = 0;
Let v_ctrol_emp = 0;
Let v_ctrol_recolec = 0;
Let v_cantidad_recolec = 0;
Let v_id_rec = 0;

Let v_tipo_aseo_descripcion = ' ';
Let v_cve_recoleccion = ' ';
Let v_unidad_recoleccion = ' ';

if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
	SELECT a.control_contrato, a.domicilio, a.sector, 
	( case when a.status_vigencia = 'V' then 'VIGENTE' when a.status_vigencia = 'N' then 'CONVENIADO' when a.status_vigencia = 'C' then 'CANCELADO'  end ),
	a.ctrol_aseo, a.ctrol_emp, a.num_empresa, a.ctrol_recolec, a.cantidad_recolec, a.id_rec,
	a.fecha_hora_alta, a.aso_mes_oblig, a.fecha_hora_baja 

	INTO  v_control_contrato, v_calle, v_sector, 
	v_Status_Contrato,
	v_ctrol_aseo, v_ctrol_emp, v_num_empresa, v_ctrol_recolec, v_cantidad_recolec, v_id_rec,
	v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja

	FROM ta_16_contratos a, ta_16_tipo_aseo b 
	WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

		Let v_colonia                     = 'COL. CENTRO';
                                    Let v_municipio                 = 'GUADALAJARA';
                                    Let v_estado                      = 'JALISCO';
		
		SELECT descripcion INTO v_Tipo_Aseo_Descripcion  from ta_16_tipo_aseo where ctrol_Aseo = v_ctrol_aseo;

		SELECT descripcion, representante  INTO v_Nombre_Empresa, v_Representante_Empresa 
		FROM ta_16_empresas WHERE ctrol_emp = v_ctrol_emp and num_empresa = v_num_empresa;

		SELECT cve_recolec, descripcion  INTO  v_Cve_Recoleccion, v_Unidad_Recoleccion  FROM ta_16_unidades WHERE ctrol_recolec = v_ctrol_recolec;
	
		Let v_status = 1;
		Let v_leyenda = 'EXISTE CONTRATO';
else
		Let v_status = -1;
		Let v_leyenda = 'NO EXISTE CONTRATO';
end if;

	RETURN v_control_contrato, p_numero, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
		v_num_empresa, v_nombre_empresa, v_representante_empresa,
		p_tipo, v_tipo_aseo_descripcion,
		v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec,
		v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_licenciagiro_f2 ( p_tipo char(1), p_numero int )
{######################################################################
#  Procedimiento:    sp16_LicenciaGiro_F2
#  Descripcion:      Interfaz de consulta Consulta de Licencias de Giro Relacionadas al Contrato de ASEO CONTRATADO
#
#  Parametros                   p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:                   p_numero   = Numero de Contrato
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:
#
#  Llamado por:      Procedimiento
#  Llama a:          
#  
######################################################################}
                returning	int as Licencia, 
		char(130) as Actividad, 
		char(80) as Propietario;

define v_control_contrato				Int;
define v_licencia					Int;
define v_actividad					char(130);
define v_propietario					char(80);

Let v_control_contrato = 0;
Let v_licencia = 0;
Let v_actividad = ' ';
Let v_propietario = ' ';

if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
	SELECT a.control_contrato  INTO  v_control_contrato  FROM ta_16_contratos a, ta_16_tipo_aseo b  WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

	FOREACH
	SELECT b.licencia, b.actividad, b.propietario  INTO  v_licencia, v_actividad, v_propietario 
	FROM ta_16_rel_licgiro a, catastro_gdl:Licencias b
	WHERE a.control_contrato = v_control_contrato
	AND b.licencia = a.num_licencia and b.vigente = 'V'
	ORDER BY a.num_licencia

	RETURN v_licencia, Trim(v_actividad), Trim(v_propietario)       with resume;

	END FOREACH;

end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_licenciagiro_f3 ( )
{######################################################################
#  Procedimiento:    sp16_LicenciaGiro_F3
#  Descripcion:      Interfaz de consulta Consulta de Licencias de Giro Relacionadas al Contrato de ASEO CONTRATADO
#
#  Parametros	
#  de entrada:	
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:
#
#  Llamado por:      Procedimiento
#  Llama a:          
#  
######################################################################}
                returning	char(10) as Vigencia_Rel, 
		int as Licencia, 
		char(130) as Actividad, 
		char(80) as Propietario, 
		int as Num_Contrato, 
		varchar(80) as Domicilio_Recoleccion, 
		int as Num_Empresa, 
		varchar(80) as Nombre_Empresa, 
		varchar(80) as Representante_Empresa;

define v_Vigencia_Rel				char(10);
define v_licencia					Int;
define v_actividad					char(130);
define v_propietario					char(80);
define v_Num_Contrato				Int;
define v_Domicilio_Recoleccion			varchar(80);
define v_Num_Empresa				Int;
define v_Nombre_Empresa				varchar(80);
define v_Representante_Empresa			varchar(80);


Let v_Vigencia_Rel = ' ';
Let v_licencia = 0;
Let v_actividad = ' ';
Let v_propietario = ' ';
Let v_Num_Contrato = 0;
Let v_Domicilio_Recoleccion = ' ';
Let v_Num_Empresa = 0;
Let v_Nombre_Empresa = ' ';
Let v_Representante_Empresa = ' ';


	FOREACH
	SELECT case when a.vigencia = 'V' then 'VIGENTE' when a.vigencia = 'C' then 'CANCELADA' end, 
	b.Licencia, b.actividad, b.propietario, 
	c.Num_Contrato, c.Domicilio, 
	d.num_empresa, d.descripcion, d.representante 
	INTO  v_Vigencia_Rel, 
	v_Licencia, v_actividad, v_propietario, 
	v_Num_Contrato, v_Domicilio_Recoleccion, 
	v_Num_Empresa, v_Nombre_Empresa, v_Representante_Empresa 

	FROM ta_16_rel_licgiro a, catastro_gdl:Licencias b, ta_16_contratos c, ta_16_empresas d 
	WHERE b.licencia = a.num_licencia -- and b.vigente = 'V'
	AND c.Control_Contrato = a.Control_Contrato
	AND d.num_empresa = c.num_empresa and d.ctrol_emp = c.ctrol_emp
	ORDER BY c.Num_Contrato, a.num_licencia

	RETURN v_Vigencia_Rel, v_Licencia, v_actividad, v_propietario, v_Num_Contrato, v_Domicilio_Recoleccion, v_Num_Empresa, v_Nombre_Empresa, v_Representante_Empresa   with resume;

	END FOREACH;


end procedure;

CREATE PROCEDURE "informix".spd_pagpredkio2borrar(
    		parcvecuenta    integer,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		parKiosco	integer
        )
		returning smallint , char(2), integer, char(28);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int; 
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
          
       RETURN 0, '' , 0 , ' ';
  ELIF  v_lError = -236   THEN
         RETURN 0, '' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje;
    --   RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
         RETURN 0, '' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
-- set debug file to "pago13";
-- trace on;
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;

 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo , 
   trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior),
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior)
   || '@CVECATASTRAL ' || CVECATNVA || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa 

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip 

  , v_hora
 from catastro_gdl:datos_gralKio a 
 where a.cvecuenta = parcvecuenta;

  select id_rec , caja  into varrec , varcaja
  
  from ta12_operacKiosco
  where id_usuario = parkiosco; 
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial por Kiosco de la cuenta ' || parcvecuenta , '',parcvecuenta,0,
                0,0,parkiosco,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'Kiosco ' || parkiosco;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1"); 
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)
                
let linea = 1;     
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
execute procedure  catastro_gdl:kiosco_totalespred( parcvecuenta , parAxohasta, parMeshasta, 1) 
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 
if v_ob = 'D' then 
insert into ta_12_recibosdet
( fecha ,id_rec , caja , operacion ,linea , descripcion , cuenta ,importe
)
  values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );

     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea +1 ;
 end if;
if v_ob = 'T' then 
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
 select   s.multa,  s.gasto,  s.multavir 
    into   v_mulpag,  v_gaspag,  v_multasvir 
      from  catastro_gdl:saldos s  where  s.cvecuenta= parcvecuenta;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq) 
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta 
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor , 
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

 execute PROCEDURE catastro_gdl:linea_capturapred(parcvecuenta, p_desde , p_hasta ,
         parImpCertificado, 0,0,0,parImpCertificado , today) 
       into v_lineacapt, v_lineacapt2;
       let estatus = 0;
    execute  PROCEDURE linea_pagok(v_lineacapt2, parKiosco, parImpCertificado, 'K',varcvepago,
             today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje ;
	-- COMMIT WORK;   
return varrec, varcaja, spoperacion , v_lineacapt2;
--trace off;
end procedure
;

CREATE PROCEDURE "informix".spd_pagpredkio2(
    		parcvecuenta    integer,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		parKiosco	integer
        )
		returning smallint , char(2), integer, char(28);

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int; 
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
          
       RETURN 0, '' , 0 , ' ';
  ELIF  v_lError = -236   THEN
         RETURN 0, '' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje;
    --   RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
         RETURN 0, '' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
-- set debug file to "pago13";
-- trace on;
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;

 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo , 
   trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior),
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(a.u_calle) || ' Ext ' || trim(a.u_noexterior) || ' # Int ' || trim(a.u_interior)
   || '@CVECATASTRAL ' || CVECATNVA || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa 

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip 

  , v_hora
 from catastro_gdl:datos_gralKio a 
 where a.cvecuenta = parcvecuenta;

  select id_rec , caja  into varrec , varcaja
  
  from ta12_operacKiosco
  where id_usuario = parkiosco; 
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial por Kiosco de la cuenta ' || parcvecuenta , '',parcvecuenta,0,
                0,0,parkiosco,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'Kiosco ' || parkiosco;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, today, v_hora , 
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1"); 
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)
                
let linea = 1;     
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
execute procedure  catastro_gdl:kiosco_totalespred( parcvecuenta , parAxohasta, parMeshasta, 1) 
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 
if v_ob = 'D' then 
insert into ta_12_recibosdet
( fecha ,id_rec , caja , operacion ,linea , descripcion , cuenta ,importe
)
  values(today ,varrec , varcaja ,  varoperacion , linea , 
        v_concepto  ,   v_cuenta,  	v_importe );

     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea +1 ;
 end if;
if v_ob = 'T' then 
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
 select   s.multa,  s.gasto,  s.multavir 
    into   v_mulpag,  v_gaspag,  v_multasvir 
      from  catastro_gdl:saldos s  where  s.cvecuenta= parcvecuenta;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq) 
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta 
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor , 
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

 execute PROCEDURE catastro_gdl:linea_capturapred_kio(parcvecuenta, p_desde , p_hasta ,
         parImpCertificado, 0,0,0,parImpCertificado , today , parKiosco ) 
    
 into v_lineacapt, v_lineacapt2;
       let estatus = 0;
    execute  PROCEDURE linea_pagok(v_lineacapt2, parKiosco, parImpCertificado, 'K',varcvepago,
             today, varrec , varcaja, varoperacion, 'KIOSCO') into  estatus ,mensaje ;
	-- COMMIT WORK;   
return varrec, varcaja, spoperacion , v_lineacapt2;
--trace off;
end procedure
;

CREATE PROCEDURE "pgmoreno".sp16_licenciagiro_f1 ( p_tipo char(1), p_numero int )
{######################################################################
#  Procedimiento:    sp16_LicenciaGiro_F1
#  Descripcion:      Interfaz de consulta Consulta de Licencias de Giro Relacionadas al Contrato de ASEO CONTRATADO
#
#  Parametros                   p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:                   p_numero   = Numero de Contrato
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:
#
#  Llamado por:      Procedimiento
#  Llama a:          
#  
######################################################################}
                returning	int as status_licencias, 
		varchar(100) as Concepto_licencias;

define v_control_contrato				Int;

define v_licencia, v_Follic				Int;
define v_DetFollic					varchar(100);

Let v_control_contrato = 0;
Let v_Follic = 0;
Let v_licencia = 0;
Let v_DetFollic = 'Licencia(s) Relacionada(s) : ';

if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
	SELECT a.control_contrato  INTO  v_control_contrato  FROM ta_16_contratos a, ta_16_tipo_aseo b  WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

	FOREACH
	SELECT a.num_licencia INTO v_licencia  FROM ta_16_rel_licgiro a, catastro_gdl:Licencias b
                  WHERE a.control_contrato = v_control_contrato
	AND b.licencia = a.num_licencia and b.vigente = "V"
	ORDER BY a.num_licencia

	if v_Follic > 0 then
                  	Let v_DetFollic = v_DetFollic || ',' || v_licencia;
		Let v_Follic = v_Follic + 1;
	else
                  	Let v_DetFollic = v_DetFollic || v_licencia;
		Let v_Follic = v_Follic + 1;
	end if;
	END FOREACH;

	if v_Follic > 0 then
		RETURN v_Follic, Trim(v_DetFollic);
	end if;

end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp_requerim_f01 ( par_Modulo Integer, p_Id Integer )
{######################################################################
#  Procedimiento:    sp16_Requerim_F01
#  Descripcion:      Interfaz de consulta de Requerimientos en INGRESOS
#
#  Parametros	par_Modulo	= Modulo de Consulta
#  de entrada:	p_Id		= Id de Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento para cualquiera que solicite datos de requerimientos
#  Llama a:          
#  
######################################################################}
                returning varchar(255) as Concepto,    
                               Money(12,2) as Multa,    
                               Money(12,2) as Gastos;    

--******************************************************************************************* APREMIOS
  define v_id_control, v_folio_req, v_FolReq		Integer;
  define v_importe_multa, v_tot_multas, v_tot_dscto_multas, v_importe_gastos, v_tot_gastos, v_porcentaje_multa      Money(12,2);
  define v_DetFolReq                                                               varchar(255);
  define v_diligencia                                                                 char(1);
--*******************************************************************************************

Let v_id_control = 0;

Let v_tot_gastos = 0;
Let v_importe_multa = 0;
Let v_importe_gastos = 0;
Let v_FolReq = 0;
Let v_DetFolReq = 'Docto(s) Requerido(s) : ';

FOREACH
SELECT id_control,   folio,            diligencia,      importe_multa,     importe_gastos, porcentaje_multa
INTO v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos, v_porcentaje_multa 
FROM ta_15_apremios
WHERE modulo = par_Modulo  And control_otr = p_Id
And vigencia = "1" and clave_practicado = "P"
Order By id_control
	
	Let v_tot_multas = v_importe_multa;
                  if v_porcentaje_multa < 100 then
                  	Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                    Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
	else
                  	Let v_tot_dscto_multas = 0;
	end if;

	if v_FolReq > 0 then
                  	Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
	else
                  	Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
	end if;

	Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

END FOREACH;

	if v_FolReq > 0 then
                  	RETURN Trim(v_DetFolReq), v_importe_multa, v_tot_gastos  with resume;
		if v_tot_dscto_multas <> 0 then
                                    	RETURN 'Dscto. a Multas', v_tot_dscto_multas, Null  with resume;
		end if;
	end if;

END PROCEDURE;

CREATE PROCEDURE "pgmoreno".sp_requerim_3col ( par_Modulo Integer, p_Id Integer )
{######################################################################
#  Procedimiento:    sp_Requerim_3Col
#  Descripcion:      Interfaz de consulta de Requerimientos en INGRESOS salida 3 columnas
#
#  Parametros	par_Modulo	= Modulo de Consulta
#  de entrada:	p_Id		= Id de Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento para cualquiera que solicite datos de requerimientos
#  Llama a:          
#  
######################################################################}
	returning	varchar(100) as Concepto,
		Money(12,2) as Importe_Multa_Descto,
		Money(12,2) as Importe_Gastos;

define v_r_rubro, v_r_cta_aplic, v1_r_cta_aplic, v2_r_cta_aplic, v3_r_cta_aplic	int;
define v_r_importe, v1_r_importe, v2_r_importe, v3_r_importe	money(12,2);
define v_DetFolReq, v0_DetFolReq, v_concepto	varchar(100);

Let v_r_rubro = 0;
Let v_r_cta_aplic = 0;
Let v1_r_cta_aplic = 0;
Let v2_r_cta_aplic = 0;
Let v3_r_cta_aplic = 0;

Let v_r_importe = 0;
Let v1_r_importe = 0;
Let v2_r_importe = 0;
Let v3_r_importe = 0;

Let v_DetFolReq = ' ';
Let v0_DetFolReq = ' ';
Let v_concepto = ' ';

FOREACH
EXECUTE PROCEDURE sp_Requerim_F00 ( 16, p_Id ) INTO v_r_rubro, v_r_cta_aplic, v_r_importe, v_Concepto
if v_r_rubro =  0 then
	Let v0_DetFolReq = v_Concepto;	-- documentos
end if;

if v_r_rubro =  1 then
	--Let v1_r_cta_aplic = v_r_cta_aplic;
	Let v1_r_importe = v_r_importe;	--Multa
end if;

if v_r_rubro =  2 then
	--Let v2_r_cta_aplic = v_r_cta_aplic;
	Let v2_r_importe = v_r_importe;	--Descuento a la Multa
end if;

if v_r_rubro =  3 then
	--Let v3_r_cta_aplic = v_r_cta_aplic;
	Let v3_r_importe = v_r_importe;	--Gastos
end if;
END FOREACH;

-- DETALLE DE REQUERIMIENTOS
if ( v1_r_importe <> 0 ) and ( v3_r_importe <> 0 ) then
	RETURN v0_DetFolReq, v1_r_importe, v3_r_importe	with resume;
	if v2_r_importe <> 0 then
		--v2_r_importe el importa ya esta * -1
		RETURN 'Dscto. a Multas ', v2_r_importe, 0	with resume;
	end if;
else
	if ( v1_r_importe = 0 ) and ( v3_r_importe <> 0 ) then
		RETURN v0_DetFolReq, 0, v3_r_importe		with resume;
	end if;
end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_adeudos_f02x ( p_tipo char(1), p_numero int, p_rep char(1), pref varchar(20) )
{######################################################################
#  Procedimiento:    sp16_Adeudos_F02
#  Descripcion:      Interfaz de consulta de detalle de Adeudos de ASEO CONTRATADO
#
#  Parametros           p_tipo	= tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:            p_numero	= Numero de Contrato
#		p_rep	= 'V'=Adeudos Vigentes, 'T'=Todo el adeudo ( letra diferente de 'V' )
#                             	pref	= Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}	
	returning	varchar(200) as Concepto,
		Integer as Cant_Recolec,
		Money(12,2) as Importe_Adeudos,
		Money(12,2) as Importe_Recargos,
		Money(12,2) as Importe_Multa,
		Money(12,2) as Importe_Gastos;

define v_control_contrato		int;
define a_Periodo_CN, a_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE		varchar(7);
define  v_ref     char(7);

define v_status_licencias		int;
define v_concepto_licencias		char(100);

define vr_Concepto  varchar(100);
define vr_Importe_Multa_Descto, vr_Importe_Gastos  money(12,2);

--define v_r_rubro, v_r_cta_aplic, v1_r_cta_aplic, v2_r_cta_aplic, v3_r_cta_aplic	int; --, v1_r_rubro, v2_r_rubro, v3_r_rubro	int;
--define v_r_importe, v1_r_importe, v2_r_importe, v3_r_importe	money(12,2);
--define v_DetFolReq, v0_DetFolReq			varchar(100);
--define v_importe_multa, v_tot_gastos, v_porcentaje_multa	Money(12,2);

  
define v_Ctrol_Operacion, v_exedencias	int;
define v_descripcion		varchar(50);
define v_importe		Money(12,2);
define v_aso_mes_pago		date;
define v_Axo, v_Mes	int;
define v_Importe_recargo, v_importe_rec1, v_importe_rec2	Money(12,2);
define v_mensaje_proc	varchar(200);

define v_contador		int;

-- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
define v_porcdescto			int;
define v_mensaje			varchar(255);									
define v_Multa20, v_DsctoMulta	money(12,2);
define v_Multa20_tot, v_DsctoMulta_tot	money(12,2);

Let v_porcdescto	= 0;
Let v_mensaje	= '';
Let v_Multa20	= 0;
Let v_DsctoMulta	= 0;
Let v_Multa20_tot	= 0;
Let v_DsctoMulta_tot= 0;
--

Let v_status_licencias = 0;
Let v_concepto_licencias = ' ';

Let a_Periodo_CN = ' ';
Let a_Periodo_EXE = ' ';
Let r_Periodo_CN = ' ';
Let r_Periodo_EXE = ' ';

Let v_Ctrol_Operacion = 0;
Let v_exedencias = 0;
Let v_descripcion = ' ';
Let v_importe = 0;
Let v_Axo = 0;
Let v_Mes = 0;
Let v_Importe_recargo = 0;
Let v_importe_rec1 = 0;
Let v_importe_rec2 = 0;

Let v_contador = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO a_Periodo_CN, a_Periodo_EXE;

Let r_Periodo_CN = a_Periodo_CN;
Let r_Periodo_EXE = a_Periodo_EXE;
if p_rep <> 'V' then
	if trim(pref)='' then
   		let v_ref=year(today) || '-' || 12;
   		--let v_ref=9999 || '-' || 12;
	else
   		let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
	end if;
	Let a_Periodo_CN = v_ref;
	Let a_Periodo_EXE = v_ref;
end if;

let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato  INTO  v_control_contrato   FROM ta_16_contratos a, ta_16_tipo_aseo b
                               WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

	FOREACH
	Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
	Into v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion
	From ta_16_pagos a, ta_16_operacion b
	Where a.Control_Contrato = v_control_contrato  and aso_mes_pago <= a_Periodo_CN  and a.Status_Vigencia = 'V'
	And b.ctrol_operacion = a.ctrol_operacion
	Order By a.aso_mes_pago, a.Ctrol_Operacion

	-- desde aqui
	if v_importe > 0 then
		if v_contador = 0 then
			-- LICENCIAS RELACIONADAS
			EXECUTE PROCEDURE sp16_LicenciaGiro_F1 ( p_tipo, p_numero ) INTO v_status_licencias, v_concepto_licencias;
			if v_status_licencias > 0 then
				RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' ' || v_concepto_licencias, Null, Null, Null, Null, Null    with resume;
			end if;

			-- REQUERIMIENTOS
			Let vr_Importe_Multa_Descto = 0;
			Let vr_Importe_Gastos = 0;
			FOREACH
			EXECUTE PROCEDURE sp_Requerim_3Col ( 16, v_control_contrato ) INTO vr_Concepto, vr_Importe_Multa_Descto, vr_Importe_Gastos
			if ( vr_Importe_Multa_Descto <> 0 ) or ( vr_Importe_Gastos <> 0 ) then
				RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' ' || vr_Concepto, Null, Null, Null, vr_Importe_Multa_Descto, vr_Importe_Gastos	with resume;
			end if;
			END FOREACH;
		end if;

		if v_Ctrol_Operacion = 6 then
			SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
                                                      WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN);
		else
                                                      SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
                                                      WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_EXE);
		end if;

		if v_Importe_recargo > 0 then  -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
			execute PROCEDURE sp_multa_DestoMulta ( 16, v_control_contrato, v_axo, v_Mes, v_importe ) INTO v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;
			if v_Multa20 <> 0 then
				Let v_Multa20_tot = v_Multa20_tot + v_Multa20;
			end if;
			if v_DsctoMulta <> 0 then
				Let v_DsctoMulta_tot = v_DsctoMulta_tot + v_DsctoMulta;
			end if;
		end if;

                                    if v_Importe_recargo <> 0 then
                                    	Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                                      EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
                                                      				INTO v_importe_rec2, v_mensaje_proc;
		end if;
                                    if v_importe_rec2 <> 0 then
                                    	Let v_importe_rec2 = v_importe_rec2 * -1;
                                    end if;
		Let v_contador = 1;
	end if;	
	-- hasta aqui
	if v_Ctrol_Operacion = 6 then
		if v_importe_rec1 <> 0 then
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, v_importe_rec1, 0, 0  with resume;
			if v_importe_rec2 > 0 then
                                                      	RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' Dscto. al Rcgo del Adeudo', Null, Null, v_importe_rec2, 0, 0 	with resume;
			end if;
		else
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, 0, 0, 0 	with resume;
		end if;
	else
		if v_aso_mes_pago <= a_Periodo_EXE then
			if v_importe_rec1 <> 0 then
				RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, v_importe_rec1, 0, 0  with resume;
				if v_importe_rec2 > 0 then
                                                      		RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' Dscto. al Rcgo del Adeudo', Null, Null, v_importe_rec2, 0, 0 	with resume;
				end if;
			else
				RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, 0, 0, 0 	with resume;
			end if;
		end if;
	end if;

	END FOREACH;

		if v_contador = 0 then
			-- LICENCIAS RELACIONADAS
			EXECUTE PROCEDURE sp16_LicenciaGiro_F1 ( p_tipo, p_numero ) INTO v_status_licencias, v_concepto_licencias;
			if v_status_licencias > 0 then
				RETURN year(today) || '-' || LPAD(1,2,'0') || ' ' || v_concepto_licencias, Null, Null, Null, Null, Null    with resume;
			end if;

			-- REQUERIMIENTOS
			Let vr_Importe_Multa_Descto = 0;
			Let vr_Importe_Gastos = 0;
			FOREACH
			EXECUTE PROCEDURE sp_Requerim_3Col ( 16, v_control_contrato ) INTO vr_Concepto, vr_Importe_Multa_Descto, vr_Importe_Gastos
			if ( vr_Importe_Multa_Descto <> 0 ) or ( vr_Importe_Gastos <> 0 ) then
				RETURN year(today) || '-' || LPAD(1,2,'0') || ' ' || vr_Concepto, Null, Null, Null, vr_Importe_Multa_Descto, vr_Importe_Gastos	with resume;
			end if;
			END FOREACH;
		end if;

		-- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
		if v_Multa20_tot <> 0 then
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' ' || 'Multas ', Null, Null, Null, v_Multa20_tot, 0	with resume;
		end if;
		if v_DsctoMulta_tot <> 0 then
			Let v_DsctoMulta_tot = v_DsctoMulta_tot * -1;
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0') || ' ' || 'Descto. a Multa ', Null, Null, Null, v_DsctoMulta_tot, 0	with resume;
		end if;

end if;
end procedure;

CREATE PROCEDURE "informix".spd_siapa_23hrs_ex( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;

   foreach
select  a.cvecuenta , k.fecha ,  k.importe ,  a.bim_ini  ,   a.axo_ini  ,  a.bim_fin  ,  a.axo_fin  ,   a.id_transaccion 
 into v_cvecuenta , v_fecha ,  v_importe ,  v_bim_ini  ,   v_axo_ini  ,  v_bim_fin  ,  v_axo_fin  ,   v_id_transaccion 
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal = 'SIAPA' and a.cancelacion is null
 and k.cvekiosco = a.cvepago and a.id_transaccion = 67073

execute procedure db_ingresos:spd_pagpredkioSiapa5( v_cvecuenta, v_fecha,  v_importe, v_bim_ini, v_axo_ini, v_bim_fin , v_axo_fin , v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

CREATE PROCEDURE "pgmoreno".sp_r000 ( )
                returning	date as aso_mes_pago,
		int as Axo,
		int as Mes,
		int as Ctrol_operacion,
		int as Excedencias,
		money(12,2) as Importe,
		varchar(50) as Descripcion;

define v_aso_mes_pago date;
define v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias int;
define v_importe money(12,2);
define v_descripcion varchar(50);

Let v_Axo = 0;
Let v_Mes = 0;
Let v_Ctrol_Operacion = 0;
Let v_exedencias = 0;
Let v_importe = 0;
Let v_descripcion = ' ';

FOREACH
Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
Into v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion
From ta_16_pagos a, ta_16_operacion b
Where a.Control_Contrato = 3277  and a.aso_mes_pago <= '2018-05'  and a.Status_Vigencia = 'V' and a.ctrol_operacion = 6
And b.ctrol_operacion = a.ctrol_operacion
UNION ALL
Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
From ta_16_pagos a, ta_16_operacion b
Where a.Control_Contrato = 3277  and a.aso_mes_pago <= '2018-05'  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
And b.ctrol_operacion = a.ctrol_operacion
Order By 1, 4

	RETURN v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion  with resume;

END FOREACH;

END PROCEDURE;

CREATE PROCEDURE "pgmoreno".sp16_adeudos_ind ( p_tipo char(1), p_numero int, par_a_Periodo_CN char(7), par_a_Periodo_EXE char(7), par_r_Periodo_CN char(7), par_r_Periodo_EXE char(7) )
{######################################################################
#  Procedimiento:    sp16_Adeudos_Ind
#  Descripcion:      Interfaz de consulta de detalle de Adeudos de ASEO CONTRATADO
#
#  Parametros           p_tipo			= tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:            p_numero			= Numero de Contrato
#		par_a_Periodo_CN		= periodo de adeudo requerido ( Cuota normal )
#		par_a_Periodo_EXE	= periodo de adeudo requerido ( exedencias )
#		par_r_Periodo_CN		= periodo de adeudo requerido ( Cuota normal recargos )
#		par_r_Periodo_EXE	= periodo de adeudo requerido ( exedencias recargos )
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}	
	returning	int as Axo,
		int as Mes,
		varchar(200) as Concepto,
		Int as Cant_Recolec,

		int as Cta_Aplic_Adeudo, 
		Money(12,2) as Importe_Adeudo, 

		int as Cta_Aplic_Multa, 
		Money(12,2) as Importe_Multa, 

		int as Cta_Aplic_Dscto_Multa, 
		Money(12,2) as Importe_Dscto_Multa, 

		int as Cta_Aplic_Rcgo_Adeudo, 
		Money(12,2) as Importe_Rcgo_Adeudo, 

		int as Cta_Aplic_DsctoRcgo_Adeudo, 
		Money(12,2) as Importe_DsctoRcgo_Adeudo, 

		int as Cta_Aplic_Actualiza_Adeudo, 
		Money(12,2) as Importe_Actualiza_Adeudo, 

		int as Cta_Aplic_DsctoActualiza_Adeudo, 
		Money(12,2) as Importe_DsctoActualiza_Adeudo; 

define v_control_contrato				int;

define v_aso_mes_pago				date;
define v_Ctrol_Operacion, v_exedencias, v_Axo, v_Mes	int;
define v_descripcion				varchar(50);
define v_importe					money(12,2);

define v_Importe_recargo				money(12,2);
define v_importe_rec1				money(12,2);
define v_importe_rec2				money(12,2);
define v_mensaje_proc				varchar(200);

define v_importe_act1				money(12,2);
define v_importe_act2				money(12,2);

-- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
define v_porcdescto			int;
define v_mensaje			varchar(255);									
define v_Multa20, v_DsctoMulta	money(12,2);

Let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato  INTO  v_control_contrato   FROM ta_16_contratos a, ta_16_tipo_aseo b
                               WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

	Let v_Ctrol_Operacion = 0;	-- adeudos
	Let v_exedencias = 0;
	Let v_Axo = 0;
	Let v_Mes = 0;
	Let v_importe = 0;
	Let v_descripcion = ' ';

	Let v_Importe_recargo = 0;	-- recargos
	Let v_importe_rec1 = 0;
	Let v_importe_rec2 = 0;	-- descuento a recargos
	Let v_mensaje_proc = ' ';

	Let v_porcdescto	= 0;	-- Multa y descuento a la multa
	Let v_Multa20	= 0;
	Let v_DsctoMulta	= 0;
	Let v_mensaje	= '';

	Let v_importe_act1 = 0;
	Let v_importe_act2 = 0;

	FOREACH
	Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
	Into v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion
	From ta_16_pagos a, ta_16_operacion b
	Where a.Control_Contrato = v_control_contrato  and a.aso_mes_pago <= par_a_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion = 6
	And b.ctrol_operacion = a.ctrol_operacion
	UNION ALL
	Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
	From ta_16_pagos a, ta_16_operacion b
	Where a.Control_Contrato = v_control_contrato  and a.aso_mes_pago <= par_a_Periodo_EXE  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
	And b.ctrol_operacion = a.ctrol_operacion
	Order By 1, 4

	-- desde aqui
	if v_importe > 0 then
		if v_Ctrol_Operacion = 6 then
			SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
                                                      WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND ( par_r_Periodo_CN );
		else
                                                      SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
                                                      WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND ( par_r_Periodo_EXE );
		end if;

		if v_Importe_recargo > 0 then  -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
			execute PROCEDURE sp_multa_DestoMulta ( 16, v_control_contrato, v_axo, v_Mes, v_importe ) INTO v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;
		end if;

                                    if v_Importe_recargo <> 0 then
                                    	Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                                      EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
                                                      				INTO v_importe_rec2, v_mensaje_proc;
		end if;

                                    if v_importe_rec2 <> 0 then
                                    	Let v_importe_rec2 = v_importe_rec2 * -1;
                                    end if;

		-- v_importe_act  actualizacion del adeudo
		-- v_importe_act2 descuento de la actualizacion

		if v_Ctrol_Operacion = 6 then
                                    	if Year(v_aso_mes_pago) < Year(Current) then
				-- 'Rezago del Adeudo '
				RETURN v_Axo, LPAD(v_Mes,2,'0'), 'Periodo de Adeudo por Rezago de ' || v_descripcion, v_exedencias, 250130000, v_importe, 
				515002003, v_Multa20, 515042003, v_DsctoMulta, 390200000, v_importe_rec1, 390240000, v_importe_rec2, 
				0, v_importe_act1, 0, v_importe_act2  with resume;
			else
				-- 'Actual de Adeudo '
				RETURN v_Axo, LPAD(v_Mes,2,'0'), 'Periodo de Adeudo Actual de ' || v_descripcion, v_exedencias, 250100000, v_importe, 
				515002003, v_Multa20, 515042003, v_DsctoMulta, 390200000, v_importe_rec1, 390240000, v_importe_rec2, 
				0, v_importe_act1, 0, v_importe_act2  with resume;
			end if;
		else
                                    	if Year(v_aso_mes_pago) < Year(Current) then
				-- 'Rezago del Adeudo '
				RETURN v_Axo, LPAD(v_Mes,2,'0'), 'Periodo de Adeudo por Rezago de ' || v_descripcion, v_exedencias, 250230000, v_importe, 
				515002003, v_Multa20, 515042003, v_DsctoMulta, 390200000, v_importe_rec1, 390240000, v_importe_rec2, 
				0, v_importe_act1, 0, v_importe_act2  with resume;
			else
				-- 'Actual de Adeudo '
				RETURN v_Axo, LPAD(v_Mes,2,'0'), 'Periodo de Adeudo Actual de ' || v_descripcion, v_exedencias, 250200000, v_importe, 
				515002003, v_Multa20, 515042003, v_DsctoMulta, 390200000, v_importe_rec1, 390240000, v_importe_rec2, 
				0, v_importe_act1, 0, v_importe_act2  with resume;
			end if;
		end if;
	end if;	
	END FOREACH;
end if;

end procedure;

CREATE PROCEDURE "informix".spd_abcrebospagos3rost(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo 	integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta      	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia     	integer,
		parObra                 integer,
		parAxofolio               integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                                Partipo_che            smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc char(1),
                pardescripcion varchar(255),
                parREFERENCIA  varchar(30)
		)
		returning integer;

		define varOperacion integer;
 define varuap_rcm  integer;
 define varpar  smallint;
 define vgrupo integer;
--set debug file to "ivan.log";
--trace on;

--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;
let vgrupo = 12;
--si la opcion fue insertar
if parId_modulo = 12 then
   if parId_regmodulo = 1 then
      let vgrupo = 1207; 
   end if;
   if parId_regmodulo = 2 then
      let vgrupo = 1207; 
   end if;
  if parId_regmodulo = 3 then
      let vgrupo = 12003; 
   end if ;
if parId_regmodulo = 532 then
      let vgrupo = 0; 
   end if;
   if parId_regmodulo = 533 then
      let vgrupo = 12533; 
   end if;
  if parId_regmodulo = 534 then
      let vgrupo = 12534; 
   end if ;
end if;


	
	select nvl(operacion,0) + 1
		into varOperacion 
		from ta12_operacKiosco
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario;

	
 
	insert into ta_12_recibos (fecha,
    id_rec ,
    caja ,
    operacion ,
    importe,
    cvepago ,
    id_modulo,
    id_regmodulo,
    id_rec_cta,
    regmunur ,
    mesdesde,
    axodesde ,
    meshasta ,
    axohasta ,
    nombre ,
    domicilio ,
    concepto,
    rfcini ,
    rfcnumero,
    rfccolonia ,
    obra ,
    axofolio ,
    id_usuario ,
    fecha_act ,
    descripcion, lugar_pago,kio_num_terceros,grupo, fec_pagobco) values(
    		today,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current, 
                pardescripcion, parId_banco,parREFERENCIA, vgrupo ,  parFecha );


	update	ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario;
	


return varOperacion;
--trace off;

end procedure;

CREATE PROCEDURE "informix".kio_pagodiverso3rost(
    		parnumDiv  int,   -- 548 Transmisiones , 533  Tianguis , 551  Registro civil , 549 Avaluos 
                parReferencia varchar(28),
                parnombre char(60),
                parRFC varchar(13),
                pardomicilio char(60),
                parImpCertificado money(15,2),
    		parLugarpago	integer,
                parFechapago    date
               
               
        )
		returning smallint as Reca, char(2) as caja, integer as operacion  , char(28) as linea;
-- parExtra1  para registro civil es el lugar y horario   1 oficina en horario , 2 oficina fuera de horario , 3 domicilio en horario, 4 domicilio fuera de horario
-- parExtra2  para registro civil es el tipo de contrato 1  separacion de bienes ,2 sociedad legal
-- parextra3   para registro civil es la cantidad de anotaciones marginales.


define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define v_cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_orden int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);define v_importex  money(15,2) ;
define v_hora datetime hour to minute;
define  v_linea100 varchar(110);
define v_linea28 varchar(28);
define v_id int;
define v_bco int;
define v_contrato int; 
define v_long int;
define v_contratost char(8);
define v_opcion int;
--set debug file to "pagokioDIV.TXT";
--trace on;
let v_opcion = 0;

   if parnombre = '' then
      return 0, '', 0 , '';
   end if;


 let parnombre = REPLACE(parnombre, '�?', '�');
-- 
if v_opcion = 1 then
       return 0, '', 0 , '';
end if;
 -- select * from ta_12_recibos where caja = 'I1'
 -- select * from catastro_gdl:c_recaud
 --  update ta12_operacKiosco set id_usuario = 549 where rowid = 267

 -- select rowid ,* from ta12_operacKiosco 
 -- insert into ta12_operacKiosco values (1,'I4',0, 549 , 'L')

   select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parnumDiv; 
 if parnumdiv = 549 then
    let v_concepto = parRFC ||'-Pago AVALUOS';
    let v_bco = 102; -- bbva
 end if; 
 if parnumdiv = 551 then
    let v_concepto = parRFC ||'-Pago REGISTRO CIVIL';
    let v_bco = 102; -- bbva
 end if; 

 if parnumDiv = 533 then  
    let v_concepto = parRFC ||'-Pago Tianguis';
     if parLugarpago = 1 then 
     let v_bco = 166; -- bbva
    end if;
 if parLugarpago = 2 then 
     let v_bco = 164; -- bmx  con respecto a c_reacud catastro
    end if;
 if parLugarpago = 3 then 
     let v_bco = 160;  -- hsbc
    end if;
 if parLugarpago = 4 then 
     let v_bco = 106; -- oxxo
    end if;
 if parLugarpago = 5 then 
     let v_bco = 165; -- guga21
    end if;
 if parLugarpago = 6 then 
     let v_bco = 0;  --Recaudadora
    end if;
       
 end if;

if parLugarpago <> 6 then 
    execute procedure spd_abcrebospagos3rosT(parFechapago ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 12, parnumDiv, 0, '',
              1, 0, 12, 0,  parNombre, pardomicilio,
           v_concepto, '',parnumDiv,0, 
                0,0, parnumDiv ,current,v_bco,0,0,'',0,'I','',parReferencia )
 into spoperacion;



  let varoperacion = spoperacion;
              
   let linea = 1;     
     
     if parnumDiv = 548 then             -- Transmisiones Patrimoniales
       let v_importe = parImpCertificado;
    
     end if;
  if parnumDiv = 533 then               --  para Tianguis Electronico  pago anticipado
 -- select * from ta00_conceptocobro
 -- insert into ta00_conceptocobro values(0, 
    --   select * from 
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 363099999 , parImpCertificado );
    end if;
 
   if parnumDiv = 549 then               -- para AVALUOS pago electronico
       let v_importe = parImpCertificado;
       insert into ta_12_recibosdet values(today ,varrec, varcaja,  varoperacion, 1 , v_concepto, 320300000 , parImpCertificado );
    end if;
   let v_linea28 = parReferencia;
  return varrec, varcaja, spoperacion , v_linea28 ;
  else

  return 0, '', 0 , 'RECA 6' ;
  end if;   
     

--trace off;
end procedure;

create procedure "informix".admin_encabezado_kiosco3(pcaja char(8), pfecha date, ptipo char(1) )
returning       int as interface,
                char(10) as segmento1,
                char(10) as segmento2,
                char(10) as segmento3,
                char(10) as segmento4,
                char(10) as segmento5,
                char(10) as segmento6,
                varchar(250) as descripcionrbo,
                varchar(92) as nombre,
                varchar(80) as calle,
                int as recaudadora,
                int as operacionmpio,
                money(14,2) as importerecibido, 
                int as LugarCobro;

define v_interface,v_rec,v_oper,v_idregmodulo,v_rfcnumero,v_idreccta,v_modulo,v_grupo int;
define v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6 varchar(10);
define v_knterceros varchar(32); 
define v_descrbo varchar(250);
define v_nombre varchar(92);
define v_calle varchar(80);
define v_importe money(14,2);
define v_ur char(1);
define v_placa varchar(7);
define v_lugar int;
define v_axofolio int;
define v_descrip_corta varchar(15);
define num_caja smallint;
let pcaja = upper(pcaja);
let ptipo = upper(ptipo);
select count(caja) into num_caja from ta12_operacKiosco where caja  = pcaja and tip_impresora = 'L';
if num_caja = 0 then
 return 0,' ',' ',' ',' ',' ',' ',' ',' ',' ',0,0,0,0;
end if;


if ptipo='P' then
   if pcaja = 'I3'  then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , lugar_pago , axofolio ,   descripcion[1,14]
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_lugar , v_axofolio  , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans=0 
   order by operacion
  if v_lugar is null then
    let v_lugar = 0;
 end if;
 
 if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
      let v_descrbo='';
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
      if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if ( v_grupo=12533 ) or (v_grupo=12549) then
          let v_descrbo= v_knterceros  || '  ' || v_descrip_corta;
      end if;


        
      
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=upper(v_nombre);
   else 
     if v_modulo = 48 then 
      let v_interface=29;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
   else 
   if v_modulo = 55 then 
      let v_interface=55;
      let v_descrbo=upper( v_knterceros   || '  ' || v_descrip_corta);
    else 
      let v_interface=911;
   end if ; end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe , v_lugar with resume;
   end foreach;
  else
     foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , lugar_pago , axofolio , descripcion[1,14]
   into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_lugar , v_axofolio , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans=0 
   order by operacion
  if v_lugar is null then
    let v_lugar = 0;
 end if;
  if  (pcaja = 'K1') or  (pcaja = 'K2') or  (pcaja = 'K3') or  (pcaja = 'K4') or  (pcaja = 'K5') or  (pcaja = 'K6') or  (pcaja = 'K7')
 or  (pcaja = 'K8') then
   let  v_lugar = 0;
  end if;


 if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
      let v_descrbo='';
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
      if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
      if ( v_grupo=12533 ) or (v_grupo=12549) then
           let v_descrbo= v_knterceros  || '  ' || v_descrip_corta;
      end if;
        
      
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=upper(v_nombre);
   else 
     if v_modulo = 48 then 
      let v_interface=29;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe , v_lugar with resume;
   end foreach;
  end if;
end if;
 
if ptipo='A' then
   if pcaja = 'I3'  then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo ,  nombre[48,57] , lugar_pago , axofolio , descripcion[1,14]
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_lugar , v_axofolio , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans>0 
   order by operacion
   if v_lugar is null then
     let v_lugar = 0;
 end if;
  if  (pcaja = 'K1') or  (pcaja = 'K2') or  (pcaja = 'K3') or  (pcaja = 'K4') or  (pcaja = 'K5') or  (pcaja = 'K6') or  (pcaja = 'K7')  or  (pcaja = 'K8') then
     let v_lugar = 0;
  end if; 
 
 if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
       if ( v_grupo=12533 ) or (v_grupo=12549) then
           let v_descrbo= v_knterceros  || '  ' || v_descrip_corta;
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
 if v_modulo = 48 then 
      let v_interface=29;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe, v_lugar with resume;
   end foreach;
  else
  foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo ,  nombre[48,57] , lugar_pago , axofolio , descripcion[1,14]
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_lugar , v_axofolio , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and fec_pagobco=pfecha and caja=pcaja and kio_trans>0 
   order by operacion
   if v_lugar is null then
     let v_lugar = 0;
 end if;
  if  (pcaja = 'K1') or  (pcaja = 'K2') or  (pcaja = 'K3') or  (pcaja = 'K4') or  (pcaja = 'K5') or  (pcaja = 'K6') or  (pcaja = 'K7')  or  (pcaja = 'K8') then
     let v_lugar = 0;
  end if; 
 
 if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
       if ( v_grupo=12533 ) or (v_grupo=12549) then
           let v_descrbo= v_knterceros  || '  ' || v_descrip_corta;
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
 if v_modulo = 48 then 
      let v_interface=29;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe, v_lugar with resume;
   end foreach;
  end if;
end if;

if ptipo='T' then 
  if pcaja = 'I3'  then
   foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , lugar_pago , axofolio , descripcion[1,14]
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_lugar , v_axofolio , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and  fec_pagobco=pfecha and caja=pcaja 
   order by operacion
  if v_lugar is null then
    let v_lugar = 0;
    end if;
  if  (pcaja = 'K1') or  (pcaja = 'K2') or  (pcaja = 'K3') or  (pcaja = 'K4') or  (pcaja = 'K5') or  (pcaja = 'K6') or  (pcaja = 'K7')  or  (pcaja = 'K7') then
    let v_lugar = 0;
  end if; 
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
     if ( v_grupo=12533 ) or (v_grupo=12549) then
          let v_descrbo= v_knterceros  || '  ' || v_descrip_corta;
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
   if v_modulo = 48 then 
      let v_interface=29;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe , v_lugar with resume;
   end foreach;
  else
 foreach
   select id_modulo,id_regmodulo,id_rec_cta,regmunur,rfcnumero,descripcion,nombre,domicilio,
   id_rec,operacion,importe,kio_num_terceros,grupo , nombre[48,57] , lugar_pago , axofolio , descripcion[1,14]
    into v_modulo,v_idregmodulo,v_idreccta,v_ur,v_rfcnumero,
   v_descrbo,v_nombre,v_calle,v_rec,v_oper,v_importe,v_knterceros,v_grupo , v_placa , v_lugar , v_axofolio , v_descrip_corta 
   from ta_12_recibos where cvepago = 'P' and  fec_pagobco=pfecha and caja=pcaja 
   order by operacion
  if v_lugar is null then
    let v_lugar = 0;
    end if;
  if  (pcaja = 'K1') or  (pcaja = 'K2') or  (pcaja = 'K3') or  (pcaja = 'K4') or  (pcaja = 'K5') or  (pcaja = 'K6') or  (pcaja = 'K7')  or  (pcaja = 'K7') then
    let v_lugar = 0;
  end if; 
   if v_descrbo is null then
      let v_descrbo=' ';
   end if;
   if v_calle is null then
      let v_calle =' ';
   end if;
   let v_seg1=' ';
   let v_seg2=' ';
   let v_seg3=' ';
   let v_seg4=' ';
   let v_seg5=' ';
   let v_seg6=' ';
   if v_modulo = 5 then 
      let v_interface=8;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
   else 
   if v_modulo = 9 then 
      let v_interface=12;
      let v_seg1='L';
      let v_seg2=v_idregmodulo;
   else 
   if v_modulo = 13 then 
      let v_interface=14;
      let v_seg1=v_idregmodulo;
   else 
   if v_modulo = 12 then 
      let v_interface=29;
      let v_descrbo='PAGO DE '||upper(v_calle);
       if v_grupo=12003 then
         let v_descrbo=upper(v_calle);
      end if;
       if ( v_grupo=12533 ) or (v_grupo=12549) then
           let v_descrbo= v_knterceros  || '  ' || v_descrip_corta;
      end if;
   else
   if v_modulo = 14 then 
      let v_interface=16;
      let v_seg1=v_placa;
      let v_descrbo=v_nombre;
   else 
   if v_modulo = 48 then 
      let v_interface=29;
      let v_seg1=v_idreccta;
      let v_seg2=v_ur;
      let v_seg3=v_idregmodulo;
      let v_seg4=v_axofolio;
   else 
      let v_interface=911;
   end if; end if; end if; end if; end if; end if;

   return v_interface,v_seg1,v_seg2,v_seg3,v_seg4,v_seg5,v_seg6,v_descrbo,v_nombre,v_calle,
   v_rec,v_oper,v_importe , v_lugar with resume;
   end foreach;
  end if;
end if;


end procedure
;

create procedure "pgcabrer".sp_11_insmercado()
returning   int as locales,
            int as noexistelic,
            varchar(250) as licencias;

define vtotloc, vidlocal, vofna, vmerc, vcat, vlocal int;
define vlic1, vlic2, vlic3, vgiro, vidlic, vedo, vnelic int;
define vsecc char(2);
define vlet varchar(3);
define vblq varchar(2);
define vnom, vmsg varchar(60);
define vdom varchar(70);
define vsup decimal(6,2);
define vfalta date;
define vlicencias varchar(250);

let vtotloc=0;
let vlicencias='';
let vnelic=0;

foreach 
  select oficina,num_mercado,categoria,seccion,local,letra_local,bloque,nombre,
  domicilio, superficie, fecha_alta, licencia1, licencia2, licencia3
  into vofna, vmerc, vcat, vsecc, vlocal, vlet, vblq, vnom, vdom,
  vsup, vfalta, vlic1, vlic2, vlic3
  from ta_11_localpaso 
  order by local, letra_local, bloque 

  let vtotloc=vtotloc+1;
  insert into ta_11_locales values(0,vofna, vmerc, vcat, vsecc, vlocal, vlet, vblq,
  1, 0, vnom, '', vdom, 'J', 7, '', vsup, 0, vfalta, null, current, 'A', 93, 10, 0, null);
  let vidlocal = dbinfo("sqlca.sqlerrd1");
  
  if vlic1>0 then
     if exists(select * from catastro_gdl:licencias where licencia=vlic1) then
        select id_licencia, id_giro into vidlic, vgiro
        from catastro_gdl:licencias where licencia=vlic1;
        insert into ta_11_licencias values(0,vidlocal,vidlic,'V',today,null,current,93);
        update ta_11_locales set giro=vgiro where id_local=vidlocal;
     else
        let vnelic=vnelic+1;
        let vlicencias=vlicencias||vlic1||' ';
     end if;
  end if;

  if vlic2>0 then
     if exists(select * from catastro_gdl:licencias where licencia=vlic2) then
        select id_licencia, id_giro into vidlic, vgiro
        from catastro_gdl:licencias where licencia=vlic2;
        insert into ta_11_licencias values(0,vidlocal,vidlic,'V',today,null,current,93);
     else
        let vnelic=vnelic+1;
        let vlicencias=vlicencias||vlic2||' ';
     end if;
  end if;

  if vlic3>0 then
     if exists(select * from catastro_gdl:licencias where licencia=vlic3) then
        select id_licencia, id_giro into vidlic, vgiro
        from catastro_gdl:licencias where licencia=vlic3;
        insert into ta_11_licencias values(0,vidlocal,vidlic,'V',today,null,current,93);
     else
        let vnelic=vnelic+1;
        let vlicencias=vlicencias||vlic3||' ';
     end if;  
  end if; 

  execute procedure spd_11_genadeudos(vidlocal,vmerc,vcat,vsecc,vsup,10,vfalta,93) into vedo, vmsg; 
end foreach;
return vtotloc, vnelic, vlicencias;
end procedure;

CREATE PROCEDURE "informix".spd_abcreboskiosco(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo 	integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta      	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia     	integer,
		parObra                 integer,
		parAxofolio               integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                                Partipo_che            smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc char(1),
                pardescripcion varchar(255)
		)
		returning integer;

		define varOperacion integer;
  define varuap_rcm  integer;
  define varpar  smallint;
  define vgrupo integer;
  define vlugar_pago smallint;
--set debug file to "ivan.log";
--trace on;

--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;
let vgrupo = 12;
--si la opcion fue insertar
if parId_modulo = 12 then
   if parId_regmodulo = 1 then
      let vgrupo = 1207; 
   end if;
   if parId_regmodulo = 2 then
      let vgrupo = 1207; 
   end if;
  if parId_regmodulo = 3 then
      let vgrupo = 12003; 
   end if ;
end if;

--select * from ta12_operacKiosco
	
	select nvl(operacion,0) + 1 , lugar_pago
		into varOperacion , vlugar_pago
		from ta12_operacKiosco
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario  and tip_impresora = 'L';

	
 
	insert into ta_12_recibos (fecha,
    id_rec ,
    caja ,
    operacion ,
    importe,
    cvepago ,
    id_modulo,
    id_regmodulo,
    id_rec_cta,
    regmunur ,
    mesdesde,
    axodesde ,
    meshasta ,
    axohasta ,
    nombre ,
    domicilio ,
    concepto,
    rfcini ,
    rfcnumero,
    rfccolonia ,
    obra ,
    axofolio ,
    id_usuario ,
    fecha_act ,
    descripcion, lugar_pago,grupo, fec_pagobco) values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current, 
                pardescripcion, vlugar_pago, vgrupo , parFecha );


	update	ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario and tip_impresora = 'L';
	


return varOperacion;
--trace off;

end procedure;

CREATE PROCEDURE "informix".spd_hsbcws_20hrs( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;

   foreach
select  a.cvecuenta , k.fecha ,  k.importe ,  a.bim_ini  ,   a.axo_ini  ,  a.bim_fin  ,  a.axo_fin  ,   a.id_transaccion 
 into v_cvecuenta , v_fecha ,  v_importe ,  v_bim_ini  ,   v_axo_ini  ,  v_bim_fin  ,  v_axo_fin  ,   v_id_transaccion 
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal = 'HSBCSUC' and a.cancelacion is null
 and k.cvekiosco = a.cvepago 

execute procedure db_ingresos:spd_pagpredkioHSBCws( v_cvecuenta, v_fecha,  v_importe, v_bim_ini, v_axo_ini, v_bim_fin , v_axo_fin , v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkiohsbcws(
    		parcvecuenta    integer,
                parfechaPAgo    date ,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint, 
    		parAxohasta  	smallint,
    		
                parIdTransKio   integer
        )
		returning smallint , char(2), integer, char(28), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int; 
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define pg_recaud int;
define pg_caja char(2);
define pg_folio int;
define pg_fecha date ;
define pg_cvecuenta int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
  
   if varcvepago > 0 then
      select recaud , caja , folio , fecha , cvecuenta into
             pg_recaud , pg_caja , pg_folio , pg_cvecuenta
      from catastro_gdl:pagos where cvepago = varcvepago ;

       update db_ingresos:ta_12_recibos set cvepago = 'C' 
       where fecha = pg_fecha and id_rec = pg_recaud and caja =  pg_caja and operacion = pg_folio and id_modulo = 5 
        and rfcnumero = pg_cvecuenta and cvepago = 'P';
       insert into catastro_gdl:pagoscan values(0,varcvepago , 'bmxws' ,parfechaPAgo);
    end if;
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
 --set debug file to "pago13";
 --trace on;
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;

  select a.recaud , a.urbrus , a.cuenta , a.nombre_completo , 
   trim(nvl(a.c_calle,'')) || ' # Ext ' || trim(nvl(a.c_noexterior, '')) || ' # Int ' || trim(nvl(a.c_interior,'')),
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,'')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,''))
   || '@CVECATASTRAL ' || nvl(CVECATNVA,'') || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa  

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip   , v_hora
 from catastro_gdl:datos_gralKio a 
 where a.cvecuenta = parcvecuenta;

  select id_rec , caja  into varrec , varcaja
 --- select *  
  from ta12_operacKiosco
  where id_usuario = 556; 
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(parfechaPAgo ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial en HSBC ventanilla de ' || parcvecuenta , '',parcvecuenta,0,
                0,0,556,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'HSBCws' ;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, parfechaPAgo, v_hora , 
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1"); 

                
let linea = 1;     
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
execute procedure  catastro_gdl:kiosco_totalespred_nvo( parcvecuenta , parAxohasta, parMeshasta, 1) 
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 
if v_ob = 'D' then 
     if v_cuenta <> 550800000   then
  insert into ta_12_recibosdet
        ( fecha       , id_rec , caja    , operacion     , linea , descripcion , cuenta    , importe )
  values( parfechaPAgo, varrec , varcaja ,  varoperacion , linea ,  v_concepto ,   v_cuenta, v_importe );
     end if;
     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)  
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea +1 ;
 end if;
if v_ob = 'T' then 
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
 select   s.multa,  s.gasto,  s.multavir 
    into   v_mulpag,  v_gaspag,  v_multasvir 
      from  catastro_gdl:saldos s  where  s.cvecuenta= parcvecuenta;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq) 
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta 
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;

    insert into catastro_gdl:banamex(cvepago,cvecuenta,recaud,folio ,caja,operacion,fecha,fechapago,
       importe,importepago, tipopago, fecarga) 
     values (varcvepago,parcvecuenta, 165 , varoperacion , '17', varoperacion, today, 
              parfechaPAgo, parImpCertificado, parImpCertificado,5,parfechaPAgo);
   
if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor , 
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);
 

select a.linea into v_lineacapt2 from catastro_gdl:linea_capturapred a, catastro_gdl:liga_linea_trans t 
where  t.id_transaccion = parIdTransKio and t.refer_id = a.id;

--select * from catastro_gdl:linea_capturapred 
--select * from catastro_gdl:liga_linea_trans 

    execute  PROCEDURE linea_pagok(v_lineacapt2, 167, parImpCertificado, 'K',varcvepago,
             parfechaPAgo, varrec , varcaja, varoperacion, 'HSBCws') into  estatus ,mensaje ;
	-- COMMIT WORK;   
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago;
--trace off;
end procedure
;

CREATE PROCEDURE "informix".spd_bmxws_20hrs( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;
define v_cvekiosco integer;

   foreach
select  a.cvecuenta , k.fecha ,  k.importe ,  a.bim_ini  ,   a.axo_ini  ,  a.bim_fin  ,  a.axo_fin  ,   a.id_transaccion , k.cvekiosco
 into v_cvecuenta , v_fecha ,  v_importe ,  v_bim_ini  ,   v_axo_ini  ,  v_bim_fin  ,  v_axo_fin  ,   v_id_transaccion , v_cvekiosco
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal = 'BMXSUC' and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null

execute procedure db_ingresos:spd_pagpredkioBmxws( v_cvecuenta, v_fecha,  v_importe, v_bim_ini, v_axo_ini, v_bim_fin , v_axo_fin , v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;

 update catastro_gdl:k_pagos k set fec_afec = today where cvekiosco = v_cvekiosco and fec_afec is null;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_bbvaws_20hrs( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;
define v_cvekiosco integer;

   foreach
select  a.cvecuenta , k.fecha ,  k.importe ,  a.bim_ini  ,   a.axo_ini  ,  a.bim_fin  ,  a.axo_fin  ,   a.id_transaccion , k.cvekiosco
 into v_cvecuenta , v_fecha ,  v_importe ,  v_bim_ini  ,   v_axo_ini  ,  v_bim_fin  ,  v_axo_fin  ,   v_id_transaccion , v_cvekiosco
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal = 'BBVASUC' and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null

execute procedure db_ingresos:spd_pagpredkioBBVAws( v_cvecuenta, v_fecha,  v_importe, v_bim_ini, v_axo_ini, v_bim_fin , v_axo_fin , v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;
update catastro_gdl:k_pagos set fec_afec = today where cvekiosco = v_cvekiosco and fec_afec is null;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredinterbco( parIdTransKio   integer  )
		returning smallint , char(2), integer, char(28), integer;


define varrec 	        smallint;
define varCaja 		char(2);
define spoperacion 	integer;
define v_lineacapt2 varchar(28);
define varcvepago int;

define parcvecuenta    integer;
define parfechaPAgo    date ;
define parImpCertificado money(15,2);

define parMesdesde 	smallint;
define parAxodesde 	smallint;
define parMeshasta    	smallint; 
define parAxohasta  	smallint;
define parcvekiosco     integer;
define parsucursal      varchar(8);
define var_idusuario    integer;
define varFecha 	date;
define varOperacion 	integer;
define v_recaud         smallint;
define v_urbrus         char(1);
define v_cuenta 	integer;
define v_nombre         char(60);
define v_domicilio      char(60);
define v_ubicacion      char(60);
define linea integer ;
define cuenta integer;

define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);

define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int; 
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;

define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define pg_recaud int;
define pg_caja char(2);
define pg_folio int;
define pg_fecha date ;
define pg_cvecuenta int;
define var_descr_bco varchar(12);
define v_lugar_pago int;


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
  
   if varcvepago > 0 then
      select recaud , caja , folio , fecha , cvecuenta into
             pg_recaud , pg_caja , pg_folio , pg_cvecuenta
      from catastro_gdl:pagos where cvepago = varcvepago ;

       update db_ingresos:ta_12_recibos set cvepago = 'C' 
       where fecha = pg_fecha and id_rec = pg_recaud and caja =  pg_caja and operacion = pg_folio and id_modulo = 5 
        and rfcnumero = pg_cvecuenta and cvepago = 'P';
       insert into catastro_gdl:pagoscan values(0,varcvepago , 'interbco' ,parfechaPAgo);
    end if;
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
 set debug file to "interbco";
 trace on;
 let v_r = 'N';

 let varcvepago = 0;
 let  v_mulpag = 0;
 let v_multavir = 0;
 let v_gaspag = 0;
 let v_saldosfavor = 0;


--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;

select  a.cvecuenta, k.fecha, k.importe, a.bim_ini, a.axo_ini, a.bim_fin, a.axo_fin,  k.cvekiosco, a.sucursal
 into parcvecuenta , parfechaPAgo , parImpCertificado , parMesdesde , parAxodesde, parMeshasta , parAxohasta , parcvekiosco , parsucursal
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where id_transaccion = parIdTransKio and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null ;

 --let axocal = (parAxodesde/100);
 --let axocal = axocal *100;
 --let p_desde = (parMesdesde * 100) + (parAxodesde - axocal);
 --let axocal = (parAxohasta/100);
 --let axocal = axocal *100;
 --let p_hasta = (parMeshasta * 100) + (parAxohasta - axocal);

 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo , 
   trim(nvl(a.c_calle,'')) || ' # Ext ' || trim(nvl(a.c_noexterior, '')) || ' # Int ' || trim(nvl(a.c_interior,'')),
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,'')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta 
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,''))
   || '@CVECATASTRAL ' || nvl(CVECATNVA,'') || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr 
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa , extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,  catdescrip   , v_hora 
  from catastro_gdl:datos_gralKio a 
  where a.cvecuenta = parcvecuenta;
 
  select id_rec , caja , id_usuario , descripcion , lugar_pago 
  into varrec , varcaja , var_idusuario , var_descr_bco , v_lugar_pago
      from db_ingresos:ta12_operacKiosco
      where id_via = trim(parsucursal) and tip_impresora = 'L'; 
  -- BEGIN WORK;
     let v_r = 'S';


  execute procedure spd_abcreboskiosco(parfechaPAgo ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus, parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial en ' || trim(var_descr_bco) || ' de ' || parcvecuenta , '',parcvecuenta,0,
                0,0, var_idusuario ,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;

--catastro pago
  let us = trim(parsucursal) ;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, parfechaPAgo, v_hora , parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1"); 
                
let linea = 1;     
let v_suma =0;

FOREACH
   execute procedure  catastro_gdl:internet_totalespred( parIdTransKio)  
   into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans 
if v_ob = 'D' then 
   if v_cuenta <> 550800000   then
       insert into ta_12_recibosdet ( fecha , id_rec, caja, operacion, linea, descripcion, cuenta, importe )
        values( parfechaPAgo, varrec , varcaja ,  varoperacion , linea ,  v_concepto ,   v_cuenta, v_importe );
   end if;
    if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 1 then
    insert into catastro_gdl:auditoria (cvecuenta, cvepago, cvectaapl, recaudpago, monto, cancelacion, axopago,  bimini)  
           values (parcvecuenta, varcvepago, v_cuenta, varrec, v_importe, 'N', 0, 0);
   end if;
       let linea = linea +1 ;
end if;
if v_ob = 'T' then 
   let v_suma = v_importe;
end if;
end FOREACH;



-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach

  select sum(multa) , sum(multavir) into v_mulpag , v_multasvir  from catastro_gdl:k_detsaldos_nvo where cvekiosco = parcvekiosco;

     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq) 
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta set estado = 'P' , cvepago = varcvepago
            where cvecuenta = parcvecuenta and estado = 'V';
end if;
-- insertar la detalle de lugar de pago en este caso los datos del siapa. select * from catastro_gdl:banamex

 -- select * from banamex
    insert into catastro_gdl:banamex(cvepago,cvecuenta,recaud,folio ,caja,operacion,fecha,fechapago,
       importe,importepago, tipopago, fecarga) 
     values (varcvepago,parcvecuenta, v_lugar_pago , varoperacion , varcaja, varoperacion, today, 
              parfechaPAgo, parImpCertificado, parImpCertificado,5, parfechaPAgo);
   
if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor , 
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta, parMesdesde, parAxodesde, parMeshasta, parAxohasta, 
                    varcvepago ,  v_urbrus, varrec ,0);
 
--select * from liga_linea_trans where id_transaccion =  parIdTransKio;
select a.linea into v_lineacapt2 from catastro_gdl:linea_capturapred a, catastro_gdl:liga_linea_trans t 
where  t.id_transaccion = parIdTransKio and t.refer_id = a.id;

  
  execute  PROCEDURE linea_pagok(v_lineacapt2, v_lugar_pago, parImpCertificado, 'W' ,varcvepago,
             parfechaPAgo, varrec , varcaja, varoperacion, parsucursal) into  estatus ,mensaje ;
	-- COMMIT WORK;   
 return varrec, varcaja, spoperacion , v_lineacapt2, varcvepago;
 trace off;
 end procedure

--select * from ta_12_recibos where fecha = today and caja = '16'
;

CREATE PROCEDURE "informix".spd_interbancario_20hrs( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;
define v_cvekiosco integer;

   foreach
select   a.id_transaccion , k.cvekiosco
  into   v_id_transaccion , v_cvekiosco
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal in (   '@BBVA' ) and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null

execute procedure db_ingresos:spd_pagpredinterbco(  v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;

 update catastro_gdl:k_pagos k set fec_afec = today where cvekiosco = v_cvekiosco and fec_afec is null;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

CREATE PROCEDURE "pgcabrer".spd_11_ade_axo(
parm_axo integer,
parm_mes integer,
parm_cuota money(10,2))
returning integer, 
               integer,
               integer,
               integer,
               char(2),
               integer,
               char(3),
               char(2),
               char(60),
               char(30),
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2),
               money(10,2);
define    v_oficina_g integer;
define    v_mercado_g integer;
define    v_control_g integer;
define    v_categoria_g integer;
define    v_seccion_g varchar(2);
define    v_local_g integer;
define    v_letra_g varchar(3);
define    v_bloque_g varchar(2);
define    v_nombre_g char(60);
define    v_descripcion_g char(30);
define    v_adeudo_g money(10,2);
define    v_control_a integer;
define    v_local_a integer;
define    v_axo_a integer;
define    v_mes_a integer;
define    v_adeudo_a money(10,2);
define    v_fecha_a date;
define    v_id_usuario_a integer;
define    v_ade_total money(10,2);
define    v_ade_2008 money(10,2);
define    v_ade_2007 money(10,2);
define    v_ade_2006 money(10,2);
define    v_ade_2005 money(10,2);
define    v_ade_2004 money(10,2);
define    v_ade_ant money(10,2);
let v_ade_total=0;
let v_ade_2008=0;
let v_ade_2007=0;
let v_ade_2006=0;
let v_ade_2005=0;
let v_ade_2004=0;
let v_ade_ant=0;
foreach
    select a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,a.nombre,a.id_local,b.descripcion,sum(c.importe) into
          v_oficina_g,v_mercado_g,v_categoria_g,v_seccion_g,v_local_g,v_letra_g,v_bloque_g,v_nombre_g,v_control_g,
          v_descripcion_g,v_adeudo_g
          from ta_11_locales a,ta_11_mercados b,ta_11_adeudo_local c
          where ((c.axo=parm_axo and c.periodo<=parm_mes) or (c.axo<parm_axo))
          and a.oficina=b.oficina
          and a.num_mercado=b.num_mercado_nvo
          and a.id_local=c.id_local
          group by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,a.nombre,a.id_local,b.descripcion
          having sum(c.importe)>=parm_cuota
          order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque
          let v_ade_2008=0;
          let v_ade_2007=0;
          let v_ade_2006=0;
          let v_ade_2005=0;
          let v_ade_2004=0;
          let v_ade_ant=0;
         foreach
         select axo,sum(importe) into v_axo_a,v_adeudo_a
              from ta_11_adeudo_local
              where id_local=v_control_g
              and  ((axo=parm_axo and periodo<=parm_mes) or (axo<parm_axo))
         group by axo
         if  v_axo_a=2008 then
             let v_ade_2008=v_ade_2008+v_adeudo_a;
         else
         if  v_axo_a=2007 then
             let v_ade_2007=v_ade_2007+v_adeudo_a;
         else
         if  v_axo_a=2006 then
             let v_ade_2006=v_ade_2006+v_adeudo_a;
         else
         if  v_axo_a=2005 then
             let v_ade_2005=v_ade_2005+v_adeudo_a;
         else
         if  v_axo_a=2004 then
             let v_ade_2004=v_ade_2004+v_adeudo_a;
         else 
         if  v_axo_a<=2003 then
             let v_ade_ant=v_ade_ant+v_adeudo_a;
         end if;
         end if;
         end if;
         end if;
         end if;
         end if;
         let v_ade_total=v_ade_2008+v_ade_2007+v_ade_2006+v_ade_2005+v_ade_2004+v_ade_ant;
         end foreach;
return v_control_g,v_oficina_g,v_mercado_g,v_categoria_g,v_seccion_g,v_local_g,v_letra_g,v_bloque_g,v_nombre_g,v_descripcion_g,
v_ade_ant,v_ade_2004,v_ade_2005,v_ade_2006,v_ade_2007,v_ade_2008,v_ade_total
with resume;
end foreach;
end procedure;

create procedure "pgcabrer".spd_11_convlocales(pmerc int,pvig char(1))
returning   varchar(60) as mercado,
            integer as idlocal,
            smallint as rec,
            smallint as merc,
            smallint as cat,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(10) as estado_local,
            char(3) as let_conv,
            integer as num_conv,
            smallint as axo_conv,
            date as inicio,
            date as final,
            date as movimiento,
            varchar(10) as estado_conv;

define v_rec,v_mer,v_cat,v_loc,v_numexp,v_axoexp,v_idlocal integer;
define v_edoloc,v_edoconv char(1);
define v_letexp,v_let char(3);
define v_sec,v_blq char(2);
define v_edolocn,v_edoconvn varchar(10);
define v_nmerc varchar(60);
define v_ini,v_fin,v_act date;

if pmerc=0 then
   foreach
   select f.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,
   a.vigencia,d.letras_exp,d.numero_exp,d.axo_exp,b.fecha_inicio,b.fecha_venc,fecha_modificacion,b.vigencia
   into v_nmerc,v_idlocal,v_rec,v_mer,v_cat,v_sec,v_loc,v_let,v_blq,v_edoloc,v_letexp,v_numexp,v_axoexp,
   v_ini,v_fin,v_act,v_edoconv 
   from ta_11_locales a,ta_17_conv_d_resto b, ta_17_conv_diverso d,ta_17_referencia e,ta_11_mercados f
   where b.vigencia=pvig and e.modulo=11 and 
   e.id_referencia=a.id_local and e.id_conv_resto=b.id_conv_resto and 
   b.tipo=d.tipo and b.id_conv_diver=d.id_conv_diver and f.num_mercado_nvo=a.num_mercado
   order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque
   if v_edoloc='A' then
      let v_edolocn='VIGENTE';
   else
      let v_edolocn='VIGENTE';
   end if;

   if v_edoconv='A' then
      let v_edoconvn='VIGENTE';
   else
   if v_edoconv='B' then
      let v_edoconvn='BAJA';
   else
   if v_edoconv='P' then
      let v_edoconvn='PAGADO';
   else
      let v_edoconvn='';
   end if;
   end if;
   end if;

   return v_nmerc,v_idlocal,v_rec,v_mer,v_cat,v_sec,v_loc,v_let,v_blq,v_edolocn,v_letexp,v_numexp,v_axoexp,
   v_ini,v_fin,v_act,v_edoconvn 
   with resume;
   end foreach;
end if;

if pmerc>=1 then
   foreach
   select f.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,
   a.vigencia,d.letras_exp,d.numero_exp,d.axo_exp,b.fecha_inicio,b.fecha_venc,fecha_modificacion,b.vigencia
   into v_nmerc,v_idlocal,v_rec,v_mer,v_cat,v_sec,v_loc,v_let,v_blq,v_edoloc,v_letexp,v_numexp,v_axoexp,
   v_ini,v_fin,v_act,v_edoconv 
   from ta_11_locales a,ta_17_conv_d_resto b, ta_17_conv_diverso d,ta_17_referencia e,ta_11_mercados f
   where a.num_mercado=pmerc and b.vigencia=pvig and e.modulo=11 and 
   e.id_referencia=a.id_local and e.id_conv_resto=b.id_conv_resto and 
   b.tipo=d.tipo and b.id_conv_diver=d.id_conv_diver and f.num_mercado_nvo=a.num_mercado
   order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque
   if v_edoloc='A' then
      let v_edolocn='VIGENTE';
   else
      let v_edolocn='VIGENTE';
   end if;

   if v_edoconv='A' then
      let v_edoconvn='VIGENTE';
   else
   if v_edoconv='B' then
      let v_edoconvn='BAJA';
   else
   if v_edoconv='P' then
      let v_edoconvn='PAGADO';
   else
      let v_edoconvn='';
   end if;
   end if;
   end if;

   return v_nmerc,v_idlocal,v_rec,v_mer,v_cat,v_sec,v_loc,v_let,v_blq,v_edolocn,v_letexp,v_numexp,v_axoexp,
   v_ini,v_fin,v_act,v_edoconvn 
   with resume;
   end foreach;
end if;

end procedure;

create procedure "pgcabrer".spd_11_pagosloc(pmerc int,pdsd date,phst date)
returning   char(30) as mercado,
            integer as rec,
            integer as merc,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            MONEY(16,2) as pagosrezago,
            MONEY(16,2) as pagosactual,
            MONEY(16,2) as total;
  
define v_rezago,v_actual,v_total MONEY(16,2);  
define v_mer char(30);          
define v_nme,v_ofi,v_cat,v_loc,v_id,v_pagos integer;          
define v_sec char(2);           
define v_let char(3);
define v_blq char(2);        

foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque,count(d.id_local)  
into v_mer,v_id,v_ofi,v_nme,v_sec,v_loc,v_let,v_blq,v_pagos
from ta_11_locales a, ta_11_mercados b,ta_11_pagos_local d
where a.num_mercado=pmerc and a.vigencia='A'
and b.num_mercado_nvo=a.num_mercado and d.id_local=a.id_local
and (d.fecha_pago between pdsd and phst)
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque
order by a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque

if v_pagos > 0 then
   execute function fn_getpagosloc(v_id,pdsd,phst) into v_rezago,v_actual,v_total;
end if;
return v_mer,v_ofi,v_nme,v_sec,v_loc,v_let,v_blq,v_rezago,v_actual,v_total  
with resume;

end foreach; -- cierre del principal

end procedure;

create procedure "pgcabrer".spd_11_axoemitidos(pmerc int,paxo int,paxoa int,pmesa int)
returning   varchar(60) as mercado,
            int as rec,
            int as merc,
            char(2) as seccion,
            int as local,
            char(3) as letra,
            char(2) as bloque,
            money(16,2) as adeudo,
            char(200) as folios;

define v_rec,v_merc,v_local,v_folio,v_id int;
define v_secc,v_blq char(2);
define v_let char(3);
define v_prac,v_dil char(1);
define v_folios char(200);
define v_adeudo money(16,2);
define v_mercado varchar(60);
define v_fecemi date;

foreach
select a.id_local,a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque,b.descripcion
into v_id,v_rec,v_merc,v_secc,v_local,v_let,v_blq,v_mercado
from ta_11_locales a,ta_11_mercados b where a.num_mercado=pmerc
and b.num_mercado_nvo=a.num_mercado
order by a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque

select nvl(sum(importe),0) into v_adeudo from ta_11_adeudo_local 
where id_local=v_id and ((axo=paxoa  and periodo<=pmesa) or (axo<paxoa)); 

let v_folios='';
foreach
select folio,clave_practicado,diligencia,fecha_emision into v_folio,v_prac,v_dil,v_fecemi
from   ta_15_apremios    
where  modulo=11 and control_otr=v_id and vigencia='1' and clave_practicado='P'
and year(fecha_emision)>=paxo
order by folio
let v_folios=trim(v_folios)||' '||year(v_fecemi)||'-'||v_folio||'-'||v_prac||'-'||v_dil||' |';
end foreach; -- cierre de apremios

--if trim(v_folios)>'' then
   return v_mercado,v_rec,v_merc,v_secc,v_local,v_let,v_blq,v_adeudo,trim(v_folios) with resume;
--end if;
end foreach;
end procedure;

create procedure "pgcabrer".spd_11_pagos(pdsd date,phst date)
returning   int as idlocal,
            int as rec,
            int as merc,
            int as cat,
            char(2) as seccion,
            int as local,
            char(3) as letra,
            char(2) as bloque,
            date as fechapago,
            int as recpago,
            char(2) as cajapago,
            int as operpago,
            varchar(10) as perdsd,
            varchar(10) as perhst,
            money(16,2) as arrendamiento,
            money(16,2) as recargos,
            money(16,2) as multa,
            money(16,2) as gastos,
            money(16,2) as gastosfolio,
            int as folio,
            char(1) as diligencia,
            date as fechaemision,
            date as fechapractica,
            date as fechaentrega,
            int as ejecutor;

define v_id,v_rec,v_merc,v_cat,v_local,v_recpago,v_operpago,v_folio,v_ejecutor,xrec,xoper int;
define v_seccion,v_cajapago,xcaja char(2);
define v_letra char(3);
define v_bloque char(2);
define v_diligencia char(1);
define v_fechapago,v_fechaemision,v_fechapractica,v_fechaentrega,xfecha date;
define v_importe,v_arrendamiento,v_recargos,v_multa,v_gastos,v_gasfol money(16,2);
define v_perdsd,v_perhst varchar(10);
define v_cuenta,v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst int; 

let xfecha=null;
let xrec=0;
let xcaja='';
let xoper=0;

foreach
select b.id_local,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,
((select min(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago)||'-'||
(select min(periodo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago and axo=
(select min(axo) from ta_11_pagos_local  where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago))),
((select Max(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago)||'-'||
(select max(periodo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago and axo=
(select Max(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago))),
d.folio,d.diligencia,d.fecha_emision,d.fecha_practicado,d.fecha_entrega1,d.ejecutor,nvl(d.importe_pago,0)
into v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
v_operpago,v_perdsd,v_perhst,v_folio,v_diligencia,v_fechaemision,v_fechapractica,v_fechaentrega,v_ejecutor,
v_gasfol
from ta_11_pagos_local a, ta_11_locales b,outer ta_15_apremios d
where (a.fecha_pago between pdsd and phst) and b.num_mercado not in(90,99,214,999) and b.id_local=a.id_local 
and d.fecha_pago=a.fecha_pago and d.recaudadora=a.oficina_pago 
and d.caja=a.caja_pago and d.operacion=a.operacion_pago
group by b.id_local,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,13,14,
d.folio,d.diligencia,d.fecha_emision,d.fecha_practicado,d.fecha_entrega1,d.ejecutor,d.importe_pago
order by b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,d.folio

select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,cuenta_descmulta,cuenta_gastos 
into v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst
from ta_11_mercados where num_mercado_nvo=v_merc;

let v_arrendamiento=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;

foreach
select cuenta,importe into v_cuenta,v_importe from ta_12_recibosdet 
where fecha=v_fechapago and id_rec=v_recpago and caja=v_cajapago and operacion=v_operpago
and cuenta in(v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst)

if (v_cuenta=v_ctaact) or (v_cuenta=v_ctarzg) then let v_arrendamiento=v_importe; 
else if (v_cuenta=v_ctarec) or (v_cuenta=v_ctadrec) then let v_recargos=v_importe;
else if (v_cuenta=v_ctamul) or (v_cuenta=v_ctadmul) then let v_multa=v_importe;
else if v_cuenta=v_ctagst then let v_gastos=v_importe;
end if; end if; end if; end if;

end foreach

if ((v_fechapago=xfecha) and (v_recpago=xrec) and (v_cajapago=xcaja) and (v_operpago=xoper)) then
   return v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
   v_operpago,v_perdsd,v_perhst,0,0,0,0,v_gasfol,v_folio,v_diligencia,
   v_fechaemision,v_fechapractica,v_fechaentrega,v_ejecutor with resume;
else
   return v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
   v_operpago,v_perdsd,v_perhst,v_arrendamiento,v_recargos,v_multa,v_gastos,v_gasfol,v_folio,v_diligencia,
   v_fechaemision,v_fechapractica,v_fechaentrega,v_ejecutor with resume;
end if;

let xfecha=v_fechapago;
let xrec=v_recpago;
let xcaja=v_cajapago;
let xoper=v_operpago;
end foreach;
end procedure;

create procedure "pgcabrer".spd_11_totalesloc(paxo int,pmes int,popc char(1))
returning   int as rec,
            int as Mercado,
            Varchar(60) as nombre,
            int as Locales;

define u_rec,u_merc,u_loc,p_rec,p_merc,p_loc int;
define u_nombre,p_nombre varchar(60); 

if popc='U' then
   foreach
   select a.oficina,a.num_mercado_nvo,a.descripcion,
   (sum((select count(*) from ta_11_locales  where vigencia='A' and
   oficina=a.oficina and num_mercado=a.num_mercado_nvo))) 
   into u_rec,u_merc,u_nombre,u_loc
   from ta_11_mercados a where num_mercado_nvo not in (99,214,999)
   group by a.oficina,a.num_mercado_nvo,a.categoria,a.descripcion,
   a.cuenta_ingreso,a.cuenta_rezago,a.cuenta_energia,a.cta_ene_rezago,
   a.id_zona,a.tipo_emision order by a.oficina,a.num_mercado_nvo
   return u_rec,u_merc,u_nombre,u_loc with resume;
   end foreach;
end if;

if popc='P' then
   foreach
   select  a.oficina,a.num_mercado_nvo,a.descripcion,
   nvl((sum((select count(*) from ta_11_locales b  where b.vigencia='A' and
   b.oficina=a.oficina and b.num_mercado=a.num_mercado_nvo  
   and b.id_local not in(select id_local from ta_11_adeudo_local where id_local=b.id_local 
   and (axo<paxo  or (periodo<=pmes and axo=paxo)) )))),0) 
   into p_rec,p_merc,p_nombre,p_loc
   from ta_11_mercados a where num_mercado_nvo not in (99,214,999)
   group by a.oficina,a.num_mercado_nvo,a.descripcion 
   order by a.oficina,a.num_mercado_nvo
   return p_rec,p_merc,p_nombre,p_loc with resume;
   end foreach;
end if;

end procedure;

create procedure "pgcabrer".spd_11_padrontotal(paxo int,pmes int,ptip char(1))
-- Genera el padron total de mercados (locales sin adeudo y con adeudo) con totales de adeudo,recargos,multas y gastos
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            integer as categoria,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(60) as nombre,
            integer as zona,
            decimal(8,2) as superficie,
            money(7,2) as costo_mtr2013,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo,
            MONEY(16,2) as recargos,
            MONEY(16,2) as multa,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total,
            char(500) as Licencias,
            integer as idlocal;
  
define v_recargostotal,v_rec2001,v_rec2002,v_rec2003,v_rec2004,v_rec2005,v_rec2006,
       v_rec2007,v_rec2008,v_rec2009,v_rec2010,v_rec2011,v_rec2012,v_rec2013,
       v_rec2014,v_rec2015 MONEY(16,2);
define v_ade2001,v_ade2002,v_ade2003,v_ade2004,v_ade2005,v_ade2006,
       v_ade2007,v_ade2008,v_ade2009,v_ade2010,v_ade2011,v_ade2012,v_ade2013,
       v_ade2014,v_ade2015 MONEY(16,2);  
define v_multa MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_licencias char(500);
define v_giro varchar(150);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer char(30);          define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(3);           define v_blq char(2);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);       define v_zona,v_lic int;
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

define vp_lic,vp_id,vp_blq,vp_idg int;
define vp_act varchar(130);
define vp_prop varchar(80); 
define vp_txtblq varchar(30);
define vp_vig char(1);
define vp_giro varchar(96);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_porc=0;     
let v_folio=0; 


foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,a.giro,nvl(sum(d.importe),0)
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_zona,v_superf,v_est,v_bloqueo,v_cvecuo,v_giro,v_ade
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where b.tipo_emision=ptip and a.vigencia='A'
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
and d.id_local=a.id_local and (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo))
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,bloqueo,a.clave_cuota,a.giro
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

if v_est='A' then
   if v_bloqueo=4 then
      let v_estado='VIGENTE-BLOQUEADO';
   else
      let v_estado='VIGENTE';
   end if;
else
   let v_estado='BAJA';
end if;

select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  
let v_total=0;

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=v_idl and (a.axo<paxo  or (a.periodo<=pmes and a.axo=paxo)) 
and b.mes=month(today)
order by axo,periodo

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if today>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

-- verifica los periodos de adeudo
let v_periodo=0;
select a.id_local,(  
(select min(axo) from ta_11_adeudo_local where id_local=a.id_local and (axo<paxo or (periodo<=pmes and axo=paxo)))||'-'||
(select min(periodo) from ta_11_adeudo_local where id_local=a.id_local and (axo<paxo or (periodo<=pmes and axo=paxo)) and axo=
(select min(axo) from ta_11_adeudo_local where id_local=a.id_local and (axo<paxo or (periodo<=pmes and axo=paxo))) ) ),(
(select Max(axo) from ta_11_adeudo_local where id_local=a.id_local and (axo<paxo or (periodo<=pmes and axo=paxo)))||'-'||
(select max(periodo) from ta_11_adeudo_local where id_local=a.id_local and (axo<paxo or (periodo<=pmes and axo=paxo)) and axo=
(select Max(axo) from ta_11_adeudo_local where id_local=a.id_local and (axo<paxo or (periodo<=pmes and axo=paxo))) ) )
into v_ida,v_ini,v_fin
from   ta_11_adeudo_local a   
where  a.id_local=v_idl 
group by a.id_local,2,3;
let v_periodo=trim(v_ini)||' AL '||trim(v_fin);

-- obtiene la(s) licenicia del local
let v_licencias='';
foreach
  select b.licencia into v_lic
  from ta_11_licencias a,catastro_gdl:licencias b where a.id_local=v_idl
  and a.vigencia='V' and b.id_licencia=a.id_licencia
  execute procedure catastro_gdl:spget_lic_estatus(v_lic) into vp_lic,vp_id,vp_act,vp_prop,vp_blq,vp_txtblq,vp_vig,vp_idg,vp_giro; 
  let v_licencias=trim(v_licencias)||v_lic||'-'||trim(vp_giro)||',';
end foreach;
let v_licencias=substr(v_licencias,1,(length(v_licencias)-1));

-- verifica los folios de requerimientos
--let v_requerimientos='';
--foreach
--select id_control,fecha_emision,folio,fecha_practicado,( 
--(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
--(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
--(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
--(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
--(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
--(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
--into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
--from   ta_15_apremios a   
--where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
--and a.fecha_emision>=mdy(1,1,2013)
--order by a.fecha_emision,a.folio
--let v_requerimientos=trim(v_requerimientos)||v_fol||',';
--end foreach; -- cierre de apremios

--let v_requerimientos=substr(v_requerimientos,1,(length(v_requerimientos)-1));
let v_total=v_ade+v_recargostotal+v_multa+v_gastos;

return trim(v_mer),v_ofi,v_nme,v_cat,trim(v_sec),v_loc,trim(v_let),trim(v_blq),trim(v_nombre),v_zona,v_superf,v_costomtr,
trim(v_estado),trim(v_periodo),v_ade,v_recargostotal,v_multa,v_gastos,v_total,v_licencias,v_idl
with resume;
end foreach; -- cierre del principal

end procedure;

CREATE PROCEDURE "pgcabrer".spd_11_adepresc(p_merc smallint,p_mesh smallint,p_axoh smallint)	

returning  	integer as id_local,
        	smallint as rec,   
        	smallint as merc,   
        	smallint as cat,  
        	char(2) as seccion,
        	integer as local,
            char(3) as letra,
    		char(2) as bloque,
        	char(30) as nombre, 
        	smallint as mesdesde, 
        	smallint as axodesde, 
        	smallint as meshasta, 
        	smallint as axohasta,
        	money(15,2) as adeudo, 
        	money(15,2) as recargos, 
        	money(15,2) as multa,
        	money(15,2) as gastos,
        	money(15,2) as total,
        	money(15,2) as adeudopresc, 
        	money(15,2) as recargospresc, 
        	money(15,2) as multapresc,
        	money(15,2) as gastospresc,
        	money(15,2) as totalpresc;

define v_estatus smallint;
define v_id_local,v_id,vid,p_licencia,p_idlicencia,p_bloqueado,p_idgiro,v_idgiro integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra1,v_let char(3);
define v_bloque1,v_blq char(2); 
define v_dillic,v_dilloc,p_vigente char(1);
define v_nombre,p_txtbloqueado char(30);
define v_domicilio char(40);
define v_adicional,v_aprloc,v_aprlic char(20);
define v_superficie decimal(10,2);
define v_adeudo, v_adeudop money(15,2);
define v_recargos, v_recargosp money(15,2);
define v_multa, v_multap money(15,2);
define v_gastos, v_gastosp money(15,2);
define v_descuento,v_renta money(15,2);
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_folio, v_foliop integer;
define v_per smallint;
define v_aid_local,v_follic,v_folloc integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec, v_fecha_alta date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp,v_lic integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo,v_merc,v_mer smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc,v_cvecuo integer;
define v_total, v_totalp money(15,2);
define v_cat,v_ofna smallint;
define v_sec char(2);
define v_loc,v_idlic integer;
define v_licencia,v_licdesc char(200);
define p_actividad varchar(130);
define p_propietario varchar(80);
define p_giro,v_giro varchar(96);

define vpropietario varchar(92);
define vcalle varchar(80);
define vnumext,vnumint varchar(10);
define vrecaudadora,vzona,vaxo_desde_ade,vmes_desde_ade int;
define vderechos,vanuncios,vimpresos,vrecargos,vmultas,vgastos,vtotal,vfvlicencias,vfvanuncios dec(14,2);

let v_axocalc=0; 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_nom_mercado='';
let v_estatus=0;
let v_descripcion='';
let v_licencia='';
let v_renta=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_merc=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_mesmin=0;
let v_axomin=0;
let v_idlic=0;
let p_idgiro=0;
let v_adeudop=0;
let v_recargosp=0;
let v_multap=0;
let v_gastosp=0;
let v_totalp=0;

begin
    on exception in (-958)
       delete from locales;
    end exception;
create temp table locales( 
 tid_local  	integer,		--
 tofna		smallint,
 tmerc		smallint,
 tcat		smallint,
 tsec		char(2),
 tlocal		integer,
 tletra		char(3),
 tbloq		char(2),
 tmesdesde	smallint,		-- 
 taxodesde	smallint,		-- 
 tmeshasta	smallint,		-- 
 taxohasta	smallint,		--
 tnombre	char(30),		-- 
 tadeudo	money(15,2),	-- 
 trecargos	money(15,2),	-- 
 tmulta	money(15,2),	--
 tgastos	money(15,2),	--
 ttotal	money(15,2),	--
 tadeudop	money(15,2),	-- 
 trecargosp	money(15,2),	-- 
 tmultap	money(15,2),	--
 tgastosp	money(15,2),	--
 ttotalp	money(15,2)
)  with no log;		--
end;

    -- obtiene los datos generales
foreach
     select id_local,oficina,num_mercado,categoria,seccion,local,letra_local,bloque
	 into vid,v_ofna,v_mer,v_cat,v_sec,v_loc,v_let,v_blq 
     from ta_11_locales  where num_mercado=p_merc 
     order by oficina,num_mercado,categoria,seccion,local,letra_local,bloque
     if v_let is null then
        let v_letra1='';
     else
        let v_letra1=v_let;
     end if;
     if v_blq is null then
        let v_bloque1='';
     else
        let v_bloque1=v_blq;
     end if;

         select c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
         c.num_mercado,c.fecha_alta,c.clave_cuota
         into     v_id_local,v_desc,v_nombre,v_domicilio,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado,v_merc,v_fecha_alta,v_cvecuo
         from    ta_11_locales c,ta_11_mercados e
         where c.id_local=vid
	     and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado
	     group by c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
          c.num_mercado,c.fecha_alta,c.clave_cuota;

         let v_per=0;
         let v_porc=0;

         if v_desc is null then
            let v_desc=0;
         end if;

         if  v_vigencia<>'A' then
             let v_estatus=4;
             let v_descripcion='LOCAL DADO DE BAJA';
         else
         if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and ((axo=p_axoh and periodo<=p_mesh) or (axo<p_axoh))) then 	
            let v_estatus=5;
            let v_descripcion='LOCAL AL CORRIENTE DE PAGOS';
         else 
            let v_recacum=0;
 
         -- para sacar el a�o minimo
         select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

         -- para sacar el mes minimo       
         select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

         -- para obtener los datos de multa y gastos real
         select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
         into     v_multa,v_folio,v_gastos
         from    ta_15_apremios a  
         where modulo=11 and control_otr=v_id_local and vigencia='1' and clave_practicado='P';

         -- para obtener los datos de multa y gastos para prescripcion
         select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
         into     v_multap,v_foliop,v_gastosp
         from    ta_15_apremios a  
         where modulo=11 and control_otr=v_id_local and vigencia='1' and clave_practicado='P' and fecha_emision>=mdy(1,1,(year(today)-5));

         -- calcula la renta
--         execute procedure spd_11_calc_renta(year(today),v_cat,v_sec,v_cvecuo,v_superficie,v_mer,1) into v_renta;

         -- todos los adeudos pendientes hasta mes actual
         let v_adeudo=0;
         let v_recargos=0;
         let v_adeudop=0;
         let v_recargosp=0;
         foreach
         select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
         into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
         from    ta_11_adeudo_local a,ta_11_fecha_desc b 
         where id_local=v_id_local
                   and ((a.axo=p_axoh and a.periodo<=p_mesh) or (a.axo<p_axoh)) 
                   and b.mes=month(today)
                   order by axo,periodo

         if v_merc=214 then
            let v_impcalc=(v_aimporte*(100-v_desc))/100;
         else
            let v_impcalc=v_aimporte;
         end if;
  
         let v_meshst=v_aperiodo;
         let v_axohst=v_aaxo;  

         -- obtiene el porcentaje de recargos
         if v_merc <>214 then 	
            if today>=v_fecha_rec then
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
            else
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
            end if;
         else 
            if v_aperiodo=1 then let v_primermes=1;
            else if v_aperiodo=2 then let v_primermes=4;
            else if v_aperiodo=3 then let v_primermes=7;
            else if v_aperiodo=4 then let v_primermes=10;
            else let v_primermes=0;
            end if;
            end if;
            end if;
            end if;

            if v_primermes=month(today) then
               if today>=v_fecha_rec then
                  select sum(porcentaje_mes) into v_porc from ta_12_recargos
                  where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                               (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
               else
                  select sum(porcentaje_mes) into v_porc from ta_12_recargos
                  where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                               (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
               end if;
            else
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
            end if;
         end if;

         if  v_porc is null then
             let v_porc=0;
         end if;

         if  v_folio = 0 then
             if v_porc > 100 then
                let v_recacum=trunc(v_impcalc*100)/100;
             else
                let v_recacum=trunc(v_impcalc*v_porc)/100;
             end if;
         else
             if v_porc > 250 then
                let v_recacum=trunc(v_impcalc*250)/100;
             else
                let v_recacum=trunc(v_impcalc*v_porc)/100;
             end if;
         end if;

         let v_recargos=v_recargos+v_recacum;
         if v_aaxo>=(year(today)-5) then
            let v_recargosp=v_recargosp+v_recacum;
         end if;
	
         if v_merc<>214 then
            if v_aaxo=year(today) and v_aperiodo=month(today) then
               if today>v_fecha_desc then
                  let v_adeacum=v_aimporte;
               else
                  let v_adeacum=v_aimporte-(v_aimporte*.10);
                  let v_descuento=v_aimporte*.10;
               end if;
            else
               let v_adeacum=v_aimporte;
            end if;
         else
            let v_adeacum=v_impcalc;
            let v_descuento=v_descuento+(v_aimporte-v_impcalc);
         end if;

         let v_adeudo=v_adeudo+v_adeacum;
         if v_aaxo>=(year(today)-5) then
            let v_adeudop=v_adeudop+v_adeacum;
         end if;

         if  v_bloqueo=1 then
             let v_estatus=0; -- ANTES ESTATUS 3
             let v_descripcion='LOCAL CON ADEUDO CONVENIADO';
         else
             let v_estatus=0;
             let v_descripcion='LOCAL CON ADEUDO';
         end if;
         end foreach;
        end if;
        end if;

     let v_total=v_adeudo+v_recargos+v_multa+v_gastos;
     let v_totalp=v_adeudop+v_recargosp+v_multap+v_gastosp;
     if v_estatus=0 then
       insert into locales values(v_id_local,v_ofna, v_merc, v_cat,v_sec,v_loc, v_letra1,v_bloque1, v_mesmin, v_axomin, v_meshst,
		    v_axohst, v_nombre, v_adeudo, v_recargos, v_multa, v_gastos, v_total, v_adeudop, v_recargosp, v_multap, v_gastosp, v_totalp );
     end if;	
end foreach;

foreach
select tid_local,tofna,tmerc,tcat,tsec,tlocal,tletra,tbloq,tmesdesde,taxodesde,tmeshasta, 
     taxohasta,tnombre,tadeudo,trecargos,tmulta,tgastos,ttotal,tadeudop,trecargosp,tmultap,tgastosp,ttotalp
into v_id_local,v_ofna, v_merc, v_cat,v_sec,v_loc, v_letra1,v_bloque1, v_mesmin, v_axomin, v_meshst,
	 v_axohst, v_nombre, v_adeudo, v_recargos, v_multa, v_gastos, v_total, v_adeudop, v_recargosp, v_multap, v_gastosp, v_totalp 
from locales order by tofna,tmerc,tcat,tsec,tlocal,tletra,tbloq

return v_id_local,v_ofna, v_merc, v_cat,v_sec,v_loc, v_letra1,v_bloque1, v_nombre, v_mesmin, v_axomin, v_meshst, v_axohst,
       v_adeudo, v_recargos, v_multa, v_gastos, v_total, v_adeudop, v_recargosp, v_multap, v_gastosp, v_totalp 
with resume;
end foreach;

end procedure;

CREATE PROCEDURE "informix".sp_cancel_factelec( p_operacion int ,  p_foliofiscal varchar(60), p_estatus int, p_fecha varchar(20) , p_mensaje varchar(60))
RETURNING int as recibo , varchar( 60 ) AS foliofiscal , varchar(20) as fecha_cancelacion , varchar(60) as mensaje;

if (p_estatus = 200) then

update ta_12_fact_elec set can_fecha = today , can_uuid_estatus = p_estatus , 
can_uuid_descripcion = p_mensaje , can_usr = 'WEBPROCE'
where operacion =   p_operacion and can_fecha is null ;

update ses_facturausuario set estatus = 'CANCELADA' , fecha_in = current 
where operacion = p_operacion and estatus = 'ELABORADA'; 
RETURN p_operacion, p_foliofiscal , p_fecha ,  p_mensaje;
else

RETURN p_operacion, 'No se cancelo la operacion' , p_fecha ,  p_mensaje;
end if;
END PROCEDURE;

CREATE PROCEDURE "informix".adeudo_cons(
    p_recaud SMALLINT,
    p_urbrus CHAR(1),
    p_cuenta INT,
    p_axo INT
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);


--****** variables locales
define v_cvecuenta int;
define v_cvepago int;
define v_caja char(2);--
define v_operacion int;--
define v_fecha date;--
define v_id_rec smallint;--
define v_estatus char(1);
define v_linea char(33);
--set debug file to 'adeudocons.log';
--trace on;
--select * from catastro_gdl:convcta where cvecuenta = 10000
--Verifica que exista en catastro_gdl:convcta
  	if NOT exists (select * from catastro_gdl:convcta where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta) then --bco
	
	return -1,"LA CUENTA PROPORCIONADA NO EXISTE",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin bco	

        --select * from catastro_gdl:saldos where cvecuenta = 10000 and saldototal=0

        --Verifica que exista en v_bco_carga1
	
	if exists (select * from v_bco_carga1 where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta
		and estatus not in ("A","E") and cvepago = 0 and YEAR(fecha_pagobco) = p_axo  )then--bco2
        -- el -2 me sirve para ense�ar enlace en la p�gina...
	return -2,"LA CUENTA PRESENTA PAGOS PENDIENTES POR APLICAR",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
	end if; --Fin bco2	

  	if NOT exists (select count(*) from v_bco_carga1 where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta
		and estatus = "A" and cvepago > 0 and YEAR(fecha_pagobco) = p_axo having count(*) > 0  ) then --bco
	
	        --Obtengo la cvecuenta
		select cvecuenta into v_cvecuenta from catastro_gdl:convcta where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta;		
	
	        --Verifico si est� la l�nea de captura en linea_pagos mediante la clave cuenta
	  	if exists (select linea from linea_pagos where substr(linea,1,6) = v_cvecuenta AND modulo = 1 AND YEAR(fecha_pago) =p_axo )then --linea

		foreach
		select linea into v_linea from linea_pagos where substr(linea,1,6) = v_cvecuenta AND modulo = 1 AND YEAR(fecha_pago) =p_axo order by id desc
                end foreach;

		return -3,v_linea,
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
	     
	        end if; --Fin linea

	        return -1,"LA CUENTA NO PRESENTA PAGOS EN BANCOS PARA EL A�O "||p_axo,
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;

   	end if; --Fin bco	

	Let v_estatus = " ";

        FOREACH
	select cvecuenta, cvepago, estatus 
	into v_cvecuenta, v_cvepago, v_estatus
	from v_bco_carga1 
	where recaud = p_recaud 
	and urbrus = p_urbrus
	and cuenta = p_cuenta
	and estatus = "A"
	and cvepago > 0
	and YEAR(fecha_pagobco) = p_axo   order by cvepago 
        END FOREACH;
	
        if v_estatus is null then
	   Let v_estatus = " ";
        end if;

	if v_estatus <> "A" then
         return -1,"LA CUENTA NO HA SIDO APLICADA, PARA PAGO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
        end if;	

--Verificar en v_pagos
	if NOT exists ( select * from v_pagos where cvepago = v_cvepago and cvecuenta= v_cvecuenta 
	and cvecanc is null)then --v_pagos
	
	return -1,"EL PAGO REALIZADO A ESTA CUENTA, EST� EN PROCESO DE APLICACI�N",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin v_pagos

	select fecha, recaud, caja, folio 
	into v_fecha, v_id_rec, v_caja, v_operacion
	from v_pagos
	where cvepago= v_cvepago 
	and cvecuenta= v_cvecuenta
	and cvecanc is null; 	

--Validar en ta_12_recibos

       if NOT exists (select * from ta_12_recibos where fecha=v_fecha and id_rec = v_id_rec and caja=v_caja 
	and operacion=v_operacion and cvepago="P") then--recibos
	
	return -1,"LA CUENTA NO EXISTE EN EL REGISTRO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos

  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 

  where  fecha=v_fecha and id_rec = v_id_rec and caja=v_caja 
	 and operacion=v_operacion and cvepago="P";

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"CUENTA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;
--trace off;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkiobmxws(
    		parcvecuenta    integer,
                parfechaPAgo    date ,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint,
    		parAxohasta  	smallint,
    		
                parIdTransKio   integer
        )
		returning smallint , char(2), integer, char(28), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int;
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int;
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define pg_recaud int;
define pg_caja char(2);
define pg_folio int;
define pg_fecha date ;
define pg_cvecuenta int;
define parcvekiosco int;
define parsucursal  varchar(30);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;

   if varcvepago > 0 then
      select recaud , caja , folio , fecha , cvecuenta into
             pg_recaud , pg_caja , pg_folio , pg_cvecuenta
      from catastro_gdl:pagos where cvepago = varcvepago ;

       update db_ingresos:ta_12_recibos set cvepago = 'C'
       where fecha = pg_fecha and id_rec = pg_recaud and caja =  pg_caja and operacion = pg_folio and id_modulo = 5
        and rfcnumero = pg_cvecuenta and cvepago = 'P';
       insert into catastro_gdl:pagoscan values(0,varcvepago , 'bmxws' ,parfechaPAgo);
    end if;
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
 --set debug file to "pago13";
 --trace on;
 
 select  a.cvecuenta, k.fecha, k.importe, a.bim_ini, a.axo_ini, a.bim_fin, a.axo_fin,  k.cvekiosco, a.sucursal
 into parcvecuenta , parfechaPAgo , parImpCertificado , parMesdesde , parAxodesde, parMeshasta , parAxohasta , parcvekiosco , parsucursal
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where id_transaccion = parIdTransKio and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null ;
 
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;


 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo ,
   trim(nvl(a.c_calle,'')) || ' # Ext ' || trim(nvl(a.c_noexterior, '')) || ' # Int ' || trim(nvl(a.c_interior,'')),
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,'')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,''))
   || '@CVECATASTRAL ' || nvl(CVECATNVA,'') || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip   , v_hora
 from catastro_gdl:datos_gralKio a
 where a.cvecuenta = parcvecuenta;


  select id_rec , caja  into varrec , varcaja

  from ta12_operacKiosco
  where id_usuario = 554;
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(parfechaPAgo ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial en BANAMEX ventanilla de ' || parcvecuenta , '',parcvecuenta,0,
                0,0,554,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'BMXWS' ;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, parfechaPAgo, v_hora ,
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1");
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)

let linea = 1;
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
--execute procedure  catastro_gdl:kiosco_totalespred_nvo( parcvecuenta , parAxohasta, parMeshasta, 1)
execute procedure  catastro_gdl:internet_totalespred( parIdTransKio)
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans
if v_ob = 'D' then
     if v_cuenta <> 550800000   then
  insert into ta_12_recibosdet
        ( fecha       , id_rec , caja    , operacion     , linea , descripcion , cuenta    , importe )
  values( parfechaPAgo, varrec , varcaja ,  varoperacion , linea ,  v_concepto ,   v_cuenta, v_importe );
     end if;
     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea + 1 ;
 end if;
if v_ob = 'T' then
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
  select sum(multa) , sum(multavir) into v_mulpag , v_multasvir  from catastro_gdl:k_detsaldos_nvo where cvekiosco = parcvekiosco;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq)
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
-- insertar la detalle de lugar de pago en este caso los datos del siapa. select * from catastro_gdl:banamex
 --select * from catastro_gdl:k_pagos where llave = 525535
    insert into catastro_gdl:banamex(cvepago,cvecuenta,recaud,folio ,caja,operacion,fecha,fechapago,
       importe,importepago, tipopago, fecarga)
     values (varcvepago,parcvecuenta, 1 , varoperacion , '15', varoperacion, today,
              parfechaPAgo, parImpCertificado, parImpCertificado,5,parfechaPAgo);

if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor ,
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

--select * from liga_linea_trans where id_transaccion =  parIdTransKio;
select a.linea into v_lineacapt2 from catastro_gdl:linea_capturapred a, catastro_gdl:liga_linea_trans t
where  t.id_transaccion = parIdTransKio and t.refer_id = a.id;

--select * from catastro_gdl:linea_capturapred
--select * from catastro_gdl:liga_linea_trans

    execute  PROCEDURE linea_pagok(v_lineacapt2, 164, parImpCertificado, 'K',varcvepago,
             parfechaPAgo, varrec , varcaja, varoperacion, 'BMXWS') into  estatus ,mensaje ;
	-- COMMIT WORK;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago;
--trace off;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkiobbvaws(
    		parcvecuenta    integer,
                parfechaPAgo    date ,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint,
    		parAxohasta  	smallint,
    		
                parIdTransKio   integer
        )
		returning smallint , char(2), integer, char(28), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int;
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int;
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define pg_recaud int;
define pg_caja char(2);
define pg_folio int;
define pg_fecha date ;
define pg_cvecuenta int;
define parcvekiosco int;
define parsucursal  varchar(30);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;

   if varcvepago > 0 then
      select recaud , caja , folio , fecha , cvecuenta into
             pg_recaud , pg_caja , pg_folio , pg_cvecuenta
      from catastro_gdl:pagos where cvepago = varcvepago ;

       update db_ingresos:ta_12_recibos set cvepago = 'C'
       where fecha = pg_fecha and id_rec = pg_recaud and caja =  pg_caja and operacion = pg_folio and id_modulo = 5
        and rfcnumero = pg_cvecuenta and cvepago = 'P';
       insert into catastro_gdl:pagoscan values(0,varcvepago , 'bmxws' ,parfechaPAgo);
    end if;
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
 --set debug file to "pago13";
 --trace on;
 
 select  a.cvecuenta, k.fecha, k.importe, a.bim_ini, a.axo_ini, a.bim_fin, a.axo_fin,  k.cvekiosco, a.sucursal
 into parcvecuenta , parfechaPAgo , parImpCertificado , parMesdesde , parAxodesde, parMeshasta , parAxohasta , parcvekiosco , parsucursal
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where id_transaccion = parIdTransKio and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null ;
 
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;


 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo ,
   trim(nvl(a.c_calle,'')) || ' # Ext ' || trim(nvl(a.c_noexterior, '')) || ' # Int ' || trim(nvl(a.c_interior,'')),
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,'')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,''))
   || '@CVECATASTRAL ' || nvl(CVECATNVA,'') || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip   , v_hora
 from catastro_gdl:datos_gralKio a
 where a.cvecuenta = parcvecuenta;


  select id_rec , caja  into varrec , varcaja

  from ta12_operacKiosco
  where id_usuario = 555;
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(parfechaPAgo ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial en BBVA ventanilla de ' || parcvecuenta , '',parcvecuenta,0,
                0,0,555,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = 'BBVAws' ;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, parfechaPAgo, v_hora ,
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1");
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)

let linea = 1;
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
--execute procedure  catastro_gdl:kiosco_totalespred_nvo( parcvecuenta , parAxohasta, parMeshasta, 1)
execute procedure  catastro_gdl:internet_totalespred( parIdTransKio)
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans
if v_ob = 'D' then
     if v_cuenta <> 550800000   then
  insert into ta_12_recibosdet
        ( fecha       , id_rec , caja    , operacion     , linea , descripcion , cuenta    , importe )
  values( parfechaPAgo, varrec , varcaja ,  varoperacion , linea ,  v_concepto ,   v_cuenta, v_importe );
     end if;
     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea + 1 ;
 end if;
if v_ob = 'T' then
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
  select sum(multa) , sum(multavir) into v_mulpag , v_multasvir  from catastro_gdl:k_detsaldos_nvo where cvekiosco = parcvekiosco;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq)
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
-- insertar la detalle de lugar de pago en este caso los datos del siapa. select * from catastro_gdl:banamex
 --select * from catastro_gdl:k_pagos where llave = 525535
    insert into catastro_gdl:banamex(cvepago,cvecuenta,recaud,folio ,caja,operacion,fecha,fechapago,
       importe,importepago, tipopago, fecarga)
     values (varcvepago,parcvecuenta, 166 , varoperacion , '16', varoperacion, today,
              parfechaPAgo, parImpCertificado, parImpCertificado,5,parfechaPAgo);

if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor ,
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

--select * from liga_linea_trans where id_transaccion =  parIdTransKio;
select a.linea into v_lineacapt2 from catastro_gdl:linea_capturapred a, catastro_gdl:liga_linea_trans t
where  t.id_transaccion = parIdTransKio and t.refer_id = a.id;

--select * from catastro_gdl:linea_capturapred
--select * from catastro_gdl:liga_linea_trans

    execute  PROCEDURE linea_pagok(v_lineacapt2, 166, parImpCertificado, 'K',varcvepago,
             parfechaPAgo, varrec , varcaja, varoperacion, 'BBVAws') into  estatus ,mensaje ;
	-- COMMIT WORK;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago;
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".admin_adeudos_detalle_18_tot ( p_tipo char(1), p_numero int, pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_18_tot
#  Descripcion:      Interfaz de consulta de detalle para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros                   p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:                   p_numero   = Numero de Contrato
#                             pref   = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
                --returning  Integer as Rubro,
                --               Integer as Concepto,
                --               Integer as Cuenta_Aplicacion,
                --               VarChar(30) as Referencia,
                --               VarChar(120) as Descripcion,
                --               Money(12,2) as Monto,
                --               Money(12,2) as Acumulado;
                returning  Integer as Cuenta_Aplicacion,
                               VarChar(50) as Referencia,
                               Money(12,2) as Monto;

--********** totales *******************************
define t_cuenta	int;
define t_concepto_abrev varchar(50);
define t_monto, t_monto_t	money(12,2);
               
define v_control_contrato, v_ctrol_operacion, v_id_control_req                                          Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas            Money(12,2);
define v_porcentaje_multa                                                                                                     Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           Money(12,2);
define v_aso_mes_pago                                                                                                          Date;
define v_Axo, v_Mes                                                                                                 Integer;
define v_mensaje_proc                                                                                                            varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                                               varchar(7);
define v_contador                                                                                                                       Smallint;
define  v_ref     char(7);

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

begin
    on exception in (-958)
       delete from tmp_totalaseo;
    end exception;
create temp table tmp_totalaseo(
  rubro int,
  concepto int,
  cuenta int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
       delete from tmp_detalleaseo;
    end exception;
create temp table tmp_detalleaseo(
  control_contrato int,
  aso_mes_pago char(7),
  ctrol_operacion int,
  tipo_movto char(1) ) with no log;
end;

if trim(pref)='' then
   let v_ref=9999 || '-' || 12;
else
   let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;

let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato  INTO  v_control_contrato   FROM ta_16_contratos a, ta_16_tipo_aseo b
                               WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

                -- VARIABLES A 0
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               Let v_tot_gastos = 0;
                Let v_acumulado = 0;
                Let v_importe = 0;
                Let v_Importe_recargo = 0;
                Let v_importe_rec1 = 0;
                Let v_importe_rec2 = 0;
                Let v_contador = 0;

                -- APREMIOS
                Let v_id_control_req = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_Axo = 0;
                Let v_Mes = 0; 
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               
                               Let v_tot_multas = v_importe_multa;
                               if v_porcentaje_multa < 100 then
                                               Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                               Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                               else
                                               Let v_tot_dscto_multas = 0;
                               end if;
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                               insert into tmp_detalleaseo values ( v_id_control_req, v_ref, 0, 'R' );
                end foreach;
                
                -- TERMINA APREMIOS

                               -- INICIAN PERIODOS
                               foreach
                                               SELECT  aso_mes_pago,  Year(aso_mes_pago), Month(aso_mes_pago), importe, ctrol_operacion 
                                               INTO     v_aso_mes_pago, v_Axo, v_Mes, v_importe, v_ctrol_operacion
                                                               FROM ta_16_pagos 
                                                               WHERE Control_Contrato = v_control_contrato  
                                                               and aso_mes_pago <= v_ref
                                                               AND status_vigencia = 'V'  Order By aso_mes_pago, ctrol_operacion

                                               insert into tmp_detalleaseo values ( v_control_contrato, v_Axo || '-' || v_Mes, v_ctrol_operacion, 'A' );

                                               if v_importe > 0 then
                                                               if v_contador = 0 then
                                                                              if v_tot_multas > 0 then
                                                                                              Let v_acumulado = v_acumulado + v_tot_multas;
                                                                                                              --RETURN 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado                     with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado );
                                                                              end if;
                                                                              if v_tot_dscto_multas <> 0 then
                                                                                              Let v_acumulado = v_acumulado + v_tot_dscto_multas;
                                                                                                              --RETURN 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado        with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado );
                                                                              end if;
                                                                              if v_tot_gastos > 0 then
                                                                                              Let v_acumulado = v_acumulado + v_tot_gastos;
                                                                                                              --RETURN 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado                      with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
                                                                              end if;
                                                               end if;

                                                               if v_ctrol_operacion = 6 then
                                                                              if Year(v_aso_mes_pago) < Year(Current) then
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                              --RETURN 0,0, 250130000, v_Axo || '/' || v_Mes, 'Rezago del Adeudo ', v_importe, v_acumulado                           with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 250130000, v_Axo || '/' || v_Mes, 'Rezago del Adeudo ', v_importe, v_acumulado );
                                                                              else
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                              --RETURN 0,0, 250100000, v_Axo || '/' || v_Mes, 'Actual de Adeudo ', v_importe, v_acumulado                           with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 250100000, v_Axo || '/' || v_Mes, 'Actual de Adeudo ', v_importe, v_acumulado );
                                                                              end if;
                                                                              SELECT sum(porc_recargo)   INTO v_Importe_recargo
                                                                                              FROM ta_16_recargos 
                                                                                              WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);
                                                               else
                                                                              if Year(v_aso_mes_pago) < Year(Current) then
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                              --RETURN 0,0, 250230000, v_Axo || '/' || v_Mes, 'Rezago Excedente ', v_importe, v_acumulado                           with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 250230000, v_Axo || '/' || v_Mes, 'Rezago Excedente ', v_importe, v_acumulado );
                                                                              else
                                                                                              Let v_acumulado = v_acumulado + v_importe;
                                                                                                              --RETURN 0,0, 250200000, v_Axo || '/' || v_Mes, 'Actual Excedente ', v_importe, v_acumulado                           with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 250200000, v_Axo || '/' || v_Mes, 'Actual Excedente ', v_importe, v_acumulado );
                                                                              end if;
                                                                              SELECT sum(porc_recargo)   INTO v_Importe_recargo
                                                                                              FROM ta_16_recargos 
                                                                                              WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);
                                                               end if;
                                                               if v_Importe_recargo <> 0 then
                                                                              Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                                                              Let v_acumulado = v_acumulado + v_importe_rec1;
                                                                              --RETURN 0,0, 390200000, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado                                with resume;
                                                                              insert into tmp_totalaseo values ( 0,0, 390200000, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado );
                                                                              EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
                                                                                                                                                             INTO v_importe_rec2, v_mensaje_proc;
                                                               end if;
                                                               if v_importe_rec2 > 0 then
                                                                              Let v_importe_rec2 = v_importe_rec2 * -1;
                                                                              Let v_acumulado = v_acumulado + v_importe_rec2;
                                                                              --RETURN 0,0, 390240000, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado                                with resume;
                                                                              insert into tmp_totalaseo values ( 0,0, 390240000, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado );
                                                               end if;
                                                               Let v_contador = 1;
                                                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                               Let v_importe_rec1 = 0;
                               Let v_importe_rec2 = 0;
                               end foreach;
                               -- TERMINAN PERIODOS

                                                               if v_contador = 0 then
                                                                               if v_tot_multas > 0 then
                                                                                              Let v_acumulado = v_acumulado + v_tot_multas;
                                                                                                              --RETURN 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado                     with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado );
                                                                              end if;
                                                                              if v_tot_dscto_multas <> 0 then
                                                                                              Let v_acumulado = v_acumulado + v_tot_dscto_multas;
                                                                                                              --RETURN 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado        with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado );
                                                                              end if;
                                                                              if v_tot_gastos > 0 then
                                                                                              Let v_acumulado = v_acumulado + v_tot_gastos;
                                                                                                              --RETURN 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado                      with resume;
                                                                                              insert into tmp_totalaseo values ( 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
                                                                              end if;
                                                               end if;

	Let t_monto_t = 0;
	foreach
	select a.cuenta, b.concepto_abrev, sum(a.monto)   INTO t_cuenta, t_concepto_abrev, t_monto 
	from tmp_totalaseo a, ta_16_ctas_aplic b
	where b.cuenta = a.cuenta
	group by a.cuenta, b.concepto_abrev
	order by a.cuenta

	RETURN t_cuenta, t_concepto_abrev, t_monto    with resume;
	Let t_monto_t = t_monto_t + t_monto;
	end foreach;
	RETURN Null, Null, Null    with resume;
	RETURN Null, 'TOTAL ADEUDO', t_monto_t    with resume;

end if;
end procedure;

CREATE PROCEDURE "informix".adeudo_consx(
    p_recaud SMALLINT,
    p_urbrus CHAR(1),
    p_cuenta INT,
    p_axo INT
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);


--****** variables locales
define v_cvecuenta int;
define v_cvepago int;
define v_caja char(2);--
define v_operacion int;--
define v_fecha date;--
define v_id_rec smallint;--
define v_estatus char(1);
define v_linea char(33);
--set debug file to 'adeudocons.log';
--trace on;
--select * from catastro_gdl:convcta where cvecuenta = 10000
--Verifica que exista en catastro_gdl:convcta
  	if NOT exists (select * from catastro_gdl:convcta where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta) then --bco
	
	return -1,"LA CUENTA PROPORCIONADA NO EXISTE",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin bco	

        --select * from catastro_gdl:saldos where cvecuenta = 10000 and saldototal=0

        --Verifica que exista en v_bco_carga1
	
	if exists (select * from v_bco_carga1 where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta
		and estatus not in ("A","E") and cvepago = 0 and YEAR(fecha_pagobco) = p_axo  )then--bco2
        -- el -2 me sirve para ense�ar enlace en la p�gina...
	return -2,"LA CUENTA PRESENTA PAGOS PENDIENTES POR APLICAR",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
	end if; --Fin bco2	

  	if NOT exists (select count(*) from v_bco_carga1 where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta
		and estatus = "A" and cvepago > 0 and YEAR(fecha_pagobco) = p_axo having count(*) > 0  ) then --bco
	
	        --Obtengo la cvecuenta
		select cvecuenta into v_cvecuenta from catastro_gdl:convcta where recaud = p_recaud and urbrus = p_urbrus and cuenta = p_cuenta;		
	
	        --Verifico si est� la l�nea de captura en linea_pagos mediante la clave cuenta
	  	if exists (select linea from linea_pagos where substr(linea,1,6) = v_cvecuenta AND modulo = 1 AND YEAR(fecha_pago) =p_axo )then --linea

		foreach
		select linea into v_linea from linea_pagos where substr(linea,1,6) = v_cvecuenta AND modulo = 1 AND YEAR(fecha_pago) =p_axo order by id desc
                end foreach;

		return -3,v_linea,
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
	     
	        end if; --Fin linea

	        return -1,"LA CUENTA NO PRESENTA PAGOS EN BANCOS PARA EL A�O "||p_axo,
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;

   	end if; --Fin bco	

	Let v_estatus = " ";

        FOREACH
	select cvecuenta, cvepago, estatus 
	into v_cvecuenta, v_cvepago, v_estatus
	from v_bco_carga1 
	where recaud = p_recaud 
	and urbrus = p_urbrus
	and cuenta = p_cuenta
	and estatus = "A"
	and cvepago > 0
	and YEAR(fecha_pagobco) = p_axo   order by cvepago 
        END FOREACH;
	
        if v_estatus is null then
	   Let v_estatus = " ";
        end if;

	if v_estatus <> "A" then
         return -1,"LA CUENTA NO HA SIDO APLICADA, PARA PAGO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
        end if;	

--Verificar en v_pagos
	if NOT exists ( select * from v_pagos where cvepago = v_cvepago and cvecuenta= v_cvecuenta 
	and cvecanc is null)then --v_pagos
	
	return -1,"EL PAGO REALIZADO A ESTA CUENTA, EST� EN PROCESO DE APLICACI�N",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin v_pagos

	select fecha, recaud, caja, folio 
	into v_fecha, v_id_rec, v_caja, v_operacion
	from v_pagos
	where cvepago= v_cvepago 
	and cvecuenta= v_cvecuenta
	and cvecanc is null; 	

--Validar en ta_12_recibos

       if NOT exists (select * from ta_12_recibos where fecha=v_fecha and id_rec = v_id_rec and caja=v_caja 
	and operacion=v_operacion and cvepago="P") then--recibos
	
	return -1,"LA CUENTA NO EXISTE EN EL REGISTRO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos

  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 

  where  fecha=v_fecha and id_rec = v_id_rec and caja=v_caja 
	 and operacion=v_operacion and cvepago="P";

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"CUENTA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo with resume;

---localizar pagos en kiosco
FOREACH
 select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos r
  where year(r.fecha)=year(v_fecha) and r.caja like "K%" and r.id_modulo in (5,12) 
        and r.id_regmodulo=p_cuenta and r.id_rec_cta=p_recaud and r.regmunur=p_urbrus and r.cvepago="P"

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"CUENTA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo with resume;
END FOREACH;
--trace off;
end procedure;

CREATE PROCEDURE "informix".upd34_gen_adeudos_ind ( par_id_34_datos Integer, par_Axo Integer, par_Mes Integer, par_Fecha Date, par_Id_Rec Integer, 
par_Caja Char(2), par_Consec Integer, par_Folio_rcbo Char(15), par_tab Char(1), par_status Char(1), par_Opc Char(1), par_usuario char(10) )
{######################################################################
#  Procedimiento:    upd34_gen_adeudos_ind
#  Descripcion:      Interfaz de actualizaciones a registros de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_Id_Cobro = Id 
#		     	par_Axo = a�o del periodo a actualizar
#		     	par_Mes = mes del periodo a actualizar
#                    		par_Fecha = Fecha del recibo
#                    		par_Id_Rec = recaudadora donde se realiza el pago(para nuevas solo en rec 2)
#                    		par_Caja = caja de pago
#                    		par_Consec = operacion de pago
#                    		par_Folio_rcbo = Folio del recibo
#                    		par_tab = rubro de ingreso
#                    		par_status = status de la operacion que deseas realizar
#                    		par_Opc = opcion de entrada de la operacion  A = operacion por cajero
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_id_usuario	int;

define v_id_34_stat, v_id_control				Integer;
define v_importe_gastos					Money(12,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion upd34_gen_adeudos_ind ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_leyenda    	= 'ALGO EXTRA�O PASO';
let v_estatus	= -1;

Let v_id_control = 0;
Let v_importe_gastos = 0;
--************************************************************************ STATUS
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = par_tab and cve_stat = par_status;
--************************************************************************

if par_Opc = 'A' then  -- entrada por cajero
	if par_status = 'P' then
		--BEGIN WORK;
		UPDATE t34_pagos SET
			fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec,  caja = par_Caja,
			operacion = par_Consec,  folio_recibo = par_Folio_rcbo,  usuario = par_usuario,  id_stat = v_id_34_stat
		WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;

		FOREACH
			SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos
                      			FROM ta_15_apremios
                       			WHERE modulo = 34  AND control_otr = par_id_34_datos  AND vigencia = "1" AND clave_practicado = "P"
				if exists ( select * from ta_15_apremios where id_control = v_id_control ) then
					UPDATE ta_15_apremios SET
						fecha_pago = par_Fecha, recaudadora = par_Id_Rec,  caja = par_Caja,  
						operacion = par_Consec,  importe_pago = v_importe_gastos,  vigencia = '2', usuario = par_usuario
						WHERE id_control = v_id_control;
				end if;
		END FOREACH;

         		let v_leyenda = 'Cajero - Pago aplicado correctamente';
         		let v_estatus  = 1;
		--COMMIT WORK; 
	else
		-- aqui insertar el guardar en el historico de movimientos
		--BEGIN WORK;	
		UPDATE t34_pagos SET
			fecha_hora_pago = Null,  id_recaudadora = Null,  caja = Null,
			operacion = Null,  folio_recibo = Null,  usuario = par_usuario,  id_stat = v_id_34_stat
		WHERE fecha_hora_pago = par_Fecha and id_recaudadora = par_Id_Rec and caja = par_Caja and operacion = par_Consec ;

		FOREACH
			SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos
                      			FROM ta_15_apremios
                       			WHERE modulo = 34  AND control_otr = par_id_34_datos  AND vigencia = "2" AND clave_practicado = "P"
				if exists ( select * from ta_15_apremios where id_control = v_id_control ) then
					UPDATE ta_15_apremios SET
						fecha_pago = Null, recaudadora = 0,  caja = ' ',  
						operacion = 0,  importe_pago = 0,  vigencia = '1', usuario = par_usuario
                       					WHERE id_control = v_id_control;
				end if;


		END FOREACH;

         		let v_leyenda = 'Cajero - Cancelacion de recibo y reactivacion de folios aplicada correctamente';
         		let v_estatus  = 1;
		--COMMIT WORK; 
	end if;
else	
	if par_status = 'P' then
		--if exists( SELECT * FROM ta_12_recibos 
		--	WHERE fecha = par_Fecha AND id_rec = par_Id_Rec AND caja = par_Caja AND operacion = par_Consec ) then
		
			--BEGIN WORK;	
			UPDATE t34_pagos SET
				fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec,  caja = par_Caja,
				operacion = par_Consec,  folio_recibo = par_Folio_rcbo,  usuario = par_usuario,  id_stat = v_id_34_stat
				WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;

         			let v_leyenda = 'PAGO APLICADO CORRECTAMENTE';
         			let v_estatus  = 1;
			--COMMIT WORK; 
		--else
         		--	let v_leyenda = 'Modulo - Pago no aplicado correctamente por no existir recibo';
         		--	let v_estatus  = -1;
		--end if;
	else
		--BEGIN WORK;	
		UPDATE t34_pagos SET
			fecha_hora_pago = Null,  id_recaudadora = Null,  caja = Null,
			operacion = Null,  folio_recibo = par_Folio_rcbo,  usuario = par_usuario,  id_stat = v_id_34_stat
			WHERE id_datos = par_id_34_datos and periodo = par_Axo || '-' || par_Mes;
		--COMMIT WORK; 
		if par_status = 'S' then
         			let v_leyenda = 'CONDONACION APLICADA CORRECTAMENTE';
         			let v_estatus  = 1;
		end if;
		if par_status = 'C' then
         			let v_leyenda = 'CANCELACION APLICADA CORRECTAMENTE';
         			let v_estatus  = 1;
		end if;
		if par_status = 'R' then
         			let v_leyenda = 'PRESCRIPCION APLICADA CORRECTAMENTE';
         			let v_estatus  = 1;
		end if;
	end if;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

create procedure "informix".ins_recarotras ( par_control int, par_axoi int, par_mesi int, par_axof int, par_mesf int, par_usuario char(10), par_porc int, par_opc int )
	returning	int as control;

define vid int;

if par_opc = 1 then
	insert into db_ingresos:t34_descrec (id_descto, id_contrato, axoinicio, mesinicio, axofin, mesfin, fecha_alta, usuario_alta, vigencia, porcentaje) 
				VALUES(0, par_control, par_axoi, par_mesi, par_axof, par_mesf, current, par_usuario,'V', par_porc);
	--	LET vid = dbinfo("sqlca.sqlerrd1");
	select id_descto INTO vid FROM db_ingresos:t34_descrec  where id_contrato = par_control and vigencia = 'V';  
	return vid;
end if;

if par_opc = 2 then
	update db_ingresos:t34_descrec set 
		fecha_baja = current, 
		usuario_baja = par_usuario, 
		vigencia='C' 
	where id_contrato = par_control and vigencia = 'V';
	return 0;
end if;

end procedure;

CREATE PROCEDURE "informix".admin_encabezados_18 (p_tipo char(1), p_numero int)
{######################################################################
#  Procedimiento:    admin_encabezados_18
#  Descripcion:      Interfaz de consulta de encabezados para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros        p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:       p_numero   = Numero de Contrato
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_encabezados en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning  varchar(92) as propietario,
                              varchar(80) as calle,
                              varchar(10) as numext,
                              varchar(10) as numint,
                              varchar(50) as colonia,
                              varchar(10) as cp,
                              varchar(13) as rfc,
                              varchar(50) as municipio,
                              varchar(50) as estado,
                              varchar(18) as curp,
                              lvarchar(500) as descripcion,
                              int as cartera,
                              varchar(255) as leyenda,
                              varchar(255) as leyendaRecibo,
                              int as impidecobro;
        
define v_importe_multa, v_importe_gastos, v_tot_gastos Money(12,2);   -- requerimientos

define v_control_contrato           Integer;   
define v_importe                            Money(15,2);

define v_propietario       varchar(92);
define v_calle                  varchar(80);
define v_numext              varchar(10);
define v_numint               varchar(10);
define v_colonia              varchar(50);
define v_cp                       varchar(10);
define v_rfc                       varchar(13);
define v_municipio          varchar(50);
define v_estado               varchar(50);
define v_curp                    varchar(18);
define v_descripcion       varchar(10);
define v_cartera                             int; --1 si la Cuenta espec�fica tiene adeudos y 0 en caso contrario
define v_leyenda             varchar(50);
define v_leyendaRecibo varchar(255);
define v_codigo                              int;

define v_Axo                     Integer;
define v_status_vigencia              Char(1);

let v_propietario              = ' ';
let v_calle                         = ' ';
let v_numext                     = ' ';
let v_numint                      = ' ';
let v_colonia                     = ' ';
let v_cp                              = ' ';
let v_rfc                             = ' ';
let v_municipio                 = ' ';
let v_estado       = ' ';
let v_curp                          = ' ';
let v_descripcion              = ' ';
let v_cartera                     = 0;
let v_leyenda    = 'NO PROCEDE COBRO';
let v_leyendaRecibo     = ' ';
let v_codigo                      = -1;

Let v_control_contrato = 0;
Let v_importe = 0;
Let v_Axo = Year(Current);



if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato, (c.descripcion) nom_emp, a.domicilio, a.status_vigencia  INTO  v_control_contrato, v_propietario, v_calle, v_status_vigencia
                              FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c  
                              WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp;
                                            let v_colonia                     = 'COL. CENTRO';
                                            let v_municipio                 = 'GUADALAJARA';
                                            let v_estado                      = 'JALISCO';
                              
               -- APREMIOS
               Let v_importe_multa = 0;
               Let v_importe_gastos = 0;
               Let v_tot_gastos = 0;
                foreach
                     SELECT importe_multa,     importe_gastos  INTO v_importe_multa, v_importe_gastos 
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                end foreach;

                                                                          if exists( SELECT * FROM ta_16_pagos WHERE control_contrato = v_control_contrato ) then
                                                                                         SELECT sum(importe)  INTO v_importe  FROM ta_16_pagos WHERE control_contrato = v_control_contrato and status_vigencia = 'V';
                                                                                         if v_importe > 0 then
                                                                                                       let v_cartera      = 1;
                                                                                                       let v_leyenda    = 'PROCEDE COBRO';
                                                                                                       let v_codigo       = 0;
                                                                                         else
                                                                                                       if v_importe_multa > 0 or v_tot_gastos > 0 then
                                                                                                                      let v_cartera      = 1; 
                                                                                                                      let v_leyenda    = 'requerimientos PROCEDE COBRO';
                                                                                                                      let v_codigo       = 0;
                                                                                                       else
                                                                                                                      let v_cartera      = 0;
                                                                                                                      let v_leyenda     = 'NO TIENE ADEUDOS';
                                                                                                                      Let v_codigo      = -1;
                                                                                                       end if;
                                                                                         end if;
                                                                          else
                                                                                         if v_importe_multa > 0 or v_tot_gastos > 0 then
                                                                                                       let v_cartera      = 1;  
                                                                                                       let v_leyenda    = 'PROCEDE COBRO';
                                                                                                       let v_codigo       = 0;
                                                                                         end if;
                                                                          end if;
               if v_status_vigencia = 'C' then
                              let v_cartera                     = 0;
                              let v_leyenda    = 'NO PROCEDE COBRO CONTRATO CANCELADO';
               end if;
               if v_status_vigencia = 'N' then
                              let v_cartera                     = 0;
                              let v_leyenda    = 'NO PROCEDE COBRO CONTRATO CONVENIADO';
               end if;
               if v_status_vigencia = 'S' then
                              let v_cartera                     = 0;
                              let v_leyenda    = 'NO PROCEDE COBRO CONTRATO CON SUSPENSION DE PAGOS';
               end if;


               RETURN v_propietario, v_calle, v_numext, v_numint, v_colonia, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_descripcion, v_cartera, v_leyenda, v_leyendaRecibo, v_codigo;
else
               RETURN v_propietario, v_calle, v_numext, v_numint, v_colonia, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_descripcion, v_cartera, v_leyenda, v_leyendaRecibo, v_codigo;
end if;
end procedure;

CREATE PROCEDURE "informix".adeudo_conspant(
    p_control_rcm INT,
    p_axo INT
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);

--****** variables locales
define v_cvecuenta int;
define v_cvepago int;
define v_caja char(2);--
define v_operacion int;--
define v_fecha date;--
define v_id_rec smallint;--
define v_estatus char(1);
define v_linea char(33);

--Verifica que exista en catastro_gdl:convcta
  	if NOT exists (select * from ta_13_datosrcm where control_rcm = p_control_rcm) then --bco
	
	return -1,"EL NUMERO DE CONTROL PROPORCIONADO NO EXISTE",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if;

--Validar en ta_12_recibos

       if NOT exists (select * from ta_12_recibos where id_modulo=13 AND id_regmodulo=p_control_rcm
			and year(fecha) = p_axo
			and caja IN ("K1","K2","K3","K4","K5","K6","K7","K8","K9") and cvepago="P" ) then --recibos
	
	return -1,"NO EXISTE PAGO PARA ESE NUMERO DE CONTROL",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   	end if; --Fin recibos

  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 
  where id_modulo=13 AND id_regmodulo=p_control_rcm
			and year(fecha) = p_axo
			and caja IN ("K1","K2","K3","K4","K5","K6","K6","K7","K8","K9") and cvepago="P";

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"CUENTA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		o_id_modulo,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;
end procedure;

CREATE PROCEDURE "pgmoreno".sp_requerim_f00 ( par_Modulo Integer, p_Id Integer )
{######################################################################
#  Procedimiento:    sp16_Requerim_F00
#  Descripcion:      Interfaz de consulta de Requerimientos en INGRESOS
#
#  Parametros	par_Modulo	= Modulo de Consulta
#  de entrada:	p_Id		= Id de Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento para cualquiera que solicite datos de requerimientos
#  Llama a:          
#  
######################################################################}
                returning	int as rubro,
		Integer as Cuenta_Aplicacion,
		Money(12,2) as importe,
		varchar(100) as concepto;    

--******************************************************************************************* APREMIOS
  define v_id_control, v_folio_req, v_FolReq		Integer;
  define v_importe_multa, v_tot_multas, v_tot_dscto_multas, v_importe_gastos, v_tot_gastos, v_porcentaje_multa      Money(12,2);
  define v_DetFolReq                                                               varchar(255);
  define v_diligencia                                                                 char(1);
--*******************************************************************************************

Let v_id_control = 0;

Let v_tot_gastos = 0;
Let v_importe_multa = 0;
Let v_importe_gastos = 0;
Let v_FolReq = 0;
Let v_DetFolReq = 'Docto(s) Requerido(s) : ';

FOREACH
SELECT id_control,   folio,            diligencia,      importe_multa,     importe_gastos, porcentaje_multa
INTO v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos, v_porcentaje_multa 
FROM ta_15_apremios
WHERE modulo = par_Modulo  And control_otr = p_Id
And vigencia = "1" and clave_practicado = "P"
Order By id_control
	
	Let v_tot_multas = v_importe_multa;
                  if v_porcentaje_multa < 100 then
                  	Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                    Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
	else
                  	Let v_tot_dscto_multas = 0;
	end if;

	if v_FolReq > 0 then
                  	Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
	else
                  	Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
		Let v_FolReq = v_FolReq + 1;
	end if;

	Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

END FOREACH;

	RETURN 0, 0, 0, v_DetFolReq	with resume;
	if v_FolReq > 0 then
		if v_importe_multa <> 0 then
			RETURN 1, 515002003, v_importe_multa, 'Multas '			with resume;
		end if;
		if v_tot_dscto_multas <> 0 then
			RETURN 2, 515042003, v_tot_dscto_multas, 'Dscto. a Multas '	with resume;
		end if;
		if v_tot_gastos <> 0 then
			RETURN 3, 992104009, v_tot_gastos, 'Gastos '			with resume;
		end if;
	end if;

END PROCEDURE;

CREATE PROCEDURE "pgmoreno".con16_detade_02x ( p_Control_contrato Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
{######################################################################
#  Procedimiento:    con16_detade_02
#  Descripcion:      Interfaz de consulta  ASEO CONTRATADO
#
#  Parametros	p_Control_contrato	=	Control del contrato
#  de entrada:	p_Rep		=	'T'=hasta fin de a�o, 'V'=solo adeudo vigente
#		p_Fecha_fin	=	en caso de ser opcion 'T' seria hasta el periodo seleccionado
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}	
returning	varchar(100) as Concepto,
	Integer as Cant_Recolec,
              	Money(12,2) as Importe_Adeudos_Multa,
              	Money(12,2) as Importe_Recargos_Gastos;

-- LICENCIAS RELACIONADAS
define v_tipo				char(1);
define v_numero				integer;
define v_licencia, v_Follic			Integer;
define v_DetFollic                                                           varchar(100);

-- APREMIOS
define v_id_control, v_folio_req, v_FolReq							Integer;
define v_importe_multa, v_porcentaje_multa, v_tot_multas, v_tot_dscto_multas, v_importe_gastos, v_tot_gastos     Money(12,2);
define v_diligencia										char(1);
--
define v_r_rubro, v_r_cta_aplic, v1_r_cta_aplic, v2_r_cta_aplic, v3_r_cta_aplic				int;
define v_r_importe, v1_r_importe, v2_r_importe, v3_r_importe						money(12,2);
define v_DetFolReq, v0_DetFolReq, v1_DetFolReq, v2_DetFolReq, v3_DetFolReq, v_concepto		varchar(100);
          
-- PERIODO DE CORTE PARA RECARGOS
define v_Periodo_CN, v_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE					varchar(7);

-- ADEUDOS
define v_Contador										Integer;
define v_aso_mes_pago									Date;
define v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias						int;
define v_descripcion									varchar(100);
define v_Importe_recargo, v_importe, v_importe_rec1, v_importe_rec2					money(12,2);
define v_TotRecargos, v_totAdeudos								money(12,2);
define v_mensaje_proc									varchar(255);

Let v_Contador = 0;

-- INICIA PERIODO PARA GENERACION DE ADEUDOS
Let v_Periodo_CN = '';	Let v_Periodo_EXE = '';	Let r_Periodo_CN = '';	Let r_Periodo_EXE = '';
EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;  -- para obtener adeudo vigente
-- TERMINA PERIODO PARA GENERACION DE ADEUDOS

if exists( SELECT * FROM ta_16_contratos WHERE control_contrato = p_Control_contrato ) then	-- INICIO DE LECTURA DE DATOS DEL CONTRATO
	SELECT a.num_contrato, b.tipo_aseo INTO v_numero, v_tipo  FROM ta_16_contratos a, ta_16_tipo_aseo b
	WHERE a.control_contrato = p_Control_contrato  and b.ctrol_aseo = a.ctrol_aseo;
   
-- INICIA LICENCIAS RELACIONADAS
Let v_licencia = 0;	Let v_Follic = 0;	Let v_DetFollic = '';
EXECUTE PROCEDURE sp16_LicenciaGiro_F1 ( v_tipo, v_numero ) INTO v_Follic, v_DetFollic;
if v_Follic > 0 then
	return v_DetFollic, Null, Null, Null     with resume;
                  Let v_Contador = v_Contador + 1;
end if;
-- TERMINA LICENCIAS RELACIONADAS

-- INICIA REQUERIMIENTOS
Let v_r_rubro = 0;
Let v_r_cta_aplic = 0;  Let v1_r_cta_aplic = 0;  Let v2_r_cta_aplic = 0;  Let v3_r_cta_aplic = 0;
Let v_r_importe = 0;  Let v1_r_importe = 0;  Let v2_r_importe = 0;  Let v3_r_importe = 0;
Let v_DetFolReq = ' ';  Let v0_DetFolReq = ' ';  Let v1_DetFolReq = ' ';  Let v2_DetFolReq = ' ';  Let v3_DetFolReq = ' ';
FOREACH
EXECUTE PROCEDURE sp_Requerim_F00 ( 16, p_Control_contrato )  INTO v_r_rubro, v_r_cta_aplic, v_r_importe, v_DetFolReq
if v_r_rubro =  0 then  Let v0_DetFolReq = v_DetFolReq;  end if;					-- Descripcion de documentos
if v_r_rubro =  1 then  Let v1_DetFolReq = v_DetFolReq;  Let v1_r_importe = v_r_importe;  end if;		-- Importe de Multa
if v_r_rubro =  2 then  Let v2_DetFolReq = v_DetFolReq;  Let v2_r_importe = v_r_importe;  end if;		-- Descuento a la Multa
if v_r_rubro =  3 then  Let v3_DetFolReq = v_DetFolReq;  Let v3_r_importe = v_r_importe;  end if;		-- Importe de Gastos
END FOREACH;
if ( v1_r_importe <> 0 ) and ( v3_r_importe <> 0 ) then
	return v0_DetFolReq, Null, v1_r_importe, v3_r_importe  with resume;
	if v2_r_importe <> 0 then
		return 'Dscto. a Multas', Null, v2_r_importe, Null  with resume;
	end if;
else
	if ( v1_r_importe = 0 ) and ( v3_r_importe <> 0 ) then
		return v0_DetFolReq, Null, 0, v3_r_importe  with resume;
	end if;
end if;
-- TERMINA REQUERIMIENTOS
-- SE OBTIENE PERIODO PARA REQUERIR ADEUDO
Let r_Periodo_CN = v_Periodo_CN;
Let r_Periodo_EXE = v_Periodo_EXE;
if p_Rep <> 'V' then
	Let v_Periodo_CN = p_Fecha_fin;
	Let v_Periodo_EXE = p_Fecha_fin;
end if;

-- INICIA LECTURA DE ADEUDOS
Let v_Axo = 0;	Let v_Mes = 0;	Let v_Ctrol_Operacion = 0;	Let v_exedencias = 0;	Let v_importe = 0;	Let v_descripcion = '';
Let v_totAdeudos = 0;	Let v_Importe_recargo = 0;	Let v_importe_rec1 = 0;	Let v_importe_rec2 = 0;	Let v_mensaje_proc = '';
FOREACH
Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
Into v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion
From ta_16_pagos a, ta_16_operacion b
Where a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= v_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion = 6
And b.ctrol_operacion = a.ctrol_operacion
UNION ALL
Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
From ta_16_pagos a, ta_16_operacion b
Where a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= v_Periodo_EXE  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
And b.ctrol_operacion = a.ctrol_operacion
Order By 1, 4

if v_importe > 0 then
	--Let v_totAdeudos = v_totAdeudos + v_importe;
	if v_Ctrol_Operacion = 6 then
		Select sum(porc_recargo) 
                                    	Into v_Importe_recargo 
			From ta_16_recargos 
			Where aso_mes_recargo between (v_aso_mes_pago) and (r_Periodo_CN);
	else 
		Select sum(porc_recargo) 
			Into v_Importe_recargo 
			From ta_16_recargos 
			Where aso_mes_recargo between (v_aso_mes_pago) and (r_Periodo_EXE);
	end if;

	if v_Importe_recargo <> 0 then
                  	Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100; 
		RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), v_exedencias, v_importe, v_importe_rec1  with resume; 
		EXECUTE PROCEDURE sp_desctomerc ( p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc; 
		if v_importe_rec2 > 0 then
                                    	Let v_importe_rec2 = v_importe_rec2 * -1; 
			RETURN 'Dscto. al Rcgo del Adeudo', Null, Null, v_importe_rec2	with resume;
		end if;
	else
                  	RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), v_exedencias, v_importe, 0	with resume;
	end if;

	Let v_Contador = v_Contador + 1;
end if;

Let v_importe = 0;
Let v_Importe_recargo = 0;
Let v_importe_rec1 = 0;
Let v_importe_rec2 = 0;

--Let v_totAdeudos = 0;
--Let v_TotRecargos = 0;
END FOREACH;
-- TERMINA LECTURA DE ADEUDOS

end if;  -- FIN DE LECTURA DE DATOS DEL CONTRATO SI EXISTE

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_contratos ( parTipo char(1), parVigencia char(1) )
{######################################################################
#  Procedimiento:    sp16_contratos
#  Descripcion:      Interfaz de consulta  ASEO CONTRATADO
#
#  Parametros	parTipo		=	'C'=Zona Centro, 'H'=Hospitalario, 'O'=Ordinario, 'T'=Todos
#  de entrada:	parVigencia	=	'V'=VIGENTE, 'N'=CONVENIADO, 'C'=CANCELADO, 'S'=SUSPENDIDO, 'T'=TODOS
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
	returning	int as Control_Contrato,
		int as Num_Contrato,
		varchar(80) as Calle,
		varchar(10) as Numext,
		varchar(10) as Numint,
		varchar(50) as Colonia,
		char(1) as Sector,
		varchar(10) as Cp,
		varchar(13) as Rfc,
		varchar(50) as Municipio,
		varchar(50) as Estado,
		varchar(18) as Curp,
		char(10) as Status_Contrato,

		int as Num_Empresa,
		varchar(80) as Nombre_Empresa,
		varchar(80) as Representante_Empresa,

		char(1) as Tipo_Aseo,
		varchar(80) as Tipo_Aseo_Descripcion,

		char(1) as Cve_Recoleccion,
		varchar(80) as Unidad_Recoleccion,
		int as Cantidad_Recoleccion,
		char(7) as Inicio_Oblig,
		char(7) as Fin_Oblig;

define v_control_contrato	int;
define v_numero_contrato	int;
define v_calle		varchar(80);
define v_numext		varchar(10);
define v_numint               	varchar(10);
define v_colonia              	varchar(50);
define v_sector		char(1);
define v_cp                       	varchar(10);
define v_rfc                       	varchar(13);
define v_municipio          	varchar(50);
define v_estado               	varchar(50);
define v_curp                    	varchar(18);
define v_Status_Contrato	char(10);

define v_num_empresa	int;
define v_Nombre_Empresa, v_Representante_Empresa	varchar(80);

define v_tipo, v_status_c		char(1);
define v_ctrol_aseo, v_ctrol_emp, v_ctrol_recolec, v_cantidad_recolec, v_id_rec int;
define v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja	date;

define v_Cve_Recoleccion			char(1);
define v_Tipo_Aseo_Descripcion, v_Unidad_Recoleccion	varchar(80);

define v_inicio_oblig, v_fin_oblig	char(7);

define req_Concepto	varchar(255);
define req_Multa, req_Gastos	Money(12,2);

Let v_control_contrato = 0;
Let v_numero_contrato = 0;
Let v_calle = ' ';
Let v_numext = ' ';
Let v_numint = ' ';
Let v_colonia = ' ';
Let v_sector = ' ';
Let v_cp = ' ';
Let v_rfc = ' ';
Let v_municipio = ' ';
Let v_estado = ' ';
Let v_curp = ' ';
Let v_status_contrato = ' ';

Let v_num_empresa = 0;
Let v_nombre_empresa = ' ';
Let v_representante_empresa = ' ';

Let v_ctrol_aseo = 0;
Let v_ctrol_emp = 0;
Let v_ctrol_recolec = 0;
Let v_cantidad_recolec = 0;
Let v_id_rec = 0;

Let v_tipo_aseo_descripcion = ' ';
Let v_cve_recoleccion = ' ';
Let v_unidad_recoleccion = ' ';

Let v_inicio_oblig = '';
Let v_fin_oblig = '';

Let req_Concepto = '';
Let req_Multa = 0;
Let req_Gastos = 0;

FOREACH
SELECT a.control_contrato, a.num_contrato, a.domicilio, a.sector, a.status_vigencia, 
( case 
when a.status_vigencia = 'V' then 'VIGENTE' 
when a.status_vigencia = 'N' then 'CONVENIADO' 
when a.status_vigencia = 'C' then 'CANCELADO'  
when a.status_vigencia = 'S' then 'SUSPENDIDO' 
end ),
a.ctrol_aseo, a.ctrol_emp, a.num_empresa, a.ctrol_recolec, a.cantidad_recolec, a.id_rec,
a.fecha_hora_alta, a.aso_mes_oblig, a.fecha_hora_baja 

INTO  v_control_contrato, v_numero_contrato, v_calle, v_sector, v_status_c, 
v_Status_Contrato,
v_ctrol_aseo, v_ctrol_emp, v_num_empresa, v_ctrol_recolec, v_cantidad_recolec, v_id_rec,
v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja

FROM ta_16_contratos a, ta_16_tipo_aseo b 
WHERE b.ctrol_aseo = a.ctrol_aseo
Order By ctrol_aseo, num_contrato 

	Let v_colonia                     = 'COL. CENTRO';
                  Let v_municipio                 = 'GUADALAJARA';
                  Let v_estado                      = 'JALISCO';
		
	SELECT tipo_aseo, descripcion INTO v_tipo, v_Tipo_Aseo_Descripcion  from ta_16_tipo_aseo where ctrol_Aseo = v_ctrol_aseo;

	SELECT descripcion, representante  INTO v_Nombre_Empresa, v_Representante_Empresa 
	FROM ta_16_empresas WHERE ctrol_emp = v_ctrol_emp and num_empresa = v_num_empresa;

	SELECT cve_recolec, descripcion  INTO  v_Cve_Recoleccion, v_Unidad_Recoleccion  FROM ta_16_unidades WHERE ctrol_recolec = v_ctrol_recolec;

	Let v_inicio_oblig = Year(v_aso_mes_oblig)||'-'||Month(v_aso_mes_oblig);
	Let v_fin_oblig = Year(v_fecha_hora_baja)||'-'||Month(v_fecha_hora_baja);

--

if parTipo = 'T' then
	if parVigencia = 'T' then
		RETURN v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
		v_num_empresa, v_nombre_empresa, v_representante_empresa, v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
		v_inicio_oblig, v_fin_oblig  with resume;
	else
		if parVigencia = v_status_c then
			RETURN v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
			v_num_empresa, v_nombre_empresa, v_representante_empresa, v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
			v_inicio_oblig, v_fin_oblig  with resume;
		end if;
	end if;
else
	if parTipo = v_tipo then
		if parVigencia = 'T' then
			RETURN v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
			v_num_empresa, v_nombre_empresa, v_representante_empresa, v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
			v_inicio_oblig, v_fin_oblig  with resume;
		else
			if parVigencia = v_status_c then
				RETURN v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
				v_num_empresa, v_nombre_empresa, v_representante_empresa, v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
				v_inicio_oblig, v_fin_oblig  with resume;
			end if;
		end if;
	end if;
end if;
--
end foreach;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_empresa_contratos ( parOpc char(1), parDescrip varchar(80), parTipo_Aseo char(1), parVigencia_Contrato char(1) )
{######################################################################
#  Procedimiento:    sp16_contratos
#  Descripcion:      Interfaz de consulta  ASEO CONTRATADO
#
#  Parametros	parTipo_Aseo		=	'C'=Zona Centro, 'H'=Hospitalario, 'O'=Ordinario, 'T'=Todos
#  de entrada:	parVigencia_Contrato	=	'V'=VIGENTE, 'N'=CONVENIADO, 'C'=CANCELADO, 'S'=SUSPENDIDO, 'T'=TODOS
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
	returning	int as Num_Empresa,
		varchar(80) as Nombre_Empresa,
		varchar(80) as Representante_Empresa,
		char(1) as Tipo_empresa,
		varchar(80) as Tipo_Descripcion,

		int as Control_Contrato,
		int as Num_Contrato,
		varchar(80) as Calle,
		varchar(10) as Numext,
		varchar(10) as Numint,
		varchar(50) as Colonia,
		char(1) as Sector,
		varchar(10) as Cp,
		varchar(13) as Rfc,
		varchar(50) as Municipio,
		varchar(50) as Estado,
		varchar(18) as Curp,
		char(10) as Status_Contrato,

		char(1) as Tipo_Aseo,
		varchar(80) as Tipo_Aseo_Descripcion,

		char(1) as Cve_Recoleccion,
		varchar(80) as Unidad_Recoleccion,
		int as Cantidad_Recoleccion,
		char(7) as Inicio_Oblig,
		char(7) as Fin_Oblig;

define v_num_empresa	int;
define v_Nombre_Empresa, v_Representante_Empresa	varchar(80);
define v_Ctrol_emp	int;  
define v_Tipo_empresa char(1); 
define v_tipo_Descripcion varchar(80);

define v_control_contrato	int;
define v_numero_contrato	int;
define v_calle		varchar(80);
define v_numext		varchar(10);
define v_numint               	varchar(10);
define v_colonia              	varchar(50);
define v_sector		char(1);
define v_cp                       	varchar(10);
define v_rfc                       	varchar(13);
define v_municipio          	varchar(50);
define v_estado               	varchar(50);
define v_curp                    	varchar(18);
define v_Status_Contrato	char(10);

define v_tipo, v_status_c		char(1);
define v_ctrol_aseo, v_ctrol_recolec, v_cantidad_recolec, v_id_rec int;
define v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja	date;

define v_Cve_Recoleccion			char(1);
define v_Tipo_Aseo_Descripcion, v_Unidad_Recoleccion	varchar(80);

define v_inicio_oblig, v_fin_oblig	char(7);

Let v_num_empresa = 0;
Let v_Nombre_Empresa = '';
Let v_Representante_Empresa = '';
Let v_Ctrol_emp = 0;
Let v_Tipo_empresa = '';
Let v_tipo_Descripcion = '';

Let v_control_contrato = 0;
Let v_numero_contrato = 0;
Let v_calle = ' ';
Let v_numext = ' ';
Let v_numint = ' ';
Let v_colonia = ' ';
Let v_sector = ' ';
Let v_cp = ' ';
Let v_rfc = ' ';
Let v_municipio = ' ';
Let v_estado = ' ';
Let v_curp = ' ';
Let v_status_contrato = ' ';

Let v_ctrol_aseo = 0;
Let v_ctrol_recolec = 0;
Let v_cantidad_recolec = 0;
Let v_id_rec = 0;

Let v_tipo = ' ';
Let v_tipo_aseo_descripcion = ' ';
Let v_cve_recoleccion = ' ';
Let v_unidad_recoleccion = ' ';

Let v_inicio_oblig = '';
Let v_fin_oblig = '';

if parOpc = 'T' then	
	FOREACH
	select a.Num_empresa, a.Ctrol_emp, a.Descripcion, a.Representante, b.Tipo_empresa, b.Descripcion
	INTO v_Num_empresa, v_Ctrol_emp, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion
	from ta_16_empresas a, ta_16_tipos_emp b
	where b.Ctrol_emp = a.Ctrol_emp
	Order By a.Descripcion, a.Ctrol_emp, a.Num_empresa

	if exists ( SELECT * FROM ta_16_contratos WHERE num_empresa = v_Num_empresa and ctrol_emp = v_Ctrol_emp ) then
		FOREACH
		SELECT a.control_contrato, a.num_contrato, a.domicilio, a.sector, a.status_vigencia, 
		( case 
		when a.status_vigencia = 'V' then 'VIGENTE' 
		when a.status_vigencia = 'N' then 'CONVENIADO' 
		when a.status_vigencia = 'C' then 'CANCELADO'  
		when a.status_vigencia = 'S' then 'SUSPENDIDO' 
		end ),
		a.ctrol_aseo, a.ctrol_recolec, a.cantidad_recolec, a.id_rec,
		a.fecha_hora_alta, a.aso_mes_oblig, a.fecha_hora_baja 

		INTO  v_control_contrato, v_numero_contrato, v_calle, v_sector, v_status_c, 
		v_Status_Contrato,
		v_ctrol_aseo, v_ctrol_recolec, v_cantidad_recolec, v_id_rec,
		v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja

		FROM ta_16_contratos a, ta_16_tipo_aseo b 
		WHERE num_empresa = v_Num_empresa and ctrol_emp = v_Ctrol_emp 
		AND b.ctrol_aseo = a.ctrol_aseo
		Order By ctrol_aseo, num_contrato 

		Let v_colonia                     = 'COL. CENTRO';
                  	Let v_municipio                 = 'GUADALAJARA';
                  	Let v_estado                      = 'JALISCO';
		
		SELECT tipo_aseo, descripcion INTO v_tipo, v_Tipo_Aseo_Descripcion  from ta_16_tipo_aseo where ctrol_Aseo = v_ctrol_aseo;

		SELECT cve_recolec, descripcion  INTO  v_Cve_Recoleccion, v_Unidad_Recoleccion  FROM ta_16_unidades WHERE ctrol_recolec = v_ctrol_recolec;

		Let v_inicio_oblig = Year(v_aso_mes_oblig)||'-'||Month(v_aso_mes_oblig);
		Let v_fin_oblig = Year(v_fecha_hora_baja)||'-'||Month(v_fecha_hora_baja);

		if parTipo_Aseo = 'T' then
			if parVigencia_Contrato = 'T' then
				RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
				v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
				v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
				v_inicio_oblig, v_fin_oblig  with resume;
			else
				if parVigencia_Contrato = v_status_c then
					RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
					v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
					v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
					v_inicio_oblig, v_fin_oblig  with resume;
				end if;
			end if;
		else
			if parTipo_Aseo = v_tipo then
				if parVigencia_Contrato = 'T' then
					RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
					v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
					v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
					v_inicio_oblig, v_fin_oblig  with resume;
				else
					if parVigencia_Contrato = v_status_c then
						RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
						v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
						v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
						v_inicio_oblig, v_fin_oblig  with resume;
					end if;
				end if;
			end if;
		end if;

		Let v_control_contrato = 0;
		Let v_numero_contrato = 0;
		Let v_calle = '';
		Let v_numext = '';
		Let v_numint = '';
		Let v_colonia = '';
		Let v_sector = '';
		Let v_cp = '';
		Let v_rfc = '';
		Let v_municipio = '';
		Let v_estado = '';
		Let v_curp = '';
		Let v_status_contrato = '';
		Let v_tipo = '';
		Let v_tipo_aseo_descripcion = '';
		Let v_cve_recoleccion = '';
		Let v_unidad_recoleccion = '';
		Let v_cantidad_recolec = 0;
		Let v_inicio_oblig = '';
		Let v_fin_oblig = '';
		END FOREACH;
	end if;
	END FOREACH;
else
	FOREACH
	select a.Num_empresa, a.Ctrol_emp, a.Descripcion, a.Representante, b.Tipo_empresa, b.Descripcion
	INTO v_Num_empresa, v_Ctrol_emp, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion
	from ta_16_empresas a, ta_16_tipos_emp b
	where a.Descripcion like '%'||(parDescrip)||'%' and 		-- linea despues del Where adicionada
	b.Ctrol_emp = a.Ctrol_emp
	Order By a.Descripcion, a.Ctrol_emp, a.Num_empresa

	if exists ( SELECT * FROM ta_16_contratos WHERE num_empresa = v_Num_empresa and ctrol_emp = v_Ctrol_emp ) then
		FOREACH
		SELECT a.control_contrato, a.num_contrato, a.domicilio, a.sector, a.status_vigencia, 
		( case 
		when a.status_vigencia = 'V' then 'VIGENTE' 
		when a.status_vigencia = 'N' then 'CONVENIADO' 
		when a.status_vigencia = 'C' then 'CANCELADO'  
		when a.status_vigencia = 'S' then 'SUSPENDIDO' 
		end ),
		a.ctrol_aseo, a.ctrol_recolec, a.cantidad_recolec, a.id_rec,
		a.fecha_hora_alta, a.aso_mes_oblig, a.fecha_hora_baja 

		INTO  v_control_contrato, v_numero_contrato, v_calle, v_sector, v_status_c, 
		v_Status_Contrato,
		v_ctrol_aseo, v_ctrol_recolec, v_cantidad_recolec, v_id_rec,
		v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja

		FROM ta_16_contratos a, ta_16_tipo_aseo b 
		WHERE num_empresa = v_Num_empresa and ctrol_emp = v_Ctrol_emp 
		AND b.ctrol_aseo = a.ctrol_aseo
		Order By ctrol_aseo, num_contrato 

		Let v_colonia                     = 'COL. CENTRO';
                  	Let v_municipio                 = 'GUADALAJARA';
                  	Let v_estado                      = 'JALISCO';
		
		SELECT tipo_aseo, descripcion INTO v_tipo, v_Tipo_Aseo_Descripcion  from ta_16_tipo_aseo where ctrol_Aseo = v_ctrol_aseo;

		SELECT cve_recolec, descripcion  INTO  v_Cve_Recoleccion, v_Unidad_Recoleccion  FROM ta_16_unidades WHERE ctrol_recolec = v_ctrol_recolec;

		Let v_inicio_oblig = Year(v_aso_mes_oblig)||'-'||Month(v_aso_mes_oblig);
		Let v_fin_oblig = Year(v_fecha_hora_baja)||'-'||Month(v_fecha_hora_baja);

		if parTipo_Aseo = 'T' then
			if parVigencia_Contrato = 'T' then
				RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
				v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
				v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
				v_inicio_oblig, v_fin_oblig  with resume;
			else
				if parVigencia_Contrato = v_status_c then
					RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
					v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
					v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
					v_inicio_oblig, v_fin_oblig  with resume;
				end if;
			end if;
		else
			if parTipo_Aseo = v_tipo then
				if parVigencia_Contrato = 'T' then
					RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
					v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
					v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
					v_inicio_oblig, v_fin_oblig  with resume;
				else
					if parVigencia_Contrato = v_status_c then
						RETURN v_Num_empresa, v_Nombre_Empresa, v_Representante_Empresa, v_Tipo_empresa, v_Tipo_Descripcion, 
						v_control_contrato, v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_status_contrato, 
						v_tipo, v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
						v_inicio_oblig, v_fin_oblig  with resume;
					end if;
				end if;
			end if;
		end if;

		Let v_control_contrato = 0;
		Let v_numero_contrato = 0;
		Let v_calle = '';
		Let v_numext = '';
		Let v_numint = '';
		Let v_colonia = '';
		Let v_sector = '';
		Let v_cp = '';
		Let v_rfc = '';
		Let v_municipio = '';
		Let v_estado = '';
		Let v_curp = '';
		Let v_status_contrato = '';
		Let v_tipo = '';
		Let v_tipo_aseo_descripcion = '';
		Let v_cve_recoleccion = '';
		Let v_unidad_recoleccion = '';
		Let v_cantidad_recolec = 0;
		Let v_inicio_oblig = '';
		Let v_fin_oblig = '';
		END FOREACH;
	end if;
	END FOREACH;
end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp16_adeudos_novig ( p_tipo char(1), p_numero int, parOpcion char(1) )
{######################################################################
#  Procedimiento:    sp16_Adeudos_NoVig
#  Descripcion:      Interfaz de consulta de detalle de Periodos NO VIGENTES de ASEO CONTRATADO
#
#  Parametros           p_tipo		= tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:            p_numero		= Numero de Contrato
#		parOpcion	= P - PAGADO, S - CONDONADO, C - CANCELADO, R - PRESCRITO, N - CONDONADO/CANCELADO/PRESCRITO, T - TODOS
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}	
	returning	char(7) as Periodo,
		varchar(80) as Tipo_Adeudo,
		int as Cantidad,
		money(12,2) as Importe,
		char(10) as Status_Vigencia,
		date as Fecha,
		int as Recaudadora,
		char(2) as Caja,
		int as Operacion,
		char(20) as Rcbo,
		char(20) as Usuario;

define v_control_contrato				int;

define v_axo, v_mes, v_ctrol_operacion	int;
define v_periodo	char(7);
define v_cantidad	int;
define v_importe	money(12,2);
define v_Tipo_Adeudo	varchar(80);
define v_status		char(1);
define v_status_vigencia	char(10);
define v_fecha		date;
define v_id_rec		int;
define v_caja		char(2);
define v_oper		int;
define v_rcbo		char(20);
define v_usuario		char(20);

Let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato  INTO  v_control_contrato   FROM ta_16_contratos a, ta_16_tipo_aseo b
                               WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

	-- ADEUDOS
	Let v_axo = 0;
	Let v_mes = 0;
	Let v_ctrol_operacion = 0;
	Let v_periodo = '';
	Let v_cantidad = 0;
	Let v_importe = 0;
	Let v_Tipo_Adeudo = '';
	Let v_status = '';
	Let v_status_vigencia = '';
	Let v_fecha = Current;
	Let v_id_rec = 0;
	Let v_caja = '';
	Let v_oper = 0;
	Let v_rcbo = '';
	Let v_usuario = '';
	FOREACH

	Select Year(a.aso_mes_pago),Month(a.aso_mes_pago),a.ctrol_operacion, a.Status_Vigencia, Year(a.aso_mes_pago)||'-'||Month(a.aso_mes_pago), a.exedencias, a.importe, b.descripcion
	, case 
	when a.Status_Vigencia = 'P' then 'PAGADO' 
	when a.Status_Vigencia = 'S' then 'CONDONADO' 
	when a.Status_Vigencia = 'C' then 'CANCELADO' 
	when a.Status_Vigencia = 'R' then 'PRESCRITO' 
	end case 
	,a.fecha_hora_pago, a.id_rec, a.caja, a.consec_operacion, a.folio_rcbo, c.usuario

	INTO v_axo, v_mes, v_ctrol_operacion, v_status, v_periodo, v_cantidad, v_importe, v_Tipo_Adeudo, v_status_vigencia, v_fecha, v_id_rec, v_caja, v_oper, v_rcbo, v_usuario

	From ta_16_pagos a, ta_16_operacion b, outer ta_12_passwords c
	Where a.Control_Contrato = v_control_contrato  and a.Status_Vigencia in ( 'P','S','C','R' ) and a.ctrol_operacion = 6
	And b.ctrol_operacion = a.ctrol_operacion
	And c.id_usuario = a.usuario 
	UNION ALL
	Select Year(a.aso_mes_pago),Month(a.aso_mes_pago),a.ctrol_operacion, a.Status_Vigencia, Year(a.aso_mes_pago)||'-'||Month(a.aso_mes_pago), a.exedencias, a.importe, b.descripcion
	, case 
	when a.Status_Vigencia = 'P' then 'PAGADO' 
	when a.Status_Vigencia = 'S' then 'CONDONADO' 
	when a.Status_Vigencia = 'C' then 'CANCELADO' 
	when a.Status_Vigencia = 'R' then 'PRESCRITO' 
	end case 
	,a.fecha_hora_pago, a.id_rec, a.caja, a.consec_operacion, a.folio_rcbo, c.usuario
	From ta_16_pagos a, ta_16_operacion b, outer ta_12_passwords c
	Where a.Control_Contrato = v_control_contrato  and a.Status_Vigencia in ( 'P','S','C','R' ) and a.ctrol_operacion <> 6
	And b.ctrol_operacion = a.ctrol_operacion
	And c.id_usuario = a.usuario 
	Order By 1,2,3

	if (parOpcion = 'P') or (parOpcion = 'S') or (parOpcion = 'C') or (parOpcion = 'R') then
		if parOpcion = v_status then
			RETURN v_periodo, v_Tipo_Adeudo, v_cantidad, v_importe, v_status_vigencia, v_fecha, v_id_rec, v_caja, v_oper, v_rcbo, v_usuario  with resume;
		end if;
	end if;
	if parOpcion = 'N' then
		if (v_status = 'S') or (v_status = 'C') or (v_status = 'R') then
			RETURN v_periodo, v_Tipo_Adeudo, v_cantidad, v_importe, v_status_vigencia, v_fecha, v_id_rec, v_caja, v_oper, v_rcbo, v_usuario  with resume;
		end if; 
	end if;
	if parOpcion = 'T' then
		RETURN v_periodo, v_Tipo_Adeudo, v_cantidad, v_importe, v_status_vigencia, v_fecha, v_id_rec, v_caja, v_oper, v_rcbo, v_usuario  with resume;
	end if;

	-- ADEUDOS
	Let v_axo = 0;
	Let v_mes = 0;
	Let v_ctrol_operacion = 0;
	Let v_periodo = '';
	Let v_cantidad = 0;
	Let v_importe = 0;
	Let v_Tipo_Adeudo = '';
	Let v_status = '';
	Let v_status_vigencia = '';
	Let v_fecha = Current;
	Let v_id_rec = 0;
	Let v_caja = '';
	Let v_oper = 0;
	Let v_rcbo = '';
	Let v_usuario = '';

	END FOREACH;

end if;

end procedure;

CREATE PROCEDURE "informix".linea_pagokq(
    p_linea VARCHAR(50),
    p_recaud INT,
    p_pagado MONEY(16,2),
    p_forma_carga CHAR(1),
    p_cvepago INT,
    p_fecha_pago DATE,
    p_id_rec SMALLINT,
    p_caja CHAR(2),
    p_operacion INT,
    p_usuario CHAR(8)
)
--** PAga la linea de captura de pagos realizados en kioscos
--** p_recaud es el numero de kiosco que se le asigno en C_recaud 120+
--** Forma de carga C=Cajas Recaudadora, A=Archivo Banco k=kiosco
--** ESTATUS para linea_pago C=carga, A=aplicado, N=conciliado sin error, D=diferencia en importes 
returning int,varchar(200);
--****** parametros desde salida
--* 1.- Estatus de Registro
--* 2.- Mensaje de Estatus
define estatus int;
define mensaje varchar(200);

define v_id int;
define v_linea VARCHAR(50);
define v_id_linea int;
define v_folio int;
define v_modulo int;
define v_id_cont int;
define v_estatus char(1);
define v_fecha_pago date;
define v_fecha_impresion datetime year to second;
define v_importe money(16,2);
define v_difimp money(16,2);
define v_cvepago char(1);
define v_importe_conc money(16,2);
define v_fecha_concilia datetime year to second;


--set debug file to "lineapagok.log";
--   trace on;
--** Obtener datos de la linea de captura
--3538 4610 9610 0000 0101 8512 1278 '0000070000000000011285116291'
--select * from linea_capturadiv where trim(linea) = trim('0000070000000000011285116291')

let v_modulo = substr(p_linea,19,2)*1;

if v_modulo = 1 then --predial
   let v_estatus = "A";
   --Verifica que exista la linea de captura
   if NOT exists (select * from catastro_gdl:linea_capturapred where trim(linea) = trim(p_linea)) then
         return -1,"LA LINEA DE CAPTURA DE PAGO DE PREDIAL NO EXISTE";
   end if;
   --obtener los datos del registro de predial  
   select id,linea,cvecuenta,total into 
	  v_id_linea,v_linea,v_folio,v_importe
          from catastro_gdl:linea_capturapred where trim(linea) = trim(p_linea);  

 --  if v_importe <> p_pagado then
 --        return  1,"IMPORTE DE LINEA DE CAPTURA INCORRECTO"; 
 --  end if;
   --Obtiene el control por banco y fecha del registro de conciliacion
   if exists (select * from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pago) then
      select id into v_id_cont from linea_control where recaud = p_recaud and fecha_pagobco=p_fecha_pago;
   else 
      insert into linea_control(id ,recaud ,fecha_carga ,fecha_pagobco ,fecha_proc ,totreg ,totreg_conerr ,totreg_sinerr)
             values (0, p_recaud ,current ,p_fecha_pago,null,0 ,0 ,0);
      LET v_id_cont = dbinfo("sqlca.sqlerrd1");
   end if;    
   --Verifica si la linea de captura ya esta cargada ,pagada, conciliada y su estatus
   if exists (select * from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pago
	      and linea_cap_id=v_id_linea and modulo = v_modulo) then
      select id,estatus,fecha_pago,fecha_impresion into v_id,v_estatus,v_fecha_pago,v_fecha_impresion
	      from linea_pagos where linea_control_id = v_id_cont and fecha_pagobco=p_fecha_pago
	      and linea_cap_id=v_id_linea and modulo = v_modulo;
      if v_fecha_impresion is not null then
 	 let estatus = 2;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE IMPRESO";
         return estatus,mensaje;
      end if;
      if v_fecha_pago is not null then
	 let estatus = 3;
	 let mensaje = "EL RECIBO DE LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE PAGADO";
         return estatus,mensaje;
      end if;
      if v_estatus = "A" then
	 let estatus = 4;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL YA FUE APLICADA, PARA PAGO";
         return estatus,mensaje;
      end if;
      if v_estatus = "N" then --conciliada correctamente
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL ESTA CONCILIADA";
         return estatus,mensaje;
      end if;
   else --si no esta cargada la linea de captura en pagos
	 let v_difimp = v_importe - p_pagado;
         Insert into linea_pagos(id ,linea_control_id ,linea ,linea_cap_id ,modulo ,recaud ,fecha_pagobco ,
	        pagado ,adeudo ,diferencia ,forma_carga ,fecha_carga ,fecha_concilia ,fecha_impresion ,bco_recibo ,
	        bco_suc ,bco_caj ,bco_oper ,bco_lineatxt ,estatus ,cvepago ,fecha_pago ,id_rec ,caja ,operacion ,usuario)
	 values (0,v_id_cont ,p_linea ,v_id_linea ,v_modulo ,p_recaud ,p_fecha_pago ,p_pagado ,v_importe ,v_difimp ,p_forma_carga ,
                current ,null ,null ,null ,null ,null ,null ,null ,v_estatus ,p_cvepago ,p_fecha_pago,p_id_rec ,p_caja ,p_operacion ,p_usuario);
	 let estatus = 0;
	 let mensaje = "LA LINEA DE CAPTURA DE PAGO DE PREDIAL ESTA APLICADA";
         return estatus,mensaje;
   end if;--no existe linea captura en pagos
end if; --modulo 01 predial
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".con16_cifras2 ( p_Rep Char(1), p_Fecha_fin Char(7) )
--##################################################################
--#  Procedimiento: con16_cifras2	consulta de cifras totales a un periodo determinado
--#
--#  Parametros de entrada:	p_Rep		= 'V'=Vigentes, 'T'=Todo
--#			p_Fecha_fin	= Periodo de corte si no es 'V'
--#
--#  Elaboro:    c. Gilberto Moreno
--#  Modifico: 
--#  Fecha Modificaci�n : 
--##################################################################
                returning Integer as linea,

                               varchar(100) as Concepto1,
                               Integer as cant_concepto1,             
                               Money(12,2) as Importe_concepto1,                   

                               varchar(100) as Concepto2,
                               Integer as cant_concepto2,             
                               Money(12,2) as Importe_concepto2,                   

                               varchar(100) as Concepto3,
                               Integer as cant_concepto3,             
                               Money(12,2) as Importe_concepto3;                   

-- ADEUDOS PAGADOS
define pag_periodo	char(7);
define pag_cantidad	int;
define pag_importe, pag_tot_importe	money(12,2);
define pag_Tipo_Adeudo	varchar(80);
define pag_status_vigencia	char(10);
define pag_fecha		date;
define pag_id_rec		int;
define pag_caja		char(2);
define pag_oper		int;
define pag_rcbo		char(20);
define pag_usuario		char(20);

-- ADEUDOS CONDONADOS/CANCELADOS/PRESCRITOS
define scr_periodo	char(7);
define scr_cantidad	int;
define scr_importe, scr_tot_importe	money(12,2);
define scr_Tipo_Adeudo	varchar(80);
define scr_status_vigencia	char(10);
define scr_fecha		date;
define scr_id_rec		int;
define scr_caja		char(2);
define scr_oper		int;
define scr_rcbo		char(20);
define scr_usuario		char(20);

-- ADEUDOS
define F02_Periodo, F02_primer_adeudo			char(7);
define F02_Concepto, F02_Licencias, F02_Documentos		varchar(200);
define F02_Cant_Recolec, F02_cont_primer_adeudo		int;
define F02_Adeudos, F02_Recargos, F02_Multa, F02_Gastos	Money(12,2);
define TF02_Adeudos, TF02_Recargos, TF02_Multa, TF02_Gastos	Money(12,2);

--AUXILIARES DE PERIODOS
  define v_tipo_aseo						char(1);
  define v_num_contrato					integer;
  define v_concepto1, v_concepto2, v_concepto3, v_concepto		varchar(100);
  define v_cant1, v_cant2, v_cant3, v_ctrol_aseo                                            Integer;
  define v_importe1, v_importe2, v_importe3                                                  Money(12,2);
  define v_Periodo_CN, v_Periodo_EXE                                                        varchar(7);
--

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;  
  -- pedazo adicionado
  if p_Rep <> 'V' then
     Let v_Periodo_CN = p_Fecha_fin;
     Let v_Periodo_EXE = p_Fecha_fin;
  end if;

-- ADEUDOS
Let F02_cont_primer_adeudo = 0;
Let F02_Periodo = '';
Let F02_primer_adeudo = '';
Let F02_Concepto = '';
Let F02_Licencias = '';
Let F02_Documentos = '';
Let F02_Cant_Recolec = 0;

Let F02_Adeudos = 0;
Let F02_Recargos = 0;
Let F02_Multa = 0;
Let F02_Gastos = 0;

Let TF02_Adeudos = 0;
Let TF02_Recargos = 0;
Let TF02_Multa = 0;
Let TF02_Gastos = 0;


FOREACH

SELECT ctrol_aseo, descripcion, tipo_aseo INTO v_ctrol_aseo, v_concepto, v_tipo_aseo FROM ta_16_tipo_aseo order by ctrol_aseo
RETURN Null, 'TIPO DE ASEO  '|| v_concepto, null, null,        null, null, null,     null, null, null  with resume;
RETURN Null, Null, Null, Null, null, null, null, null, null, null  with resume;

	SELECT count(*) INTO v_cant1 FROM ta_16_contratos where ctrol_aseo = v_ctrol_aseo;
	RETURN Null, 'CONTRATOS  ', v_cant1, null,        null, null, null,     null, null, null  with resume;
	RETURN Null, Null, Null, Null, null, null, null, null, null, null  with resume;

	SELECT count(*) INTO v_cant2 FROM ta_16_contratos where ctrol_aseo = v_ctrol_aseo and status_vigencia = 'V';
	RETURN Null, 'VIGENTES ', v_cant2, null,        null, null, null,     null, null, null  with resume;
	RETURN Null, Null, Null, Null, null, null, null, null, null, null  with resume;

	FOREACH
	SELECT num_contrato INTO v_num_contrato FROM ta_16_contratos where ctrol_aseo = v_ctrol_aseo and status_vigencia = 'V'

		-- inicio

		-- ADEUDOS POR RECOLECCION
		FOREACH
			EXECUTE PROCEDURE sp16_Adeudos_F02 ( v_tipo_aseo, v_num_contrato, p_Rep, p_Fecha_fin )  
			INTO  F02_Periodo, F02_Concepto, F02_Cant_Recolec, F02_Adeudos, F02_Recargos, F02_Multa, F02_Gastos
	
		if F02_Concepto <> '' then
			if substr(F02_Concepto,1,8) = 'Licencia' then
				Let F02_Licencias = Trim(F02_Concepto);
			end if;
			if (F02_Multa <> 0) or (F02_Gastos <> 0) then
				Let F02_Documentos = Trim(F02_Concepto);
				Let TF02_Multa = TF02_Multa + F02_Multa;
				Let TF02_Gastos = TF02_Gastos + F02_Gastos;
			end if;
			if (F02_Adeudos <> 0) then
				Let TF02_Adeudos = TF02_Adeudos + F02_Adeudos;
				Let TF02_Recargos = TF02_Recargos + F02_Recargos;
				if F02_cont_primer_adeudo = 0 then
					Let F02_primer_adeudo = F02_Periodo;
					Let F02_cont_primer_adeudo = 1;
				end if;
			end if;
		end if;

		END FOREACH;
		Let F02_cont_primer_adeudo = 0;
		Let F02_Periodo = '';
		Let F02_primer_adeudo = '';
		Let F02_Concepto = '';
		Let F02_Licencias = '';
		Let F02_Documentos = '';
		Let F02_Cant_Recolec = 0;

		Let F02_Adeudos = 0;
		Let F02_Recargos = 0;
		Let F02_Multa = 0;
		Let F02_Gastos = 0;

		-- fin
	END FOREACH;
	RETURN Null, 'ADEUDOS TOTALES ', Null, ( TF02_Multa + TF02_Gastos + TF02_Adeudos + TF02_Recargos ),        
	null, null, null,     
	null, null, null  with resume;

	RETURN Null, Null, Null, Null, null, null, null, null, null, null  with resume;

	if TF02_Multa <> 0 then  
		RETURN Null, 'Adeudos por Multas', Null, TF02_Multa,        
		Null, Null, Null,     
		Null, Null, Null  with resume;  
	end if;
	if TF02_Gastos <> 0 then  
		RETURN Null, 'Adeudos por Gastos', Null, TF02_Gastos,        
		Null, Null, Null,     
		Null, Null, Null  with resume;  
	end if;
	if TF02_Adeudos <> 0 then  
		RETURN Null, 'Recoleccion Cuota Normal y Excedente', Null, TF02_Adeudos,        
		Null, Null, Null,     
		Null, Null, Null  with resume;  
	end if;
	if TF02_Recargos <> 0 then  
		RETURN Null, 'Recargos a Cuota Normal y Excedente', Null, TF02_Recargos,        
		Null, Null, Null,     
		Null, Null, Null  with resume;  
	end if;

	RETURN Null, Null, Null, Null, null, null, null, null, null, null  with resume;
	RETURN Null, Null, Null, Null, null, null, null, null, null, null  with resume;
	RETURN Null, Null, Null, Null, null, null, null, null, null, null  with resume;

	Let TF02_Adeudos = 0;
	Let TF02_Recargos = 0;
	Let TF02_Multa = 0;
	Let TF02_Gastos = 0;

END FOREACH;

end procedure;

CREATE PROCEDURE "informix".spd_abcreboskiosco(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parImporte 	money(15,2),
    		parCvepago 	char(1),
    		parId_modulo 	integer,
    		parId_regmodulo 	integer,
    		parId_rec_cta 	smallint,
    		parRegmunur	char(1),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta      	smallint, 
    		parAxohasta  	smallint,
    		parNombre 	varchar(60),   
    		parDomicilio 	varchar(60),   
    		parConcepto 	varchar(60),
    		parRfcini      	char(4),
    		parRfcnumero  	integer,
    		parRfccolonia     	integer,
		parObra                 integer,
		parAxofolio               integer,
    		parId_usuario	integer,
		parFecha_act 	datetime year to minute,
		parId_banco 	integer,
                                Partipo_che            smallint,
		parCheque	integer,
		parCuenta	char(30),
		parImpCheque	money(15,2),
		parOpc char(1),
                pardescripcion varchar(255), 
                parid_mov       integer
		)
		returning integer;

		define varOperacion integer;
  define varuap_rcm  integer;
  define varpar  smallint;
  define vgrupo integer;
  define vlugar_pago smallint;
--set debug file to "ivan.log";
--trace on;

--inicializa la variable correcto 0=no inserto por que ya se elaboro cheque de ese c/recibo ,1=inserto
let varOperacion = 0;
let vgrupo = 12;
--si la opcion fue insertar
if parId_modulo = 12 then
   if parId_regmodulo = 1 then
      let vgrupo = 1207; 
   end if;
   if parId_regmodulo = 2 then
      let vgrupo = 1207; 
   end if;
  if parId_regmodulo = 3 then
      let vgrupo = 12003; 
   end if ;
end if;

--select * from ta12_operacKiosco
	
	select nvl(operacion,0) + 1 , lugar_pago
		into varOperacion , vlugar_pago
		from ta12_operacKiosco
		where 	id_rec=parId_rec and
			caja=parCaja and
			id_usuario=parId_usuario  and tip_impresora = 'L';

	
 
	insert into ta_12_recibos (fecha,
    id_rec ,
    caja ,
    operacion ,
    importe,
    cvepago ,
    id_modulo,
    id_regmodulo,
    id_rec_cta,
    regmunur ,
    mesdesde,
    axodesde ,
    meshasta ,
    axohasta ,
    nombre ,
    domicilio ,
    concepto,
    rfcini ,
    rfcnumero,
    rfccolonia ,
    obra ,
    axofolio ,
    id_usuario ,
    fecha_act ,
    descripcion, lugar_pago,grupo, fec_pagobco, id_mov) values(
    		parFecha,
    		parId_rec,
    		parCaja,
    		varOperacion,
    		parImporte,
    		parCvepago,
    		parId_modulo,
    		parId_regmodulo,
    		parId_rec_cta,
    		parRegmunur,
    		parMesdesde,
    		parAxodesde,
    		parMeshasta,
    		parAxohasta,
    		parNombre,
    		parDomicilio,
    		parConcepto,
    		parRfcini,
    		parRfcnumero,
    		parRfccolonia,
		parObra,
		parAxofolio,
    		parId_usuario,
		current, 
                pardescripcion, vlugar_pago, vgrupo , parFecha , parid_mov );


	update	ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=parId_rec and
    		caja=parCaja and
    		id_usuario=parId_usuario and tip_impresora = 'L';
	


return varOperacion;
--trace off;

end procedure;

CREATE PROCEDURE "informix".nk_pago_91(
                ParReferencia varchar(35),
    		parnumDiv  int,
                parfecha  date,
                parImpCertificado money(15,2),
                parredondeo  money(3,2),
                parKiosco	integer,
                parformaPago    smallint,
                parNoTarjeta    varchar(20),
                parAutoriza     integer,
                ParIdTrans      integer,
                parnombre char(60),
                pardomicilio char(60),
                parcantidad   integer
        )
		returning smallint as reca , char(2) as  caja , integer as operacion , char(28) as linea , smallint as estatus , varchar(60) as mensaje;
--varrec, varcaja, spoperacion , v_linea28
define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define v_cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_orden int;
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);define v_importex  money(15,2) ;
define v_hora datetime hour to minute;
define  v_linea100 varchar(110);
define v_linea28 varchar(28);
define v_id int;
define v_contrato int;
define v_long int;
define v_contratost char(8);
define v_opcion int;
set debug file to "nkpago91.TXT";
trace on;
let v_opcion = 0;


if parcantidad = 0 then
   let parcantidad = 1;
end if;
   if parnombre = '' then
      return 0, '', 0 , '' , -1 , 'SE REQUIERE EL NOMBRE PARA EL REGISTRO';
   end if;
--  verificar contrato siapa
 if  parnumDiv = 3 then
    let v_long = length(trim(ParReferencia));
    let v_contratost = substring(ParReferencia from 35 for 8);
    let v_contrato = v_contratost *1;
      if (v_contrato > 10000000) and (v_contrato < 12000000) then
           let v_opcion = 0;
          else
           let v_opcion = 1;
      end if;
  end if;

 let parnombre = REPLACE(parnombre, '�?', '�');
--
if v_opcion = 1 then
       return 0, '', 0 , '' , -1 , 'NO TIENEN LA CANTIDAD DE SERVICIOS';
else
    select tramite , id_dependencia
    into v_concepto , v_id
    from ta00_tramites where numtramite = parnumDiv;
  -- select * from ta00_tramites
    select id_rec , caja  into varrec , varcaja from ta12_operacKiosco where id_usuario = parkiosco;

    execute procedure spd_abcreboskiosco(today ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 12, parnumDiv, 0, '',
              1, 0, 12, 0,  parNombre, pardomicilio,
           v_concepto, '',v_id,0,
                0,0,parkiosco,current,0,0,0,'',0,'I','', ParIdTrans )
 into spoperacion;



  let varoperacion = spoperacion;

   let linea = 1;
    let v_suma =0;
  let v_importex = 0;
  FOREACH
     select orden, cta_aplicacion, concepto , importe
     into  v_orden ,v_cuenta ,  v_concepto , v_importe
       from ta00_conceptocobro where numtramite = parnumDiv
         and kiosco = 'S' and vigente = 'V'
         order by orden
     if parnumDiv = 3 then
       let v_importe = parImpCertificado;
       let parcantidad = 1;
     end if;
  if parnumDiv = 4 then
       let v_importe = parImpCertificado;
       let parcantidad = 1;
    end if;
   let v_importex = v_importe * parcantidad;
   insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea ,
        v_concepto  ,   v_cuenta, v_importex );
       let linea = linea +1 ;
       let v_suma = v_suma + v_importex;
   end FOREACH;
   let v_redondeo = parImpCertificado - v_suma;
  if v_redondeo <> 0 then
   if (parImpCertificado - (v_suma)) > 0 then
       let v_cuenta = 55080000;
        else
       let v_cuenta = 55080000;
       end if;

   insert into ta_12_recibosdet values(today ,varrec , varcaja ,  varoperacion , linea ,
   'Ajuste ART. 4 de ley de ingresos ' , 55080000, v_redondeo );

  end if;
-- forma de pago con tarjeta
 if parNoTarjeta <> '' then

   insert into db_ingresos:ta_12_cheques (fecha , id_rec , caja , operacion , id_banco , cheque , cuenta , importe , tipo_pag )
   values( today, varrec, varcaja, varoperacion, 0 , parAutoriza, parNoTarjeta, parImpCertificado, parformaPago )  ;
  end if;

  execute PROCEDURE linea_capturadiv(varoperacion, parKiosco,parImpCertificado ,today ) into
    v_linea100, v_linea28;

  return varrec, varcaja, spoperacion , v_linea28 , 0 , 'OPERACION REALIZADA';
 end if;
trace off;
end procedure;

CREATE PROCEDURE "informix".kio_13_pago(
    		parcontrol    integer,
                parImpCertificado money(15,2),
    		parAxohasta  	smallint,
    		parKiosco	integer,
                parIdTransac    integer,
 -- valores para captar otros datos.   
                par_nombre varchar(60),
                par_domicilio varchar(60),
                par_correo    VARCHAR(30),
                par_telefono VARCHAR(18),
                parparentesco char(25),
-- valores si paga con tarjeta.
                parTarBanco   int, 
                partarconfir  int,
                partartarjeta varchar(30), 
                partartipo    int
        )
		returning smallint as reca, char(2) as caja, integer as operacion,
                char(28) as linea, int as estatus , char(50) as mensaje;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;

define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;

define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int; 
define v_concepto char(30); define v_redondeo money(3,2);
define v_concrecibo char(60);
define v_concelargo char(255);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_metros dec(5,3);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define v_totim money(15,2);
define v_totre money(15,2);
define v_totdi money(15,2);
define v_totdr money(15,2);
define xresu int;
define xmensa char(30);


define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_clase SMALLINT;
define  v_clase_alfa VARCHAR(10);
define  v_seccion SMALLINT;
define  v_seccion_alfa VARCHAR(10);
define  v_linea SMALLINT;
define  v_linea_alfa VARCHAR(20);
define  v_linea100 VARCHAR(100);
define  v_linea28 VARCHAR(28);
define  v_fosa SMALLINT;
define  v_fosa_alfa VARCHAR(20);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define v_axof int;
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_reg_cem varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_tipodesc VARCHAR(10);
define  v_nomcem VARCHAR(60);
define rlinea integer ;
define xcuenta integer;
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_axohasta    integer;
define  v_obs varchar(60);
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define vcvepago int;
define v_ctaaplic int;

let varcvepago = 0;
let v_mes=month(today);

--set debug file to "kio13pago.log";
--trace on;
 if parAxohasta = 0 then
    let parAxohasta = year(today);
 end if;

 -- Leer datos del Cementerio
   select control_rcm, cementerio, cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
          clase, clase_alfa,seccion, seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
          ,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,metros,
        case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
   end
   into v_control, v_cementerio, v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
   ,v_axo_pagado,v_metros,v_nombre,v_ubicacion, v_colonia ,vpar_metros,v_tipodesc
   from ta_13_datosrcm where control_rcm=parcontrol;
---Para calcular el importe total
select  nombre  into v_nomcem from tc_13_cementerios where cementerio = v_cementerio;
select max(axo_adeudo) into v_axohasta from ta_13_adeudosrcm where control_rcm = v_control and vigencia = 'V';

    if parAxohasta < v_axohasta then
       let v_axohasta = paraxohasta;
    end if;
 
    if (v_axo_pagado + 1) < (year(today) - 5) then
        let v_axodesde =(year(today) - 5);
    else
        let v_axodesde = v_axo_pagado + 1;
    end if;

let v_imptot = 0;
let v_desctot  = 0;
let  v_totim=0;
let  v_totre=0;
let  v_totdi=0;
let  v_totdr=0;
foreach 
select b.axo_adeudo,nvl(b.importe,0),nvl(b.importe_recargos,0),d.axo_descto,nvl(d.descuento,0),nvl(b.descto_impote,0), 
           nvl(b.descto_recargos,0)
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d
           where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axohasta
           order by 1
    let v_obs='.';
    let v_desctot = 0;
    let v_desctotre = 0;
    if  v_impdesc>0 then
           let v_obs='Desc Pensionado 50%';
    end if;
     --se aplica descuento de pesionado
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
     if  v_impdesc=0 then
           let v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
           let v_obs=v_obs||' Incluye 10% Desc por pronto pago ';
     end if;
     end if;
     let v_desctot  =  v_impdesc;
     let v_desctotre  =   v_recardesc;
     let v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) ; 
     let v_totim = (v_totim + vpar_impte); 
     let v_totre = (v_totre + vpar_recar); 
     let v_totdi = (v_totdi + v_desctot); 
     let v_totdr = (v_totdr + v_desctotre); 


end foreach;
if v_totim > 0 then

let v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || v_axohasta;
let v_concrecibo = 'MANT. CEMENTERIO '|| v_nomcem || ' PERIODO '||  v_axodesde || ' - ' || v_axohasta || ' DE ' ||v_reg_cem ;
let v_concelargo = 'MANT. CEMENTERIO '|| v_nomcem || ' PERIODO '||  v_axodesde || ' - ' || v_axohasta || ' DE ' || v_metros || ' MTS. ';
let v_concelargo = trim(v_concelargo) || ' DE '|| v_clase ||' CLASE ' || v_clase_alfa || ' SECC. '|| v_seccion || ' ' || v_seccion_alfa || 'LINEA ' ||v_linea || ' ' || v_linea_alfa || ' FOSA ' || v_fosa;

--
  select id_rec , caja  into varrec , varcaja
  
  from ta12_operacKiosco
  where id_usuario = parKiosco; 
  
  select nvl(operacion,0) + 1
		into varOperacion 
		from ta12_operacKiosco
		where 	id_rec=varrec and
			caja=varCaja and
			id_usuario=parKiosco;

  
--  id_regmodulo INT,    id_rec_cta SMALLINT,    regmunur CHAR(1),    mesdesde SMALLINT,    axodesde SMALLINT,
--  meshasta SMALLINT,    axohasta SMALLINT,    nombre VARCHAR(60),    domicilio VARCHAR(60),    concepto VARCHAR(60),
--  rfcini CHAR(3),    rfcnumero INT,    rfccolonia SMALLINT,       axofolio INT,    id_usuario INT not null,
--  fecha_act ,  descripcion VARCHAR(255), lugar_pago INT default 0, kio_trans INT default 0, kio_num_terceros VARCHAR(30),
  
    insert into ta_12_recibos (fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, id_regmodulo ,id_rec_cta , mesdesde  ,
         axodesde, meshasta, axohasta, nombre,domicilio, concepto ,rfcini,rfcnumero,rfccolonia, axofolio ,
          id_usuario ,  fecha_act, descripcion , fec_pagobco, id_mov) 
         values( today, varrec, varCaja, varOperacion, parImpCertificado,'P', 13,v_control,0,1,
      v_axodesde, 12,v_axohasta , v_nombre, v_ubicacion,  v_concrecibo,'ID',v_control , 0,0   ,
      parKiosco, current, v_concelargo , today, parIdTransac);

   
	update	ta12_operacKiosco set operacion= varOperacion
		where id_rec=varrec and caja=varCaja and id_usuario=parKiosco;
	

execute PROCEDURE linea_capturadiv(varoperacion, parKiosco, parImpCertificado ,today ) into
 v_linea100, v_linea28;
  if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today, varrec, varCaja, varOperacion , parTarBanco  ,
    partarconfir ,  partartarjeta, parImpCertificado,  partartipo, "");
  end if;
 let rlinea = 1;     
let v_suma =0;

FOREACH
execute procedure  kio13_total( parcontrol , parAxohasta) 
    into v_ob, v_idtrans , v_importe  , v_ctaaplic ,  v_concepto 
if v_ob = 'D' then 
    insert into ta_12_recibosdet
          (fecha ,id_rec , caja   , operacion   ,linea ,descripcion , cuenta  ,importe )
    values(today ,varrec ,varcaja ,varoperacion ,rlinea ,v_concepto  ,v_ctaaplic ,v_importe );
 
  end if;
       let rlinea = rlinea +1 ;

if v_ob = 'T' then 
   let v_suma = v_importe;
end if;
end FOREACH;
--Cementerio Actualizar pago
  let us = 'Kiosco ' || parkiosco;
let v_axof=0;

   SELECT axofin
   into  v_axof
   FROM ta_13_descrec where id_folio =parcontrol and vigencia='V';

  INSERT INTO ta_13_pagosrcm  VALUES(today, varrec, varCaja, varOperacion, 0, v_control,
              v_cementerio, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, v_fosa, v_fosa_alfa,
              v_axodesde, v_axohasta, (v_totim - v_totdi), (v_totre-v_totdr), 'A', parKiosco, today);

         --     v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa

   let vcvepago=dbinfo("sqlca.sqlerrd1");

   update ta_13_adeudosrcm set  vigencia='P', id_pago=vcvepago
     where control_rcm=v_control and axo_adeudo between v_axodesde and v_axohasta and vigencia='V';

 if v_axohasta>=v_axof then
    update ta_13_descrec
     set vigencia='P', fec_pag=today, id_rec=varrec, caja=varCaja, operac=varOperacion
    where id_folio =v_control and vigencia='V';
   end if;

    
    update ta_13_datosrcm set axo_pagado=v_axohasta where control_rcm=v_control;
 
    update ta_13_descpens set vigencia='P' where control_rcm=v_control and axo_descto between v_axodesde and v_axohasta and vigencia='V';
   execute procedure spd_13_insextra(v_control, par_nombre , par_domicilio ,par_correo,
                   par_telefono , parparentesco) into xresu , xmensa;

   
return varrec, varcaja, varOperacion , v_linea28,0,'PAGO EFECTUADO';
else
return 0,'', 0 , '',-1,'NO TIENE ADEUDO PARA ESTE PERIODO';
end if;
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".sp_multa_destomulta ( par_id_modulo int, p_Control Int, p_Axo Int, p_Mes Int, p_importe Money )
{######################################################################
#  Procedimiento:    sp_multa_DestoMulta
#  Descripcion:      Interfaz de consulta de porcentaje de Multa
#  Parametros de entrada:	
#		par_Id_Modulo	= modulo de origen
#		p_Control		= id de control del registro
#		p_Axo			= A�o de periodo de consulta
#       p_Mes			= Mes de periodo de consulta
#		p_importe		= Importe del adeudo
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento vencidos dentro de 
#  Llama a:          
#  
######################################################################}
RETURNING	int as descuento,
			money(12,2) as Multa,
			money(12,2) as DsctoMulta,
			varchar(255) as mensaje;

define v_rcgo_adic				char(1);
define v_porc_adic				int;			
define v_porcdescto				int;
define v_Multa, v_DsctoMulta			money(12,2);
define v_mensaje				varchar(255);

Let v_porc_adic = '';
Let v_porc_adic = 0;
Let v_porcdescto = 0;
Let v_Multa = 0;
Let v_DsctoMulta = 0;
Let v_mensaje = '';

--adicionado/modificado para aplicar importes normal de requerimientos o no
SELECT aplica, porc INTO v_rcgo_adic, v_porc_adic FROM ta_aplicareq;
if v_rcgo_adic = 'S' then
	Let v_Multa = 0;
	Let v_DsctoMulta = 0;
else
	Let v_Multa = ( p_importe * v_porc_adic ) / 100;
	--execute PROCEDURE sp16_descto_multaadeudo ( 'O', par_id_modulo, p_Control, p_Axo, p_Mes, 0, 0, 0, 'pgmoreno', 1, 1 ) 
	--INTO v_porcdescto, v_mensaje;
	if v_porcdescto > 0 then
		Let v_DsctoMulta = ( v_Multa * v_porcdescto ) / 100;
		Let v_DsctoMulta = v_DsctoMulta * -1;
	end if;
end if;

RETURN v_porcdescto, v_Multa, v_DsctoMulta, v_mensaje;

end procedure;

CREATE PROCEDURE "pgmoreno".admin_adeudos_detalle_18x ( p_tipo char(1), p_numero int, pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_18
#  Descripcion:      Interfaz de consulta de detalle para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros	p_tipo		= tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:  p_numero   	= Numero de Contrato
#               pref   		= Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning	Integer as Rubro,
			Integer as Concepto,
            Integer as Cuenta_Aplicacion,
            VarChar(30) as Referencia,
            VarChar(120) as Descripcion,
            Money(12,2) as Monto,
            Money(12,2) as Acumulado;
               
define v_control_contrato, v_ctrol_operacion, v_id_control_req								Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas    Money(12,2);
define v_porcentaje_multa                                                                   Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           	Money(12,2);
define v_aso_mes_pago                                                                       Date;
define v_Axo, v_Mes                                                                         Integer;
define v_mensaje_proc                                                                       varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                          varchar(7);
define v_contador                                                                           Smallint;
define  v_ref     																			char(7);

--adicionado/modificado para aplicar importes normal de requerimientos o no
define v_porc_adic																			integer;
define v_rcgo_adic, v_ctas_odoo_adic														char(1);
define v_porc_dscto																			integer;
define v_Importe_Multa_A, v_Importe_DsctoMulta_A											Money(12,2);
define v_Importe_Multa_Acum, v_Importe_DsctoMulta_Acum										Money(12,2);
define v_mensaje																			varchar(255);
define v_cuenta_resulta																		integer;

define v_importe_gral, v_importe_porciento													Money(12,2);	-- adicionado para el recargo adicional del 20%

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

begin
    on exception in (-958)
		delete from tmp_totalaseo;
    end exception;
create temp table tmp_totalaseo(
	rubro int,
	concepto int,
	cuenta int,
	referencia varchar(30),
	descripcion varchar(120),
	monto money(14,2),
	acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
		delete from tmp_detalleaseo;
    end exception;
create temp table tmp_detalleaseo(
	control_contrato int,
	aso_mes_pago char(7),
	ctrol_operacion int,
	tipo_movto char(1) ) with no log;
end;

if trim(pref)='' then
   let v_ref=9999 || '-' || 12;
else
   let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;

let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
	SELECT a.control_contrato  INTO  v_control_contrato   FROM ta_16_contratos a, ta_16_tipo_aseo b
    WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

    -- VARIABLES A 0
    Let v_tot_multas = 0;
    Let v_porcentaje_multa = 0;
    Let v_tot_dscto_multas = 0;

    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_tot_gastos = 0;
    Let v_acumulado = 0;
    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    Let v_contador = 0;

    -- APREMIOS
    Let v_id_control_req = 0;
    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_Axo = 0;
    Let v_Mes = 0; 

    --adicionado/modificado para aplicar importes normal de requerimientos o no
	Let v_porc_dscto = 0;
	Let v_Importe_Multa_A = 0;
	Let v_Importe_DsctoMulta_A = 0;
	Let v_Importe_Multa_Acum = 0;
	Let v_Importe_DsctoMulta_Acum = 0;
	
	Let v_rcgo_adic = '';
	Let v_ctas_odoo_adic = '';
	Let v_porc_adic = 0;	

	--adicionado/modificado para aplicar importes normal de requerimientos o no
	SELECT aplica, porc, ctas_odoo INTO v_rcgo_adic, v_porc_adic, v_ctas_odoo_adic FROM ta_aplicareq;
	
    FOREACH
    SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
    INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
    FROM ta_15_apremios
    WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
    Order By id_control
	
		--adicionado/modificado para aplicar importes normal de requerimientos o no
		if v_rcgo_adic = 'S' then
			Let v_tot_multas = v_importe_multa;
			if v_porcentaje_multa < 100 then
			                Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
			                Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
			else
			                Let v_tot_dscto_multas = 0;
			end if;
			Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		else
			Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
		end if;

    insert into tmp_detalleaseo values ( v_id_control_req, v_ref, 0, 'R' );
    END FOREACH;
    -- TERMINA APREMIOS

    -- INICIAN PERIODOS
    FOREACH
    SELECT  aso_mes_pago,  Year(aso_mes_pago), Month(aso_mes_pago), importe, ctrol_operacion 
    INTO     v_aso_mes_pago, v_Axo, v_Mes, v_importe, v_ctrol_operacion
    FROM ta_16_pagos 
    WHERE Control_Contrato = v_control_contrato  
    and aso_mes_pago <= v_ref
    AND status_vigencia = 'V'  Order By aso_mes_pago, ctrol_operacion

    insert into tmp_detalleaseo values ( v_control_contrato, v_Axo || '-' || v_Mes, v_ctrol_operacion, 'A' );

    if v_importe > 0 then

		--adicionado/modificado para aplicar importes normal de requerimientos o no
	Let v_porc_dscto = 0;
	Let v_Importe_Multa_A = 0;
	Let v_Importe_DsctoMulta_A = 0;
	Let v_mensaje = '';

		--adicionado/modificado para aplicar importes normal de requerimientos o no
		EXECUTE PROCEDURE sp_multa_DestoMulta ( 16, v_control_contrato, v_Axo, v_Mes, v_importe ) 
		INTO v_porc_dscto, v_Importe_Multa_A, v_Importe_DsctoMulta_A, v_mensaje;
		Let v_Importe_Multa_Acum = v_Importe_Multa_Acum + v_Importe_Multa_A;
		Let v_Importe_DsctoMulta_Acum = v_Importe_DsctoMulta_Acum + v_Importe_DsctoMulta_A;
			
        if v_contador = 0 then
			--adicionado/modificado para aplicar importes normal de requerimientos o no
			if v_rcgo_adic = 'S' then
				if v_tot_multas > 0 then
					Let v_acumulado = v_acumulado + v_tot_multas;
					Let v_cuenta_resulta = 515002003;
					--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 515002003 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 515002003; end if; -- cta ODOO
					RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado	with resume;
					insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado );
				end if;
			
				if v_tot_dscto_multas <> 0 then
					Let v_acumulado = v_acumulado + v_tot_dscto_multas;
					Let v_cuenta_resulta = 515042003;
					--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 515042003 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 515042003; end if; -- cta ODOO
					RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado	with resume;
					insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado );
				end if;
			end if;
			
            if v_tot_gastos > 0 then
				Let v_acumulado = v_acumulado + v_tot_gastos;
				Let v_cuenta_resulta = 992104009;
				--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 992104009 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 992104009; end if; -- cta ODOO
				RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado	with resume;
				insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
            end if;
        end if;

        if v_ctrol_operacion = 6 then
			if Year(v_aso_mes_pago) < Year(Current) then
				Let v_acumulado = v_acumulado + v_importe;
				Let v_cuenta_resulta = 250130000;
				--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 250130000 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 250130000; end if; -- cta ODOO
                RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Rezago del Adeudo ', v_importe, v_acumulado	with resume;
                insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Rezago del Adeudo ', v_importe, v_acumulado );
            else
				Let v_acumulado = v_acumulado + v_importe;
				Let v_cuenta_resulta = 250100000;
				--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 250100000 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 250100000; end if; -- cta ODOO
                RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Actual de Adeudo ', v_importe, v_acumulado	with resume;
                insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Actual de Adeudo ', v_importe, v_acumulado );
            end if;
            
			SELECT sum(porc_recargo)   INTO v_Importe_recargo
			FROM ta_16_recargos 
            WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);
        else
            if Year(v_aso_mes_pago) < Year(Current) then
				Let v_acumulado = v_acumulado + v_importe;
				Let v_cuenta_resulta = 250230000;
				--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 250230000 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 250230000; end if; -- cta ODOO
                RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Rezago Excedente ', v_importe, v_acumulado	with resume;
                insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Rezago Excedente ', v_importe, v_acumulado );
            else
				Let v_acumulado = v_acumulado + v_importe;
				Let v_cuenta_resulta = 250200000;
				--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 250200000 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 250200000; end if; -- cta ODOO
                RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Actual Excedente ', v_importe, v_acumulado	with resume;
                insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Actual Excedente ', v_importe, v_acumulado );
            end if;
            
			SELECT sum(porc_recargo)   INTO v_Importe_recargo
            FROM ta_16_recargos 
            WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);
        end if;
        
		if v_Importe_recargo <> 0 then
			Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
            Let v_acumulado = v_acumulado + v_importe_rec1;
			Let v_cuenta_resulta = 390200000;
			--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 390200000 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 390200000; end if; -- cta ODOO
            RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado	with resume;
            insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado );
            EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
            INTO v_importe_rec2, v_mensaje_proc;
        end if;
        
		if v_importe_rec2 > 0 then
			Let v_importe_rec2 = v_importe_rec2 * -1;
            Let v_acumulado = v_acumulado + v_importe_rec2;
			Let v_cuenta_resulta = 390240000;
			--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 390240000 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 390240000; end if; -- cta ODOO
            RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado	with resume;
            insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado );
		end if;
        
		Let v_contador = 1;
    end if;

        Let v_importe = 0;
        Let v_Importe_recargo = 0;
        Let v_importe_rec1 = 0;
        Let v_importe_rec2 = 0;
    END FOREACH;
    -- TERMINAN PERIODOS

    if v_contador = 0 then
		--adicionado/modificado para aplicar importes normal de requerimientos o no
		if v_rcgo_adic = 'S' then
			if v_tot_multas > 0 then
				Let v_acumulado = v_acumulado + v_tot_multas;
				Let v_cuenta_resulta = 515002003;
				--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 515002003 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 515002003; end if; -- cta ODOO
				RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado	with resume;
				insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado );
			end if;
			
			if v_tot_dscto_multas <> 0 then
				Let v_acumulado = v_acumulado + v_tot_dscto_multas;
				Let v_cuenta_resulta = 515042003;
				--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 515042003 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 515042003; end if; -- cta ODOO
				RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado	with resume;
				insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado );
			end if;
		end if;
		
        if v_tot_gastos > 0 then
			Let v_acumulado = v_acumulado + v_tot_gastos;
			Let v_cuenta_resulta = 992104009;
			--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 992104009 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 992104009; end if; -- cta ODOO
            RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado	with resume;
            insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
        end if;
    end if;

	--adicionado/modificado para aplicar importes normal de requerimientos o no
	if v_rcgo_adic = 'N' then
		Let v_acumulado = v_acumulado + v_Importe_Multa_Acum;
		Let v_acumulado = v_acumulado + v_Importe_DsctoMulta_Acum;
		Let v_cuenta_resulta = 515002003;
		--if v_ctas_odoo_adic = 'S' then  execute function fn_cuenta_odoo ( 515002003 ) into v_cuenta_resulta;  else  Let v_cuenta_resulta = 515002003; end if; -- cta ODOO
		RETURN 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Multas ', v_Importe_Multa_Acum + v_Importe_DsctoMulta_Acum, v_acumulado	with resume;
		insert into tmp_totalaseo values ( 0,0, v_cuenta_resulta, v_Axo || '/' || v_Mes, 'Multas ', v_Importe_Multa_Acum + v_Importe_DsctoMulta_Acum, v_acumulado );
	end if;
end if;

end procedure;

CREATE PROCEDURE "informix".ws_encabezados_13(p_cementerio char(1), p_clase smallint, p_seccion smallint ,p_linea smallint ,
                                  p_fosa smallint )
               returning
               int         as control_rcm,
               varchar(92) as NombreCompleto,
               varchar(80) as calle,
               varchar(10) as NoExt,
               VARCHAR(10) as Int,
               VARCHAR(50) as colonia,
               VARCHAR(010)as observaciones,
               VARCHAR(30) as tipo,
               decimal(6,3) as metros,
               int         as axo_pagado ,
               char(1)     as cementerio  ,
               smallint    as clase,
               varchar(20)  as clase_alfa,
               smallint     as seccion,
               varchar(20) as seccion_alfa,
               smallint    as linea,
               varchar(20)  as linea_alfa,
               int          as fosa,
               varchar(20)  as fosa_alta,
               varchar(60)  as estatus ;


define v_control    integer;
define  v_axo    integer;
define  v_mes   smallint;
define  v_axo_pagado INTEGER;
define  v_nombre VARCHAR(60) ;
define  v_colonia VARCHAR(30);
define  v_vigencia CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_exte      VARCHAR(10);
define  v_inte      VARCHAR(10);
define  v_observaciones  varchar(100);
define  v_tipo  char(1);
define  v_metros decimal(6,3);
define  v_cementerio char(1);
define  v_clase smallint;
define  v_clase_alfa varchar(20);
define  v_seccion smallint;
define  v_seccion_alfa  varchar(20);
define  v_linea  smallint;
define  v_linea_alfa varchar(20);
define  v_fosa int;
define  v_fosa_alfa  varchar(20);

let v_axo=year(today);
let v_mes=month(today);


if not exists(select * from ta_13_datosrcm where cementerio=p_cementerio and clase = p_clase and seccion = p_seccion and linea = p_linea and fosa = p_fosa) then
   return 0, ' ',' ',' ' ,' ' ,' ',' ',' ', 0.0 , 0 , p_cementerio, p_clase, ' ' ,p_seccion , '', p_linea, '', p_fosa ,'' ,' No Existe';
end if;
 foreach  select control_rcm ,  Nombre,  domicilio,  exterior, Interior,colonia, observaciones,
 tipo, metros,axo_pagado , cementerio  , clase, clase_alfa,seccion, seccion_alfa, linea,
 linea_alfa, fosa, fosa_alfa,  vigencia
 into
 v_control ,  v_nombre,  v_domcompleto,  v_exte, v_inte, v_colonia, v_observaciones,
 v_tipo, v_metros, v_axo_pagado , v_cementerio  , v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea,
 v_linea_alfa, v_fosa, v_fosa_alfa,  v_vigencia
 from ta_13_datosrcm where cementerio=p_cementerio and clase = p_clase and seccion = p_seccion and linea = p_linea and fosa = p_fosa

--if v_axo_pagado = v_axo  then
--   return v_control , v_nombre, v_domcompleto,v_exte, v_inte, v_colonia,v_observaciones, v_tipo , v_metros, v_axo_pagado ,
--  p_cementerio, p_clase, v_clase_alfa ,p_seccion , v_seccion_alfa, p_linea, v_linea_alfa, p_fosa ,v_fosa_alfa ,'Al corriente de pagos' with resume;
--end if;
if v_vigencia='B'  then
   return v_control , v_nombre, v_domcompleto,v_exte, v_inte, v_colonia,v_observaciones, v_tipo , v_metros, v_axo_pagado ,
  p_cementerio, p_clase, v_clase_alfa ,p_seccion , v_seccion_alfa, p_linea, v_linea_alfa, p_fosa ,v_fosa_alfa  ,'BAJA' with resume;
else


EXECUTE PROCEDURE spd_13_recargos(v_control, v_mes);

return v_control , v_nombre, v_domcompleto,v_exte, v_inte, v_colonia,v_observaciones, v_tipo , v_metros, v_axo_pagado ,
  p_cementerio, p_clase, v_clase_alfa ,p_seccion , v_seccion_alfa, p_linea, v_linea_alfa, p_fosa ,v_fosa_alfa ,'VIGENTE'  with resume;
end if;
end foreach;

end procedure;

CREATE PROCEDURE "informix".spd_santgl_20hrs( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;
define v_cvekiosco integer;

   foreach
select  a.cvecuenta , k.fecha ,  k.importe ,  a.bim_ini  ,   a.axo_ini  ,  a.bim_fin  ,  a.axo_fin  ,   a.id_transaccion , k.cvekiosco
into v_cvecuenta , v_fecha ,  v_importe ,  v_bim_ini  ,   v_axo_ini  ,  v_bim_fin  ,  v_axo_fin  ,   v_id_transaccion , v_cvekiosco
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal = '@SANTGL' and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null

execute procedure db_ingresos:spd_pagpredkioSANTGL( v_cvecuenta, v_fecha,  v_importe, v_bim_ini, v_axo_ini, v_bim_fin , v_axo_fin , v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;

 update catastro_gdl:k_pagos k set fec_afec = today where cvekiosco = v_cvekiosco and fec_afec is null;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkiosantgl(
    		parcvecuenta    integer,
                parfechaPAgo    date ,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint,
    		parAxohasta  	smallint,
    		
                parIdTransKio   integer
        )
		returning smallint , char(2), integer, char(28), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int;
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int;
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define pg_recaud int;
define pg_caja char(2);
define pg_folio int;
define pg_fecha date ;
define pg_cvecuenta int;
define parcvekiosco int;
define parsucursal  varchar(30);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;

   if varcvepago > 0 then
      select recaud , caja , folio , fecha , cvecuenta into
             pg_recaud , pg_caja , pg_folio , pg_cvecuenta
      from catastro_gdl:pagos where cvepago = varcvepago ;

       update db_ingresos:ta_12_recibos set cvepago = 'C'
       where fecha = pg_fecha and id_rec = pg_recaud and caja =  pg_caja and operacion = pg_folio and id_modulo = 5
        and rfcnumero = pg_cvecuenta and cvepago = 'P';
       insert into catastro_gdl:pagoscan values(0,varcvepago , 'bmxws' ,parfechaPAgo);
    end if;
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
 --set debug file to "pago13";
 --trace on;
 
 select  a.cvecuenta, k.fecha, k.importe, a.bim_ini, a.axo_ini, a.bim_fin, a.axo_fin,  k.cvekiosco, a.sucursal
 into parcvecuenta , parfechaPAgo , parImpCertificado , parMesdesde , parAxodesde, parMeshasta , parAxohasta , parcvekiosco , parsucursal
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where id_transaccion = parIdTransKio and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null ;
 
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;


 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo ,
   trim(nvl(a.c_calle,'')) || ' # Ext ' || trim(nvl(a.c_noexterior, '')) || ' # Int ' || trim(nvl(a.c_interior,'')),
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,'')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,''))
   || '@CVECATASTRAL ' || nvl(CVECATNVA,'') || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip   , v_hora
 from catastro_gdl:datos_gralKio a
 where a.cvecuenta = parcvecuenta;


  select id_rec , caja  into varrec , varcaja

  from ta12_operacKiosco
  where id_usuario = 562;
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(parfechaPAgo ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago de Predial en SANTANDER ventanilla de ' || parcvecuenta , '',parcvecuenta,0,
                0,0,562,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = '@SANTGL' ;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, parfechaPAgo, v_hora ,
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1");
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)

let linea = 1;
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
--execute procedure  catastro_gdl:kiosco_totalespred_nvo( parcvecuenta , parAxohasta, parMeshasta, 1)
execute procedure  catastro_gdl:internet_totalespred( parIdTransKio)
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans
if v_ob = 'D' then
     if v_cuenta <> 550800000   then
  insert into ta_12_recibosdet
        ( fecha       , id_rec , caja    , operacion     , linea , descripcion , cuenta    , importe )
  values( parfechaPAgo, varrec , varcaja ,  varoperacion , linea ,  v_concepto ,   v_cuenta, v_importe );
     end if;
     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea + 1 ;
 end if;
if v_ob = 'T' then
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
  select sum(multa) , sum(multavir) into v_mulpag , v_multasvir  from catastro_gdl:k_detsaldos_nvo where cvekiosco = parcvekiosco;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq)
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
-- insertar la detalle de lugar de pago en este caso los datos del siapa. select * from catastro_gdl:banamex
 --select * from catastro_gdl:k_pagos where llave = 525535
    insert into catastro_gdl:banamex(cvepago,cvecuenta,recaud,folio ,caja,operacion,fecha,fechapago,
       importe,importepago, tipopago, fecarga)
     values (varcvepago,parcvecuenta, 1 , varoperacion , '23', varoperacion, today,
              parfechaPAgo, parImpCertificado, parImpCertificado,5,parfechaPAgo);

if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor ,
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

--select * from liga_linea_trans where id_transaccion =  parIdTransKio;
select a.linea into v_lineacapt2 from catastro_gdl:linea_capturapred a, catastro_gdl:liga_linea_trans t
where  t.id_transaccion = parIdTransKio and t.refer_id = a.id;

--select * from catastro_gdl:linea_capturapred
--select * from catastro_gdl:liga_linea_trans

    execute  PROCEDURE linea_pagok(v_lineacapt2, 172, parImpCertificado, 'K',varcvepago,
             parfechaPAgo, varrec , varcaja, varoperacion, '@SANTGL') into  estatus ,mensaje ;
	-- COMMIT WORK;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago;
--trace off;
end procedure;

create procedure "informix".admin_adeudos_detalle_23odoo ( p_opc int , pnumesta int, p_axof int , p_mesf int  )

returning
-- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
    int as rubro ,int as concepto ,int as cta  , varchar(30) as referencia,  varChar(120) as descripcion,
    decimal(12,2) as monto ,decimal(12,2) as acumulado;
 
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
define p_pubid int;
define agrupar char(6);
define v_tipo int;
define no_recargos int;
define v_porc_recgos decimal(5,2);define v_descto_recgos money(15,2);

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019

 begin
    on exception in (-958)
       delete from tmp_exclusivos;
    end exception;
    create temp table tmp_exclusivos(
      orden  smallint,
      id_exc  int ,
      axo int,
      mes int,
      imp_pagar  money(12,2) ,
      cta_aplicacion int,
      referencia varchar(30),
      concepto   varChar(120)
     ) with no log;
  end;


let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--set debug file to 'Exclusivo.log';
--trace on;

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

select id into p_pubid from ex_contrato where no_exclusivo = pnumesta;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
        let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+ mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
let no_recargos = 0;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;
SELECT axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio  FROM ta_contratos_status WHERE modulo = 1 AND id = p_pubid AND estado = 'S'; -- 1=Exclusivo, 2=P�blico
if v_mes_inicio = 1 then
Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;
if perio_susp < perio then
Let perio = perio_susp;
end if;

FOREACH
select b.cuentaapl, b.tipo , a.axo , a.mes ,(axo  * 100 )+ mes ,  a.concepto ,  a.ade_importe
into v_cuentaapl , v_tipochar, v_axo , v_mes , perioi , v_concepto , v_adeudo
from ex_adeudo a, pubtipoadeudo b
where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
and a.tipo <> 20 and a.tipo = b.tipo_id  
order by a.axo , a.mes
 
if v_cuentaapl = 370700001 then
let no_recargos = 1;
end if;
let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
let v_acumulado = v_acumulado + v_adeudo;
    insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto )
                       values(1, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl , v_referencia , v_concepto );
--return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    if  v_cuentaapl = 370710002 then
-- calcula recargos de refrendo
        execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes ) into v_recargos;
-- porcentaje de descuento
        -- calcula recargos de refrendo
        select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between
        ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
        let v_descto_recgos = 0;
        if v_porc_recgos is null then
let v_porc_recgos = 0;
end if;
        if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
            let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
end if;
        if v_recargos > 0 then
let v_acumulado = v_acumulado + v_recargos;
            let v_concepto1 = 'Recargos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                     values(1, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
--   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
        end if;
if v_descto_recgos <> 0 then
let v_acumulado = v_acumulado + v_descto_recgos;
            let v_concepto1 = 'Descto Recgos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(1, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
        end if;
end if;
END FOREACH;
--
FOREACH
select  axo || lpad(mes,2,'0')  , tipo , Axo, mes, (axo  * 100 )+ mes ,concepto, ade_importe
into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
from ex_adeudo where ex_contrato_id = p_pubid and  tipo = 20 and  (axo * 100 + mes) <= perio
order by 1,3,4

select porcentaje into v_porc_recgos from ex_descrec
where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
let v_descto_recgos = 0;
if v_porc_recgos is null then
let v_porc_recgos = 0;
end if;
let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');

if v_tipo = 20 then
select sum(porcentaje_mes) into v_porcentaje from recargos
where (axo * 100 + mes) between  perioI and per_recgos;
     
let v_recargos = (v_porcentaje * v_adeudo ) / 100;
if v_recargos is null then
let v_recargos = 0;
end if;
        if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
--    let v_recargos =   v_recargos - v_descto_recgos;
end if;
   
let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
else
let v_recargos = 0;
let v_concepto = v_concepto1 || '  ' || v_adeudo;
end if;

--  totales
    if v_axo = year(today) then
let v_cuota = v_cuota + v_adeudo;
let v_rectot = v_rectot + v_recargos;
if v_adeudo > 0 then
let v_acumulado = v_acumulado + v_adeudo;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto )
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364100000, v_referencia , v_concepto);
--      return 0 ,0 , 364100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
end if;
if no_recargos = 1 then
let v_recargos = 0;
            let v_descto_recgos = 0;
        end if;
 
if v_recargos > 0 then
let v_acumulado = v_acumulado + v_recargos;
let v_concepto1 = 'Recargos ' || v_concepto;
     
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(3, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
--   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
end if;
if v_descto_recgos <> 0 then
let v_acumulado = v_acumulado + v_descto_recgos;
let v_concepto1 = 'Descto Recgos ' || v_concepto;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
end if;
    else
let v_cuota_r = v_cuota_r + v_adeudo;
let v_rectot_r = v_rectot_r + v_recargos;
if v_adeudo > 0 then
let v_acumulado = v_acumulado + v_adeudo;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364130000, v_referencia , v_concepto);
--   return 0 ,0 , 364130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
end if;
if no_recargos = 1 then
let v_recargos = 0;
            let v_descto_recgos = 0;
end if;
if v_recargos > 0 then
let v_acumulado = v_acumulado + v_recargos;
let v_concepto1 = 'Recargos ' || v_concepto;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(3, p_pubid, v_axo ,v_mes, v_recargos, 390700000, v_referencia , v_concepto1);
--    return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
end if;
if v_descto_recgos <> 0 then
let v_acumulado = v_acumulado + v_descto_recgos;
let v_concepto1 = 'Descto Recgos ' || v_concepto;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1);
--  return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
end if;
end if;

END FOREACH;

let v_acumulado = 0 ;
FOREACH
select cta_aplicacion , referencia , concepto , imp_pagar
into v_cuentaapl, v_referencia , v_concepto , v_cuota
from tmp_exclusivos order by axo , mes, orden

let v_acumulado = v_acumulado + v_cuota;
return 0 , v_cuentaapl, get_odoo_cta(  v_cuentaapl  ,23), v_referencia , v_concepto, v_cuota, v_acumulado  with resume;
END FOREACH;

--trace off;
end procedure;

create function "informix".get_odoo_cta(i_cta int , i_interface smallint) 
returning  int as cta_odoo;
define o_cta_odoo int;
select cta_odoo into o_cta_odoo from db_ingresos:ta_12_ctas_odoo where axo = year(today) and cta_aplic = i_cta and interface = i_interface;
return o_cta_odoo;
end function;

create function "informix".get_odoo_cta22(i_cta int ) 
returning  int as cta_odoo;
define o_cta_odoo int;
select cta_odoo into o_cta_odoo from db_ingresos:ta_12_ctas_odoo where axo = year(today) and cta_aplic = i_cta ;
return o_cta_odoo;
end function;

create procedure "pgcabrer".odoo_datos_varios_13(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10))

returning   varchar(20) as campo,
            varchar(150) as datovario;

define  v_id,v_contador,v_zona,v_giro integer;
define  v_mercado,v_seccion,v_adicional varchar(30);
define  v_domicilio varchar(100);
define  v_sector  char(1);
define  v_superficie decimal(6,2);
define  v_let,v_letra1 varchar(3);
define  v_blq,v_bloque1 varchar(2);

let v_contador=0;
foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    select b.descripcion,d.descripcion,a.domicilio,a.descripcion_local,a.sector,a.zona,a.giro,a.superficie
    into v_mercado,v_seccion,v_domicilio,v_adicional,v_sector,v_zona,v_giro,v_superficie 
    from ta_11_locales a,ta_11_mercados b,ta_11_secciones d
    where a.id_local=v_id
    and b.oficina=a.oficina  and b.num_mercado_nvo=a.num_mercado
    and d.seccion=a.seccion;
    
    return 'MERCADO',v_mercado with resume;
    return 'SECCION',v_seccion with resume;
    if v_domicilio is null then
       return 'DOMICILIO',' ' with resume;
    else
       return 'DOMICILIO',v_domicilio with resume;
    end if;
    return 'LOCAL_ADICIONAL',v_adicional with resume;
    return 'SECTOR',v_sector with resume;
    return 'ZONA',v_zona with resume; 
    return 'GIRO',v_giro with resume;
    return 'SUPERFICIE',v_superficie with resume;
end if;
end foreach;
end procedure;

CREATE PROCEDURE "informix".odoo_datos_varios_14(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10))
               returning varchar(80) as campo ,  varchar(150) as sdato_vario;

define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_tipo CHAR(10);
define  v_vigencia CHAR(1);
define  v_reg_cem varchar(100);
define  v_nomcem VARCHAR(60);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);

let v_axo=year(today);
let v_mes=month(today);
let v_control= p_segmento1;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
  return "nomcem",' '   with resume;
  return "reg_cem",' '  with resume; 
  return "metros",' '   with resume; 
  return "tipo",' '     with resume; 
  return "clase", ' '   with resume; 
  return "seccion",' '  with resume; 
  return "linea",' '    with resume; 
  return "fosa",' '; 
end if;      

select cementerio, cementerio ||' '|| clase||' '||clase_alfa ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
axo_pagado, metros, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa,
case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ' '
end, vigencia
into v_cementerio,v_reg_cem,
v_axo_pagado, v_metros,v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa,v_tipo,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

select  nombre into v_nomcem
from tc_13_cementerios where cementerio=v_cementerio;

--if v_axo_pagado=v_axo  then
--   return ' '; 
--end if;  
   
if v_vigencia='B'  then
  return "nomcem",' '   with resume;
  return "reg_cem",' '  with resume; 
  return "metros",' '   with resume; 
  return "tipo",' '     with resume; 
  return "clase", ' '   with resume; 
  return "seccion",' '  with resume; 
  return "linea",' '    with resume; 
  return "fosa",' '; 
end if;     
--foreach
return "nomcem",v_nomcem  with resume;
return "reg_cem",v_reg_cem with resume; 
 return "metros",v_metros  with resume; 
 return "tipo",v_tipo with resume; 
  return "clase", v_clase    with resume; 
  return "seccion",v_seccion  with resume; 
 return "linea",v_linea    with resume; 
 return "fosa",v_fosa || v_falfa  with resume; 
--end foreach; 
end procedure;

create procedure "informix".odoo_datos_varios_15(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10))
                 returning varchar(80) as campo ,  varchar(150) as sdato_vario;


-- 24/07/2019    ivan tower
-- se agrega un parametro de salida, donde se define el nombre del campo, objetivo integracion con ODOO

define v_id      int;
define v_idmulta int;
define v_fecacta varchar(15);
define v_desley, v_desdep    varchar(100);
define v_desinf    varchar(150);
--define v_motivo    REFERENCES TEXT;

--define v_motivo   lvarchar(150);
define v_inf, v_ley   int;
define v_tipomul char(1);
define v_dep     char(1);
define v_axo     int;
define v_acta    int;
define v_ext,v_int char(10);
define v_ctaapl2 int;
define v_tipo	char(1);
define v_folioreq	integer;
define v_axoreq	integer;
define v_fecemi	date;
define v_fecpra	date;


let v_dep= p_segmento1;
let v_axo= p_segmento2;
let v_acta= p_segmento3;
let v_axoreq=0;

   -- Valida que sea una dependencia correcta
select nvl(id_dependencia,0), descripcion
into v_id, v_desdep
from c_dependencias where abrevia = v_dep and cvectaapl>0;

select nvl(m.id_multa,0), TO_CHAR(nvl(m.fecha_acta, mdy(01,01,1990)),'%d%m%Y'),nvl(id_ley,0),
       nvl(id_infraccion,0)
into   v_idmulta, v_fecacta, v_ley, v_inf
from   multas m
where  m.id_dependencia=v_id and m.axo_acta=v_axo and m.num_acta=v_acta;

select nvl(descripcion,' ') 
into v_desley
from c_leyes where id_dependencia=v_id and id_ley = v_ley and vigencia='V';

foreach
  select first 1 nvl(axoreq,0), folioreq,fecemi,fecpract, 992100009
  into v_axoreq, v_folioreq,v_fecemi,v_fecpra,v_ctaapl2
 from reqmultas where id_multa=v_idmulta  and vigencia="V" and cvepago is null
   	and fecpract is not null
   	and nodiligenciado<>'S' 
  order by axoreq desc, fecemi desc,folioreq desc  
end foreach;



select descripcion 
into v_desinf
from c_infracciones where id_dependencia=v_id and id_infraccion = v_inf and vigencia='V';

if  v_desley is null then
    return  'descripcion_ley' , ' '   with resume;
else
   return  'descripcion_ley' , v_desley   with resume;
end if;
if  v_desinf is null then
    return  'descripcion_infraccion' , ' '   with resume;
else
   return 'descripcion_infraccion' , v_desinf   with resume;
end if;

return 'fecha_acta' , v_fecacta  with resume;
return  'dependencia' , v_desdep  with resume;

end procedure;

CREATE PROCEDURE "pgmoreno".odoo_datos_varios_18 (p_tipo char(1), p_numero int)
{######################################################################
#  Procedimiento:    admin_datos_varios_18
#  Descripcion:      Interfaz de consulta de datos varios para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros        p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:       p_numero   = Numero de Contrato
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_datos_varios en dbingresosw
#  Llama a:          
#  
######################################################################}
returning   varchar(20) as campo,
	varchar(150) as datovario;

define  v_oficina, v_control_contrato, v_cantidad_recolec, v_excedentes	Integer;
define  v_fechabaja							Date;


let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
             SELECT a.control_contrato, a.id_rec, a.fecha_hora_baja, a.cantidad_recolec  INTO  v_control_contrato, v_oficina, v_fechabaja, v_cantidad_recolec
		FROM ta_16_contratos a, ta_16_tipo_aseo b
		WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

					Let v_excedentes = 0;
					if exists( SELECT * FROM ta_16_pagos WHERE control_contrato = v_control_contrato and ctrol_operacion <> 6 and status_vigencia = 'V') then
						SELECT sum(exedencias)  INTO v_excedentes  FROM ta_16_pagos WHERE control_contrato = v_control_contrato 
											and ctrol_operacion <> 6 and status_vigencia = 'V';
					else
						let v_excedentes	= 0;
					end if;
	RETURN 'Oficina', v_oficina with resume;
	RETURN 'Control Contrato', v_control_contrato with resume;
	RETURN 'Recoleccion', v_excedentes with resume;
	--RETURN TO_CHAR(nvl(v_fechabaja,mdy(01,01,1990)),'%d/%m/%Y')  with resume;
	RETURN 'Fecha Baja', TO_CHAR(nvl(v_fechabaja,mdy(01,01,1990)),'%d%m%Y') with resume;
	RETURN 'Recolecc. Contrato', v_cantidad_recolec  with resume;
end if;
end procedure;

CREATE PROCEDURE "informix".odoo_datos_varios_25 ( par_Tabla Char(2), par_Control Char(10) )
{######################################################################
#  Procedimiento:    odoo_datos_varios_25
#  Descripcion:      Interfaz de consulta de datos varios para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros        par_Tabla     = Rubro de ingreso 
#  de entrada:       par_Control   = Dato de Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_datos_varios en dbingresosw
#  Llama a:          
#  
######################################################################}
returning   varchar(20) as campo,
	varchar(150) as datovario;

--**********************************************************************************************
  define v_id_34_datos, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro		Integer;
  define v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs		VarChar(200);
  define v_superficie								Decimal(7,2);
  define v_fecha_inicio, v_fecha_fin						Date;
  define v_sector								Char(1);
  define v_status 								VarChar(50);
  define v_unidades 							VarChar(100);
  define v_categoria 							Char(15);
  define v_control, v_seccion, v_bloque 						Char(10);
  define v_nombre_tabla							Char(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
--set debug file to "gil22.log";
--trace on;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN  ' ','Error en transaccion de Otras Obligaciones ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
--************************************************************************
Let v_id_34_datos = 0;
Let v_id_recaudadora = 0;
Let v_id_zona = 0;
Let v_licencia = 0;
Let v_id_giro = 0;
Let v_superficie = 0;

Let v_concesionario = '';
Let v_ubicacion = '';
Let v_nom_comercial = '';
Let v_lugar = '';
Let v_obs = '';
Let v_sector = '';
Let v_status = '';
Let v_unidades = '';
Let v_categoria = '';
Let v_control = '';
Let v_seccion = '';
Let v_bloque = '';


--****************************************************************************************************************************
SELECT nombre INTO v_nombre_tabla  FROM t34_tablas WHERE cve_tab = par_Tabla;
--****************************************************************************************************************************


if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
                SELECT a.id_34_datos, a.control, a.concesionario, a.ubicacion, (f.descripcion) unidades, a.sector, a.superficie, a.fecha_inicio, a.fecha_fin, 
		a.id_recaudadora, a.id_zona, a.licencia

		INTO v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_unidades, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, 
		v_id_recaudadora, v_id_zona, v_licencia

		FROM t34_datos A, t34_unidades F
			WHERE a.cve_tab = par_Tabla and a.control = par_Control
			AND F.id_34_unidad = A.id_unidad;

		if exists( SELECT * FROM t34_adicionales WHERE id_datos =  v_id_34_datos ) then
			SELECT categoria  INTO  v_categoria  FROM t34_adicionales  WHERE id_datos =  v_id_34_datos;
		else
			let v_categoria = '0';
		end if;
		if exists( SELECT * FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'N' ) then
			SELECT (concepto) nom_comercial INTO v_nom_comercial   FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'N';
		else
			let v_nom_comercial = ' ';
		end if;
		if exists( SELECT * FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'L' ) then
			SELECT (concepto) lugar INTO v_lugar   FROM t34_conceptos WHERE id_datos = v_id_34_datos and tipo = 'L';
		else
			let v_lugar = ' ';
		end if;

		if v_licencia > 0 then
			if exists( SELECT * FROM catastro_gdl:licencias where licencia = v_licencia ) then
				SELECT id_giro INTO v_id_giro  FROM catastro_gdl:licencias where licencia = v_licencia;
			else
				Let v_id_giro = 0;
			end if;
		else
			Let v_id_giro = 0;
		end if;

	RETURN 'Rubro de Ingreso', substr ( v_nombre_tabla,1,40 ) with resume;
	RETURN 'Nombre Comercial', substr ( v_nom_comercial,1,50 ) with resume;
	RETURN 'Lugar/Domicilio', substr ( v_lugar,1,50 ) with resume;
	RETURN ' ', ' ' with resume;  -- ADICIONALES
	RETURN 'Concepto Cobro', substr ( v_unidades,1,20 ) with resume;
	RETURN 'Categoria', substr ( v_categoria,1,2 ) with resume;
	RETURN 'Sector', substr ( v_sector,1,5 ) with resume;
	RETURN 'Inicio Obligacion', TO_CHAR(nvl(v_fecha_inicio,mdy(01,01,1990)),'%d%m%Y') with resume; -- TO_CHAR(nvl(v_fecha_inicio,mdy(01,01,1990)),'%d/%m/%Y')  with resume;
	RETURN 'Fin Obligacion', TO_CHAR(nvl(v_fecha_fin,mdy(01,01,1990)),'%d%m%Y') with resume; -- TO_CHAR(nvl(v_fecha_fin,mdy(01,01,1990)),'%d/%m/%Y')  with resume;
	RETURN 'Giro', substr ( v_id_giro,1,4 )  with resume;
	RETURN 'Licencia', substr ( v_licencia,1,8 )  with resume;
	RETURN 'Zona', substr ( v_id_zona,1,2 )  with resume;
	RETURN 'Superficie', substr ( v_superficie,1,6 )  with resume;
	RETURN 'Recaudadora', substr ( v_id_recaudadora,1,1 )  with resume;
end if;

--trace off;
end procedure;

create procedure "informix".odoo_datos_varios_30(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10))

returning   varchar(20) as campo,
            varchar(150) as datovario;

define  v_id,v_contador,v_zona,v_giro,v_axo,v_mes integer;
define  v_mercado,v_seccion,v_adicional varchar(30);
define  v_domicilio varchar(100);
define  v_sector char(1);
define  v_let,v_letra1 varchar(3);
define  v_blq,v_bloque1 varchar(2);
define  v_superficie decimal(6,2);
define  v_recargos date; 

let v_contador=0;
foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    select b.descripcion,d.descripcion,a.domicilio,a.descripcion_local,a.sector,a.zona,a.giro,a.superficie,
    (select Max(axo) from ta_11_pagos_local where id_local=v_id),
    (select max(periodo) from ta_11_pagos_local where id_local=v_id and axo=
    (select Max(axo) from ta_11_pagos_local where id_local=v_id) ) 
    into v_mercado,v_seccion,v_domicilio,v_adicional,v_sector,v_zona,v_giro,v_superficie,v_axo,v_mes 
    from ta_11_locales a,ta_11_mercados b,ta_11_secciones d
    where a.id_local=v_id
    and b.oficina=a.oficina  and b.num_mercado_nvo=a.num_mercado
    and d.seccion=a.seccion;

--    select fecha_recargos into v_recargos from ta_11_fecha_desc where mes=month(today);
--    let v_axo=year(today);
--    let v_mes=month(today);
--    if today<v_recargos then
--       if v_mes=1 then
--          let v_mes=12;
--          let v_axo=year(today)-1;
--       else
--          let v_mes=month(today)-1;
--       end if;
--    end if;

    return 'A�O',v_axo with resume;
    return 'MES',v_mes with resume;    
    return 'MERCADO',v_mercado with resume;
    return 'SECCION',v_seccion with resume;
    if v_domicilio is null then
       return 'DOMICILIO',' ' with resume;
    else
       return 'DOMICILIO',v_domicilio with resume;
    end if;
    return 'LOCAL_ADICIONAL',v_adicional with resume;
    return 'SECTOR',v_sector with resume;
    return 'ZONA',v_zona with resume; 
    return 'GIRO',v_giro with resume;
    return 'SUPERFICIE',v_superficie with resume;
end if;
end foreach;
end procedure;

create procedure "pgcabrer".sp14_recuperacion(prec int, pfold int, pfolh int, pdil char(1), pejec int)
        returning   int as id,
                    varchar(10) as placa,
                    varchar(100) as nombre,
                    varchar(100) as domicilio,
                    money(18,2) as importe_gasto,
                    int as tipo,
                    int as ayo,
                    money(18,2) as importe_ayo,
                    money(18,2) as importe_adeudo,
                    money(18,2) as total_gasto,
                    varchar(100) as firmante,
                    varchar(100) as cargo,
                    varchar(60) as idfirmado,
                    varchar(100) as validez_certi,
                    varchar(25) as fecha_firma,
                    varchar(60) as hash,
                    date as fecha_emision,
                    int as folio,
                    int as id_control,
                    varchar(100) as marca,
                    varchar(100) as submarca,
                    varchar(100) as modelo,
                    varchar(100) as motor,
                    varchar(100) as serie,
                    varchar(100) as color,
                    varchar(255) as folios;

define vid, vtipo, vayo, vfolio, vid_control, vperiodo int;
define vplaca varchar(10);
define vnombre, vdomicilio, vfirmante, vcargo, vvalidez_certi, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor varchar(100);
define vimporte_gasto, vimporte_ayo, vimporte_adeudo, vtotal_gasto money(18,2);
define vidfirmado, vhash varchar(60);
define vfecha_firma varchar(25);
define vfecha_emision date;
define vfoldet varchar(255);

   foreach
     select distinct a.id,a.placa,a.nombre,trim(a.domicilio),c.importe_gastos,d.tipo,d.ayo,sum(d.importe),
     (select (nvl(sum(importe),0)) from ta_15_periodos where control_otr=c.id_control ),
     (select (nvl(sum(importe_gastos),0)) from ta_15_apremios where modulo=14 and control_otr=a.id 
     and clave_practicado="P" and vigencia="1"),fea.firmante,fea.cargo,
     (fea.secuencia||'-'||fea.digverificador),fea.validez_certi,fea.fecha_firma,fea.hash,c.fecha_emision,c.folio,c.id_control,  
     trim(a.marca), '', trim(a.modelo), trim(a.no_motor), trim(a.serie), trim(a.color)  
     into vid, vplaca, vnombre, vdomicilio, vimporte_gasto, vtipo, vayo, vimporte_ayo, vimporte_adeudo, vtotal_gasto, vfirmante, vcargo,
     vidfirmado, vvalidez_certi, vfecha_firma, vhash, vfecha_emision, vfolio, vid_control, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor
     from dbestacion:ta_padron a,ta_15_apremios c,ta_15_periodos d, outer ta_15_apremios_fea fea
     where c.modulo=14 and c.zona=prec and (c.folio between pfold and pfolh)
     and c.control_otr=a.id and c.id_control=d.control_otr 
     and c.diligencia=pdil and ejecutor=pejec  and fea.id_control_req=c.id_control
     group by 1,2,3,4,5,6,7,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25
     order by 1,6,7

     let vfoldet='';
     foreach
       select periodo into vperiodo from ta_15_periodos where control_otr=vid_control and ayo=vayo and tipo=vtipo order by ayo,periodo
       let vfoldet=trim(vfoldet)||vperiodo||',';
     end foreach;   
     let vfoldet=substr(vfoldet,1,(length(vfoldet)-1));
     return vid, vplaca, vnombre, vdomicilio, vimporte_gasto, vtipo, vayo, vimporte_ayo, vimporte_adeudo, vtotal_gasto, vfirmante, 
       vcargo, vidfirmado, vvalidez_certi, vfecha_firma, vhash, vfecha_emision, vfolio, vid_control, vmarca, vsubmarca, vmodelo, 
       vmotor, vserie, vcolor, vfoldet with resume; 
   end foreach;

end procedure;

create procedure "pgcabrer".sp14_notificacion_firme(prec int, pfold int, pfolh int, pdil char(1))
    returning   int as id,
                varchar(10) as placa,
                int as infraccion,
                varchar(100) as nombre,
                varchar(100) as domicilio,
                int as axo,
                varchar(250) as folios,
                money(18,2) as adeudo,
                money(18,2) as adeudoplaca,
                money(18,2) as total_gasto,
                varchar(100) as marca,
                varchar(100) as submarca,
                varchar(100) as modelo,
                varchar(100) as motor,
                varchar(100) as serie,
                varchar(100) as color;

define vid, vtipo, vayo, vfolio, vid_control, vperiodo int;
define vplaca varchar(10);
define vnombre, vdomicilio, vfirmante, vcargo, vvalidez_certi, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor varchar(100);
define vimporte_gasto, vimporte_ayo, vimporte_adeudo, vtotal_gasto money(18,2);
define vidfirmado, vhash varchar(60);
define vfecha_firma varchar(25);
define vfecha_emision date;
define vfoldet varchar(250);

   foreach
     select distinct a.id,a.placa,a.nombre,trim(a.domicilio),c.importe_gastos,d.tipo,d.ayo,sum(d.importe),
     (select (nvl(sum(importe),0)) from ta_15_periodos where control_otr=c.id_control ),
     (select (nvl(sum(importe_gastos),0)) from ta_15_apremios where modulo=14 and control_otr=a.id 
     and clave_practicado="P" and vigencia="1"),fea.firmante,fea.cargo,
     (fea.secuencia||'-'||fea.digverificador) ,fea.validez_certi,fea.fecha_firma,fea.hash,c.fecha_emision,c.folio,c.id_control,  
     trim(a.marca), '', trim(a.modelo), trim(a.no_motor), trim(a.serie), trim(a.color)  
     into vid, vplaca, vnombre, vdomicilio, vimporte_gasto, vtipo, vayo, vimporte_ayo, vimporte_adeudo, vtotal_gasto, vfirmante, vcargo,
     vidfirmado, vvalidez_certi, vfecha_firma, vhash, vfecha_emision, vfolio, vid_control, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor
     from dbestacion:ta_padron a,ta_15_apremios c,ta_15_periodos d, outer ta_15_apremios_fea fea
     where c.modulo=14 and c.zona=prec and (c.folio between pfold and pfolh)
     and c.control_otr=a.id and c.id_control=d.control_otr 
     and c.diligencia=pdil and fea.id_control_req=c.id_control
     group by 1,2,3,4,5,6,7,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25
     order by 1,6,7
    
     let vfoldet='';
     foreach
       select periodo into vperiodo from ta_15_periodos where control_otr=vid_control and ayo=vayo and tipo=vtipo order by ayo,periodo
       let vfoldet=trim(vfoldet)||vperiodo||',';
     end foreach;   
     let vfoldet=substr(vfoldet,1,(length(vfoldet)-1));
     return vid, vplaca, vtipo, vnombre, vdomicilio, vayo, vfoldet, vimporte_ayo, vimporte_adeudo, vtotal_gasto,
       vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor with resume; 
   end foreach;

end procedure;

create procedure "pgcabrer".sp14_notificacion_pruebas(pprop varchar(100),pinfd int, pinfh int, paxod int, paxoh int, 
pimpd money(18,2), pimph money(18,2),pplaca varchar(10),popc char(1))
    returning   int as id,
                varchar(10) as placa,
                int as infraccion,
                varchar(100) as nombre,
                varchar(100) as domicilio,
                int as axo,
                varchar(250) as folios,
                money(18,2) as adeudo,
                money(18,2) as adeudoplaca,
                money(18,2) as total_gasto,
                varchar(100) as marca,
                varchar(100) as submarca,
                varchar(100) as modelo,
                varchar(100) as motor,
                varchar(100) as serie,
                varchar(100) as color;

define vid_placa, vfolios, vtotal_placas, vtotal_folios int;
define vnombre varchar(100);
define vplaca varchar(10);
define dinfraccion, daxo, did int;
define dplaca varchar(10);
define dfolios varchar(250);
define dadeudo, dadeudoplaca, vtotal_gasto money(18,2);
define dnombre, ddomicilio, dmarca, dsubmarca, dmodelo, dmotor, dserie, dcolor varchar(100);


let vtotal_placas=0;
let vtotal_folios=0;

foreach
   -- ejecuta procedimeinto para sacarlos propietarios
   execute procedure sp14_propietarios(pprop, pinfd, pinfh, paxod, paxoh, pimpd, pimph, pplaca, popc)
      into vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios
   let dadeudoplaca=0;

   -- verifica si ya existen notificaciones de la placa
   let vtotal_gasto=0;
   select nvl(sum(importe_gastos),0) into vtotal_gasto from ta_15_apremios where modulo=14 and control_otr=vid_placa
     and clave_practicado='P' and vigencia='1';

   foreach
     -- ejecuta procedimiento para detallar por a�o cada placa de propietarios 
     execute PROCEDURE dbestacion:cons14_solicrep_beny2(vplaca) into dinfraccion, daxo, dfolios, dadeudo, did, dplaca,
        dnombre, ddomicilio, dmarca, dsubmarca, dmodelo, dmotor, dserie, dcolor
     let dadeudoplaca=dadeudoplaca+dadeudo;

     return did, dplaca, dinfraccion, dnombre, ddomicilio, daxo, dfolios, dadeudo, dadeudoplaca,
       vtotal_gasto, dmarca, dsubmarca, dmodelo, dmotor, dserie, dcolor with resume;

   end foreach;

end foreach;

end procedure;

create procedure "pgcabrer".spd_17_folreqconveje(pmod int,pid int,pfdsd date,pfhst date,pcveeje int)
returning   int as folio,
            int as ejecutor,
            date as fecprac,
            char(1) as vigencia,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst,
            date as fecpag,
            varchar(100) as datos;

define vfolio,vcvepago,vaxodsd,vmesdsd,vaxohst,vmeshst,vejec int;
define vfecpra,vfecpag,vfeccan date;
define vvig char(1);
define vdatos varchar(100);
let vdatos='';
let vfolio=0;
let vejec=0;
let vfecpra=null;
let vvig='';
let vaxodsd=0;
let vmesdsd=0;
let vaxohst=0;
let vmeshst=0;
let vfecpag=0; 

if pmod=3 then -- multas municipales
   foreach
   select a.folioreq,a.cvepago,a.fecpract,a.vigencia,a.feccan,b.fecha,a.cveejecut
   into vfolio,vcvepago,vfecpra,vvig,vfeccan,vfecpag,vejec 
   from catastro_gdl:reqmultas a,outer catastro_gdl:pagos b where a.id_multa=pid and b.cvepago=a.cvepago and a.cveejecut=pcveeje
   if (vvig='V') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,0,0,0,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='P') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,0,0,0,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='C') and (vfecpra<=pfdsd) and 
      ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,0,0,0,0,vfecpag,trim(vdatos) with resume;
   end if;   
   end foreach;
end if;

if pmod=5 then -- predial
   if (pcveeje=652) or (pcveeje=653) then
      foreach
      select a.folioreq,a.cvepago,a.fecent,a.axoini,a.bimini,a.axofin,a.bimfin,a.vigencia,a.feccan,b.fecha,a.cveejecut
      into vfolio,vcvepago,vfecpra,vaxodsd,vmesdsd,vaxohst,vmeshst,vvig,vfeccan,vfecpag,vejec 
      from catastro_gdl:reqpredial a,outer catastro_gdl:pagos b where a.cvecuenta=pid and b.cvepago=a.cvepago and a.cveejecut=pcveeje
      and a.fecent<=pfdsd
      order by a.folioreq
      end foreach;
      let vdatos='';
      if (vvig='V') and (vfecpra<=pfdsd) then
         let vdatos=vfolio||','||vfecpra||','||vvig||','
                    ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
         return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
      end if;
      if (vvig='P') and (vfecpra<=pfdsd) and 
         ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
         let vdatos=vfolio||','||vfecpra||','||vvig||','
                    ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
         return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
      end if;
      if (vvig='C') and (vfecpra<=pfdsd) and 
         ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
         let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
         return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
      end if;
  else
      foreach
      select a.folioreq,a.cvepago,a.fecent,a.axoini,a.bimini,a.axofin,a.bimfin,a.vigencia,a.feccan,b.fecha,a.cveejecut
      into vfolio,vcvepago,vfecpra,vaxodsd,vmesdsd,vaxohst,vmeshst,vvig,vfeccan,vfecpag,vejec 
      from catastro_gdl:reqpredial a,outer catastro_gdl:pagos b where a.cvecuenta=pid and b.cvepago=a.cvepago and a.cveejecut=pcveeje
      let vdatos='';
      if (vvig='V') and (vfecpra<=pfdsd) then
         let vdatos=vfolio||','||vfecpra||','||vvig||','
                    ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
         return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
      end if;
      if (vvig='P') and (vfecpra<=pfdsd) and 
         ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
         let vdatos=vfolio||','||vfecpra||','||vvig||','
                    ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
         return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
      end if;
      if (vvig='C') and (vfecpra<=pfdsd) and 
         ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
         let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
         return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
      end if;
      end foreach;
  end if;
end if;

if pmod=9 then -- licencias
   foreach
   select a.folioreq,a.cvepago,a.fecprac,a.axoini,a.axofin,a.vigencia,a.feccan,b.fecha,a.cveejecut
   into vfolio,vcvepago,vfecpra,vaxodsd,vaxohst,vvig,vfeccan,vfecpag,vejec 
   from catastro_gdl:reqlicencias a,outer catastro_gdl:pagos b where a.id_licencia=pid and b.cvepago=a.cvepago and a.cveejecut=pcveeje
   if (vvig='V') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='P') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='C') and (vfecpra<=pfdsd) and 
      ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;

if pmod=10 then -- anuncios
   foreach
   select a.folioreq,a.cvepago,a.fecprac,a.axoini,a.axofin,a.vigencia,a.feccan,b.fecha,a.cveejecut
   into vfolio,vcvepago,vfecpra,vaxodsd,vaxohst,vvig,vfeccan,vfecpag,vejec 
   from catastro_gdl:reqanuncios a,outer catastro_gdl:pagos b where a.id_anuncio=pid and b.cvepago=a.cvepago and a.cveejecut=pcveeje
   if (vvig='V') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='P') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='C') and (vfecpra<=pfdsd) and 
      ((vfeccan>=pfdsd) and (vfeccan<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||' AL '||vaxohst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,0,vaxohst,0,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;

if pmod=11 then -- mercados
   foreach
   select a.folio,a.fecha_practicado,
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   a.vigencia,a.fecha_pago,a.ejecutor
   into vfolio,vfecpra,vaxodsd,vmesdsd,vaxohst,vmeshst,vvig,vfecpag,vejec 
   from ta_15_apremios a where control_otr=pid and modulo=11 and a.ejecutor=pcveeje
   if (vvig='1') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='2') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='3') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;

if pmod=16 then -- aseo
   foreach
   select a.folio,a.fecha_practicado,
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control),
   (select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
   (select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) ,
   a.vigencia,a.fecha_pago,a.ejecutor
   into vfolio,vfecpra,vaxodsd,vmesdsd,vaxohst,vmeshst,vvig,vfecpag,vejec 
   from ta_15_apremios a where control_otr=pid and modulo=16 and a.ejecutor=pcveeje
   if (vvig='1') and (vfecpra<=pfdsd) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='2') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   if (vvig='3') and (vfecpra<=pfdsd) and 
      ((vfecpag>=pfdsd) and (vfecpag<=pfhst)) then
      let vdatos=vfolio||','||vfecpra||','||vvig||','
                  ||vaxodsd||'-'||vmesdsd||' AL '||vaxohst||'-'||vmeshst||','||vfecpag;
      return vfolio,vejec,vfecpra,vvig,vaxodsd,vmesdsd,vaxohst,vmeshst,vfecpag,trim(vdatos) with resume;
   end if;
   end foreach;
end if;
end procedure;

create procedure "pgcabrer".sp14_propietarios(pprop varchar(100),pinfd int, pinfh int, paxod int, paxoh int, 
pimpd money(18,2), pimph money(18,2), pplaca varchar(10), popc char(1))
returning   int as id_placa,
            varchar(100) as nombre,
            varchar(10) as placa,
            int as folios,
            int as total_placas,
            int as total_folios;

define vid_placa, vfolios, vtotal_placas, vtotal_folios, vdias, rcant_folio int;
define vnombre, rnombre, rdomicilio varchar(100);
define vplaca, rplaca varchar(10);
define radeudo money(18,2);

let vtotal_placas=0;
let vtotal_folios=0;

if popc='N'then
    -- para retornar datos
    foreach
    SELECT a.id, trim(a.NOMBRE), trim(a.placa)--, COUNT(b.folio) folios 
    into vid_placa, vnombre, vplaca--, vfolios
    FROM dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
    WHERE a.nombre LIKE '%'||pprop||'%' and a.id>0 and b.placa=a.placa 
    and trim(a.municipio)='GUADALAJARA' and (b.axo between paxod and paxoh)
    GROUP BY a.id, a.NOMBRE, a.placa ORDER BY a.NOMBRE, a.placa

    let vfolios=0;
    --  para validar a�os e importes 
    foreach
    execute  PROCEDURE dbestacion:cons14_Placa_Rangos ( vplaca, paxod, paxoh, 1, 9999, pimpd, pimph ) into rplaca, rnombre, rdomicilio, vfolios, radeudo
    end foreach;

    if vfolios >0 then
       -- verifica si tiene notificacion dentro de los 60 dias
       if exists(select * from ta_15_apremios where control_otr=vid_placa and diligencia = 'N' and vigencia='1' and modulo=14) then
           foreach
            select (today-fecha_emision) into vdias from ta_15_apremios where control_otr=vid_placa and diligencia = 'N' 
             and vigencia='1' and modulo=14 order by fecha_emision
           end foreach;
           if vdias>60 then
              let vtotal_folios = vtotal_folios + vfolios;
              let vtotal_placas = vtotal_placas + 1; 
              return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
           end if;
       else
           let vtotal_folios = vtotal_folios + vfolios;
           let vtotal_placas = vtotal_placas + 1;
           return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
       end if;
    end if;

    end foreach;
end if;

if popc='P' then
    foreach
    SELECT a.id, trim(a.NOMBRE), trim(a.placa)--, COUNT(b.folio) folios 
    into vid_placa, vnombre, vplaca--, vfolios
    FROM dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
    WHERE a.placa=pplaca and b.placa=a.placa and a.id>0 and trim(a.municipio)='GUADALAJARA'
    and (b.axo between paxod and paxoh)
    GROUP BY a.id, a.NOMBRE, a.placa ORDER BY a.NOMBRE, a.placa

    let vfolios=0;
    --  para validar a�os e importes 
    foreach
    execute  PROCEDURE dbestacion:cons14_Placa_Rangos ( vplaca, paxod, paxoh, 1, 9999, pimpd, pimph ) into rplaca, rnombre, rdomicilio, vfolios, radeudo
    end foreach;

    if vfolios >0 then
       -- verifica si tiene notificacion dentro de los 60 dias
       if exists(select * from ta_15_apremios where control_otr=vid_placa and diligencia = 'N' and vigencia='1' and modulo=14) then
           foreach
            select (today-fecha_emision) into vdias from ta_15_apremios where control_otr=vid_placa and diligencia = 'N' 
            and vigencia='1' and modulo=14 order by fecha_emision
           end foreach;
           if vdias>60 then
              let vtotal_folios = vtotal_folios + vfolios;
              let vtotal_placas = vtotal_placas + 1;
              return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
           end if;
       else
           let vtotal_folios = vtotal_folios + vfolios;
           let vtotal_placas = vtotal_placas + 1;
           return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
       end if;
    end if;

    end foreach;
end if;

if popc='A' then
    foreach
    SELECT a.id, trim(a.NOMBRE), trim(a.placa)--, COUNT(b.folio) folios 
    into vid_placa, vnombre, vplaca--, vfolios
    FROM dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
    WHERE (b.axo between paxod and paxoh) and b.placa=a.placa and a.id>0 and trim(a.municipio)='GUADALAJARA'
    GROUP BY a.id, a.NOMBRE, a.placa ORDER BY a.NOMBRE, a.placa

    let vfolios=0;
    --  para validar a�os e importes 
    foreach
    execute  PROCEDURE dbestacion:cons14_Placa_Rangos ( vplaca, paxod, paxoh, 1, 9999, pimpd, pimph ) into rplaca, rnombre, rdomicilio, vfolios, radeudo
    end foreach;

    if vfolios >0 then
       -- verifica si tiene notificacion dentro de los 60 dias
       if exists(select * from ta_15_apremios where control_otr=vid_placa and diligencia = 'N' and vigencia='1' and modulo=14) then
           foreach
            select (today-fecha_emision) into vdias from ta_15_apremios where control_otr=vid_placa and diligencia = 'N' 
            and vigencia='1' and modulo=14 order by fecha_emision
           end foreach;
           if vdias>60 then
              let vtotal_folios = vtotal_folios + vfolios;
              let vtotal_placas = vtotal_placas + 1;
              return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
           end if;
       else
           let vtotal_folios = vtotal_folios + vfolios;
           let vtotal_placas = vtotal_placas + 1;
           return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
       end if;
    end if;

    end foreach;
end if;
end procedure;

CREATE PROCEDURE "informix".spd_bmxhp_20hrs( pfecha   date )
returning smallint as reca, char(2) as Caja, integer as operacion, char(28) as Linea, integer  as cvepago;
define v_cvecuenta integer;
define v_fecha  date ;
define v_importe decimal(15,2) ;
define v_bim_ini smallint; 
define v_axo_ini smallint; 
define v_bim_fin smallint; 
define v_axo_fin smallint; 
define v_id_transaccion integer; 
define varrec smallint ;
define varcaja char(2);
define spoperacion integer;
define v_lineacapt2 varchar(32);
define  varcvepago integer;
define v_cvekiosco integer;

   foreach
select  a.cvecuenta , k.fecha ,  k.importe ,  a.bim_ini  ,   a.axo_ini  ,  a.bim_fin  ,  a.axo_fin  ,   a.id_transaccion , k.cvekiosco
into v_cvecuenta , v_fecha ,  v_importe ,  v_bim_ini  ,   v_axo_ini  ,  v_bim_fin  ,  v_axo_fin  ,   v_id_transaccion , v_cvekiosco
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where k.fecha =  pfecha and a.sucursal = '@BMXHP' and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null

execute procedure db_ingresos:spd_pagpredkioBMXHP( v_cvecuenta, v_fecha,  v_importe, v_bim_ini, v_axo_ini, v_bim_fin , v_axo_fin , v_id_transaccion )
 into varrec, varcaja, spoperacion , v_lineacapt2, varcvepago ;

 update catastro_gdl:k_pagos k set fec_afec = today where cvekiosco = v_cvekiosco and fec_afec is null;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago with resume;
  end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_pagpredkiobmxhp(
    		parcvecuenta    integer,
                parfechaPAgo    date ,
                parImpCertificado money(15,2),
    		parMesdesde 	smallint,
    		parAxodesde 	smallint,
    		parMeshasta    	smallint,
    		parAxohasta  	smallint,
    		
                parIdTransKio   integer
        )
		returning smallint , char(2), integer, char(28), integer;

define varFecha 	date;
define varrec 	       smallint;
define varCaja 		char(2);
define varOperacion 	integer;
define v_recaud 	       smallint;
define v_urbrus 		char(1);
define v_cuenta 	integer;
define v_nombre char(60);
define v_domicilio char(60);
define v_ubicacion char(60);
define spoperacion   integer;
define linea integer ;
define cuenta integer;
define v_suma money(15,2);
define v_ob char(1); define v_importe  money(15,2) ; define  v_idtrans int;
define v_concepto char(30); define v_redondeo money(3,2);
define us char(10);
define v_hora datetime hour to minute;
define catdescrip varchar(255);
define varcvepago int;
define v_mulpag MONEY(12,2);
define v_multavir MONEY(12,2);
define v_gaspag MONEY(12,2);
define v_multasvir money(12,2);
define v_saldosfavor money(12,2);
define v_cvereq int;
define p_desde int;
define p_hasta int;
define axocal int;
define v_lineacapt varchar(110) ;
define v_lineacapt2 varchar(28);
define estatus int;
define mensaje varchar(200);
define  v_axoreq int;
define v_fecemi date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define pg_recaud int;
define pg_caja char(2);
define pg_folio int;
define pg_fecha date ;
define pg_cvecuenta int;
define parcvekiosco int;
define parsucursal  varchar(30);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;

   if varcvepago > 0 then
      select recaud , caja , folio , fecha , cvecuenta into
             pg_recaud , pg_caja , pg_folio , pg_cvecuenta
      from catastro_gdl:pagos where cvepago = varcvepago ;

       update db_ingresos:ta_12_recibos set cvepago = 'C'
       where fecha = pg_fecha and id_rec = pg_recaud and caja =  pg_caja and operacion = pg_folio and id_modulo = 5
        and rfcnumero = pg_cvecuenta and cvepago = 'P';
       insert into catastro_gdl:pagoscan values(0,varcvepago , 'bmxws' ,parfechaPAgo);
    end if;
         RETURN 0,'' , 0 , v_lError || 'IS: ' || v_lISAMError || ' ' || v_vcMensaje,0;
   --   RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION;
--SET EXPLAIN FILE TO 'explain2.out';
 --set debug file to "pago13";
 --trace on;
 
 select  a.cvecuenta, k.fecha, k.importe, a.bim_ini, a.axo_ini, a.bim_fin, a.axo_fin,  k.cvekiosco, a.sucursal
 into parcvecuenta , parfechaPAgo , parImpCertificado , parMesdesde , parAxodesde, parMeshasta , parAxohasta , parcvekiosco , parsucursal
from catastro_gdl:k_pagos k , catastro_gdl:wspredtransac a   where id_transaccion = parIdTransKio and a.cancelacion is null
 and k.cvekiosco = a.cvepago and k.fec_afec is null ;
 
let axocal = (parAxodesde/100);
let axocal = axocal *100;
let p_desde = (parMesdesde * 100) + (parAxodesde -axocal);
let axocal = (parAxohasta/100);
let axocal = axocal *100;
let p_hasta = (parMeshasta * 100) + (parAxohasta -axocal);
let varcvepago = 0;
let  v_mulpag = 0;
let v_multavir = 0;
let v_gaspag = 0;
let v_saldosfavor = 0;

  let v_r = 'N';
--datos del predio.
 let  v_recaud = 0; let v_urbrus = '' ; let v_cuenta = 0;


 select a.recaud , a.urbrus , a.cuenta , a.nombre_completo ,
   trim(nvl(a.c_calle,'')) || ' # Ext ' || trim(nvl(a.c_noexterior, '')) || ' # Int ' || trim(nvl(a.c_interior,'')),
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,'')),
    'CUENTA: ' || a.recaud   || '-' ||a.urbrus  || '-' || a.cuenta
  -- '@FISCAL ' || trim(a.c_calle) || ' # Ext ' || trim(a.c_noexterior) || ' # Int ' || trim(a.c_interior)
   || '@UBICACION ' ||
   trim(nvl(a.u_calle,'')) || ' Ext ' || trim(nvl(a.u_noexterior,'')) || ' # Int ' || trim(nvl(a.u_interior,''))
   || '@CVECATASTRAL ' || nvl(CVECATNVA,'') || 'Sup. Terr: ' || areaterr || 'V.T: ' ||  valterr
   || '@Sup.Cons: ' || areaconst || 'V.C: ' ||  valconst || 'Tasa:' || tasa

,
 extend(current, hour to minute)
 into v_recaud , v_urbrus , v_cuenta ,v_nombre , v_domicilio , v_ubicacion,
 catdescrip   , v_hora
 from catastro_gdl:datos_gralKio a
 where a.cvecuenta = parcvecuenta;


  select id_rec , caja  into varrec , varcaja

  from ta12_operacKiosco
  where id_usuario = 563;
  -- BEGIN WORK;
     let v_r = 'S';
  execute procedure spd_abcreboskiosco(parfechaPAgo ,varrec , varcaja , 0  , parImpCertificado,
                'P' , 5, v_cuenta, v_recaud, v_urbrus,
              parMesdesde, parAxodesde, parMeshasta, parAxohasta,
                v_Nombre, v_ubicacion,'Pago Predial Por BANAMEX eCOMM de ' || parcvecuenta , '',parcvecuenta,0,
                0,0,563,current,0,0,0,'',0,'I', catdescrip)
 into spoperacion;

  let varoperacion = spoperacion;
--catastro pago
  let us = '@BMXHP' ;
  insert into catastro_gdl:pagos(cvepago, cvecuenta, recaud, caja, folio, fecha, hora, importe, cajero, cvecanc, cveconcepto)
             values(0,parcvecuenta, varrec, varcaja, spoperacion, parfechaPAgo, v_hora ,
                    parImpCertificado, us, null, 1);
 let varcvepago = dbinfo("sqlca.sqlerrd1");
--  execute procedure  catastro_gdl@catastro_tcp:admsp_totalespred( 2323,2010,5,1)

let linea = 1;
let v_suma =0;
--execute procedure catastro_gdl@catastro_tcp:kiosco_totalespred(265874,2009,6,1)
FOREACH
--execute procedure  catastro_gdl:kiosco_totalespred_nvo( parcvecuenta , parAxohasta, parMeshasta, 1)
execute procedure  catastro_gdl:internet_totalespred( parIdTransKio)
    into v_cuenta , v_ob , v_concepto , v_importe , v_idtrans
if v_ob = 'D' then
     if v_cuenta <> 550800000   then
  insert into ta_12_recibosdet
        ( fecha       , id_rec , caja    , operacion     , linea , descripcion , cuenta    , importe )
  values( parfechaPAgo, varrec , varcaja ,  varoperacion , linea ,  v_concepto ,   v_cuenta, v_importe );
     end if;
     if v_cuenta = 992101018 then
         let v_saldosfavor = v_importe;
     end if;
   if v_idtrans = 2 then
    insert into catastro_gdl:auditoria ( cvecuenta , cvepago , cvectaapl , recaudpago , monto ,
    cancelacion,axopago ,  bimini)
     values (parcvecuenta, varcvepago, v_cuenta,varrec ,v_importe, 'N',0,0);

     if v_cuenta = 550610001 then
       let v_gaspag = v_importe;
     end if;
   end if;
       let linea = linea + 1 ;
 end if;
if v_ob = 'T' then
let v_suma = v_importe;
end if;
end FOREACH;


let  v_mulpag = 0;
let v_multavir = 0;

-- para afectar catastro del pago:
if v_gaspag > 0 then
      foreach
        select first 1 axoreq, fecemi, cvereq
                    into v_axoreq, v_fecemi, v_cvereq
        from catastro_gdl:reqpredial
        where cvecuenta= parcvecuenta  and vigencia="V" and fecent is not null and nodiligenciado <> 'S'
        order by  axoreq desc, fecemi desc
        end foreach
  select sum(multa) , sum(multavir) into v_mulpag , v_multasvir  from catastro_gdl:k_detsaldos_nvo where cvekiosco = parcvekiosco;
     insert into catastro_gdl:gastmult ( cvepago , mulpag, multavir , gaspag , cvereq)
     values ( varcvepago , v_mulpag, v_multavir , v_gaspag , v_cvereq);
     update catastro_gdl:descmulta
        set estado = 'P' , cvepago = varcvepago
        where cvecuenta = parcvecuenta and estado = 'V';
end if;
-- insertar la detalle de lugar de pago en este caso los datos del siapa. select * from catastro_gdl:banamex
 --select * from catastro_gdl:k_pagos where llave = 525535
    insert into catastro_gdl:banamex(cvepago,cvecuenta,recaud,folio ,caja,operacion,fecha,fechapago,
       importe,importepago, tipopago, fecarga)
     values (varcvepago,parcvecuenta, 1 , varoperacion , varcaja, varoperacion, today,
              parfechaPAgo, parImpCertificado, parImpCertificado,5,parfechaPAgo);

if v_saldosfavor > 0 then
    update catastro_gdl:saldosafavor set saldosimporteaplicado = importeaplicado - v_saldosfavor ,
            saldoinicial = saldoinicial + v_saldosfavor
            where cvecuenta = parcvecuenta;
end if;

 execute PROCEDURE catastro_gdl:ins_detpago(parcvecuenta  ,
                    parMesdesde ,parAxodesde ,
                      parMeshasta ,parAxohasta ,
                    varcvepago ,  v_urbrus, varrec ,0);

--select * from liga_linea_trans where id_transaccion =  parIdTransKio;
select a.linea into v_lineacapt2 from catastro_gdl:linea_capturapred a, catastro_gdl:liga_linea_trans t
where  t.id_transaccion = parIdTransKio and t.refer_id = a.id;

--select * from catastro_gdl:linea_capturapred
--select * from catastro_gdl:liga_linea_trans

    execute  PROCEDURE linea_pagok(v_lineacapt2, 175, parImpCertificado, 'K',varcvepago,
             parfechaPAgo, varrec , varcaja, varoperacion, '@BMXHP') into  estatus ,mensaje ;
	-- COMMIT WORK;
return varrec, varcaja, spoperacion , v_lineacapt2,varcvepago;
--trace off;
end procedure;

create procedure "informix".admin_pago_kiosco(pfecha date,prec int,pcaja char(8),poper int,pidcobro int,
pfolio char(15),puser char(10))

{######################################################################
#  Procedimiento:    admin_pago_kiosco
#  Descripcion:      Interfaz de pago para el cobro de kioscos en admin
#
#  Parametros        
#  de entrada:       pfecha = fecha de pago del kiosco
#                    prec = recaudadora de pago del kiosco
#                    pcaja = caja de pago del kiosco
#                    poper = operacion de caja del kiosco
#                    pidcobro = numero de operacion,
#                    pfolio = folio de recibo ofical
#                    puser = nombre del usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            17 Diciembre 2013   
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as codigo,
            varchar(150) as descripcion;

define v_codigo,v_iduser int;
define v_descripcion varchar(150);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
define v_fecharecibo  date;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  IF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
-- set debug file to "pagoKiosco";
-- trace on;
  let v_r = 'N';
 
-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;
if pcaja  = 'I3' then
   if exists(select * from ta_12_recibos where fec_pagobco = pfecha and id_rec=prec and caja=pcaja 
          and operacion=poper and kio_trans>0) then
          return -1,'EL PAGO YA FUE APLICADO ANTERIORMENTE';
    end if;
 else
    if exists(select * from ta_12_recibos where fec_pagobco=pfecha and id_rec=prec and caja=pcaja 
             and operacion=poper and kio_trans>0) then
          return -1,'EL PAGO YA FUE APLICADO ANTERIORMENTE';
    end if;
 end if;


-- ya todos los pagos van a verificarse con la fecha del banco, esto con el fin de no modificar la fecha cuando se realizo la operacion.
-- la fecha del banco sera cuando se aplica en admin
  select fecha into v_fecharecibo from ta_12_recibos where fec_pagobco = pfecha and id_rec=prec and caja=pcaja 
          and operacion=poper;
  
   BEGIN WORK;
let v_r = 'S';

update ta_12_recibos set kio_trans=pidcobro,foliorecibo=pfolio,id_usuario=v_iduser
       where fecha=v_fecharecibo and id_rec=prec and caja=pcaja and operacion=poper;
let v_codigo=0;
let v_descripcion='PAGO APLICADO CORRECTAMENTE'; 
    
COMMIT WORK;
-- procedimiento anterior cuando afectamos con la fecha de la operacion del recibo.
--else
--BEGIN WORK;
--let v_r = 'S';

--update ta_12_recibos set kio_trans=pidcobro,foliorecibo=pfolio,id_usuario=v_iduser
--       where fecha=pfecha and id_rec=prec and caja=pcaja and operacion=poper;
--let v_codigo=0;
--let v_descripcion='PAGO APLICADO CORRECTAMENTE'; 
    
--COMMIT WORK;
--end if;
return v_codigo,v_descripcion;
--trace off;
end procedure;

create procedure "informix".odoo_datos_varios_22x(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10))

returning   varchar(20) as campo,
            varchar(150) as datovario;

define  v_tipo,v_subtipo varchar(50);
define  v_fecha varchar(20);
define  v_referencia,v_periodo varchar(30); 
define  v_inicio,v_parcial,v_final,v_total decimal(16,2);
define  v_modulo,v_idresto,v_parc,v_cont,v_resto integer; 

let v_periodo='';
let v_parc=0;
let v_idresto=0;
let v_cont=0;
let v_resto=0;

foreach
select nvl(d.descripcion,' '),nvl(e.desc_subtipo,' '),TO_CHAR(nvl(b.fecha_inicio,mdy(01,01,1990)),'%d%m%Y'),
nvl(b.cantidad_inicio,0),nvl(b.pago_parcial,0),nvl(b.pago_final,0),nvl(b.cantidad_total,0),
f.referencia,f.modulo,b.id_conv_resto
into v_tipo,v_subtipo,v_fecha,v_inicio,v_parcial,v_final,v_total,v_referencia,v_modulo,v_idresto
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_tipos d,ta_17_subtipo_conv e,
outer ta_17_referencia f
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet 
and a.numero_exp=pnum and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.tipo=a.tipo and e.tipo=a.tipo and e.subtipo=a.subtipo and f.id_conv_resto=b.id_conv_resto

if v_referencia is null then
   let v_referencia='';
end if;
if v_modulo is null then
   let v_modulo=0;
end if;

if (ptipo=3) and (psubt=1) then
   if v_modulo<>10 then
      return 'TIPO',v_tipo with resume;
      return 'SUBTIPO',v_subtipo with resume;
      return 'FECHA_INICIO',v_fecha with resume;
      return 'PAGO_INICIAL',v_inicio with resume;
      return 'PAGO_PARCIAL',v_parcial with resume;
      return 'PAGO_FINAL',v_final with resume;
      return 'CANTIDAD_TOTAL',v_total with resume; 
      return 'REFERENCIA',v_referencia with resume;
   end if;
else
   return 'TIPO',v_tipo with resume;
   return 'SUBTIPO',v_subtipo with resume;
   return 'FECHA_INICIO',v_fecha with resume;
   return 'PAGO_INICIAL',v_inicio with resume;
   return 'PAGO_PARCIAL',v_parcial with resume;
   return 'PAGO_FINAL',v_final with resume;
   return 'CANTIDAD_TOTAL',v_total with resume; 
   return 'REFERENCIA',v_referencia with resume;
end if;
end foreach;

foreach
select pago_parcial,
(case when axo_desde>0 then (lpad(mes_desde,2,'0')||'/'||axo_desde||' al '||lpad(mes_hasta,2,'0')||'/'||axo_hasta)
else '' end) into v_parc,v_periodo 
from ta_17_adeudos_div
where id_conv_resto=v_idresto and (clave_pago<>'P' or clave_pago is null)
let v_cont=v_cont+1;
--return 'PERIODO_' || v_cont , v_periodo with resume;
return v_parc , v_periodo with resume;
end foreach;

for v_resto=1 to (18-v_cont)
return '','' with resume;
end for

end procedure;

CREATE FUNCTION "informix".odoo_datos_varios_22
(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10))

returning   varchar(20) as campo,
            varchar(150) as datovario;

define  v_tipo,v_subtipo varchar(50);
define  v_fecha varchar(20);
define  v_referencia,v_periodo varchar(30); 
define  v_inicio,v_parcial,v_final,v_total decimal(16,2);
define  v_modulo,v_idresto,v_parc,v_cont,v_resto integer; 

let v_periodo='';
let v_parc=0;
let v_idresto=0;
let v_cont=0;
let v_resto=0;

foreach
select nvl(d.descripcion,' '),nvl(e.desc_subtipo,' '),TO_CHAR(nvl(b.fecha_inicio,mdy(01,01,1990)),'%d%m%Y'),
nvl(b.cantidad_inicio,0),nvl(b.pago_parcial,0),nvl(b.pago_final,0),nvl(b.cantidad_total,0),
f.referencia,f.modulo,b.id_conv_resto
into v_tipo,v_subtipo,v_fecha,v_inicio,v_parcial,v_final,v_total,v_referencia,v_modulo,v_idresto
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_tipos d,ta_17_subtipo_conv e,
outer ta_17_referencia f
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet 
and a.numero_exp=pnum and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.tipo=a.tipo and e.tipo=a.tipo and e.subtipo=a.subtipo and f.id_conv_resto=b.id_conv_resto

if v_referencia is null then
   let v_referencia='';
end if;
if v_modulo is null then
   let v_modulo=0;
end if;

if (ptipo=3) and (psubt=1) then
   if v_modulo<>10 then
      return 'TIPO',v_tipo with resume;
      return 'SUBTIPO',v_subtipo with resume;
      return 'FECHA_INICIO',v_fecha with resume;
      return 'PAGO_INICIAL',v_inicio with resume;
      return 'PAGO_PARCIAL',v_parcial with resume;
      return 'PAGO_FINAL',v_final with resume;
      return 'CANTIDAD_TOTAL',v_total with resume; 
      return 'REFERENCIA',v_referencia with resume;
   end if;
else
   return 'TIPO',v_tipo with resume;
   return 'SUBTIPO',v_subtipo with resume;
   return 'FECHA_INICIO',v_fecha with resume;
   return 'PAGO_INICIAL',v_inicio with resume;
   return 'PAGO_PARCIAL',v_parcial with resume;
   return 'PAGO_FINAL',v_final with resume;
   return 'CANTIDAD_TOTAL',v_total with resume; 
   return 'REFERENCIA',v_referencia with resume;
end if;
end foreach;

foreach
select pago_parcial,
(case when axo_desde>0 then (lpad(mes_desde,2,'0')||'/'||axo_desde||' al '||lpad(mes_hasta,2,'0')||'/'||axo_hasta)
else '' end) into v_parc,v_periodo 
from ta_17_adeudos_div
where id_conv_resto=v_idresto and (clave_pago<>'P' or clave_pago is null)
let v_cont=v_cont+1;
return 'PERIODO_' || v_cont , v_periodo with resume;
--return v_parc , v_periodo with resume;
end foreach;

for v_resto=1 to (18-v_cont)
return '','' with resume;
end for

END FUNCTION
;

CREATE FUNCTION "informix".admin_adeudo_detalle_22
(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(50) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia varchar(30);
define  v_cveparc char(1);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses decimal(14,2);
define  v_cuentaapl,v_folreq,dias_cuantos,dias_habil,v_ctarec,v_ctaint,v_ctaing int;
define  v_vencimiento,v_fecreq date;
define  v_id,v_idresto,v_idadeudo,v_ref,v_parc,v_min,v_max int;

begin
    on exception in (-958)
       delete from tmp_totalesconv;
    end exception;
create temp table tmp_totalesconv(
  rubro int,
  concepto int,
  cuenta int,
  referencia int,
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;

if trim(pref)='' then
   let v_ref=999;
else
   let v_ref=pref;
end if;

select b.id_conv_resto,nvl(e.cuenta_recargos,0),nvl(min(d.pago_parcial),0),nvl(max(d.pago_parcial),0)
,nvl(e.cuenta_intereses,0),nvl(e.cuenta_ingreso,0) 
into v_id,v_ctarec,v_min,v_max,v_ctaint,v_ctaing
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d,ta_17_subtipo_conv e
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref and e.tipo=a.tipo and e.subtipo=a.subtipo
group by 1,2,5,6;

 -- para obtener el datos de multa y gastos
foreach
select nvl(b.folio,0), nvl(b.importe_multa,0),nvl(sum(importe_gastos),0),nvl(b.porcentaje_multa,0),
nvl(b.fecha_practicado,null)
into v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
from ta_15_apremios b
where b.modulo=17 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
group by 1,2,4,5 order by  1
end foreach;

let dias_cuantos=0;

select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales 
where fecha between v_fecreq and today;
    
let dias_cuantos=(today-v_fecreq)-dias_habil;
if  v_porcmul=100 then
    if dias_cuantos <=6 then
       let v_multa=v_multa*50/100;
    else
       if (dias_cuantos >=7) and (dias_cuantos<=16) then
          let v_multa=v_multa*80/100;
       else  
          let v_multa=(v_multa*(100-v_porcmul))/100;
       end if;
    end if;
else
    let v_multa=(v_multa*(100-v_porcmul))/100;
end if;

if v_multa>0 then
   let v_acumulado=v_acumulado+v_multa;
   return 0,0,0,v_min,'MULTA',v_multa,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,v_min,'MULTA',v_multa,v_acumulado);
end if;

if v_gastos>0 then
   let v_acumulado=v_acumulado+v_gastos;
   return 0,0,0,v_min,'GASTOS',v_gastos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,v_min,'GASTOS',v_gastos,v_acumulado);  
end if;

foreach
select b.id_conv_resto,d.id_adeudo,d.pago_parcial,d.importe,d.fecha_venc,d.cve_parcialidad
into v_idresto,v_idadeudo,v_parc,v_importe,v_vencimiento,v_cveparc
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref 
order by d.pago_parcial

  foreach  
  select cuenta_apl,importe into v_cuentaapl,v_monto
  from ta_17_desg_parcial 
  where id_adeudo=v_idadeudo
  order by id_desgloce

  let v_acumulado=v_acumulado+v_monto;
  return 0,0,v_cuentaapl,v_parc,'CONVENIO',v_monto,v_acumulado with resume;
  insert into tmp_totalesconv values(0,0,v_cuentaapl,v_parc,'CONVENIO',v_monto,v_acumulado);
  end foreach;

execute procedure admin_intereses_22(v_idresto,v_vencimiento,v_parc,v_cveparc) into v_intereses;
let v_recargos=0;
if today>v_vencimiento then
   execute procedure admin_recargos_20((v_importe+v_intereses),v_vencimiento) into v_recargos;
end if;

if v_recargos>0 then
   let v_acumulado=v_acumulado+v_recargos;
   return 0,0,v_ctarec,v_parc,'RECARGOS',v_recargos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctarec,v_parc,'RECARGOS',v_recargos,v_acumulado);
end if;

if v_intereses>0 then
   let v_acumulado=v_acumulado+v_intereses;
   return 0,0,v_ctaint,v_parc,'INTERESES',v_intereses,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctaint,v_parc,'INTERESES',v_intereses,v_acumulado);
end if;

end foreach;

END FUNCTION
;

CREATE FUNCTION "informix".admin_adeudos_detalle_22
(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(50) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia varchar(30);
define  v_cveparc char(1);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses decimal(14,2);
define  v_cuentaapl,v_folreq,dias_cuantos,dias_habil,v_ctarec,v_ctaint,v_ctaing int;
define  v_vencimiento,v_fecreq date;
define  v_id,v_idresto,v_idadeudo,v_ref,v_parc,v_min,v_max int;

begin
    on exception in (-958)
       delete from tmp_totalesconv;
    end exception;
create temp table tmp_totalesconv(
  rubro int,
  concepto int,
  cuenta int,
  referencia int,
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;

if trim(pref)='' then
   let v_ref=999;
else
   let v_ref=pref;
end if;

select b.id_conv_resto,nvl(e.cuenta_recargos,0),nvl(min(d.pago_parcial),0),nvl(max(d.pago_parcial),0)
,nvl(e.cuenta_intereses,0),nvl(e.cuenta_ingreso,0) 
into v_id,v_ctarec,v_min,v_max,v_ctaint,v_ctaing
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d,ta_17_subtipo_conv e
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref and e.tipo=a.tipo and e.subtipo=a.subtipo
group by 1,2,5,6;

 -- para obtener el datos de multa y gastos
foreach
select nvl(b.folio,0), nvl(b.importe_multa,0),nvl(sum(importe_gastos),0),nvl(b.porcentaje_multa,0),
nvl(b.fecha_practicado,null)
into v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
from ta_15_apremios b
where b.modulo=17 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
group by 1,2,4,5 order by  1
end foreach;

let dias_cuantos=0;

select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales 
where fecha between v_fecreq and today;
    
let dias_cuantos=(today-v_fecreq)-dias_habil;
if  v_porcmul=100 then
    if dias_cuantos <=6 then
       let v_multa=v_multa*50/100;
    else
       if (dias_cuantos >=7) and (dias_cuantos<=16) then
          let v_multa=v_multa*80/100;
       else  
          let v_multa=(v_multa*(100-v_porcmul))/100;
       end if;
    end if;
else
    let v_multa=(v_multa*(100-v_porcmul))/100;
end if;

if v_multa>0 then
   let v_acumulado=v_acumulado+v_multa;
   return 0,0,0,v_min,'MULTA',v_multa,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,v_min,'MULTA',v_multa,v_acumulado);
end if;

if v_gastos>0 then
   let v_acumulado=v_acumulado+v_gastos;
   return 0,0,0,v_min,'GASTOS',v_gastos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,v_min,'GASTOS',v_gastos,v_acumulado);  
end if;

foreach
select b.id_conv_resto,d.id_adeudo,d.pago_parcial,d.importe,d.fecha_venc,d.cve_parcialidad
into v_idresto,v_idadeudo,v_parc,v_importe,v_vencimiento,v_cveparc
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref 
order by d.pago_parcial

  foreach  
  select cuenta_apl,importe into v_cuentaapl,v_monto
  from ta_17_desg_parcial 
  where id_adeudo=v_idadeudo
  order by id_desgloce

  let v_acumulado=v_acumulado+v_monto;
  return 0,0,v_cuentaapl,v_parc,'CONVENIO',v_monto,v_acumulado with resume;
  insert into tmp_totalesconv values(0,0,v_cuentaapl,v_parc,'CONVENIO',v_monto,v_acumulado);
  end foreach;

execute procedure admin_intereses_22(v_idresto,v_vencimiento,v_parc,v_cveparc) into v_intereses;
let v_recargos=0;
if today>v_vencimiento then
   execute procedure admin_recargos_20((v_importe+v_intereses),v_vencimiento) into v_recargos;
end if;

if v_recargos>0 then
   let v_acumulado=v_acumulado+v_recargos;
   return 0,0,v_ctarec,v_parc,'RECARGOS',v_recargos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctarec,v_parc,'RECARGOS',v_recargos,v_acumulado);
end if;

if v_intereses>0 then
   let v_acumulado=v_acumulado+v_intereses;
   return 0,0,v_ctaint,v_parc,'INTERESES',v_intereses,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctaint,v_parc,'INTERESES',v_intereses,v_acumulado);
end if;

end foreach;

END FUNCTION
;

create procedure "pgcabrer".spd_11_conv_mercados(p_merc int,p_mesh int,p_axoh int)
    returning   varchar(100) as nombre,
                varchar(25) as local, 
                money(18,2) as adeudo_local,
                money(18,2) as recargos_local,
                money(18,2) as multa_local,
                money(18,2) as gastos_local,
                money(18,2) as adeudo_total,
                varchar(25) as convenio,
                money(18,2) as valor_convenio,
                varchar(50) as estatus_convenio,
                int as parcialides_vencidas,
                money(18,2) as adeudo_vencido_convenio,
                int as parcialides_pagadas,
                money(18,2) as total_pagado_convenio,
                int as parcialides_saldos, 
                money(18,2) as saldo_convenio;

-- tomar el procedimeinto spd_adeudomerc como base
define v_estatus smallint;
define v_id_local,v_id,vid,p_licencia,p_idlicencia,p_bloqueado,p_idgiro,v_idgiro integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra1,v_let char(3);
define p_vigente char(1); 
define v_bloque1,v_blq char(2);
define v_dillic,v_dilloc char(1);
define p_txtbloqueado char(30);
define v_domicilio char(40);
define v_adicional,v_aprloc,v_aprlic, c_convenio char(20);
define v_superficie decimal(10,2);
define v_adeudo money(15,2);
define v_recargos,vactualizacion money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_descuento,v_renta money(15,2);
define v_nom_mercado char(30);
define v_descripcion,  v_nombre char(60);
define v_folio integer;
define v_per smallint;
define v_aid_local,v_follic,v_folloc integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec, v_fecha_alta date;
define v_porc decimal(10,2);
define v_vigencia, v_convenio char(1);
define v_id_localp,v_lic integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo,v_merc,v_mer smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc,v_cvecuo integer;
define v_total money(15,2);
define v_cat,v_ofna smallint;
define v_sec char(2);
define v_loc,v_idlic integer;
define v_licencia,v_licdesc char(200);
define p_actividad varchar(130);
define p_propietario varchar(80);
define p_giro,v_giro varchar(96);

define vpropietario varchar(92);
define vcalle varchar(80);
define vnumext,vnumint varchar(10);
define vrecaudadora,vzona,vaxo_desde_ade,vmes_desde_ade int;
define vderechos,vanuncios,vimpresos,vrecargos,vmultas,vgastos,vtotal,vfvlicencias,vfvanuncios dec(14,2);

define c_valor_convenio, c_adeudo_vencido_convenio, c_total_pagado_convenio, c_saldo_convenio money(18,2);
define c_cantidad_total, c_pagos, c_adeudosvenciados, c_adeudoscorriente, c_saldo money(18,2);
define c_estatus_convenio varchar(50);
define c_tipo, c_subtipo, c_parcialides_vencidas, c_numero, c_axo, c_parcpag, c_parcadeven, c_parcadecorriente, c_parcsaldo int;
define c_letras char(3); 

let v_axocalc=0; 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_nom_mercado='';
let v_estatus=0;
let v_convenio='';
let v_descripcion='';
let v_licencia='';
let v_renta=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_merc=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_mesmin=0;
let v_axomin=0;
let v_idlic=0;
let p_idgiro=0;

begin
    on exception in (-958)
       delete from localesconvenios;
    end exception;
create temp table localesconvenios( 
 tid_local  	integer,		--
 tofna		smallint,
 tmerc		smallint,
 tcat		smallint,
 tsec		char(2),
 tlocal		integer,
 tletra		char(3),
 tbloq		char(2),
 tmesdesde	smallint,		-- 
 taxodesde	smallint,		-- 
 tmeshasta	smallint,		-- 
 taxohasta	smallint,		--
 tnombre	char(100),		-- 
 tdomicilio	char(40),		--
 tadicional	char(20),  	-- 
 tsuperficie	decimal(10,2),	-- 
 tadeudo	money(15,2),	-- 
 trecargos	money(15,2),	-- 
 tmulta	money(15,2),	--
 tgastos	money(15,2),	--
 ttotal	money(15,2),	--
 tdescuento	money(15,2),	-- 
 tnombremercado	char(30),		--
 testatus		smallint,		--
 tmensaje	char(60),
 tfalta date,
 trenta money(15,2),
 tletras char(3),
 tnumero int,
 taxo int, 
 tvalor_convenio money(18,2),
 testatus_convenio varchar(50),
 tparcialides_vencidas int,
 tadeudo_vencido_convenio money(18,2),
 tparcialides_pagadas int,
 ttotal_pagado_convenio money(18,2),
 tparcialides_corriente int,
 tadeudo_corriente_convenio money(18,2),
 tparcialides_saldos int,
 tsaldo_convenio money(18,2))  with no log;		
end;

    -- obtiene los datos generales
foreach
     select id_local,oficina,num_mercado,categoria,seccion,local,letra_local,bloque
	 into vid,v_ofna,v_mer,v_cat,v_sec,v_loc,v_let,v_blq 
     from ta_11_locales  where num_mercado=p_merc 
     order by oficina,num_mercado,categoria,seccion,local,letra_local,bloque
     if v_let is null then
        let v_letra1='';
     else
        let v_letra1=v_let;
     end if;
     if v_blq is null then
        let v_bloque1='';
     else
        let v_bloque1=v_blq;
     end if;

         select c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
         c.num_mercado,c.fecha_alta,c.clave_cuota
         into     v_id_local,v_desc,v_nombre,v_domicilio,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado,v_merc,v_fecha_alta,v_cvecuo
         from    ta_11_locales c,ta_11_mercados e
         where c.id_local=vid
	     and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado
	     group by c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
          c.num_mercado,c.fecha_alta,c.clave_cuota;

         let v_per=0;
         let v_porc=0;

         if v_desc is null then
            let v_desc=0;
         end if;

         if  v_vigencia<>'A' then
             let v_estatus=4;
             let v_descripcion='LOCAL DADO DE BAJA';
         else
         if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and ((axo=p_axoh and periodo<=p_mesh) or (axo<p_axoh))) then 	
            let v_estatus=5;
            let v_descripcion='LOCAL AL CORRIENTE DE PAGOS';
         else 
            let v_recacum=0;
 
         -- para sacar el a�o minimo
         select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;

         -- para sacar el mes minimo       
         select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

         -- para obtener los datos de multa y gastos
         select nvl(max(importe_multa),0),nvl(count(folio),0), nvl(sum(importe_gastos),0)  
         into     v_multa,v_folio,v_gastos
         from    ta_15_apremios a  
         where modulo=11 and control_otr=v_id_local and vigencia='1' and clave_practicado='P';

         -- calcula la renta
         execute procedure spd_11_calc_renta(year(today),v_cat,v_sec,v_cvecuo,v_superficie,v_mer,1) into v_renta;

         -- todos los adeudos pendientes hasta mes actual
         let v_adeudo=0;
         let v_recargos=0;
         foreach
         select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
         into     v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
         from    ta_11_adeudo_local a,ta_11_fecha_desc b 
         where id_local=v_id_local
                   and ((a.axo=p_axoh and a.periodo<=p_mesh) or (a.axo<p_axoh)) 
                   and b.mes=month(today)
                   order by axo,periodo
         if v_merc=214 then
            let v_impcalc=(v_aimporte*(100-v_desc))/100;
         else
            let v_impcalc=v_aimporte;
         end if;
  
         let v_meshst=v_aperiodo;
         let v_axohst=v_aaxo;  

         -- obtiene el porcentaje de recargos
         if v_merc <>214 then 	
            if today>=v_fecha_rec then
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
            else
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
            end if;
         else 
            if v_aperiodo=1 then let v_primermes=1;
            else if v_aperiodo=2 then let v_primermes=4;
            else if v_aperiodo=3 then let v_primermes=7;
            else if v_aperiodo=4 then let v_primermes=10;
            else let v_primermes=0;
            end if;
            end if;
            end if;
            end if;

            if v_primermes=month(today) then
               if today>=v_fecha_rec then
                  select sum(porcentaje_mes) into v_porc from ta_12_recargos
                  where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                               (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
               else
                  select sum(porcentaje_mes) into v_porc from ta_12_recargos
                  where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                               (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
               end if;
            else
               select sum(porcentaje_mes) into v_porc from ta_12_recargos
               where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
            end if;
         end if;

         if  v_porc is null then
             let v_porc=0;
         end if;

         if  v_folio = 0 then
             if v_porc > 100 then
                let v_recacum=trunc(v_impcalc*100)/100;
             else
                let v_recacum=trunc(v_impcalc*v_porc)/100;
             end if;
         else
             if v_porc > 250 then
                let v_recacum=trunc(v_impcalc*250)/100;
             else
                let v_recacum=trunc(v_impcalc*v_porc)/100;
             end if;
         end if;

         let v_recargos=v_recargos+v_recacum;
	
         if v_merc<>214 then
            if v_aaxo=year(today) and v_aperiodo=month(today) then
               if today>v_fecha_desc then
                  let v_adeacum=v_aimporte;
               else
                  let v_adeacum=v_aimporte-(v_aimporte*.10);
                  let v_descuento=v_aimporte*.10;
               end if;
            else
               let v_adeacum=v_aimporte;
            end if;
         else
            let v_adeacum=v_impcalc;
            let v_descuento=v_descuento+(v_aimporte-v_impcalc);
         end if;

         let v_adeudo=v_adeudo+v_adeacum;

         if  v_bloqueo=1 then
             let v_convenio='S'; 
             let v_estatus=0; -- ANTES ESTATUS 3
             let v_descripcion='LOCAL CON ADEUDO CONVENIADO';
         else
             let v_convenio='N';
             let v_estatus=0;
             let v_descripcion='LOCAL CON ADEUDO';
         end if;
         end foreach;
        end if;
        end if;
 
     let v_total=v_adeudo+v_recargos+v_multa+v_gastos;


     let c_letras=''; 
     let c_numero=0;
     let c_axo=0; 
     let c_cantidad_total=0; 
     let c_estatus_convenio=''; 
     let c_parcadeven=0;
     let c_adeudosvenciados=0; 
     let c_parcpag=0; 
     let c_pagos=0; 
     let c_parcadecorriente=0; 
     let c_adeudoscorriente=0;
     let c_convenio='';
     let c_parcsaldo=0; 
     let c_saldo=0;
     if v_convenio='S' then 
        foreach
          select cd.tipo,cd.subtipo,cd.letras_exp,cd.numero_exp,cd.axo_exp, cr.cantidad_total
         ,nvl((select count(p.id_conv_resto) from ta_17_conv_pagos p where p.id_conv_resto=cr.id_conv_resto and p.fecha_pago<=today ),0) 
         ,nvl((select sum(pi.importe_pago) from ta_17_conv_pagos pi where pi.id_conv_resto=cr.id_conv_resto and pi.fecha_pago<=today ),0) 
         ,nvl((select count(ad.id_conv_resto) from ta_17_adeudos_div ad where ad.id_conv_resto=cr.id_conv_resto and ad.fecha_venc<today and ad.clave_pago is null),0) 
         ,nvl((select sum(adi.importe) from ta_17_adeudos_div adi where adi.id_conv_resto=cr.id_conv_resto and adi.fecha_venc<today and adi.clave_pago is null),0) 
         ,nvl((select count(adv.id_conv_resto) from ta_17_adeudos_div adv where adv.id_conv_resto=cr.id_conv_resto and adv.fecha_venc>=today and adv.clave_pago is null),0) 
         ,nvl((select sum(advi.importe) from ta_17_adeudos_div advi where advi.id_conv_resto=cr.id_conv_resto and advi.fecha_venc>=today and advi.clave_pago is null),0)
         ,nvl((select count(adv.id_conv_resto) from ta_17_adeudos_div adv where adv.id_conv_resto=cr.id_conv_resto and adv.clave_pago is null),0) 
         ,nvl((select sum(advi.importe) from ta_17_adeudos_div advi where advi.id_conv_resto=cr.id_conv_resto and advi.clave_pago is null),0)
         ,(case when
         (select count(ad.id_conv_resto) from ta_17_adeudos_div ad where ad.id_conv_resto=cr.id_conv_resto and ad.fecha_venc<today and ad.clave_pago is null)=0 
         then 'CONVENIO AL CORRIENTE' ELSE 'CONVENIO CON PARC. VENCIDAS' END )
         into c_tipo, c_subtipo, c_letras, c_numero, c_axo, c_cantidad_total, c_parcpag, c_pagos, c_parcadeven, c_adeudosvenciados, c_parcadecorriente, 
              c_adeudoscorriente, c_parcsaldo, c_saldo, c_estatus_convenio
         from ta_17_conv_d_resto cr
           inner join ta_17_conv_diverso cd on cd.id_conv_diver = cr.id_conv_diver
           inner join ta_17_referencia r on r.id_conv_resto=cr.id_conv_resto 
         where r.id_referencia=v_id_local and cr.vigencia='A' and r.modulo=11
         order by 1,2,3,4,5
       end foreach;
     end if;

     if v_estatus=0 then
       insert into localesconvenios values(v_id_local, v_ofna, v_merc, v_cat, v_sec, v_loc, v_letra1, v_bloque1, v_mesmin, v_axomin, v_meshst,
		    v_axohst, v_nombre, v_domicilio, v_adicional, v_superficie, v_adeudo, v_recargos,
		    v_multa, v_gastos, v_total, v_descuento, v_nom_mercado, v_estatus, v_descripcion, v_fecha_alta, v_renta,
            c_letras, c_numero, c_axo, c_cantidad_total, c_estatus_convenio, c_parcadeven, c_adeudosvenciados, c_parcpag, c_pagos, c_parcadecorriente, c_adeudoscorriente,
            c_parcsaldo, c_saldo); 
     end if;	
end foreach;

foreach
select tid_local, tofna, tmerc, tcat, tsec, tlocal, tletra, tbloq, tmesdesde, taxodesde, tmeshasta, taxohasta, tnombre, tdomicilio, tadicional, tsuperficie,
       tadeudo, trecargos, tmulta, tgastos, ttotal, tdescuento, tnombremercado, testatus, tmensaje, tfalta, trenta, tletras, tnumero, taxo, 
       tvalor_convenio, testatus_convenio, tparcialides_vencidas, tadeudo_vencido_convenio, tparcialides_pagadas, ttotal_pagado_convenio, tparcialides_saldos, tsaldo_convenio
into v_id_local,v_ofna, v_merc, v_cat, v_sec, v_loc, v_letra1, v_bloque1, v_mesmin, v_axomin, v_meshst, v_axohst, v_nombre, v_domicilio, v_adicional, v_superficie, v_adeudo, v_recargos,
	 v_multa, v_gastos, v_total, v_descuento, v_nom_mercado, v_estatus, v_descripcion, v_fecha_alta, v_renta,
     c_letras, c_numero, c_axo, c_cantidad_total, c_estatus_convenio, c_parcadeven, c_adeudosvenciados, c_parcpag, c_pagos, c_parcsaldo, c_saldo
from localesconvenios order by tofna, tmerc, tcat, tsec, tlocal, tletra, tbloq 
if c_numero >0 then
   let c_convenio=(c_letras||'-'||c_numero||'-'||c_axo);
else
   let c_convenio='';
end if;

return v_nombre, (v_ofna||'-'||v_merc||'-'||v_cat||'-'||v_sec||'-'||v_loc||'-'||v_letra1||'-'||v_bloque1), v_adeudo, v_recargos,
	 v_multa, v_gastos, v_total, c_convenio, c_cantidad_total, c_estatus_convenio, c_parcadeven, c_adeudosvenciados, c_parcpag, c_pagos, c_parcsaldo, c_saldo  
with resume;
end foreach;

end procedure;

CREATE PROCEDURE "informix".admin_adeudos_detalle_25( par_Tabla Char(2), par_Control Char(10), pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_25
#  Descripcion:      Interfaz de consulta de detalle para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros par_Tabla     = Rubro de ingreso
#  de entrada:      par_Control   = Dato de Control del registro
#                   pref   = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning  Integer as Rubro,
Integer as Concepto,
Integer as Cuenta_Aplicacion,
VarChar(30) as Referencia,
VarChar(120) as Descripcion,
Money(12,2) as Monto,
Money(12,2) as Acumulado;

define v_tipo_var Char(1);              
define v_id_34_datos, v_id_control_req                                                      Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas    Money(12,2);
define v_porcentaje_multa                                                                   Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           Money(12,2);
define v_aso_mes_pago                                                                       Date;
define v_Axo, v_Mes, Axo_v, Mes_v, Dia_v                                                    Integer;
define v_mensaje_proc                                                                       varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                          varchar(7);
define v_contador                                                                           Smallint;
define v_ref char(7);
--****************************************************************************************************************************************** ctas de aplicacion
define v_cta_multas, v_cta_dscto_multas, v_cta_gastos                                       Integer;
define v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza                             Integer;
define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza                                   Integer;
define v_cta_rcgos_ade, v_cta_rcgos_exced                                                   Integer;
define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced                                         Integer;
define v_tipo_obligacion                                                                    Char(50);
define v_concepto                                                                           VarChar(100);
--******************************************************************************************************************************************
-- adicionado 18/12/2019 para obtener id de rubro de ingreso
define v_id_unidad int;
define v_cve_unidad, v_cve_operatividad char(1);
define v_descripcion varchar(100);

begin
    on exception in (-958)
delete from tmp_total_otras_oblig;
    end exception;
create temp table tmp_total_otras_oblig(
rubro int,
concepto int,
cuenta int,
referencia varchar(30),
descripcion varchar(120),
monto money(14,2),
acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
delete from tmp_detalle_otras_oblig;
    end exception;
create temp table tmp_detalle_otras_oblig(
control_contrato int,
aso_mes_pago char(7),
ctrol_operacion int,
tipo_movto char(1) ) with no log;
end;

SELECT Year(fechalimite), Month(fechalimite), Day(fechalimite)  INTO Axo_v, Mes_v, Dia_v
FROM t34_fechalimite
WHERE cve_tab = par_tabla
AND Month(fechalimite) = Month(Current)  AND Year(fechalimite) = Year(Current);

if Day(Current) <= Dia_v then
if Mes_v = 1 then
Let Mes_v = 12;
        Let Axo_v = Axo_v - 1;
    else
        Let Mes_v = Mes_v - 1;
    end if;
end if;

EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  

if trim(pref)='' then
let v_ref=9999 || '-' || 12;
else
let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;

let v_id_34_datos = 0;
Let v_id_unidad = 0;
if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
    SELECT a.id_34_datos, a.id_unidad  INTO v_id_34_datos, v_id_unidad  FROM t34_datos A    WHERE a.cve_tab = par_Tabla and a.control = par_Control;

-- OBTENER EL RUBRO DE INGRESO
Let v_cve_unidad = '';
Let v_cve_operatividad = '';
Let v_descripcion = '';
SELECT cve_unidad, cve_operatividad, descripcion INTO v_cve_unidad, v_cve_operatividad, v_descripcion  FROM t34_unidades  WHERE id_34_unidad = v_id_unidad;

    -- VARIABLES A 0
    Let v_concepto = '';
    Let v_cta_multas = 0;
    Let v_cta_dscto_multas = 0;
    Let v_cta_gastos = 0;
    Let v_cta_adeudos_act = 0;
    Let v_cta_adeudos_dev = 0;
    Let v_cta_adeudos_reza = 0;
    Let v_cta_rcgos_ade = 0;
    Let v_cta_dcto_rcgos_ade = 0;

    Let v_tipo_var = '';
    Let v_tot_multas = 0;
    Let v_porcentaje_multa = 0;
    Let v_tot_dscto_multas = 0;

Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_tot_gastos = 0;
    Let v_acumulado = 0;
    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    Let v_contador = 0;

    -- APREMIOS
    FOREACH
    SELECT id_control, importe_multa,     importe_gastos, porcentaje_multa  
    INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_porcentaje_multa
    FROM ta_15_apremios
    WHERE modulo = 34  AND control_otr = v_id_34_datos  AND vigencia = "1" AND clave_practicado = "P"
    Order By id_control

    Let v_tot_multas = v_importe_multa;
    if v_porcentaje_multa < 100 then
Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
        Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
    else
        Let v_tot_dscto_multas = 0;
    end if;
    Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

    insert into tmp_detalle_otras_oblig values ( v_id_control_req, v_ref, 0, 'R' );
    END FOREACH;
-- TERMINA APREMIOS

    -- INICIAN PERIODOS
    FOREACH
    SELECT a.periodo, a.importe, Year(a.periodo), Month(a.periodo), a.tipo_var   INTO  v_aso_mes_pago, v_importe, v_Axo, v_Mes, v_tipo_var  
    FROM t34_pagos a, t34_status b    WHERE id_datos = v_id_34_datos  and periodo <= v_ref
    AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('V')
    ORDER BY a.periodo

insert into tmp_detalle_otras_oblig values ( v_id_34_datos, v_Axo || '-' || v_Mes, 0, 'A' );
        if v_importe > 0 then
if v_contador = 0 then
if v_tot_multas > 0 then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
Let v_concepto = 'MULTAS';
if par_Tabla = '5' then
Let v_cta_multas = 515003004;
--else
--
end if;
                    Let v_acumulado = v_acumulado + v_tot_multas;  
RETURN 0,0, v_cta_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_multas, v_acumulado with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_multas, v_acumulado );
                end if;
                if v_tot_dscto_multas <> 0 then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
Let v_concepto = 'DSCTO. MULTAS';
if par_Tabla = '5' then
Let v_cta_dscto_multas = 515043004;
--else
--
end if;
                    Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
RETURN 0,0, v_cta_dscto_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_dscto_multas, v_acumulado  with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_dscto_multas, v_acumulado );
                end if;
                if v_tot_gastos > 0 then
                    --EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
Let v_concepto = 'GASTOS';
if par_Tabla = '5' then
Let v_cta_gastos = 550620010;
--else
--
end if;
                    Let v_acumulado = v_acumulado + v_tot_gastos;  
RETURN 0,0, v_cta_gastos, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_gastos, v_acumulado  with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, v_concepto, v_tot_gastos, v_acumulado );
                end if;
                Let v_contador = 1;
            end if;

            if v_tipo_var = 'T' then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ADEUDO ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
if par_Tabla = '5' then
Let v_concepto = 'REFRENDO ACTUAL';
if v_descripcion = 'Empresas Especializadas VP' then
Let v_cta_adeudos_act = 370400000;
end if;
if v_descripcion = 'Con cobro para el usuario VP' then
Let v_cta_adeudos_act = 340500003;
end if;
if v_descripcion = 'Sin cobro para el usuario VP' then
Let v_cta_adeudos_act = 340500004;
end if;
else
Let v_concepto = 'ADEUDO ACTUAL';
if par_Tabla = '1' then
Let v_cta_adeudos_act = 353200000;
end if;
if par_Tabla = '2' then
Let v_cta_adeudos_act = 353800000;
end if;
if par_Tabla = '4' then
if v_descripcion = '1ra. Especial SP' then
Let v_cta_adeudos_act = 340400001;
end if;
if v_descripcion = '1ra. SP' then
Let v_cta_adeudos_act = 340400002;
end if;
if v_descripcion = '2da. SP' then
Let v_cta_adeudos_act = 340400003;
end if;
if v_descripcion = '3ra. SP' then
Let v_cta_adeudos_act = 340400004;
end if;
if v_descripcion = 'Otros SP' then
Let v_cta_adeudos_act = 340400005;
end if;
end if;
end if;
                Let v_acumulado = v_acumulado + v_importe;  
RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );

                SELECT sum(por_recargo)   INTO v_Importe_recargo  FROM t34_porcentajes  
                WHERE periodo_porc BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

                if v_Importe_recargo <> 0 then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'RCGO. ADEUDO' ) INTO v_cta_rcgos_ade, v_concepto;
Let v_concepto = 'RCGO. ADEUDO';
if par_Tabla = '5' then
Let v_cta_rcgos_ade = 390900000;
else
Let v_cta_rcgos_ade = 390500000;
end if;
                    Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                    Let v_acumulado = v_acumulado + v_importe_rec1;
                    RETURN 0,0, v_cta_rcgos_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec1, v_acumulado  with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec1, v_acumulado );  
EXECUTE PROCEDURE sp_desctomerc (v_id_34_datos, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 34) INTO v_importe_rec2, v_mensaje_proc;
                end if;
                if v_importe_rec2 > 0 then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. RECARGO' ) INTO v_cta_dcto_rcgos_ade, v_concepto;
Let v_concepto = 'DSCTO. RECARGO';
if par_Tabla = '5' then
Let v_cta_dcto_rcgos_ade = 390940000;
else
Let v_cta_dcto_rcgos_ade = 390540000;
end if;
                    Let v_importe_rec2 = v_importe_rec2 * -1;
                    Let v_acumulado = v_acumulado + v_importe_rec2;
                    RETURN 0,0, v_cta_dcto_rcgos_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec2, v_acumulado  with resume;
insert into tmp_total_otras_oblig values ( 0,0, v_cta_dcto_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec2, v_acumulado );
                end if;
            else
if v_tipo_var = 'F' then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'F', 'FORMA' ) INTO v_cta_adeudos_act, v_concepto;
Let v_concepto = 'FORMA';
if par_Tabla = '5' then
Let v_cta_adeudos_act = 421200012;
--else
--
end if;
                    Let v_acumulado = v_acumulado + v_importe;  
RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                end if;
                if v_tipo_var = 'A' then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'A', 'AUTORIZACION ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
if par_Tabla = '5' then
Let v_concepto = 'AUTORIZACION ACTUAL';
if v_descripcion = 'Empresas Especializadas VP' then
Let v_cta_adeudos_act = 370300000;
end if;
if v_descripcion = 'Con cobro para el usuario VP' then
Let v_cta_adeudos_act = 340500001;
end if;
if v_descripcion = 'Sin cobro para el usuario VP' then
Let v_cta_adeudos_act = 340500002;
end if;
--else
end if;
                    Let v_acumulado = v_acumulado + v_importe;  
RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                end if;
            end if;
end if;

    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    END FOREACH;
    -- TERMINAN PERIODOS
            if v_contador = 0 then
if v_tot_multas > 0 then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
Let v_concepto = 'MULTAS';
if par_Tabla = '5' then
Let v_cta_multas = 515003004;
--else
--
end if;
                    Let v_acumulado = v_acumulado + v_tot_multas;  
RETURN 0,0, v_cta_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'MULTAS ', v_tot_multas, v_acumulado with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, 'MULTAS ', v_tot_multas, v_acumulado );
                end if;
                if v_tot_dscto_multas <> 0 then
--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
Let v_concepto = 'DSCTO. MULTAS';
if par_Tabla = '5' then
Let v_cta_dscto_multas = 515043004;
--else
--
end if;
                    Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
RETURN 0,0, v_cta_dscto_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado  with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado );
                end if;
                if v_tot_gastos > 0 then
                    --EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
Let v_concepto = 'GASTOS';
if par_Tabla = '5' then
Let v_cta_gastos = 550620010;
--else
--
end if;
                    Let v_acumulado = v_acumulado + v_tot_gastos;  
RETURN 0,0, v_cta_gastos, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'GASTOS ', v_tot_gastos, v_acumulado  with resume;
                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, 'GASTOS ', v_tot_gastos, v_acumulado );
                end if;
            end if;

end if;
end procedure;

CREATE PROCEDURE "informix".admin_adeudos_detalle_18 ( p_tipo char(1), p_numero int, pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_18
#  Descripcion:      Interfaz de consulta de detalle para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:      p_numero   = Numero de Contrato
#                   pref   = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning Integer as Rubro,
                Integer as Concepto,
                Integer as Cuenta_Aplicacion,
                VarChar(30) as Referencia,
                VarChar(120) as Descripcion,
                Money(12,2) as Monto,
                Money(12,2) as Acumulado;
               
define v_control_contrato, v_ctrol_operacion, v_id_control_req Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas    Money(12,2);
define v_porcentaje_multa                                                                   Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           Money(12,2);
define v_aso_mes_pago                                                                       Date;
define v_Axo, v_Mes, v_Axo_pp, v_Mes_pp Integer;
define v_mensaje_proc                                                                       varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                          varchar(7);
define v_contador                                                                           Smallint;
define  v_ref char(7);
define v_importe_Dscto_Tot, v_importe_Dscto Money(12,2);  -- adicionado por GMG 31/12/2019 para descuento por pronto pago
define v_ctrol_recolec int;  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion
define v_cve_recolec char(1);  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion
define v_cta_apl int;  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion
define v_cta_descrip varchar(50);  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

begin
on exception in (-958)
delete from tmp_totalaseo;
    end exception;
create temp table tmp_totalaseo(
rubro int,
concepto int,
cuenta int,
referencia varchar(30),
descripcion varchar(120),
monto money(14,2),
acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
delete from tmp_detalleaseo;
    end exception;
create temp table tmp_detalleaseo(
control_contrato int,
aso_mes_pago char(7),
ctrol_operacion int,
tipo_movto char(1) ) with no log;
end;

if trim(pref)='' then
let v_ref=9999 || '-' || 12;
else
let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;
Let v_Axo_pp = substr(v_ref,1,4);
if v_Axo_pp = 9999 then
Let v_Axo_pp = Year(today);
end if;
Let v_Mes_pp = substr(v_ref,6,2);

Let v_ctrol_recolec = 0;
Let v_cve_recolec = '';
Let v_cta_apl = 0;
Let v_cta_descrip = '';

let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
SELECT a.control_contrato, ctrol_recolec  INTO  v_control_contrato, v_ctrol_recolec   FROM ta_16_contratos a, ta_16_tipo_aseo b
    WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

select cve_recolec into v_cve_recolec  from ta_16_unidades where ctrol_recolec = v_ctrol_recolec;

    -- VARIABLES A 0
    Let v_tot_multas = 0;
    Let v_porcentaje_multa = 0;
    Let v_tot_dscto_multas = 0;

    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_tot_gastos = 0;
    Let v_acumulado = 0;
    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    Let v_contador = 0;

    -- APREMIOS
    Let v_id_control_req = 0;
    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_Axo = 0;
    Let v_Mes = 0;
    foreach
    SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
    INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
    FROM ta_15_apremios
    WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
    Order By id_control
                               
    Let v_tot_multas = v_importe_multa;
    if v_porcentaje_multa < 100 then
Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
        Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
    else
Let v_tot_dscto_multas = 0;
    end if;
    Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

insert into tmp_detalleaseo values ( v_id_control_req, v_ref, 0, 'R' );
    end foreach;
    -- TERMINA APREMIOS

    -- INICIAN PERIODOS
Let v_importe_Dscto_Tot = 0;
Let v_importe_Dscto = 0;
    foreach
    SELECT  aso_mes_pago,  Year(aso_mes_pago), Month(aso_mes_pago), importe, ctrol_operacion
    INTO     v_aso_mes_pago, v_Axo, v_Mes, v_importe, v_ctrol_operacion
    FROM ta_16_pagos
    WHERE Control_Contrato = v_control_contrato  
    AND aso_mes_pago <= v_ref
    AND status_vigencia = 'V'  Order By aso_mes_pago, ctrol_operacion

insert into tmp_detalleaseo values ( v_control_contrato, v_Axo || '-' || v_Mes, v_ctrol_operacion, 'A' );

        if v_importe > 0 then

if v_contador = 0 then
if v_tot_multas > 0 then
Let v_acumulado = v_acumulado + v_tot_multas;
                    RETURN 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado                     with resume;
                    insert into tmp_totalaseo values ( 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado );
end if;
                if v_tot_dscto_multas <> 0 then
Let v_acumulado = v_acumulado + v_tot_dscto_multas;
                    RETURN 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado        with resume;
                    insert into tmp_totalaseo values ( 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado );
                end if;
                if v_tot_gastos > 0 then
Let v_acumulado = v_acumulado + v_tot_gastos;
                    RETURN 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado                      with resume;
                    insert into tmp_totalaseo values ( 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
                end if;
            end if;

            if v_ctrol_operacion = 6 then
if Year(v_aso_mes_pago) < Year(Current) then
-- rezago
Let v_cta_apl = 250130000;
Let v_cta_descrip = 'Rezago del Adeudo ';
else
-- actual
if (v_cve_recolec = 'N') or (v_cve_recolec = 'M') or (v_cve_recolec = 'T') or (v_cve_recolec = 'O') then
if v_cve_recolec = 'N' then -- N, TONELADA
Let v_cta_apl = 180000001;
end if;
if v_cve_recolec = 'M' then -- M,MT3
Let v_cta_apl = 180000002;
end if;
if v_cve_recolec = 'T' then -- T,TAMBOS
Let v_cta_apl = 180000003;
end if;
if v_cve_recolec = 'O' then -- O,BOLSA 60 X 65 CM
Let v_cta_apl = 180000004;
end if;
else
Let v_cta_apl = 180000003;
end if;
Let v_cta_descrip = 'Actual de Adeudo ';
                end if;

Let v_acumulado = v_acumulado + v_importe;
                RETURN 0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado                           with resume;
                insert into tmp_totalaseo values ( 0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado );

                SELECT sum(porc_recargo)   INTO v_Importe_recargo
                FROM ta_16_recargos
                WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

if today >= mdy(01,01,2020) and today <= mdy(02,29,2020) then  -- adicionado para el 10% p/pp
if (v_Axo_pp = Year(today)) and (v_Mes_pp = 12) then
Let v_importe_Dscto = (v_importe * .10);  -- para el descuento general del 10% Dscto. por pronto pago
Let v_importe_Dscto = v_importe_Dscto * -1;

Let v_acumulado = v_acumulado + v_importe_Dscto;
RETURN 0, 180000009, get_odoo_cta( 180000009 , 18), v_Axo || '/' || v_Mes, '10% Dscto p/pp ', v_importe_Dscto, v_acumulado with resume;
insert into tmp_totalaseo values ( 0,0, 180000009, v_Axo || '/' || v_Mes, '10% Dscto p/pp ', v_importe_Dscto, v_acumulado );
end if;
end if;
            else
if Year(v_aso_mes_pago) < Year(Current) then
-- rezago
Let v_cta_apl = 250230000;
Let v_cta_descrip = 'Rezago del Excedente ';
                else
-- actual
if (v_cve_recolec = 'N') or (v_cve_recolec = 'M') or (v_cve_recolec = 'T') or (v_cve_recolec = 'O') then
if v_cve_recolec = 'N' then -- N, TONELADA
Let v_cta_apl = 180000001;
end if;
if v_cve_recolec = 'M' then -- M,MT3
Let v_cta_apl = 180000002;
end if;
if v_cve_recolec = 'T' then -- T,TAMBOS
Let v_cta_apl = 180000007;
end if;
if v_cve_recolec = 'O' then -- O,BOLSA 60 X 65 CM
Let v_cta_apl = 180000008;
end if;
else
Let v_cta_apl = 180000007;
end if;
Let v_cta_descrip = 'Actual del Excedente ';
                end if;

Let v_acumulado = v_acumulado + v_importe;
                RETURN 0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado                           with resume;
                insert into tmp_totalaseo values ( 0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado );

                SELECT sum(porc_recargo)   INTO v_Importe_recargo
                FROM ta_16_recargos
                WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE);
            end if;
            if v_Importe_recargo <> 0 then
Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                Let v_acumulado = v_acumulado + v_importe_rec1;
                RETURN 0,0, 390200000, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado                                with resume;
                insert into tmp_totalaseo values ( 0,0, 390200000, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado );
                EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16)
                INTO v_importe_rec2, v_mensaje_proc;
            end if;
            if v_importe_rec2 > 0 then
Let v_importe_rec2 = v_importe_rec2 * -1;
                Let v_acumulado = v_acumulado + v_importe_rec2;
                RETURN 0,0, 390240000, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado                                with resume;
                insert into tmp_totalaseo values ( 0,0, 390240000, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado );
            end if;

            Let v_contador = 1;
end if;

        Let v_importe = 0;
Let v_Importe_recargo = 0;
        Let v_importe_rec1 = 0;
        Let v_importe_rec2 = 0;
    end foreach;
-- TERMINAN PERIODOS

    if v_contador = 0 then
if v_tot_multas > 0 then
Let v_acumulado = v_acumulado + v_tot_multas;
            RETURN 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado                     with resume;
            insert into tmp_totalaseo values ( 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado );
        end if;
        if v_tot_dscto_multas <> 0 then
Let v_acumulado = v_acumulado + v_tot_dscto_multas;
            RETURN 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado        with resume;
            insert into tmp_totalaseo values ( 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado );
        end if;
        if v_tot_gastos > 0 then
Let v_acumulado = v_acumulado + v_tot_gastos;
            RETURN 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado                      with resume;
            insert into tmp_totalaseo values ( 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
        end if;

if today >= mdy(01,01,2020) and today <= mdy(02,29,2020) then
Let v_importe_Dscto_Tot = v_importe_Dscto_Tot + (v_importe * .10);  -- para el descuento general del 10% Dscto. por pronto pago
end if;

    end if;

end if;
end procedure;

CREATE FUNCTION "informix".admin_cancela_14(p_idcobro int, p_foliorbo varchar(30), p_cajero varchar(08))
                 RETURNING int as sbien, varchar(255) as mensage;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa, par_caja      varchar(30);
define vcvepago     int;
define v_axop,par_control     int;
define v_axof, par_rec,v_idusu     int;
define par_fecp   date;


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en cancelacion de Panteones ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let par_control=0;
let v_idusu=0;

  select nvl(id_regmodulo,0), fecha,id_rec,caja, axodesde,axohasta
  into par_control, par_fecp, par_rec, par_caja,v_axop,v_axof 
  from ta_12_recibos  
--  where fecha>mdy(10,01,2013) and operacion=p_idcobro and cvepago='P' and foliorecibo=p_foliorbo;
  where operacion=p_idcobro and cvepago='P' and foliorecibo=trim(p_foliorbo);

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;


if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if par_control>0 then
    BEGIN WORK;
  select control_id into vcvepago from ta_13_pagosrcm  
  where control_rcm=par_control and fecing=par_fecp and recing=par_rec and cajing=par_caja and opcaja=p_idcobro;

   update ta_13_adeudosrcm set  vigencia='V',id_pago=0
     where control_rcm=par_control  and vigencia='P' and id_pago=vcvepago;

   update ta_13_descrec
   set vigencia='V',
       fec_pag=null, id_rec=0,caja='', 
       operac=0 
    where id_folio =par_control and  fec_pag=par_fecp and id_rec=par_rec and
            caja=par_caja and operac=p_idcobro and vigencia='P';

    select nvl((min(axo_adeudo)-1),0) into v_axop from ta_13_adeudosrcm
    where control_rcm=par_control and vigencia='V';

   if v_axop>0 then 
    update ta_13_descpens set vigencia='V' 
    where control_rcm=par_control and axo_descto between v_axop and v_axof and vigencia='P';
   end if;

   if v_axop=0 then 
      let v_axop=year(today);
   end if;

    update ta_13_datosrcm set axo_pagado=v_axop
     where control_rcm=par_control;
   
  update ta_13_pagosrcm  set vigencia='C', usuario=0, fecha_mov=today
  where control_rcm=par_control and fecing=par_fecp and recing=par_rec and cajing=par_caja and opcaja=p_idcobro;
   let vcvepago=dbinfo("sqlca.sqlerrd1");

    update ta_12_recibos set cvepago='C', fecha_act=today, id_usuario = v_idusu
    where fecha=par_fecp and operacion=p_idcobro and foliorecibo=trim(p_foliorbo);

   COMMIT WORK;	
   return 0,'Pago Cancelado '|| vcvepago;
else
   return 1,'Pago No encontrado o no Vigente ';

end if;
END FUNCTION;

CREATE FUNCTION "informix".admin_cancela_13(pidcobro integer,pfolio varchar(30),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_cancela_13
#  Descripcion:      Interfaz de cancelacion del pago de Mercados para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            06 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus,v_statmerc 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag,v_seccion char(2);
define v_cvepago,v_categoria,v_clave_cuota,v_mercado int;
define v_id_modulo    int;
define v_id,v_cvecuenta   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta,v_col,v_obra int;
define v_mes,v_iduser,varpar,v_axop,v_mesp int;
define v_adeudo_id,v_cvecanc int;
define v_res,v_dsd,v_hst int; 
define v_res1 varchar(100);
define v_resto,v_idref,v_pagpar,v_axod,v_mesd,v_axoh,v_mesh,v_cta int;
define v_importe,v_impp,vrenta money(14,2);
define v_superficie decimal(7,2);
define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de Mercados ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Mercados)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,mesdesde,axodesde,meshasta,axohasta 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_mesd,v_axod,v_mesh,v_axoh
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 11 then
   let v_leyenda = 'EL RECIBO NO ES POR MERCADOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

-- obtiene el datos para calcular la renta
select categoria,seccion,clave_cuota,superficie,num_mercado into
v_categoria,v_seccion,v_clave_cuota,v_superficie,v_mercado
from ta_11_locales where id_local=v_id;

BEGIN WORK;
-- cancela recibo
update ta_12_recibos set cvepago='C', fecha_act=today,id_usuario=v_iduser 
where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and 
operacion = pidcobro and foliorecibo=trim(pfolio);

foreach
select axo,periodo,importe_pago into v_axop,v_mesp,v_impp from  ta_11_pagos_local 
where fecha_pago=v_fecha_pag and oficina_pago=v_rec_pag and caja_pago=v_caja_pag 
and operacion_pago=pidcobro and id_local=v_id

-- si el periodo pagado es del a�o actual calcula la renta del local
if v_axop=year(today) then
   execute procedure spd_11_calc_renta(v_axop,v_categoria,v_seccion,v_clave_cuota,v_superficie,v_mercado,1) into vrenta;
   -- inserta los periodos pagados como adeudos 
   insert into ta_11_adeudo_local (id_adeudo_local,id_local,axo,periodo,importe,fecha_alta,id_usuario) 
   values (0,v_id,v_axop,v_mesp,vrenta,current,v_iduser);
else
   -- inserta los periodos pagados como adeudos
   insert into ta_11_adeudo_local (id_adeudo_local,id_local,axo,periodo,importe,fecha_alta,id_usuario) 
   values (0,v_id,v_axop,v_mesp,v_impp,current,v_iduser);  
end if;
end foreach;

-- borra los pagos 
delete from ta_11_pagos_local where fecha_pago=v_fecha_pag and oficina_pago=v_rec_pag 
and caja_pago=v_caja_pag and operacion_pago=pidcobro and id_local=v_id;

-- reactiva los folios vigentes de requerimientos
update ta_15_apremios set fecha_pago =null,recaudadora=0,caja='',operacion=0,vigencia='1',importe_pago=0
where  modulo=11 and control_otr=v_id and fecha_pago=v_fecha_pag and recaudadora=v_rec_pag and
caja=v_caja_pag and operacion=pidcobro;

COMMIT WORK; 

return v_estatus,v_leyenda;
end FUNCTION;

CREATE FUNCTION "informix".admin_cancela_20(pidcobro integer,pfolio varchar(30),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_pago_20
#  Descripcion:      Interfaz de cancelacion del pago de Convenios de obra publica para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            04 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_id   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta int;
define v_mes,v_iduser int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);


define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de Contratos de Obra publica' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Convenio obra publica)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,id_rec_cta 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_id_rec_cta
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 17 then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DE OBRA PUBLICA';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

if (v_id_modulo = 17) and (v_id_rec_cta  not in (16,15,11)) then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DE OBRA PUBLICA';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

BEGIN WORK;
update ta_12_recibos set cvepago='C', fecha_act=today,id_usuario=v_iduser 
where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and 
operacion = pidcobro and foliorecibo=trim(pfolio);

delete from  ta_17_pagos where  fecha_pago=v_fecha_pag and oficina_pago=v_rec_pag and
caja_pago=v_caja_pag and operacion_pago=pidcobro and id_convenio=v_id;

COMMIT WORK; 

return v_estatus,v_leyenda;
end FUNCTION;

CREATE FUNCTION "informix".admin_cancela_24(p_idcobro int, p_foliorbo varchar(30), p_cajero varchar(08))
                 RETURNING int as sbien, varchar(255) as mensage;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa, par_caja      varchar(30);
define vcvepago,v_idusu     int;
define v_axop,par_control     int;
define v_axof, par_rec     int;
define par_fecp   date;


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'admin_cancela_24 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let par_control=0;
   let v_idusu=0;

  select nvl(id_regmodulo,0), fecha,id_rec,caja, axodesde,axohasta
  into par_control, par_fecp, par_rec, par_caja,v_axop,v_axof 
  from ta_12_recibos  
--  where fecha>mdy(10,01,2013) and operacion=p_idcobro and cvepago='P' and foliorecibo=p_foliorbo;
  where operacion=p_idcobro and cvepago='P' and foliorecibo=p_foliorbo;

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;


if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if par_control>0 then
    BEGIN WORK;
 
    update ta_12_recibos set cvepago='C', fecha_act=today, id_usuario = v_idusu
    where fecha=par_fecp and operacion=p_idcobro and foliorecibo=p_foliorbo;
  
    delete from ta_13_titulos where fecha=par_fecp and id_rec=par_rec and caja=par_caja and operacion=p_idcobro;
  
COMMIT WORK;	
   return 0,'Pago Cancelado ';
else
   return 1,'Pago No encontrado o no Vigente ';

end if;
END FUNCTION;

CREATE FUNCTION "informix".admin_cancela_30(pidcobro integer,pfolio varchar(30),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_cancela_30
#  Descripcion:      Interfaz de cancelacion del pago certificadi de N/Adeudo de Mercados para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            02 Mayo 2014   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus,v_statmerc 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag,v_seccion char(2);
define v_cvepago,v_categoria,v_clave_cuota,v_mercado int;
define v_id_modulo    int;
define v_id,v_cvecuenta   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta,v_col,v_obra int;
define v_mes,v_iduser,varpar,v_axop,v_mesp int;
define v_adeudo_id,v_cvecanc int;
define v_res,v_dsd,v_hst int; 
define v_res1 varchar(100);
define v_resto,v_idref,v_pagpar,v_axod,v_mesd,v_axoh,v_mesh,v_cta int;
define v_importe,v_impp,vrenta money(14,2);
define v_superficie decimal(7,2);
define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en cancelacion Certificado de N/A de Mercados ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;
let v_cvepagorbo='';
let v_clave_cuota=0;

--Verifica el tipo de pago (Mercados)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,mesdesde,axodesde,meshasta,axohasta 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_mesd,v_axod,v_mesh,v_axoh
from ta_12_recibos where operacion = pidcobro and foliorecibo=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 11 then
   let v_leyenda = 'EL RECIBO NO ES POR MERCADOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

BEGIN WORK;
-- cancela recibo
update ta_12_recibos set cvepago='C', fecha_act=today,id_usuario=v_iduser 
where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and 
operacion = pidcobro and foliorecibo=trim(pfolio);

-- borra los pagos 
delete from ta_11_certificado where fecha=v_fecha_pag and id_rec=v_rec_pag 
and caja=v_caja_pag and operacion=pidcobro and id_local=v_id and axo=v_axod and mes=v_mesd;

COMMIT WORK; 

return v_estatus,v_leyenda;
end function;

CREATE FUNCTION "informix".admin_cancela_18 ( par_Id_Cobro Integer, par_Folio_rcbo Char(30), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    admin_cancela_18
#  Descripcion:      Interfaz de pago para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros        	par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#  de entrada:        	par_Folio_rcbo = Folio del recibo
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus int;
define v_id_usuario	int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en transaccion de Aseo Contratado ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda    	= 'CANCELACION DE RECIBO Y REACTIVACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************


if exists( SELECT a.* FROM ta_16_pagos a WHERE a.consec_operacion = par_Id_Cobro AND a.folio_rcbo = par_Folio_rcbo AND status_vigencia = 'P'  ) then

BEGIN WORK;	
               	UPDATE ta_16_pagos set
                  status_vigencia = 'V',  fecha_hora_pago = Null,  id_rec = 0,  
caja = ' ',  consec_operacion = 0,  folio_rcbo = ' ',  usuario = v_id_usuario
               	WHERE consec_operacion = par_Id_Cobro AND folio_rcbo = par_Folio_rcbo AND status_vigencia = 'P';

UPDATE ta_15_apremios SET
fecha_pago = Null, recaudadora = 0,  caja = ' ',  
operacion = 0,  importe_pago = 0,  vigencia = '1'
                       	WHERE modulo = 16 AND operacion = par_Id_Cobro;

UPDATE ta_12_recibos SET
cvepago = 'C', id_usuario = v_id_usuario
WHERE operacion = par_Id_Cobro AND foliorecibo = par_Folio_rcbo AND cvepago = 'P';

-- GRABAR DATOS EN REGISTRO DE DESCUENTO
UPDATE db_ingresos:ta_16_descrec SET 
fec_pag = Null, id_rec = Null, caja = Null, operac = Null, vigencia = 'V' 
WHERE operac = par_Id_Cobro and vigencia = 'P';

COMMIT WORK; 
else
         	let v_leyenda = 'NO EXISTE CONTRATO';
         	let v_estatus  = 1;
end if;
RETURN v_estatus,v_leyenda;

end FUNCTION;

CREATE FUNCTION "informix".admin_adeudos_detalle_20odoo(pinterface int,pcol char(10),pcalle char(10),pfol varchar(10),
pseg4 varchar(10),pseg5 varchar(10),pseg6 varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(50) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  a_colonia,a_descripcion varchar(50);
define  a_calle varchar(80);
define  a_tipoobra varchar(20);
define  a_nombreobra varchar(100);
define  a_referencia varchar(30);
define  a_pagototal,a_pagoinicial,a_pagoparcial,a_adeudo,a_monto,a_acumulado decimal(14,2);
define  a_pagos,a_parcialidad,a_restan,a_apagar,a_cuentaapl int;
define  a_vencimiento date;
define  v_id,v_ref int;

begin
    on exception in (-958)
       delete from tmp_totalesobra;
    end exception;
create temp table tmp_totalesobra(
  rubro int,
  concepto int,
  cuenta int,
  referencia int,
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

select id_convenio into v_id from ta_17_convenios
where colonia=pcol and calle=pcalle and folio=pfol;

if trim(pref)='' then
   let v_ref=1;
else
   let v_ref=pref;
end if;

foreach
execute procedure admin_adeudo_20(v_id,v_ref,3) into a_colonia,a_calle,a_tipoobra,a_nombreobra,a_pagototal,a_pagoinicial,
a_pagoparcial,a_pagos,a_adeudo,a_vencimiento,a_parcialidad,a_restan,a_apagar,a_cuentaapl,a_referencia,
a_descripcion,a_monto,a_acumulado
return 0,a_cuentaapl, get_odoo_cta( a_cuentaapl , 20),a_referencia,a_descripcion,a_monto,a_acumulado with resume;
insert into tmp_totalesobra values(0,0,a_cuentaapl,a_referencia,a_descripcion,a_monto,a_acumulado);
end foreach;

end function;

CREATE PROCEDURE "informix".del34_gen_contrato ( par_tabla Char(1), par_id_34_datos Integer, par_Axo_Fin Smallint, par_Mes_Fin Smallint, par_usuario char(10) )
{######################################################################
#  Procedimiento:    del34_gen_contrato
#  Descripcion:      Interfaz de CANCELAR CONCESION/CONTRATO de OTRAS OBLIGACIONES por modulo
#
#  Parametros        
# par_tabla = Tabla de origen
# par_id_34_datos = id del registro
# par_Axo_Fin = A�o de fin obligacion
# par_Mes_Fin = Mes de fin obligacion
# par_usuario = usuario
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
returning Integer as Status,
varchar(255) as Concepto_Status;
-----------Define las variables de retorno----------------
define v_leyenda     varchar(255);
define v_estatus int;
define v_estatus_dat char(1);
define v_contador int;
define v_id_34_stat_c int;
define v_id_34_stat_pc int;
define v_id_34_stat_cc int;
define v_id_34_stat_ac int;

define axo_actual, axo_penultimo Integer;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion del34_gen_contrato ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_leyenda     = 'No se elimino';
Let v_estatus = -1;

Let axo_actual = Year(Current);
Let axo_penultimo = axo_actual - 2;

Let v_estatus_dat = '';
Let v_contador = 0;
Let v_id_34_stat_c = 0;
Let v_id_34_stat_pc = 0;
Let v_id_34_stat_cc = 0;
Let v_id_34_stat_ac = 0;

-- VERIFICA SI EXISTE CONCESION
if exists( SELECT * FROM t34_datos WHERE id_34_datos = par_id_34_datos ) then
SELECT b.cve_stat  INTO  v_estatus_dat FROM t34_datos a, t34_status b  WHERE a.id_34_datos = par_id_34_datos  and b.id_34_stat = a.id_stat;
-- VERIFICA SI LA CONCESION ESTA VIGENTE PARA PODERSE CANCELAR
if v_estatus_dat = 'V' then
-- VERIFICA SI LA CONCESION TIENE ADEUDOS PAGADOS,PRESCRITOS � CONDONADOS DESPUES DEL PERIODO DE CANCELACION
SELECT count(*) INTO v_contador FROM t34_pagos a, t34_status b  
WHERE a.id_datos = par_id_34_datos  AND a.periodo >= par_Axo_Fin || '-' || par_Mes_Fin  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('P','S','R');
if v_contador > 0 then
Let v_estatus = -1;
Let v_leyenda = 'Tiene adeudos PAGADOS,PRESCRITOS � CONDONADOS no es posible la CANCELACION';
else
-- VERIFICA SI LA CONCESION TIENE ADEUDOS VIGENTES ANTES DEL PERIODO DE CANCELACION
Let v_contador = 0;
SELECT count(*) INTO v_contador FROM t34_pagos a, t34_status b  
WHERE a.id_datos = par_id_34_datos  AND a.periodo < par_Axo_Fin || '-' || par_Mes_Fin  AND b.id_34_stat = a.id_stat AND b.cve_stat in ('V');
if v_contador > 0 then
Let v_estatus = -1;
Let v_leyenda = 'Tiene adeudos VIGENTES antes del periodo de CANCELACION, esto no es permitido';
else
-- VERIFICA SI EL A�O DE CANCELACION ES MAYOR QUE EL A�O ACTUAL
if par_Axo_Fin > axo_actual then
Let v_leyenda = 'El A�o de Fin no puede ser Mayor al A�o Actual';
Let v_estatus = -1;
else
-- VERIFICA SI EL A�O DE CANCELACION ES 2 � MAS A�OS MENOR QUE EL A�O ACTUAL
if par_Axo_Fin <= axo_penultimo then
Let v_leyenda = 'El A�o de Fin no puede ser Menor 2 � m�s a�os que el A�o Actual';
Let v_estatus = -1;
else
-- CANCELAR CONCESION/CONTRATO
SELECT id_34_stat  INTO  v_id_34_stat_c  from t34_status where cve_tab = par_tabla and cve_stat = 'C' ;
UPDATE t34_datos SET
                              fecha_fin = mdy( par_Mes_Fin,01,par_Axo_Fin),
fecha_cancelacion = Today,
usuario = par_usuario,
id_stat = v_id_34_stat_c
                  Where id_34_datos = par_id_34_datos;

-- CANCELAR CONCEPTOS
SELECT id_34_stat  INTO  v_id_34_stat_cc  from t34_status where cve_tab = 'D' and cve_stat = 'C';
UPDATE t34_conceptos SET
usuario = par_usuario,
id_stat = v_id_34_stat_cc
                  Where id_datos = par_id_34_datos;

-- CANCELAR ADICIONALES
SELECT id_34_stat  INTO  v_id_34_stat_ac  from t34_status where cve_tab = 'C' and cve_stat = 'C';
UPDATE t34_adicionales SET
usuario = par_usuario,
id_stat = v_id_34_stat_ac
                  Where id_datos = par_id_34_datos;

-- CANCELAR ADEUDOS
SELECT id_34_stat  INTO  v_id_34_stat_pc  from t34_status where cve_tab = 'E' and cve_stat = 'C';
UPDATE t34_pagos SET
usuario = par_usuario,
id_stat = v_id_34_stat_pc
WHERE id_datos = par_id_34_datos  AND periodo >= par_Axo_Fin || '-' || par_Mes_Fin  AND  id_stat <> v_id_34_stat_pc;

Let v_leyenda = 'La CONCESION/CONTRATO, CONCEPTOS, ADICIONALES y los ADEUDOS han sido CANCELADOS';
Let v_estatus = 1;
end if;
end if;
end if;
end if;
else
Let v_estatus = -1;
Let v_leyenda = 'La CONCESION/CONTRATO no esta VIGENTE';
end if;
else
Let v_estatus = -1;
Let v_leyenda = 'No se puede Cancelar CONCESION/CONTRATO que no existe';
end if;

RETURN  v_estatus, v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".admin_adeudos_detalle_18odoo_tot ( p_tipo char(1), p_numero int, pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_18odoo_tot
#  Descripcion:      Interfaz de consulta de detalle para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:      p_numero   = Numero de Contrato
#                   pref   = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
--returning  Integer as Rubro,
--Integer as Concepto,
--Integer as Cuenta_Aplicacion,
--VarChar(30) as Referencia,
--VarChar(120) as Descripcion,
--Money(12,2) as Monto,
--Money(12,2) as Acumulado;
returning  Integer as Cuenta_Aplicacion,
VarChar(50) as Referencia,
Money(12,2) as Monto;

define t_cuenta	int;
define t_concepto_abrev varchar(50);
define t_monto, t_monto_t	money(12,2);

define v_ca int;
define v_r Char(1);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje   varchar(255);

define vv_Rubro, vv_Concepto, vv_Cuenta_Aplicacion int;
define vv_Referencia varchar(30);
define vv_Descripcion varchar(120);
define vv_Monto, vv_Acumulado money(14,2);
               
Let t_monto_t = 0;

-- lineas adicionadas para crear el archivo temporal
FOREACH
EXECUTE PROCEDURE admin_adeudos_detalle_18odoo ( p_tipo, p_numero, pref )
INTO vv_Rubro, vv_Concepto, vv_Cuenta_Aplicacion, vv_Referencia,  vv_Descripcion,  vv_Monto,  vv_Acumulado
END FOREACH;

FOREACH
SELECT a.cuenta, a.descripcion, sum(a.monto)  INTO t_cuenta, t_concepto_abrev, t_monto
from tmp_totalaseo a
group by a.cuenta, a.descripcion
order by a.cuenta

RETURN t_cuenta, t_concepto_abrev, t_monto    with resume;
Let t_monto_t = t_monto_t + t_monto;
END FOREACH;

RETURN Null, Null, Null    with resume;
RETURN Null, 'TOTAL ADEUDO', t_monto_t    with resume;
	
end procedure;

CREATE PROCEDURE "informix".con34_gadeudos_01 ( par_Tabla Char(2), p_Control Integer, par_Axo Integer, par_Mes Integer )
{######################################################################
#  Procedimiento:    con34_GAdeudos_01
#  Descripcion:      Interfaz de consulta de detalle Adeudos por contrato de OTRAS OBLIGACIONES
#
#  Parametros         p_Control  = Id del Registro de Control
#  de entrada:         p_Axo            = Axo de Corte
#                             p_Mes = Mes de Corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento con34_GContratos_01 en dbingresos
#  Llama a:          
#  
######################################################################}
                returning Money(12,2),    -- ADEUDOS 2007
                               Money(12,2),    -- RECARGOS 2007
                               Money(12,2),    -- ADEUDOS 2008
                               Money(12,2),    -- RECARGOS 2008
                               Money(12,2),    -- ADEUDOS 2009
                               Money(12,2),    -- RECARGOS 2009
                               Money(12,2),    -- ADEUDOS 2010
                               Money(12,2),    -- RECARGOS2010
                               Money(12,2),    -- ADEUDOS 2011
                               Money(12,2),    -- RECARGOS 2011
                               Money(12,2),    -- ADEUDOS 2012
                               Money(12,2),    -- RECARGOS 2012
                               Money(12,2),    -- ADEUDOS 2013
                               Money(12,2),    -- RECARGOS 2013
                               Money(12,2),    -- ADEUDOS 2014
                               Money(12,2),    -- RECARGOS 2014
                               Money(12,2),    -- ADEUDOS 2015
                               Money(12,2),    -- RECARGOS 2015
                               Money(12,2),    -- ADEUDOS 2016
                               Money(12,2),    -- RECARGOS 2016
                               Money(12,2),    -- ADEUDOS 2017
                               Money(12,2),    -- RECARGOS 2017
                               Money(12,2),    -- ADEUDOS 2018
                               Money(12,2),    -- RECARGOS 2018
 
                               Money(12,2),    -- ADEUDOS 2019
                               Money(12,2),    -- RECARGOS 2019
                               Money(12,2),    -- ADEUDOS 2020
                               Money(12,2),    -- RECARGOS 2020
 
                               Money(12,2),    -- Importe Multa
                               Money(12,2),    -- Importe Gastos
                               varchar(255),     -- Documentos
                               Date ;      -- FECHA DEL PRIMER ADEUDO              
                                                                                                                             
--*********************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                    Integer;
--************************************************************************************************ APREMIOS
  define v_id_control, v_folio_req, v_FolReq                                                              Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos                                        Money(12,2);
  define v_DetFolReq                                                                                                 varchar(255);
  define v_diligencia                                                                                                   char(1);
--************************************************************************************************ ADEUDOS / RECARGOS
  define v_aso_mes_pago, v_periodo_adeudo                                                                              Date;
  define v_importe, v_totAdeudos, v_importe_rgo, v_importe_dcto_rgo                     Money(12,2);
  define v_Mes                                                                                                           varchar(2);

  define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato                                         Integer;
  define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato                         varchar(120);

       define v_por_recargo, v_TotRecargos, v_Reg_1, v_recargo                                 Money(12,2);
       define v_mensaje_proc                                                                                        varchar(255);

  define v_totAdeudos2007, v_TotRecargos2007         Money(12,2);
  define v_totAdeudos2008, v_TotRecargos2008         Money(12,2);
  define v_totAdeudos2009, v_TotRecargos2009         Money(12,2);
  define v_totAdeudos2010, v_TotRecargos2010         Money(12,2);
  define v_totAdeudos2011, v_TotRecargos2011         Money(12,2);
  define v_totAdeudos2012, v_TotRecargos2012         Money(12,2);
  define v_totAdeudos2013, v_TotRecargos2013         Money(12,2);
  define v_totAdeudos2014, v_TotRecargos2014         Money(12,2);
  define v_totAdeudos2015, v_TotRecargos2015         Money(12,2);
  define v_totAdeudos2016, v_TotRecargos2016         Money(12,2);
  define v_totAdeudos2017, v_TotRecargos2017         Money(12,2);
  define v_totAdeudos2018, v_TotRecargos2018         Money(12,2);
  define v_totAdeudos2019, v_TotRecargos2019         Money(12,2);
  define v_totAdeudos2020, v_TotRecargos2020         Money(12,2);

--*************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade   varchar(7);
  define v_Periodo                                                                                           varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo                                                                   Integer;
--**********************************************************************************************************
   Let v_Contador = 0;

LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_totAdeudos2016 = 0;
LET v_TotRecargos2016 = 0;
LET v_totAdeudos2017 = 0;
LET v_TotRecargos2017 = 0;
LET v_totAdeudos2018 = 0;
LET v_TotRecargos2018 = 0;

LET v_totAdeudos2019 = 0;
LET v_TotRecargos2019 = 0;
LET v_totAdeudos2020 = 0;
LET v_TotRecargos2020 = 0;
LET v_periodo_adeudo = Null;  -- PUESTO PARA ADICIONAR EL PRIMER PERIODO DE ADEUDO

   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_importe_rgo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_axo = 0;
                Let v_Lineas_Dato = 0;


                EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  

                Let v_tot_gastos = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_FolReq = 0;
                Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
                FOREACH
                     Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos
                       Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos
                      from ta_15_apremios
                       Where modulo = 34  And control_otr = p_Control
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                               if v_FolReq > 0 then
                                  Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
                               else
                                  Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
                               Let v_FolReq = v_FolReq + 1;
                               end if;
                END FOREACH;
                      -- if v_FolReq > 0 then
                      --      return v_DetFolReq, Null, Null, v_importe_multa, v_tot_gastos  with resume;
                      --          Let v_Contador = v_Contador + 1;
                      -- end if;

                Let v_Lineas_Dato = 0;
                Let v_Detalle_Dato = '';
                               Select ('Descuento de Recargos en periodo(s) del ' || axoinicio || '-' || mesinicio ||
                                               ' al ' || axofin || '-' || mesfin || ' por el ' || porcentaje || ' %'),
                                               (axoinicio || '-' || mesinicio), axofin || '-' || mesfin, porcentaje
                                               INTO v_Detalle_Dato, v_Periodo_Inicio, v_Periodo_fin, v_porc
                                               from ta_16_descrec
                                               Where id_contrato = p_Control and vigencia = 'V';

                              if v_Detalle_Dato <> '' then
                                  Let v_Lineas_Dato = v_Lineas_Dato + 1;
                              end if;

  Let aso_proceso = 0;
  Let aso_actual = par_Axo;

  FOR aso_proceso = 2007 to aso_actual

                -------------------------------------
                               Let v_Lineas_CN = 0;
                               Let v_Detalle_CN = ' C.N. Mes(s) --';

                               FOREACH
                                               SELECT Year(a.periodo), Month(a.periodo), a.importe, a.recargo  INTO v_Axo, v_Mes, v_importe, v_recargo  FROM t34_pagos a, t34_status b    
                                                               WHERE a.id_datos = p_Control  AND a.periodo <= par_Axo || '-' || par_Mes  AND b.id_34_stat = a.id_stat
                                                               AND b.cve_tab = 'E'  AND b.cve_stat in ('V')  AND Year(a.periodo) = aso_proceso
                                                               ORDER BY periodo
                               
                                               if v_importe > 0 then
                                                               if v_Contador = 0 then
                                                                              Let v_periodo_adeudo =  mdy(v_Mes,01,v_Axo);
                                                                              Let v_Contador = 1;
                                                               end if;
                                                               Select sum(por_recargo)  Into v_por_recargo
                                                                From t34_porcentajes  Where periodo_porc between v_Axo || '-' || v_Mes and (v_Periodo_CN);

                                                               if v_por_recargo > 0 then
                                                                              Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
                                                                              Let v_importe_dcto_rgo = 0;
                                                                              EXECUTE PROCEDURE sp_desctomerc ( p_Control, v_axo, v_Mes, 1, v_importe_rgo, Null, Null, Null, Null, 34 )
                                                                                                                                             INTO v_importe_dcto_rgo, v_mensaje_proc;
                                                                              if v_importe_dcto_rgo <> 0 then
                                                                                              Let v_importe_rgo = v_importe_rgo - v_importe_dcto_rgo;
                                                                              end if;
                                                               else
                                                                              Let v_importe_rgo = 0;
                                                               end if;
                                               else
                                                               Let v_importe_rgo = 0;
                                               end if;
                                               Let v_totAdeudos = v_totAdeudos + v_importe;
                                               Let v_TotRecargos = v_TotRecargos + v_importe_rgo;


                               Let v_importe = 0;
                               Let v_por_recargo = 0;
                                Let v_importe_rgo = 0;
                                Let v_importe_dcto_rgo = 0;
                               END FOREACH;

--     Grabando registro

       if aso_proceso = 2007 then
          Let v_totAdeudos2007 = v_totAdeudos;
          Let v_TotRecargos2007 = v_TotRecargos;
       end if;
       if aso_proceso = 2008 then
          Let v_totAdeudos2008 = v_totAdeudos;
          Let v_TotRecargos2008 = v_TotRecargos;
       end if;
       if aso_proceso = 2009 then
          Let v_totAdeudos2009 = v_totAdeudos;
          Let v_TotRecargos2009 = v_TotRecargos;
       end if;
       if aso_proceso = 2010 then
          Let v_totAdeudos2010 = v_totAdeudos;
          Let v_TotRecargos2010 = v_TotRecargos;
       end if;
       if aso_proceso = 2011 then
          Let v_totAdeudos2011 = v_totAdeudos;
          Let v_TotRecargos2011 = v_TotRecargos;
       end if;
       if aso_proceso = 2012 then
          Let v_totAdeudos2012 = v_totAdeudos;
          Let v_TotRecargos2012 = v_TotRecargos;
       end if;
       if aso_proceso = 2013 then
          Let v_totAdeudos2013 = v_totAdeudos;
          Let v_TotRecargos2013 = v_TotRecargos;
       end if;
       if aso_proceso = 2014 then
          Let v_totAdeudos2014 = v_totAdeudos;
          Let v_TotRecargos2014 = v_TotRecargos;
       end if;
       if aso_proceso = 2015 then
          Let v_totAdeudos2015 = v_totAdeudos;
          Let v_TotRecargos2015 = v_TotRecargos;
       end if;
       if aso_proceso = 2016 then
          Let v_totAdeudos2016 = v_totAdeudos;
          Let v_TotRecargos2016 = v_TotRecargos;
       end if;
       if aso_proceso = 2017 then
          Let v_totAdeudos2017 = v_totAdeudos;
          Let v_TotRecargos2017 = v_TotRecargos;
       end if;
       if aso_proceso = 2018 then
          Let v_totAdeudos2018 = v_totAdeudos;
          Let v_TotRecargos2018 = v_TotRecargos;
       end if;
 
       if aso_proceso = 2019 then
          Let v_totAdeudos2019 = v_totAdeudos;
          Let v_TotRecargos2019 = v_TotRecargos;
       end if;
       if aso_proceso = 2020 then
          Let v_totAdeudos2020 = v_totAdeudos;
          Let v_TotRecargos2020 = v_TotRecargos;
       end if;

   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;

  END FOR;

RETURN v_totAdeudos2007, v_TotRecargos2007, v_totAdeudos2008, v_TotRecargos2008, v_totAdeudos2009, v_TotRecargos2009,
v_totAdeudos2010, v_TotRecargos2010, v_totAdeudos2011, v_TotRecargos2011, v_totAdeudos2012, v_TotRecargos2012,
    v_totAdeudos2013, v_TotRecargos2013, v_totAdeudos2014, v_TotRecargos2014, v_totAdeudos2015, v_TotRecargos2015,
    v_totAdeudos2016, v_TotRecargos2016, v_totAdeudos2017, v_TotRecargos2017, v_totAdeudos2018, v_TotRecargos2018,
v_totAdeudos2019, v_TotRecargos2019, v_totAdeudos2020, v_TotRecargos2020,
    v_importe_multa, v_tot_gastos, v_DetFolReq, v_periodo_adeudo   with resume;

end procedure;

CREATE FUNCTION "informix".admin_pago_18 ( p_tipo char(1), p_numero int, pref varchar(20), par_imppagado money(12,2), par_impcartera money(12,2), par_impredondeo money(4,2),
par_Id_Cobro Integer, par_Folio_rcbo Char(30), par_Fecha Date, par_Id_Rec Integer, par_Centro_Ingreso int,
par_Caja Char(2), par_Nom_Cajero Varchar(40), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    admin_pago_18
#  Descripcion:      Interfaz de pago para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros         p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:         p_numero   = Numero de Control del registro
# p_referencia_pag  = referencia que se obtiene del procedimiento admin_adeudos_detalle_18
# par_imppagado = Importe Pagado (Importe total del recibo)
# par_impcartera = Importe de cartera pagado
#                     par_impredondeo = Importe de Redondeo
# par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#                     par_Folio_rcbo = Folio del recibo
#                     par_Fecha = Fecha del recibo
#                     par_Id_Rec = recaudadora donde se realiza el pago(para nuevas solo en rec 2)
#                     par_Centro_Ingreso = Numero de centro de Ingreso
#                     par_Caja = caja de pago
#                     par_Nom_Cajero = Nombre de cajero(a)
#                     par_Cve_Usuario = usuario de cajero(a)
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda     varchar(255);
define v_estatus int;

define vp_control_contrato, v_oficina, v_id_usuario Integer;
define v_propietario varchar(92);
define v_calle, v_tipo_aseo varchar(80);
define v_status_vigencia Char(1);
--*****
define v_monto_cartera Money(12,2);
--*****
define v_control_contrato, v_ctrol_operacion Integer;
define v_aso_mes_pago char(7);
define v_Axo_ini, v_Mes_ini, v_Axo_fin, v_Mes_fin Smallint;
define v_Cuento Smallint;
--*****
define v_id_control Integer;
define v_importe_gastos Money(12,2);
--*****
define v_cuentaaplicacion Integer;
define v_monto Money(12,2);
define v_Cuento_1 Smallint;

define v_ca int;
define v_r Char(1);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje   varchar(255);

define v_Centro_Ingreso Integer; -- HASTA QUE CONFIRME ADMIN ESTE DATO

define vv_Rubro, vv_Concepto, vv_Cuenta_Aplicacion int;
define vv_Referencia varchar(30);
define vv_Descripcion varchar(120);
define vv_Monto, vv_Acumulado money(14,2);

--set debug file to "gil22.log";
--trace on;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
--RETURN -1, 'Error en transaccion de Aseo Contratado ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
--END EXCEPTION;
  if v_lError <> -206 then
    begin
    if v_r = 'S' then
      ROLLBACK WORK;
    end if;
    RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
    end;
  else
  RETURN -12, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE ASEO ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;
END EXCEPTION;

Let v_r = 'N';

-- lineas adicionadas para crear el archivo temporal
FOREACH
EXECUTE PROCEDURE admin_adeudos_detalle_18 ( p_tipo, p_numero, pref )
INTO vv_Rubro, vv_Concepto, vv_Cuenta_Aplicacion, vv_Referencia,  vv_Descripcion,  vv_Monto,  vv_Acumulado
END FOREACH;
SELECT count(*) INTO v_ca from  tmp_totalaseo ;
if v_ca = 0 then
RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
end if;

let v_leyenda     = 'PAGO REALIZADO';
let v_estatus = 0;

Let v_Centro_Ingreso = 0;

Let v_Axo_ini = 0;
Let v_Mes_Ini = 0;
Let v_Axo_fin = 0;
Let v_Mes_fin = 0;

Let v_Cuento = 0;
Let v_Cuento_1 = 0;
Let v_id_control = 0;
Let v_importe_gastos = 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************



let vp_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
SELECT a.control_contrato, (c.descripcion) nom_emp, a.domicilio, a.status_vigencia, a.id_rec, (b.descripcion) tipo_aseo  
INTO  vp_control_contrato, v_propietario, v_calle, v_status_vigencia, v_oficina, v_tipo_aseo
FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c  
WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp;

Let v_control_contrato  = 0;
Let v_ctrol_operacion = 0;
Let v_aso_mes_pago = '';

BEGIN WORK;
let v_r = 'S';
FOREACH
SELECT a.control_contrato, a.aso_mes_pago, a.ctrol_operacion
INTO  v_control_contrato, v_aso_mes_pago, v_ctrol_operacion
FROM tmp_detalleaseo a  WHERE a.tipo_movto = 'A'  
ORDER BY a.aso_mes_pago, a.ctrol_operacion

if v_Cuento = 0 then
Let v_Axo_ini = substr(v_aso_mes_pago,1,4);
Let v_Mes_Ini = substr(v_aso_mes_pago,6,2);

Let v_Axo_fin = substr(v_aso_mes_pago,1,4);
Let v_Mes_fin = substr(v_aso_mes_pago,6,2);
Let v_Cuento = 1;
else
Let v_Axo_fin = substr(v_aso_mes_pago,1,4);
Let v_Mes_fin = substr(v_aso_mes_pago,6,2);
end if;

                UPDATE ta_16_pagos set
                                status_vigencia = 'P',  fecha_hora_pago = par_Fecha,  id_rec = par_Id_Rec,  
caja = par_Caja,  consec_operacion = par_Id_Cobro,  folio_rcbo = par_Folio_rcbo,  usuario = v_id_usuario
                WHERE control_contrato = v_control_contrato AND aso_mes_pago = v_aso_mes_pago  AND ctrol_operacion = v_ctrol_operacion;
END FOREACH;

Let v_control_contrato  = 0;
Let v_ctrol_operacion = 0;
Let v_aso_mes_pago = '';
Let v_id_control = 0;
Let v_importe_gastos = 0;
FOREACH
SELECT a.control_contrato, a.aso_mes_pago, a.ctrol_operacion
INTO  v_control_contrato, v_aso_mes_pago, v_ctrol_operacion
FROM tmp_detalleaseo a  WHERE a.tipo_movto = 'R'  
ORDER BY a.aso_mes_pago, a.ctrol_operacion

if exists( SELECT * FROM ta_15_apremios  WHERE id_control = v_control_contrato ) then
SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos  FROM ta_15_apremios
                        WHERE id_control = v_control_contrato;

UPDATE ta_15_apremios SET
fecha_pago = par_Fecha,  recaudadora = par_Id_Rec, caja = par_Caja,  
operacion = par_Id_Cobro, vigencia='2', clave_mov = 'P', importe_pago = v_importe_gastos
WHERE id_control = v_control_contrato;
end if;
END FOREACH;

-- GRABAR DATOS EN REGISTRO DE DESCUENTO
UPDATE db_ingresos:ta_16_descrec SET
fec_pag = par_Fecha, id_rec = par_Id_Rec, caja = par_Caja, operac = par_Id_Cobro, vigencia = 'P'
WHERE id_contrato = vp_control_contrato and vigencia = 'V';

    -- GRABA RECIBO
    insert into  ta_12_recibos(fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, id_regmodulo, id_rec_cta,
mesdesde, axodesde, meshasta, axohasta, nombre, domicilio, concepto, fecha_act, descripcion, id_usuario, id_centro, foliorecibo)
    values(par_Fecha, par_Id_Rec, par_Caja, par_Id_Cobro, par_imppagado, 'P' ,16, vp_control_contrato, par_Id_Rec,
v_Mes_Ini, v_Axo_ini, v_Mes_fin, v_Axo_fin, v_propietario, v_calle, 'PAGO DE SERVICIO DE RECOLECCION DE BASURA ' || v_tipo_aseo, current,
par_Nom_Cajero, v_id_usuario, par_Centro_Ingreso, par_Folio_rcbo);

Let v_cuentaaplicacion = 0;
Let v_monto = 0;
    FOREACH
    SELECT cuenta,sum(monto)  INTO v_cuentaaplicacion, v_monto
    FROM tmp_totalaseo GROUP BY cuenta ORDER BY cuenta

    let v_Cuento_1 = v_Cuento_1 + 1;

    insert into ta_12_recibosdet(fecha, id_rec, caja, operacion, linea, descripcion, cuenta, importe)
values(par_Fecha, par_Id_Rec, par_Caja, par_Id_Cobro, v_Cuento_1, '', v_cuentaaplicacion, v_monto);
    END FOREACH;
if par_impredondeo <> 0 then
let v_Cuento_1 = v_Cuento_1 + 1;
insert into ta_12_recibosdet(fecha, id_rec, caja, operacion, linea, descripcion, cuenta, importe)
values(par_Fecha, par_Id_Rec, par_Caja, par_Id_Cobro, v_Cuento_1, '', 550800000, par_impredondeo);
end if;

DELETE FROM tmp_detalleaseo;
DELETE FROM tmp_totalaseo;

COMMIT WORK;
else
          let v_leyenda = 'NO EXISTE CONTRATO';
          let v_estatus  = 1;
end if;
RETURN v_estatus,v_leyenda;
--trace off;
END function;

CREATE FUNCTION "informix".admin_pago_20(pinterface int,pcol char(10),pcalle char(10),pfol varchar(10),
pseg4 varchar(10),pseg5 varchar(10),pseg6 varchar(10),pref varchar(20),pimppag money(14,2),
pimpcartera money(14,2),pimpredondeo money(14,2),pidcobro int,
pfolio varchar(30),pfecha date,precp int,pcentrop int,pcaja char(20),pnombreuser varchar(40),
puser char(8))

{######################################################################
#  Procedimiento:    admin_pago_20
#  Descripcion:      Interfaz de pago para el cobro Convenios de obra publica para admin
#
#  Parametros        
#  de entrada:       pinterface = 20 numero de interfaz para convenios diversos
#                    pcol = numero de colonia
#                    pcalle = numero de calle
#                    pfol = numero de folio
#                    pseg4 = sin informacion
#                    pseg5 = sin informacion
#                    pseg6 = sin informacion
#                    pref = hasta que parcialidad se afectara como pagado
#                    pimppag = importe total de pago
#                    pimpcartera = importe de total de las parcialidades 
#                    pimpredondeo = importe de redondeo
#                    pidcobro = numero de operacion,
#                    pfolio = folio de recibo ofical
#                    pfecha = fecha de pago
#                    precp = recaudadora de pago
#                    pcentrop = numero de centro de recaudacion
#                    pcaja = caja de pago
#                    pnombreuser = nombre del cajero
#                    puser = nombre del usuario
#  Parametros        
#  de salida:        Definidos Abajo.
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            31 Octubre 2013   
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}


returning   int as status, 
            varchar(150) as mensaje;

define v_status,v_contvarios,v_ref,v_iduser,v_id,v_parci,v_parcf,v_tipo int;
define v_datosvarios,v_descrbo varchar(150);
define v_Nombrecompleto varchar(92); 
define v_calle varchar(80);
define v_Exterior,v_interior,v_codigopostal varchar(10);
define v_colonia,v_municipio,v_estado varchar(50);
define v_RFC varchar(13);
define v_curp varchar(18);
define v_carteraxcobar,v_codigo,v_cont,v_totparc int;
define v_leyenda,v_leyenda1,v_leyendaRECIBO varchar(255);
define  a_colonia,a_descripcion varchar(50);
define  a_calle varchar(80);
define  a_tipoobra varchar(20);
define  a_nombreobra varchar(100);
define  a_referencia,v_refper varchar(30);
define  a_pagototal,a_pagoinicial,a_pagoparcial,a_adeudo,a_monto,a_acumulado decimal(8,2);
define  a_pagos,a_parcialidad,a_restan,a_apagar,a_cuentaapl,v_cuentatot,v_tcta int;
define  a_vencimiento date;
define v_acumulado,v_montotot,v_acumuladotot,v_montoper decimal(14,2);
define v_concepto,v_domicilio,v_conceptodet varchar(60);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -12, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE DESARROLLO SOCIAL ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
-- set debug file to "pago20";
-- trace on;
  let v_r = 'N';
 
  select count(*) into v_ca from  tmp_totalesobra ;
  if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;

let v_contvarios=0;
let v_cont=0;

-- Asigna valor a fererencia a pagar
if trim(pref)='' then
   let v_ref=999;
else
   let v_ref=pref;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

if not exists (select * from tmp_totalesobra) then
   let v_status=1;
   let v_leyenda1='No existen adeudos para afectar';
   return v_status,v_leyenda1;
end if;

-- checa que exista el convenio
if not exists(select * from ta_17_convenios where colonia=pcol and calle=pcalle and folio=pfol) then
   return -1,'REFERENCIA NO EXISTE';
end if;

-- obtiene el id convenio
select a.id_convenio,b.tipo into v_id,v_tipo from ta_17_convenios a, ta_17_calles b
where a.colonia=pcol and a.calle=pcalle and a.folio=pfol
and b.colonia=a.colonia and b.calle=a.calle;

-- ejecuta el procedimeinto de encabezados
execute procedure admin_encabezados_20(pinterface,pcol,pcalle,pfol,pseg4,pseg5,pseg6) into
v_Nombrecompleto,v_calle,v_Exterior,v_interior,v_colonia,v_codigopostal,v_RFC,v_municipio,v_estado,
v_curp,v_carteraxcobar,v_leyenda,v_leyendaRECIBO,v_codigo;

-- ejecuta el procedimiento de datos varios
foreach
execute procedure admin_datos_varios_20(pinterface,pcol,pcalle,pfol,pseg4,pseg5,pseg6) into v_datosvarios
let v_contvarios=v_contvarios+1;
if v_contvarios = 1 then let a_colonia=v_datosvarios; 
else if v_contvarios = 2 then let a_calle=v_datosvarios;
else if v_contvarios = 3 then let a_tipoobra=v_datosvarios;
else if v_contvarios = 4 then let a_pagototal=v_datosvarios;
else if v_contvarios = 5 then let a_pagoinicial=v_datosvarios;
else if v_contvarios = 6 then let a_pagoparcial=v_datosvarios;
else if v_contvarios = 7 then let a_vencimiento=to_date(v_datosvarios,'%d%m%Y');
else if v_contvarios = 8 then let a_parcialidad=v_datosvarios;
else if v_contvarios = 9 then let a_restan=v_datosvarios;
else if v_contvarios = 10 then let a_apagar=v_datosvarios;
else let a_nombreobra=v_datosvarios;
end if; end if; end if; end if; end if; end if; end if; end if; end if; end if;
end foreach;

-- para sacar parcialidad minima
select  min(referencia) into v_parci from tmp_totalesobra; 
-- para sacar parcialidad maxima
select  max(referencia) into v_parcf from tmp_totalesobra;

-- ejecuta el procedimiento de adeudo detalle
foreach
select acumulado into v_acumulado from tmp_totalesobra where referencia=v_parcf 
end foreach;
           
-- valida si el importe pagado es igual al importe adeudo 
if pimpcartera<>v_acumulado then
   return -7,'EL IMPORTE COBRADO ES DIFERENCIA AL IMPORTE ADEUDO'
            ||pimpcartera||' '||v_acumulado||' '||v_parcf;
end if;

-- valida si el importe pagado mas redondeo es igual al importe pagado 
if (pimpcartera+pimpredondeo)<>pimppag then
   return -6,'LA SUMA DE CARTERA Y REDONDEO NO ES EL CERTIFICADO. VERIFICAR';
end if;

BEGIN WORK;
let v_r = 'S';
-- graba la operacion en recibos
let v_concepto='RECUPERACION DE GASTOS GRALES '||trim(a_tipoobra);
let v_descrbo='DATOS DEL CONTRATO '||trim(pcol)||'-'||trim(pcalle)||'-'||trim(pfol)||
              '     ID CONTRATO '||v_id;
let v_domicilio=v_calle||' '||v_Exterior||' '||v_interior;
insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,
rfccolonia,obra,axofolio,id_usuario,fecha_act,descripcion,id_centro,foliorecibo) 
values(pfecha,precp,pcaja,pidcobro,pimppag,'P',17,v_id,v_tipo,'',v_parci,v_parcf,month(today),year(today),
v_Nombrecompleto,v_domicilio,v_concepto,'',pfol,pcol,pcalle,0,v_iduser,current,v_descrbo,
pcentrop,pfolio);

foreach
select cuenta,descripcion,count(cuenta),sum(monto),sum(acumulado) 
into v_cuentatot,v_conceptodet,v_tcta,v_montotot,v_acumuladotot  
from tmp_totalesobra group by cuenta,descripcion order by cuenta

-- graba detalle de recibo
let v_cont=v_cont+1;
insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
values(pfecha,precp,pcaja,pidcobro,v_cont,v_conceptodet,v_cuentatot,v_montotot);
end foreach;

-- inserta el redondeo
if pimpredondeo<>0 then
   insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
   values(pfecha,precp,pcaja,pidcobro,v_cont+1,'REDONDEO',550800000,pimpredondeo);
end if;

-- afecta los periodos como pagados
select sum(monto) into v_montoper  
from tmp_totalesobra where cuenta not in(570200000);

-- inserta el pago a contratos
insert into ta_17_pagos(id_pago,id_convenio,fecha_pago,oficina_pago,caja_pago,operacion_pago,
pago_parcial,total_parciales,importe,cve_descuento,cve_bonificacion,id_usuario,fecha_actual) 
values(0,v_id,pfecha,precp,pcaja,pidcobro,v_parci,v_parcf,v_montoper,null,null,v_iduser,current);
let v_status=0;
let v_leyenda1='PAGO APLICADO CORRECTAMENTE';


-- borrar tabla temporal
delete from tmp_totalesobra;
COMMIT WORK;

return v_status,v_leyenda1;
-- trace off;
end function;

CREATE FUNCTION "informix".admin_pago_24(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10), p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10), p_Apagar char(20), p_certifp money,p_imptep money,
                                  p_redonp money, p_idcobro int, p_foliorbo varchar(30), p_fechapago date, p_recrbo int,  p_centrorbo int,p_cajarbo char(20),
                                  p_nomcajero  varchar(40), p_cajero    varchar(08), p_adicional1 varchar(100), p_adicional2 varchar(100),
                                  p_adicional3 varchar(100), p_adicional4 varchar(100), p_adicional5 varchar(100), p_adicional6 varchar(100),
                                  p_adicional7 varchar(100), p_adicional8 varchar(100), p_adicional9 varchar(100), p_adicional10 varchar(100),
                                  p_adicional11 varchar(100), p_adicional12 varchar(100), p_adicional13 varchar(100), p_adicional14 varchar(100),
                                  p_adicional15 varchar(100))
                RETURNING int as sbien, varchar(255) as mensage;


define v_lError     int;
define v_lISAMError int;
define v_vcMensaje,v_tmsg  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);
define vcvepago     int;
define v_axop,vx_cod     int;
define v_axof,v_cont,v_uno    int;
define v_control,v_idusu    integer;
define  par_axod,v_ctaapl1   int;
define  par_axoh   int;
define  par_importe money;
define  par_recar   money;
define  par_tot   money;
define  v_nombre,v_colonia, vx_msg  varchar(80);
define  v_domcompleto,v_desade VARCHAR(75);
define  v_exte,v_refe      VARCHAR(10);
define  v_inte      VARCHAR(10);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -911, 'admin_pago_24 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_control= nvl(p_segmento1,0);
let v_cont   = 0;
let v_axof   = year(today);
let par_axod = year(today);
let v_uno    = 0;
let par_axoh = year(today); 
let v_ctaapl1=   nvl(p_adicional1, 0);
let par_importe= nvl(p_adicional2, 0);
   let v_idusu=0;

SELECT cementerio, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, 
         nombre,domicilio, exterior, interior,colonia
into  v_cem, v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa,
      v_nombre,v_domcompleto,v_exte,v_inte,v_colonia
FROM ta_13_datosrcm where control_rcm=v_control;

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;

if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if v_control>0 then
    BEGIN WORK;
    insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
    id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcnumero,
    axofolio,id_usuario,fecha_act,descripcion, id_centro, foliorecibo) 
    values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro, p_certifp,'P',12, v_control, 0, '',1,par_axod,12,par_axoh,
    v_nombre, (Trim(v_domcompleto)||' '||trim(v_exte) ||' '||trim(v_inte)), v_colonia, v_control, 0, v_idusu, current,
    (p_nomcajero||' '||p_foliorbo||' '||v_cem||' '||v_clase||' '||trim(v_calfa)||' '||v_seccion||' '||trim(v_salfa)||' '||v_linea||' '||trim(v_lalfa)||' '||v_fosa||' '||trim(v_falfa)),
     p_centrorbo, p_foliorbo );

     if v_ctaapl1>0 then
        select descripcion, tipo_pago into v_desade, v_refe from cg_12_cuentas where cta_aplicacion= v_ctaapl1;
        let v_cont=v_cont+1;
        insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe) 
        values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,v_desade,v_ctaapl1, par_importe);
        if v_refe='T' then 
           if v_ctaapl1=347000000 then
              let v_uno=1;
          end if;
           if v_ctaapl1=421100001 then
              let v_uno=2;
          end if;
           if v_ctaapl1=342000001 then
              let v_uno=1;
          end if;
           INSERT INTO ta_13_titulos(tipo, titulo, control_rcm, fecha, id_rec, caja, operacion, importe) 
                  VALUES(v_uno,0, v_control,p_fechapago,p_recrbo,p_cajarbo,p_idcobro,p_certifp);
         end if;
     end if;
 
    EXECUTE FUNCTION spd_12_grupodiv(v_ctaapl1, p_fechapago,p_recrbo,p_cajarbo,p_idcobro) into vx_cod, vx_msg;

     let v_ctaapl1=nvl(p_adicional3,0);
     let par_importe=nvl(p_adicional4,0);
     if v_ctaapl1>0 then
        select descripcion into v_desade from cg_12_cuentas where cta_aplicacion= v_ctaapl1;
        let v_cont=v_cont+1;
        insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
        values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,v_desade,v_ctaapl1, par_importe);
     end if;

    if p_redonp <> 0 then
       let v_cont=v_cont+1;
       insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
       values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,'Redondeo ',55080000, p_redonp);
    end if;

  COMMIT WORK;	
 return 0,'Pagado ' ;
else
 return -1,'REFERENCIA NO EXISTE ' ;
end if;
END function;

CREATE FUNCTION "dbduenas".admin_pago_30(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20),pimppag money(14,2),
pimpcartera money(14,2),pimpredondeo money(14,2),pidcobro int,
pfolio varchar(30),pfecha date,precp int,pcentrop int,pcaja char(20),pnombreuser varchar(40),
puser char(8),psolicitud varchar(150))

{######################################################################
#  Procedimiento:    admin_pago_30
#  Descripcion:      Interfaz de pago para el cobro de mercados para admin
#
#  Parametros        
#  de entrada:       pinterface = 30 numero de interfaz para convenios diversos
#                    prec = recaudadora al que pertenece el mercado
#                    pmer = numero de mercado
#                    psecc = seccion del mercado
#                    ploc = numero de local
#                    plet = letra del local
#                    pblq = bloque del local
#                    pref = hasta que mensualidad se afectara como pagado
#                    pimppag = importe total de pago
#                    pimpcartera = importe de total de mensualidades 
#                    pimpredondeo = importe de redondeo
#                    pidcobro = numero de operacion,
#                    pfolio = folio de recibo ofical
#                    pfecha = fecha de pago
#                    precp = recaudadora de pago
#                    pcentrop = numero de centro de recaudacion
#                    pcaja = caja de pago
#                    pnombreuser = nombre del cajero
#                    puser = nombre del usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            10 Abril 2014   
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}


returning   int as status, 
            varchar(100) as mensaje;

define v_ref char(7);
define v_bloque1,v_blq varchar(2);
define v_letra1,v_let varchar(3);
define v_rubro,v_conctmp,v_cuentaaplicacion,v_axoi,v_axof,v_mesi,v_mesf,d_rubro,d_concepto,d_cuenta int;
define v_referencia,d_referencia varchar(30);
define v_descadeudo,d_descripcion varchar(120);
define v_monto,v_acumulado,v_montotot,v_acumuladotot,v_montoper,v_acumuladoper,d_monto,d_acumulado decimal(14,2);
define v_Nombrecompleto varchar(92);
define v_calle varchar(80);
define v_Exterior,v_interior,v_codigopostal varchar(10);
define v_colonia,v_municipio,v_estado varchar(50);
define v_RFC varchar(13);
define v_curp varchar(18);
define v_descripcionrecibo lvarchar(500);
define v_carteraxcobar,v_codigo,v_tcta,v_cuentatot,v_cuentaper,v_axoper,v_mesper integer; 
define v_leyenda,v_leyendarecibo,v_descrbo varchar(255); 
define v_datosvarios,v_mercado,v_seccion,v_dom,v_adicional,v_sector,v_zona,v_giro,v_superficie varchar(150);
define v_id,v_contador,v_contvarios,v_status,v_iduser,v_axot,v_mest,v_ultfolio int;
define v_leyenda1 varchar(100);

define v_numtrans int;
define v_idlocal int;
define v_descripcion varchar(240);
define v_axoini,v_mesini,v_axofin,v_mesfin int;
define v_numperiodos int;
define v_idmedio int;
define v_impactual,v_imprezago,v_imprecargos,v_impmulta,v_impgastos,v_impredon money(16,2);
define v_nummerc int;
define v_local int;
define v_letra varchar(3);
define v_bloque varchar(2);
define v_nomsec,v_nommer char(30);
define v_ctaact,v_ctarzg,v_ctarec,v_ctamul,v_ctagas int;
define v_conc1,v_conc2,v_conc3,v_conc4,v_conc5,v_conc6,v_conc7,v_conc8 char(60);
define v_conc4f1,v_conc4f2,v_conc4f3,v_conc4f4 char(60);
define v_nombre,v_domicilio,v_mensaje,v_concepto,v_conceptodet char(60);
define v_linea1 char(100);
define v_linea2 char(28);
define v_adeudo,v_total,v_importe money(16,2);
define v_perini,v_perfin int;
define v_reca,v_porcdescrec int; 
define v_caja char(2);
define v_operacion,v_cont,v_cont1,v_cuenta int;
define v_categoria,v_desc,v_idcontrol,v_folio int;
define v_aid_local,v_aaxo,v_aperiodo,v_dmes,v_axo,v_mes int;
define v_aimporte,v_gastos,v_descuento money(16,2);
define v_fecha_desc date; 
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -12, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE CERTIFICADO DE MERCADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
-- set debug file to "pago30";
-- trace on;
  let v_r = 'N';
 
let v_status=0;
let v_leyenda1='';
let v_leyenda='';
let v_contador=0;
let v_contvarios=0;
let v_nombre='';
let v_domicilio='';
let v_cont=0;

if trim(psolicitud)=''then
   let psolicitud='0';
end if; 

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

-- checa que exista el local y toma el id_local
if not exists(select * from ta_11_locales where oficina=prec and num_mercado=pmer 
                                           and seccion=psecc and local=ploc ) then
   let v_status=1;
   let v_leyenda1='No existe numero de local';
   return v_status,v_leyenda1;
end if;
   
foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    let v_status=0;
    let v_leyenda1='';
    -- ejecuta el procedimeinto de encabezados
    execute procedure admin_encabezados_30(30,prec,pmer,psecc,ploc,plet,pblq) into
    v_Nombrecompleto,v_calle,v_Exterior,v_interior,v_colonia,v_codigopostal,v_RFC,v_municipio,v_estado,
    v_curp,v_carteraxcobar,v_leyenda,v_leyendarecibo,v_codigo;
    
    -- ejecuta el procedimiento de datos varios
    foreach
    execute procedure admin_datos_varios_30(30,prec,pmer,psecc,ploc,plet,pblq) into v_datosvarios
    let v_contvarios=v_contvarios+1;
    if v_contvarios = 1 then let v_axo=v_datosvarios;
    else if v_contvarios = 2 then let v_mes=v_datosvarios;
    else if v_contvarios = 3 then let v_mercado=v_datosvarios; 
    else if v_contvarios = 4 then let v_seccion=v_datosvarios;
    else if v_contvarios = 5 then let v_dom=v_datosvarios;
    else if v_contvarios = 6 then let v_adicional=v_datosvarios;
    else if v_contvarios = 7 then let v_sector=v_datosvarios;
    else if v_contvarios = 8 then let v_zona=v_datosvarios;
    else if v_contvarios = 9 then let v_giro=v_datosvarios;
    else let v_superficie=v_datosvarios;
    end if; end if; end if; end if; end if; end if; end if; end if; end if;
    end foreach;

    -- ejecuta el procedimiento de adeudo detalle
    foreach 
    execute procedure admin_adeudos_detalle_30(30,prec,pmer,psecc,ploc,plet,pblq,pref) 
      into d_rubro,d_concepto,d_cuenta,d_referencia,d_descripcion,d_monto,d_acumulado
    end foreach;

    foreach
    select rubro,concepto,cuenta,axo,mes,referencia,descripcion,monto,acumulado 
    into v_rubro,v_conctmp,v_cuentaaplicacion,v_axot,v_mest,v_referencia,v_descadeudo,v_monto,v_acumulado 
    from  tmp_totcertificado
    end foreach;
           
    -- valida si el importe pagado es igual al importe adeudo 
    if pimpcartera<>v_acumulado then
       let v_status=2;
       let v_leyenda1='El importe cartera pagada es diferente al importe adeudo';
       return v_status,v_leyenda1;
    end if;

    -- valida si el importe pagado mas redondeo es igual al importe pagado 
    if (pimpcartera+pimpredondeo)<>pimppag then
       let v_status=2;
       let v_leyenda1='El importe cartera pagada mas importe redondeo es diferente al importe pagado';
       return v_status,v_leyenda1;
    end if;
 
    -- asigna el concepto de cobro para grabar en recibos
    let v_concepto='PAGO DE CERTIFICADO DE NO ADEUDO DE MERCADOS';
    let v_domicilio='MDO. '||trim(v_mercado)||' LOCAL '||trim(ploc)||'-'||trim(plet)||'-'||trim(pblq);

    BEGIN WORK;
     let v_r = 'S';
    -- graba la operacion en recibos
    let v_descrbo='Datos del Local '||trim(prec)||'-'||trim(pmer)||'-'||trim(psecc)||'-'||
                  trim(ploc)||'-'||trim(plet)||'-'||trim(pblq)||'     Id local '||v_id;
    insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
    id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,
    rfccolonia,obra,axofolio,id_usuario,fecha_act,descripcion,id_centro,foliorecibo) 
    values(pfecha,precp,pcaja,pidcobro,pimppag,'P',11,v_id,prec,'C',v_mest,v_axot,
    month(today),year(today),v_Nombrecompleto,v_domicilio,v_concepto,psecc,ploc,pmer,0,psolicitud,v_iduser,
    current,v_descrbo,pcentrop,pfolio);

    foreach
    select cuenta,descripcion,count(cuenta),sum(monto),sum(acumulado) 
    into v_cuentatot,v_conceptodet,v_tcta,v_montotot,v_acumuladotot  
    from tmp_totcertificado group by cuenta,descripcion order by cuenta

    -- graba detalle de recibo
    let v_cont=v_cont+1;
    insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
    values(pfecha,precp,pcaja,pidcobro,v_cont,v_conceptodet,v_cuentatot,v_montotot);
    end foreach;

    -- inserta el redondeo
    if pimpredondeo<>0 then
       insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
       values(pfecha,precp,pcaja,pidcobro,v_cont+1,'REDONDEO',550800000,pimpredondeo);
    end if;
 
    -- inserta el pago a mercados
    insert into ta_11_certificado(id_certificado,id_local,axo,mes,fecha,id_rec,
    caja,operacion,importe,solicitud,actual,id_usuario) 
    values(0,v_id,v_axot,v_mest,pfecha,precp,pcaja,pidcobro,v_acumuladotot,psolicitud,current,v_iduser);
    let v_status=0;
    let v_leyenda1='PAGO APLICADO CORRECTAMENTE';

   -- borrar tabla temporal
       delete from tmp_totcertificado;
   COMMIT WORK;   
end if;
end foreach;
if v_contador=0 then
   let v_status=-1;
   let v_leyenda1='REFERENCIA NO EXISTE';
   return v_status,v_leyenda1;
end if;
return v_status,v_leyenda1;
-- trace off;
end function;

CREATE PROCEDURE "pgmoreno".sp16_licenciagiro_f0 ( p_Control_contrato int )
{######################################################################
#  Procedimiento:    sp16_LicenciaGiro_F1
#  Descripcion:      Interfaz de consulta Consulta de Licencias de Giro Relacionadas al Contrato de ASEO CONTRATADO
#
#  Parametros		p_Control_contrato : id de busqueda del Contrato
#  de entrada:
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:
#
#  Llamado por:      Procedimiento
#  Llama a:          
#  
######################################################################}
returning	int as status_licencias, 
varchar(100) as Concepto_licencias;

define v_licencia, v_Follic				Int;
define v_DetFollic					varchar(100);

Let v_Follic = 0;
Let v_licencia = 0;
Let v_DetFollic = 'Licencia(s) Relacionada(s) : ';

	FOREACH
	SELECT a.num_licencia INTO v_licencia  FROM ta_16_rel_licgiro a, catastro_gdl:Licencias b
    WHERE a.control_contrato = p_Control_contrato
	AND b.licencia = a.num_licencia and b.vigente = "V"
	ORDER BY a.num_licencia

	if v_Follic > 0 then
		Let v_DetFollic = v_DetFollic || ',' || v_licencia;
		Let v_Follic = v_Follic + 1;
	else
        Let v_DetFollic = v_DetFollic || v_licencia;
		Let v_Follic = v_Follic + 1;
	end if;
	END FOREACH;

	if v_Follic > 0 then
		RETURN v_Follic, Trim(v_DetFollic);
	end if;

end procedure;

CREATE FUNCTION "informix".get_diashabiles (fechaIni date, fechaFin date)
	returns int as diashabiles;

    define vFecha date;
    define dias_cuantos int;
    define dias_habil int;
	
    let dias_cuantos = 0;
    let dias_habil = 0;
    let vFecha = fechaIni;

    if Weekday(fechaIni) = 6 then
        let dias_cuantos = 1;
    end if;

    select count(*) 
       into dias_habil 
    from db_ingresos:ta_12_diasinhabil  where fecha between fechaIni and fechaFin;

     while vFecha <= fechaFin 
        IF (Weekday(vFecha) >= 1) AND (Weekday(vFecha)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let vFecha = vFecha + 1;
   end while;

    let dias_cuantos =  dias_cuantos - dias_habil ;

    return dias_cuantos;

END FUNCTION
;

CREATE PROCEDURE "pgmoreno".admin_adeudos_detalle_18odooxxx ( p_tipo char(1), p_numero int, pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_18
#  Descripcion:      Interfaz de consulta de detalle para el cobro de ASEO CONTRATADO en el sistema ADMIN
#
#  Parametros p_tipo     = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:      p_numero   = Numero de Contrato
#                   pref   = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning Integer as Rubro,
Integer as Concepto,
Integer as Cuenta_Aplicacion,
VarChar(30) as Referencia,
VarChar(120) as Descripcion,
Money(12,2) as Monto,
Money(12,2) as Acumulado;
               
define v_control_contrato, v_ctrol_operacion, v_id_control_req Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas    Money(12,2);
define v_porcentaje_multa                                                                   Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           	Money(12,2);
define v_aso_mes_pago                                                                       Date;
define v_Axo, v_Mes, v_Axo_pp, v_Mes_pp														Integer;
define v_mensaje_proc                                                                       varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                          varchar(7);
define  v_ref char(7);
define v_importe_Dscto_Tot, v_importe_Dscto Money(12,2);  -- adicionado por GMG 31/12/2019 para descuento por pronto pago
define v_ctrol_recolec	int;  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion
define v_cve_recolec	char(1);  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion
define v_cta_apl	int;  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion
define v_cta_descrip	varchar(50);  -- adicionado por GMG 31/12/2019 para obtener el tipo de recoleccion

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
define v_aplica	char(1);
define v_porc_adic	int;

-- Descuento por pronto pago
define pp_fecha_inicio, pp_fecha_fin	date;
define pp_porc_dscto	decimal(5,2);

begin
    on exception in (-958)
delete from tmp_totalaseo;
    end exception;
create temp table tmp_totalaseo(
	rubro int,
	concepto int,
	cuenta int,
	referencia varchar(30),
	descripcion varchar(120),
	monto money(14,2),
	acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
delete from tmp_detalleaseo;
    end exception;
create temp table tmp_detalleaseo(
	control_contrato int,
	aso_mes_pago char(7),
	ctrol_operacion int,
	tipo_movto char(1) ) with no log;
end;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;
if trim(pref)='' then
   Let v_ref=year(today) || '-' || 12;
else
   Let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;
Let v_Axo_pp = substr(v_ref,1,4);
Let v_Mes_pp = substr(v_ref,6,2);

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
SELECT aplica INTO v_aplica FROM ta_aplicareq;

-- Descuento por pronto pago
SELECT fecha_inicio, fecha_fin, porc_dscto INTO pp_fecha_inicio, pp_fecha_fin, pp_porc_dscto FROM ta_16_Dscto_pp WHERE status = 'V';

Let v_ctrol_recolec	= 0;
Let v_cve_recolec = '';
Let v_cta_apl = 0;
Let v_cta_descrip = '';

let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
SELECT a.control_contrato, ctrol_recolec  INTO  v_control_contrato, v_ctrol_recolec   FROM ta_16_contratos a, ta_16_tipo_aseo b
    WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;
	
	select cve_recolec into v_cve_recolec  from ta_16_unidades where ctrol_recolec = v_ctrol_recolec;

    -- VARIABLES A 0
    Let v_tot_multas = 0;
    Let v_porcentaje_multa = 0;
    Let v_tot_dscto_multas = 0;

    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_tot_gastos = 0;
    Let v_acumulado = 0;
    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
	
    -- APREMIOS
    Let v_id_control_req = 0;
    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_Axo = 0;
    Let v_Mes = 0;
    foreach
    SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
    INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
    FROM ta_15_apremios
    WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
    Order By id_control

	if v_aplica = 'S' then  -- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
		Let v_tot_multas = v_importe_multa;
		if v_porcentaje_multa < 100 then
			Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
			Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
		else
			Let v_tot_dscto_multas = 0;
		end if;
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
	else
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
	end if;

	insert into tmp_detalleaseo values ( v_id_control_req, v_ref, 0, 'R' );
	
    end foreach;
    -- TERMINA APREMIOS
	if v_tot_multas > 0 then
		Let v_acumulado = v_acumulado + v_tot_multas;
        RETURN 0, 515002003, get_odoo_cta( 515002003 , 18), v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado  with resume;
        insert into tmp_totalaseo values ( 0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado );
    end if;
    if v_tot_dscto_multas <> 0 then
		Let v_acumulado = v_acumulado + v_tot_dscto_multas;
        RETURN 0, 515042003, get_odoo_cta( 515042003 , 18), v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado with resume;
        insert into tmp_totalaseo values ( 0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado );
    end if;
    if v_tot_gastos > 0 then
		Let v_acumulado = v_acumulado + v_tot_gastos;
        RETURN 0, 992104009, get_odoo_cta( 992104009 , 18), v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado  with resume;
        insert into tmp_totalaseo values ( 0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
    end if;

    -- INICIAN PERIODOS
    foreach
    SELECT  aso_mes_pago,  Year(aso_mes_pago), Month(aso_mes_pago), importe, ctrol_operacion
    INTO     v_aso_mes_pago, v_Axo, v_Mes, v_importe, v_ctrol_operacion
    FROM ta_16_pagos
    WHERE Control_Contrato = v_control_contrato  
    AND aso_mes_pago <= v_ref
    AND status_vigencia = 'V'  Order By aso_mes_pago, ctrol_operacion

	insert into tmp_detalleaseo values ( v_control_contrato, v_Axo || '-' || v_Mes, v_ctrol_operacion, 'A' );

        if v_importe > 0 then
            if v_ctrol_operacion = 6 then
				if Year(v_aso_mes_pago) < Year(Current) then
					-- rezago
					Let v_cta_apl = 250130000;
					Let v_cta_descrip = 'Rezago del Adeudo ';
				else
					-- actual
					if (v_cve_recolec = 'N') or (v_cve_recolec = 'M') or (v_cve_recolec = 'T') or (v_cve_recolec = 'O') then
						if v_cve_recolec = 'N' then -- N, TONELADA
							Let v_cta_apl = 180000001;
						end if;
						if v_cve_recolec = 'M' then -- M,MT3
							Let v_cta_apl = 180000002;
						end if;
						if v_cve_recolec = 'T' then -- T,TAMBOS
							Let v_cta_apl = 180000003;
						end if;
						if v_cve_recolec = 'O' then -- O,BOLSA 60 X 65 CM
							Let v_cta_apl = 180000004;
						end if;
					else
						Let v_cta_apl = 180000003;
					end if;
					Let v_cta_descrip = 'Actual de Adeudo ';
                end if;
				
				Let v_acumulado = v_acumulado + v_importe;
				RETURN 0, v_cta_apl, get_odoo_cta( v_cta_apl , 18), v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado  with resume;
				insert into tmp_totalaseo values ( 0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado );

                SELECT sum(porc_recargo)   INTO v_Importe_recargo
                FROM ta_16_recargos
                WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

				-- INICIO -- Descuento por pronto pago
				if pp_porc_dscto > 0 then -- and p_rep <> 'V' 
					if today >= pp_fecha_inicio and today <= pp_fecha_fin then
						if v_Axo = Year(today) and (v_Mes_pp = 12)then  -- solo a�o actual
							Let v_importe_Dscto = (v_importe * pp_porc_dscto);
							Let v_importe_Dscto = v_importe_Dscto * -1;

							Let v_acumulado = v_acumulado + v_importe_Dscto;
							RETURN 0, 180000009, get_odoo_cta( 180000009 , 18), v_Axo || '/' || v_Mes, '10% Dscto p/pp ', v_importe_Dscto, v_acumulado with resume;
							insert into tmp_totalaseo values ( 0,0, 180000009, v_Axo || '/' || v_Mes, '10% Dscto p/pp ', v_importe_Dscto, v_acumulado );
						end if;
					end if;
				end if;
				-- FIN -- Descuento por pronto pago				
				
            else
				if Year(v_aso_mes_pago) < Year(Current) then
					-- rezago
					Let v_cta_apl = 250230000;
					Let v_cta_descrip = 'Rezago del Excedente ';
                else
					-- actual
					if (v_cve_recolec = 'N') or (v_cve_recolec = 'M') or (v_cve_recolec = 'T') or (v_cve_recolec = 'O') then
						if v_cve_recolec = 'N' then -- N, TONELADA
							Let v_cta_apl = 180000001;
						end if;
						if v_cve_recolec = 'M' then -- M,MT3
							Let v_cta_apl = 180000002;
						end if;
						if v_cve_recolec = 'T' then -- T,TAMBOS
							Let v_cta_apl = 180000007;
						end if;
						if v_cve_recolec = 'O' then -- O,BOLSA 60 X 65 CM
							Let v_cta_apl = 180000008;
						end if;
					else
						Let v_cta_apl = 180000007;
					end if;
					Let v_cta_descrip = 'Actual del Excedente ';
                end if;
				
				Let v_acumulado = v_acumulado + v_importe;
				RETURN 0, v_cta_apl, get_odoo_cta( v_cta_apl , 18), v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado  with resume;
				insert into tmp_totalaseo values ( 0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado );

                SELECT sum(porc_recargo)   INTO v_Importe_recargo
                FROM ta_16_recargos
                WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN); --(v_Periodo_EXE);
				
            end if;
            if v_Importe_recargo <> 0 then
				Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                Let v_acumulado = v_acumulado + v_importe_rec1;
                RETURN 0, 390200000, get_odoo_cta( 390200000 , 18), v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado   with resume;
                insert into tmp_totalaseo values ( 0,0, 390200000, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado );
                EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16)
                INTO v_importe_rec2, v_mensaje_proc;
            end if;
            if v_importe_rec2 > 0 then
				Let v_importe_rec2 = v_importe_rec2 * -1;
                Let v_acumulado = v_acumulado + v_importe_rec2;
                RETURN 0, 390240000, get_odoo_cta( 390240000 , 18), v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado  with resume;
                insert into tmp_totalaseo values ( 0,0, 390240000, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado );
            end if;

        end if;

        Let v_importe = 0;
        Let v_Importe_recargo = 0;
        Let v_importe_rec1 = 0;
        Let v_importe_rec2 = 0;
    end foreach;
    -- TERMINAN PERIODOS

end if;
end procedure;

CREATE PROCEDURE "pgmoreno".sp16_adeudos_f02xxx ( p_tipo char(1), p_numero int, p_rep char(1), pref varchar(20) )
{######################################################################
#  Procedimiento:    sp16_Adeudos_F02
#  Descripcion:      Interfaz de consulta de detalle de Adeudos de ASEO CONTRATADO
#
#  Parametros	p_tipo		= tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:  p_numero	= Numero de Contrato
#				p_rep		= 'V'=Adeudos Vigentes, 'T'=Todo el adeudo ( letra diferente de 'V' )
#               pref		= Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}	
returning	char(7) as Periodo,
varchar(200) as Concepto,
Int as Cant_Recolec,
Money(12,2) as Importe_Adeudos,
Money(12,2) as Importe_Recargos,
Money(12,2) as Importe_Multa,
Money(12,2) as Importe_Gastos;

define v_control_contrato		int;
define a_Periodo_CN, a_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE		varchar(7);
define  v_ref     char(7);

define v_status_licencias		int;
define v_concepto_licencias		char(100);

define vr_Concepto  varchar(100);
define vr_Importe_Multa_Descto, vr_Importe_Gastos  money(12,2);

define v_r_rubro, v_r_cta_aplic, v1_r_cta_aplic, v2_r_cta_aplic, v3_r_cta_aplic	int;
define v_r_importe, v1_r_importe, v2_r_importe, v3_r_importe			money(12,2);
define v_DetFolReq, v0_DetFolReq, v1_DetFolReq, v2_DetFolReq, v3_DetFolReq, v_concepto				varchar(100);
--define v_importe_multa, v_tot_gastos, v_porcentaje_multa	Money(12,2);
  
define v_Ctrol_Operacion, v_exedencias	int;
define v_descripcion		varchar(50);
define v_importe		Money(12,2);
define v_aso_mes_pago		date;
define v_Axo, v_Mes, v_Axo_pp, v_Mes_pp	int;
define v_Importe_recargo, v_importe_rec1, v_importe_rec2	Money(12,2);
define v_mensaje_proc	varchar(200);

define v_contador		int;
define v_importe_Dscto_Tot, v_importe_Dscto Money(12,2);  -- adicionado por GMG 31/12/2019 para descuento por pronto pago

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
define v_aplica	char(1);
define v_porc_adic	int;

-- Descuento por pronto pago
define pp_fecha_inicio, pp_fecha_fin	date;
define pp_porc_dscto	decimal(5,2);

define v_porcdescto			int;
define v_mensaje			varchar(255);									
define v_Multa20, v_DsctoMulta	money(12,2);
define v_Multa20_tot, v_DsctoMulta_tot	money(12,2);

Let v_porcdescto	= 0;
Let v_mensaje	= '';
Let v_Multa20	= 0;
Let v_DsctoMulta	= 0;
Let v_Multa20_tot	= 0;
Let v_DsctoMulta_tot= 0;
--

Let v_status_licencias = 0;
Let v_concepto_licencias = ' ';

Let a_Periodo_CN = ' ';
Let a_Periodo_EXE = ' ';
Let r_Periodo_CN = ' ';
Let r_Periodo_EXE = ' ';

Let v_Ctrol_Operacion = 0;
Let v_exedencias = 0;
Let v_descripcion = ' ';
Let v_importe = 0;
Let v_Axo = 0;
Let v_Mes = 0;
Let v_Importe_recargo = 0;
Let v_importe_rec1 = 0;
Let v_importe_rec2 = 0;

Let v_contador = 0;
Let v_importe_Dscto = 0;


EXECUTE PROCEDURE con16_LPeriodo () INTO a_Periodo_CN, a_Periodo_EXE;

Let r_Periodo_CN = a_Periodo_CN;
Let r_Periodo_EXE = a_Periodo_EXE;
if p_rep <> 'V' then
	if trim(pref)='' then
   		Let v_ref=year(today) || '-' || 12;
		Let v_Axo_pp = Year(today);
	else
   		let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
		Let v_Axo_pp = substr(v_ref,1,4);
	end if;
	Let v_Mes_pp = substr(v_ref,6,2);

	Let a_Periodo_CN = v_ref;
	Let a_Periodo_EXE = v_ref;
else
	if trim(pref)='' then
		Let v_Axo_pp = year(today);
		Let v_Mes_pp = 12;
	else
		Let v_Axo_pp = substr(pref,1,4);
		Let v_Mes_pp = substr(pref,6,2);
	end if;
end if;
-- if (v_Axo_pp = Year(today)) and (v_Mes_pp = 12) then

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
SELECT aplica INTO v_aplica FROM ta_aplicareq;

-- Descuento por pronto pago
SELECT fecha_inicio, fecha_fin, porc_dscto INTO pp_fecha_inicio, pp_fecha_fin, pp_porc_dscto FROM ta_16_Dscto_pp WHERE status = 'V';

let v_control_contrato = 0;
if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo  ) then
	SELECT a.control_contrato  INTO  v_control_contrato   FROM ta_16_contratos a, ta_16_tipo_aseo b
    WHERE a.num_contrato = p_numero  and b.ctrol_aseo = a.ctrol_aseo and b.tipo_aseo = p_tipo;

	FOREACH
	Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
	Into v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion
	From ta_16_pagos a, ta_16_operacion b
	Where a.Control_Contrato = v_control_contrato  and a.aso_mes_pago <= a_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion = 6
	And b.ctrol_operacion = a.ctrol_operacion
	UNION ALL
	Select a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
	From ta_16_pagos a, ta_16_operacion b
	Where a.Control_Contrato = v_control_contrato  and a.aso_mes_pago <= a_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
	--Where a.Control_Contrato = v_control_contrato  and a.aso_mes_pago <= a_Periodo_EXE  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
	And b.ctrol_operacion = a.ctrol_operacion
	Order By 1, 4

	-- desde aqui
	if v_importe > 0 then
		if v_contador = 0 then
			-- LICENCIAS RELACIONADAS
			EXECUTE PROCEDURE sp16_LicenciaGiro_F1 ( p_tipo, p_numero ) INTO v_status_licencias, v_concepto_licencias;
			if v_status_licencias > 0 then
				RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v_concepto_licencias, Null, Null, Null, Null, Null    with resume;
			end if;

			-- REQUERIMIENTOS
			Let v_r_rubro = 0;  Let v_r_cta_aplic = 0;  
			Let v_r_importe = 0;  Let v1_r_importe = 0;  Let v2_r_importe = 0;  Let v3_r_importe = 0;
			Let v_DetFolReq = ' ';  Let v1_DetFolReq = ' ';  Let v2_DetFolReq = ' ';  Let v3_DetFolReq = ' ';

			FOREACH
			EXECUTE PROCEDURE sp_Requerim_F00 ( 16, v_control_contrato )  INTO v_r_rubro, v_r_cta_aplic, v_r_importe, v_DetFolReq
			if v_r_rubro =  0 then  Let v0_DetFolReq = v_DetFolReq;  end if;										-- Descripcion de documentos
			if v_r_rubro =  1 then  Let v1_DetFolReq = v_DetFolReq;  Let v1_r_importe = v_r_importe;  end if;		-- Importe de Multa
			if v_r_rubro =  2 then  Let v2_DetFolReq = v_DetFolReq;  Let v2_r_importe = v_r_importe;  end if;		-- Descuento a la Multa
			if v_r_rubro =  3 then  Let v3_DetFolReq = v_DetFolReq;  Let v3_r_importe = v_r_importe;  end if;		-- Importe de Gastos
			END FOREACH;
			
			if v_aplica = 'S' then
				if ( v1_r_importe <> 0 ) and ( v3_r_importe <> 0 ) then
					RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v0_DetFolReq, Null, Null, Null, v1_r_importe, v3_r_importe  with resume;
					if v2_r_importe <> 0 then
						RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v2_DetFolReq, Null, Null, Null, v2_r_importe, Null  with resume;
					end if;
				else
					if ( v1_r_importe = 0 ) and ( v3_r_importe <> 0 ) then
						RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v3_DetFolReq, Null, Null, Null, Null, v3_r_importe  with resume;
					end if;
				end if;
			else
				if v3_r_importe <> 0 then
					RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v3_DetFolReq, Null, Null, Null, Null, v3_r_importe  with resume;
				end if;
			end if;
		end if;
	
		if v_Ctrol_Operacion = 6 then
			-- INICIO DEL 10% POR PRONTO PAGO
			if pp_porc_dscto > 0 and p_rep <> 'V' then
				if today >= pp_fecha_inicio and today <= pp_fecha_fin then
					if v_Axo = Year(today) then  -- solo a�o actual
						Let v_importe_Dscto = (v_importe * pp_porc_dscto);
						Let v_importe_Dscto = v_importe_Dscto * -1;
					end if;
					--if (v_Axo_pp = Year(today)) and (v_Mes_pp = 12) then  -- todo el adeudo
					--	Let v_importe_Dscto = (v_importe * pp_porc_dscto);
					--	Let v_importe_Dscto = v_importe_Dscto * -1;
					--end if;
				end if;
			end if;
			-- FIN DEL 10% POR PRONTO PAGO
		
			SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
			WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN);
		else
            SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
            WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN); -- (r_Periodo_EXE);
		end if;

		if v_Importe_recargo <> 0 then  -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA en periodos vencidos
			execute PROCEDURE sp_multa_DestoMulta ( 16, v_control_contrato, v_axo, v_Mes, v_importe ) INTO v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;
			if v_Multa20 <> 0 then
				Let v_Multa20_tot = v_Multa20_tot + v_Multa20;
			end if;
			if v_DsctoMulta <> 0 then
				Let v_DsctoMulta_tot = v_DsctoMulta_tot + v_DsctoMulta;
			end if;
		end if;

        if v_Importe_recargo <> 0 then
			Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
            EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
            INTO v_importe_rec2, v_mensaje_proc;
		end if;
        if v_importe_rec2 <> 0 then
			Let v_importe_rec2 = v_importe_rec2 * -1;
        end if;
		Let v_contador = 1;
	end if;	
	-- hasta aqui
	if v_importe_rec1 <> 0 then
		RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, v_importe_rec1, Null, Null  with resume;
		if v_importe_Dscto <> 0 then 
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' 10% Dscto p/pp', Null, v_importe_Dscto, Null, Null, Null 	with resume;
		end if;
		if v_importe_rec2 <> 0 then
            RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Dscto. al Rcgo del Adeudo', Null, Null, v_importe_rec2, Null, Null 	with resume;
		end if;
	else
		RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, Null, Null, Null 	with resume;
		if v_importe_Dscto <> 0 then 
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' 10% Dscto p/pp', Null, v_importe_Dscto, Null, Null, Null 	with resume;
		end if;
	end if;
	-- lo quite

	Let v_Importe_recargo = 0;  -- revision
	Let v_importe_rec1 = 0;
	Let v_importe_rec2 = 0;
	Let v_importe_Dscto = 0; --
	Let v_descripcion = '';
	Let v_exedencias = 0;
	Let v_importe = 0;

	END FOREACH;

	-- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
	if v_Multa20_tot <> 0 then
		RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), 'Multas ', Null, Null, Null, v_Multa20_tot, Null	with resume;
	end if;
	if v_DsctoMulta_tot <> 0 then
		Let v_DsctoMulta_tot = v_DsctoMulta_tot * -1;
		RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), 'Descto. a Multa ', Null, Null, Null, v_DsctoMulta_tot, Null	with resume;
	end if;

end if;
end procedure;

CREATE PROCEDURE "pgmoreno".con16_detade_01xxx ( p_Control_contrato Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
{######################################################################
#  Procedimiento:    Con16_detade_01
#  Descripcion:      Interfaz de consulta de Estado de Cuenta Concentrado para el cobro de ASEO CONTRATADO en el m�dulo de ModulosGdl
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento vencidos dentro de ASEO CONTRATADO
#  Llama a:          
#  
######################################################################}
returning varchar(255) as Concepto,
Money(12,2) as Importe_Adeudos,
Money(12,2) as Importe_Recargos,
Money(12,2) as Importe_Multa,
Money(12,2) as Importe_Gastos;

--************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
define v_Contador	Integer;
--************************************************************************************************************** APREMIOS
define v_id_control, v_folio_req, v_FolReq	Integer;
define v_importe_multa, v_tot_multas, v_tot_dscto_multas, v_importe_gastos, v_tot_gastos	Money(12,2);
define v_diligencia	char(1);
--************************************************************************************************************** ADEUDOS / RECARGOS
define v_aso_mes_pago	Date;
define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2	Money(12,2);
define v_Axo, v_Mes, v_Axo_pp, v_Mes_pp	int;
define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato	Integer;
define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato	varchar(120);
define v_Importe_recargo, v_porcentaje_multa, v_TotRecargos, v_TotDsctoRrgos, v_Reg_1	Money(12,2);
define v_mensaje_proc	varchar(255);

define v_Ctrol_Operacion, v_exedencias	int;
define v_descripcion		varchar(50);
--************************************************************************************************************** AUXILIARES DE PERIODOS
define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy	varchar(4);
define a_Periodo_CN, a_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE		varchar(7);
define v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade	varchar(7);
define v_Periodo	varchar(9);
define aso_proceso, aso_actual, v_porc	Integer;
--************************************************************************************************************** 
define v_Follic	Integer;
define v_DetFollic	varchar(120);

define  v_ref     char(7);

define v_importe_Dscto_Tot, v_importe_Dscto Money(12,2);  -- adicionado por GMG 31/12/2019 para descuento por pronto pago

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
define v_aplica	char(1);
define v_porc_adic	int;

-- Descuento por pronto pago
define pp_fecha_inicio, pp_fecha_fin	date;
define pp_porc_dscto	decimal(5,2);
			
define v_r_rubro, v_r_cta_aplic, v1_r_cta_aplic, v2_r_cta_aplic, v3_r_cta_aplic	int;
define v_r_importe, v1_r_importe, v2_r_importe, v3_r_importe			money(12,2);
define v_DetFolReq, v0_DetFolReq, v1_DetFolReq, v2_DetFolReq, v3_DetFolReq, v_concepto				varchar(100);

define v_porcdescto			int;
define v_mensaje			varchar(255);									
define v_Multa20, v_DsctoMulta	money(12,2);
define v_Multa20_tot, v_DsctoMulta_tot	money(12,2);

Let v_porcdescto	= 0;
Let v_mensaje	= '';
Let v_Multa20	= 0;
Let v_DsctoMulta	= 0;
Let v_Multa20_tot	= 0;
Let v_DsctoMulta_tot= 0;
   
Let v_Detalle_T = ' ';
Let v_importe = 0;
Let v_Importe_recargo = 0;
Let v_totAdeudos = 0;
Let v_TotRecargos = 0;
Let v_TotDsctoRrgos = 0;
Let v_importe_rec1 = 0;
Let v_importe_rec2 = 0;
Let v_axo = 0;
Let v_Lineas_Dato = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO a_Periodo_CN, a_Periodo_EXE;

Let r_Periodo_CN = a_Periodo_CN;
Let r_Periodo_EXE = a_Periodo_EXE;
if p_rep <> 'V' then
	if trim(p_Fecha_fin)='' then
   		Let v_ref=year(today) || '-' || 12;
		Let v_Axo_pp = Year(today);
	else
   		let v_ref=substr(p_Fecha_fin,1,4) || '-' || substr(p_Fecha_fin,6,2);
		Let v_Axo_pp = substr(v_ref,1,4);
	end if;
	Let v_Mes_pp = substr(v_ref,6,2);

	Let a_Periodo_CN = v_ref;
	Let a_Periodo_EXE = v_ref;
else
	if trim(p_Fecha_fin)='' then
		Let v_Axo_pp = year(today);
		Let v_Mes_pp = 12;
	else
		Let v_Axo_pp = substr(p_Fecha_fin,1,4);
		Let v_Mes_pp = substr(p_Fecha_fin,6,2);
	end if;
end if;
-- if (v_Axo_pp = Year(today)) and (v_Mes_pp = 12) then

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
SELECT aplica INTO v_aplica FROM ta_aplicareq;

-- Descuento por pronto pago
SELECT fecha_inicio, fecha_fin, porc_dscto INTO pp_fecha_inicio, pp_fecha_fin, pp_porc_dscto FROM ta_16_Dscto_pp WHERE status = 'V';

if exists( SELECT * FROM ta_16_contratos WHERE control_contrato = p_Control_contrato ) then

	-- LICENCIAS RELACIONADAS
	EXECUTE PROCEDURE sp16_LicenciaGiro_F0 ( p_Control_contrato ) INTO v_Follic, v_DetFollic;
	if v_Follic > 0 then
		RETURN v_DetFollic, Null, Null, Null, Null     with resume;
	end if;

	-- REQUERIMIENTOS
	Let v_r_rubro = 0;  Let v_r_cta_aplic = 0;  
	Let v_r_importe = 0;  Let v1_r_importe = 0;  Let v2_r_importe = 0;  Let v3_r_importe = 0;
	Let v_DetFolReq = ' ';  Let v1_DetFolReq = ' ';  Let v2_DetFolReq = ' ';  Let v3_DetFolReq = ' ';
	FOREACH
	EXECUTE PROCEDURE sp_Requerim_F00 ( 16, p_Control_contrato )  INTO v_r_rubro, v_r_cta_aplic, v_r_importe, v_DetFolReq
	if v_r_rubro =  0 then  Let v0_DetFolReq = v_DetFolReq;  end if;										-- Descripcion de documentos
	if v_r_rubro =  1 then  Let v1_DetFolReq = v_DetFolReq;  Let v1_r_importe = v_r_importe;  end if;		-- Importe de Multa
	if v_r_rubro =  2 then  Let v2_DetFolReq = v_DetFolReq;  Let v2_r_importe = v_r_importe;  end if;		-- Descuento a la Multa
	if v_r_rubro =  3 then  Let v3_DetFolReq = v_DetFolReq;  Let v3_r_importe = v_r_importe;  end if;		-- Importe de Gastos
	END FOREACH;

	if v_aplica = 'S' then
		if ( v1_r_importe <> 0 ) and ( v3_r_importe <> 0 ) then
			RETURN v0_DetFolReq, Null, Null, v1_r_importe, v3_r_importe  with resume;
			if v2_r_importe <> 0 then
				RETURN v2_DetFolReq, Null, Null, v2_r_importe, Null  with resume;
			end if;
		else
			if ( v1_r_importe = 0 ) and ( v3_r_importe <> 0 ) then
				RETURN v3_DetFolReq, Null, Null, Null, v3_r_importe  with resume;
			end if;
		end if;
	else
		if v3_r_importe <> 0 then
			RETURN v3_DetFolReq, Null, Null, Null, v3_r_importe  with resume;
		end if;
	end if;

	Let aso_proceso = 0;
	Let aso_actual = Year(Current);

	FOR aso_proceso = 1989 to aso_actual
		Let v_Lineas_EX = 0;
        Let v_Detalle_EX = ' EXE. Mes(s) --';
							   
		Let v_Lineas_CN = 0;
        Let v_Detalle_CN = ' C.N. Mes(s) --';
		FOREACH
	
		SELECT a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
		INTO v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion
		FROM ta_16_pagos a, ta_16_operacion b
		WHERE a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= a_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion = 6
		And Year(a.aso_mes_pago) = aso_proceso and b.ctrol_operacion = a.ctrol_operacion
		UNION ALL
		SELECT a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
		FROM ta_16_pagos a, ta_16_operacion b
		WHERE a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= a_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
		--Where a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= a_Periodo_EXE  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
		And Year(a.aso_mes_pago) = aso_proceso and b.ctrol_operacion = a.ctrol_operacion
		ORDER BY 1, 4
	
		-- incrustado
		if v_importe > 0 then
			if v_Ctrol_Operacion = 6 then
				-- INICIO DEL 10% POR PRONTO PAGO
				if pp_porc_dscto > 0 and p_rep <> 'V' then
					if today >= pp_fecha_inicio and today <= pp_fecha_fin then
						if v_Axo = Year(today) then  -- solo a�o actual
							Let v_importe_Dscto = (v_importe * pp_porc_dscto);
							Let v_importe_Dscto = v_importe_Dscto * -1;
						end if;
					end if;
				end if;
				-- FIN DEL 10% POR PRONTO PAGO
			
				if v_Lineas_CN > 0 then
					Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                else
					Let v_Detalle_CN = v_Detalle_CN||v_Mes;
                end if;
                Let v_totAdeudos = v_totAdeudos + v_importe;
                Let v_Lineas_CN = v_Lineas_CN + 1;
				
				SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
				WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN);
			else
				if v_Lineas_EX > 0 then
					Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                else
                    Let v_Detalle_EX = v_Detalle_EX||v_Mes;
                end if;
                Let v_totAdeudos = v_totAdeudos + v_importe;
                Let v_Lineas_EX = v_Lineas_EX + 1;
			
				SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos 
				WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN); -- (r_Periodo_EXE);
			end if;
		end if;

		if v_Importe_recargo <> 0 then  -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA en periodos vencidos
			execute PROCEDURE sp_multa_DestoMulta ( 16, p_Control_contrato, v_axo, v_Mes, v_importe ) INTO v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;
			if v_Multa20 <> 0 then
				Let v_Multa20_tot = v_Multa20_tot + v_Multa20;
			end if;
			if v_DsctoMulta <> 0 then
				Let v_DsctoMulta_tot = v_DsctoMulta_tot + v_DsctoMulta;
			end if;
		end if;

        if v_Importe_recargo <> 0 then
			Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
			Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
            EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
            INTO v_importe_rec2, v_mensaje_proc;
		end if;
        if v_importe_rec2 <> 0 then
			Let v_importe_rec2 = v_importe_rec2 * -1;
			Let v_TotDsctoRrgos = v_TotDsctoRrgos + v_importe_rec2;
        end if;
		
		Let v_importe = 0;
        Let v_Importe_recargo = 0;
        Let v_importe_rec1 = 0;
        Let v_importe_rec2 = 0;
        END FOREACH;
		
		--     Grabando registro
		if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
			--Let v_Detalle_T = 'Adeudos del ' || aso_proceso || ' ';
			Let v_Detalle_T = aso_proceso;
			if v_Lineas_CN > 0 then
				Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
			end if;
			if v_Lineas_EX > 0 then
				Let v_Detalle_T = v_Detalle_T|| ' ' || v_Detalle_EX;
			end if;
			return v_Detalle_T , v_totAdeudos, v_TotRecargos, Null, Null  with resume;
			if v_TotDsctoRrgos > 0 then
				Let v_TotDsctoRrgos = v_TotDsctoRrgos * -1;
                return 'Dscto. al Rcgo del Adeudo' , Null, v_TotDsctoRrgos, Null, Null  with resume;
			end if;
		end if;
		
		Let v_totAdeudos = 0;
		Let v_TotRecargos = 0;
		Let v_TotDsctoRrgos = 0;
		Let v_Detalle_T = '';
	END FOR;
	
end if;

end procedure;

create function "pgcabrer".fn_getpagoslocaxo(fid int,fdsd date,fhst date,paxo int)
returning   money(16,2) as total;

define v_pagoaxo money(16,2);

-- pagos a�o especial
select nvl(sum(importe_pago),0) into v_pagoaxo
from ta_11_pagos_local 
where (fecha_pago between fdsd and fhst) and axo=paxo
and id_local=fid;

return v_pagoaxo;
end function;

create procedure "pgcabrer".spd_11_pagoslocaxo(pmerc int,pdsd date,phst date,paxo int)
returning   char(30) as mercado,
            integer as rec,
            integer as merc,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(100) as nombre,
            integer as mesinicial,
            integer as mesfinal,
            MONEY(16,2) as total;
  
define v_rezago,v_actual,v_total MONEY(16,2);  
define v_mer char(30);
define v_nombre varchar(100);          
define v_nme,v_ofi,v_cat,v_loc,v_id,v_pagos,v_mesini, v_mesfin integer;          
define v_sec char(2);           
define v_let char(3);
define v_blq char(2);        

foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque,a.nombre,
min(d.periodo), max(d.periodo),count(d.id_local)  
into v_mer,v_id,v_ofi,v_nme,v_sec,v_loc,v_let,v_blq,v_nombre,v_mesini,v_mesfin,v_pagos
from ta_11_locales a, ta_11_mercados b,ta_11_pagos_local d
where a.num_mercado=pmerc and a.vigencia='A' and d.axo=paxo
and b.num_mercado_nvo=a.num_mercado and d.id_local=a.id_local
and (d.fecha_pago between pdsd and phst)
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque,a.nombre
order by a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque

if v_pagos > 0 then
   execute function fn_getpagoslocaxo(v_id,pdsd,phst,paxo) into v_total;
end if;
return v_mer,v_ofi,v_nme,v_sec,v_loc,v_let,v_blq,v_nombre,v_mesini,v_mesfin,v_total  
with resume;

end foreach; -- cierre del principal

end procedure;

CREATE PROCEDURE "informix".con16_detade_021 ( p_Control_contrato Integer )
returning Integer, -- control del registro
varchar(7),         -- Periodo
varchar(15),       -- Concepto de Operacion
Integer,            -- Control de Operacion
Integer,            -- Cantidad de recoleccion
Money(12,2),        -- Importe Adeudos
Money(12,2);        -- Importe Recargos

{
#  Procedimiento: Con16_detade_021
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#  Parametros de salida:   Control :   dato de control del registro
#  Elaboro:    c. Gilberto Moreno
#  Modifico:
#  Fecha Modificaci�n :
}

--****************************************************************************************************************************** AUXILIARES DE PERIODOS
 define v_Periodo_CN, v_Periodo_EXE, v_Periodo_Ade                                                           varchar(7);
 define v_Descrip_operacion                                                                                                 varchar(15);
 define v_Ctrol_Operacion, v_Cantidad                                                                                            Integer;
 define v_importe                                                                                                                       Money(12,2);
--******************************************************************************************************************************

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;  

foreach
Select Year(A.aso_mes_pago) || '-'|| LPAD(Month(A.aso_mes_pago),2,0), B.descripcion, A.Ctrol_Operacion, A.exedencias, A.importe
INTO v_Periodo_Ade, v_Descrip_operacion , v_Ctrol_Operacion, v_Cantidad, v_importe
From ta_16_pagos A, ta_16_operacion B
Where a.Control_Contrato = p_Control_contrato --and a.aso_mes_pago <= v_Periodo_CN
and a.Status_Vigencia = 'V' and a.Ctrol_Operacion = 6
and b.ctrol_operacion = a.ctrol_operacion
UNION ALL
Select Year(A.aso_mes_pago) || '-'|| LPAD(Month(A.aso_mes_pago),2,0), B.descripcion, A.Ctrol_Operacion, A.exedencias, A.importe
From ta_16_pagos A, ta_16_operacion B
Where a.Control_Contrato = p_Control_contrato --and a.aso_mes_pago <= v_Periodo_EXE
and a.Status_Vigencia = 'V' and a.Ctrol_Operacion <> 6
and b.ctrol_operacion = a.ctrol_operacion
Order By 1, 3

if v_Cantidad > 0 then
RETURN p_Control_contrato, v_Periodo_Ade, v_Descrip_operacion, v_Ctrol_Operacion, v_Cantidad, v_importe, 0  with resume;
end if;
end foreach;

end procedure;

create procedure "pgcabrer".admin_adeudos_detalle_13odoo19(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(120) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia,v_mensaje varchar(30);
define  v_cveparc char(1);
define  v_letra1,v_let varchar(3);
define  v_bloque1,v_blq varchar(2);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses decimal(14,2);
define  v_aimporte,v_descuento,v_porc,v_gastost,v_impdesc,v_muldesc, v_impcovid19 decimal(14,2);
define  v_folreq,dias_cuantos,dias_habil,v_axomin,v_mesmin int;
define  v_fecreq,v_fecha_desc,v_fecha_rec,v_fecemi date;
define  v_id,v_idresto,v_idadeudo,v_parc,v_aaxo,v_aperiodo,v_dmes,v_desc,v_contador,v_porcdesc,v_cvecuo int;
define  v_ref char(7);
define  v_cuentaapl,v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp,v_porccovid19 int;

begin
    on exception in (-958)
       delete from tmp_totalesmerc;
    end exception;
create temp table tmp_totalesmerc(
  rubro int,
  concepto int,
  cuenta int,
  axo int,
  mes int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_porccovid19=0;
let v_impcovid19=0;
let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;
let v_contador=0;
let v_gastost=0;
let v_aperiodo=0;
let v_impdesc=0;
let v_muldesc=0;

if trim(pref)='' then
   let v_ref=year(today)||'/12';
--   let v_ref='2020/12';
else
   let v_ref=trim(pref);
end if;

if month(today)=4 then let v_porccovid19=1.47; 
else if month(today)=5 then let v_porccovid19=2.94;
else if  month(today)=6 then let v_porccovid19=4.41;
else let  v_porccovid19=0;
end if; end if; end if; 

foreach
select id_local,letra_local,bloque,clave_cuota into v_id,v_let,v_blq,v_cvecuo
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    -- obtiene las cuentas de aplicacion para el mercado
    select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,
           cuenta_descmulta,cuenta_gastos,cuenta_descpp
    into v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp
    from ta_11_mercados where num_mercado_nvo=pmer;

    -- cuentas para locales exteriores del rastro cambios 2020
    if (pmer=90) and (v_cvecuo=17) then
       let v_ctaact=132010090;
       let v_ctarzg=132030090;
    end if;

    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id;
    -- para sacar el mes minimo      
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id and axo=v_axomin;

    if pmer=70 then
       let v_axomin=2017;
       let v_mesmin=1;
    end if;

    if trim(pmer)=34 then
       if (today>=mdy(5,13,2019)) and (today<=mdy(6,15,2019)) then
          execute procedure spd_15_descautrm(v_id, 'S', 'S',substr(v_ref,1,4),substr(v_ref,6,2) );
       end if;
    end if;

    -- para obtener el datos de multa y gastos
    foreach
    select b.fecha_emision,nvl(b.folio,0), nvl(b.importe_multa,0),nvl(importe_gastos,0),
    nvl(b.porcentaje_multa,0),nvl(b.fecha_practicado,null)
    into v_fecemi,v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
    from ta_15_apremios b
    where b.modulo=11 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
    order by  1,2
    let v_gastost=v_gastost+v_gastos;
    end foreach;

    let dias_cuantos=0;

    select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales
    where fecha between v_fecreq and today;
   
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
--           let v_multa=v_multa*50/100;
           let v_muldesc=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
--              let v_multa=v_multa*80/100;
              let v_muldesc=v_multa*20/100;
           end if;
        end if;
    else
--        let v_multa=(v_multa*(100-v_porcmul))/100;
        let v_muldesc=(v_multa*v_porcmul)/100;
    end if;

    if v_multa>0 then
       let v_acumulado=v_acumulado+v_multa;
       return 0,v_ctamul, get_odoo_cta( v_ctamul , 13),v_axomin||'/'||lpad(v_mesmin,2,'0'),'MULTA '||v_folreq,v_multa,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctamul,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'MULTA '||v_folreq,v_multa,v_acumulado);
    end if;

    if v_muldesc>0 then
       let v_muldesc=v_muldesc*-1;
       let v_acumulado=v_acumulado+v_muldesc;
       return 0,v_ctadesmul, get_odoo_cta( v_ctadesmul , 13),v_axomin||'/'||lpad(v_mesmin,2,'0'),'DESCUENTO MULTA '||v_folreq,v_muldesc,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctadesmul,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'DESCUENTO MULTA '||v_folreq,v_muldesc,v_acumulado);
    end if;

    if v_gastost>0 then
       let v_acumulado=v_acumulado+v_gastost;
       return 0,v_ctagst, get_odoo_cta( v_ctagst , 13),v_axomin||'/'||lpad(v_mesmin,2,'0'),'GASTOS '||v_folreq,v_gastost,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctagst,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'GASTOS '||v_folreq,v_gastost,v_acumulado);
    end if;

    foreach
    select a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos,
           d.id_contribuy_renta
    into   v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec,v_desc
    from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d
    where a.id_local=v_id and
    ( (a.axo>v_axomin  or (periodo>=v_mesmin  and axo=v_axomin)) and
   ((a.axo=substr(v_ref,1,4)  and a.periodo<=substr(v_ref,6,2)) or (a.axo<substr(v_ref,1,4))) )  

    and b.mes=month(today) and d.id_local=a.id_local
    order by a.axo,a.periodo
    let v_porc=0;
    let v_monto=0;
    let v_impdesc=0;
    let v_impcovid19=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    if (pmer=90) or (v_cvecuo=19) then
       let v_monto=v_aimporte;
    else
    if pmer=214 then
       let v_impdesc=(v_aimporte*v_desc)/100;
       let v_monto=v_aimporte;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_monto=v_aimporte;
             else
                let v_impdesc=v_aimporte*.10;
                let v_monto=v_aimporte;
             end if;
          else
             let v_impdesc=v_aimporte*.10;
             let v_monto=v_aimporte;  
          end if;
       else
          let v_monto=v_aimporte;
       end if;  
    end if;
    end if;
    if  v_aaxo=year(today) then
        let v_cuentaapl=v_ctaact;
    else
        let v_cuentaapl=v_ctarzg;
    end if;
    let v_acumulado=v_acumulado+v_monto;
    if pmer=214 then
       return 0,v_cuentaapl, get_odoo_cta( v_cuentaapl , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'PAGO TRIMESTRAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'PAGO TRIMESTRAL',v_monto,v_acumulado);
    else
       return 0,v_cuentaapl, get_odoo_cta( v_cuentaapl , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado);
    end if;

    if v_impdesc>0 then
       let v_impdesc=v_impdesc*-1;
       let v_acumulado=v_acumulado+v_impdesc;
       if pmer=214 then
          return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado);
       else
          return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado);
       end if;
    end if;

    if (v_cvecuo=19) and (v_aaxo=2020) and (v_aperiodo=1) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2018 peticion de Claudia Jara por correo
       execute procedure admin_recargos_13(pmer,v_folreq,(v_monto+v_impdesc),mdy(v_aperiodo,31,v_aaxo)) into v_recargos;
    else
       execute procedure admin_recargos_13(pmer,v_folreq,(v_monto+v_impdesc),mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos;
    end if;
   
 --   if (pmer=19 and v_aaxo>=2019) or (pmer=37 and v_aaxo>=2019) then -- quitar esta validacion terminando la promocion
 --      if (today>=mdy(3,4,2020)) and (today<=mdy(3,20,2020)) then
 --          let v_recargos=0;
 --      end if;  
 --   end if;

    if v_recargos>0 then
       let v_acumulado=v_acumulado+v_recargos;
       if pmer=214 then
          return 0,v_ctarec, get_odoo_cta( v_ctarec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO TRIMESTRAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO TRIMESTRAL',v_recargos,v_acumulado);
       else
          return 0,v_ctarec, get_odoo_cta( v_ctarec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO MENSUAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO MENSUAL',v_recargos,v_acumulado);
       end if;

       -- calculo descuento de recargos por contingencia de covid19
       let v_impcovid19=0;
       if (v_recargos>0) and (v_porccovid19>0) then
             let v_impcovid19=(v_monto*v_porccovid19) / 100;
             let v_impcovid19=v_impcovid19*-1;
             let v_acumulado=v_acumulado+v_impcovid19;  
             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL CONTINGENCIA COVID-19 '||v_porccovid19||'%',v_impcovid19,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO MENSUAL COVID-19'||v_porccovid19||'%',v_impcovid19,v_acumulado);
       end if;

       let v_descuento=0;
       execute procedure sp_desctomerc(v_id,v_aaxo,v_aperiodo,1,v_recargos,null,0,'',0,11) into v_descuento,v_mensaje;
       if v_descuento>0 then
          let v_porcdesc=substr(v_mensaje,length(v_mensaje)-2,3);
          let v_descuento=v_descuento*-1;
          let v_acumulado=v_acumulado+v_descuento;
          if pmer=214 then
             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          else
             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          end if;
       end if;
    end if;
    end foreach;
end if;
end foreach;

end procedure;

create procedure "pgcabrer".spd_11_prescmasiva()
returning   int as total;

define vtotal,vid,vaxo,vmes,viduser,vcont int;
define vimporte money(18,2);
define vfecha date;
let vcont=0;

foreach
select b.id_local,b.axo,b.periodo,b.importe,b.fecha_alta,b.id_usuario into vid,vaxo,vmes,vimporte,vfecha,viduser
FROM ta_11_locales a,ta_11_adeudo_local b where b.id_local=a.id_local
and ((b.axo>2020  or (b.periodo>=4  and b.axo=2020)) and (b.axo<2020  or (b.periodo<=6 and b.axo=2020)))

insert into ta_11_ade_loc_canc values (0,vid,vaxo,vmes,vimporte,'C','CONDONACION DE ADEUDO COVID-19 PETICION INGRESOS',vfecha,viduser);

delete from ta_11_adeudo_local where id_local=vid and axo=vaxo and periodo=vmes;
let vcont=vcont+1;
end foreach;
return vcont;

end procedure;

create procedure "pgcabrer".spd_11_generacartera90(prec int,paxo int)
returning   int as locales,
            int as meses,
            int as existeade,
            int as existepagcan;

define vid,vofi,vmer,vcat,vloc,vaxo,vcvecuo,v_cont int;
define vtotloc,vtotmeses,vtotexia,vtotextpc int;
define vsec char(2);
define vlet,vblq char(1);
define vsuperf decimal(7,2);
define vimpcuo,vade money(18,2);

let vtotloc=0;
let vtotmeses=0;
let vtotexia=0;
let vtotextpc=0;

foreach
  select a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,a.superficie,
  c.axo,c.clave_cuota,c.importe_cuota
  into vid,vofi,vmer,vcat,vsec,vloc,vlet,vblq,vsuperf,vaxo,vcvecuo,vimpcuo
  from ta_11_locales a,ta_11_mercados b,ta_11_cuo_locales c
  where a.oficina=prec and a.vigencia='A' and a.bloqueo<4 and b.tipo_emision<>'B' and a.num_mercado=90
  and a.oficina=b.oficina and a.num_mercado=b.num_mercado_nvo
  and c.axo=paxo and a.categoria=c.categoria and a.seccion=c.seccion and a.clave_cuota=c.clave_cuota
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

  let vtotloc=vtotloc+1;
  -- calcula renta
  let vade=0;
  if vsec='PS' then
     if vcvecuo=4 then
        let vade=vsuperf*vimpcuo;
     else
        if (paxo < 2019) or (paxo = 2020) then
           let vade=(vimpcuo*vsuperf)*30;
        else
           let vade=vsuperf*vimpcuo;
        end if;
     end if
  else
     let vade=vsuperf*vimpcuo;
  end if;

  -- graba el adeudo mensual
  for v_cont= 1 to 12
      if ((not exists(select * from ta_11_pagos_local where id_local=vid and axo=vaxo and periodo=v_cont)) and
         (not exists(select * from ta_11_ade_loc_canc where id_local=vid and axo=vaxo and periodo=v_cont))) then
         if not exists(select * from ta_11_adeudo_local where id_local=vid and axo=vaxo and periodo=v_cont) then
            insert into ta_11_adeudo_local values(0,vid,vaxo,v_cont,vade,current,18);
            let vtotmeses=vtotmeses+1;
         else
            let vtotexia=vtotexia+1;
         end if
      else 
         let vtotextpc=vtotextpc+1; 
      end if; 
  end for; 
end foreach;

return vtotloc,vtotmeses,vtotexia,vtotextpc;
end procedure;

create procedure "pgcabrer".sp_condonadascero()
returning  int as locales,
           int as meses;

define v_total, v_mer, v_cat, v_cve, v_id, v_meses, v_con int;
define v_sec char(2);
define v_sup decimal(7,2);
define v_renta money(18,2);

let v_meses=0;
let v_total=0;

foreach
  select id_local,count(*)  into v_id, v_con from ta_11_ade_loc_canc
  where axo=2020 and periodo in(4,5,6) and clave_canc='C' and importe=0
  group by id_local order by id_local
  
  let v_meses=v_meses+v_con;
  let v_total=v_total+1;
 
  select num_mercado, categoria, seccion, superficie, clave_cuota into v_mer, v_cat, v_sec, v_sup, v_cve
  from ta_11_locales where id_local=v_id;

  execute PROCEDURE spd_11_calc_renta(2020, v_cat, v_sec, v_cve, v_sup, v_mer, 0) into v_renta;

  update ta_11_ade_loc_canc set importe=v_renta 
  where axo=2020 and periodo in(4,5,6) and clave_canc='C' and importe=0 and id_local=v_id;

end foreach;

return v_total, v_meses;

end procedure;

create procedure "pgcabrer".spd_15_notif_mes(papract int, paemi int, pfpdsd date, pfphst date)
returning  varchar(20) as modulo,
           int as mes,
           int as axo,
           int as ejecutor,
           int as asignados,
           int as practicados,
           int as cancelados,
           int as pagados,
           money(18,2) as recaudado;

define v_modulo varchar(20);
define v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados int;
define v_recaudado money(18,2);

foreach
select 'Predial', month(a.fecemi), year(a.fecemi), nvl(a.cveejecut,0), nvl(count(distinct a.cvereq),0)
,nvl(count(r.cvereq),0), nvl(count(rc.cvereq),0), nvl(count(rp.cvereq),0), nvl(sum(p.importe),0) 
--into v_modulo, v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados, v_recaudado
from catastro_gdl:reqpredial a
left join  catastro_gdl:reqpredial r on r.cvereq=a.cvereq and year(r.fecent)=papract
left join  catastro_gdl:reqpredial rc on rc.cvereq=a.cvereq and rc.vigencia='C'
left join  catastro_gdl:pagos p on p.cvepago=a.cvepago and (p.fecha between pfpdsd and pfphst)
left join  catastro_gdl:reqpredial rp on rp.cvereq=a.cvereq and rp.cvepago>0 and rp.cvepago=p.cvepago
 where year(a.fecemi)=paemi 
group by 1,2,3,4 
UNION
select 'Licencias', month(a.fecemi), year(a.fecemi), nvl(a.cveejecut,0), nvl(count(distinct a.cvereq),0)
,nvl(count(r.cvereq),0), nvl(count(rc.cvereq),0), nvl(count(rp.cvereq),0), nvl(sum(p.importe),0) 
--into v_modulo, v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados, v_recaudado
from catastro_gdl:reqlicencias a
left join  catastro_gdl:reqlicencias r on r.cvereq=a.cvereq and year(r.fecprac)=papract
left join  catastro_gdl:reqlicencias rc on rc.cvereq=a.cvereq and rc.vigencia='C'
left join  catastro_gdl:pagos p on p.cvepago=a.cvepago and (p.fecha between pfpdsd and pfphst)
left join  catastro_gdl:reqlicencias rp on rp.cvereq=a.cvereq and rp.cvepago>0 and rp.cvepago=p.cvepago
where year(a.fecemi)=paemi 
group by 1,2,3,4 
UNION
select 'Multas', month(a.fecemi), year(a.fecemi), nvl(a.cveejecut,0), nvl(count(distinct a.cvereq),0)
,nvl(count(r.cvereq),0), nvl(count(rc.cvereq),0), nvl(count(rp.cvereq),0), nvl(sum(p.importe),0)
--into v_modulo, v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados, v_recaudado
from catastro_gdl:reqmultas a
left join  catastro_gdl:reqmultas r on r.cvereq=a.cvereq and year(r.fecpract)=papract
left join  catastro_gdl:reqmultas rc on rc.cvereq=a.cvereq and rc.vigencia='C'
left join  catastro_gdl:pagos p on p.cvepago=a.cvepago and (p.fecha between pfpdsd and pfphst)
left join  catastro_gdl:reqmultas rp on rp.cvereq=a.cvereq and rp.cvepago>0 and rp.cvepago=p.cvepago
where year(a.fecemi)=paemi
group by 1,2,3,4 
UNION
select 'Mercados', month(a.fecha_emision), year(a.fecha_emision), nvl(a.ejecutor,0), nvl(count(distinct a.id_control),0)
,nvl(count(r.id_control),0), nvl(count(rc.id_control),0), nvl(count(rp.id_control),0), nvl(sum(p.importe),0)
--into v_modulo, v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados, v_recaudado
from db_ingresos:ta_15_apremios a
left join  db_ingresos:ta_15_apremios r on r.id_control=a.id_control and year(r.fecha_practicado)=papract
left join  db_ingresos:ta_15_apremios rc on rc.id_control=a.id_control and rc.vigencia='3'
left join  db_ingresos:ta_15_apremios rp on rp.id_control=a.id_control and (rp.fecha_pago between pfpdsd and pfphst) and rp.vigencia='2'
left join  db_ingresos:ta_12_recibos p on p.fecha=a.fecha_pago and p.id_rec=a.recaudadora and p.caja=a.caja and p.operacion=a.operacion 
           and (p.fecha between pfpdsd and pfphst)
where year(a.fecha_emision)=paemi and a.modulo=11
group by 1,2,3,4 
UNION
select 'Aseo Contratado', month(a.fecha_emision), year(a.fecha_emision), nvl(a.ejecutor,0), count(distinct a.id_control)
,nvl(count(r.id_control),0), nvl(count(rc.id_control),0), nvl(count(rp.id_control),0), nvl(sum(p.importe),0)
--into v_modulo, v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados, v_recaudado
from db_ingresos:ta_15_apremios a
left join  db_ingresos:ta_15_apremios r on r.id_control=a.id_control and year(r.fecha_practicado)=papract
left join  db_ingresos:ta_15_apremios rc on rc.id_control=a.id_control and rc.vigencia='3'
left join  db_ingresos:ta_15_apremios rp on rp.id_control=a.id_control and (rp.fecha_pago between pfpdsd and pfphst) and rp.vigencia='2'
left join  db_ingresos:ta_12_recibos p on p.fecha=a.fecha_pago and p.id_rec=a.recaudadora and p.caja=a.caja and p.operacion=a.operacion 
           and (p.fecha between pfpdsd and pfphst)
where year(a.fecha_emision)=paemi and a.modulo=16
group by 1,2,3,4 
UNION
select 'Estacionometros', month(a.fecha_emision), year(a.fecha_emision), nvl(a.ejecutor,0), count(distinct a.id_control)
,nvl(count(r.id_control),0), nvl(count(rc.id_control),0), nvl(count(rp.id_control),0), nvl(sum(p.importe),0)
into v_modulo, v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados, v_recaudado
from db_ingresos:ta_15_apremios a
left join  db_ingresos:ta_15_apremios r on r.id_control=a.id_control and year(r.fecha_practicado)=papract
left join  db_ingresos:ta_15_apremios rc on rc.id_control=a.id_control and rc.vigencia='3'
left join  db_ingresos:ta_15_apremios rp on rp.id_control=a.id_control and (rp.fecha_pago between pfpdsd and pfphst) and rp.vigencia='2'
left join  db_ingresos:ta_12_recibos p on p.fecha=a.fecha_pago and p.id_rec=a.recaudadora and p.caja=a.caja and p.operacion=a.operacion 
           and (p.fecha between pfpdsd and pfphst)
where year(a.fecha_emision)=paemi and a.modulo=14
group by 1,2,3,4 order by 1,3,2,4

return v_modulo, v_mes, v_axo, v_ejecutor, v_asignados, v_practicados, v_cancelados, v_pagados, v_recaudado with resume;
end foreach;

end procedure;

create procedure "pgcabrer".calc_recarmerc_esp(pmer int,pfol int,pimp money(18,2),pven date,ppag date)
returning   money(18,2) as recargos;

define v_recargos money(18,2);
define v_porc decimal(5,2);
define v_aperiodo,v_primermes int;

let v_aperiodo=0;


if pmer <>214 then
   if day(ppag)<day(pven) then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>year(pven)  or (mes>=month(pven)  and axo=year(pven))) and
            (axo<year(ppag)  or (mes<=(month(ppag)-1) and axo =year(ppag))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>year(pven) or (mes>=month(pven)  and axo=year(pven))) and
            (axo<year(ppag)  or (mes<=month(ppag) and axo =year(ppag))) );
   end if;
else 
   if month(pven)=1 then let v_primermes=1;
   else if month(pven)=2 then let v_primermes=4;
   else if month(pven)=3 then let v_primermes=7;
   else if month(pven)=4 then let v_primermes=10;
   else let v_primermes=0;
   end if;
   end if;
   end if;
   end if;

   if (month(today)=1) or (month(today)=4) or (month(today)=7) or (month(today)=10)  then
      if day(today)<day(pven) then
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>year(pven)  or (mes>=v_primermes  and axo=year(pven))) and
               (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
      else
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>year(pven) or (mes>=v_primermes  and axo=year(pven))) and
               (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
      end if;
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>year(pven) or (mes>=v_primermes  and axo=year(pven))) and
            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
   end if;
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  pfol = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(pimp*100)/100;
    else
       let v_recargos=trunc(pimp*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(pimp*250)/100;
    else
       let v_recargos=trunc(pimp*v_porc)/100;
    end if;
end if;
return v_recargos;
end procedure;

create procedure "pgcabrer".spd_11_pag_calcrec(pmer int, paxo int, pfdsd date, pfhst date)
returning    varchar(100) as descripcion,
            int as id_local,
            int as oficina,
            int as num_mercado,
            char(2) as seccion,
            int as local,
            char(3) as letra_local,
            char(3) as bloque,
            varchar(100) as nombre,
            date as fechapago,
            int as oficina_pago,
            char(2) as caja_pago,
            int as operacion_pago,
            int as axo,
            int as mes,
            money(18,2) as importerenta,
            money(18,2) as recragos; 

define v_descripcion, v_nombre varchar(100);
define v_id_local, v_oficina, v_num_mercado, v_local, v_axo, v_mes, v_oficina_pago, v_operacion_pago, v_dven, v_folreq int;
define v_seccion, v_caja_pago char(2);
define v_letra_local, v_bloque char(3);
define v_importerenta, v_recargos money(18,2);
define v_fechapago date;

foreach
   select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque,a.nombre,d.axo,d.periodo,
   d.importe_pago importerenta,d.fecha_pago fechapago,d.oficina_pago,d.caja_pago,d.operacion_pago,
   CASE
      WHEN d.periodo = 1 THEN 9 
      WHEN d.periodo = 2 THEN 6
      WHEN d.periodo = 3 THEN 6
      WHEN d.periodo = 4 THEN 6
      WHEN d.periodo = 5 THEN 7
      WHEN d.periodo = 6 THEN 6
      WHEN d.periodo = 7 THEN 6 
      WHEN d.periodo = 8 THEN 6
      WHEN d.periodo = 9 THEN 6
      WHEN d.periodo = 10 THEN 8
      WHEN d.periodo = 11 THEN 6
      WHEN d.periodo = 12 THEN 6
      ELSE 0
   END
   into v_descripcion, v_id_local, v_oficina, v_num_mercado, v_seccion, v_local, v_letra_local, v_bloque, v_nombre, v_axo, v_mes,
   v_importerenta, v_fechapago, v_oficina_pago, v_caja_pago, v_operacion_pago, v_dven
   from ta_11_locales a, ta_11_mercados b,ta_11_pagos_local d
   where a.num_mercado=pmer and a.vigencia='A' and d.axo=paxo
   and b.num_mercado_nvo=a.num_mercado and d.id_local=a.id_local
   and (d.fecha_pago between pfdsd and pfhst)
   order by a.oficina,a.num_mercado,a.seccion,a.local,a.letra_local,a.bloque,d.axo,d.periodo

    select nvl(count(b.folio),0) into v_folreq
    from ta_15_apremios b where b.modulo=11 and b.control_otr=v_id_local and b.vigencia='1' and b.clave_practicado='P';

   execute procedure calc_recarmerc_esp(v_num_mercado,v_folreq,v_importerenta,mdy(v_mes,v_dven,v_axo),v_fechapago) into v_recargos;

   return v_descripcion, v_id_local, v_oficina, v_num_mercado, v_seccion, v_local, v_letra_local, v_bloque, v_nombre,
          v_fechapago, v_oficina_pago, v_caja_pago, v_operacion_pago, v_axo, v_mes, v_importerenta, v_recargos with resume;

end foreach;

end procedure;

CREATE PROCEDURE "informix".sp16_licenciagiro ( par_LicenciaGiro int )
{######################################################################
#  Procedimiento:    sp16_LicenciaGiro
#  Descripcion:      Interfaz de consulta de Adeudo en ASEO CONTRATADO para el cobro de Licencia de Giro
#
#  Parametros        par_LicenciaGiro     = Numero de Licencia de Giro
#  de entrada:       
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            15 Septiembre 2015   
#
#  Llamado por:      Procedimiento Modulo de Licencias
#  
######################################################################}
                returning  int as status,
                                            varchar(255) as leyenda;
        
define v_importe_multa, v_importe_gastos, v_tot_gastos	Money(12,2);   -- requerimientos
define v_tot_adeudos				Money(15,2);
define v_importe, v_importe_CN, v_importe_Exe		Money(12,2);
define v_control_contrato, v_numero                                  	Int;
define v_leyenda                                                                        	varchar(255);
define v_status                                                                            	Int;
define v_Periodo_CN, v_Periodo_EXE                                   	varchar(7);

Let v_status                      = 0;
let v_leyenda    = 'NO TIENE ADEUDO';
let v_tot_adeudos           = 0;
Let v_control_contrato  = 0;
Let v_numero                   = 0;
Let v_importe = 0;
Let v_importe_CN = 0;
Let v_importe_Exe = 0;

if exists( SELECT * FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro and vigencia='V') then
               SELECT count(*) INTO v_numero FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro;

               if v_numero = 1 then
               		SELECT control_contrato  INTO  v_control_contrato
                              	FROM ta_16_Rel_LicGiro  WHERE Num_Licencia = par_LicenciaGiro;
                              
                              	-- APREMIOS
                              	Let v_importe_multa = 0;
                              	Let v_importe_gastos = 0;
                              	Let v_tot_gastos = 0;
                		foreach
                     		SELECT importe_multa,     importe_gastos  INTO v_importe_multa, v_importe_gastos 
                      		FROM ta_15_apremios
                       		WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      		Order By id_control
                               		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
                		end foreach;
                              		EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

                                                                          if exists( SELECT * FROM ta_16_pagos WHERE control_contrato = v_control_contrato  and status_vigencia = 'V' ) then
                                                                                         SELECT sum(importe)  INTO v_importe_CN  FROM ta_16_pagos WHERE control_contrato = v_control_contrato 
                                                                                                                      and ctrol_operacion = 6 and aso_mes_pago <= v_Periodo_CN  and status_vigencia = 'V';
                                            			if v_importe_CN is Null then
                                                           			Let  v_importe_CN = 0;
                                            			end if;

                                                                                         SELECT sum(importe)  INTO v_importe_Exe  FROM ta_16_pagos WHERE control_contrato = v_control_contrato 
                                                                                                                      and ctrol_operacion = 7 and aso_mes_pago <= v_Periodo_EXE  and status_vigencia = 'V';
                                            			if v_importe_Exe is Null then
                                                           			Let  v_importe_Exe = 0;
                                            			end if;

					Let v_importe = v_importe_CN + v_importe_Exe;

                                                                                         if v_importe > 0 then
                                                                                                       let v_status                       = 1;
                                                                                                       let v_leyenda    = 'TIENE ADEUDO';
                                                                                         else
                                                                                                       if v_importe_multa > 0 or v_tot_gastos > 0 then
                                                                                                                      let v_status                       = 1;
                                                                                                                      let v_leyenda    = 'TIENE ADEUDO';
                                                                                                       else
                                                                                                                      let v_status                       = 0;
                                                                                                                      let v_leyenda    = 'NO TIENE ADEUDO';
                                                                                                       end if;
                                                                                         end if;
                                                                          else
                                                                                         if v_importe_multa > 0 or v_tot_gastos > 0 then
                                                                                                       let v_status                       = 1;
                                                                                                       let v_leyenda    = 'TIENE ADEUDO';
                                                                                         end if;
                                                                          end if;
               else
                              let v_status                       = 2;
                              let v_leyenda    = 'La Licencia esta ligada a mas de un Contrato';
               end if;
else
               let v_status                       = -1;
               let v_leyenda    = 'NO EXISTE LIGA';
end if;
               RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "informix".linea_consrecibo(
    p_linea VARCHAR(50)
)

returning 
INT as estatus,
VARCHAR(200) as mensaje,
DATE as fecha,
SMALLINT as rec_id,
CHAR(2) as caja,
INT as operacion,
MONEY(16,2) as importe,
CHAR(1) as cvepago,
INT as modulo_id,
INT as regmodulo_id,
SMALLINT as rec_cta_id,
CHAR as regmunur,
SMALLINT as mesdesde,
SMALLINT as axodesde,
SMALLINT as meshasta,
SMALLINT as axohasta,
VARCHAR(60) as nombre,
VARCHAR(60) as domicilio,
VARCHAR(60) as concepto,
CHAR(3) as rfcini,
INT as rfcnumero,
SMALLINT as rfccolonia,
SMALLINT as obra,
INT as axofolio,
INT as usuario_id,
DATETIME YEAR TO MINUTE as fecha_act,
VARCHAR(255) as desc,
CHAR(15) as foliorecibo;


--****** parametros desde salida
define o_fecha DATE;
define o_id_rec SMALLINT;
define o_caja CHAR(2);
define o_operacion INT;
define o_importe MONEY(16,2);
define o_cvepago CHAR(1);
define o_id_modulo INT;
define o_id_regmodulo INT;
define o_id_rec_cta SMALLINT;
define o_regmunur CHAR(1);
define o_mesdesde SMALLINT;
define o_axodesde SMALLINT;
define o_meshasta SMALLINT;
define o_axohasta SMALLINT;
define o_nombre VARCHAR(60);
define o_domicilio VARCHAR(60);
define o_concepto VARCHAR(60);
define o_rfcini CHAR(3);
define o_rfcnumero INT;
define o_rfccolonia SMALLINT;
define o_obra SMALLINT;
define o_axofolio INT;
define o_id_usuario INT;
define o_fecha_act DATETIME YEAR TO MINUTE;
define o_desc VARCHAR(255);
define o_foliorecibo CHAR(15);

--****** variables locales
define v_estatus char(1);
define v_fecha_pago date;
define v_id_rec smallint;--
define v_caja char(2);--
define v_operacion int;--
define v_modulo int;
define v_mod int;

let v_mod = substr(p_linea,19,2)*1;

--avaluos
if v_mod = 49 then

   --Verifica que exista la linea de captura de avaluos en recibos diversos
   if NOT exists (select * from ta_12_recibos where kio_num_terceros = trim(p_linea)
		  and caja = "I4" and cvepago='P' ) then 
         return -1,"LA L�NEA DE CAPTURA DE PAGO DE AVALUOS NO EXISTE!",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
   end if; 

   --obtener los datos del registro de diversos  
FOREACH
   select fecha, operacion, id_rec , caja, foliorecibo
   into v_fecha_pago, v_operacion, v_id_rec, v_caja, o_foliorecibo
   from ta_12_recibos where kio_num_terceros = trim(p_linea)
        and caja = "I4" and cvepago='P'
END FOREACH;

   if (trim(o_foliorecibo)='') or  (o_foliorecibo is null) then
        return -1,"LA L�NEA DE CAPTURA DE PAGO DE AVALUOS NO HA SIDO AFECTADO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
    end if;
else --no es linea de captura de avaluos 
        return -1,"LA L�NEA DE CAPTURA NO ES DE PAGO DE AVALUOS, VERIFIQUE",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
end if; -- fin v_modulo==49

--Validar en ta_12_recibos
if NOT exists (select * from ta_12_recibos where fecha=v_fecha_pago and id_rec = v_id_rec and caja=v_caja 
	and operacion=v_operacion and cvepago="P") then--recibos
	
   return -1,"EL RECIBO NO EXISTE EN EL REGISTRO",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
end if; --Fin recibos
--SET LOCK MODE TO WAIT;
  select fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,id_rec_cta,regmunur,
    	 mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,rfccolonia,
	 obra,axofolio,id_usuario,fecha_act,descripcion,foliorecibo

  into  o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,o_id_modulo,o_id_regmodulo,
	o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,o_axohasta,o_nombre,o_domicilio,
	o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo

  from  ta_12_recibos 

  where  fecha=v_fecha_pago and id_rec = v_id_rec and caja=v_caja 
	 and operacion=v_operacion and cvepago="P";

	if o_cvepago <> "P" then
        return -1,"LA CLAVE DE PAGO HA SIDO CANCELADA",
		null,null,null,null,null,null,null,null,null,null,null,null,
		null,null,null,null,null,null,null,null,null,null,null,null,null,null;
      	end if;

        return 0,"L�NEA DE CAPTURA V�LIDA",o_fecha,o_id_rec,o_caja,o_operacion,o_importe,o_cvepago,
		v_mod,o_id_regmodulo,o_id_rec_cta,o_regmunur,o_mesdesde,o_axodesde,o_meshasta,
		o_axohasta,o_nombre,o_domicilio,o_concepto,o_rfcini,o_rfcnumero,o_rfccolonia,o_obra,
		o_axofolio,o_id_usuario,o_fecha_act,o_desc,o_foliorecibo;

end procedure;

create procedure "pgcabrer".sp_padron_geomatica()
returning varchar(100) as mercado,
          int as recaudadora,
          int as num_mercado,
          int as categoria,
          char(2) as seccion,
          int as local,
          char(3) as letra,
          char(3) as bloque,
          varchar(100) as nombre,
          money(18,2) as adeudo,
          varchar(10) as ult_per_pago,
          varchar(10) as vigencia_local,
          char(500) as licencias;
--          int as licencia, 
--          varchar(250) as giro;

define v_descripcion, v_nombre varchar(100);
define v_id_local,v_oficina,v_num_mercado,v_categoria,v_local,v_licencia,v_id_licencia int;
define v_seccion char(2);
define v_letra,v_bloque varchar(3);
define v_adeudo money(18,2);
define v_periodo,v_vigencia varchar(10);
define v_giro varchar(250);
define v_licencias char(500);

define vp_lic,vp_id,vp_blq,vp_idg int;
define vp_act varchar(130);
define vp_prop varchar(80); 
define vp_txtblq varchar(30);
define vp_vig char(1);
define vp_giro varchar(96);

foreach
  select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,a.nombre
  ,fn_getadeper(a.id_local,1992,1,year(today),month(today)) 
  ,( (select Max(axo) from ta_11_pagos_local where id_local=a.id_local)||'-'||
  (select max(periodo) from ta_11_pagos_local where id_local=a.id_local and axo=
  (select Max(axo) from ta_11_pagos_local where id_local=a.id_local) ) ), 
  case when a.vigencia='A' then 'VIGENTE' else 'BAJA' end
  into v_descripcion,v_id_local,v_oficina,v_num_mercado,v_categoria,v_seccion,v_local,v_letra,v_bloque,v_nombre,v_adeudo,v_periodo,v_vigencia
  from ta_11_locales a, ta_11_mercados b
  where b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

  if v_periodo='2020-3' then
     let v_periodo='2020-6';
  end if;

  -- obtiene la(s) licenicia del local
  let v_licencias='';
  foreach
    select b.licencia into v_licencia
    from ta_11_licencias a,catastro_gdl:licencias b where a.id_local=v_id_local
    and a.vigencia='V' and b.id_licencia=a.id_licencia
    execute procedure catastro_gdl:spget_lic_estatus(v_licencia) into vp_lic,vp_id,vp_act,vp_prop,vp_blq,vp_txtblq,vp_vig,vp_idg,vp_giro; 
    let v_licencias=trim(v_licencias)||v_licencia||'-'||trim(vp_giro)||',';
  end foreach;
  let v_licencias=substr(v_licencias,1,(length(v_licencias)-1));

  return v_descripcion,v_oficina,v_num_mercado,v_categoria,v_seccion,v_local,v_letra,v_bloque,v_nombre,v_adeudo,v_periodo,v_vigencia,v_licencias with resume;
end foreach;

end procedure;

create procedure "informix".sp_15_genera_carta(pmodulo int,pidmodulo int,pfoliocarta int, precaud int,  
pimpuesto money(18,2), precargos money(18,2), pgastos money(18,2), pmultas money(18,2), pactualizacion money(18,2), ptotal money(18,2), 
pcapturista varchar(8))

returning   int as estado,
            varchar(100) as mensaje;

define vest, vcvereg int;
define vmsg varchar(100);

let vest=0;
let vmsg='ERROR AL INSERTAR';

-- inserta registro
insert into ta_15_cartainvitacion (cveejecutor, modulo, id_modulo, foliocarta, axocarta, recaud, impuesto, recargos, gastos, multas, actualizacion,
 total, fecemi, fecprac, fecejec, axoini, bimini, axofin, bimfin, vigencia, fecha_pago, recaudadora, caja, operacion,
 nodiligenciado, obs, zona_subzona, feccap, capturista) 
values (0, pmodulo, pidmodulo, pfoliocarta, year(today), precaud, pimpuesto, precargos, pgastos, pmultas, pactualizacion,
ptotal, today, null, null, 0, 0, 0, 0, 'V', null, null, null, null, null, null, 0, TODAY, pcapturista);

let vcvereg=dbinfo("sqlca.sqlerrd1");
let vest=vcvereg;
let vmsg='AFECTACION CORRECTA';
return vest, vmsg;

end procedure;

create procedure "informix".sp_15_dotacion_carta(pmodulo int, prec int, pfold int, pfolh int, pfec date, pejec int, popc char(1))
       returning  int as folios;

define v_folios int;

-- folios asignados
if popc='A' then 
   select count(*) into v_folios from ta_15_cartainvitacion where modulo=pmodulo and recaud=prec and cveejecutor=pejec 
     and (foliocarta between pfold and pfolh) and fecejec=today;

   return v_folios;
end if;
-- folios practicados
if popc='P' then 
   select count(*) into v_folios from ta_15_cartainvitacion where modulo=pmodulo and recaud=prec and cveejecutor=pejec 
     and (foliocarta between pfold and pfolh) and fecprac=pfec;

   return v_folios;
end if;
-- foliod cancelados
if popc='C' then 
   select count(*) into v_folios from ta_15_cartainvitacion where modulo=pmodulo and recaud=prec 
     and (foliocarta between pfold and pfolh) and vigencia='C';

   return v_folios;
end if;

end procedure;

create procedure "informix".sp_15_asigna_carta(peje int, pfec date, pcvereq int, popc char(1), pmemo varchar(250))
returning  int as estado,
          varchar(100) as msg;

define vest int;
define vmsg varchar(100);
define vobs varchar(255);

let vest=-1;
let vmsg='ERROR AL MODIFICAR';

select nvl(obs,'') into vobs from ta_15_cartainvitacion where cvereq=pcvereq;

if popc='A' then
   update ta_15_cartainvitacion set cveejecutor=peje, fecejec=today, obs=vobs||' '||pmemo where cvereq=pcvereq;
   let vest=pcvereq;
   let vmsg='FOLIO ASIGNADO CORRECTAMENTE';
   return vest, vmsg;
end if;

if popc='P' then
   update ta_15_cartainvitacion set fecprac=pfec, obs=vobs||' '||pmemo where cvereq=pcvereq;
   let vest=pcvereq;
   let vmsg='FOLIO PRACTICADO CORRECTAMENTE';
   return vest, vmsg;
end if;

if popc='C' then
   update ta_15_cartainvitacion set vigencia='C', obs=vobs||' '||pmemo where cvereq=pcvereq;
   let vest=pcvereq;
   let vmsg='FOLIO CANCELADO CORRECTAMENTE';
   return vest, vmsg;
end if;


end procedure;

create procedure "informix".sp_15_seleccion_carta(pmodulo int,prec int, pfold int, pfolh int, pfec date, pejec int, popc char(1))
       returning  int as cvereq,
                  int as foliocarta,
                  int as cveejecutor,
                  date as fecejec,
                  date as fecprac,
                  int as zona,
                  varchar(100) as colonia,
                  varchar(30) as cuenta,
                  money(18,2) as impuesto,
                  money(18,2) as recargos,
                  money(18,2) as gastos,
                  money(18,2) as multa,
                  money(18,2) as actualizacion,
                  money(18,2) as total,
                  varchar(100) as ejecutor;

define v_cvereq, v_foliocarta, v_cveejecutor, v_cvecuenta, v_zona, v_idmodulo int;
define v_fecejec, v_fecprac date;
define v_impuesto, v_recargos, v_gastos, v_multa, v_actualizacion, v_total money(18,2);
define v_ejecutor, v_colonia varchar(100);
define v_cuenta varchar(30);

-- seleccion para asignar
if popc='A' then 
   foreach
     select cvereq,id_modulo,foliocarta,cveejecutor,fecejec,fecprac,a.zona_subzona
       ,impuesto,recargos,gastos,multas,actualizacion,total 
       ,(select nombre from ta_15_ejecutores where cve_eje=pejec and id_rec=a.recaud) 
     into v_cvereq, v_idmodulo, v_foliocarta, v_cveejecutor, v_fecejec, v_fecprac, v_zona, v_impuesto, v_recargos, v_gastos, v_multa, v_actualizacion, v_total, v_ejecutor
     from ta_15_cartainvitacion a where a.recaud=prec and (foliocarta between pfold and pfolh) 
     and a.vigencia='V' and a.cveejecutor=0 and a.modulo=pmodulo
     order by zona_subzona, foliocarta
     
     if pmodulo=14 then
        select placa, colonia into v_cuenta, v_colonia from dbestacion:ta_padron where id=v_idmodulo and actualizado='A';
     end if;

     return v_cvereq, v_foliocarta, v_cveejecutor, v_fecejec, v_fecprac, v_zona, v_colonia, v_cuenta, v_impuesto, v_recargos, v_gastos, v_multa, v_actualizacion, v_total, v_ejecutor with resume;
   end foreach;
end if;
-- seleccion para practicar
if popc='P' then
   foreach
     select cvereq,id_modulo,foliocarta,cveejecutor,fecejec,fecprac,a.zona_subzona
       ,impuesto,recargos,gastos,multas,actualizacion,total 
       ,(select nombre from ta_15_ejecutores where cve_eje=a.cveejecutor and id_rec=a.recaud) 
     into v_cvereq, v_idmodulo, v_foliocarta, v_cveejecutor, v_fecejec, v_fecprac, v_zona, v_impuesto, v_recargos, v_gastos, v_multa, v_actualizacion, v_total, v_ejecutor
     from ta_15_cartainvitacion a where a.recaud=prec and (a.foliocarta between pfold and pfolh) 
     and a.vigencia='V' and a.cveejecutor=pejec and a.fecprac is null and a.modulo=pmodulo
     order by foliocarta

     if pmodulo=14 then
        select placa, colonia into v_cuenta, v_colonia from dbestacion:ta_padron where id=v_idmodulo and actualizado='A';
     end if;

     return v_cvereq, v_foliocarta, v_cveejecutor, v_fecejec, v_fecprac, v_zona, v_colonia, v_cuenta, v_impuesto, v_recargos, v_gastos, v_multa, v_actualizacion, v_total, v_ejecutor with resume;
   end foreach;
end if;
-- seleccion para cancelar
if popc='C' then
   foreach
     select cvereq,id_modulo,foliocarta,cveejecutor,fecejec,fecprac,a.zona_subzona
       ,impuesto,recargos,gastos,multas,actualizacion,total 
       ,(select nombre from ta_15_ejecutores where cve_eje=a.cveejecutor and id_rec=a.recaud)
     into v_cvereq, v_idmodulo, v_foliocarta, v_cveejecutor, v_fecejec, v_fecprac, v_zona, v_impuesto, v_recargos, v_gastos, v_multa, v_actualizacion, v_total, v_ejecutor
     from ta_15_cartainvitacion a where a.recaud=prec and (foliocarta between pfold and pfolh) 
     and a.vigencia='V' and a.cveejecutor=pejec and a.modulo=pmodulo
     order by foliocarta

     if pmodulo=14 then
        select placa, colonia into v_cuenta, v_colonia from dbestacion:ta_padron where id=v_idmodulo and actualizado='A';
     end if;

     return v_cvereq, v_foliocarta, v_cveejecutor, v_fecejec, v_fecprac, v_zona, v_colonia, v_cuenta, v_impuesto, v_recargos, v_gastos, v_multa, v_actualizacion, v_total, v_ejecutor with resume;
   end foreach;
end if;

end procedure;

create function "pgcabrer".fn_getactmerc(fid int,faxo int,fmes int)
returning money(16,2) as actualizacion;

define v_recargos,v_multa,v_gastos,v_actualizaciontotal, v_actualizacion,v_aimporte money(16,2);
define v_folio,v_aid_local,v_aaxo,v_aperiodo,v_dmes,v_merc,v_desc,v_primermes int;
define v_fecha_desc,v_fecha_rec date;

select num_mercado,nvl(id_contribuy_renta,0) into v_merc,v_desc
from ta_11_locales where id_local=fid;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=fid and vigencia='1' and clave_practicado='P';

let v_actualizaciontotal=0;  

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=fid and axo=faxo and periodo<=fmes 
and b.mes=month(today)
order by axo,periodo
if v_merc =214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
end if;

-- calcula el recargo
let v_recargos=0;
execute procedure admin_recargos_13(v_merc, v_folio, v_aimporte, mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos;

-- calcula la actualizacion
let v_actualizacion=0;
if  v_recargos>0 then
    execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, v_aimporte) into v_actualizacion;
end if;

-- acumula recargos por a�o
let v_actualizaciontotal=v_actualizaciontotal+v_actualizacion;

end foreach; -- cierre de los periodos

return v_actualizaciontotal;
end function;

create procedure "informix".sp_cancdautmerc(pmer int, pfecd date, pfhst date)
returning   int as total_recargos,
            int as total_multas;


define vmerc, vid_descto, vid_local, v_porc, vtotal_recargos, vtotal_multas int;
define m_merc,m_id_local,m_control,m_id_rec,m_porcentaje int;
define vfalta date;
define vuser varchar(10);

let vtotal_recargos=0;
let vtotal_multas=0;

-- recargos
foreach
    -- verifica los descuentos de recargos vigentes
    select b.num_mercado,a.id_descto, b.id_local,a.fecha_alta,a.usuario_alta,a.porcentaje 
    into vmerc, vid_descto, vid_local, vfalta, vuser, v_porc
    from ta_11_descrec a,ta_11_locales b
    where a.vigencia='V' and a.usuario_alta='dautmer' and (date(a.fecha_alta) between pfecd and pfhst)
    --and b.num_mercado=pmer 
    and b.id_local=a.id_local
    order by b.num_mercado

    -- cancela descuento de recargos
    update ta_11_descrec set vigencia='C', fecha_baja=today, usuario_baja='dautmer' where id_descto=vid_descto;
    let vtotal_recargos=vtotal_recargos+1;

end foreach;

-- Multas
foreach
    -- verifica los descuentos de multas vigentes
    select d.num_mercado,b.control_otr,a.control,a.id_rec,a.porcentaje
    into m_merc,m_id_local,m_control,m_id_rec,m_porcentaje
    from ta_15_autorizados a, ta_15_apremios b, ta_11_locales d 
    where a.id_usuarioa=1034 and a.estado=1 and (a.fecha_alta between pfecd and pfhst)
    and b.id_control=a.control and d.id_local=b.control_otr and b.modulo=11 
    and b.vigencia='1' 
    --and d.num_mercado=pmer

    -- cancela descuento en apremios 
    update ta_15_apremios set  porcentaje_multa=100 where id_control=m_control;

    -- cancela descuento en autorizados
    update ta_15_autorizados set fecha_baja=today, estado=2 where control=m_control;
    let vtotal_multas=vtotal_multas+1;

end foreach;

return vtotal_recargos, vtotal_multas;
end procedure;

CREATE PROCEDURE "informix".sp_recargos_x_mes ( ai_axo integer, ai_mes integer, adec_importe decimal(18,2)  )  

-- Recibe A�o, mes e Importe a calcular de Manera Mensual.
-- Devuelve el importe de Recargos Calculados .
--29 octubre 2020

Returning  decimal (18,2) ;
 
Define 	li_axo 		integer; 
Define	li_mes		integer;
Define	ldec_porcentaje_mes	decimal(18,2);
Define	ldec_recargos	decimal(18,2);
Define	ldec_porcentaje 	decimal(18,2);
Define	li_periodo		Integer;
Define	ai_periodo 	integer;


Let	li_axo = 0;
Let	li_mes = 0 ;
Let 	ldec_porcentaje_mes = 0;
Let	ldec_recargos  =  0;
Let	ldec_porcentaje = 0;
Let	li_periodo = 0 ;
Let	ai_periodo = ai_axo || ai_mes ;

ForEach 


	Select	porcentaje_mes
	Into	ldec_porcentaje_mes
	From	db_ingresos:ta_12_recargos 
	Where	( axo >= ai_axo and mes >= ai_mes  ) 
	Let	ldec_porcentaje = ldec_porcentaje + ldec_porcentaje_mes ;

End ForEach

Let	ldec_recargos = 0 ;
Let	ldec_recargos = ( adec_importe * ldec_porcentaje ) / 100 ;

Return	ldec_recargos ;
Let	ldec_recargos = 0 ;

End Procedure
;

CREATE PROCEDURE "informix".sp_adeudo_vp ( ai_id integer ) 
-- Recibe 	ai_id = t34_pagos.id_datos
-- Devuelve:  a�o, meses de adeudo, importe total y recargos total
-- 29 octubre 2020


Returning  integer, varchar(36), decimal (18,2), decimal (18,2) ;
 
Define	li_mes		integer;
Define	ls_mes		char(02);
Define 	ls_meses 		varchar(50) ;
Define 	li_sw		integer;
Define 	li_periodo		integer; 
Define 	li_periodoant 	integer; 
Define	ldec_importes 	decimal(18,2);
Define	ldec_importe 	decimal(18,2);
Define	ldec_recargos 	decimal(18,2);
Define	ldec_recargo 	decimal(18,2);
Define	ai_periodo	integer;
Define	as_meses		varchar(36);
Define	adec_total	decimal(18,2);
Define	adec_recargos	decimal(18,2);
Define 	li_existe		integer;
Define	li_suma		integer;
Define	ldec_fechahoy	date;
Define	ldec_recargoscal	decimal(18,2);

-- Crea tabla temporal adeudos ----  t_adeudos
Create temp table t_adeudos ( periodo integer, meses varchar(50), total decimal (18,2), recargos decimal (18,2) ) with no log;
 
Let	ls_mes = "" ;
Let	li_mes = 0 ;
Let	ls_meses = "" ;
Let	li_sw = 0 ;
Let	li_periodoant = 0 ;
Let	ldec_importes =  0;
Let	ldec_recargos =  0;
Let	ldec_importe  =  0;
Let	ldec_recargo  =  0;
Let	li_existe = 0 ;
Let	li_suma = 0 ;
Let	ldec_fechahoy = date(current);
Let	ldec_recargoscal = 0;


SELECT	Count(*)
INTO	li_existe
FROM 	t34_pagos 
WHERE  	id_datos = ai_id  
AND	folio_recibo is null  
AND	Substr( periodo, 1,4) ||  Substr( periodo, 6, 2 ) <=  year( ldec_fechahoy ) || month( ldec_fechahoy )  ;
IF	li_existe > 0 Then
Elif	li_existe = 0 Then
	Drop table t_adeudos;
	Return	0, "Sin Adeudo", 0, 0 ;
Else
	Drop table t_adeudos;
	Return	0, "Sin Adeudo", 0, 0 ;
End if


ForEach

	SELECT	year(periodo) , month( periodo ), month( periodo ), importe, recargo
	INTO	li_periodo, ls_mes, li_mes, ldec_importe, ldec_recargo
	FROM 	t34_pagos 
	WHERE  	id_datos = ai_id  
---	AND	folio_recibo  is null  
	AND	( Substr( periodo, 1,4) ||  Substr( periodo, 6, 2 ) <=  Year( ldec_fechahoy ) ||  Month( ldec_fechahoy) ) 

	If	li_periodo <> 0 Then

		If	li_sw = 0 Then
			Let	li_sw = 1 ;
			Let	li_periodoant  = li_periodo ; 
		End If

		If	li_periodoant  = li_periodo 	Then
			Let	ls_meses = ls_meses ||  TRIM(ls_mes) ||  ',' ;
			Let	ldec_importes = ldec_importes + ldec_importe ;

			Execute Procedure sp_recargos_x_mes ( li_periodo, li_mes, ldec_importe ) into ldec_recargoscal ;
			Let	ldec_recargos = ldec_recargos + ldec_recargoscal ;
			--Let	ldec_recargos = ldec_recargos + ldec_recargo ;
		Else
			-- Inserta a la Tabla
			Insert	Into t_adeudos ( periodo, meses, total, recargos )
			Values	( li_periodoant, ls_meses, ldec_importes, ldec_recargos ) ;
			If	li_periodo > 0 Then
				Let	li_periodoant = li_periodo ;
				Let	ls_meses = "" ;
				Let	ls_meses = ls_meses ||  TRIM(ls_mes) ||  ',' ;
				Let	ldec_importes = 0;
				Let	ldec_recargos = 0 ;
				Let	ldec_importes = ldec_importes + ldec_importe ;

				Execute Procedure sp_recargos_x_mes ( li_periodo, li_mes, ldec_importe ) into ldec_recargoscal ;
				Let	ldec_recargos = ldec_recargos + ldec_recargoscal ;
				--Let	ldec_recargos = ldec_recargos + ldec_recargo ;

			Else
				Let	ldec_importes = 0;
				Let	ldec_recargos = 0 ;
				Let	ls_meses = "" ;
			End If
		End If
 	End If

End ForEach



-- Inserta a la Tabla
Insert	Into t_adeudos ( periodo, meses, total, recargos )
Values	( li_periodoant, ls_meses, ldec_importes, ldec_recargos ) ;

ForEach
	Select 	periodo, meses, total, recargos
	Into	ai_periodo, as_meses, adec_total, adec_recargos	
	From  	t_adeudos 
	 
	Return	ai_periodo, as_meses, adec_total, adec_recargos With Resume;

End ForEach

Drop table t_adeudos;

End Procedure
;

CREATE PROCEDURE "informix".admin_adeudos_detalle_25odoo_beto ( par_Tabla Char(2), par_Control Char(10), pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_25
#  Descripcion:      Interfaz de consulta de detalle para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros par_Tabla     = Rubro de ingreso
#  de entrada:      par_Control   = Dato de Control del registro
#                   pref   = Hasta el periodo requerido    ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  en db_ingresos 
######################################################################}
returning  Integer as Rubro,
Integer as Concepto,
Integer as Cuenta_Aplicacion,
VarChar(30) as Referencia,
VarChar(120) as Descripcion,
Money(12,2) as Monto,
Money(12,2) as Acumulado;

define v_tipo_var 																			Char(1);              
define v_id_34_datos, v_id_control_req                                                      Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas    Money(12,2);
define v_porcentaje_multa                                                                   Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           Money(12,2);
define v_aso_mes_pago                                                                       Date;
define v_Axo, v_Mes, Axo_v, Mes_v, Dia_v                                                    Integer;
define v_mensaje_proc                                                                       varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                          varchar(7);
define v_contador                                                                           Smallint;
define v_ref 																				char(7);
--****************************************************************************************************************************************** ctas de aplicacion
define v_cta_multas, v_cta_dscto_multas, v_cta_gastos                                       Integer;
define v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza                             Integer;
define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza                                   Integer;
define v_cta_rcgos_ade, v_cta_rcgos_exced                                                   Integer;
define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced                                         Integer;
define v_tipo_obligacion                                                                    Char(50);
define v_concepto                                                                           VarChar(100);
define perioI 						integer;
define v_actualizacion 					decimal(18,2);
--******************************************************************************************************************************************
-- adicionado 18/12/2019 para obtener id de rubro de ingreso
define v_id_unidad int;
define v_cve_unidad, v_cve_operatividad char(1);
define v_descripcion varchar(100);

begin
    on exception in (-958)
delete from tmp_total_otras_oblig;
    end exception;
create temp table tmp_total_otras_oblig( rubro int, concepto int, cuenta int, referencia varchar(30), descripcion varchar(120),
				  monto money(14,2), acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
delete from tmp_detalle_otras_oblig;
    end exception;
create temp table tmp_detalle_otras_oblig( control_contrato int, aso_mes_pago char(7), ctrol_operacion int, tipo_movto char(1) ) with no log;
end;


SELECT 	Year(fechalimite), Month(fechalimite), Day(fechalimite)  
INTO 	Axo_v, Mes_v, Dia_v
FROM 	t34_fechalimite
WHERE 	cve_tab = par_tabla
AND 	Month(fechalimite) = Month(Current)  
AND 	Year(fechalimite) = Year(Current);

if 	Day(Current) <= Dia_v then
	if 	Mes_v = 1 then
		Let Mes_v = 12;
        Let Axo_v = Axo_v - 1;
    else
        Let Mes_v = Mes_v - 1;
    end if;
End if;

EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  

if 	trim(pref)='' then
	let v_ref=9999 || '-' || 12;
else
	let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
End if;

let 	v_id_34_datos = 0;
Let 	v_id_unidad = 0;

if 	exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
    SELECT 	a.id_34_datos, a.id_unidad  
	INTO 	v_id_34_datos, v_id_unidad  
	FROM 	t34_datos A    
	WHERE 	a.cve_tab = par_Tabla 
	AND  	a.control = par_Control;

	-- OBTENER EL RUBRO DE INGRESO
	Let v_cve_unidad 		= '';
	Let v_cve_operatividad 	= '';
	Let v_descripcion 		= '';
	SELECT 	cve_unidad, cve_operatividad, descripcion 
	INTO 	v_cve_unidad, v_cve_operatividad, v_descripcion  
	FROM 	t34_unidades  
	WHERE 	id_34_unidad = v_id_unidad;

    -- VARIABLES A 0
    Let v_concepto = '';
    Let v_cta_multas = 0;
    Let v_cta_dscto_multas = 0;
    Let v_cta_gastos = 0;
    Let v_cta_adeudos_act = 0;
    Let v_cta_adeudos_dev = 0;
    Let v_cta_adeudos_reza = 0;
    Let v_cta_rcgos_ade = 0;
    Let v_cta_dcto_rcgos_ade = 0;
    Let	v_actualizacion = 0;

    Let v_tipo_var = '';
    Let v_tot_multas = 0;
    Let v_porcentaje_multa = 0;
    Let v_tot_dscto_multas = 0;

    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_tot_gastos = 0;
    Let v_acumulado = 0;
    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    Let v_contador = 0;

    -- APREMIOS
    FOREACH
		SELECT 	id_control, importe_multa, importe_gastos, porcentaje_multa  
		INTO 	v_id_control_req, v_importe_multa, v_importe_gastos, v_porcentaje_multa
		FROM 	ta_15_apremios
		WHERE 	modulo = 34  
		AND 	control_otr = v_id_34_datos
		AND 	vigencia = "1" 
		AND 	clave_practicado = "P"
		Order 	By id_control

		Let v_tot_multas = v_importe_multa;
		if 	v_porcentaje_multa < 100 then
			Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
			Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
		else
			Let v_tot_dscto_multas = 0;
		End if;
		
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

		INSERT INTO  tmp_detalle_otras_oblig 
		VALUES ( v_id_control_req, v_ref, 0, 'R' );
    
	END FOREACH;
    -- TERMINA APREMIOS


    -- INICIAN PERIODOS
    FOREACH
		SELECT 	a.periodo, a.importe, Year(a.periodo), Month(a.periodo), a.tipo_var   
		INTO  	v_aso_mes_pago, v_importe, v_Axo, v_Mes, v_tipo_var  
		FROM 	t34_pagos a, t34_status b    
		WHERE 	id_datos = v_id_34_datos  
		and 	periodo <= v_ref
		AND 	b.id_34_stat = a.id_stat 
		AND 	b.cve_tab = 'E' 
		AND 	b.cve_stat in ('V')
		ORDER 	BY a.periodo

		INSERT 	INTO  tmp_detalle_otras_oblig 
		VALUES  ( v_id_34_datos, v_Axo || '-' || v_Mes, 0, 'A' );
		
		if 	v_importe > 0 then
			if 	v_contador = 0 then
				if 	v_tot_multas > 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
					Let v_concepto = 'MULTAS';
					if 	par_Tabla = '5' then
						Let v_cta_multas = 515003004;
					End if;
					
                    Let v_acumulado = v_acumulado + v_tot_multas;  
					RETURN 0, v_cta_multas, get_odoo_cta( v_cta_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_multas, v_acumulado with resume;
					INSERT INTO tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_multas, v_acumulado );
                End if;
				
				if 	v_tot_dscto_multas <> 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
					Let v_concepto = 'DSCTO. MULTAS';
					if 	par_Tabla = '5' then
						Let v_cta_dscto_multas = 515043004;
					end if;
					
                    Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
					RETURN 0, v_cta_dscto_multas, get_odoo_cta( v_cta_dscto_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_dscto_multas, v_acumulado  with resume;
                    INSERT INTO  tmp_total_otras_oblig 
					VALUES  ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_dscto_multas, v_acumulado );
                End if;
                if 	v_tot_gastos > 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
					Let v_concepto = 'GASTOS';
					if 	par_Tabla = '5' then
						Let v_cta_gastos = 550620010;
					end if;
					
                    Let v_acumulado = v_acumulado + v_tot_gastos;  
					RETURN 0, v_cta_gastos, get_odoo_cta( v_cta_gastos , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_gastos, v_acumulado  with resume;
                    INSERT INTO tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, v_concepto, v_tot_gastos, v_acumulado );
                End if;
				
                Let v_contador = 1;
            End if;

            if 	v_tipo_var = 'T' then
				--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ADEUDO ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
				if 	par_Tabla = '5' then
					Let v_concepto = 'REFRENDO ACTUAL';
					if 	v_descripcion = 'Empresas Especializadas VP' then
						Let v_cta_adeudos_act = 370400000;
					End if;
					if 	v_descripcion = 'Con cobro para el usuario VP' then
						Let v_cta_adeudos_act = 340500003;
					End if;
					if 	v_descripcion = 'Sin cobro para el usuario VP' then
						Let v_cta_adeudos_act = 340500004;
					End if;
				Else
					Let v_concepto = 'ADEUDO ACTUAL';
					if 	par_Tabla = '1' then
						if 	v_axo = year(today) then
							Let v_cta_adeudos_act = 353200000;
						else
							Let v_cta_adeudos_act = 353230000;  -- rezago
						End if;
					End if;
					
					if 	par_Tabla = '2' then
						if 	v_axo = year(today) then
							Let v_cta_adeudos_act = 353800000;
						else
							Let v_cta_adeudos_act = 353830000;  -- rezago
						End if;
					End if;
					
					if 	par_Tabla = '4' then
						if 	v_descripcion = '1ra. Especial SP' then
							Let v_cta_adeudos_act = 340400001;
						End if;
						if 	v_descripcion = '1ra. SP' then
							Let v_cta_adeudos_act = 340400002;
						End if;
						if 	v_descripcion = '2da. SP' then
							Let v_cta_adeudos_act = 340400003;
						End if;
						if 	v_descripcion = '3ra. SP' then
							Let v_cta_adeudos_act = 340400004;
						End if;
						if 	v_descripcion = 'Otros SP' then
							Let v_cta_adeudos_act = 340400005;
						End if;
					End if;
				End if;
				
                Let v_acumulado = v_acumulado + v_importe;  
				RETURN 0, v_cta_adeudos_act, get_odoo_cta( v_cta_adeudos_act , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                INSERT INTO tmp_total_otras_oblig 
				VALUES ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );

                SELECT 	sum(por_recargo)   
				INTO 	v_Importe_recargo  
				FROM 	t34_porcentajes  
                WHERE 	periodo_porc BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

                if 	v_Importe_recargo <> 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'RCGO. ADEUDO' ) INTO v_cta_rcgos_ade, v_concepto;
					Let v_concepto = 'RCGO. ADEUDO';
					if 	par_Tabla = '5' then
						Let v_cta_rcgos_ade = 390900000;
					else
						Let v_cta_rcgos_ade = 390500000;
					End if;
                    
					Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                    Let v_acumulado = v_acumulado + v_importe_rec1;
                    RETURN 0, v_cta_rcgos_ade, get_odoo_cta( v_cta_rcgos_ade , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec1, v_acumulado  with resume;
                    INSERT INTO tmp_total_otras_oblig 
					VALUES  ( 0,0, v_cta_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec1, v_acumulado );  
					
					-- inicia codigo nuevo inpc Actualizacion 	
					Let	perioI = (v_Axo * 100) + v_Mes;
					Let	v_actualizacion = dbestacion:fcn_inpc_x_mes ( perioI ) * v_importe_rec1 / 100 ;
					let v_acumulado = v_acumulado + v_actualizacion;
					let v_concepto = 'ACTUALIZACION'  ;
                    RETURN 0, 459111, 459111, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_actualizacion, v_acumulado  with resume;
                    INSERT INTO tmp_total_otras_oblig 
					VALUES  ( 0,0, 459111, v_Axo || '/' || v_Mes, v_concepto, v_actualizacion, v_acumulado );  
					-- Termina codigo nuevo inpc Actualizacion
					
					EXECUTE PROCEDURE sp_desctomerc (v_id_34_datos, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 34) INTO v_importe_rec2, v_mensaje_proc;
                End if;
				
                if 	v_importe_rec2 > 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. RECARGO' ) INTO v_cta_dcto_rcgos_ade, v_concepto;
					Let v_concepto = 'DSCTO. RECARGO';
					if 	par_Tabla = '5' then
						Let v_cta_dcto_rcgos_ade = 390940000;
					else
						Let v_cta_dcto_rcgos_ade = 390540000;
					End if;
					
                    Let v_importe_rec2 = v_importe_rec2 * -1;
                    Let v_acumulado = v_acumulado + v_importe_rec2;
                    RETURN 0, v_cta_dcto_rcgos_ade, get_odoo_cta( v_cta_dcto_rcgos_ade , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec2, v_acumulado  with resume;
					INSERT INTO  tmp_total_otras_oblig 
					VALUES  ( 0,0, v_cta_dcto_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec2, v_acumulado );
                End if;
            Else
				if 	v_tipo_var = 'F' then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'F', 'FORMA' ) INTO v_cta_adeudos_act, v_concepto;
					Let v_concepto = 'FORMA';
					if 	par_Tabla = '5' then
						Let v_cta_adeudos_act = 421200012;
					End if;
				
					Let v_acumulado = v_acumulado + v_importe;  
					RETURN 0, v_cta_adeudos_act, get_odoo_cta( v_cta_adeudos_act , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
					INSERT INTO  tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                End if;

                if 	v_tipo_var = 'A' then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'A', 'AUTORIZACION ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
					if 	par_Tabla = '5' then
						Let v_concepto = 'AUTORIZACION ACTUAL';
						if 	v_descripcion = 'Empresas Especializadas VP' then
							Let v_cta_adeudos_act = 370300000;
						End if;
						if 	v_descripcion = 'Con cobro para el usuario VP' then
							Let v_cta_adeudos_act = 340500001;
						End if;
						if 	v_descripcion = 'Sin cobro para el usuario VP' then
							Let v_cta_adeudos_act = 340500002;
						End if;
					End if;
			
					Let v_acumulado = v_acumulado + v_importe;  
					RETURN 0, v_cta_adeudos_act, get_odoo_cta( v_cta_adeudos_act , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
					INSERT INTO  tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
				End if;
			End if;
		End if;

		Let v_importe = 0;
		Let v_Importe_recargo = 0;
		Let v_importe_rec1 = 0;
		Let v_importe_rec2 = 0;
    END FOREACH;
    -- TERMINAN PERIODOS

	if 	v_contador = 0 then
		if 	v_tot_multas > 0 then
			--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
			Let v_concepto = 'MULTAS';
			if 	par_Tabla = '5' then
				Let v_cta_multas = 515003004;
			End if;
        
			Let v_acumulado = v_acumulado + v_tot_multas;  
			RETURN 0, v_cta_multas, get_odoo_cta( v_cta_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'MULTAS ', v_tot_multas, v_acumulado with resume;
			INSERT INTO tmp_total_otras_oblig 
			VALUES ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, 'MULTAS ', v_tot_multas, v_acumulado );
		End if;
	
		if 	v_tot_dscto_multas <> 0 then
			--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
			Let v_concepto = 'DSCTO. MULTAS';
			if 	par_Tabla = '5' then
				Let v_cta_dscto_multas = 515043004;
			End if;
			
			Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
			RETURN 0, v_cta_dscto_multas, get_odoo_cta( v_cta_dscto_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado  with resume;
			INSERT INTO tmp_total_otras_oblig 
			VALUES  ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado );
		End if;
 
		if 	v_tot_gastos > 0 then
			EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
			Let v_concepto = 'GASTOS';

			if 	par_Tabla = '5' then
				Let v_cta_gastos = 550620010;
			End if;
			
			Let v_acumulado = v_acumulado + v_tot_gastos;  
			RETURN 0, v_cta_gastos, get_odoo_cta( v_cta_gastos , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'GASTOS ', v_tot_gastos, v_acumulado  with resume;
			INSERT INTO tmp_total_otras_oblig 
			VALUES ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, 'GASTOS ', v_tot_gastos, v_acumulado );
		End if;
	End if;
End if;

END PROCEDURE
;

create procedure "pgcabrer".spd_11_generacartera(prec int,paxo int)
returning   int as locales,
            int as meses,
            int as existeade,
            int as existepagcan;

define vid,vofi,vmer,vcat,vloc,vaxo,vcvecuo,v_cont int;
define vtotloc,vtotmeses,vtotexia,vtotextpc int;
define vsec char(2);
define vlet,vblq char(1);
define vsuperf decimal(7,2);
define vimpcuo,vade money(18,2);

let vtotloc=0;
let vtotmeses=0;
let vtotexia=0;
let vtotextpc=0;

foreach
  select a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,a.superficie,
  c.axo,c.clave_cuota,c.importe_cuota
  into vid,vofi,vmer,vcat,vsec,vloc,vlet,vblq,vsuperf,vaxo,vcvecuo,vimpcuo
  from ta_11_locales a,ta_11_mercados b,ta_11_cuo_locales c
  where a.oficina=prec and a.vigencia='A' and a.bloqueo<4 and b.tipo_emision<>'B' and a.num_mercado<>214
  and a.oficina=b.oficina and a.num_mercado=b.num_mercado_nvo
  and c.axo=paxo and a.categoria=c.categoria and a.seccion=c.seccion and a.clave_cuota=c.clave_cuota
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

  let vtotloc=vtotloc+1;
  -- calcula renta
  let vade=0;
  if vsec='PS' then
     if vcvecuo=4 then
        let vade=vsuperf*vimpcuo;
     else
        if (paxo < 2019) or (paxo >= 2020) then
           let vade=(vimpcuo*vsuperf)*30;
        else
           let vade=vsuperf*vimpcuo;
        end if;
     end if
  else
     let vade=vsuperf*vimpcuo;
  end if;

  -- graba el adeudo mensual
  for v_cont= 1 to 12
      if ((not exists(select * from ta_11_pagos_local where id_local=vid and axo=vaxo and periodo=v_cont)) and
         (not exists(select * from ta_11_ade_loc_canc where id_local=vid and axo=vaxo and periodo=v_cont))) then
         if not exists(select * from ta_11_adeudo_local where id_local=vid and axo=vaxo and periodo=v_cont) then
            insert into ta_11_adeudo_local values(0,vid,vaxo,v_cont,vade,current,18);
            let vtotmeses=vtotmeses+1;
         else
            let vtotexia=vtotexia+1;
         end if
      else 
         let vtotextpc=vtotextpc+1; 
      end if; 
  end for; 
end foreach;

return vtotloc,vtotmeses,vtotexia,vtotextpc;
end procedure;

CREATE PROCEDURE "pgcabrer".spd_11_calc_renta(
parm_alo  smallint,
parm_categoria  smallint,
parm_seccion  char(2),
parm_cve_cuota  smallint,
parm_superficie decimal(7,2),
parm_merc smallint,
parm_trimestre smallint)
returning money(10,2);
define    v_id_cuotas integer;
define    v_axo,v_sabados smallint;
define    v_categoria  smallint;
define    v_seccion  char(2);
define    v_cve_cuota smallint;
define    v_importe_cuota money(10,2);
define    v_renta  money(10,2);
let v_renta=0;
foreach
   select id_cuotas,axo,categoria,seccion,clave_cuota,importe_cuota 
   into v_id_cuotas,v_axo,v_categoria,v_seccion,v_cve_cuota,v_importe_cuota
   from ta_11_cuo_locales
   where axo=parm_alo and categoria=parm_categoria and seccion=parm_seccion 
   and  clave_cuota=parm_cve_cuota

   select first 1 sabadosacum into v_sabados 
   from ta_11_fecha_desc where trimestre=parm_trimestre;

   if  parm_seccion ='PS' then
       if v_cve_cuota=4 then
          let v_renta=parm_superficie*v_importe_cuota; 
       else
          if (parm_alo < 2019) or (parm_alo >= 2020) then 
             let v_renta=(parm_superficie*v_importe_cuota)*30;
          else
             let v_renta=parm_superficie*v_importe_cuota;
          end if;
       end if;
   else
       if parm_merc=214 then
          let v_renta=(parm_superficie*v_importe_cuota)*v_sabados;
       else
          let v_renta=parm_superficie*v_importe_cuota;
       end if;
   end if; 
end foreach;
return v_renta;
end procedure;

CREATE PROCEDURE "informix".con16_detade_02 ( p_Control_contrato Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
	returning	varchar(100) as Concepto,
		Integer as Cant_Recolec,
              		Money(12,2) as Importe_Adeudos_Multa,
              		Money(12,2) as Importe_Recargos_Gastos,
                        Money(12,2) as Importe_Act;
               

{
#  Procedimiento: Con16_detade_02
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Fecha :   Periodo de Adeudo   
#                                      Concepto : El concepto de cobro
#                                      Numero : Unidades recolectadas
#                                      Importe : El importe de los Adeudos/multa
#                                      Importe : El importe de los Recargos/gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                                    Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq, v_Lineas_Dato                                                   Integer;
  define v_importe_multa, v_porcentaje_multa, v_tot_multas, v_tot_dscto_multas, v_importe_gastos, v_tot_gastos                                                    Money(12,2);
  define v_DetFolReq                                                                                                  varchar(120);
  define v_diligencia                                                                                                                     char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago                                                                                                        Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2                                 Money(12,2);

  define v_Ctrol_Operacion, v_exedencias                                                                        Integer;
  define v_descripcion                                                                                                 varchar(50);
  define v_Detalle_Dato                                                                                                             varchar(100);

       define v_Importe_recargo, v_TotRecargos                                                               Money(12,2);
       define v_mensaje_proc                                                                                                     varchar(255);
--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE                             varchar(7);
  define v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade                                                        varchar(7);
  define v_Periodo                                                                                                                       varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo, v_Mes                                                           Integer;
--****************************************************************************************************************************** 
  define v_licencia, v_Follic                                                                                                                                       Integer;
  define v_DetFollic                                                                                                                                                     varchar(120);

  define v_actualizacion money(12,2);

-- set debug file to 'Gil.log';
-- trace on;   
Let v_Contador = 0;
   
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_rec1 = 0;
   Let v_importe_rec2 = 0;
   Let v_axo = 0;
   Let v_Lineas_Dato = 0;
   Let v_actualizacion = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

                               -- licencias relacionadas
                                               Let v_Follic = 0;
                                               Let v_licencia = 0;
                                               Let v_DetFollic = 'Licencia(s) Relacionada(s) : ';
                                               foreach
                                                               SELECT a.num_licencia INTO v_licencia  FROM ta_16_rel_licgiro a, catastro_gdl:Licencias b
                                                                              where a.control_contrato = p_Control_contrato
                                                                              and b.licencia = a.num_licencia and b.vigente = "V"
                                                                              order by a.num_licencia

                               if v_Follic > 0 then
                                  Let v_DetFollic = v_DetFollic || ',' || v_licencia;
                               else
                                  Let v_DetFollic = v_DetFollic || v_licencia;
                               Let v_Follic = v_Follic + 1;
                               end if;

                                               end foreach;
                        if v_Follic > 0 then
                                                               return v_DetFollic, Null, Null, Null,Null     with resume;
                                Let v_Contador = v_Contador + 1;
                        end if;

                               -- termina licencias relacionadas

                Let v_tot_gastos = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_FolReq = 0;
                Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
                foreach

                     Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa
                       Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      from ta_15_apremios
                       Where modulo = 16  And control_otr = p_Control_contrato
                       And vigencia = "1" and clave_practicado = "P"
                      Order By id_control

                               Let v_tot_multas = v_importe_multa;
                               if v_porcentaje_multa < 100 then
                                               Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                               Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                               else
                                               Let v_tot_dscto_multas = 0;
                               end if;

                               if v_FolReq > 0 then
                                  Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
                               else
                                  Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
                               Let v_FolReq = v_FolReq + 1;
                               end if;

                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                end foreach;
                       if v_FolReq > 0 then
                               return v_DetFolReq, Null, v_importe_multa, v_tot_gastos,Null  with resume;
                               if v_tot_dscto_multas <> 0 then
                                                               return 'Dscto. a Multas',              Null, v_tot_dscto_multas, Null, Null  with resume;
                               end if;
                                Let v_Contador = v_Contador + 1;
                       end if;

--                Let v_Lineas_Dato = 0;
--                Let v_Detalle_Dato = '';
--                               Select ('Descuento de Recargos en periodo(s) del ' || axoinicio || '-' || mesinicio || 
--                                               ' al ' || axofin || '-' || mesfin || ' por el ' || porcentaje || ' %'), 
--                                               (axoinicio || '-' || mesinicio), axofin || '-' || mesfin, porcentaje
--                                               INTO v_Detalle_Dato, v_Periodo_Inicio, v_Periodo_fin, v_porc
--                                               from ta_16_descrec
--                                               Where id_contrato = p_Control_contrato and vigencia = 'V';
--
--                              if v_Detalle_Dato <> '' then
--                                  Let v_Lineas_Dato = v_Lineas_Dato + 1;
--                              end if;

-- inicio
  -- pedazo adicionado
  Let r_Periodo_CN = v_Periodo_CN;
  Let r_Periodo_EXE = v_Periodo_EXE;
  if p_Rep <> 'V' then
     Let v_Periodo_CN = p_Fecha_fin;
     Let v_Periodo_EXE = p_Fecha_fin;
  end if;

                               foreach
                                               Select Year(A.aso_mes_pago), Month(A.aso_mes_pago), A.aso_mes_pago,  A.Ctrol_Operacion, B.descripcion, A.exedencias, A.importe
                                                       ,calc_actualizacion_aseo(Year(A.aso_mes_pago), Month(A.aso_mes_pago), A.importe)
                                               INTO v_axo, v_Mes , v_aso_mes_pago, v_Ctrol_Operacion, v_descripcion , v_exedencias, v_importe, v_actualizacion
                                                               From ta_16_pagos A, ta_16_operacion B
                                                               Where a.Control_Contrato = p_Control_contrato and a.Ctrol_Operacion = 6 
                                                              and a.aso_mes_pago <= ( v_Periodo_CN )          -- anteriormente p_Fecha_fin
                                                              and a.Status_Vigencia = 'V'
                                                               and b.ctrol_operacion = a.ctrol_operacion
                                               Order By A.aso_mes_pago,  A.Ctrol_Operacion
             
                               if v_importe > 0 then
                                                               Select sum(porc_recargo) 
                                                               Into v_Importe_recargo
                                               From ta_16_recargos 
                                               Where aso_mes_recargo between (v_aso_mes_pago) and (r_Periodo_CN);
                               end if;

                               if v_importe > 0 then
                                    Let v_Contador = v_Contador + 1;
                                   Let v_totAdeudos = v_totAdeudos + v_importe;
                                   if v_Importe_recargo <> 0 then
                                               Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                               RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), v_exedencias, v_importe, v_importe_rec1,v_actualizacion  with resume;
                                               EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                               if v_importe_rec2 > 0 then
                                                               Let v_importe_rec2 = v_importe_rec2 * -1;
                                                               RETURN 'Dscto. al Rcgo del Adeudo', Null, Null, v_importe_rec2 ,Null           with resume;
                                               end if;
                                   else
                                               RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), v_exedencias, v_importe, 0 ,v_actualizacion  with resume;
                                   end if;
                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;

                               Let v_totAdeudos = 0;
                               Let v_TotRecargos = 0;
                               end foreach;

                               foreach
                                               Select Year(A.aso_mes_pago), Month(A.aso_mes_pago), A.aso_mes_pago,  A.Ctrol_Operacion, B.descripcion, A.exedencias, A.importe
                                                    ,calc_actualizacion_aseo(Year(A.aso_mes_pago), Month(A.aso_mes_pago), A.importe)
                                               INTO v_axo, v_Mes , v_aso_mes_pago, v_Ctrol_Operacion, v_descripcion , v_exedencias, v_importe, v_actualizacion
                                                               From ta_16_pagos A, ta_16_operacion B
                                                               Where a.Control_Contrato = p_Control_contrato and a.Ctrol_Operacion <> 6 
                                                              and a.aso_mes_pago <= ( v_Periodo_EXE )       -- anteriormente p_Fecha_fin
                                                              and a.Status_Vigencia = 'V'
                                                               and b.ctrol_operacion = a.ctrol_operacion
                                               Order By A.aso_mes_pago,  A.Ctrol_Operacion
             
                               if v_importe > 0 then
                                               Select sum(porc_recargo) 
                                               Into v_Importe_recargo
                                                From ta_16_recargos 
                                                Where aso_mes_recargo between (v_aso_mes_pago) and (r_Periodo_EXE);
                               end if;

                              if v_importe > 0 then
                                    Let v_Contador = v_Contador + 1;
                                   Let v_totAdeudos = v_totAdeudos + v_importe;
                                   if v_Importe_recargo <> 0 then
                                               Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                               RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), v_exedencias, v_importe, v_importe_rec1,v_actualizacion  with resume;
                                               EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                               if v_importe_rec2 > 0 then
                                                               Let v_importe_rec2 = v_importe_rec2 * -1;
                                                               RETURN 'Dscto. al Rcgo del Adeudo', Null, Null, v_importe_rec2, Null             with resume;
                                               end if;
                                   else
                                               RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), v_exedencias, v_importe, 0, v_actualizacion with resume;
                                   end if;
                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;

                               Let v_totAdeudos = 0;
                               Let v_TotRecargos = 0;
                               end foreach;


   if v_Contador = 0 then
       return 'NO HAY ADEUDO DENTRO DEL PERIODO SELECCIONADO' , Null, Null, Null, Null  with resume;
--   else
--       if v_Lineas_Dato > 0 then
--          return v_Detalle_Dato, Null, Null, Null       with resume;
--       end if;
   end if;
--trace off;
end procedure;

create procedure "pgcabrer".sp_bajaconvenios(ptipo int, pfecven date, piduser int, pusuario varchar(8))
        returning   int as totbajas,
                    int as estado,
                    varchar(100) as mensaje;

define v_totbajas, v_estado, v_tipo, v_subtipo, v_numero_exp, v_axo_exp, v_id_conv_resto, v_modulo, v_id_referencia int;
define v_letras_exp char(3);
define v_fecha_venc, v_fecha_inic date;
define v_mensaje varchar(100); 

let v_totbajas=0;
let v_estado=null;
let v_mensaje='';

foreach  
    -- busca los convenios vigentes vencidos de tipo y fecha seleccionado
--    select d.tipo, d.subtipo, d.letras_exp, d.numero_exp, d.axo_exp, a.id_conv_resto, a.fecha_inicio, a.fecha_venc, b.modulo, b.id_referencia 
--    into v_tipo, v_subtipo, v_letras_exp, v_numero_exp, v_axo_exp, v_id_conv_resto, v_fecha_inic, v_fecha_venc, v_modulo, v_id_referencia
--    from ta_17_conv_diverso d, ta_17_conv_d_resto a, ta_17_referencia b
--    where d.tipo=ptipo and a.fecha_venc<=pfecven and a.vigencia='A'
--    and a.tipo=d.tipo and a.id_conv_diver=d.id_conv_diver and b.id_conv_resto=a.id_conv_resto


    -- busca los convenios vigentes por tipo y fecha de parcialidad vencida
    select d.tipo, d.subtipo, d.letras_exp, d.numero_exp, d.axo_exp, a.id_conv_resto, a.fecha_inicio, a.fecha_venc, b.modulo, b.id_referencia 
    into v_tipo, v_subtipo, v_letras_exp, v_numero_exp, v_axo_exp, v_id_conv_resto, v_fecha_inic, v_fecha_venc, v_modulo, v_id_referencia
    from ta_17_conv_diverso d, ta_17_conv_d_resto a, ta_17_referencia b, ta_17_adeudos_div e
    where d.tipo=ptipo and e.fecha_venc<=pfecven and a.vigencia='A' and e.id_conv_resto=a.id_conv_resto and e.clave_pago is null
    and a.tipo=d.tipo and a.id_conv_diver=d.id_conv_diver and b.id_conv_resto=a.id_conv_resto
    group by 1,2,3,4,5,6,7,8,9,10
    having  count(e.id_adeudo)>=2
    order by 1,2,3,4,5


    -- busca convenios vigentes de tipo y hasta fecha de vencimiento de convenio seleccionado
--    select d.tipo, d.subtipo, d.letras_exp, d.numero_exp, d.axo_exp, a.id_conv_resto, a.fecha_inicio, a.fecha_venc, b.modulo, b.id_referencia
--    into v_tipo, v_subtipo, v_letras_exp, v_numero_exp, v_axo_exp, v_id_conv_resto, v_fecha_inic, v_fecha_venc, v_modulo, v_id_referencia
--    from ta_17_conv_diverso d, ta_17_conv_d_resto a, ta_17_referencia b
--    where d.tipo=ptipo and a.fecha_venc<=pfecven and a.vigencia='A' 
--    and a.tipo=d.tipo and a.id_conv_diver=d.id_conv_diver and b.id_conv_resto=a.id_conv_resto
--    group by 1,2,3,4,5,6,7,8,9,10
--    order by 1,2,3,4,5

    -- da de baja el convenio
    update ta_17_conv_d_resto set vigencia='B', id_usuario=piduser, fecha_actual=current where id_conv_resto=v_id_conv_resto;
    let v_totbajas=v_totbajas+1;
    let v_estado=0;
    let v_mensaje='Se dieron de baja correctamente';

    -- afecta la tabla de catastro si es multa, predial, licencia � anuncio
    if (v_modulo=3) or (v_modulo=5) or (v_modulo=9) or (v_modulo=10) then
        update catastro_gdl:convenios set vigencia='B' where id_conv_diver=v_id_conv_resto and vigencia='A';

        if v_modulo=9 then
           execute procedure catastro_gdl:conv_licanun(v_id_referencia,'L','B',v_id_conv_resto,pusuario) into v_estado;
           execute procedure spd_17_ins_saldos(v_id_conv_resto, v_id_referencia, 9,(v_letras_exp||'/'||v_numero_exp||'/'||v_axo_exp), 'A')
            into v_estado, v_mensaje;
        end if;

        if v_modulo=10 then
           execute procedure catastro_gdl:conv_licanun(v_id_referencia,'A','B',v_id_conv_resto,pusuario) into v_estado;
           execute procedure spd_17_ins_saldos(v_id_conv_resto, v_id_referencia, 10,(v_letras_exp||'/'||v_numero_exp||'/'||v_axo_exp), 'A')
            into v_estado, v_mensaje;
        end if;
    end if;

    -- proceso para recativar mercados
    if v_modulo=11 then
        -- desbloquea tabla de locales
        update ta_11_locales set bloqueo=0 where id_local=v_id_referencia;
        if v_tipo=6 then
           update ta_11_bloqueo set fecha_final=v_fecha_venc where id_local=v_id_referencia and cve_bloqueo=1 and fecha_inicio=v_fecha_inic;
        else
           if v_tipo=7 then
              update ta_11_bloqueo set fecha_final=v_fecha_venc where id_local=v_id_referencia and cve_bloqueo=2 and fecha_inicio=v_fecha_inic;
           else
              update ta_11_bloqueo set fecha_final=v_fecha_venc where id_local=v_id_referencia and cve_bloqueo=3 and fecha_inicio=v_fecha_inic;
           end if;
        end if;
    end if;

    -- desbloquea aseo contratado
    if v_modulo=16 then
       update ta_16_contratos set status_vigencia='V' where control_contrato=v_id_referencia;
    end if;

    -- desbloquea estacionamientos exclusivo
    if v_modulo=28 then
        update esta_ifx:ex_contrato set estatus="V" where id=v_id_referencia;
    end if;

end foreach;
return v_totbajas, v_estado, v_mensaje;
end procedure;

CREATE FUNCTION "informix".linea_capturagral(p_modulo int, p_cuentaid int, p_monto decimal(18,2), p_desde varchar(3), p_hasta varchar(3), p_vencimiento date)

    /********************************************************************
    * PAR�METROS:
    *   p_modulo: Id de m�dulos  14 -> Cementerios
    *   p_cuentaid: Identificador de la cuenta a generar la linea
    *   p_monto: monto por el cual se genera la l�nea de captura
    *   p_desde: 3 digitos bimestre/a�o (dos d�gitos) 121
    *   p_hasta: 3 digitos bimestre/a�o (dos d�gitos) 621
    ********************************************************************/
    returning varchar(110) as resultado, varchar(50) as linea;

    define linea1 varchar(50);
    define resultado varchar(110);
    define v_id int;
    define v_axobase int;
    define fecha int;
    define fecha_st char(5);
    define fechax date;
    define v_codigo1 varchar(20);
    define v1_7 smallint;
    define v1_3 smallint;
    define v1_1 smallint;
    define vt1    int;
    define v2_11 smallint;
    define v2_13 smallint;
    define v2_17 smallint;
    define v2_19 smallint;
    define v2_23 smallint;
    define vt2    int;
    define i int;

    -- Inicializamos variables...
    let v_axobase = 2013;

    select max(lc.linea) into linea1
    from lineas_captura lc
    where lc.modulo = p_modulo and lc.id_cuenta = p_cuentaid
        and lc.monto = p_monto and lc.vigencia >= today;

    if linea1 is null then
        -- ************ No existe Linea, la generamos...
        let linea1 = lpad(p_cuentaid, 6, '0') || lpad(p_desde,3,'0') || lpad(p_hasta, 3, '0');

        insert into lineas_captura(id, modulo, id_cuenta, fecha, monto, desde, hasta, vigencia, linea) 
	    values(0, p_modulo, p_cuentaid, today, p_monto, p_desde, p_hasta, p_vencimiento, linea1);

        let v_id = dbinfo("sqlca.sqlerrd1");

        let linea1 = linea1|| lpad(v_id, 6, '0');

        let linea1 = linea1 || lpad(p_modulo, 2, '0'); --pago de modulo

        -- Codificamos fecha *********************
        let fechax = p_vencimiento;

        let fecha = (((year(fechax) - v_axobase) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1)) + 10000;  
        let fecha_st = '' || fecha;

        let linea1 = linea1 || fecha_st[2,5];

        -- Calculamos digito verificador del importe
        let v_codigo1 = trunc(p_monto*100) ;
        let vt1 = 0;

        for i = length(v_codigo1) to 1 step -3
            let v1_7 = 0;
            let v1_3 = 0;
            let v1_1 = 0;

            if i >= 1 then
                let v1_7 = substr(v_codigo1,i , 1)  * 7;
            end if;
            
            if i >= 2 then
                let v1_3 = substr(v_codigo1,(i -1) , 1)  * 3;
            end if;

            if i >= 3 then
                let v1_1 = substr(v_codigo1,(i -2), 1)  * 1;
            end if;

            let  vt1 = vt1+ v1_7 + v1_3 + v1_1;

        end for;

        let vt1 = mod(vt1,10);
        let linea1 = linea1 || vt1;

        -- Controles, validar fecha e importe ******
        let linea1 = linea1 || '2'; -- El 2 valida fecha e importe

        -- Control General - Digito Verificador final ******************************
        let vt2 = 0;

        for i =   length(linea1) to 1 step -5
            let v2_11 = 0;
            let v2_13 = 0;
            let v2_17 = 0;
            let v2_19 = 0;
            let v2_23 = 0;

            if i >= 1 then
                let v2_11 = substr(linea1,i , 1)  * 11;
            end if;
            
            if i >= 2 then
                let v2_13 = substr(linea1,(i -1) , 1)  * 13;
            end if;
            
            if i >= 3 then
                let v2_17 = substr(linea1,(i -2), 1)  * 17;
            end if;
            
            if i >= 4 then
                let v2_19 = substr(linea1,(i -3), 1)  * 19;
            end if;  
            
            if i >= 5 then
                let v2_23 = substr(linea1,(i -4), 1)  * 23;
            end if;
            
            let  vt2 = vt2+ v2_11 + v2_13 + v2_17 + v2_19 + v2_23;
        end for;

        let vt2 = mod(vt2,97) +1;
        
        let linea1 = linea1 || lpad(vt2, 2, '0');
        
        -- Actualizamos la tabla con la linea actualizada...
        update lineas_captura set
            linea = linea1
        where id = v_id;    
    end if;

    -- Dividimos la linea en grupo de cuatro caracteres
    let resultado = '';

    for i = 1 to length(linea1) step 4
        let resultado = resultado || substr(linea1,i , 4) || "   ";
    end for;

    let resultado = resultado || "   -   " || p_monto;

    return resultado, linea1; 

end function;

CREATE FUNCTION "informix".kio13_datosencx(var_control integer, var_axo int)
                 returning  char(1) as slinea, int as sclave, varchar(100) as scomentario, varchar(100) as sregcomp,
               VARCHAR(60) as snombre,VARCHAR(75) as sdomcomp, VARCHAR(30)as scol,VARCHAR(10) as stdesc, dec(5,3) as smetros,
               VARCHAR(60) as snomcem, varchar(250) as sconcepto, money(15,2) as simptot,varchar(30) as speriodo,
			   money(15,2) as simporte, money(15,2) as srecargo, money(15,2) as sdesctoimp,money(15,2) as sdesctorec,
               money(15,2) as sajuste, varchar(60)as sobserv, int as control;

define v_uap    integer;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_metros dec(5,3);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_clase SMALLINT;
define  v_clase_alfa VARCHAR(10);
define  v_seccion SMALLINT;
define  v_seccion_alfa VARCHAR(10);
define  v_linea SMALLINT;
define  v_linea_alfa VARCHAR(20);
define  v_fosa SMALLINT;
define  v_fosa_alfa VARCHAR(20);
define  v_axo_pagado INTEGER;
define  v_metros DECIMAL(5,3);
define  v_nombre VARCHAR(60) ;
define  v_colonia VARCHAR(30);
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_reg_cem varchar(100);
define  v_domcompleto VARCHAR(75);
define  v_tipodesc VARCHAR(10);
define  v_nomcem VARCHAR(60);
define  v_concepto varchar(250);
define  v_concepto1 varchar(250);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define v_ctaaplaju     int;
define  v_totim money(15,2);
define  v_totre money(15,2);
define  v_totdi money(15,2);
define  v_totdr money(15,2);

define v_cuenta integer;
define v_ajuste money(5,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_axohasta int;
define v_axocont char(35);
define v_axocont1 int;
define v_cont int;
define v_actualizacion  money(15,2);

--ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--RETURN '-1',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,'', 'sp_13_datosrcm ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

--END EXCEPTION
--let var_axo = 2019;
let v_axo=year(today);
let v_mes=month(today);
--let v_mes=2;
 let v_imptot=0;
 let v_concepto = '';
 let v_concepto1 = '';
 let v_periodo='';
 let v_obs='';
 let v_desctot  = 0;
 let  v_totim=0;
 let  v_totre=0;
 let  v_totdi=0;
 let  v_totdr=0;
 let  v_ctaapli=0;
 let  v_ctaaplr=0;
 let  v_ctaapldi=0;
 let  v_ctaapldr=0;
 let  v_ctaaplaju=0;
 if var_axo = 0 then
  let var_axo = year(today);
 end if;
 if var_control>0 then
  select control_rcm, cementerio,cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
 clase,clase_alfa,seccion,seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
 ,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,metros,
 case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
 end
 into v_control, v_cementerio,v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
 ,v_axo_pagado,v_metros,v_nombre,v_domcompleto,v_colonia ,vpar_metros,v_tipodesc
 from ta_13_datosrcm where control_rcm=var_control;
 else
 select control_rcm, cementerio,cementerio || clase||' '||clase_alfa ||' '||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
 clase,clase_alfa,seccion,seccion_alfa , linea , linea_alfa , fosa,fosa_alfa
 ,axo_pagado,metros,nombre,domicilio || ' ' || exterior ||' '|| interior ,colonia ,metros,
 case when tipo = 'F' then 'FOSA' 
        when tipo = 'G' then 'GAVETA' 
        when tipo = 'U' then 'URNA'
        else ''
 end
 into v_control,v_cementerio,v_reg_cem,v_clase,v_clase_alfa,v_seccion,v_seccion_alfa , v_linea , v_linea_alfa , v_fosa,v_fosa_alfa
 ,v_axo_pagado,v_metros,v_nombre,v_domcompleto,v_colonia ,vpar_metros,v_tipodesc
 from ta_13_datosrcm where cementerio=var_cementerio and clase=var_clase and clase_alfa= var_clasalf and seccion=var_secc 
 and seccion_alfa=var_seccalf and linea=var_linea and linea_alfa=var_linalf and fosa= var_fosa  and fosa_alfa=var_fosalf;
 end if;

 select  nombre, cta_aplicacion, cta_vencido into v_nomcem,v_ctaapl1,v_ctaapl2 
 from tc_13_cementerios where cementerio=v_cementerio; 

 if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   let v_clave = -1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,'',v_control; 
 end if;      
 if v_axo_pagado>=v_axo  then
   let v_clave = -2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO PARA ESTE PERIODO';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,'',v_control; 
 end if;     
 if v_tipodesc <>'FOSA'  then
   let v_clave = -3; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO ES FOSA, NO SE PUEDE PAGAR';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,'',v_control; 
 end if;   
   -- PAra calcular Recargos.
      execute procedure spd_13_recargos(var_control , v_mes);
 select max(axo_adeudo) into v_axohasta from ta_13_adeudosrcm where control_rcm = var_control and vigencia = 'V';

    if var_axo < v_axohasta then
       let v_axohasta = var_axo;
    end if;

    if (v_axo_pagado + 1) < (year(today) - 5) then
        let v_axodesde =(year(today) - 5);
    else
        let v_axodesde = v_axo_pagado + 1;
    end if;
   let v_axocont = '';
 let v_cont =0;
  foreach 
    select axo_adeudo into v_axocont1 from ta_13_adeudosrcm where control_rcm = var_control and vigencia = 'V' 
    and axo_adeudo between v_axodesde and v_axohasta order by 1
     let v_cont = v_cont +1;
     if v_cont = 1 then
       let v_axocont = v_axocont1;
     else
        let v_axocont = trim(v_axocont) || ', ' || v_axocont1;
     end if;
   
   end foreach;
 let v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || v_axohasta;
 let v_concepto = 'PAGO DE MANTENIMIENTO DEL PANTEON '|| v_nomcem || ' DE: CLASE ' || v_clase ||' ' || v_clase_alfa || ' SECC. '|| v_seccion ;
 let v_concepto = trim(v_concepto) || ' ' || trim(v_seccion_alfa) || ' LINEA ' ||v_linea || ' ' || trim(v_linea_alfa) || ' FOSA ' || v_fosa || ' DE ' || v_metros || ' MTS.';
  if v_cont > 1 then
  let v_concepto1 =  'ANUALIDADES: '|| v_axocont ||'.' ;
  else 
  let v_concepto1 = 'ANUALIDAD: '|| v_axocont  ||'.';
  end if;
 let v_clave = 0; 
 let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO SE PUEDE PAGAR';

 if v_axo<>var_axo then
   let v_axo=var_axo;
 end if;
---Para calcular el importe total
 foreach 
 select b.axo_adeudo,b.importe,b.importe_recargos,d.axo_descto,nvl(d.descuento,0),b.descto_impote, b.descto_recargos,nvl(b.actualizacion,0)
           into vpar_axo,vpar_impte, vpar_recar , v_axo_alta ,v_descuento,v_impdesc,v_recardesc,v_actualizacion 	
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
           order by 1

    let v_desctot = 0;
    let v_desctotre = 0;
    if  v_impdesc>0 then
           let v_obs='Desc Pensionado 50%';
    end if;
     --se aplica descuento de pesionado
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
     if  v_impdesc=0 then
           let v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
           let v_obs=v_obs||' Incluye 10% Desc por pronto pago ';
     end if;
     end if;

     let v_desctot  =  v_impdesc;
     let v_desctotre  =   v_recardesc;
     let v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) + v_actualizacion ; 
     let v_totim = (v_totim + vpar_impte); 
     let v_totre = (v_totre + vpar_recar); 
     let v_totdi = (v_totdi + v_desctot); 
     let v_totdr = (v_totdr + v_desctotre); 


 end foreach;
 if v_imptot = 0  then
   let v_clave = -4; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO PARA ESTE PERIODO';
   return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_concepto1,v_concepto,v_imptot,v_periodo,0,0,0,0,0,'',v_control; 
 end if;
--Regresa los datos de encabezado
  --  execute procedure catastro_gdl:redondeocaja(v_imptot) into v_imptot, v_ajuste; 
    execute procedure db_ingresos:spd_redondeokiosco(v_imptot) into v_ctaaplaju, v_ajuste;
     let v_totdi = (v_totdi * -1); 
     let v_totdr = (v_totdr * -1);
     let v_imptot = v_imptot + v_ajuste;

 return 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_concepto1,v_concepto,v_imptot,v_periodo,v_totim,v_totre,
 v_totdi, v_totdr,v_ajuste,v_obs, v_control ; 

 end function;

CREATE FUNCTION "informix".kio13_totalx(var_control integer, var_axo int)
                 returning  char(1) as slinea, int as sclave, 
                 money(15,2) as stotal,  int as sctaapli,varchar(60)as sobserv;

define v_uap    integer;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_concepto varchar(250);
define  v_nomcem VARCHAR(60);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define  v_totim money(15,2);
define  v_totre money(15,2);
define  v_totimac money(15,2);
define  v_totreac money(15,2);

define v_cuenta integer;
define v_ctaapli integer;
define v_ctaapla integer;
define v_ctaaplr integer;
define v_ctadescto integer;
define v_ajuste money(15,2);
define v_ctaapl_act money(15,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define v_actualizacion  money(15,2);
define v_actualizaciontot  money(15,2);

--let var_axo = 2019;
let v_axo=year(today);
let v_mes=month(today);
--let v_mes=2;
let v_imptot=0;
let v_concepto = '';
let v_periodo='';
let v_desctot = 0;
let v_desctotre = 0;

let  v_totim=0;
let  v_totre=0;
let  v_totimac=0;
let  v_totreac=0;
let v_actualizacion = 0;
let v_actualizaciontot = 0;
--set debug file to 'kio13tot.log';
--trace on;
if var_axo = 0 then
 let var_axo = year(today);
end if;
select control_rcm, cementerio,axo_pagado
into v_control, v_cementerio,v_axo_pagado
from ta_13_datosrcm where control_rcm=var_control;

select  nombre, cta_aplicacion, cta_vencido, cta_descto,cta_actualizacion
into v_nomcem,v_ctaapl1,v_ctaapl2, v_ctadescto ,v_ctaapl_act
from tc_13_cementerios where cementerio=v_cementerio;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   let v_clave = -1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   return 'E',v_clave,0,0,v_texto; 
end if;      
if v_axo_pagado=v_axo  then
   let v_clave = -2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   return 'E',v_clave,0,0,v_texto; 
end if;     
if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;
let v_clave = 0; 

---Para calcular el importe total
foreach 
select b.axo_adeudo, case when b.axo_adeudo =year(today) then v_ctaapl1 
        else v_ctaapl2 end, b.importe, b.importe_recargos, b.descto_impote, b.descto_recargos,nvl(b.actualizacion,0)
        into vpar_axo,v_cuenta, vpar_impte, vpar_recar,v_impdesc,v_recardesc,v_actualizacion
        from ta_13_adeudosrcm b, ta_13_datosrcm r where r.control_rcm=v_control and
             b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and var_axo
        order by 1

     if ((v_mes >= 1)  and (v_mes <=2) and (v_cuenta=v_ctaapl1)) then
        if v_impdesc=0 then
           let vpar_impte  = vpar_impte-trunc(((vpar_impte) * 0.1),2);
        end if;
     end if;
     
     if vpar_axo<v_axo then
        let v_totim = (v_totim + vpar_impte); 
        let v_totre = (v_totre + vpar_recar); 
        let v_desctot = (v_desctot + v_impdesc); 
        let v_desctotre = (v_desctotre + v_recardesc); 
        let v_actualizaciontot = v_actualizaciontot + v_actualizacion;
        let v_ctaapli=v_cuenta;
     else   
        let v_totimac = (v_totimac + vpar_impte); 
        let v_totreac = (v_totreac + vpar_recar); 
        let v_desctot = (v_desctot + v_impdesc); 
        let v_desctotre = (v_desctotre + v_recardesc); 
        let v_actualizaciontot = v_actualizaciontot + v_actualizacion;
        let v_ctaapla=v_cuenta;
     end if;

  if vpar_axo=var_axo then
     if v_totim>0 then
        let v_obs = 'MANTENIMIENTO REZAGO ';
        let v_imptot = v_imptot + v_totim; 
         return 'D',v_clave, v_totim,v_ctaapli, v_obs with resume; 
     end if;   
     
    if v_totre>0 then
       let v_ctaaplr=390300000;
       let v_obs = 'RECARGOS ';
       let v_imptot = v_imptot + v_totre; 
       return 'D',v_clave, v_totre,v_ctaaplr, v_obs with resume; 
    end if;   

    if v_totimac>0 then
       let v_obs = 'MANTENIMIENTO ';
       let v_imptot = v_imptot + v_totimac; 
       return 'D',v_clave, vpar_impte, v_ctaapla, v_obs with resume;    
    end if;

    if v_totreac>0 then
       let v_ctaaplr=390300000;
       let v_obs = 'RECARGOS ';
       let v_imptot = v_imptot+v_totreac; 
      return 'D',v_clave, v_totreac,v_ctaaplr, v_obs with resume; 
    end if; 
    if v_desctot>0 then
       let v_ctaaplr=v_ctadescto;
       let v_obs = 'DESCTO MANT. ';
       let v_imptot = v_imptot-v_desctot; 
      return 'D',v_clave, (v_desctot*-1),v_ctaaplr, v_obs with resume; 
    end if; 
    if v_desctotre>0 then
       let v_ctaaplr=v_ctadescto;
       let v_obs = 'DESCTO RECARGOS ';
       let v_imptot = v_imptot+v_desctotre; 
      return 'D',v_clave, (v_desctotre*-1),v_ctaaplr, v_obs with resume; 
    end if; 

  if v_actualizaciontot <>0 then
       let v_obs = 'ACTUALIZACION ';
       let v_imptot = v_imptot+v_actualizaciontot; 
      return 'D',v_clave, v_actualizaciontot,v_ctaapl_act, v_obs with resume; 
  end if;

 end if; 
end foreach;

  

    execute procedure spd_redondeokiosco(v_imptot) into v_ctaaplr, v_ajuste; 
     if v_ajuste <> 0 then    
        return 'D',v_clave, v_ajuste, v_ctaaplr,'AJUSTE ARTICULO 14 LEY DE INGRESOS ' with resume; 
       let v_imptot = v_imptot+v_ajuste; 
     end if;
   return 'T',v_clave, v_imptot, 000000000,'TOTAL '; 
--trace off;
end function;

create procedure "pgcabrer".spd_11_genadeudos(pidlocal int,pmerc int,pcat int,psecc char(2),
psup decimal(6,2),pcuota int,palta date,puser int)

returning int as status, varchar(60) as mensaje;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_idlocal,v_idpolpre,v_idpoldev,v_idpolrec int;
define v_mescalc,v_axocalc,v_contade,v_mini,v_axomin,v_mesmin int;
define v_fecini,v_fecfin date;
define v_renta,v_recargos money(16,2);
define v_datosloc varchar(25);
define v_nommerc varchar(30);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1,'spd_11_genadeudos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let v_mescalc=0;

-- para sacar el a�o minimo
select  nvl(min(axo),0) into v_axomin from ta_11_adeudo_local where id_local=pidlocal;
-- para sacar el mes minimo       
select nvl(min(periodo),0) into v_mesmin from ta_11_adeudo_local where id_local=pidlocal and axo=v_axomin;

-- genera adeudos en base al primer adeudo � a fecha del parametro
if (v_axomin>0) and (v_mesmin>0) then
   let v_fecini=mdy(v_mesmin,1,v_axomin);
   let v_mescalc=v_mesmin;
   let v_axocalc=v_axomin;
else   
   let v_fecini=mdy(month(palta),1,year(palta));
   let v_mescalc=month(palta);
   let v_axocalc=year(palta);
end if;
let v_fecfin=mdy(12,1,year(today));
while v_fecini <= v_fecfin
    execute procedure spd_11_calc_renta(v_axocalc,pcat,psecc,pcuota,psup,pmerc,0) into v_renta;
--    if not exists (select * from ta_11_pagos_local where id_local=pidlocal and 
--               axo=v_axocalc and periodo=v_mescalc) then
      if ((not exists(select * from ta_11_pagos_local where id_local=pidlocal and axo=v_axocalc and periodo=v_mescalc)) and
         (not exists(select * from ta_11_ade_loc_canc where id_local=pidlocal and axo=v_axocalc and periodo=v_mescalc and
           clave_canc <>'T'))) then
       if exists (select * from ta_11_adeudo_local where id_local=pidlocal and 
                  axo=v_axocalc and periodo=v_mescalc) then
          update ta_11_adeudo_local set importe=v_renta,fecha_alta=current,id_usuario=puser 
                 where id_local=pidlocal and axo=v_axocalc and periodo=v_mescalc;
       else
          insert into ta_11_adeudo_local(id_adeudo_local,id_local,axo,periodo,importe,fecha_alta,id_usuario)
                 values(0,pidlocal,v_axocalc,v_mescalc,v_renta,current,puser);
       end if;
    end if;
    if  v_mescalc=12  then 
        let v_mescalc=1;
        let v_axocalc=v_axocalc + 1;
    else
        let v_mescalc=v_mescalc + 1;
    end if;
    let v_fecini=mdy(v_mescalc,1,v_axocalc);
end while;

return 0,'SE GENERARON CORRECTAMENTE LOS ADEUDOS';
end procedure;

create procedure "pgcabrer".spd_11_adeudomerc(paxo int,pmes int)
returning   int as merc,
            varchar(60) as nombre,
            int as locales,
            money(16,2) as adeudo;

define v_merc,v_locales,v_id int;
define v_nombre varchar(60);
define v_adeudo money(16,2);

foreach
select a.num_mercado,d.descripcion,nvl(count(distinct a.id_local),0),sum(b.importe)
into v_merc,v_nombre,v_locales,v_adeudo
from ta_11_locales a,ta_11_adeudo_local b,ta_11_mercados d
where a.vigencia='A' and d.tipo_emision<>'B'
and (b.axo<paxo  or (b.periodo<=pmes and b.axo=paxo)) 
and b.id_local=a.id_local and d.num_mercado_nvo=a.num_mercado
group by a.num_mercado,d.descripcion order by a.num_mercado

return v_merc,v_nombre,v_locales,v_adeudo with resume;
end foreach;
end procedure;

create PROCEDURE "informix".sp_exc_ade_anual( )
returning   int as no_exclusivo,
varchar(80) as propiestario,
varchar(100) as domicilio,
varchar(30)  as colonia,
char(2) as Zona,
Decimal(6,2) as Total_bateria,
Decimal(6,2) as Total_Cordon,
Decimal(5,2) as Factor,
Varchar(50) as Clasificacion,
int as axo_adeudo,
int as mes_ini_adeudo,
money(14,2) as adeudo_2009,
money(14,2) as recargos_2009,
money(14,2) as adeudo_2010,
money(14,2) as recargos_2010,
money(14,2) as adeudo_2011,
money(14,2) as recargos_2011,
money(14,2) as adeudo_2012,
money(14,2) as recargos_2012,
money(14,2) as adeudo_2013,
money(14,2) as recargos_2013,
money(14,2) as adeudo_2014,
money(14,2) as recargos_2014,
money(14,2) as adeudo_2015,
money(14,2) as recargos_2015,
money(14,2) as adeudo_2016,
money(14,2) as recargos_2016,
money(14,2) as adeudo_2017,
money(14,2) as recargos_2017,
money(14,2) as adeudo_2018,
money(14,2) as recargos_2018,
money(14,2) as adeudo_2019,
money(14,2) as recargos_2019,
money(14,2) as adeudo_2020,
money(14,2) as recargos_2020,
money(14,2) as adeudo_2021,
money(14,2) as recargos_2021,
money(14,2) as adeudo_recargos ;


define  v_id  int;
define  v_categoria_id int;
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_no_exclusivo int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_propietario varchar(100);

define v_domicilio varchar(80);
define v_colonia varchar(20);
define v_zona char(2) ;
define v_total_bateria decimal(6,2) ;
define v_total_cordon decimal(6,2) ;
define v_factor  decimal(5,2) ;
define v_clasificacion varchar(50);
define v_cupo int;
define v_axo_adeudo int;
define v_mes_ini_adeudo int;
define v_adeudo_2008 money(14,2);
define v_adeudo_2009 money(14,2);
define v_adeudo_2010 money(14,2);
define v_adeudo_2011 money(14,2);
define v_adeudo_2012 money(14,2);
define v_adeudo_2013 money(14,2);
define v_adeudo_2014 money(14,2);
define v_adeudo_2015 money(14,2);
define v_adeudo_2016 money(14,2);
define v_adeudo_2017 money(14,2);
define v_adeudo_2018 money(14,2);
define v_adeudo_2019 money(14,2);
define v_adeudo_2020 money(14,2);
define v_adeudo_2021 money(14,2);

define v_recgos_2008 money(14,2);
define v_recgos_2009 money(14,2);
define v_recgos_2010 money(14,2);
define v_recgos_2011 money(14,2);
define v_recgos_2012 money(14,2);
define v_recgos_2013 money(14,2);
define v_recgos_2014 money(14,2);
define v_recgos_2015 money(14,2);
define v_recgos_2016 money(14,2);
define v_recgos_2017 money(14,2);
define v_recgos_2018 money(14,2);
define v_recgos_2019 money(14,2);
define v_recgos_2020 money(14,2);
define v_recgos_2021 money(14,2);
define v_adeudo_recargos money(14,2);

FOREACH
select a.no_exclusivo , b.propietario, b.domicilio , b.colonia , a.zona, a.total_bateria, a.total_cordon, a.factor
, c.concepto ,
fn_exc_axomin(a.id) , fn_exc_mesmin(a.id)  ,

fn_exc_ade_axo(a.id,2009 ),
fn_exc_ade_axo(a.id,2010) ,
fn_exc_ade_axo(a.id,2011 ),
fn_exc_ade_axo(a.id,2012) ,
fn_exc_ade_axo(a.id,2013 ),
fn_exc_ade_axo(a.id,2014) ,
fn_exc_ade_axo(a.id,2015 ),
fn_exc_ade_axo(a.id,2016 ),
fn_exc_ade_axo(a.id,2017 ),
fn_exc_ade_axo(a.id,2018 ),
fn_exc_ade_axo(a.id,2019 ),
fn_exc_ade_axo(a.id,2020 ),
fn_exc_ade_axo(a.id,2021 ),

fn_exc_recargos_axo(a.id ,2009) ,
fn_exc_recargos_axo(a.id ,2010) ,
fn_exc_recargos_axo(a.id ,2011) ,
fn_exc_recargos_axo(a.id ,2012) ,
fn_exc_recargos_axo(a.id ,2013) ,
fn_exc_recargos_axo(a.id ,2014) ,
fn_exc_recargos_axo(a.id ,2015) ,
fn_exc_recargos_axo(a.id ,2016) ,
fn_exc_recargos_axo(a.id ,2017) ,
fn_exc_recargos_axo(a.id ,2018) ,
fn_exc_recargos_axo(a.id ,2019) ,
fn_exc_recargos_axo(a.id ,2020) ,
fn_exc_recargos_axo(a.id ,2021) ,
fn_exc_recargos(2 , a.id , year(today) , month(today))
into
v_no_exclusivo, v_propietario, v_domicilio, v_colonia, v_zona, v_total_bateria, v_total_cordon, v_factor, v_clasificacion ,v_axo_adeudo,v_mes_ini_adeudo,
v_adeudo_2009, v_adeudo_2010, v_adeudo_2011, v_adeudo_2012, v_adeudo_2013,
v_adeudo_2014, v_adeudo_2015, v_adeudo_2016, v_adeudo_2017, v_adeudo_2018,
v_adeudo_2019, v_adeudo_2020, v_adeudo_2021,
v_recgos_2009, v_recgos_2010, v_recgos_2011, v_recgos_2012, v_recgos_2013,
v_recgos_2014, v_recgos_2015, v_recgos_2016, v_recgos_2017, v_recgos_2018,
v_recgos_2019, v_recgos_2020, v_recgos_2021,
v_adeudo_recargos
from dbestacion:ex_contrato a, dbestacion:ex_propietario b , dbestacion:ex_clasificacion c
where  a.ex_propietario_id  = b.id
and a.estatus <> 'C' and a.id_clasificacion in ( 1,3 ) and c.id = a.id_clasificacion
and (fn_exc_ade_ant(a.id) + fn_exc_ade_act1(a.id)) > 0

RETURN  v_no_exclusivo, v_propietario, v_domicilio, v_colonia, v_zona, v_total_bateria, v_total_cordon, v_factor, v_clasificacion,
v_axo_adeudo,  v_mes_ini_adeudo,
v_adeudo_2009, v_recgos_2009, v_adeudo_2010, v_recgos_2010,
v_adeudo_2011, v_recgos_2011, v_adeudo_2012, v_recgos_2012,
v_adeudo_2013, v_recgos_2013, v_adeudo_2014, v_recgos_2014,
v_adeudo_2015, v_recgos_2015, v_adeudo_2016, v_recgos_2016,
v_adeudo_2017, v_recgos_2017, v_adeudo_2018, v_recgos_2018,
v_adeudo_2019, v_recgos_2019, v_adeudo_2020, v_recgos_2020, 
v_adeudo_2021, v_recgos_2021, v_adeudo_recargos with resume;

END FOREACH;
--return 0 , 'Fin archivo', '' , '' ,'', 0, 0, 0, '' , 0 ,  0 ,  ,0,0, 0 , 0 , 0;
end procedure;

create procedure "informix".sp_pub_ade_anual ( )
returning int as numesta, varchar(100) as nombre, char(2) as categoria, varchar(80) as descripcion,
char(1) as sector, varchar(10) as sectornom, varchar(100) as calle,
varchar(10) as numext, int as Cajones, int as axo_adeudo, int as mes_ini_adeudo,
money(14,2) as adeudo_2008, money(14,2) as recargos_2008,
money(14,2) as adeudo_2009, money(14,2) as recargos_2009,
money(14,2) as adeudo_2010, money(14,2) as recargos_2010,
money(14,2) as adeudo_2011, money(14,2) as recargos_2011,
money(14,2) as adeudo_2012, money(14,2) as recargos_2012,
money(14,2) as adeudo_2013, money(14,2) as recargos_2013,
money(14,2) as adeudo_2014, money(14,2) as recargos_2014,
money(14,2) as adeudo_2015, money(14,2) as recargos_2015,
money(14,2) as adeudo_2016, money(14,2) as recargos_2016,
money(14,2) as adeudo_2017, money(14,2) as recargos_2017,
money(14,2) as adeudo_2018, money(14,2) as recargos_2018,
money(14,2) as adeudo_2019, money(14,2) as recargos_2019,
money(14,2) as adeudo_2020, money(14,2) as recargos_2020,
money(14,2) as adeudo_2021, money(14,2) as recargos_2021,
money(14,2) as recargos;
  --money(12,2) as adeudo_act ;

define  v_id  int;
define  v_categoria_id int;
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_numesta int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_nombre varchar(100);

define v_calle varchar(80);
define v_numext varchar(10);
define v_cupo int;
define v_axo_adeudo int;
define v_mes_ini_adeudo int;

define v_adeudo_2008 money(14,2);
define v_adeudo_2009 money(14,2);
define v_adeudo_2010 money(14,2);
define v_adeudo_2011 money(14,2);
define v_adeudo_2012 money(14,2);
define v_adeudo_2013 money(14,2);
define v_adeudo_2014 money(14,2);
define v_adeudo_2015 money(14,2);
define v_adeudo_2016 money(14,2);
define v_adeudo_2017 money(14,2);
define v_adeudo_2018 money(14,2);
define v_adeudo_2019 money(14,2);
define v_adeudo_2020 money(14,2);
define v_adeudo_2021 money(14,2);

define v_recgos_2008 money(14,2);
define v_recgos_2009 money(14,2);
define v_recgos_2010 money(14,2);
define v_recgos_2011 money(14,2);
define v_recgos_2012 money(14,2);
define v_recgos_2013 money(14,2);
define v_recgos_2014 money(14,2);
define v_recgos_2015 money(14,2);
define v_recgos_2016 money(14,2);
define v_recgos_2017 money(14,2);
define v_recgos_2018 money(14,2);
define v_recgos_2019 money(14,2);
define v_recgos_2020 money(14,2);
define v_recgos_2021 money(14,2);

define v_adeudo_recgos money(14,2);

--set debug file to 'pub.log';
--trace on;

foreach
select  a.id, a.pubcategoria_id, b.categoria, b.descripcion, a.numesta, a.sector,
    case when sector = 'J' then 'JUAREZ'  when sector = 'H' then 'HIDALGO'
    when sector = 'L' then 'LIBERTAD'  when sector = 'R' then 'REFORMA' else 'S/N' end ,
    trim(a.nombre), trim(a.calle), trim(a.numext), a.cupo,
    (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ,
    (select min(d.mes) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10  and
    axo = (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ) ,

    dbestacion:fn_pub_ade_axo(a.id ,2008) ,
    dbestacion:fn_pub_ade_axo(a.id ,2009) ,
    dbestacion:fn_pub_ade_axo(a.id ,2010) ,
    dbestacion:fn_pub_ade_axo(a.id ,2011) ,
    dbestacion:fn_pub_ade_axo(a.id ,2012) ,
    dbestacion:fn_pub_ade_axo(a.id ,2013) ,
    dbestacion:fn_pub_ade_axo(a.id ,2014) ,
    dbestacion:fn_pub_ade_axo(a.id ,2015) ,
    dbestacion:fn_pub_ade_axo(a.id ,2016) ,
    dbestacion:fn_pub_ade_axo(a.id ,2017) ,
    dbestacion:fn_pub_ade_axo(a.id ,2018) ,
dbestacion:fn_pub_ade_axo(a.id ,2019) ,
dbestacion:fn_pub_ade_axo(a.id ,2020) ,
dbestacion:fn_pub_ade_axo(a.id ,2021) ,

    dbestacion:fn_pub_recargos_axo(a.id ,2008) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2009) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2010) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2011) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2012) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2013) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2014) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2015) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2016) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2017) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2018) ,
dbestacion:fn_pub_recargos_axo(a.id ,2019) ,
dbestacion:fn_pub_recargos_axo(a.id ,2020) ,
dbestacion:fn_pub_recargos_axo(a.id ,2021) ,

    dbestacion:fn_pub_recargos(2 , a.id, year(today) , month(today) )

into v_id, v_categoria_id, v_categoria, v_descripcion, v_numesta, v_sector, v_sectornom, v_nombre, v_calle, v_numext, v_cupo, v_axo_adeudo, v_mes_ini_adeudo,
v_adeudo_2008, v_adeudo_2009, v_adeudo_2010, v_adeudo_2011,
v_adeudo_2012, v_adeudo_2013, v_adeudo_2014, v_adeudo_2015,
v_adeudo_2016, v_adeudo_2017, v_adeudo_2018, v_adeudo_2019,
v_adeudo_2020,v_adeudo_2021,

v_recgos_2008, v_recgos_2009, v_recgos_2010, v_recgos_2011,
v_recgos_2012, v_recgos_2013, v_recgos_2014, v_recgos_2015,
v_recgos_2016, v_recgos_2017, v_recgos_2018, v_recgos_2019,
v_recgos_2020,v_recgos_2021,
v_adeudo_recgos
from dbestacion:pubmain a, dbestacion:pubcategoria b
    where  b.id =  a.pubcategoria_id and a.movto_cve <> 'C'
--  and (fn_pub_ade_ant(a.id) + fn_pub_ade_act1( a.id ) ) > 0
        order by a.numesta

return   v_numesta, v_nombre, v_categoria, v_descripcion, v_sector, v_sectornom, v_calle, v_numext, v_cupo, v_axo_adeudo, v_mes_ini_adeudo,
v_adeudo_2008, v_recgos_2008,
v_adeudo_2009, v_recgos_2009,
v_adeudo_2010, v_recgos_2010,
v_adeudo_2011, v_recgos_2011,
v_adeudo_2012, v_recgos_2012,
v_adeudo_2013, v_recgos_2013,
v_adeudo_2014, v_recgos_2014,
v_adeudo_2015, v_recgos_2015,
v_adeudo_2016, v_recgos_2016,
v_adeudo_2017, v_recgos_2017,
v_adeudo_2018, v_recgos_2018,
    v_adeudo_2019, v_recgos_2019,
    v_adeudo_2020, v_recgos_2020,
    v_adeudo_2021, v_recgos_2021,
v_adeudo_recgos with resume;

end foreach;
--trace off;
end procedure;

CREATE PROCEDURE "informix".con16_detade_05 ( p_Control_contrato Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
returning Money(12,2),    -- ADEUDOS 2007
Money(12,2),    -- RECARGOS 2007
Money(12,2),    -- ADEUDOS 2008
Money(12,2),    -- RECARGOS 2008
Money(12,2),    -- ADEUDOS 2009
Money(12,2),    -- RECARGOS 2009
Money(12,2),    -- ADEUDOS 2010
Money(12,2),    -- RECARGOS2010
Money(12,2),    -- ADEUDOS 2011
Money(12,2),    -- RECARGOS 2011
Money(12,2),    -- ADEUDOS 2012
Money(12,2),    -- RECARGOS 2012
Money(12,2),    -- ADEUDOS 2013
Money(12,2),    -- RECARGOS 2013
Money(12,2),    -- ADEUDOS 2014
Money(12,2),    -- RECARGOS 2014
Money(12,2),    -- ADEUDOS 2015
Money(12,2),    -- RECARGOS 2015
Money(12,2),    -- ADEUDOS 2016
Money(12,2),    -- RECARGOS 2016
Money(12,2),    -- ADEUDOS 2017
Money(12,2),    -- RECARGOS 2017
Money(12,2),    -- ADEUDOS 2018
Money(12,2),    -- RECARGOS 2018
Money(12,2),    -- ADEUDOS 2019
Money(12,2),    -- RECARGOS 2019
Money(12,2),    -- ADEUDOS 2020
Money(12,2),    -- RECARGOS 2020
Money(12,2),    -- ADEUDOS 2021
Money(12,2),    -- RECARGOS 2021
Money(12,2),    -- Importe Multa
Money(12,2),    -- Importe Gastos
varchar(255);     -- Documentos
               

{
#  Procedimiento: Con16_detade_05
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#                                      Importe : El importe de los Adeudos desde 2007 hasta 2013
#                                      Importe : El importe de los Recargos desde 2007 hasta 2013
#                                      Importe : El importe de la Multa
#                                      Importe : El importe de los Gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico:
#  Fecha Modificaci�n :
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                                    Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq                                                                   Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos                                                    Money(12,2);
  define v_DetFolReq                                                                                                  varchar(120);
  define v_diligencia                                                                                                                     char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago                                                                                                        Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2                                 Money(12,2);
  define v_Mes                                                                                                               varchar(2);

  define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato                                                      Integer;
  define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato                                      varchar(120);

       define v_Importe_recargo, v_TotRecargos, v_Reg_1                                                           Money(12,2);
       define v_mensaje_proc                                                                                                     varchar(255);
  define v_totAdeudos2007, v_TotRecargos2007         Money(12,2);
  define v_totAdeudos2008, v_TotRecargos2008         Money(12,2);
  define v_totAdeudos2009, v_TotRecargos2009         Money(12,2);
  define v_totAdeudos2010, v_TotRecargos2010         Money(12,2);
  define v_totAdeudos2011, v_TotRecargos2011         Money(12,2);
  define v_totAdeudos2012, v_TotRecargos2012         Money(12,2);
  define v_totAdeudos2013, v_TotRecargos2013         Money(12,2);
  define v_totAdeudos2014, v_TotRecargos2014         Money(12,2);
  define v_totAdeudos2015, v_TotRecargos2015         Money(12,2);
  define v_totAdeudos2016, v_TotRecargos2016         Money(12,2);
  define v_totAdeudos2017, v_TotRecargos2017         Money(12,2);
  define v_totAdeudos2018, v_TotRecargos2018         Money(12,2);
  define v_totAdeudos2019, v_TotRecargos2019         Money(12,2);
  define v_totAdeudos2020, v_TotRecargos2020         Money(12,2);
  define v_totAdeudos2021, v_TotRecargos2021         Money(12,2);

--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade   varchar(7);
  define v_Periodo                                                                                                                       varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo                                                                           Integer;
--******************************************************************************************************************************
   Let v_Contador = 0;

LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_totAdeudos2016 = 0;
LET v_TotRecargos2016 = 0;
LET v_totAdeudos2017 = 0;
LET v_TotRecargos2017 = 0;
LET v_totAdeudos2018 = 0;
LET v_TotRecargos2018 = 0;
LET v_totAdeudos2019 = 0;
LET v_TotRecargos2019 = 0;
LET v_totAdeudos2020 = 0;
LET v_TotRecargos2020 = 0;
LET v_totAdeudos2021 = 0;
LET v_TotRecargos2021 = 0;

Let v_Detalle_T = ' ';
Let v_importe = 0;
Let v_Importe_recargo = 0;
Let v_totAdeudos = 0;
Let v_TotRecargos = 0;
Let v_importe_rec1 = 0;
Let v_importe_rec2 = 0;
Let v_axo = 0;
Let v_Lineas_Dato = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;  

Let v_tot_gastos = 0;
Let v_importe_multa = 0;
Let v_importe_gastos = 0;
Let v_FolReq = 0;
Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
foreach
Select id_control,   folio,            diligencia,      importe_multa,     importe_gastos
Into v_id_control, v_folio_req, v_diligencia, v_importe_multa, v_importe_gastos
from ta_15_apremios
Where modulo = 16  And control_otr = p_Control_contrato
And vigencia = "1" and clave_practicado = "P"
Order By id_control

Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
if v_FolReq > 0 then
Let v_DetFolReq = v_DetFolReq || ',' || v_diligencia || '-' || v_folio_req;
else
    Let v_DetFolReq = v_DetFolReq || v_diligencia || '-' || v_folio_req;
    Let v_FolReq = v_FolReq + 1;
end if;
end foreach;
-- if v_FolReq > 0 then
--      return v_DetFolReq, Null, Null, v_importe_multa, v_tot_gastos  with resume;
--          Let v_Contador = v_Contador + 1;
-- end if;

Let v_Lineas_Dato = 0;
Let v_Detalle_Dato = '';
Select ('Descuento de Recargos en periodo(s) del ' || axoinicio || '-' || mesinicio ||
' al ' || axofin || '-' || mesfin || ' por el ' || porcentaje || ' %'),
(axoinicio || '-' || mesinicio), axofin || '-' || mesfin, porcentaje
INTO v_Detalle_Dato, v_Periodo_Inicio, v_Periodo_fin, v_porc
from ta_16_descrec
Where id_contrato = p_Control_contrato and vigencia = 'V';

if v_Detalle_Dato <> '' then
Let v_Lineas_Dato = v_Lineas_Dato + 1;
end if;

Let aso_proceso = 0;
Let aso_actual = Year(Current);

FOR aso_proceso = 2007 to aso_actual
--- CONSULTA DE CUOTA NORMAL
Let v_Lineas_CN = 0;
    Let v_Detalle_CN = ' C.N. Mes(s) --';

    foreach
    Select Year(h.aso_mes_pago), h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago)
    Into v_axo, v_aso_mes_pago, v_importe, v_Mes
    From ta_16_pagos H
    Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion = 6
    and H.aso_mes_pago <= ( p_Fecha_fin )
    and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
    Order By h.aso_mes_pago

    if v_importe > 0 then
--if v_aso_mes_pago > ( p_Fecha_fin ) then
        --             Let v_importe = 0;
        --else
        Select sum(porc_recargo)
        Into v_Importe_recargo
        From ta_16_recargos
        Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_CN);
        --end if;
    end if;

    if v_importe > 0 then
if v_Lineas_CN > 0 then
Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
        else
Let v_Detalle_CN = v_Detalle_CN||v_Mes;
        end if;
        Let v_totAdeudos = v_totAdeudos + v_importe;
        Let v_Lineas_CN = v_Lineas_CN + 1;
        if v_Importe_recargo <> 0 then
Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
            EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
            if v_importe_rec2 > 0 then
Let v_TotRecargos = v_TotRecargos + (v_importe_rec1 - v_importe_rec2);  -- modificado de sumando a restando
                Let v_Lineas_Dato = v_Lineas_Dato + 1;
            else
Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
end if;
        end if;
        Let v_Contador = v_Contador + 1;
    end if;

    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    end foreach;

    --- CONSULTA DE EXEDENCIAS
    Let v_Lineas_EX = 0;
    Let v_Detalle_EX = ' EXE. Mes(s) --';

    foreach
    Select h.aso_mes_pago,  h.importe, Month(h.aso_mes_pago)
    Into v_aso_mes_pago, v_importe, v_Mes
    From ta_16_pagos H
    Where H.Control_Contrato = p_Control_contrato and H.Ctrol_Operacion <> 6
    and H.aso_mes_pago <= ( p_Fecha_fin )
    and H.Status_Vigencia = 'V' and Year(h.aso_mes_pago) = aso_proceso
    Order By h.aso_mes_pago

    if v_importe > 0 then
--if v_aso_mes_pago > ( p_Fecha_fin ) then
        --             Let v_importe = 0;
        --else
        Select sum(porc_recargo)
        Into v_Importe_recargo
        From ta_16_recargos
        Where aso_mes_recargo between (v_aso_mes_pago) and (v_Periodo_EXE);
        --end if;
    end if;

    if v_importe > 0 then
if v_Lineas_EX > 0 then
Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
        else
Let v_Detalle_EX = v_Detalle_EX||v_Mes;
        end if;
        Let v_totAdeudos = v_totAdeudos + v_importe;
        Let v_Lineas_EX = v_Lineas_EX + 1;
        if v_Importe_recargo <> 0 then
Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
            EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
            if v_importe_rec2 > 0 then
Let v_TotRecargos = v_TotRecargos + (v_importe_rec1 - v_importe_rec2);  -- modificado de sumando a restando
                Let v_Lineas_Dato = v_Lineas_Dato + 1;
            else
Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
            end if;
        end if;
        Let v_Contador = v_Contador + 1;
    end if;

    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    end foreach;

--     Grabando registro

    if aso_proceso = 2007 then
          Let v_totAdeudos2007 = v_totAdeudos;
          Let v_TotRecargos2007 = v_TotRecargos;
    end if;
    if aso_proceso = 2008 then
          Let v_totAdeudos2008 = v_totAdeudos;
          Let v_TotRecargos2008 = v_TotRecargos;
    end if;
    if aso_proceso = 2009 then
          Let v_totAdeudos2009 = v_totAdeudos;
          Let v_TotRecargos2009 = v_TotRecargos;
    end if;
    if aso_proceso = 2010 then
          Let v_totAdeudos2010 = v_totAdeudos;
          Let v_TotRecargos2010 = v_TotRecargos;
    end if;
    if aso_proceso = 2011 then
          Let v_totAdeudos2011 = v_totAdeudos;
          Let v_TotRecargos2011 = v_TotRecargos;
    end if;
    if aso_proceso = 2012 then
          Let v_totAdeudos2012 = v_totAdeudos;
          Let v_TotRecargos2012 = v_TotRecargos;
    end if;
    if aso_proceso = 2013 then
          Let v_totAdeudos2013 = v_totAdeudos;
          Let v_TotRecargos2013 = v_TotRecargos;
    end if;
    if aso_proceso = 2014 then
          Let v_totAdeudos2014 = v_totAdeudos;
          Let v_TotRecargos2014 = v_TotRecargos;
    end if;
    if aso_proceso = 2015 then
          Let v_totAdeudos2015 = v_totAdeudos;
          Let v_TotRecargos2015 = v_TotRecargos;
    end if;
    if aso_proceso = 2016 then
          Let v_totAdeudos2016 = v_totAdeudos;
          Let v_TotRecargos2016 = v_TotRecargos;
    end if;
    if aso_proceso = 2017 then
          Let v_totAdeudos2017 = v_totAdeudos;
          Let v_TotRecargos2017 = v_TotRecargos;
    end if;
    if aso_proceso = 2018 then
          Let v_totAdeudos2018 = v_totAdeudos;
          Let v_TotRecargos2018 = v_TotRecargos;
    end if;
if aso_proceso = 2019 then
          Let v_totAdeudos2019 = v_totAdeudos;
          Let v_TotRecargos2019 = v_TotRecargos;
    end if;
if aso_proceso = 2020 then
          Let v_totAdeudos2020 = v_totAdeudos;
          Let v_TotRecargos2020 = v_TotRecargos;
    end if;
if aso_proceso = 2021 then
          Let v_totAdeudos2021 = v_totAdeudos;
          Let v_TotRecargos2021 = v_TotRecargos;
    end if;

Let v_totAdeudos = 0;
Let v_TotRecargos = 0;

END FOR;

Return v_totAdeudos2007, v_TotRecargos2007,
            v_totAdeudos2008, v_TotRecargos2008,
            v_totAdeudos2009, v_TotRecargos2009,
            v_totAdeudos2010, v_TotRecargos2010,
            v_totAdeudos2011, v_TotRecargos2011,
            v_totAdeudos2012, v_TotRecargos2012,
            v_totAdeudos2013, v_TotRecargos2013,
            v_totAdeudos2014, v_TotRecargos2014,
            v_totAdeudos2015, v_TotRecargos2015,
            v_totAdeudos2016, v_TotRecargos2016,
            v_totAdeudos2017, v_TotRecargos2017,
            v_totAdeudos2018, v_TotRecargos2018,
            v_totAdeudos2019, v_TotRecargos2019,
            v_totAdeudos2020, v_TotRecargos2020,
            v_totAdeudos2021, v_TotRecargos2021,
            v_importe_multa, v_tot_gastos, v_DetFolReq   with resume;
end procedure;

CREATE PROCEDURE "informix".con16_detcont_03ex ( p_Ctrol_aseo Integer)
RETURNING CHAR(2) as OFNA,               -- RECAUDADORA
VARCHAR(20) as TIPO_ASEO,    -- TIPO DE ASEO
INTEGER as NUM_CONTRATO,              -- NUMERO DE CONTRATO
VARCHAR(200) as NOM_EMPRESA,                 -- A NOMBRE DE QUIEN ESTA EL CONTRATO
VARCHAR(200) as DOMICILIO,                 -- DOMICILIO
CHAR(2) as VIGENCIA,               -- VIGENCIA   HASTA AQUI DATOS DEL CONTRATO

Money(12,2) as ADEUDOS_2007,    -- ADEUDOS 2007
Money(12,2) as RECARGOS_2007,    -- RECARGOS 2007
Money(12,2) as ADEUDOS_2008,    -- ADEUDOS 2008
Money(12,2) as RECARGOS_2008,    -- RECARGOS 2008
Money(12,2) as ADEUDOS_2009,    -- ADEUDOS 2009
Money(12,2) as RECARGOS_2009,    -- RECARGOS 2009
Money(12,2) as ADEUDOS_2010,    -- ADEUDOS 2010
Money(12,2) as RECARGOS_2010,    -- RECARGOS2010
Money(12,2) as ADEUDOS_2011,    -- ADEUDOS 2011
Money(12,2) as RECARGOS_2011,    -- RECARGOS 2011
Money(12,2) as ADEUDOS_2012,    -- ADEUDOS 2012
Money(12,2) as RECARGOS_2012,    -- RECARGOS 2012
Money(12,2) as ADEUDOS_2013,    -- ADEUDOS 2013
Money(12,2) as RECARGOS_2013,    -- RECARGOS 2013
Money(12,2) as ADEUDOS_2014,    -- ADEUDOS 2014
Money(12,2) as RECARGOS_2014,    -- RECARGOS 2014
Money(12,2) as ADEUDOS_2015,    -- ADEUDOS 2015
Money(12,2) as RECARGOS_2015,    -- RECARGOS 2015
Money(12,2) as ADEUDOS_2016,    -- ADEUDOS 2016
Money(12,2) as RECARGOS_2016,    -- RECARGOS 2016
Money(12,2) as ADEUDOS_2017,    -- ADEUDOS 2017
Money(12,2) as RECARGOS_2017,    -- RECARGOS 2017
Money(12,2) as ADEUDOS_2018,    -- ADEUDOS 2018
Money(12,2) as RECARGOS_2018,    -- RECARGOS 2018
Money(12,2) as ADEUDOS_2019,    -- ADEUDOS 2019
Money(12,2) as RECARGOS_2019,    -- RECARGOS 2019
Money(12,2) as ADEUDOS_2020,    -- ADEUDOS 2020
Money(12,2) as RECARGOS_2020,    -- RECARGOS 2020
Money(12,2) as ADEUDOS_2021,    -- ADEUDOS 2021
Money(12,2) as RECARGOS_2021,    -- RECARGOS 2021
Money(12,2) as GASTOS,    -- TOTAL DE GASTOS
Money(12,2) as MULTAS,    -- TOTAL DE MULTAS

varchar(255) as DATOS_DOCTOS;      -- DATOS DE REQUERIMIENTOS

{
#  Procedimiento: Con16_F4DetCont
#  Descripcion:  Genera una consulta del Contrato con control de importe
#  Parametros de entrada: p_Mod : Caracteres de identificacion del Modulo
#                                        p_Control_contrato : id de busqueda del Contrato
#                                        p_Control_adeudo : solo imprime si existe contrato
#  Parametros de salida:   todos los datos del contrato
#  Elaboro:    c. Gilberto Moreno
#  Modifico:
#  Fecha Modificaci�n :
}

  define v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_cantidad_recolec, v_id_rec      Integer;
  define v_nombre, v_domicilio               , v_tipo_aseo   varchar(80);
  define v_tipo_recolec    varchar(20);
  define v_sector, v_status_vigencia   Char(1);
  define v_fecha_ini, v_fecha_hora_baja  Date;

  define v_importe_multa, v_importe_gastos, v_tot_gastos   Money(12,2);
  define v_totAdeudos2007, v_TotRecargos2007         Money(12,2);
  define v_totAdeudos2008, v_TotRecargos2008         Money(12,2);
  define v_totAdeudos2009, v_TotRecargos2009         Money(12,2);
  define v_totAdeudos2010, v_TotRecargos2010         Money(12,2);
  define v_totAdeudos2011, v_TotRecargos2011         Money(12,2);
  define v_totAdeudos2012, v_TotRecargos2012         Money(12,2);
  define v_totAdeudos2013, v_TotRecargos2013         Money(12,2);
  define v_totAdeudos2014, v_TotRecargos2014         Money(12,2);
  define v_totAdeudos2015, v_TotRecargos2015         Money(12,2);
  define v_totAdeudos2016, v_TotRecargos2016         Money(12,2);
  define v_totAdeudos2017, v_TotRecargos2017         Money(12,2);
  define v_totAdeudos2018, v_TotRecargos2018         Money(12,2);
  define v_totAdeudos2019, v_TotRecargos2019         Money(12,2);
  define v_totAdeudos2020, v_TotRecargos2020         Money(12,2);
  define v_totAdeudos2021, v_TotRecargos2021         Money(12,2);
  define v_Datos   varchar(255);                                                                                                                                        
  define p_Adeudos Char(1);
  define p_Rep Char(1) ;
  define  p_Fecha_fin Char(7);
  define  v_mes  char(3);
  define  vmesst char(2);

----------------------
let p_adeudos = 'T';
let p_rep = 'V';

let v_mes = '' || (100 + month(today));
let vmesst = SUBSTR (v_mes,2,2);
let p_fecha_fin = year(today) || '-' ||  vmesst  ;
Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_totAdeudos2016 = 0;
LET v_TotRecargos2016 = 0;
LET v_totAdeudos2017 = 0;
LET v_TotRecargos2017 = 0;
LET v_totAdeudos2018 = 0;
LET v_TotRecargos2018 = 0;
LET v_totAdeudos2019 = 0;
LET v_TotRecargos2019 = 0;
LET v_totAdeudos2020 = 0;
LET v_TotRecargos2020 = 0;
LET v_totAdeudos2021 = 0;
LET v_TotRecargos2021 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;
LET v_Datos = '';

FOREACH
       Select a.control_contrato, a.num_contrato, a.ctrol_aseo, b.descripcion, c.descripcion, a.domicilio, a.cantidad_recolec, d.descripcion,
                  a.sector, a.id_rec, a.aso_mes_oblig, a.fecha_hora_baja, a.status_vigencia
          Into  v_Control, v_Num_Contrato, v_Ctrol_Aseo, v_tipo_aseo, v_nombre, v_domicilio, v_cantidad_recolec, v_tipo_recolec,
                  v_sector, v_id_rec, v_fecha_ini, v_fecha_hora_baja, v_status_vigencia
       From ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_unidades d
       Where a.ctrol_aseo = p_Ctrol_aseo      
       and b.ctrol_aseo = a.ctrol_aseo
       and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
       and d.ctrol_recolec = a.ctrol_recolec
       Order by a.num_contrato
       
     FOREACH
                EXECUTE PROCEDURE con16_detade_05 ( v_Control, p_Rep, p_Fecha_fin)
                               INTO v_totAdeudos2007, v_TotRecargos2007,
                                               v_totAdeudos2008, v_TotRecargos2008,
                                               v_totAdeudos2009, v_TotRecargos2009,
                                               v_totAdeudos2010, v_TotRecargos2010,
                                               v_totAdeudos2011, v_TotRecargos2011,
                                               v_totAdeudos2012, v_TotRecargos2012,
                                               v_totAdeudos2013, v_TotRecargos2013,
                                               v_totAdeudos2014, v_TotRecargos2014,
                                               v_totAdeudos2015, v_TotRecargos2015,
                                               v_totAdeudos2016, v_TotRecargos2016,
                                               v_totAdeudos2017, v_TotRecargos2017,
                                               v_totAdeudos2018, v_TotRecargos2018,
                                               v_totAdeudos2019, v_TotRecargos2019,
                                               v_totAdeudos2020, v_TotRecargos2020,
                                               v_totAdeudos2021, v_TotRecargos2021,
                                               v_importe_multa, v_tot_gastos, v_Datos
     END FOREACH;

IF p_Adeudos = 'S' THEN  -- CON ADEUDO ALGUNO
  IF (v_totAdeudos2007 <> 0 or v_TotRecargos2007 <> 0 or
       v_totAdeudos2008 <> 0 or v_TotRecargos2008 <> 0 or
       v_totAdeudos2009 <> 0 or v_TotRecargos2009 <> 0 or
       v_totAdeudos2010 <> 0 or v_TotRecargos2010 <> 0 or
       v_totAdeudos2011 <> 0 or v_TotRecargos2011 <> 0 or
       v_totAdeudos2012 <> 0 or v_TotRecargos2012 <> 0 or
       v_totAdeudos2013 <> 0 or v_TotRecargos2013 <> 0 or
       v_totAdeudos2014 <> 0 or v_TotRecargos2014 <> 0 or
       v_totAdeudos2015 <> 0 or v_TotRecargos2015 <> 0 or
       v_totAdeudos2016 <> 0 or v_TotRecargos2016 <> 0 or
       v_totAdeudos2017 <> 0 or v_TotRecargos2017 <> 0 or
       v_totAdeudos2018 <> 0 or v_TotRecargos2018 <> 0 or
       v_totAdeudos2019 <> 0 or v_TotRecargos2019 <> 0 or
       v_totAdeudos2020 <> 0 or v_TotRecargos2020 <> 0 or
       v_totAdeudos2021 <> 0 or v_TotRecargos2021 <> 0 or
       v_importe_multa <> 0 or v_tot_gastos <> 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia,
                v_totAdeudos2007, v_TotRecargos2007,
                v_totAdeudos2008, v_TotRecargos2008,
                v_totAdeudos2009, v_TotRecargos2009,
                v_totAdeudos2010, v_TotRecargos2010,
                v_totAdeudos2011, v_TotRecargos2011,
                v_totAdeudos2012, v_TotRecargos2012,
                v_totAdeudos2013, v_TotRecargos2013,
                v_totAdeudos2014, v_TotRecargos2014,
                v_totAdeudos2015, v_TotRecargos2015,
                v_totAdeudos2016, v_TotRecargos2016,
                v_totAdeudos2017, v_TotRecargos2017,
                v_totAdeudos2018, v_TotRecargos2018,
                v_totAdeudos2019, v_TotRecargos2019,
                v_totAdeudos2020, v_TotRecargos2020,
                v_totAdeudos2021, v_TotRecargos2021,
                v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'R' THEN  -- CON SOLO ADEUDOS DE PERIODOS Y REQUERIMIENTOS EN CEROS
  IF ((v_totAdeudos2007 <> 0) or (v_TotRecargos2007 <> 0) or
       (v_totAdeudos2008 <> 0) or (v_TotRecargos2008 <> 0) or
       (v_totAdeudos2009 <> 0) or (v_TotRecargos2009 <> 0) or
       (v_totAdeudos2010 <> 0) or (v_TotRecargos2010 <> 0) or
       (v_totAdeudos2011 <> 0) or (v_TotRecargos2011 <> 0) or
       (v_totAdeudos2012 <> 0) or (v_TotRecargos2012 <> 0) or
       (v_totAdeudos2013 <> 0) or (v_TotRecargos2013 <> 0) or
       (v_totAdeudos2014 <> 0) or (v_TotRecargos2014 <> 0) or
       (v_totAdeudos2015 <> 0) or (v_TotRecargos2015 <> 0) or
       (v_totAdeudos2016 <> 0) or (v_TotRecargos2016 <> 0) or
       (v_totAdeudos2017 <> 0) or (v_TotRecargos2017 <> 0) or
       (v_totAdeudos2018 <> 0) or (v_TotRecargos2018 <> 0) or
       (v_totAdeudos2019 <> 0) or (v_TotRecargos2019 <> 0) or
       (v_totAdeudos2020 <> 0) or (v_TotRecargos2020 <> 0) or
       (v_totAdeudos2021 <> 0) or (v_TotRecargos2021 <> 0)
       ) AND
       ( v_importe_multa = 0 AND v_tot_gastos = 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia,
                v_totAdeudos2007, v_TotRecargos2007,
                v_totAdeudos2008, v_TotRecargos2008,
                v_totAdeudos2009, v_TotRecargos2009,
                v_totAdeudos2010, v_TotRecargos2010,
                v_totAdeudos2011, v_TotRecargos2011,
                v_totAdeudos2012, v_TotRecargos2012,
                v_totAdeudos2013, v_TotRecargos2013,
                v_totAdeudos2014, v_TotRecargos2014,
                v_totAdeudos2015, v_TotRecargos2015,
                v_totAdeudos2016, v_TotRecargos2016,
                v_totAdeudos2017, v_TotRecargos2017,
                v_totAdeudos2018, v_TotRecargos2018,
                v_totAdeudos2019, v_TotRecargos2019,
                v_totAdeudos2020, v_TotRecargos2020,
                v_totAdeudos2021, v_TotRecargos2021,
                v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'U' THEN  -- CON SOLO ADEUDOS DE REQUERIMIENTOS Y PERIODOS EN CEROS
  IF (v_totAdeudos2007 = 0 AND v_TotRecargos2007 = 0 AND
       v_totAdeudos2008 = 0 AND v_TotRecargos2008 = 0 AND
       v_totAdeudos2009 = 0 AND v_TotRecargos2009 = 0 AND
       v_totAdeudos2010 = 0 AND v_TotRecargos2010 = 0 AND
       v_totAdeudos2011 = 0 AND v_TotRecargos2011 = 0 AND
       v_totAdeudos2012 = 0 AND v_TotRecargos2012 = 0 AND
       v_totAdeudos2013 = 0 AND v_TotRecargos2013 = 0 AND
       v_totAdeudos2014 = 0 AND v_TotRecargos2014 = 0 AND
       v_totAdeudos2015 = 0 AND v_TotRecargos2015 = 0 AND
       v_totAdeudos2016 = 0 AND v_TotRecargos2016 = 0 AND
       v_totAdeudos2017 = 0 AND v_TotRecargos2017 = 0 AND
       v_totAdeudos2018 = 0 AND v_TotRecargos2018 = 0 AND
       v_totAdeudos2019 = 0 AND v_TotRecargos2019 = 0 AND
       v_totAdeudos2020 = 0 AND v_TotRecargos2020 = 0 AND
       v_totAdeudos2021 = 0 AND v_TotRecargos2021 = 0) AND
       ((v_importe_multa <> 0) OR (v_tot_gastos <> 0))  THEN
RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia,
                v_totAdeudos2007, v_TotRecargos2007,
                v_totAdeudos2008, v_TotRecargos2008,
                v_totAdeudos2009, v_TotRecargos2009,
                v_totAdeudos2010, v_TotRecargos2010,
                v_totAdeudos2011, v_TotRecargos2011,
                v_totAdeudos2012, v_TotRecargos2012,
                v_totAdeudos2013, v_TotRecargos2013,
                v_totAdeudos2014, v_TotRecargos2014,
                v_totAdeudos2015, v_TotRecargos2015,
                v_totAdeudos2016, v_TotRecargos2016,
                v_totAdeudos2017, v_TotRecargos2017,
                v_totAdeudos2018, v_TotRecargos2018,
                v_totAdeudos2019, v_TotRecargos2019,
                v_totAdeudos2020, v_TotRecargos2020,
                v_totAdeudos2021, v_TotRecargos2021,
v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'W' THEN  -- SIN ADEUDO ALGUNO
  IF ( v_totAdeudos2007 = 0 AND v_TotRecargos2007 = 0 AND
       v_totAdeudos2008 = 0 AND v_TotRecargos2008 = 0 AND
       v_totAdeudos2009 = 0 AND v_TotRecargos2009 = 0 AND
       v_totAdeudos2010 = 0 AND v_TotRecargos2010 = 0 AND
       v_totAdeudos2011 = 0 AND v_TotRecargos2011 = 0 AND
       v_totAdeudos2012 = 0 AND v_TotRecargos2012 = 0 AND
       v_totAdeudos2013 = 0 AND v_TotRecargos2013 = 0 AND
       v_totAdeudos2014 = 0 AND v_TotRecargos2014 = 0 AND
       v_totAdeudos2015 = 0 AND v_TotRecargos2015 = 0 AND
       v_totAdeudos2016 = 0 AND v_TotRecargos2016 = 0 AND
       v_totAdeudos2017 = 0 AND v_TotRecargos2017 = 0 AND
       v_totAdeudos2018 = 0 AND v_TotRecargos2018 = 0 AND
       v_totAdeudos2019 = 0 AND v_TotRecargos2019 = 0 AND
       v_totAdeudos2020 = 0 AND v_TotRecargos2020 = 0 AND
       v_totAdeudos2021 = 0 AND v_TotRecargos2021 = 0 AND
       v_importe_multa  = 0 AND v_tot_gastos      = 0)  THEN
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia,
                v_totAdeudos2007, v_TotRecargos2007,
                v_totAdeudos2008, v_TotRecargos2008,
                v_totAdeudos2009, v_TotRecargos2009,
                v_totAdeudos2010, v_TotRecargos2010,
                v_totAdeudos2011, v_TotRecargos2011,
                v_totAdeudos2012, v_TotRecargos2012,
                v_totAdeudos2013, v_TotRecargos2013,
                v_totAdeudos2014, v_TotRecargos2014,
                v_totAdeudos2015, v_TotRecargos2015,
                v_totAdeudos2016, v_TotRecargos2016,
                v_totAdeudos2017, v_TotRecargos2017,
                v_totAdeudos2018, v_TotRecargos2018,
                v_totAdeudos2019, v_TotRecargos2019,
                v_totAdeudos2020, v_TotRecargos2020,
                v_totAdeudos2021, v_TotRecargos2021,
v_importe_multa, v_tot_gastos, v_Datos  with resume;
  END IF;
END IF;

IF p_Adeudos = 'T' THEN  -- TODOS
                RETURN v_id_rec, v_tipo_aseo, v_Num_Contrato, v_nombre, v_domicilio, v_status_vigencia,
                v_totAdeudos2007, v_TotRecargos2007,
                v_totAdeudos2008, v_TotRecargos2008,
                v_totAdeudos2009, v_TotRecargos2009,
                v_totAdeudos2010, v_TotRecargos2010,
                v_totAdeudos2011, v_TotRecargos2011,
                v_totAdeudos2012, v_TotRecargos2012,
                v_totAdeudos2013, v_TotRecargos2013,
                v_totAdeudos2014, v_TotRecargos2014,
                v_totAdeudos2015, v_TotRecargos2015,
                v_totAdeudos2016, v_TotRecargos2016,
                v_totAdeudos2017, v_TotRecargos2017,
                v_totAdeudos2018, v_TotRecargos2018,
                v_totAdeudos2019, v_TotRecargos2019,
                v_totAdeudos2020, v_TotRecargos2020,
                v_totAdeudos2021, v_TotRecargos2021,
v_importe_multa, v_tot_gastos, v_Datos  with resume;
END IF;

Let v_Control = 0;
Let v_id_rec = 0;
Let v_tipo_aseo = ' ';
Let v_Num_Contrato = 0;
Let v_nombre = ' ';
Let v_domicilio = ' ';
Let v_status_vigencia = ' ';
LET v_totAdeudos2007 = 0;
LET v_TotRecargos2007 = 0;
LET v_totAdeudos2008 = 0;
LET v_TotRecargos2008 = 0;
LET v_totAdeudos2009 = 0;
LET v_TotRecargos2009 = 0;
LET v_totAdeudos2010 = 0;
LET v_TotRecargos2010 = 0;
LET v_totAdeudos2011 = 0;
LET v_TotRecargos2011 = 0;
LET v_totAdeudos2012 = 0;
LET v_TotRecargos2012 = 0;
LET v_totAdeudos2013 = 0;
LET v_TotRecargos2013 = 0;
LET v_totAdeudos2014 = 0;
LET v_TotRecargos2014 = 0;
LET v_totAdeudos2015 = 0;
LET v_TotRecargos2015 = 0;
LET v_totAdeudos2016 = 0;
LET v_TotRecargos2016 = 0;
LET v_totAdeudos2017 = 0;
LET v_TotRecargos2017 = 0;
LET v_totAdeudos2018 = 0;
LET v_TotRecargos2018 = 0;
LET v_totAdeudos2019 = 0;
LET v_TotRecargos2019 = 0;
LET v_totAdeudos2020 = 0;
LET v_TotRecargos2020 = 0;
LET v_totAdeudos2021 = 0;
LET v_TotRecargos2021 = 0;
LET v_importe_multa = 0;
LET v_importe_gastos = 0;
LET v_tot_gastos = 0;
LET v_Datos = '';

END FOREACH;

end procedure
;

CREATE PROCEDURE "informix".spd_17_act_adeudos(
parm_id_conv_resto integer,
parm_id_usuario  integer)
returning smallint;
define    v_id_conv_resto integer;
define    v_tipo smallint;
define    v_id_conv_diver integer;
define    v_fecha_inicio date;
define    v_pago_inicio money(10,2);
define    v_pago_parcial money(10,2);
define    v_pago_final money(10,2);
define    v_total_pagos smallint;
define    v_tipo_pago char(1);
define    v_parcialidad smallint;
define    v_parc smallint;
define    v_importe  money(10,2);
define    v_fecha_pvenc date;
define    v_id_usuario integer;
define    v_cont smallint;
define    v_inserta smallint;
define    v_clave_pago char(1);
define    v_cve_parcialidad char(1);
define    v_modifica smallint;
define    v_axo smallint;
define    v_mes smallint;
define    v_dia smallint;
define    v_pag smallint;
let v_inserta=0;
let v_modifica=0;
let v_pag=0;
foreach
   select id_conv_resto,tipo,id_conv_diver,fecha_inicio,cantidad_inicio,pago_parcial,pago_final,total_pagos,tipo_pago into v_id_conv_resto,v_tipo,v_id_conv_diver,v_fecha_inicio,v_pago_inicio,v_pago_parcial,v_pago_final,v_total_pagos,v_tipo_pago  from ta_17_conv_d_resto 
        where id_conv_resto=parm_id_conv_resto
    let v_parc=0;
    let v_parcialidad=0;
    let v_clave_pago='P';
    let v_id_usuario=parm_id_usuario;
    let v_fecha_pvenc=v_fecha_inicio;
    let v_dia=day(v_fecha_inicio);      
    let v_mes=month(v_fecha_inicio);
    let v_axo=year(v_fecha_inicio);
    if  v_pago_inicio>0 then
        let v_parc=v_parc + 1;
    end if;
    if v_pago_final>0 then
       let v_parc=v_parc + 1;
    end if;
    let v_parc=v_parc + v_total_pagos;
    for v_cont= 1 to v_parc
         let v_pag=v_pag+1;
         if v_tipo_pago='M' then
            if  v_mes=12 then
                let v_mes=1;
                let v_axo=v_axo + 1;
            else
                if  v_cont=1 then
                    let v_mes=v_mes;
                else
                    let v_mes=v_mes + 1;
                end if; 
            end if;
            if v_dia = 31 then
               if  (v_mes = 4 or v_mes =6 or v_mes =9 or v_mes =11) then   
                   let v_dia=30;
               else
               if v_mes = 2 then  
                  let v_dia = 28;
               end if;
               end if;
            end if;
            if v_dia = 30 then
               if v_mes = 2 then  
                  let v_dia = 28;
               end if;
            end if;
            if v_dia = 29 then
               if v_mes = 2 then  
                  let v_dia = 28;
               end if;
            end if;
--            let v_fecha_pvenc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"');
            let v_fecha_pvenc=mdy(v_mes,v_dia,v_axo);
         else
         if v_tipo_pago='Q' then
            let v_fecha_pvenc=v_fecha_pvenc+15;
         else
         if v_tipo_pago='S' then
            let v_fecha_pvenc=v_fecha_pvenc+7;
         end if;
         end if;
         end if;
         if  (v_cont=1 and v_pag=1) and v_pago_inicio>=1 then
             let v_pag=0;
             let v_importe=v_pago_inicio;
             let v_parcialidad=v_parcialidad + 1;
             let v_cve_parcialidad='I';
--             let v_fecha_pvenc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"');
         else
         if  v_cont>=1 and (v_pag>=1 and v_pag<=v_total_pagos) and v_pago_parcial>=1 then
             let v_importe=v_pago_parcial;
             let v_parcialidad=v_parcialidad + 1;
             let v_cve_parcialidad='P';
--             let v_fecha_pvenc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"');
         else
             let v_importe=v_pago_final;
             let v_parcialidad=v_parcialidad + 1;
             let v_cve_parcialidad='F';
--             let v_fecha_pvenc=date('"'|| v_dia || '/' || v_mes || '/' || v_axo ||'"');
        end if;
        end if;
         if not exists( select * from ta_17_conv_pagos
                  where id_conv_resto=v_id_conv_resto and pago_parcial=v_parcialidad) then
            insert into ta_17_adeudos_div values(0,v_id_conv_resto,v_parcialidad,0,v_importe,0,v_fecha_pvenc,v_id_usuario,current,null,v_cve_parcialidad,0,0,0,0,0,0);
            let v_inserta=v_inserta + 1;
         else
            insert into ta_17_adeudos_div values(0,v_id_conv_resto,v_parcialidad,0,v_importe,0,v_fecha_pvenc,v_id_usuario,current,v_clave_pago,v_cve_parcialidad,0,0,0,0,0,0);
            let v_inserta=v_inserta + 1;            
        end if; 
   end for;
end foreach;
return v_inserta;
end procedure;

create function "informix".fn_17_calc_parcialidad(p_porc decimal(11,8),p_pagos int,p_saldo money(18,2))
returning   money(18,2) as pagomensual;

define v_var1, v_var2, v_var3, v_var4 decimal(12,11);
define v_pagomensual money(18,2);

let v_pagomensual=0;

let v_var1=pow(1+(p_porc/100),p_pagos);
let v_var2=v_var1-1;
let v_var3=(p_porc/100)/v_var2;
let v_var4=(p_porc/100)+v_var3;

let v_pagomensual=p_saldo*v_var4;

return v_pagomensual;

end function;

create procedure "informix".spd_17_desglocegrl(pid int)
returning   int as parcial,
            money(16,2) as importe,
            money(16,2) as interes,
            money(16,2) as pago_total,
            date as vencimiento,
            char(1) as cveparcial,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst;

define v_parcial, v_axodsd, v_mesdsd, v_axohst, meshst, v_tipo int;
define v_importe, v_interes, v_pago_total money(16,2);
define v_vencimiento, v_inicio date;
define v_cveparc, v_nvaforma char(1);

select b.tipo,b.nvaforma,b.fecha_inicio into v_tipo, v_nvaforma, v_inicio
from ta_17_conv_d_resto a,ta_17_catparcnvo b where a.id_conv_resto=pid and b.tipo=a.tipo;

if (v_nvaforma='S') and (today>=v_inicio) then
   foreach
     execute procedure spd_17_desgloce2021(pid) into v_parcial,v_importe,v_interes,v_pago_total,v_vencimiento,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst
     return v_parcial,v_importe,v_interes,v_pago_total,v_vencimiento,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst with resume;
   end foreach;
else
   let v_interes=0;
   let v_pago_total=0;
   foreach
     execute procedure spd_17_desgloce(pid) into v_parcial,v_importe,v_vencimiento,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst
     return v_parcial,v_importe,0,0,v_vencimiento,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst with resume;
   end foreach;
end if;

end procedure;

create procedure "informix".spd_17_desgloce2021(pid int)
returning   int as parcial,
            money(16,2) as importe,
            money(16,2) as interes,
            money(16,2) as pago_total,
            date as vencimiento,
            char(1) as cveparcial,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst;

define v_parcial,v_axodsd,v_mesdsd,v_axohst,meshst,v_idlocal,v_ctaimp,v_ctarec,v_ctaact,v_ctamul int;
define v_pagos,v_mod,v_axodet,v_mesdet,v_cont,v_reg,v_linea,v_diac int; 
define v_apdsd,v_mpdsd,v_aphst,v_mphst,v_totlin,v_totreg,v_mes,v_dia,v_axo int; 
define v_imprte,v_inicial,v_impdet,v_recdet,v_saldo,v_impparc,v_actdet,v_muldet,v_cant_total money(16,2);
define v_parc_total, v_interes, pparcial money(18,2);
define v_porc decimal(11,8);
define v_vencimiento,v_inicio,v_mensual date;
define v_cveparc,v_tipo_pago char(1);
define v_concdet varchar(30);

begin
    on exception in (-958)
       delete from tmp_detalle2021;
    end exception;
create temp table tmp_detalle2021(
  parcialidad int,
  adeudo money(14,2),
  interes money(14,2), 
  pago money(14,2),
  vencimiento date,
  cveparcial char(1)) with no log;
end;

let v_saldo=0;
let v_reg=0;
let v_vencimiento=null;
let v_mensual=null;
let v_totlin=0;
let v_totreg=0;
let v_linea=0;
let v_apdsd=0;
let v_mpdsd=0;
let v_aphst=0;
let v_mphst=0;
let v_linea=0;
let v_diac=0;
let v_cant_total=0;
let pparcial=0;

if not exists(select * from ta_17_conv_d_resto where id_conv_resto=pid) then 
   return 0, 0, 0, 0, null, ' ', 0, 0, 0, 0;
end if;

foreach
  select nvl(a.cantidad_inicio,0),nvl(a.total_pagos,0),a.fecha_inicio,nvl(b.modulo,0),nvl(b.id_referencia,0),nvl(b.axo_desde,0),
   nvl(b.mes_desde,0),nvl(b.axo_hasta,0),nvl(b.mes_hasta,0),a.tipo_pago,nvl(a.cantidad_total,0)
  into v_inicial,v_pagos,v_inicio,v_mod,v_idlocal,v_axodsd,v_mesdsd,v_axohst,meshst,v_tipo_pago,v_cant_total
  from ta_17_conv_d_resto a,ta_17_referencia b where a.id_conv_resto=pid
  and b.id_conv_resto=a.id_conv_resto
end foreach;

-- obtine el porcentaje del interes
select nvl(porcentaje,0) into v_porc from ta_12_intereses where axo=year(v_inicio) and mes=month(v_inicio);
if v_porc is null then
   let v_porc=0;
end if;

-- Empieza el calculo las parcialidades

-- inserta el pago inicial
let v_saldo=v_cant_total - v_inicial;
insert into tmp_detalle2021 values(1, v_inicial, 0, v_inicial, v_inicio, 'I');

-- inserta parcialidades
execute function fn_17_calc_parcialidad(v_porc, v_pagos, v_saldo) into pparcial;
let v_vencimiento=v_inicio;
let v_mensual=v_inicio;
let v_impparc=0;
for v_cont=1 to v_pagos
   let v_interes=(v_porc * v_saldo) / 100;
   let v_impparc=pparcial - v_interes;

   let v_diac=day(v_inicio);
   if v_diac = 31 then
      if  (month(v_mensual) = 4 or month(v_mensual) =6 or month(v_mensual) =9 or month(v_mensual) =11) then   
          let v_diac=30;
      else
          if month(v_mensual) = 2 then  
             let v_diac = 28;
          end if;
      end if;
   end if;
   if v_diac = 30 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   if v_diac = 29 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   execute function fn_17_calc_venc(mdy(month(v_mensual),v_diac,year(v_mensual)),v_tipo_pago) into v_vencimiento,v_mensual;
   insert into tmp_detalle2021 values(v_cont+1, v_impparc, v_interes,  v_impparc+v_interes, v_vencimiento, 'P');
   let v_saldo=v_saldo - v_impparc;
end for;

-- regresa las parcialidades calculadas
foreach
  select parcialidad, adeudo, interes, pago, vencimiento, cveparcial 
  into v_linea, v_impparc, v_interes, v_parc_total, v_vencimiento, v_cveparc
  from tmp_detalle2021 order by parcialidad

  return v_linea, v_impparc, v_interes, v_parc_total, v_vencimiento, v_cveparc, 0, 0, 0, 0 with resume;
end foreach;

end procedure;

create procedure "informix".spd_17_totalcuenta(pmod int, pid int, pidconv int)
returning   int as estado,
            varchar(100) as mensaje;

define vcuenta,vctaact,vctarzg,vctaimp,vctarec,vctamul,vctagst,vctafvlic,vctafvanun,vctarecdesc,vctaactualizacion,vctaactualizacionanun,vestado int;
define vctaactanu,vctarzganu,aaxo,ames,vaxod,vmesd,vaxoh,vmesh,actaimporte,actarecargos,aparcactaapl,fcuenta,actaint,t_prior,actaparc,t_cuenta int;
define dimporte,aimporte,arecargos,gimporte,aacumulado,acalcacumulado,aimpparc,aimpcalc,amonto,fdiferencia,fmonto,ainteres,apagomensual money(16,2);
define lderechos,lrecargos,lanuncios,lformas,lgastos,lmulta,limporte,lfvlicencias,lfvanuncios,lactualizacion,lactualizacionanun,t_diferencia money(16,2);
define vur char(1);
define vdescripcion, vmsg varchar(100);
define aconcepto,fconcepto,t_concepto varchar(30);

begin
    on exception in (-958)
       delete from tmp_totalescuenta;
    end exception;
create temp table tmp_totalescuenta(
  prioridad int,
  concepto varchar(30),
  cuenta int,
  monto money(14,2)) with no log;
end;

let vcuenta=0;
let vdescripcion='';
let vctaactanu=0;
let vctafvanun=0;
let vctafvlic=0;
let vctaactualizacion=0;
let vestado=0;
let vmsg='';

if pmod>0 then
   let acalcacumulado=0;
   let t_prior=0;
   if pmod=3 then -- cuentas multas municipales
      select b.cvectaapl,b.cta_vencido,(select cta_gasto from catastro_gdl:c_ctasxmodulo where id_modulo=6) into vctaact,vctarzg,vctagst 
      from catastro_gdl:multas a,catastro_gdl:c_dependencias b where a.id_multa=pid and b.id_dependencia=a.id_dependencia;

      -- obtiene datos de accesorios de convenios
      select nvl(total,0), nvl(gastos,0) into gimporte, lgastos from ta_17_referencia where id_conv_resto=pidconv;

      -- inserta el total por cuenta
      let limporte=gimporte-lgastos;
      insert into ta_17_totalcta values(0,pidconv,pmod,pid,1,'GASTOS',vctagst,lgastos,lgastos,0,lgastos);
      insert into ta_17_totalcta values(0,pidconv,pmod,pid,2,'MULTA MUNICIPAL',vctaact,limporte,0,gimporte);
   else
   if pmod=4 then -- licencias de construccion
      -- obtiene las cuentas de la table de detalle
      foreach
        select a.cuenta,a.monto,a.acumulado,b.descripcion into actaimporte, aimporte, aacumulado, aconcepto 
        from ta_17_det_obraspub a, outer ta_12_ctas_odoo b
        where a.id_conv_resto=pidconv and a.monto>0 and b.cta_aplic=a.cuenta and b.axo=year(today)
        order by a.acumulado
        let t_prior=t_prior+1;

        -- inserta el total por cuenta
        insert into ta_17_totalcta values(0,pidconv,pmod,pid,t_prior,aconcepto,actaimporte,aimporte,aacumulado,0,aimporte);
      end foreach;  
   else
   if pmod=5 then -- cuentas de predial
      -- obtiene los periodos conveniados
      select axo_hasta, mes_hasta into vaxoh,vmesh from ta_17_referencia where id_conv_resto=pidconv;
      foreach
        -- verifica los adeudos para separa totales por cuenta de aplicacion
        execute procedure catastro_gdl:convenios_predial_detalle(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                     aimporte,actarecargos,arecargos,vctaactualizacion,lactualizacion,vctamul,lmulta

        -- verifica los adeudos de la parcialidad y graba a temporal
        if (aimporte > 0) and (aconcepto='Gastos') then
           insert into tmp_totalescuenta values(1,aconcepto,actaimporte,aimporte);
        end if; 
        if lmulta > 0 then   
           insert into tmp_totalescuenta values(2,'MULTA',vctamul,lmulta);
        end if;
        if arecargos > 0 then     
           insert into tmp_totalescuenta values(3,'RECARGOS',actarecargos,arecargos);
        end if;
        if lactualizacion > 0 then
           insert into tmp_totalescuenta values(4,'ACTUALIZACION',vctaactualizacion,lactualizacion);        
        end if;
        if (aimporte > 0) and (aconcepto<>'Gastos') then
           insert into tmp_totalescuenta values(5,aconcepto,actaimporte,aimporte);
        end if; 
      end foreach;

      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
        select a.prioridad, a.cuenta, b.descripcion, nvl(sum(a.monto),0) into t_prior,vcuenta,t_concepto,dimporte 
        from tmp_totalescuenta a, outer ta_12_ctas_odoo b where b.cta_aplic=a.cuenta and b.axo=year(today)
        group by a.prioridad, a.cuenta, b.descripcion order by a.prioridad, a.cuenta
        let acalcacumulado=acalcacumulado+dimporte;
               
        -- inserta el total por cuenta
        insert into ta_17_totalcta values(0,pidconv,pmod,pid,t_prior,t_concepto,vcuenta,dimporte,acalcacumulado,0,dimporte);
      end foreach;
   else   
   if pmod=9 then -- cuentas de licencias
      -- obtiene las cuentas de licencias
      foreach
        execute FUNCTION catastro_gdl:conv_adeudos_detalle_12('L',pid) into t_prior, actaimporte, aconcepto, aimporte, aacumulado
      
        -- inserta el total por cuenta
        insert into ta_17_totalcta values(0,pidconv,pmod,pid,t_prior,aconcepto,actaimporte,aimporte,aacumulado,0,aimporte);
      end foreach;
   else
   if pmod=10 then -- cuentas de anuncios  
      -- obtiene las cuentas de anuncios
      foreach
        execute FUNCTION catastro_gdl:conv_adeudos_detalle_12('A',pid) into t_prior, actaimporte, aconcepto, aimporte, aacumulado
      
        -- inserta el total por cuenta
        insert into ta_17_totalcta values(0,pidconv,pmod,pid,t_prior,aconcepto,actaimporte,aimporte,aacumulado,0,aimporte);
      end foreach;
/*   else 
   if pmod=11 then -- mercados
      -- verifica los adeudos para separa totales por cuenta de aplicacion
      foreach
      execute procedure spd_11_conv_liqdet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos,vctaactualizacion,lactualizacion
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         if arecargos>0 then     
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
         if lactualizacion>0 then
            insert into tmp_desgloce values('ACTUALIZACION',aaxo,ames,vctaactualizacion,lactualizacion);
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select a.cuenta,b.descripcion,nvl(sum(a.monto),0) into vcuenta,vdescripcion,dimporte 
       from tmp_desgloce a, outer ta_12_ctas_odoo b
       where b.axo=year(today) and b.interface=13 and b.cta_aplic=a.cuenta
       group by a.cuenta, b.descripcion order by a.cuenta           
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else 
   if pmod=16 then -- aseo contratado
      -- verifica los adeudos para separar totales por cuenta de aplicacion
      foreach
      execute procedure sp16_ConvDet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         if arecargos=0 then     
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         else
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;               
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else
   if pmod=18 then -- especios abiertos
      select d.cuenta_ingreso,391000000,391040000 into vctaact,vctarec,vctarecdesc
      from ta_17_conv_d_resto a,ta_17_conv_diverso b,ta_17_subtipo_conv d
      where a.id_conv_resto=pidconv and b.id_conv_diver=a.id_conv_diver and b.tipo=a.tipo
      and d.tipo=b.tipo and d.subtipo=b.subtipo;

      -- obtiene datos de accesorios de convenios
      select nvl(impuesto,0),nvl(recargos,0)
      into lderechos,lrecargos
      from ta_17_referencia where id_conv_resto=pidconv;

      if pparc=1 then
         let limporte=gimporte-lrecargos;
         insert into tmp_desgloce values('CUOTA',0,0,vctaact,limporte);
         insert into tmp_desgloce values('RECARGOS',0,0,vctarec,lrecargos);
      else
         insert into tmp_desgloce values('CUOTA',0,0,vctaact,gimporte);
      end if;

      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta

      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;
      if dimporte>0 then               
         return vcuenta,vdescripcion,dimporte with resume;
      end if;
      end foreach;
   else
   if pmod=24 then -- Estacionamientos Publicos
      -- verifica los adeudos para separa totales por cuenta de aplicacion
      foreach
      execute procedure dbestacion:sp24_convdet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         if arecargos=0 then     
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         else
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;               
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else
   if pmod=28 then -- Estacionamientos exclusivos
      -- verifica los adeudos para separa totales por cuenta de aplicacion
      foreach
      execute procedure dbestacion:sp28_convdet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         if arecargos=0 then     
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         else
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;               
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else 
      return 0,'',0;
   end if; end if; end if; end if; end if;*/ end if; end if; end if; end if; end if;
end if; 
return vestado, vmsg;
end procedure;

create function "informix".fn_17_saldocuenta(pid_conv int, pcuenta int, paplicar money(18,2), popc int)
returning   int as prioridad,
            int as cuenta,
            varchar(100) as concepto,
            money(18,2) as saldo;

-- popc =1  para insertar monto aplicado y retornar la primera diferencia por cuenta
-- popc =0  solo retornar la primera diferencia por cuenta

define vprior, vcuenta int;
define vsaldo money(18,2);
define vconcepto varchar(100);

let vprior=0;
let vcuenta=0;
let vconcepto='';
let vsaldo=0;

if popc=1 then
   update ta_17_totalcta set aplicado=aplicado+paplicar, diferencia=monto-(aplicado+paplicar)
    where id_conv_resto=pid_conv and cuenta=pcuenta;
end if;

foreach
  select prioridad, cuenta, concepto, diferencia into vprior, vcuenta, vconcepto, vsaldo from ta_17_totalcta where id_conv_resto=pid_conv and diferencia>0
  order by prioridad desc

end foreach;

return vprior, vcuenta, vconcepto, vsaldo;
end function;

create procedure "informix".spd_17_cuentasaplgrl(pmod int,pid int,pparc int,pidconv int)
returning   int as cuenta,
            varchar(100) as descripcion,
            money(16,2) as importe;

define v_tipo, vcuenta int;
define dimporte money(16,2);
define v_nvaforma char(1);
define vdescripcion varchar(100);
define v_inicio date;

-- verifica el tipo de convenio 
select b.tipo,b.nvaforma,b.fecha_inicio into v_tipo, v_nvaforma, v_inicio
from ta_17_conv_d_resto a,ta_17_catparcnvo b where a.id_conv_resto=pidconv and b.tipo=a.tipo;

if (v_nvaforma='S') and (today>=v_inicio) then
   foreach
     execute procedure spd_17_cuentasapl2021(pparc, pidconv) into vcuenta, vdescripcion, dimporte
     return vcuenta, vdescripcion, dimporte with resume;
   end foreach;
else
   foreach
     execute procedure spd_17_cuentasapl(pmod, pid, pparc, pidconv) into vcuenta, vdescripcion, dimporte
     return vcuenta, vdescripcion, dimporte with resume;
   end foreach;
end if;
end procedure;

create procedure "informix".spd_17_cuentasapl2021(pparc int,pidconv int)
returning   int as cuenta,
            varchar(100) as descripcion,
            money(16,2) as importe;

define actaint,t_prior,t_cuenta int;
define aimporte,ainteres,apagomensual,vacumulado,vacumulado1,vaplicar,vsaldoparcialidad,t_saldo,t_monto,t_aplicado money(14,2);
define t_concepto varchar(100);

begin
    on exception in (-958)
       delete from tmp_desgloce;
    end exception;
create temp table tmp_desgloce(
  prioridad int,
  concepto varchar(100),
  cuenta int,
  monto money(14,2),
  aplicado money(14,2),
  diferencia money(14,2)  ) with no log;
end;

-- verifica los periodos del adeudo
select pagomensual, importe, interes into apagomensual, aimporte, ainteres from ta_17_adeudos_div where id_conv_resto=pidconv and pago_parcial=pparc;

-- obtiene la cuenta de interes
select d.cuenta_intereses into actaint from ta_17_conv_d_resto a, ta_17_conv_diverso b, ta_17_subtipo_conv d 
where a.id_conv_resto=pidconv and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver and d.tipo=b.tipo and d.subtipo=b.subtipo;

-- traslada las saldos de las cuentas a temporal
foreach
  select prioridad, concepto, cuenta, monto, aplicado, diferencia into t_prior, t_concepto, t_cuenta, t_monto, t_aplicado, t_saldo
  from ta_17_totalcta where id_conv_resto=pidconv
  order by prioridad

  insert into tmp_desgloce values(t_prior, t_concepto, t_cuenta, t_monto, t_aplicado, t_saldo);
end foreach;

-- arma el desgloce de cuentas
let vacumulado=0;
let vacumulado1=0;
let vaplicar=0;
let vsaldoparcialidad=aimporte;
while vacumulado<aimporte
   --execute function fn_17_saldocuenta(pidconv, 0, 0, 0) into t_prior, t_cuenta, t_concepto, t_saldo; -- solo saldo 
   foreach
     select prioridad, cuenta, concepto, diferencia into t_prior, t_cuenta, t_concepto, t_saldo 
     from tmp_desgloce where diferencia>0
     order by prioridad desc
   end foreach;
   if t_saldo<=vsaldoparcialidad then
      let vaplicar=t_saldo;
      let vacumulado=vacumulado+vaplicar;
      let vsaldoparcialidad=aimporte-vacumulado;
      return t_cuenta, t_concepto, vaplicar with resume;
      --execute function fn_17_saldocuenta(pidconv, t_cuenta, vaplicar, 1) into t_prior, t_cuenta, t_concepto, t_saldo; -- para insertar
      update tmp_desgloce set aplicado=aplicado+vaplicar, diferencia=monto-(aplicado+vaplicar) where cuenta=t_cuenta;
   else
      let vaplicar=vsaldoparcialidad;
      let vacumulado=vacumulado+vaplicar;
      let vsaldoparcialidad=aimporte-vacumulado;
      return t_cuenta, t_concepto, vaplicar with resume;
      --execute function fn_17_saldocuenta(pidconv, t_cuenta, vaplicar, 1) into t_prior, t_cuenta, t_concepto, t_saldo; -- para insertar 
      update tmp_desgloce set aplicado=aplicado+vaplicar, diferencia=monto-(aplicado+vaplicar) where cuenta=t_cuenta;
   end if;
end while; 
   
-- retorna el interes
--select descripcion into t_concepto from ta_12_ctas_odoo where cta_aplic=actaint and axo=year(today);
--if ainteres>0 then
--   return actaint, t_concepto, ainteres; 
--end if;
-- borrar tabla temporal
delete from tmp_desgloce;  
  
end procedure;

create procedure "informix".admin_intereses_22(pidresto int,pven date,pparc int,ptparc char(1))
returning   money(18,2) as intereses;

define v_intereses,v_acumulado,v_cantidad,v_saldo money(18,2);
define v_porc decimal(11,8);
define v_porcant decimal(5,2);
define v_tipo int; 
define v_fecinicio, v_inicio date;
define v_nvaforma char(1);

let v_porc=0;
let v_porcant=0;
let v_intereses=0;
if ptparc='I' then
   return v_intereses;
end if;

select b.tipo,b.fecha_inicio, d.nvaforma, d.fecha_inicio, nvl(b.cantidad_total,0), nvl(sum(a.importe),0) 
into v_tipo, v_fecinicio, v_nvaforma, v_inicio, v_cantidad, v_acumulado 
from ta_17_adeudos_div a,ta_17_conv_d_resto b, outer ta_17_catparcnvo d
where a.id_conv_resto=pidresto and a.pago_parcial<pparc and b.id_conv_resto=a.id_conv_resto
and d.tipo=b.tipo group by b.tipo,b.fecha_inicio, d.nvaforma, d.fecha_inicio, b.cantidad_total;

let v_saldo=v_cantidad-v_acumulado;  
 
if pven>today then
   select porcentaje into v_porc from ta_12_intereses where axo=year(today) and mes=month(today);
else
   select porcentaje into v_porc from ta_12_intereses where axo=year(pven) and mes=month(pven);
end if;

if  v_porc is null then
    let v_porc=0;
end if;

let v_porcant=v_porc;
if v_fecinicio>=v_inicio then
   let v_intereses=trunc(v_saldo*v_porc)/100;
else
   let v_intereses=trunc(v_saldo*v_porcant)/100;
end if;

return v_intereses;
end procedure;

create procedure "informix".spd_17_ultimaparc(pid_conv int,pcvepago int,popc char(1),puser varchar(10),piduser int)
returning   int as estado,
            varchar(100) as mensaje;

define v_estado,v_tipo,v_subt,v_id_ref,v_mod,v_ok, r_bini, r_aini, r_bfin, r_afin, v_idcta int;
define v_modulo,v_referencia int;
define v_mensaje varchar(100);
define v_convenio varchar(15);
define v_inicio,v_final date;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'spd_17_ultimaparc ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

let v_id_ref=0;
let v_mod=0;
let v_estado=0;
let v_modulo=0;
let v_referencia=0;
let v_mensaje='MOVIMIENTO REALIZADO CORRECTAMENTE';

select b.tipo,b.subtipo,a.fecha_inicio,a.fecha_venc,(trim(b.letras_exp)||'/'||b.numero_exp||'/'||b.axo_exp)
into v_tipo,v_subt,v_inicio,v_final,v_convenio 
from ta_17_conv_d_resto a, ta_17_conv_diverso b
where a.id_conv_resto=pid_conv and b.id_conv_diver=a.id_conv_diver;

if popc='P' then
   -- afecta como pagado el convenio
   update ta_17_conv_d_resto set vigencia='P',id_usuario=piduser,fecha_actual=current
   where id_conv_resto=pid_conv;

   -- afecta como pagado la tabla convenios de catastro
   if (v_tipo=1) or (v_tipo=8) or ((v_tipo=3 ) and (v_subt<=2)) then
      update catastro_gdl:convenios set vigencia='P' where id_conv_diver=pid_conv;
   end if; 

   if exists (select * from ta_17_referencia where id_conv_resto=pid_conv) then
      foreach
      select  modulo,id_referencia into v_modulo,v_referencia
      from ta_17_referencia where id_conv_resto=pid_conv
      order by modulo desc
      end foreach;
   end if;

   -- inserta saldo a favor 
   if v_tipo=3 then
      execute procedure spd_17_ins_saldos(pid_conv,v_referencia,v_modulo,v_convenio,'A') into v_estado,v_mensaje;
   end if;

   if exists (select * from ta_17_referencia where id_conv_resto=pid_conv) then
      foreach
      select  modulo,id_referencia into v_mod,v_id_ref
      from ta_17_referencia where id_conv_resto=pid_conv

      if v_mod=9 then
         -- desbloquea tablas de licencias
         execute procedure conv_licanun(v_id_ref,'L','P',pid_conv,puser) into v_ok;
         if v_ok<>0 then
            let v_estado=-1;
            let v_mensaje='ERROR AL EJECUTAR COMO PAGADO EL PROCEDIMEINTO PARA LICENCIAS';
         end if;
      end if;
  
      if v_mod=10 then
         -- desbloquea tablas de anuncios
         execute procedure conv_licanun(v_id_ref,'A','P',pid_conv,puser) into v_ok;
         if v_ok<>0 then
            let v_estado=-1;
            let v_mensaje='ERROR AL EJECUTAR COMO PAGADO EL PROCEDIMEINTO PARA ANUNCIOS';
         end if;
      end if;

      if v_mod=11 then
         -- elimina el bloqueo en locales 
         update ta_11_locales set bloqueo=0 where id_local=v_id_ref;
         -- desbloquea arrendamiento
         if v_tipo=6 then
            update ta_11_bloqueo set fecha_final=v_final 
            where id_local=v_id_ref and cve_bloqueo=1 and fecha_inicio=v_inicio;
         else
         if v_tipo=7 then
            update ta_11_bloqueo set fecha_final=v_final 
            where id_local=v_id_ref and cve_bloqueo=2 and fecha_inicio=v_inicio;
         else
            update ta_11_bloqueo set fecha_final=v_final 
            where id_local=v_id_ref and cve_bloqueo=3 and fecha_inicio=v_inicio;
         end if; 
         end if; 
      end if;

      if v_mod=16 then
         -- elimina el estatus de conveniado en aseo
         update ta_16_contratos set status_vigencia='V' where control_contrato=v_id_ref;
      end if;
      if v_mod=28 then
         -- elimina el estatus de conveniado en estacionamientos exclusivos
         update dbestacion:ex_contrato set estatus='V' where id=v_id_ref;
      end if;
      end foreach;  
   end if;  
end if;

if popc='C' then
   -- reactiva el convenio
   update ta_17_conv_d_resto set vigencia='A',id_usuario=piduser,fecha_actual=current
   where id_conv_resto=pid_conv; 
   -- reactiva el convenios de catastro
   if (v_tipo=1) or (v_tipo=8) or ((v_tipo=3) and (v_subt<=2)) then
      update catastro_gdl:convenios set vigencia='A' where id_conv_diver=pid_conv;
   end if;

   if v_tipo=1 then
      -- congela el detsaldo 
      select id_referencia, bimini, axoini, bimfin, axofin  into v_idcta, r_bini, r_aini, r_bfin, r_afin 
       from catastro_gdl:convenios where id_conv_diver=pid_conv;

      update catastro_gdl:detsaldos set kpgel='C' where cvecuenta=v_idcta 
        and ( (axosal>r_aini or (bimsal>=r_bini and axosal=r_aini)) 
        and (axosal<r_afin  or (bimsal<=r_bfin and axosal=r_afin)) );
   end if;

   if exists (select * from ta_17_referencia where id_conv_resto=pid_conv) then
      foreach
      select  modulo,id_referencia into v_modulo,v_referencia
      from ta_17_referencia where id_conv_resto=pid_conv
      order by modulo desc
      end foreach;
   end if;

   -- inserta saldo a favor 
   if v_tipo=3 then
      execute procedure spd_17_ins_saldos(pid_conv,v_referencia,v_modulo,v_convenio,'B') into v_estado,v_mensaje;
   end if;
                 
   if exists (select * from ta_17_referencia where id_conv_resto=pid_conv) then
      foreach
      select modulo,id_referencia into v_mod,v_id_ref
      from ta_17_referencia where id_conv_resto=pid_conv

      -- cancela el pago de predial
--      if v_mod=5 then
--         insert into catastro_gdl:pagoscan (cvecanc,cvepago,autorizo,fechacan) 
--	     values (0,pcvepago,puser,today);
--      end if;

      -- desbloquea tablas de licencias
      if v_mod=9 then
         execute procedure conv_licanun(v_id_ref,'L','R',pid_conv,puser) into v_ok;
         if v_ok<>0 then
            let v_estado=-1;
            let v_mensaje='ERROR AL EJECUTAR COMO CANCELADO EL PROCEDIMEINTO PARA LICENCIAS';
         end if;
      end if;
 
      -- desbloquea tablas de anuncios 
      if v_mod=10 then
         execute procedure conv_licanun(v_id_ref,'A','R',pid_conv,puser) into v_ok;
         if v_ok<>0 then
            let v_estado=-1;
            let v_mensaje='ERROR AL EJECUTAR COMO CANCELADO EL PROCEDIMEINTO PARA ANUNCIOS';
         end if;
      end if;

      -- desbloquea arrendamiento
      if v_mod=11 then
         if v_tipo=6 then
            -- reactiva el bloqueo en locales 
            update ta_11_locales set bloqueo=1 where id_local=v_id_ref;
            update ta_11_bloqueo set fecha_final=null 
            where id_local=v_id_ref and cve_bloqueo=1 and fecha_inicio=v_inicio;
         else
         if v_tipo=7 then
            -- reactiva el bloqueo de bienes inmuebles 
            update ta_11_locales set bloqueo=2 where id_local=v_id_ref;
            update ta_11_bloqueo set fecha_final=null 
            where id_local=v_id_ref and cve_bloqueo=2 and fecha_inicio=v_inicio;
         else
            -- reactiva el bloqueo DE REMODELACION-REHABILITACION
            update ta_11_locales set bloqueo=3 where id_local=v_id_ref;
            update ta_11_bloqueo set fecha_final=null 
            where id_local=v_id_ref and cve_bloqueo=3 and fecha_inicio=v_inicio;
         end if; 
         end if;   
      end if;
      -- reactiva estado de conveniado al contrato de aseo
      if v_mod=16 then
         update ta_16_contratos set status_vigencia='N' where control_contrato=v_id_ref;
      end if;
      -- reactiva estado de conveniado del estacionamiento exclusivo
      if v_mod=28 then
         update dbestacion:ex_contrato set estatus='N' where id=v_id_ref;
      end if;
      end foreach;  
   end if;   
end if;

return v_estado,v_mensaje; 
end procedure;

CREATE FUNCTION "informix".admin_pago_22(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10),pref varchar(20),pimppag money(14,2),
pimpcartera money(14,2),pimpredondeo money(14,2),pidcobro int,
pfolio varchar(30),pfecha date,precp int,pcentrop int,pcaja char(20),pnombreuser varchar(40),
puser char(8))

{######################################################################
#  Procedimiento:    admin_pago_22
#  Descripcion:      Interfaz de pago para el cobro Convenios diversos para admin
#
#  Parametros        
#  de entrada:       pinterface = 22 numero de interfaz para convenios diversos
#                    ptipo = tipo de convenio ejem(1-predial)
#                    psubt = subtipo del tipo de convenio ejem (1-urbano)
#                    plet = letras del convenio ejem(ZC1)
#                    pnum = nuemro del convenio
#                    paxo = a�o del convenio
#                    pseg = sin informacion
#                    pref = hasta que parcialidad se afectara como pagado
#                    pimppag = importe total de pago
#                    pimpcartera = importe de total de las parcialidades 
#                    pimpredondeo = importe de redondeo
#                    pidcobro = numero de operacion,
#                    pfolio = folio de recibo ofical
#                    pfecha = fecha de pago
#                    precp = recaudadora de pago
#                    pcentrop = numero de centro de recaudacion
#                    pcaja = caja de pago
#                    pnombreuser = nombre del cajero
#                    puser = nombre del usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            30 Octubre 2013   
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}


returning   int as status, 
            varchar(100) as mensaje;

define v_Nombrecompleto varchar(92); 
define v_calle varchar(80);
define v_Exterior,v_interior,v_codigopostal varchar(10);
define v_colonia,v_municipio,v_estado varchar(50);
define v_RFC varchar(13);
define v_curp varchar(18);
define v_carteraxcobar,v_codigo,v_cuentatot,v_tcta,v_cont,v_totparc,v_axofd,v_mesfd,v_descuento int;
define v_leyenda,v_leyenda1,v_leyendaRECIBO varchar(255);
define v_tipo,v_subtipo varchar(50);
define v_fecha varchar(20);
define v_porcdescrec decimal(5,2);
define v_referencia,v_refper,v_refrec varchar(30); 
define v_inicio,v_parcial,v_final,v_total,v_acumulado,v_montotot,v_acumuladotot decimal(16,2);
define v_montoper,v_montorec,v_gastostmp,v_multatmp,v_imprecutmp,v_imprecrtmp decimal(16,2);
define v_datosvarios,v_descrbo,v_conceptodet,v_mensmerc,v_menspred,v_mensultima varchar(150);
define v_concepto,v_domicilio,v_mensaje varchar(60);
define v_ref,v_iduser,v_contvarios,v_parci,v_parcf,v_id,v_cvevenc,v_idreferencia int;
define v_aini,v_mini,v_afin,v_mfin,v_statmerc,v_statpred,v_reccta,v_status,v_estultima int;
define v_ctarec,v_ctaint,v_ctagst,v_ctamul,v_ctarecurb,v_ctarecrus int;
define v_per1,v_per2,v_per3,v_per4,v_per5,v_per6,v_per7,v_per8,v_per9 varchar(30);
define v_per10,v_per11,v_per12,v_per13,v_per14,v_per15,v_per16,v_per17,v_per18 varchar(30);
define d_rubro,d_concepto,d_cuenta int;
define d_referencia varchar(30);
define d_descripcion  varchar(120);
define d_monto,d_acumulado decimal(14,2);
define v_inicionv, v_fecinicio date;

define v_ur, v_cvegst, v_nvaforma, v_ultima char(1);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -12, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE CONVENIOS DIVERSOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
-- set debug file to "pago22";
-- trace on;
  let v_r = 'N';
 
  -- ejecuta el procedimiento adeudo detalle
    foreach 
execute procedure admin_adeudos_detalle_22odoo(22 , ptipo ,psubt ,plet ,
pnum ,paxo ,pseg ,pref ) into  d_rubro,d_concepto,d_cuenta,d_referencia,d_descripcion,d_monto,d_acumulado

end foreach;
  select count(*) into v_ca from  tmp_totalesconv ;
  if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;

let v_contvarios=0;
let v_cont=0;

-- Asigna valor a fererencia a pagar
if trim(pref)='' then
   let v_ref=999;
else
   let v_ref=pref;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=1053;
end if;

if not exists (select * from tmp_totalesconv) then
   let v_status=1;
   let v_leyenda1='No existen adeudos para afectar';
   return v_status,v_leyenda1;
end if;

-- checa que exista el convenio
if not exists(select * from ta_17_conv_diverso a,ta_17_conv_d_resto b
   where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
   and a.numero_exp=pnum and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver) then
       return -1,'REFERENCIA NO EXISTE  **CONVENIO';
end if;

-- obtiene el id resto y la fecha del convenio
select b.id_conv_resto, b.fecha_inicio into v_id, v_fecinicio 
from ta_17_conv_diverso a,ta_17_conv_d_resto b
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver;

-- ejecuta el procedimeinto de encabezados
execute procedure admin_encabezados_22(pinterface,ptipo,psubt,plet,pnum,paxo,pseg) into
v_Nombrecompleto,v_calle,v_Exterior,v_interior,v_colonia,v_codigopostal,v_RFC,v_municipio,v_estado,
v_curp,v_carteraxcobar,v_leyenda,v_leyendaRECIBO,v_codigo;

-- ejecuta el procedimiento de datos varios
foreach
execute procedure admin_datos_varios_22(pinterface,ptipo,psubt,plet,pnum,paxo,pseg) into v_datosvarios
let v_contvarios=v_contvarios+1;
if v_contvarios = 1 then let v_tipo=v_datosvarios; 
else if v_contvarios = 2 then let v_subtipo=v_datosvarios;
else if v_contvarios = 3 then let v_fecha=v_datosvarios;
else if v_contvarios = 4 then let v_inicio=v_datosvarios;
else if v_contvarios = 5 then let v_parcial=v_datosvarios;
else if v_contvarios = 6 then let v_final=v_datosvarios;
else if v_contvarios = 7 then let v_total=v_datosvarios;
else if v_contvarios = 8 then let v_referencia=v_datosvarios;
else if v_contvarios = 9 then let v_per1=v_datosvarios;
else if v_contvarios = 10 then let v_per2=v_datosvarios;
else if v_contvarios = 11 then let v_per3=v_datosvarios;
else if v_contvarios = 12 then let v_per4=v_datosvarios;
else if v_contvarios = 13 then let v_per5=v_datosvarios;
else if v_contvarios = 14 then let v_per6=v_datosvarios;
else if v_contvarios = 15 then let v_per7=v_datosvarios;
else if v_contvarios = 16 then let v_per8=v_datosvarios;
else if v_contvarios = 17 then let v_per9=v_datosvarios;
else if v_contvarios = 18 then let v_per10=v_datosvarios;
else if v_contvarios = 19 then let v_per11=v_datosvarios;
else if v_contvarios = 20 then let v_per12=v_datosvarios;
else if v_contvarios = 21 then let v_per13=v_datosvarios;
else if v_contvarios = 22 then let v_per14=v_datosvarios;
else if v_contvarios = 23 then let v_per15=v_datosvarios;
else if v_contvarios = 24 then let v_per16=v_datosvarios;
else if v_contvarios = 25 then let v_per17=v_datosvarios;
else let v_per18=v_datosvarios;
end if; end if; end if; end if; end if; end if; end if; end if; end if;
end if; end if; end if; end if; end if; end if; end if; end if; end if;
end if; end if; end if; end if; end if; end if; end if; 
end foreach;

-- para sacar parcialidad minima
select  min(referencia) into v_parci from tmp_totalesconv; 
-- para sacar parcialidad maxima
select  max(referencia) into v_parcf from tmp_totalesconv;
-- para sacar el maximo de parcialidades de todo el convenio
select max(pago_parcial) into v_totparc from ta_17_adeudos_div where id_conv_resto=v_id;
-- obtiene el periodo de la primera parcialida
select axo_desde,mes_desde into v_aini,v_mini 
from ta_17_adeudos_div where id_conv_resto=v_id and pago_parcial=v_parci;
-- obtiene el periodo de la ultima parcialida
select axo_hasta,mes_hasta into v_afin,v_mfin 
from ta_17_adeudos_div where id_conv_resto=v_id and pago_parcial=v_parcf;

-- verifica el tipo de convenio para la nueva forma (para la nueva forma)
select nvaforma, fecha_inicio into v_nvaforma, v_inicionv from ta_17_catparcnvo where tipo=ptipo;

-- ejecuta el procedimiento de adeudo detalle
foreach
select acumulado into v_acumulado from tmp_totalesconv where referencia=v_parcf 
end foreach;
           
-- valida si el importe pagado es igual al importe adeudo 
if pimpcartera<>v_acumulado then
   return -7,'EL IMPORTE COBRADO ES DIFERENCIA AL IMPORTE ADEUDO';
end if;

-- valida si el importe pagado mas redondeo es igual al importe pagado 
if (pimpcartera+pimpredondeo)<>pimppag then
   return -6,'LA SUMA DE CARTERA Y REDONDEO NO ES EL CERTIFICADO. VERIFICAR';
end if;

BEGIN WORK;
let v_r = 'S';
-- graba la operacion en recibos
let v_concepto='PAGO DE CONVENIO DIVERSOS '||trim(v_subtipo);
let v_descrbo='DATOS DEL CONVENIO '||trim(ptipo)||'-'||trim(psubt)||'-'||trim(plet)||'-'||
                                     trim(pnum)||'-'||paxo||'     ID CONV_RESTO '||v_id;
let v_domicilio=v_calle||' '||v_Exterior||' '||v_interior;
insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,
rfccolonia,obra,axofolio,id_usuario,fecha_act,descripcion,id_centro,foliorecibo) 
values(pfecha,precp,pcaja,pidcobro,pimppag,'P',17,v_id,0,'',v_parci,v_parcf,month(today),year(today),
v_Nombrecompleto,v_domicilio,v_concepto,plet,pnum,psubt,ptipo,paxo,v_iduser,current,v_descrbo,
pcentrop,pfolio);

foreach
select cuenta,descripcion,count(cuenta),sum(monto),sum(acumulado) 
into v_cuentatot,v_conceptodet,v_tcta,v_montotot,v_acumuladotot  
from tmp_totalesconv group by cuenta,descripcion order by cuenta

-- graba detalle de recibo
let v_cont=v_cont+1;
insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
values(pfecha,precp,pcaja,pidcobro,v_cont,v_conceptodet,v_cuentatot,v_montotot);
end foreach;

-- inserta el redondeo
if pimpredondeo<>0 then
   insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
   values(pfecha,precp,pcaja,pidcobro,v_cont+1,'REDONDEO',550800000,pimpredondeo);
end if;

-- afecta los periodos como pagados
select cuenta_recargos,cuenta_intereses into v_ctarec,v_ctaint from ta_17_subtipo_conv
where tipo=ptipo and subtipo=psubt; 

foreach
select referencia,sum(monto) into v_refper,v_montoper  
from tmp_totalesconv where cuenta not in(v_ctarec,v_ctaint)
group by referencia order by referencia

select referencia,nvl(monto,0) into v_refrec,v_montorec
from tmp_totalesconv where referencia=v_refper and cuenta=v_ctarec;
if v_montorec>0 then
   let v_cvevenc=2;
else
   let v_cvevenc=1;
end if;

-- inserta el pago a convenios diversos
insert into ta_17_conv_pagos(id_conv_pago,id_conv_resto,fecha_pago,oficina_pago,caja_pago,operacion_pago,
pago_parcial,total_parciales,importe_pago,importe_recargo,cve_venc,cve_descuento,cve_bonificacion,
id_usuario,fecha_actual) 
values(0,v_id,pfecha,precp,pcaja,pidcobro,v_refper,v_totparc,v_montoper,v_montorec,v_cvevenc,
null,null,v_iduser,current);
let v_status=0;
let v_leyenda1='PAGO APLICADO CORRECTAMENTE';

-- quitar los adeudos
update ta_17_adeudos_div set clave_pago='P' where id_conv_resto=v_id and pago_parcial=trim(v_refper);

-- para afectar el convenio como pagado si es la ultima parcialidad
if v_totparc=v_refper then
   let v_ultima='S';
   if ptipo<>17 then
      execute procedure spd_17_ultimaparc(v_id,0,'P',puser,v_iduser) into v_estultima,v_mensultima;
      if v_estultima <> 0 then
         ROLLBACK WORK;     
         return v_estultima,v_mensultima;
      end if;
   end if;
else
   let v_ultima='N'; 
end if;
end foreach;

if ptipo=1 then
   select sum(monto) into v_gastostmp
   from tmp_totalesconv where cuenta IN(550610001,500015,500016);
   if v_gastostmp is null then
      let v_gastostmp=0;
   end if;
   select sum(monto) into v_multatmp
   from tmp_totalesconv where cuenta in(515001001,500013,500019,500009,500011);
   if v_multatmp is null then
      let v_multatmp=0;
   end if;
   select sum(monto) into v_imprecutmp
   from tmp_totalesconv where cuenta in(150100000,500003);
   if v_imprecutmp is null then
      let v_imprecutmp=0;
   end if;
      select sum(monto) into v_imprecrtmp
   from tmp_totalesconv where cuenta in(150200000,500005);
   if v_imprecrtmp is null then
      let v_imprecrtmp=0;
   end if;

   -- obtiene la referencia de pago
   select  first 1 d.id_referencia into v_idreferencia  
   from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_referencia d
   where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
   and a.numero_exp=pnum and axo_exp=paxo
   and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
   and d.id_conv_resto=b.id_conv_resto;

   -- afecta los periodos en tablas de predial y sus requerimientos
   let v_ur=substr(v_referencia,3,1);
   let v_reccta=substr(v_referencia,1,1); 
   if (v_nvaforma='S') and (v_fecinicio>=v_inicionv) then
      execute procedure catastro_gdl:admin_inspred_22_2021(v_idreferencia,precp,pcaja,pidcobro,pfecha,puser,pimppag,
       v_gastostmp,pimpredondeo,v_parci,v_parcf,v_ur,v_reccta,v_id,v_ultima) into v_statpred,v_menspred;
      if v_statpred <> 0 then
         ROLLBACK WORK;
         return v_statpred,v_menspred;
      end if;
   else
      execute procedure catastro_gdl:admin_inspred_22(v_idreferencia,precp,pcaja,pidcobro,pfecha,puser,pimppag,
       v_gastostmp,v_multatmp,v_imprecutmp,v_imprecrtmp,pimpredondeo,v_aini,v_mini,v_afin,v_mfin,v_ur,v_reccta,v_id) into v_statpred,v_menspred;
      if v_statpred <> 0 then
         ROLLBACK WORK;
         return v_statpred,v_menspred;
      end if; 
   end if;     
else
  if (ptipo=6) and (psubt=1) then

     -- obtiene la referencia
     select first 1 d.id_referencia into v_idreferencia  
     from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_referencia d
     where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
     and a.numero_exp=pnum and axo_exp=paxo
     and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
     and d.id_conv_resto=b.id_conv_resto;

     select c.cuenta_gastos into v_ctagst from ta_17_referencia a,ta_11_locales b,ta_11_mercados c
     where a.id_conv_resto=v_id and b.id_local=a.id_referencia and c.num_mercado_nvo=b.num_mercado; 
 
     select sum(monto) into v_gastostmp
     from tmp_totalesconv where cuenta=v_ctagst;
     if v_gastostmp is null then
        let v_gastostmp=0;
     end if;

     -- afecta los periodos en tablas de mercados y sus requerimientos
     foreach
     execute procedure cajero_afecmerconv(v_idreferencia,v_aini,v_mini,v_afin,v_mfin,
     pfecha,precp,pcaja,pidcobro,'CONV. '||trim(plet)||'/'||trim(pnum)||'/'||trim(paxo),
     v_iduser,'P',v_gastostmp) into v_statmerc,v_mensmerc
     if v_statmerc <= 0 then
        ROLLBACK WORK;
        return v_statmerc,v_mensmerc;
     end if;
     end foreach;
     -- verifica si tiene descuento en recargos.
     select nvl(porcentaje,0),axofin,mesfin into v_porcdescrec,v_axofd,v_mesfd from ta_11_descrec where id_local=v_idreferencia
     and vigencia='V' and fecha_baja is null;
     if v_porcdescrec is null then
        let v_porcdescrec=0;
     end if;
     -- afecta como pagado el descuento de recargos
     if  v_porcdescrec>0 then
         execute procedure sp_desctomerc(v_idreferencia,v_axofd,v_mesfd,3,0,pfecha,precp,pcaja,pidcobro,11) into v_descuento,v_mensaje;
     end if;
  else
  if ptipo=13 then
     -- obtiene la referencia
     select first 1 d.id_referencia into v_idreferencia  
     from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_referencia d
     where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet and a.numero_exp=pnum 
     and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver and d.id_conv_resto=b.id_conv_resto; 

     select sum(monto) into v_gastostmp from tmp_totalesconv where cuenta=992104009;
     if v_gastostmp is null then
        let v_gastostmp=0;
     end if;
     
     if v_gastostmp >0 then
        let v_cvegst='S';
     else
        let v_cvegst='N';
     end if;

     execute procedure sp16_ConvPago(v_idreferencia,v_aini,v_mini,v_afin,v_mfin,v_cvegst,
     pidcobro,trim(plet)||'/'||trim(pnum)||'/'||trim(paxo),pfecha,precp,pcaja,puser) into v_statmerc,v_mensmerc;
     if v_statmerc <> 0 then
        ROLLBACK WORK;
        return v_statmerc,v_mensmerc;
     end if;
  else
  if (ptipo=19) and (psubt=1) then
     -- obtiene la referencia
     select first 1 d.id_referencia into v_idreferencia  
     from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_referencia d
     where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet and a.numero_exp=pnum 
     and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver and d.id_conv_resto=b.id_conv_resto; 

     select sum(monto) into v_gastostmp from tmp_totalesconv where cuenta=992109009;
     if v_gastostmp is null then
        let v_gastostmp=0;
     end if;
     
     if v_gastostmp >0 then
        let v_cvegst='S';
     else
        let v_cvegst='N';
     end if;

     execute procedure dbestacion:sp24_ConvPago(v_idreferencia,v_aini,v_mini,v_afin,v_mfin,v_cvegst,
     pidcobro,trim(plet)||'/'||trim(pnum)||'/'||trim(paxo),pfecha,precp,pcaja,puser,'C') into v_statmerc,v_mensmerc;
     if v_statmerc <> 0 then
        ROLLBACK WORK;
        return v_statmerc,v_mensmerc;
     end if;
  else
  if (ptipo=19) and (psubt=2) then
     -- obtiene la referencia
     select first 1 d.id_referencia into v_idreferencia  
     from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_referencia d
     where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet and a.numero_exp=pnum 
     and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver and d.id_conv_resto=b.id_conv_resto; 

     select sum(monto) into v_gastostmp from tmp_totalesconv where cuenta=992109010;
     if v_gastostmp is null then
        let v_gastostmp=0;
     end if;
     
     if v_gastostmp >0 then
        let v_cvegst='S';
     else
        let v_cvegst='N';
     end if;

     execute procedure dbestacion:sp28_ConvPago(v_idreferencia,v_aini,v_mini,v_afin,v_mfin,v_cvegst,
     pidcobro,trim(plet)||'/'||trim(pnum)||'/'||trim(paxo),pfecha,precp,pcaja,puser,'C') into v_statmerc,v_mensmerc;
     if v_statmerc <> 0 then
        ROLLBACK WORK;
        return v_statmerc,v_mensmerc;
     end if;
  end if;
  end if;    
  end if;
  end if;
end if;

-- borrar tabla temporal 
delete from tmp_totalesconv;
COMMIT WORK;

return v_status,v_leyenda1;
--trace off;
end function;

CREATE FUNCTION "informix".admin_cancela_22(pidcobro integer,pfolio varchar(30),puser varchar(10))

{######################################################################
#  Procedimiento:    admin_pago_22
#  Descripcion:      Interfaz de cancelacion del pago de Convenios diversos para ADMIN
#
#  Parametros        pidcobro = numero de operacion de admin
#  de entrada:       pfolio   = folio de recibo admin
#                    puser    = usuario que cancela
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            04 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}

returning   int as estatus,
            varchar(255) as leyenda;

define v_leyenda,v_mensmerc    	varchar(255);
define v_estatus,v_statmerc,v_ultima,v_estultima,v_cnum,v_caxo 	int;
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo    int;
define v_id,v_cvecuenta   int;
define v_cvepagorbo       CHAR(1);
define v_axo,v_id_rec_cta,v_col,v_obra int;
define v_mes,v_iduser,varpar int;
define v_adeudo_id,v_cvecanc int;
define v_res,v_dsd,v_hst int; 
define v_res1,v_mensultima varchar(100);
define v_resto,v_idref,v_pagpar,v_axod,v_mesd,v_axoh,v_mesh,v_cta int;
define v_importe money(14,2);
define v_clet char(3);
define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en cancelacion de Convenios diversos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Convenio obra publica)
if NOT exists (select * from ta_12_recibos where operacion = pidcobro and trim(foliorecibo)=trim(pfolio)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago,id_rec_cta,rfccolonia,obra,mesdesde,axodesde,rfcini,rfcnumero,axofolio 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_id,v_id_modulo,v_cvepagorbo,v_id_rec_cta,v_col,v_obra,v_dsd,v_hst,v_clet,v_cnum,v_caxo
from ta_12_recibos where operacion = pidcobro and trim(foliorecibo)=trim(pfolio);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 17 then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DIVERSOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

if (v_id_modulo = 17) and (v_id_rec_cta in (16,15,11)) then
   let v_leyenda = 'EL RECIBO NO ES POR CONVENIOS DIVERSOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

-- obtiene la ultima parcialidad del convenio mov.8/12/2014
select nvl(max(pago_parcial),0) into v_ultima from ta_17_adeudos_div where id_conv_resto=v_id;

-- VALIDACION DE TENER UN CERTIFICADO DE NO ADEUDO DENTRO DE EL PERIODO PAGADO EN CONVENIO
if v_obra=1  then
   if exists (select * from catastro_gdl:pagos where recaud = v_rec_pag and caja= v_caja_pag 
              and fecha=v_fecha_pag and folio = pidcobro) then
      select cvepago,cvecuenta into v_cvepago,v_cvecuenta from catastro_gdl:pagos where recaud = v_rec_pag and 
      caja= v_caja_pag and fecha=v_fecha_pag and folio=pidcobro;
      if v_cvepago > 0 then
         select COUNT(A.CVECUENTA) INTO V_CONTAR_CVECUENTA 
         from catastro_gdl:noadeudo a,catastro_gdl:pagos p,catastro_gdl:imprecpre i
         where p.cvecuenta= v_cvecuenta and p.cvepago=v_cvepago and a.cvecuenta=p.cvecuenta
         and i.cvepago=p.cvepago and a.axo=i.axopago and a.bimestre <= i.bimfin
         and a.cvepago > p.cvepago and a.cvepago not in (select cvepago from catastro_gdl:pagos 
         where cvecuenta=v_cvecuenta and cvepago > v_cvepago and cveconcepto=3 and cvecanc is not null);
         if V_CONTAR_CVECUENTA > 0 THEN
            let v_leyenda = 'LA CUENTA PREDIAL TIENE UN CERTIFICADO DE NO ADEUDO DENTRO DEL PERIODO CONVENIADO A CANCELAR';
            let v_estatus = 3;
            RETURN v_estatus,v_leyenda;
         end if;
      end if;
   end if;
end if;

BEGIN WORK;
-- cancela recibo
update ta_12_recibos set cvepago='C', fecha_act=today,id_usuario=v_iduser 
where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and 
operacion = pidcobro and trim(foliorecibo)=trim(pfolio);

foreach
select pago_parcial into varpar from  ta_17_conv_pagos 
where fecha_pago=v_fecha_pag and oficina_pago=v_rec_pag and caja_pago=v_caja_pag 
and operacion_pago=pidcobro and id_conv_resto=v_id

-- deja vigentes las parcialidades
update ta_17_adeudos_div set clave_pago =null
where  id_conv_resto=v_id and pago_parcial=varpar;
end foreach;

-- borra los pagos 
delete from ta_17_conv_pagos where  fecha_pago=v_fecha_pag and oficina_pago=v_rec_pag 
and caja_pago=v_caja_pag and operacion_pago=pidcobro and id_conv_resto=v_id;

-- reactiva convenio si es ultima parcialidad
if v_hst=v_ultima then
   execute procedure spd_17_ultimaparc(v_id,0,'C',puser,v_iduser) into v_estultima,v_mensultima;
   if v_estultima <> 0 then
      ROLLBACK WORK;     
      return v_estultima,v_mensultima;
   end if; 
end if;

if v_obra=1 then -- si es predial 
   -- inserta cancelacion
   insert into catastro_gdl:pagoscan (cvecanc,cvepago,autorizo,fechacan ) values (0,v_cvepago,puser,today);
   let v_cvecanc = dbinfo("sqlca.sqlerrd1"); 
   -- solo para predial pone enceros la recargos pagados, multa pagada y actualizacion pagada en ceros en conv_saldos y detsaldos
   execute procedure catastro_gdl:canc_accesorios_conv(v_cvepago);
   -- cancela el pago en tabla referencia
   update ta_12_referencias set ref_cancelado=v_cvecanc where referencia_p=v_cvepago;  
   -- deja el saldo de parcialida anterior a saldo por aplicar
   update ta_17_adeudos_div set saldoaplicar=saldopagoant  where id_conv_resto=v_id;
end if;

if (v_obra=6) and (v_col=1) then -- si es mercados
   foreach
   select a.id_conv_resto,a.id_referencia,b.pago_parcial,b.axo_desde,b.mes_desde,
   b.axo_hasta,b.mes_hasta,nvl(d.cuenta_apl,0),nvl(d.importe,0) into
   v_resto,v_idref,v_pagpar,v_axod,v_mesd,v_axoh,v_mesh,v_cta,v_importe
   from ta_17_referencia a,ta_17_adeudos_div b,outer ta_17_desg_parcial d 
   where a.id_conv_resto=v_id and b.id_conv_resto=a.id_conv_resto and (b.pago_parcial between v_dsd and v_hst)
   and d.id_adeudo=b.id_adeudo and d.cuenta_apl=550620004 order by b.pago_parcial
   if v_importe is null then
      let v_importe=0;
   end if;
     -- restaura las mensualidades de mercados 
     foreach
     execute procedure cajero_afecmerconv(v_idref,v_axod,v_mesd,v_axoh,v_mesh,
     v_fecha_pag,v_rec_pag,v_caja_pag,pidcobro,'',v_iduser,'C',v_importe) into v_statmerc,v_mensmerc
     if v_statmerc <= 0 then
        return v_statmerc,v_mensmerc;
        ROLLBACK WORK;
     end if;
     end foreach;
   end foreach;
end if;

if v_obra=13 then -- si es aseo contratado
   -- ejecuta cancelacion
   execute procedure sp16_ConvCancela(pidcobro,(trim(v_clet)||'/'||v_cnum||'/'||v_caxo),puser) into v_statmerc,v_mensmerc;
   if v_statmerc <> 0 then
      ROLLBACK WORK;
      return v_statmerc,v_mensmerc;
   end if;
end if;

if (v_obra=19) and (v_col=1) then -- si es estacionamiento publico
   -- ejecuta cancelacion
   execute procedure dbestacion:sp24_ConvCancela(pidcobro,pfolio,puser) into v_statmerc,v_mensmerc;
   if v_statmerc <> 0 then
      ROLLBACK WORK;
      return v_statmerc,v_mensmerc;
   end if;
end if;

if (v_obra=19) and (v_col=2) then -- si es estacionamiento exclusivo
   -- ejecuta cancelacion
   execute procedure dbestacion:sp28_ConvCancela(pidcobro,pfolio,puser) into v_statmerc,v_mensmerc;
   if v_statmerc <> 0 then
      ROLLBACK WORK;
      return v_statmerc,v_mensmerc;
   end if;
end if;

COMMIT WORK; 

return v_estatus,v_leyenda;
end FUNCTION;

CREATE FUNCTION "informix".admin_adeudos_detalle_14odoox(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10),p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10), p_Apagar char(20))
                returning  int as sNoRubro, int as sNoConcepto, int as sCuenta_aplicacion,
                varchar(50) as sreferencia1, varchar(50) as sDescripcion, dec(14,2) as sMonto, dec(14,2) as sAcumulado;


define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_mon  integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_actualizacion  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define var_cem char(1);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_vigencia CHAR(1);
define  v_imptot money(15,2);
define  v_impmonto money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  var_axo    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define v_ctaapl3     int;
define v_ctaapl4     int;
define v_ctaapl5     int;
define v_ctaapli     int;
define v_ctaaplr     int;
define v_ctaapldi     int;
define v_ctaapldr     int;
define  v_acumula     money(15,2);
define v_ctaapl_act money(15,2);



let v_axo=year(today);
let v_mes=month(today);
let v_obs ='';
let v_impmonto = 0;
let v_desctot  = 0;
let v_axo_mon  = 0;
let v_acumula  = 0;

let v_control= p_segmento1;
let var_axo= nvl((p_Apagar),0);
let v_imptot=0;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   return 0,0,0,' ',' ',0,0; 
end if;      

select cementerio,axo_pagado,vigencia
into  v_cementerio,v_axo_pagado,v_vigencia
from ta_13_datosrcm where control_rcm=v_control;

select  cta_aplicacion, cta_vencido, cta_descto,cta_desctopens,cta_desctopens_rez ,cta_actualizacion
into v_ctaapl1, v_ctaapl2 , v_ctaapl3 ,v_ctaapl4, v_ctaapl5, v_ctaapl_act
from tc_13_cementerios where cementerio=v_cementerio;

if v_axo_pagado=v_axo  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if v_vigencia='B'  then
   return 0,0,0,' ',' ',0,0; 
end if;     

if not exists(select * from tmp_cem_norecgos where control_rcm = v_control) then
    if (v_axo_pagado + 1) < (v_axo - 5) then
        let v_axodesde = v_axo - 5;
    else
        let v_axodesde = v_axo_pagado + 1;
    end if;
else
    let v_axodesde = v_axo_pagado + 1;
end if;

if v_axo<>var_axo then
   let v_axo=var_axo;
end if;

    let v_desctot = 0;
    let v_desctotre = 0;

if v_imptot>0 then
foreach 
    select b.axo_adeudo, (b.importe+b.importe_recargos) - (b.descto_impote+ b.descto_recargos)
          into vpar_axo, vpar_impte
           from ta_13_adeudosrcm b where  b.control_rcm=v_control and b.axo_adeudo between v_axodesde and v_axo
          order by 1
    let v_impmonto = v_impmonto + vpar_impte;
    if  v_impmonto <= v_imptot then
        let v_axo_mon =  vpar_axo; 
    end if;
end foreach;
   let v_axo=v_axo_mon;
end if;

foreach 
    select b.axo_adeudo,b.importe,b.importe_recargos, nvl(d.descuento,0),b.descto_impote, b.descto_recargos,nvl(b.actualizacion,0)
          into vpar_axo,vpar_impte, vpar_recar , v_descuento,v_impdesc,v_recardesc,v_actualizacion     
           from ta_13_adeudosrcm b, ta_13_datosrcm r,outer ta_13_descpens d where r.control_rcm=v_control and
           d.control_rcm=r.control_rcm and d.axo_descto=b.axo_adeudo and d.vigencia='V' and  b.vigencia='V' and
           b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and v_axo
          order by 1

    if  v_descuento <> 0 then   
        if vpar_axo < v_axo then
           let v_ctaapldi=v_ctaapl5; --rezago pensionado
        else
           let v_ctaapldi=v_ctaapl4;
	end if;
        let v_desctot  = v_desctot  + v_impdesc;
           let v_obs = 'INCLUYE DESC. '||v_descuento||'% POR PENSIONADO'; 
    else
           let v_obs = ''; 
     end if;
     let v_desctotre  =  v_recardesc;
     if ((v_mes >= 1)  and (v_mes <=2) and (vpar_axo=year(today))) then
        if v_impdesc=0 then
          let v_desctot  =v_desctot+ trunc(((vpar_impte-v_impdesc) * 0.1),2);
          let v_ctaapldi=v_ctaapl3;
          if  v_obs = '' then
             let v_obs = v_obs || 'INCLUYE DESC. 10% POR PRONTO PAGO'; 
          else
              let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
          end if;
          end if;
     end if;
--eliminar despues de pago por web
     if ((vpar_axo=2021) and v_control in (
55723,
95936,
76052,
19024,
31240,
51746,
95756,
107442,
51300,
119487,
20694,
26690,
99173)) then
        if v_impdesc=0 then
          let v_desctot  =v_desctot+ trunc(((vpar_impte-v_impdesc) * 0.1),2);
          let v_ctaapldi=v_ctaapl3;
          if  v_obs = '' then
             let v_obs = v_obs || 'INCLUYE DESC. 10% POR PRONTO PAGO'; 
          else
              let v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
          end if;
          end if;
     end if;
---<--eliminar


     if vpar_axo=year(today) then
        let v_ctaapli=v_ctaapl1;
     else
        let v_ctaapli=v_ctaapl2;
     end if;   
     if vpar_recar>0 then
        let v_ctaaplr=390300000;
     end if;   
     if v_desctot>0 then
--        let v_ctaapldi=v_ctaapl3;
        let v_desctot= v_desctot * -1;
     end if;   
     if v_desctotre>0 then
        let v_ctaapldr=390340000;
        let v_desctotre= v_desctotre* -1;
     end if;   

  let v_acumula=v_acumula +vpar_impte;
  return 0,v_ctaapli, get_odoo_cta( v_ctaapli , 14) , vpar_axo, 'Mantenimiento' ||vpar_axo,  vpar_impte, v_acumula with resume;

  if  v_desctot <>0 then
     let v_acumula= v_acumula + v_desctot;

     if v_acumula > 0 then
        return 0,v_ctaapldi, get_odoo_cta( v_ctaapldi , 14),vpar_axo, v_obs || vpar_axo,   (v_desctot ), v_acumula with resume;
     else
        return 0,413921, 413921,vpar_axo, v_obs || vpar_axo,   (v_desctot ), v_acumula with resume;
     end if;

     let v_desctot=0;
  end if;
  if vpar_recar>0 then
     let v_acumula=v_acumula+vpar_recar;
  return 0,v_ctaaplr, get_odoo_cta( v_ctaaplr , 14),vpar_axo , 'Recargos ' || vpar_axo , vpar_recar, v_acumula with resume;
  end if;
  if v_desctotre <>0 then
     let v_acumula=v_acumula + v_desctotre;
  return 0,v_ctaapldr , get_odoo_cta( v_ctaapldr , 14), vpar_axo, v_obs||'Descto Recarg ' || vpar_axo,  v_desctotre , v_acumula with resume;
  end if;
  if v_actualizacion <>0 then
     let v_acumula=v_acumula + v_actualizacion;
  return 0,v_ctaapl_act , get_odoo_cta( v_ctaapl_act , 14), vpar_axo, v_obs||'Actualizacion ' || vpar_axo,  v_actualizacion , v_acumula with resume;
  end if;

end foreach;
end function;

create function "pgcabrer".del34_masiva_contratos(pcve_tab Char(1), pAxo_Fin int, pMes_Fin int, p_usuario char(10)) 
returning  int as estado,
           varchar(100) as mensaje;

define vestado, vid_34_datos, v_id_34_stat_c, v_id_34_stat_cc, v_id_34_stat_ac, v_id_34_stat_pc  int;
define vmsg varchar(100);
define vcontrol varchar(10);
define vsanitario int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion del34_masiva_contratos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION
 
foreach
   select id_34_datos, control into vid_34_datos, vcontrol from t34_datos where cve_tab=pcve_tab and id_stat=10 

   -- CANCELAR CONCESION/CONTRATO
   SELECT id_34_stat  INTO  v_id_34_stat_c  from t34_status where cve_tab = pcve_tab and cve_stat = 'C' ;
   UPDATE t34_datos SET fecha_fin = mdy( pMes_Fin,01,pAxo_Fin), fecha_cancelacion = Today, usuario = p_usuario, 
     id_stat = v_id_34_stat_c Where id_34_datos = vid_34_datos;

   -- CANCELAR CONCEPTOS
   SELECT id_34_stat  INTO  v_id_34_stat_cc  from t34_status where cve_tab = 'D' and cve_stat = 'C';
   UPDATE t34_conceptos SET usuario = p_usuario, id_stat = v_id_34_stat_cc Where id_datos = vid_34_datos;

   -- CANCELAR ADICIONALES
   SELECT id_34_stat  INTO  v_id_34_stat_ac  from t34_status where cve_tab = 'C' and cve_stat = 'C';
   UPDATE t34_adicionales SET usuario = p_usuario, id_stat = v_id_34_stat_ac Where id_datos = vid_34_datos;

   -- CANCELAR ADEUDOS
   SELECT id_34_stat  INTO  v_id_34_stat_pc  from t34_status where cve_tab = 'E' and cve_stat = 'C';
   UPDATE t34_pagos SET usuario = p_usuario, id_stat = v_id_34_stat_pc
   WHERE id_datos = vid_34_datos  AND periodo >= pAxo_Fin || '-' || pMes_Fin  AND  id_stat <> v_id_34_stat_pc;

   -- AGREGAR AL NUMERO DE SANITARIO 1000
   let vsanitario=0;
   let vsanitario=substr(trim(vcontrol),4,2);
   let vsanitario=1000+vsanitario;
   UPDATE t34_datos SET control='SP/'||vsanitario Where id_34_datos = vid_34_datos;
end foreach;

Let vmsg = 'La CONCESION/CONTRATO, CONCEPTOS, ADICIONALES y los ADEUDOS han sido CANCELADOS';
Let vestado = 0;

RETURN  vestado, vmsg;

end function;

CREATE FUNCTION "informix".linea_capturagral2
(p_modulo int, p_cuentaid int, p_monto decimal(18,2), p_desde varchar(3), p_hasta varchar(3), p_vencimiento date)

    /********************************************************************
    * PAR�METROS:
    *   p_modulo: Id de m�dulos  14 -> Cementerios
    *   p_cuentaid: Identificador de la cuenta a generar la linea
    *   p_monto: monto por el cual se genera la l�nea de captura
    *   p_desde: 3 digitos bimestre/a�o (dos d�gitos) 121
    *   p_hasta: 3 digitos bimestre/a�o (dos d�gitos) 621
    ********************************************************************/
    returning varchar(50) as linea;

    define linea1 varchar(50);
    define resultado varchar(110);
    define v_id int;
    define v_axobase int;
    define fecha int;
    define fecha_st char(5);
    define fechax date;
    define v_codigo1 varchar(20);
    define v1_7 smallint;
    define v1_3 smallint;
    define v1_1 smallint;
    define vt1    int;
    define v2_11 smallint;
    define v2_13 smallint;
    define v2_17 smallint;
    define v2_19 smallint;
    define v2_23 smallint;
    define vt2    int;
    define i int;

    -- Inicializamos variables...
    let v_axobase = 2013;

    select max(lc.linea) into linea1
    from lineas_captura lc
    where lc.modulo = p_modulo and lc.id_cuenta = p_cuentaid
        and lc.monto = p_monto and lc.vigencia >= today;

    if linea1 is null then
        -- ************ No existe Linea, la generamos...
        let linea1 = lpad(p_cuentaid, 6, '0') || lpad(p_desde,3,'0') || lpad(p_hasta, 3, '0');

        insert into lineas_captura(id, modulo, id_cuenta, fecha, monto, desde, hasta, vigencia, linea) 
	    values(0, p_modulo, p_cuentaid, today, p_monto, p_desde, p_hasta, p_vencimiento, linea1);

        let v_id = dbinfo("sqlca.sqlerrd1");

        let linea1 = linea1|| lpad(v_id, 6, '0');

        let linea1 = linea1 || lpad(p_modulo, 2, '0'); --pago de modulo

        -- Codificamos fecha *********************
        let fechax = p_vencimiento;

        let fecha = (((year(fechax) - v_axobase) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1)) + 10000;  
        let fecha_st = '' || fecha;

        let linea1 = linea1 || fecha_st[2,5];

        -- Calculamos digito verificador del importe
        let v_codigo1 = trunc(p_monto*100) ;
        let vt1 = 0;

        for i = length(v_codigo1) to 1 step -3
            let v1_7 = 0;
            let v1_3 = 0;
            let v1_1 = 0;

            if i >= 1 then
                let v1_7 = substr(v_codigo1,i , 1)  * 7;
            end if;
            
            if i >= 2 then
                let v1_3 = substr(v_codigo1,(i -1) , 1)  * 3;
            end if;

            if i >= 3 then
                let v1_1 = substr(v_codigo1,(i -2), 1)  * 1;
            end if;

            let  vt1 = vt1+ v1_7 + v1_3 + v1_1;

        end for;

        let vt1 = mod(vt1,10);
        let linea1 = linea1 || vt1;

        -- Controles, validar fecha e importe ******
        let linea1 = linea1 || '2'; -- El 2 valida fecha e importe

        -- Control General - Digito Verificador final ******************************
        let vt2 = 0;

        for i =   length(linea1) to 1 step -5
            let v2_11 = 0;
            let v2_13 = 0;
            let v2_17 = 0;
            let v2_19 = 0;
            let v2_23 = 0;

            if i >= 1 then
                let v2_11 = substr(linea1,i , 1)  * 11;
            end if;
            
            if i >= 2 then
                let v2_13 = substr(linea1,(i -1) , 1)  * 13;
            end if;
            
            if i >= 3 then
                let v2_17 = substr(linea1,(i -2), 1)  * 17;
            end if;
            
            if i >= 4 then
                let v2_19 = substr(linea1,(i -3), 1)  * 19;
            end if;  
            
            if i >= 5 then
                let v2_23 = substr(linea1,(i -4), 1)  * 23;
            end if;
            
            let  vt2 = vt2+ v2_11 + v2_13 + v2_17 + v2_19 + v2_23;
        end for;

        let vt2 = mod(vt2,97) +1;
        
        let linea1 = linea1 || lpad(vt2, 2, '0');
        
        -- Actualizamos la tabla con la linea actualizada...
        update lineas_captura set
            linea = linea1
        where id = v_id;    
    end if;

    return linea1; 

end function;

CREATE FUNCTION "informix".tmp_getlineas()
	 returning int as folio, varchar(30) as cuenta, varchar(32) as linea, date as vencimiento;
     
     define v_folio int;
     define v_cuenta varchar(30);
     define v_linea varchar(32);
     define v_vence date;

     foreach  
     select first 50 t.folio, (cc.recaud||'-'|| cc.urbrus||'-'|| cc.cuenta) cuenta_predial, today+30 vencimiento   
        into v_folio, v_cuenta, v_vence
     from actostransm t 
        inner join convcta cc on (cc.cvecuenta = t.cvecuenta)
     where t.status = 'Z' 
        -- Calculamos linea de captura
        execute procedure db_ingresos:linea_capturagral2(15, v_folio, 1, '000','000',today+30) into v_linea;

        return v_folio, v_cuenta, v_linea, v_vence with resume;
     end foreach;

END FUNCTION
;

create procedure "pgcabrer".sp34_adeudototal( par_Tabla Char(2), pref varchar(20))
returning   int as id_datos,
            varchar(10) as control,
            varchar(100) as nombre,
            decimal(10,2) as superficie,
            varchar(20) as periodos,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as desc_recargos,
            money(18,2) as multa,
            money(18,2) as desc_multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as forma,
            money(18,2) as autorizacion,
            money(18,2) as total,
            varchar(100) as ubicacion,
            varchar(100) as tipo;

define v_id_datos, v_cuenta, v_id_stat, v_id_stat_pago int;
define v_control varchar(10);
define v_periodos varchar(20);
define v_nombre, v_ubicacion, v_tipo, v_referencia varchar(100);
define v_superficie decimal(10,2);
define v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total, v_monto, v_desc_rec, v_desc_mul money(18,2);
define v_forma, v_autorizacion money(18,2);
define v_ref char(7);

if trim(pref)='' then
   let v_ref=year(today) || '-' || 12;
else
   let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;

-- obtiene el status vigente del contrato
select id_34_stat into v_id_stat from t34_status where cve_tab=par_Tabla and cve_stat='V';
-- obtiene el status vigente del adeudo
select id_34_stat into v_id_stat_pago from t34_status where cve_tab='E' and cve_stat='V';

foreach
  -- selecciona los contratos vigentes
  select a.id_34_datos,trim(a.control), trim(a.concesionario), a.superficie, trim(b.concepto), trim(t.nombre) 
   into v_id_datos, v_control, v_nombre, v_superficie, v_ubicacion, v_tipo
  from t34_datos a, t34_conceptos b, t34_tablas t
  where a.cve_tab=par_Tabla and a.id_stat=v_id_stat and b.tipo='N' and t.cve_tab=a.cve_tab and b.id_datos=a.id_34_datos 

    let v_adeudo=0; 
    let v_recargos=0;
    let v_desc_rec=0;
    let v_multa=0;
    let v_desc_mul=0;
    let v_actualizacion=0;
    let v_gastos=0;
    let v_forma=0;
    let v_autorizacion=0;
    let v_total=0;
    let v_periodos='';

  -- ejecuta el procedimiento de totales
  foreach
    execute PROCEDURE admin_adeudos_detalle_25_tot ( par_Tabla, v_control, v_ref ) into v_cuenta, v_referencia, v_monto

    if (trim(v_referencia)='ADEUDO ACTUAL') or (trim(v_referencia)='ADEUDO REZAGO') then let v_adeudo=v_adeudo+v_monto; 
    else if trim(v_referencia)='RCGO. ADEUDO' then let v_recargos=v_monto;
    else if trim(v_referencia)='DSCTO. RECARGO' then let v_desc_rec=v_monto;
    else if trim(v_referencia)='MULTAS' then let v_multa=v_monto;
    else if trim(v_referencia)='DSCTO. MULTAS' then let v_desc_mul=v_monto;
    else if trim(v_referencia)='ACTUALIZACION' then let v_actualizacion=v_monto;
    else if trim(v_referencia)='GASTOS' then let v_gastos=v_monto;
    else if trim(v_referencia)='FORMA' then let v_forma=v_monto;
    else if trim(v_referencia)='AUTORIZACION ACTUAL' then let v_autorizacion=v_monto;
    else if trim(v_referencia)='TOTAL ADEUDO' then let v_total=v_monto; 
    end if; end if; end if; end if; end if; end if; end if; end if; end if; end if;

  end foreach;
  -- obtiene los periodos de adeudo
  select min(periodo)||' al '||max(periodo) into v_periodos from t34_pagos where id_datos=v_id_datos and id_stat=v_id_stat_pago and periodo<=v_ref;
  if v_adeudo > 0 then
     return v_id_datos, v_control, v_nombre, v_superficie, v_periodos, v_adeudo, v_recargos, v_desc_rec, v_multa, v_desc_mul,
         v_actualizacion, v_gastos, v_forma, v_autorizacion, v_total, v_ubicacion, v_tipo with resume;
  end if;
end foreach;

end procedure;

CREATE FUNCTION "informix".spd_redondeokiosco(importe money(15,2))
           returning integer,money(5,2);
define entero money(15,2);
define dife money(15,2);
define redondeo money(15,2);
define cuenta integer;
define ajuste money(5,2);
let cuenta=0;
let ajuste=0;
let  entero=trunc(importe);
let dife=importe - entero;
--    dife:=StrToCurr(CurrToStr(dife));
    if dife > 0 then
            if ((dife > 0.00) and (dife <= 0.50)) then
               let redondeo = entero;
            end if;
            if ((dife > 0.50) and (dife < 1.00)) then
              let redondeo =  (entero + 1);
            end if;
    else
              let redondeo = importe;
    end if;

let ajuste = redondeo-importe;
if ajuste<>0 then
   if ajuste>0.00 then
      let cuenta = 550800000;
   else
      let cuenta =550800000;
   end if;
end if;
return cuenta,ajuste;
end function;

CREATE PROCEDURE "pgcabrer".spd_adeudomerctot(p_mesh smallint,p_axoh smallint)	

returning  	int as merc,   
        	money(15,2) as adeudo, 
        	money(15,2) as recargos, 
        	money(15,2) as multa,
        	money(15,2) as gastos,
        	money(15,2) as actualizacion,
        	money(15,2) as total,
        	char(30) as mercado;

define v_estatus smallint;
define v_id_local,v_id,vid,p_licencia,p_idlicencia,p_bloqueado,p_idgiro,v_idgiro integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra1,v_let char(3);
define p_vigente char(1); 
define v_bloque1,v_blq char(2);
define v_dillic,v_dilloc char(1);
define v_nombre,p_txtbloqueado char(30);
define v_domicilio char(40);
define v_adicional,v_aprloc,v_aprlic char(20);
define v_superficie decimal(10,2);
define v_adeudo money(15,2);
define v_recargos,vactualizacion money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_actualizacion money(15,2);
define v_descuento,v_renta,v_ade money(15,2);
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_folio integer;
define v_per smallint;
define v_aid_local,v_follic,v_folloc integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec, v_fecha_alta date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp,v_lic integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo,v_merc,v_mer smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc,v_cvecuo integer;
define v_total money(15,2);
define v_cat,v_ofna smallint;
define v_sec char(2);
define v_loc,v_idlic integer;
define v_licencia,v_licdesc char(200);
define p_actividad varchar(130);
define p_propietario, t_leyenda varchar(80);
define p_giro,v_giro varchar(96);
define t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, t_desc_recargos, t_rec_apagar money(18,2);
define t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total money(18,2);
define t_axo, t_mes int;
define vpropietario varchar(92);
define vcalle varchar(80);
define vnumext,vnumint varchar(10);
define vrecaudadora,vzona,vaxo_desde_ade,vmes_desde_ade int;
define vderechos,vanuncios,vimpresos,vrecargos,vmultas,vgastos,vtotal,vfvlicencias,vfvanuncios,vactualizacion_anun dec(14,2);

let v_axocalc=0; 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_nom_mercado='';
let v_estatus=0;
let v_descripcion='';
let v_licencia='';
let v_renta=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_merc=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_mesmin=0;
let v_axomin=0;
let v_idlic=0;
let p_idgiro=0;

begin
    on exception in (-958)
       delete from locales;
    end exception;
create temp table locales( 
 tid_local  	integer,		--
 tofna		smallint,
 tmerc		smallint,
 tcat		smallint,
 tsec		char(2),
 tlocal		integer,
 tletra		char(3),
 tbloq		char(2),
 tmesdesde	smallint,		-- 
 taxodesde	smallint,		-- 
 tmeshasta	smallint,		-- 
 taxohasta	smallint,		--
 tnombre	char(30),		-- 
 tdomicilio	char(40),		--
 tadicional	char(20),  	-- 
 tsuperficie	decimal(10,2),	-- 
 tadeudo	money(15,2),	-- 
 trecargos	money(15,2),	-- 
 tmulta	money(15,2),	--
 tgastos	money(15,2),	--
 tactualizacion money(15,2),
 ttotal	money(15,2),	--
 tdescuento	money(15,2),	-- 
 tnombremercado	char(30),		--
 testatus		smallint,		--
 tmensaje	char(60),
 tlicencia char(200),
 treqlocal varchar(20),
 treqlic varchar(20),
 tidgiro int,
 tgiro varchar(100),
 tfalta date,
 trenta money(15,2))  with no log;		--
end;

    -- obtiene los datos generales
foreach
         select c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
         c.num_mercado,c.fecha_alta,c.clave_cuota,c.oficina,num_mercado,c.categoria,seccion,local,letra_local,bloque, sum(a.importe)
         into v_id_local,v_desc,v_nombre,v_domicilio,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado,v_merc,v_fecha_alta,v_cvecuo,
              v_ofna,v_mer,v_cat,v_sec,v_loc,v_let,v_blq,v_ade
         from    ta_11_locales c,ta_11_mercados e, ta_11_adeudo_local a
         where c.vigencia='A' and (a.axo<p_axoh  or (a.periodo<=p_mesh and a.axo=p_axoh))
         and a.id_local=c.id_local and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado
         group by c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
         c.num_mercado,c.fecha_alta,c.clave_cuota,num_mercado,c.oficina,num_mercado,c.categoria,seccion,local,letra_local,bloque
         order by c.oficina,num_mercado,c.categoria,seccion,local,letra_local,bloque

    --     if v_desc is null then
    --        let v_desc=0;
    --     end if;

    --     if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and ((axo=p_axoh and periodo<=p_mesh) or (axo<p_axoh))) then 	
    --        let v_estatus=5;
    --        let v_descripcion='LOCAL AL CORRIENTE DE PAGOS';
    --     else 
            let v_recacum=0;
 
         -- para sacar el a�o minimo
         if v_merc=70 then
            select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local and axo>2016;
         else
            select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;
         end if;

         -- para sacar el mes minimo
         select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

         -- calcula la renta
        -- execute procedure spd_11_calc_renta(year(today),v_cat,v_sec,v_cvecuo,v_superficie,v_mer,1) into v_renta;

         -- ejecuta tabla de detalle para generar tabla temporal
         foreach
           execute function spd_11_adeudodetalle(v_id_local) into t_axo, t_mes, t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, 
           t_desc_recargos, t_rec_apagar, t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total, t_leyenda
         end foreach;

         -- totales de tabla temporal  
         select sum(adeudo), sum(rec_apagar), max(mul_apagar), max(gastos), sum(actualizacion),
               (sum(adeudo)+sum(rec_apagar)+max(mul_apagar)+max(gastos)+sum(actualizacion)),
           nvl((select min(axo) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) )),0),
           nvl((select min(mes) from tmp_adeudomerc where axo=(select min(axo) from tmp_adeudomerc 
             where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) ))),0),
           nvl((select Max(axo) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) )),0),
           nvl((select max(mes) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) ) 
             and axo=(select Max(axo) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) ))),0)
         into v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axomin, v_mesmin, v_axohst, v_meshst 
         from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) );

         if v_adeudo>0 then 
            let v_estatus=0;
         else
            let v_estatus=5;      
         end if;
   --     end if;

     -- agrega las not y req de locales 4/08/2014
     let v_aprloc='';
     foreach
     select diligencia,nvl(count(*),0) into v_dilloc,v_folloc from ta_15_apremios 
     where modulo=11 and control_otr=v_id_local
     and vigencia='1' and clave_practicado='P' and year(fecha_emision)=year(today)
     group by diligencia order by diligencia
     let v_aprloc=trim(v_aprloc)||' '||v_dilloc||'-'||v_folloc;
     end foreach;
     -- agrega las not y req de licencias 4/08/2014
     let v_aprlic='';

     foreach
     select cveproceso,nvl(count(*),0) into v_dillic,v_follic from catastro_gdl:reqlicencias
     where id_licencia=v_idlic
     and vigencia='V' and fecprac is not null and year(fecemi)=year(today)
     group by cveproceso order by cveproceso
     let v_aprlic=trim(v_aprlic)||' '||v_dillic||'-'||v_follic;
     end foreach;

     let v_aprlic=trim(v_aprlic);

     if v_estatus=0 then
       insert into locales values(v_id_local, v_ofna, v_merc, v_cat, v_sec,v_loc, v_let,v_blq, v_mesmin, v_axomin, v_meshst,
		    v_axohst, v_nombre, v_domicilio, v_adicional, v_superficie, v_adeudo, v_recargos,
		    v_multa, v_gastos, v_actualizacion, v_total, v_descuento, v_nom_mercado, v_estatus, v_descripcion, '','','',0,0,v_fecha_alta,v_renta);
     end if;	

end foreach;

foreach
  select tmerc,sum(tadeudo),sum(trecargos),sum(tmulta),sum(tgastos),sum(tactualizacion),sum(ttotal)
  into v_merc, v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total
  from locales group by tmerc order by tmerc

  return v_merc, v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_nom_mercado with resume;
end foreach;
-- borrar tabla temporal
delete from locales;
end procedure;

create procedure "dbarias".spd_17_ins_saldos(pidconv int,pidmod int,pmod int,pconvenio varchar(15),popc char(1))
returning   int as estado,
            varchar(100) as mensaje;


define vestado int;
define vvig char(1);
define vmensaje varchar(100);
define vpagado, vimpaplicado, vsaldoaplicar money(16,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'spd_17_ins_saldos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

let vvig='';
let vmensaje='';
let vestado=0;
let vvig='';
let vpagado=0;
let vsaldoaplicar=0;

if popc='A' then
   -- obtiene la vigencia del convenio
   select vigencia into vvig from ta_17_conv_d_resto where id_conv_resto=pidconv;
   -- obtiene el importe total pagado
   select nvl(sum(importe_pago),0) into vpagado from ta_17_conv_pagos where id_conv_resto=pidconv;
   -- graba el total pagado a saldos a favor dependiendo del modulo
   if vpagado>0 then
      if pmod=5 then -- predial
         -- obtiene el saldo a favor para aplicar 
         select nvl(sum(saldoaplicar),0) into vsaldoaplicar
         from db_ingresos:ta_17_adeudos_div where id_conv_resto=pidconv and clave_pago='P' and saldoaplicar>0;
         -- inserta el saldo a favor
         if vsaldoaplicar>0 then 
            insert into catastro_gdl:saldosafavor
            (cvecuenta, id_convenio, folio, saldoinicial, importeaplicado, fechaalta, fechacan, usu_alta, usu_can)
            values(pidmod, pidconv, pconvenio, vsaldoaplicar, 0, today, null, user, null);
            let vestado=0;
            let vmensaje='REGISTRO INSERTADO CORRECTAMENTE';
         end if;         
      end if;
      if pmod=9 then -- licencias
         insert into catastro_gdl:saldosafavor_lic 
          (id,c_saldosafavor_id,id_licencia,folio,saldoinicial,importeaplicado,fechaalta,fechacan,usu_alta,usu_can,vigconvenio)
          values(0,1,pidmod,pconvenio,vpagado,0,today,null,user,null,vvig);
         let vestado=0;
         let vmensaje='REGISTRO INSERTADO CORRECTAMENTE'; 
      end if;
      if pmod=10 then -- anuncios
         insert into catastro_gdl:saldosafavor_anu 
          (id,c_saldosafavor_id,id_anuncio,folio,saldoinicial,importeaplicado,fechaalta,fechacan,usu_alta,usu_can,vigconvenio)
          values(0,1,pidmod,pconvenio,vpagado,0,today,null,user,null,vvig);
         let vestado=0;
         let vmensaje='REGISTRO INSERTADO CORRECTAMENTE';
      end if;
   end if;
end if;
if popc='B' then
   if pmod=5 then -- predial
   -- obtiene el importe aplicado del saldo a favor
      select nvl(sum(importeaplicado),0) into vimpaplicado from catastro_gdl:saldosafavor
       where cvecuenta=pidmod and id_convenio=pidconv;
      if vimpaplicado=0 then
         delete from catastro_gdl:saldosafavor where cvecuenta=pidmod and id_convenio=pidconv;
         let vestado=0;
         let vmensaje='REGISTRO ELIMINADO CORRECTAMENTE';
      else
         let vestado=-1;
         let vmensaje='YA SE APLICO EL SALDO A FAVOR AL ADEUDO PREDIAL';
      end if;        
   end if; 
   if pmod=9 then -- licencias
   -- obtiene el importe aplicado del saldo a favor
      select nvl(sum(importeaplicado),0) into vimpaplicado from catastro_gdl:saldosafavor_lic 
       where id_licencia=pidmod and folio=trim(pconvenio);
      if vimpaplicado=0 then
         delete from catastro_gdl:saldosafavor_lic where id_licencia=pidmod and folio=trim(pconvenio);
         let vestado=0;
         let vmensaje='REGISTRO INSERTADO CORRECTAMENTE';
      else
         let vestado=-1;
         let vmensaje='YA SE APLICO EL SALDO A FAVOR AL ADEUDO DE LICENCIA';
      end if;
   end if;
   if pmod=10 then -- anuncios
   -- obtiene el importe aplicado del saldo a favor
      select nvl(sum(importeaplicado),0) into vimpaplicado from catastro_gdl:saldosafavor_anu 
       where id_anuncio=pidmod and folio=trim(pconvenio);
      if vimpaplicado=0 then
         delete from catastro_gdl:saldosafavor_anu where id_anuncio=pidmod and folio=trim(pconvenio);
         let vestado=0;
         let vmensaje='REGISTRO INSERTADO CORRECTAMENTE';
      else
         let vestado=-1;
         let vmensaje='YA SE APLICO EL SALDO A FAVOR AL ADEUDO DE ANUNCIO';
      end if;
   end if;
end if;
return vestado,vmensaje;
end procedure;

create procedure "pgcabrer".spd_11_descderechosmerc(par_local int, par_axoi int, par_mesi int, par_axof int, par_mesf int,
                               par_usuario char(10), par_porc int, par_autoriza int, par_opc int)

returning int as control;

define vid int;
-- opc. 1 insertas el descuento
if par_opc = 1 then
   insert into ta_11_descderechos (id_descuento, id_local, axoini, mesini, axofin, mesfin, porcentaje,
                     fecha_alta, usu_alta, fecha_baja, usu_baja, estado, id_pago, autoriza) 
    VALUES(0, par_local, par_axoi, par_mesi, par_axof, par_mesf, par_porc, current, par_usuario, null, null,'V', null, par_autoriza);
--	LET vid = dbinfo("sqlca.sqlerrd1");
   select id_descuento into vid  from ta_11_descderechos where id_local=par_local and estado='V';
return vid;

end if;

-- opc. 2 cancelas el descuento
if par_opc = 2 then
   update ta_11_descderechos set fecha_baja=current, usu_baja=par_usuario, estado='C' where id_local=par_local and estado='V';
return 0;
end if;

-- opc. 3 pagas el descuento
-- el parametro "par_autoriza" para la opcion 3 es el id_pago
if par_opc=3 then
   update ta_11_descderechos set estado='P',  id_pago=par_autoriza where id_local=par_local and estado='V';
   return 0;
end if; 

end procedure;

create procedure "pgcabrer".spd_11_descmultamerc(par_local int, par_axoi int, par_mesi int, par_axof int, par_mesf int,
                               par_usuario char(10), par_porc int, par_autoriza int, par_opc int)

returning int as control;

define vid int;
-- opc. 1 insertas el descuento
if par_opc = 1 then
   insert into ta_11_descmulta (id_descuento, id_local, axoini, mesini, axofin, mesfin, porcentaje,
                     fecha_alta, usu_alta, fecha_baja, usu_baja, estado, id_pago, autoriza) 
    VALUES(0, par_local, par_axoi, par_mesi, par_axof, par_mesf, par_porc, current, par_usuario, null, null,'V', null, par_autoriza);
--	LET vid = dbinfo("sqlca.sqlerrd1");
   select id_descuento into vid  from ta_11_descmulta where id_local=par_local and estado='V';
return vid;

end if;

-- opc. 2 cancelas el descuento
if par_opc = 2 then
   update ta_11_descmulta set fecha_baja=current, usu_baja=par_usuario, estado='C' where id_local=par_local and estado='V';
return 0;
end if;

-- opc. 3 pagas el descuento
-- el parametro "par_autoriza" para la opcion 3 es el id_pago
if par_opc=3 then
   update ta_11_descmulta set estado='P',  id_pago=par_autoriza where id_local=par_local and estado='V';
   return 0;
end if; 

end procedure;

CREATE PROCEDURE "pgcabrer".sp_desctorenta( par_local int, par_axo smallint, par_mes smallint, par_renta money(15,2))

RETURNING money as descuento,
          varchar(30) as mensage;


define v_descto  money(16,2);
define v_porcentaje  int;
define v_porccovid19 decimal(5,2);
define v_id       int;
define v_axoi       int;
define v_mesi      int;
define v_axof      int;
define v_mesf      int;
define v_men      varchar(30);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp_desctorenta ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let    v_descto=0;
let    v_porcentaje=0;
let    v_axoi=0;
let    v_mesi=0;
let    v_axof=0;
let    v_mesf=0;
let    v_men='Ini';

select porcentaje, id_descuento, axoini, mesini, axofin, mesfin
into v_porcentaje, v_id,v_axoi,v_mesi,v_axof,v_mesf
from ta_11_descderechos where id_local =par_local and estado='V';
if v_axoi=0 then
   let v_men=('sin calcular '||par_renta||' '||v_porcentaje);
else
   if v_axoi=par_axo then
      if par_axo<year(today) then
         let v_descto=(par_renta * v_porcentaje)/100;
      else
         if par_mes<=v_mesf then
            let v_descto=(par_renta * v_porcentaje)/100;
         else
           let v_descto=0;
         end if;
      end if;
      let v_men=('entre 1 '||par_renta||' '||v_porcentaje);
   else
      if v_axof=par_axo then
         if v_mesf>=par_mes then
            let v_descto=(par_renta * v_porcentaje)/100;
         else
            let v_descto=0;
         end if;
         let v_men=('entre 2 '||par_renta||' '||v_porcentaje);
      else
         if v_axoi<=par_axo then
            if v_axof>=par_axo then
               let v_descto=(par_renta * v_porcentaje)/100;
            else
               let v_descto=0;
            end if;
            let v_men=('entre 3 '||par_renta||' '||v_porcentaje);
         else
            let v_descto=0;
            let v_men=('sin nada '||par_renta||' '||v_porcentaje); 
         end if;   
      end if;
   end if;
end if;
return v_descto,v_men;
  
END PROCEDURE;

create function "pgcabrer".spd_11_adeudototal(p_idlocal int,p_axo int,p_mes int,p_opc char(1))
returning  money(18,2) as adeudo,
           money(18,2) as recargos,
           money(18,2) as multa,
           money(18,2) as gastos,
           money(18,2) as actualizacion,
           money(18,2) as total,
           int as axodsd,
           int as mesdsd,
           int as axohst,
           int as neshst;

-- parametro p_opc si es T=renta total sin descuento y D=renta con descuento

define v_adeudo, v_adeapagar, v_recargos, v_multa, v_gastos, v_actualizacion, v_total money(18,2);    
define v_axo, v_mes, v_axodsd, v_mesdsd, v_axohst, v_meshst int;
define t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, t_desc_recargos, t_rec_apagar money(18,2);
define t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total money(18,2);
define t_leyenda varchar(100);

-- ejecuta tabla de detalle para generar tabla temporal
foreach
  execute function spd_11_adeudodetalle(p_idlocal) into v_axo, v_mes, t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, 
    t_desc_recargos, t_rec_apagar, t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total, t_leyenda
end foreach;

-- totales de tabla temporal
select sum(adeudo), sum(ade_apagar), sum(rec_apagar), sum(mul_apagar), max(gastos), sum(actualizacion),
 (sum(rec_apagar)+sum(mul_apagar)+max(gastos)+sum(actualizacion)),

nvl((select min(axo) from tmp_adeudomerc where (axo<p_axo  or (mes<=p_mes and axo=p_axo))),0),

nvl((select min(mes) from tmp_adeudomerc where axo=(select min(axo) from tmp_adeudomerc 
  where (axo<p_axo  or (mes<=p_mes and axo=p_axo)))),0),

nvl((select Max(axo) from tmp_adeudomerc where (axo<p_axo  or (mes<=p_mes and axo=p_axo))),0),

nvl((select max(mes) from tmp_adeudomerc where (axo<p_axo  or (mes<=p_mes and axo=p_axo)) 
and axo=(select Max(axo) from tmp_adeudomerc where (axo<p_axo  or (mes<=p_mes and axo=p_axo)))),0)
  into v_adeudo, v_adeapagar, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axodsd, v_mesdsd, v_axohst, v_meshst 
from tmp_adeudomerc where (axo<p_axo  or (mes<=p_mes and axo=p_axo));

if p_opc='T' then
   let v_total=v_total+v_adeudo;
   return v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axodsd, v_mesdsd, v_axohst, v_meshst;
else
   let v_total=v_total+v_adeapagar;
   return v_adeapagar, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axodsd, v_mesdsd, v_axohst, v_meshst;
end if;

-- borrar tabla temporal
delete from tmp_adeudomerc;
end function;

CREATE FUNCTION "dbarias".admin_pago_13(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20),pimppag money(14,2),
pimpcartera money(14,2),pimpredondeo money(14,2),pidcobro int,
pfolio varchar(30),pfecha date,precp int,pcentrop int,pcaja char(20),pnombreuser varchar(40),
puser char(8))

{######################################################################
#  Procedimiento:    admin_pago_13
#  Descripcion:      Interfaz de pago para el cobro de mercados para admin
#
#  Parametros        
#  de entrada:       pinterface = 13 numero de interfaz para convenios diversos
#                    prec = recaudadora al que pertenece el mercado
#                    pmer = numero de mercado
#                    psecc = seccion del mercado
#                    ploc = numero de local
#                    plet = letra del local
#                    pblq = bloque del local
#                    pref = hasta que mensualidad se afectara como pagado
#                    pimppag = importe total de pago
#                    pimpcartera = importe de total de mensualidades 
#                    pimpredondeo = importe de redondeo
#                    pidcobro = numero de operacion,
#                    pfolio = folio de recibo ofical
#                    pfecha = fecha de pago
#                    precp = recaudadora de pago
#                    pcentrop = numero de centro de recaudacion
#                    pcaja = caja de pago
#                    pnombreuser = nombre del cajero
#                    puser = nombre del usuario
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Benita Cabrera Toscano
#  Fecha:            30 Octubre 2013   
#  Actualizacion:    Se agrega el procedimiento para dar como pagado el descto de arrendamiento 19/07/2021.
#                    Se agrega el procedimiento para dar como pagado el descto de multa mensual calculada 22/07/2021.   
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}


returning   int as status, 
            varchar(100) as mensaje;

define v_ref char(7);
define v_bloque1,v_blq varchar(2);
define v_letra1,v_let varchar(3);
define v_rubro,v_conctmp,v_cuentaaplicacion,v_axoi,v_axof,v_mesi,v_mesf,d_rubro,d_concepto,d_cuenta int;
define v_referencia,d_referencia varchar(30);
define v_descadeudo,d_descripcion  varchar(120);
define v_monto,v_acumulado,v_montotot,v_acumuladotot,v_montoper,v_acumuladoper,d_monto,d_acumulado decimal(14,2);
define v_Nombrecompleto varchar(92);
define v_calle varchar(80);
define v_Exterior,v_interior,v_codigopostal varchar(10);
define v_colonia,v_municipio,v_estado varchar(50);
define v_RFC varchar(13);
define v_curp varchar(18);
define v_descripcionrecibo lvarchar(500);
define v_carteraxcobar,v_codigo,v_tcta,v_cuentatot,v_cuentaper,v_axoper,v_mesper integer; 
define v_leyenda,v_leyendarecibo,v_descrbo varchar(255); 
define v_datosvarios,v_mercado,v_seccion,v_dom,v_adicional,v_sector,v_zona,v_giro,v_superficie varchar(150);
define v_id,v_contador,v_contvarios,v_status,v_iduser,v_axot,v_mest,v_ultfolio int;
define v_leyenda1 varchar(100);

--Benita Proc, [03.04.20 10:51]
define v_numtrans int;
define v_idlocal int;
define v_descripcion varchar(240);
define v_axoini,v_mesini,v_axofin,v_mesfin,v_axofd,v_mesfd int;
define v_numperiodos int;
define v_idmedio int;
define v_impactual,v_imprezago,v_imprecargos,v_impmulta,v_impgastos,v_impredon money(16,2);
define v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadescpp,v_ctaactualizacion integer;
define v_nummerc int;
define v_local int;
define v_letra,v_bloque char(1);
define v_nomsec,v_nommer char(30);
--define v_ctaact,v_ctarzg,v_ctarec,v_ctamul,v_ctagas int;
define v_conc1,v_conc2,v_conc3,v_conc4,v_conc5,v_conc6,v_conc7,v_conc8 char(60);
define v_conc4f1,v_conc4f2,v_conc4f3,v_conc4f4 char(60);
define v_nombre,v_domicilio,v_mensaje,v_concepto,v_conceptodet char(60);
define v_linea1 char(100);
define v_linea2 char(28);
define v_adeudo,v_total,v_importe money(16,2);
define v_perini,v_perfin int;
define v_reca,v_porcdescrec, v_descderecho, v_descmulta, v_idpago, v_bien int; 
define v_caja char(2);
define v_operacion,v_cont,v_cont1,v_cuenta int;
define v_categoria,v_desc,v_idcontrol,v_folio int;
define v_aid_local,v_aaxo,v_aperiodo,v_dmes int;
define v_aimporte,v_gastos,v_descuento money(16,2);
define v_fecha_desc date; 
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_ca int;
define v_error_paso int;
define v_r char(1);
--DEFINE okey SMALLINT; 
--DEFINE err_num INTEGER; 
--LET okey = 0; 
--BEGIN 
--ON EXCEPTION IN (-206) SET err_num 
--IF err_num = -206 THEN 
--LET okey = 1; 
--END IF 
--END EXCEPTION WITH resume 
--DROP TABLE tabla_temporal; 
--END 



ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -11, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE MERCADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION;
 --set debug file to "pago13";
 --trace on;
  let v_r = 'N';
   -- ejecuta el procedimiento adeudo detalle
    foreach 
    execute procedure admin_adeudos_detalle_13odoo(13,prec,pmer,psecc,ploc,plet,pblq,pref) 
      into d_rubro,d_concepto,d_cuenta,d_referencia,d_descripcion,d_monto,d_acumulado
    end foreach;
  select count(*) into v_ca from  tmp_totalesmerc ;
  if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;

let v_status=0;
let v_leyenda1='';
let v_leyenda='';
let v_contador=0;
let v_contvarios=0;
let v_nombre='';
let v_domicilio='';
let v_cont=0;
let v_descderecho=0;
let v_descmulta=0;
let v_idpago=0;

-- Asigna valor a fererencia a pagar
if trim(pref)='' then
   let v_ref=year(today)||'/12';
--   let v_ref='9999/12';
else
   let v_ref=trim(pref);
end if;

-- verifica el ususario de caja si no existe toma el usuario admin
select id_usuario into v_iduser from ta_12_passwords where usuario=trim(puser);
if v_iduser is null then
   let v_iduser=335;
end if;

if v_ca =0 then
   let v_status=-9;
   let v_leyenda1='NO EXISTE ADEUDOS';
   return v_status,v_leyenda1;
end if;

--Benita Proc, [03.04.20 10:51]
-- checa que exista el local y toma el id_local
if not exists(select * from ta_11_locales where oficina=prec and num_mercado=pmer 
                                           and seccion=psecc and local=ploc ) then
   let v_status=-1;
   let v_leyenda1='REFERENCIA NO EXISTE  No.local';
   return v_status,v_leyenda1;
end if;
   
foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    let v_status=0;
    let v_leyenda1='';
    -- obtiene las cuentas de aplicacion para el mercado
    select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,
           cuenta_descmulta,cuenta_gastos,cuenta_descpp,cuenta_actualizacion
    into v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadescpp,v_ctaactualizacion
    from ta_11_mercados where num_mercado_nvo=pmer;

    -- ejecuta el procedimeinto de encabezados
    execute procedure admin_encabezados_13(13,prec,pmer,psecc,ploc,plet,pblq) into
    v_Nombrecompleto,v_calle,v_Exterior,v_interior,v_colonia,v_codigopostal,v_RFC,v_municipio,v_estado,
    v_curp,v_carteraxcobar,v_leyenda,v_leyendarecibo,v_codigo;
    
    -- ejecuta el procedimiento de datos varios
    foreach
    execute procedure admin_datos_varios_13(13,prec,pmer,psecc,ploc,plet,pblq) into v_datosvarios
    let v_contvarios=v_contvarios+1;
    if v_contvarios = 1 then let v_mercado=v_datosvarios; 
    else if v_contvarios = 2 then let v_seccion=v_datosvarios;
    else if v_contvarios = 3 then let v_dom=v_datosvarios;
    else if v_contvarios = 4 then let v_adicional=v_datosvarios;
    else if v_contvarios = 5 then let v_sector=v_datosvarios;
    else if v_contvarios = 6 then let v_zona=v_datosvarios;
    else if v_contvarios = 7 then let v_giro=v_datosvarios;
    else let v_superficie=v_datosvarios;
    end if; end if; end if; end if; end if; end if; end if; 
    end foreach;

 

    -- para sacar el a�o minimo de temporal
    select  min(axo) into v_axoi from tmp_totalesmerc; 
    -- para sacar el mes minimo de temporal      
    select min(mes) into v_mesi  from tmp_totalesmerc where axo=v_axoi;
    -- para sacar el a�o maximo de temporal
    select  max(axo) into v_axof from tmp_totalesmerc;
    -- para sacar el mes maxino de temporal      
    select max(mes) into v_mesf  from tmp_totalesmerc where axo=v_axof;

    -- selecciona adeudo detalle de tabla temporal
    foreach
    select rubro,concepto,cuenta,axo,mes,referencia,descripcion,monto,acumulado 
    into v_rubro,v_conctmp,v_cuentaaplicacion,v_axot,v_mest,v_referencia,v_descadeudo,v_monto,v_acumulado 
    from  tmp_totalesmerc where axo=v_axof and mes=v_mesf 
    end foreach;
           
    -- valida si el importe pagado es igual al importe adeudo 
    if pimpcartera<>v_acumulado then
       let v_status=-7;
       let v_leyenda1='EL IMPORTE COBRADO ES DIFERENCIA AL IMPORTE ADEUDO  **';
       return v_status,v_leyenda1;
    end if;

    -- valida si el importe pagado mas redondeo es igual al importe pagado 
    if (pimpcartera+pimpredondeo)<>pimppag then
       let v_status=-6;
       let v_leyenda1='LA SUMA DE CARTERA Y REDONDEO NO ES EL CERTIFICADO. VERIFICAR';
       return v_status,v_leyenda1;
    end if;

    -- verifica si tiene descuento de arrendamiento
    select id_descuento into v_descderecho from ta_11_descderechos where id_local=v_id and estado='V' and fecha_baja is null;
    if v_descderecho is null then
       let v_descderecho=0;
    end if;

    -- verifica si tiene descuento en multa
    select id_descuento into v_descmulta from ta_11_descmulta where id_local=v_id and estado='V' and fecha_baja is null;
    if v_descmulta is null then
       let v_descmulta=0;
    end if;

    -- verifica si tiene descuento en recargos.
    select nvl(porcentaje,0),axofin,mesfin into v_porcdescrec,v_axofd,v_mesfd from ta_11_descrec where id_local=v_id
    and vigencia='V' and fecha_baja is null;
    if v_porcdescrec is null then
       let v_porcdescrec=0;
    end if;

    -- asigna el concepto de cobro para grabar en recibos
    if pmer=214 then
       let v_concepto='PAGO TRIMESTRAL DEL '||trim(v_mercado);
    else
       let v_concepto='PAGO RENTA MENSUAL DEL MERCADO '||trim(pmer)||' '||trim(v_mercado);
    end if;

--Benita Proc, [03.04.20 10:51]
BEGIN WORK;
     let v_r = 'S';
    -- graba la operacion en recibos
    let v_descrbo='Datos del Local '||trim(prec)||'-'||trim(pmer)||'-'||trim(psecc)||'-'||
                  trim(ploc)||'-'||trim(plet)||'-'||trim(pblq)||'     Id local '||v_id;
    insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
    id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcini,rfcnumero,
    rfccolonia,obra,axofolio,id_usuario,fecha_act,descripcion,id_centro,foliorecibo) 
    values(pfecha,precp,pcaja,pidcobro,pimppag,'P',11,v_id,prec,'M',v_mesi,v_axoi,
    v_mesf,v_axof,v_Nombrecompleto,v_domicilio,v_concepto,psecc,ploc,pmer,0,0,v_iduser,current,v_descrbo,
    pcentrop,pfolio);

    foreach
--    select cuenta,substring(descripcion from 1 for locate(descripcion,' ')),count(cuenta),sum(monto),sum(acumulado) 
    select cuenta,descripcion ,count(cuenta),sum(monto),sum(acumulado) 
    into v_cuentatot,v_conceptodet,v_tcta,v_montotot,v_acumuladotot  
    from tmp_totalesmerc group by cuenta,descripcion order by cuenta
    -- graba detalle de recibo
    let v_cont=v_cont+1;
    insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
    values(pfecha,precp,pcaja,pidcobro,v_cont,v_conceptodet,v_cuentatot,v_montotot);
    end foreach;

    -- inserta el redondeo
    if pimpredondeo<>0 then
       insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
       values(pfecha,precp,pcaja,pidcobro,v_cont+1,'REDONDEO',550800000,pimpredondeo);
    end if;

    -- afecta los periodos como pagados
    foreach
    select axo,mes,sum(monto) 
    into v_axoper,v_mesper,v_montoper  
    from tmp_totalesmerc 
    where cuenta not in(v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctaactualizacion)
    group by axo,mes order by axo,mes

    -- inserta el pago a mercados
    insert into ta_11_pagos_local(id_pago_local,id_local,axo,periodo,fecha_pago,oficina_pago,
    caja_pago,operacion_pago,importe_pago,folio,fecha_modificacion,id_usuario) 
    values(0,v_id,v_axoper,v_mesper,pfecha,precp,pcaja,pidcobro,v_montoper,pfolio,current,v_iduser);
    let v_idpago = dbinfo("sqlca.sqlerrd1");
    let v_status=0;
    let v_leyenda1='PAGO APLICADO CORRECTAMENTE';

    -- quitar los adeudos
   delete from ta_11_adeudo_local where id_local=v_id and axo=v_axoper and periodo=v_mesper;
   end foreach;

   -- seleccionar los folios vigentes y practicados  
   foreach
   select nvl(id_control,0),nvl(folio,0),importe_gastos 
   into v_idcontrol,v_folio,v_gastos
   from    ta_15_apremios a  
   where modulo=11 and control_otr=v_id and vigencia='1' and clave_practicado='P'

   -- poner como pagados los folios vigentes y practicados
   update ta_15_apremios set fecha_pago=pfecha,recaudadora=precp,caja=pcaja,
   operacion=pidcobro,vigencia='2',clave_mov='P',importe_pago=v_gastos
   where modulo=11 and Id_control=v_idcontrol;
   end foreach;

   -- afecta como pagado el descuento de arrendamiento
   if v_descderecho>0 then
      execute procedure spd_11_descderechosmerc(v_id, 0, 0, 0, 0, puser, 0, v_idpago, 3) into v_bien;
   end if;

   -- afecta como pagado el descuento de multa
   if v_descmulta>0 then
      execute procedure spd_11_descmultamerc(v_id, 0, 0, 0, 0, puser, 0, v_idpago, 3) into v_bien;
   end if;

   -- afecta como pagado el descuento de recargos
   if  v_porcdescrec>0 then
       execute procedure sp_desctomerc(v_id,v_axofd,v_mesfd,3,0,today,precp,pcaja,pidcobro,11) into v_descuento,v_mensaje;
   end if;

   -- borrar tabla temporal
       delete from tmp_totalesmerc;
   COMMIT WORK;   
end if;
end foreach;
if v_contador=0 then
   let v_status=-1;
   let v_leyenda1='REFERENCIA NO EXISTE. No.local';
   return v_status,v_leyenda1;
end if;
return v_status,v_leyenda1;
 trace off;
end function;

create procedure "pgcabrer".spd_11_calc_multab(pmer int,pimp money(18,2),pven date)
returning   money(18,2) as multa;

define v_multa money(18,2);
define v_porc int;

let v_porc=30;
let v_multa=0;

if pmer <>214 then
   if year(today)=year(pven) then
      if month(today)>month(pven) then
         let v_multa=trunc(pimp*v_porc)/100; 
      else
      if month(today)=month(pven) then
            if day(today)<day(pven) then
               let v_multa=0;
            else
               let v_multa=trunc(pimp*v_porc)/100;
            end if;
      else
      if month(today)<month(pven) then
            let v_multa=0;
          else
            let v_multa=trunc(pimp*v_porc)/100;
          end if; 
        end if;          
      end if;       
   else
      let v_multa=trunc(pimp*v_porc)/100;
   end if;
else
   let v_multa=0;
end if;

return v_multa;
end procedure;

create procedure "pgcabrer".spd_11_calc_multa(pmer int,pimp money(18,2),pven date)
returning   money(18,2) as multa;

define v_multa money(18,2);
define v_porc int;

let v_porc=30;
let v_multa=0;

if pmer <>214 then
   if year(today)=year(pven) then
      if month(today)>month(pven) then
         let v_multa=trunc(pimp*v_porc)/100; 
      else
      if month(today)=month(pven) then
            if day(today)<day(pven) then
               let v_multa=0;
            else
               let v_multa=trunc(pimp*v_porc)/100;
            end if;
      else
      if month(today)<month(pven) then
            let v_multa=0;
          else
            let v_multa=trunc(pimp*v_porc)/100;
          end if; 
        end if;          
      end if;       
   else
      let v_multa=trunc(pimp*v_porc)/100;
   end if;
else
   let v_multa=0;
end if;

return v_multa;
end procedure;

create procedure "pgcabrer".spd_11_conv_liqtot(pid int,paxo int,pmes int)
returning   varchar(100) as nombre,
            varchar(30) as calle,
            int as exterior,
            int as interior,
            int as recaudadora, 
            int as zona,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst,
            money(16,2) as importe,
            money(16,2) as recargos,
            money(16,2) as gastos,
            money(16,2) as multa,
            money(16,2) as actualizacion,
            money(16,2) as total,
            int as status,
            varchar(100) as mensaje;

define v_nombre,v_leyenda,v_mensaje varchar(100);
define v_calle  varchar(30);
define v_exterior,v_interior,v_recaudadora,v_zona,v_axodsd,v_mesdsd,v_axohst,v_meshst int;
define v_importe,v_recargos,v_gastos,v_multa,v_total,v_aimporte,v_recmes,v_gas money(16,2);
define v_id,v_status,v_merc,v_folreq,dias_cuantos,dias_habil,v_aaxo,v_aperiodo,v_desc int;
define t_axodsd,t_mesdsd,t_axohst,t_meshst int;
define v_descuento, v_actualizacion money(16,2);
define v_porcmul decimal(7,2);
define v_fecreq,v_fecha_rec date;

let v_exterior=0;
let v_interior=0;
let v_importe=0;
let v_recargos=0;
let v_multa=0;
let v_actualizacion=0;
let v_gastos=0;
let v_total=0;
let v_fecreq=null;
let v_status=0;
let v_porcmul=0;
let v_folreq=0;
let v_leyenda='Local Correcto';

select a.num_mercado,a.nombre,b.descripcion,a.oficina,b.id_zona,
nvl(sum((case when a.id_contribuy_renta>0 then ((d.importe*a.id_contribuy_renta)/100) else d.importe end)),0)
--nvl(((sum(d.importe*a.id_contribuy_renta)/100)),0),
into v_merc,v_nombre,v_calle,v_recaudadora,v_zona,v_importe 
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where a.id_local=pid and b.num_mercado_nvo=a.num_mercado and d.id_local=a.id_local
and (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo))
group by a.num_mercado,a.nombre,b.descripcion,a.oficina,b.id_zona;
if v_importe=0 then
   let v_status=-1;
   let v_leyenda='Local sin adeudo';
   return v_nombre,v_calle,v_exterior,v_interior,v_recaudadora,v_zona,0,0,0,0,v_importe,v_recargos,v_gastos,v_multa,v_actualizacion,v_total,v_status,v_leyenda;
end if;

--ejecuta procedimiento de totales
execute function spd_11_adeudototal(pid,paxo,pmes,'T') 
  into v_importe,v_recargos,v_multa,v_gastos,v_actualizacion,v_total,t_axodsd,t_mesdsd,t_axohst,t_meshst;

return v_nombre,v_calle,v_exterior,v_interior,v_recaudadora,v_zona,t_axodsd,t_mesdsd,t_axohst,t_meshst,
  v_importe,v_recargos,v_gastos,v_multa,v_actualizacion,v_total,v_status,v_leyenda;
end procedure;

create procedure "pgcabrer".spd_11_conv_liqdet(pid int,paxo int,pmes int)
returning   varchar(30) as concepto,
            int as axo,
            int as mes,
            int as ctaimporte,
            money(16,2) as importe,
            int as ctarecargos,
            money(16,2) as recargos,
            int as ctaactualizacion,
            money(18,2) as actualizacion,
            int as ctamulta,
            money(18,2) as multa;

define v_axo,v_mes int;
define v_importe,v_recargos,v_gastos,v_multa,v_total, v_actualizacion money(16,2);
define v_id,v_status,v_merc int;
define vctaact,vctarzg,vctarec,vctamul,vctagst, v_cvecuo, vctaactualizacion int;
define v_mensaje varchar(150);
define t_axo, t_mes int;
define t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, t_desc_recargos, t_rec_apagar money(18,2);
define t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total money(18,2);
define t_leyenda varchar(100);

let v_importe=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_actualizacion=0;
let v_status=0;


select a.num_mercado,b.cuenta_ingreso,b.cuenta_rezago,b.cuenta_recargos,
b.cuenta_multa,b.cuenta_gastos,a.clave_cuota,
nvl(sum((case when a.id_contribuy_renta>0 then ((d.importe*a.id_contribuy_renta)/100) else d.importe end)),0),b.cuenta_actualizacion 
into v_merc,vctaact,vctarzg,vctarec,vctamul,vctagst,v_cvecuo,v_importe,vctaactualizacion
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where a.id_local=pid and b.num_mercado_nvo=a.num_mercado and d.id_local=a.id_local
and (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo))
group by a.num_mercado,b.cuenta_ingreso,b.cuenta_rezago,b.cuenta_recargos,
b.cuenta_multa,b.cuenta_gastos,a.clave_cuota,b.cuenta_actualizacion;
if v_importe=0 then
   return '',0,0,0,0,0,0,0,0, 0, 0;
end if;

-- cuentas para locales exteriores del rastro cambios 2020
if (v_merc=90) and (v_cvecuo=17) then
   let vctaact=132010090;
   let vctarzg=132030090;
end if;

-- ejecuta tabla de detalle para generar tabla temporal
foreach
  execute function spd_11_adeudodetalle(pid) into t_axo, t_mes, t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, 
    t_desc_recargos, t_rec_apagar, t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total, t_leyenda
end foreach;

select first 1 axo, mes, gastos into v_axo, v_mes, v_gastos from tmp_adeudomerc;
if v_gastos>0 then
   return 'GASTOS', v_axo, v_mes, vctagst, v_gastos, 0, 0, 0, 0, 0, 0 with resume;
end if;

--select first 1 axo, mes, mul_apagar into v_axo, v_mes, v_multa from tmp_adeudomerc;
--if v_multa>0 then
--   return 'MULTA', v_axo, v_mes, vctamul, v_multa, 0, 0, 0, 0, 0, 0 with resume;
--end if;

foreach
  select axo, mes, adeudo, rec_apagar, actualizacion, mul_apagar into v_axo, v_mes, v_importe, v_recargos, v_actualizacion, v_multa
  from tmp_adeudomerc where ((axo=paxo  and mes<=pmes) or (axo<paxo))
  order by axo, mes

  if  v_axo = year(today) then
      return 'ARRENDAMIENTO',v_axo, v_mes, vctaact, v_importe, vctarec, v_recargos, vctaactualizacion, v_actualizacion, vctamul, v_multa with resume;
  else
      return 'ARRENDAMIENTO',v_axo, v_mes, vctarzg, v_importe, vctarec, v_recargos, vctaactualizacion, v_actualizacion, vctamul, v_multa with resume;
  end if;
end foreach;

-- borrar tabla temporal
delete from tmp_adeudomerc;
end procedure;

CREATE PROCEDURE "pgcabrer".sp_desctomulta( par_local int, par_axo smallint, par_mes smallint, par_multa money(15,2))

RETURNING money as descuento,
          varchar(30) as mensage;

-- se modifica validacion del a�o actual 07/09/2021

define v_descto  money(16,2);
define v_porcentaje  int;
define v_porccovid19 decimal(5,2);
define v_id       int;
define v_axoi       int;
define v_mesi      int;
define v_axof      int;
define v_mesf      int;
define v_men      varchar(30);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp_desctomulta ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let    v_descto=0;
let    v_porcentaje=0;
let    v_axoi=0;
let    v_mesi=0;
let    v_axof=0;
let    v_mesf=0;
let    v_men='Ini';

select porcentaje, id_descuento, axoini, mesini, axofin, mesfin
into v_porcentaje, v_id,v_axoi,v_mesi,v_axof,v_mesf
from ta_11_descmulta where id_local =par_local and estado='V';
if v_axoi=0 then
   let v_men=('sin calcular '||par_multa||' '||v_porcentaje);
else
   if v_axoi=par_axo then
      if par_axo<year(today) then
         let v_descto=(par_multa * v_porcentaje)/100;
      else
         if par_mes<=v_mesf then 
             let v_descto=(par_multa * v_porcentaje)/100;
         else
             let v_descto=0;
         end if;
      end if;
      let v_men=('entre 1 '||par_multa||' '||v_porcentaje);
   else
      if v_axof=par_axo then
         if v_mesf>=par_mes then
            let v_descto=(par_multa * v_porcentaje)/100;
         else
            let v_descto=0;
         end if;
         let v_men=('entre 2 '||par_multa||' '||v_porcentaje);
      else
         if v_axoi<par_axo then
            if v_axof>par_axo then
               let v_descto=(par_multa * v_porcentaje)/100;
            else
               let v_descto=0;
            end if;
            let v_men=('entre 3 '||par_multa||' '||v_porcentaje);
         else
            let v_descto=0;
            let v_men=('sin nada '||par_multa||' '||v_porcentaje); 
         end if;   
      end if;
   end if;
end if;
return v_descto,v_men;
  
END PROCEDURE;

CREATE PROCEDURE "pgcabrer".sp_desctomerc( par_local int, par_axo smallint, par_mes smallint, par_opcion smallint, 
par_recar money(15,2), par_fecp date, par_rec smallint, par_caja char(2), par_oper int, par_modulo int)

RETURNING money as descuento,
          varchar(255) as mensage;

-- se modifica validacion del a�o actual 07/09/2021

define v_descto  money(16,2);
define v_porcentaje  int;
define v_porccovid19 decimal(5,2);
define v_id       int;
define v_axoi       int;
define v_mesi      int;
define v_axof      int;
define v_mesf      int;
define v_men      varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp_desctomerc ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let    v_descto=0;
let    v_porcentaje=0;
let    v_axoi=0;
let    v_mesi=0;
let    v_axof=0;
let    v_mesf=0;
let    v_men='Ini';


if par_modulo=11 then
if par_opcion=1 then   
   select porcentaje, id_descto, axoinicio,mesinicio, axofin,mesfin
     into v_porcentaje, v_id,v_axoi,v_mesi,v_axof,v_mesf
    from ta_11_descrec where id_local =par_local and vigencia='V';
    if v_axoi=0 then
       let v_men=('sin calcular '||par_recar||' '||v_porcentaje);
    else
    if v_axoi=par_axo then
      if par_axo<year(today) then
         let v_descto=(par_recar * v_porcentaje)/100;
      else
         if par_mes<=v_mesf then 
            let v_descto=(par_recar * v_porcentaje)/100;
         else
            let v_descto=0;
         end if;
      end if;
       let v_men=('entre 1 '||par_recar||' '||v_porcentaje);
    else
    if v_axof=par_axo then
       if v_mesf>=par_mes then
          let v_descto=(par_recar * v_porcentaje)/100;
       else
          let v_descto=0;
       end if;
       let v_men=('entre 2 '||par_recar||' '||v_porcentaje);
    else
    if v_axoi<par_axo then
       if v_axof>par_axo then
          let v_descto=(par_recar * v_porcentaje)/100;
       else
          let v_descto=0;
      end if;
       let v_men=('entre 3 '||par_recar||' '||v_porcentaje);
    else
          let v_descto=0;
          let v_men=('sin nada '||par_recar||' '||v_porcentaje); 
    end if;   
    end if;
    end if;
    end if;
    return v_descto,v_men;
end if;    

if par_opcion=2 then   
   update ta_11_descrec
   set vigencia='V',
       fec_pag=null,
    id_rec=0,caja='', 
       operac=0 
    where id_local =par_local and  fec_pag= par_fecp and id_rec=par_rec and
            caja=par_caja and operac=par_oper and vigencia='P' and axofin=par_axo and mesfin=par_mes;
   return 0,'Reactivado';
end if; 

if par_opcion=3 then
   if par_fecp>0 then  
   update ta_11_descrec
   set vigencia='P',
  fec_pag=par_fecp,
   id_rec=par_rec,
   caja=par_caja,
    operac=par_oper

    where id_local =par_local and vigencia='V' and axofin=par_axo and mesfin=par_mes;
   return 0,'Pagado';
   else
   return 1,'Falta cve';
    end if;  
end if; 

if par_opcion=4 then   
   update ta_11_descrec
   set vigencia='C',
   fecha_baja=today,usuario_baja='Cajero' 
    where id_local =par_local and vigencia='V';
   return 0,'Cancelado';
end if; 

if par_opcion=5 then
   if par_oper=1 then let v_porccovid19=1.47; 
   else if par_oper=2 then let v_porccovid19=2.94;
   else if   par_oper=3 then let v_porccovid19=4.41;
   else let  v_porccovid19=0;
end if; end if; end if; 
let v_descto=par_recar * v_porccovid19 / 100;
let v_men=('CONTINGENCIA COVID-19 '||par_recar||' '||v_porccovid19);
return v_descto,v_men;
end if;
end if;

-- ASEO CONTRATADO
if par_modulo=16 then
	if par_opcion=1 then 
		--select porcentaje, id_descto, axoinicio,mesinicio, axofin,mesfin 
		--into v_porcentaje, v_id,v_axoi,v_mesi,v_axof,v_mesf 
		--from ta_16_descrec 
		--where id_contrato =par_local and vigencia='V'; 
	
		--if v_axoi=0 then 
		--	let v_men=('sin calcular '||par_recar||' '||v_porcentaje); 
		--else 
		--	if v_axoi=par_axo then 
		--		if v_mesi<=par_mes then 
		--			let v_descto=(par_recar * v_porcentaje)/100; 
		--		else 
		--			let v_descto=0; 
		--		end if; 
		--		let v_men=('entre 1 '||par_recar||' '||v_porcentaje); 
		--	else 
		--		if v_axof=par_axo then 
		--			if v_mesf>=par_mes then 
		--				let v_descto=(par_recar * v_porcentaje)/100; 
		--			else 
		--				let v_descto=0; 
		--			end if; 
		--			let v_men=('entre 2 '||par_recar||' '||v_porcentaje); 
		--		else 
		--			if v_axoi<par_axo then 
		--				if v_axof>par_axo then 
		--					let v_descto=(par_recar * v_porcentaje)/100; 
		--				else 
		--					let v_descto=0; 
		--				end if; 
		--				let v_men=('entre 3 '||par_recar||' '||v_porcentaje); 
		--			else 
		--				let v_descto=0; 
		--				let v_men=('sin nada '||par_recar||' '||v_porcentaje); 
		--			end if; 
		--		end if; 
		--	end if; 
		--end if; 

		-- ojo nuevo
		select porcentaje, id_descto, axoinicio, mesinicio, axofin, mesfin
		into v_porcentaje, v_id,v_axoi,v_mesi,v_axof,v_mesf  
		from ta_16_descrec 
		where id_contrato =par_local and vigencia='V' 
		and (par_axo * 100)+par_mes between ( axoinicio * 100) + mesinicio and ( axofin * 100) + mesfin;

		if v_porcentaje > 0 then
			let v_descto=(par_recar * v_porcentaje)/100; 
			let v_men=('calculado '||par_recar||' '||v_porcentaje); 
		end if;
		-- termina nuevo

		return v_descto,v_men;
	end if;    
	if par_opcion=2 then 
		update ta_16_descrec set 
			vigencia='V', 
			fec_pag=null, 
			id_rec=0,caja='', 
			operac=0 
		where id_contrato =par_local and  fec_pag=par_fecp and id_rec=par_rec and 
		caja=par_caja and operac=par_oper and vigencia='P' and axofin=par_axo and mesfin=par_mes;
		return 0,'Reactivado';
	end if; 

	if par_opcion=3 then 
		if par_fecp>0 then 
			update ta_16_descrec set 
				vigencia='P', 
				fec_pag=par_fecp, 
				id_rec=par_rec, 
				caja=par_caja, 
				operac=par_oper 
			where id_contrato =par_local and vigencia='V' and axofin=par_axo and mesfin=par_mes;
			return 0,'Pagado'; 
		else 
			return 1,'Falta cve'; 
		end if;  
	end if; 

	if par_opcion=4 then   
		update ta_16_descrec set 
			vigencia='C', 
			fecha_baja=today,usuario_baja='Cajero' 
		where id_contrato =par_local and vigencia='V'; 
		return 0,'Cancelado'; 
	end if; 
end if;

--  OTRAS OBLIGACIONES
if par_modulo=34 then
	if par_opcion=1 then 
		-- ojo nuevo
		select porcentaje, id_descto, axoinicio, mesinicio, axofin, mesfin
		into v_porcentaje, v_id,v_axoi,v_mesi,v_axof,v_mesf  
		from t34_descrec 
		where id_contrato =par_local and vigencia='V' 
		and (par_axo * 100)+par_mes between ( axoinicio * 100) + mesinicio and ( axofin * 100) + mesfin;

		if v_porcentaje > 0 then
			let v_descto=(par_recar * v_porcentaje)/100; 
			let v_men=('calculado '||par_recar||' '||v_porcentaje); 
		end if;
		-- termina nuevo

		return v_descto,v_men;
	end if;    
	if par_opcion=2 then 
		update t34_descrec set 
			vigencia='V', 
			fec_pag=null, 
			id_rec=0,caja='', 
			operac=0 
		where id_contrato =par_local and  fec_pag=par_fecp and id_rec=par_rec and 
		caja=par_caja and operac=par_oper and vigencia='P' and axofin=par_axo and mesfin=par_mes;
		return 0,'Reactivado';
	end if; 

	if par_opcion=3 then 
		if par_fecp>0 then 
			update t34_descrec set 
				vigencia='P', 
				fec_pag=par_fecp, 
				id_rec=par_rec, 
				caja=par_caja, 
				operac=par_oper 
			where id_contrato =par_local and vigencia='V' and axofin=par_axo and mesfin=par_mes;
			return 0,'Pagado'; 
		else 
			return 1,'Falta cve'; 
		end if;  
	end if; 

	if par_opcion=4 then   
		update t34_descrec set 
			vigencia='C', 
			fecha_baja=today,usuario_baja='Cajero' 
		where id_contrato =par_local and vigencia='V'; 
		return 0,'Cancelado'; 
	end if; 
end if;    --



if par_modulo=13 then
if par_opcion=1 then   
   select porcentaje, id_descto, axoinicio, axofin
     into v_porcentaje, v_id,v_axoi,v_axof
    from ta_13_descrec
    where id_folio =par_local and vigencia='V';
    if v_axoi=0 then
       let v_men=('sin calcular '||par_recar||' '||v_porcentaje);
    else
    if v_axoi=par_axo then
       let v_descto=(par_recar * v_porcentaje)/100;
    else
    if v_axoi<par_axo then
       if v_axof>=par_axo then
          let v_descto=(par_recar * v_porcentaje)/100;
       else
          let v_descto=0;
      end if;
       let v_men=('entre 3 '||par_recar||' '||v_porcentaje);
    else
          let v_descto=0;
          let v_men=('sin nada '||par_recar||' '||v_porcentaje); 
    end if;   
    end if;
    end if;
    return v_descto,v_men;
end if;    


if par_opcion=2 then   
   update ta_13_descrec
   set vigencia='V',
       fec_pag=null, id_rec=0,caja='', 
       operac=0 
    where id_folio =par_local and  fec_pag=par_fecp and id_rec=par_rec and
            caja=par_caja and operac=par_oper and vigencia='P' and axofin=par_axo;
   return 0,'Reactivado';
end if; 

if par_opcion=3 then
   if par_fecp>0 then  
   update ta_13_descrec
   set vigencia='P',
  fec_pag=par_fecp,
   id_rec=par_rec,
   caja=par_caja,
    operac=par_oper

    where id_folio =par_local and vigencia='V' and axofin=par_axo;
   return 0,'Pagado';
   else
   return 1,'Falta cve';
    end if;  
end if; 

if par_opcion=4 then   
   update ta_13_descrec
   set vigencia='C',
   fecha_baja=today,usuario_baja='Cajero' 
    where id_folio =par_local and vigencia='V';
   return 0,'Cancelado';
end if; 
end if;
 
END PROCEDURE;

create procedure "pgcabrer".spd_17_buscaregistro(pmod int,p1 varchar(10),p2 varchar(10),p3 varchar(10),p4 varchar(10),p5 varchar(10),p6 varchar(10),p7 varchar(10))
returning   int as id_registro;

define vid_registro int;
DEFINE cust_qry LVARCHAR(1000);
DEFINE l_cust_num INTEGER;

let vid_registro=0;
if pmod=5 then
   select cvecuenta into vid_registro from catastro_gdl:convcta where recaud=p1 and urbrus=p2 and cuenta=p3;
   return vid_registro;
end if;
if pmod=9 then
   select id_licencia into vid_registro from catastro_gdl:licencias where licencia=p1;
   return vid_registro;
end if;
if pmod=10 then
   select id_anuncio into vid_registro from catastro_gdl:anuncios where anuncio=p1;
   return vid_registro;
end if;
if pmod=11 then
   LET cust_qry = " select id_local from ta_11_locales "
                ||" where oficina="||p1||" and num_mercado="||p2||" and categoria="||p3||" and seccion='"
                ||p4||"' and local="||p5;
if p6='' then
   LET cust_qry = cust_qry||" and letra_local is null " ;
else
   LET cust_qry = cust_qry||" and letra_local='"||p6||"'";
end if;
if p7='' then
   LET cust_qry = cust_qry||" and bloque is null " ;
else
   LET cust_qry = cust_qry||" and bloque='"||p7||"'";
end if

   PREPARE stmt_id FROM cust_qry;
   DECLARE cust_cur cursor FOR stmt_id;
   OPEN cust_cur ;

     WHILE (1 = 1)
 
        FETCH cust_cur into vid_registro;
 
        IF (SQLCODE != 100) THEN
           return vid_registro;
        ELSE
           return 0;
        END IF
 
       END WHILE
 
       CLOSE cust_cur;
 
           FREE cust_cur ;
 
           FREE stmt_id ;
end if;
if pmod=16 then
   select control_contrato into vid_registro from ta_16_contratos a, ta_16_tipo_aseo b where a.num_contrato=p2 and b.tipo_aseo=p1 and b.ctrol_aseo=a.ctrol_aseo;
   return vid_registro;
end if;
if pmod=19 then
   select id into vid_registro from dbestacion:pubmain where numesta=p1;
   return vid_registro;
end if;
if pmod=23 then
   select id into vid_registro from dbestacion:ex_contrato where no_exclusivo=p1;
   return vid_registro;
end if;


end procedure;

create function "pgcabrer".fn_getmulmerc(fid int,faxo int,fmes int)
returning money(16,2) as multa;

define v_multa, v_multatotal, v_aimporte, v_descrenta  money(16,2);
define v_folio, v_aid_local, v_aaxo, v_aperiodo, v_dmes, v_merc, v_desc, v_primermes int;
define v_fecha_desc, v_fecha_rec date;
define v_msgrenta varchar(30);

select num_mercado, nvl(id_contribuy_renta,0) into v_merc, v_desc
from ta_11_locales where id_local=fid;

let v_multatotal=0;  

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=fid and axo=faxo and periodo<=fmes 
and b.mes=month(today)
order by axo,periodo

if v_merc =214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
else
   -- calcula descuento en renta
   let v_descrenta=0;
   let v_msgrenta='';
   execute PROCEDURE sp_desctorenta( v_aid_local, v_aaxo, v_aperiodo, v_aimporte) into v_descrenta, v_msgrenta;
end if;

-- calcula la multa
let v_multa=0;
execute procedure spd_11_calc_multa(v_merc, (v_aimporte-v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;

-- acumula multa por a�o
let v_multatotal=v_multatotal+v_multa;

end foreach; -- cierre de los periodos

return v_multatotal;
end function;

CREATE PROCEDURE "pgcabrer".sp34_desctomulta( par_id int, par_axo smallint, par_mes smallint, par_multa money(15,2))

RETURNING money as descuento,
          varchar(30) as mensage;

-- se modifica validacion del a�o actual 07/09/2021

define v_descto  money(16,2);
define v_porcentaje  int;
define v_porccovid19 decimal(5,2);
define v_id       int;
define v_axoi       int;
define v_mesi      int;
define v_axof      int;
define v_mesf      int;
define v_men      varchar(30);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'ex_desctomulta ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let    v_descto=0;
let    v_porcentaje=0;
let    v_axoi=0;
let    v_mesi=0;
let    v_axof=0;
let    v_mesf=0;
let    v_men='Ini';

select porcentaje, id_descto, axoinicio, mesinicio, axofin, mesfin
into v_porcentaje, v_id, v_axoi, v_mesi, v_axof, v_mesf
from t34_descmul where id_contrato =par_id and vigencia='V';
if v_axoi=0 then
   let v_men=('sin calcular '||par_multa||' '||v_porcentaje);
else
   if v_axoi=par_axo then
      if par_axo<year(today) then
         if v_axof=par_axo then 
            if par_mes<=v_mesf then
               let v_descto=(par_multa * v_porcentaje)/100;
            else
               let v_descto=0;
            end if;
         else
            let v_descto=(par_multa * v_porcentaje)/100;
         end if;
      else
         if par_mes<=v_mesf then 
             let v_descto=(par_multa * v_porcentaje)/100;
         else
             let v_descto=0;
         end if;
      end if;
      let v_men=('entre 1 '||par_multa||' '||v_porcentaje);
   else
      if v_axof=par_axo then
         if v_mesf>=par_mes then
            let v_descto=(par_multa * v_porcentaje)/100;
         else
            let v_descto=0;
         end if;
         let v_men=('entre 2 '||par_multa||' '||v_porcentaje);
      else
         if v_axoi<par_axo then
            if v_axof>par_axo then
               let v_descto=(par_multa * v_porcentaje)/100;
            else
               let v_descto=0;
            end if;
            let v_men=('entre 3 '||par_multa||' '||v_porcentaje);
         else
            let v_descto=0;
            let v_men=('sin nada '||par_multa||' '||v_porcentaje); 
         end if;   
      end if;
   end if;
end if;
return v_descto,v_men;
  
END PROCEDURE;

CREATE FUNCTION "pgcabrer".admin_pago_25 ( par_Tabla Char(2), par_Control Char(10), pref varchar(20), par_imppagado money(12,2), par_impcartera money(12,2), par_impredondeo money(4,2), 
par_Id_Cobro Integer, par_Folio_rcbo Char(32), par_Fecha Date, par_Id_Rec Integer, par_Centro_Ingreso int, 
par_Caja Char(2), par_Nom_Cajero Varchar(40), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    admin_pago_25
#  Descripcion:      Interfaz de pago para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros	par_Tabla     = Rubro de ingreso 
#  de entrada:	par_Control   = Dato de Control del registro
#  	pref   = Hasta el periodo requerido ejem: '2013-10'
#	   	par_imppagado = Importe Pagado (Importe total del recibo) 
#	   	par_impcartera = Importe de cartera pagado
#                    	par_impredondeo = Importe de Redondeo
#	   	par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#                    	par_Folio_rcbo = Folio del recibo
#                    	par_Fecha = Fecha del recibo
#                    	par_Id_Rec = recaudadora donde se realiza el pago(para nuevas solo en rec 2)
#                    	par_Centro_Ingreso = Numero de centro de Ingreso 
#                    	par_Caja = caja de pago
#                    	par_Nom_Cajero = Nombre de cajero(a)
#                    	par_Cve_Usuario = usuario de cajero(a)
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_pago en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus int;

define vp_id_34_datos, v_oficina, v_id_usuario	Integer;
define v_propietario varchar(92);
define v_calle, v_tipo_aseo	varchar(80);
define v_status_vigencia	Char(1);
--*****
define v_monto_cartera	Money(12,2);
--*****
define v_control_contrato, v_ctrol_operacion, v_id_34_stat	Integer;
define v_aso_mes_pago	char(7);
define v_Axo_ini, v_Mes_ini, v_Axo_fin, v_Mes_fin	Smallint;
define v_Cuento	Smallint;
--*****
define v_id_control	Integer;
define v_importe_gastos	Money(12,2);
--*****
define v_cuentaaplicacion	Integer;
define v_monto	Money(12,2);
define v_Cuento_1	Smallint;

define v_nombre	VarChar(100);
define v_tipo_obligacion	VarChar(50);
define v_Centro_Ingreso	Integer; -- HASTA QUE CONFIRME ADMIN ESTE DATO

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define d_rubro,d_concepto,d_cuenta int;
define d_referencia varchar(30);
define d_descripcion  varchar(120);
define d_monto,d_acumulado decimal(14,2);
--set debug file to "gil22.log";
--trace on;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -911, 'Error en transaccion de Otras Obligaciones ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 -- ejecuta el procedimiento adeudo detalle
    foreach execute procedure admin_adeudos_detalle_25odoo ( par_Tabla , par_Control , pref )
    into  d_rubro,d_concepto,d_cuenta,d_referencia,d_descripcion,d_monto,d_acumulado

end foreach;

let v_leyenda    	= 'PAGO REALIZADO';
let v_estatus	= 0;

Let v_Centro_Ingreso = 0;
Let v_Axo_ini = 0;
Let v_Mes_Ini = 0;
Let v_Axo_fin = 0;
Let v_Mes_fin = 0;

Let v_Cuento = 0;
Let v_Cuento_1 = 0;
Let v_id_control = 0;
Let v_importe_gastos = 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--************************************************************************ STATUS
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'P';
--************************************************************************ TABLA
SELECT a.nombre, b.tipo_obligacion  INTO  v_nombre, v_tipo_obligacion  
FROM t34_tablas a, t34_ctasaplic b  WHERE a.cve_tab = par_Tabla  and tipo_var = 'T'  and b.cve_tab = a.cve_tab;
--************************************************************************
--let v_id_usuario = 0;  --  trampa

let vp_id_34_datos = 0;
if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then 
SELECT a.id_34_datos, a.concesionario, a.ubicacion, a.id_recaudadora 
INTO vp_id_34_datos, v_propietario, v_calle, v_oficina 
FROM t34_datos A    WHERE a.cve_tab = par_Tabla and a.control = par_Control;

Let v_control_contrato  = 0;
Let v_ctrol_operacion = 0;
Let v_aso_mes_pago = '';

BEGIN WORK;	
FOREACH
SELECT a.control_contrato, a.aso_mes_pago, a.ctrol_operacion
INTO  v_control_contrato, v_aso_mes_pago, v_ctrol_operacion
FROM tmp_detalle_otras_oblig a  WHERE a.tipo_movto <> 'R'  
ORDER BY a.aso_mes_pago, a.ctrol_operacion

if v_Cuento = 0 then
Let v_Axo_ini = substr(v_aso_mes_pago,1,4);
Let v_Mes_Ini = substr(v_aso_mes_pago,6,2);

Let v_Axo_fin = substr(v_aso_mes_pago,1,4);
Let v_Mes_fin = substr(v_aso_mes_pago,6,2);
Let v_Cuento = 1;
else
Let v_Axo_fin = substr(v_aso_mes_pago,1,4);
Let v_Mes_fin = substr(v_aso_mes_pago,6,2);
end if;

UPDATE t34_pagos set 
id_stat = v_id_34_stat,  fecha_hora_pago = par_Fecha,  id_recaudadora = par_Id_Rec, 
caja = par_Caja,  operacion = par_Id_Cobro,  folio_recibo = par_Folio_rcbo,  usuario = Trim(par_Cve_Usuario) 
WHERE id_datos = v_control_contrato AND periodo = v_aso_mes_pago; 
END FOREACH;

Let v_control_contrato  = 0;
Let v_ctrol_operacion = 0;
Let v_aso_mes_pago = '';
Let v_id_control = 0;
Let v_importe_gastos = 0;
FOREACH
SELECT a.control_contrato, a.aso_mes_pago, a.ctrol_operacion
INTO  v_control_contrato, v_aso_mes_pago, v_ctrol_operacion
FROM tmp_detalle_otras_oblig a  WHERE a.tipo_movto = 'R'  
ORDER BY a.aso_mes_pago, a.ctrol_operacion

if exists( SELECT * FROM ta_15_apremios  WHERE id_control = v_control_contrato ) then
SELECT id_control, importe_gastos INTO v_id_control, v_importe_gastos  FROM ta_15_apremios
                       	WHERE id_control = v_control_contrato;

UPDATE ta_15_apremios SET 
fecha_pago = par_Fecha,  recaudadora = par_Id_Rec, caja = par_Caja,  
operacion = par_Id_Cobro, vigencia='2', clave_mov = 'P', importe_pago = v_importe_gastos
WHERE id_control = v_control_contrato;
end if;
END FOREACH;

-- GRABAR DATOS EN REGISTRO DE DESCUENTO RECARGOS
UPDATE db_ingresos:t34_descrec SET 
fec_pag = par_Fecha, id_rec = par_Id_Rec, caja = par_Caja, operac = par_Id_Cobro, vigencia = 'P'
WHERE id_contrato = vp_id_34_datos and vigencia = 'V';

-- GRABAR DATOS EN REGISTRO DE DESCUENTO MULTA
UPDATE db_ingresos:t34_descmul SET 
fec_pag = par_Fecha, id_rec = par_Id_Rec, caja = par_Caja, operac = par_Id_Cobro, vigencia = 'P'
WHERE id_contrato = vp_id_34_datos and vigencia = 'V';

-- GRABA RECIBO
insert into  ta_12_recibos(fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, id_regmodulo, id_rec_cta, 
mesdesde, axodesde, meshasta, axohasta, nombre, domicilio, concepto, fecha_act, descripcion, id_usuario, id_centro, foliorecibo) 
values(par_Fecha, par_Id_Rec, par_Caja, par_Id_Cobro, par_imppagado, 'P' ,34, vp_id_34_datos, par_Id_Rec, 
v_Mes_Ini, v_Axo_ini, v_Mes_fin, v_Axo_fin, v_propietario, v_calle, 'PAGO DE SERVICIO DE ' || v_tipo_obligacion || ' DE ' || v_nombre, current, 
par_Nom_Cajero, v_id_usuario, v_Centro_Ingreso, par_Folio_rcbo);

Let v_cuentaaplicacion = 0;
Let v_monto = 0; 
FOREACH 
SELECT cuenta,sum(monto)  INTO v_cuentaaplicacion, v_monto 
FROM tmp_total_otras_oblig GROUP BY cuenta ORDER BY cuenta

let v_Cuento_1 = v_Cuento_1 + 1;

insert into ta_12_recibosdet(fecha, id_rec, caja, operacion, linea, descripcion, cuenta, importe) 
values(par_Fecha, par_Id_Rec, par_Caja, par_Id_Cobro, v_Cuento_1, '', v_cuentaaplicacion, v_monto); 
END FOREACH;

if par_impredondeo <> 0 then
let v_Cuento_1 = v_Cuento_1 + 1;
insert into ta_12_recibosdet(fecha, id_rec, caja, operacion, linea, descripcion, cuenta, importe)
values(par_Fecha, par_Id_Rec, par_Caja, par_Id_Cobro, v_Cuento_1, '', 550800000, par_impredondeo);
end if;

DELETE FROM tmp_detalle_otras_oblig;
DELETE FROM tmp_total_otras_oblig; 

COMMIT WORK; 
else
         	let v_leyenda = 'REFERENCIA NO EXISTE';
         	let v_estatus  = -1;
end if;

RETURN v_estatus,v_leyenda;

--trace off;
end function;

CREATE FUNCTION "pgcabrer".admin_cancela_25 ( par_Id_Cobro Integer, par_Folio_rcbo Char(30), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    admin_cancela_25
#  Descripcion:      Interfaz de pago para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros        	par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#  de entrada:        	par_Folio_rcbo = Folio del recibo
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus, v_id_34_stat int;
define v_id_usuario	int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en transaccion de Otras Obligaciones ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda    	= 'CANCELACION DE RECIBO Y REACTIVACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO 
SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
--************************************************************************ STATUS
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = 'V';
--************************************************************************

if exists( SELECT a.* FROM t34_pagos a, t34_status b WHERE a.operacion = par_Id_Cobro AND a.folio_recibo = par_Folio_rcbo 
AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('P')  ) then

BEGIN WORK;	
               	UPDATE t34_pagos set
                               	id_stat = v_id_34_stat,  fecha_hora_pago = Null,  id_recaudadora = 0,  
caja = ' ',  operacion = 0,  folio_recibo = ' ',  usuario = Trim(par_Cve_Usuario) 
WHERE operacion = par_Id_Cobro AND folio_recibo = par_Folio_rcbo;

UPDATE ta_15_apremios SET 
fecha_pago = Null, recaudadora = 0,  caja = ' ',  
operacion = 0,  importe_pago = 0,  vigencia = '1'
                       	WHERE modulo = 16 AND operacion = par_Id_Cobro;

UPDATE ta_12_recibos SET 
cvepago = 'C', id_usuario = v_id_usuario 
WHERE operacion = par_Id_Cobro AND foliorecibo = par_Folio_rcbo AND cvepago = 'P';

-- GRABAR DATOS EN REGISTRO DE DESCUENTO RECARGOS
UPDATE db_ingresos:t34_descrec SET 
fec_pag = Null, id_rec = Null, caja = Null, operac = Null, vigencia = 'V' 
WHERE operac = par_Id_Cobro and vigencia = 'P';

-- GRABAR DATOS EN REGISTRO DE DESCUENTO MULTAS
UPDATE db_ingresos:t34_descmul SET 
fec_pag = Null, id_rec = Null, caja = Null, operac = Null, vigencia = 'V' 
WHERE operac = par_Id_Cobro and vigencia = 'P';

COMMIT WORK; 
else
         	let v_leyenda = 'NO EXISTE REGISTRO CON ESTE DATO';
         	let v_estatus  = 1;
end if;

RETURN v_estatus,v_leyenda;

end function;

create procedure "pgcabrer".spd_17_desgloce2021beny(pid int)
returning   int as parcial,
            money(16,2) as importe,
            money(16,2) as interes,
            money(16,2) as pago_total,
            date as vencimiento,
            char(1) as cveparcial,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst;

define v_parcial,v_axodsd,v_mesdsd,v_axohst,meshst,v_idlocal,v_ctaimp,v_ctarec,v_ctaact,v_ctamul int;
define v_pagos,v_mod,v_axodet,v_mesdet,v_cont,v_reg,v_linea,v_diac int; 
define v_apdsd,v_mpdsd,v_aphst,v_mphst,v_totlin,v_totreg,v_mes,v_dia,v_axo int; 
define v_imprte,v_inicial,v_impdet,v_recdet,v_saldo,v_impparc,v_actdet,v_muldet,v_cant_total money(16,2);
define v_parc_total, v_interes, pparcial money(18,2);
define v_porc decimal(11,8);
define v_vencimiento,v_inicio,v_mensual date;
define v_cveparc,v_tipo_pago char(1);
define v_concdet varchar(30);

begin
    on exception in (-958)
       delete from tmp_detalle2021;
    end exception;
create temp table tmp_detalle2021(
  parcialidad int,
  adeudo money(14,2),
  interes money(14,2), 
  pago money(14,2),
  vencimiento date,
  cveparcial char(1)) with no log;
end;

let v_saldo=0;
let v_reg=0;
let v_vencimiento=null;
let v_mensual=null;
let v_totlin=0;
let v_totreg=0;
let v_linea=0;
let v_apdsd=0;
let v_mpdsd=0;
let v_aphst=0;
let v_mphst=0;
let v_linea=0;
let v_diac=0;
let v_cant_total=0;
let pparcial=0;

if not exists(select * from ta_17_conv_d_resto where id_conv_resto=pid) then 
   return 0, 0, 0, 0, null, ' ', 0, 0, 0, 0;
end if;

foreach
  select 0,6,a.fecha_inicio,nvl(b.modulo,0),nvl(b.id_referencia,0),nvl(b.axo_desde,0),
   nvl(b.mes_desde,0),nvl(b.axo_hasta,0),nvl(b.mes_hasta,0),a.tipo_pago,839039.04
  into v_inicial,v_pagos,v_inicio,v_mod,v_idlocal,v_axodsd,v_mesdsd,v_axohst,meshst,v_tipo_pago,v_cant_total
  from ta_17_conv_d_resto a,ta_17_referencia b where a.id_conv_resto=pid
  and b.id_conv_resto=a.id_conv_resto
end foreach;

-- obtine el porcentaje del interes
select nvl(porcentaje,0) into v_porc from ta_12_intereses where axo=year(v_inicio) and mes=month(v_inicio);
if v_porc is null then
   let v_porc=0;
end if;

-- Empieza el calculo las parcialidades

-- inserta el pago inicial
let v_saldo=v_cant_total - v_inicial;
--insert into tmp_detalle2021 values(1, v_inicial, 0, v_inicial, v_inicio, 'I');

-- inserta parcialidades
execute function fn_17_calc_parcialidad(v_porc, v_pagos, v_saldo) into pparcial;
let v_vencimiento=v_inicio;
let v_mensual=v_inicio;
let v_impparc=0;
for v_cont=1 to v_pagos
   let v_interes=(v_porc * v_saldo) / 100;
   let v_impparc=pparcial - v_interes;

   let v_diac=day(v_inicio);
   if v_diac = 31 then
      if  (month(v_mensual) = 4 or month(v_mensual) =6 or month(v_mensual) =9 or month(v_mensual) =11) then   
          let v_diac=30;
      else
          if month(v_mensual) = 2 then  
             let v_diac = 28;
          end if;
      end if;
   end if;
   if v_diac = 30 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   if v_diac = 29 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   execute function fn_17_calc_venc(mdy(month(v_mensual),v_diac,year(v_mensual)),v_tipo_pago) into v_vencimiento,v_mensual;
   insert into tmp_detalle2021 values(v_cont+1, v_impparc, v_interes,  v_impparc+v_interes, v_vencimiento, 'P');
   let v_saldo=v_saldo - v_impparc;
end for;

-- regresa las parcialidades calculadas
foreach
  select parcialidad, adeudo, interes, pago, vencimiento, cveparcial 
  into v_linea, v_impparc, v_interes, v_parc_total, v_vencimiento, v_cveparc
  from tmp_detalle2021 order by parcialidad

  return v_linea, v_impparc, v_interes, v_parc_total, v_vencimiento, v_cveparc, 0, 0, 0, 0 with resume;
end foreach;

end procedure;

CREATE PROCEDURE "pgcabrer".spd_adeudomercgrl(p_mesh smallint,p_axoh smallint)	

returning  	integer as id_local,
        	smallint as rec,   
        	smallint as merc,   
        	smallint as cat,  
        	char(2) as seccion,
        	integer as local,
            char(3) as letra,
    		char(2) as bloque,
        	char(30) as nombre, 
        	smallint as mesdesde, 
        	smallint as axodesde, 
        	smallint as meshasta, 
        	smallint as axohasta,
        	money(15,2) as adeudo, 
        	money(15,2) as recargos, 
        	money(15,2) as multa,
        	money(15,2) as gastos,
        	money(15,2) as actualizacion,
        	money(15,2) as total,
        	char(30) as mercado,
        	smallint as estatus,
        	char(60) as mensaje;

define v_estatus smallint;
define v_id_local,v_id,vid,p_licencia,p_idlicencia,p_bloqueado,p_idgiro,v_idgiro integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra1,v_let char(3);
define p_vigente char(1); 
define v_bloque1,v_blq char(2);
define v_dillic,v_dilloc char(1);
define v_nombre,p_txtbloqueado char(30);
define v_domicilio char(40);
define v_adicional,v_aprloc,v_aprlic char(20);
define v_superficie decimal(10,2);
define v_adeudo money(15,2);
define v_recargos,vactualizacion money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_actualizacion money(15,2);
define v_descuento,v_renta money(15,2);
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_folio, v_axod, v_mesd, v_axoh, v_mesh integer;
define v_per smallint;
define v_aid_local,v_follic,v_folloc integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec, v_fecha_alta date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp,v_lic integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo,v_merc,v_mer smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc,v_cvecuo integer;
define v_total money(15,2);
define v_cat,v_ofna smallint;
define v_sec char(2);
define v_loc,v_idlic integer;
define v_licencia,v_licdesc char(200);
define p_actividad varchar(130);
define p_propietario, t_leyenda varchar(80);
define p_giro,v_giro varchar(96);
define t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, t_desc_recargos, t_rec_apagar money(18,2);
define t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total money(18,2);
define t_axo, t_mes int;
define vpropietario varchar(92);
define vcalle varchar(80);
define vnumext,vnumint varchar(10);
define vrecaudadora,vzona,vaxo_desde_ade,vmes_desde_ade int;
define vderechos,vanuncios,vimpresos,vrecargos,vmultas,vgastos,vtotal,vfvlicencias,vfvanuncios,vactualizacion_anun dec(14,2);

let v_axocalc=0; 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_nom_mercado='';
let v_estatus=0;
let v_descripcion='';
let v_licencia='';
let v_renta=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_merc=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_mesmin=0;
let v_axomin=0;
let v_idlic=0;
let p_idgiro=0;

begin
    on exception in (-958)
       delete from locales;
    end exception;
create temp table locales( 
 tid_local  	integer,		--
 tofna		smallint,
 tmerc		smallint,
 tcat		smallint,
 tsec		char(2),
 tlocal		integer,
 tletra		char(3),
 tbloq		char(2),
 tmesdesde	smallint,		-- 
 taxodesde	smallint,		-- 
 tmeshasta	smallint,		-- 
 taxohasta	smallint,		--
 tnombre	char(30),		--  
 tadeudo	money(15,2),	-- 
 trecargos	money(15,2),	-- 
 tmulta	money(15,2),	--
 tgastos	money(15,2),	--
 tactualizacion money(15,2),
 ttotal	money(15,2),	--
 tnombremercado	char(30),		--
 testatus		smallint,		--
 tmensaje	char(60))  with no log;		--
end;

let v_licencia='';
let v_aprloc='';
let v_aprlic='';

    -- obtiene los datos generales
foreach
     select id_local,oficina,num_mercado,categoria,seccion,local,letra_local,bloque
	 into vid,v_ofna,v_mer,v_cat,v_sec,v_loc,v_let,v_blq 
     from ta_11_locales  where num_mercado not in(214,998,99,999) 
     order by oficina,num_mercado,categoria,seccion,local,letra_local,bloque
     if v_let is null then
        let v_letra1='';
     else
        let v_letra1=v_let;
     end if;
     if v_blq is null then
        let v_bloque1='';
     else
        let v_bloque1=v_blq;
     end if;

         select c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
         c.num_mercado,c.fecha_alta,c.clave_cuota
         into     v_id_local,v_desc,v_nombre,v_domicilio,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado,v_merc,v_fecha_alta,v_cvecuo
         from    ta_11_locales c,ta_11_mercados e
         where c.id_local=vid  and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado
	     group by c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
          c.num_mercado,c.fecha_alta,c.clave_cuota;

         if v_desc is null then
            let v_desc=0;
         end if;

         if  v_vigencia<>'A' then
             let v_estatus=4;
             let v_descripcion='LOCAL DADO DE BAJA';
         else
         if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and ((axo=p_axoh and periodo<=p_mesh) or (axo<p_axoh))) then 	
            let v_estatus=5;
            let v_descripcion='LOCAL AL CORRIENTE DE PAGOS';
         else 
            let v_recacum=0;
 
         -- totales 
         execute function spd_11_adeudototal(v_id_local,2022,12,'T') into v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axomin, v_mesmin, v_axohst, v_meshst;

         if v_adeudo>0 then 
            if  v_bloqueo=1 then
                let v_estatus=0; -- ANTES ESTATUS 3
                let v_descripcion='LOCAL CON ADEUDO CONVENIADO';
            else
                let v_estatus=0;
                let v_descripcion='LOCAL CON ADEUDO';
            end if;
         else
            let v_estatus=5;
            let v_descripcion='LOCAL AL CORRIENTE DE PAGOS';          
         end if;
        end if;
        end if;
     let v_licencia='';
     let p_giro=0;

   /*  if v_estatus=0 then
       insert into locales values(v_id_local, v_ofna, v_merc, v_cat, v_sec,v_loc, v_letra1, v_bloque1, v_mesmin, v_axomin, v_meshst, v_axohst, v_nombre, 
         v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_nom_mercado, v_estatus, v_descripcion);
     end if;	*/

     if v_estatus=0 then
       return v_id_local, v_ofna, v_merc, v_cat, v_sec,v_loc, v_letra1, v_bloque1, v_nombre, v_mesmin, v_axomin, v_meshst, v_axohst,  
         v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_nom_mercado, v_estatus, v_descripcion with resume;
     end if;

end foreach; 

/*foreach
select tid_local,tofna,tmerc,tcat,tsec,tlocal,tletra,tbloq,tmesdesde,taxodesde,tmeshasta,taxohasta,tnombre,
     tadeudo,trecargos,tmulta,tgastos,tactualizacion,ttotal,tnombremercado,testatus,tmensaje
into v_id_local,v_ofna, v_merc, v_cat, v_sec, v_loc, v_letra1, v_bloque1, v_mesmin, v_axomin, v_meshst, v_axohst, v_nombre, 
     v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_nom_mercado, v_estatus, v_descripcion
from locales order by tofna,tmerc,tcat,tsec,tlocal,tletra,tbloq

return v_id_local,v_ofna, v_merc, v_cat,v_sec,v_loc, v_letra1,v_bloque1, v_nombre,  
    v_mesmin, v_axomin, v_meshst, v_axohst,v_adeudo, v_recargos,
	v_multa, v_gastos, v_actualizacion, v_total, v_nom_mercado, v_estatus, v_descripcion with resume;
end foreach;
-- borrar tabla temporal
delete from locales; */
end procedure;

create procedure "pgcabrer".spd_11_padronade(paxo int,pmes int,ptip char(1))
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(60) as nombre,
            integer as zona,
            decimal(8,2) as superficie,
            money(7,2) as costo_mtr2013,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo_anterior,
            MONEY(16,2) as recargos_anterior,
            MONEY(16,2) as actualizacion_anterior,
            MONEY(16,2) as multa_anterior,
            MONEY(16,2) as adeudo2001,
            MONEY(16,2) as recargos2001,
            MONEY(16,2) as actualizacion2001,
            MONEY(16,2) as multa2001,
            MONEY(16,2) as adeudo2002,
            MONEY(16,2) as recargos2002,
            MONEY(16,2) as actualizacion2002,
            MONEY(16,2) as multa2002,
            MONEY(16,2) as adeudo2003,
            MONEY(16,2) as recargos2003,
            MONEY(16,2) as actualizacion2003,
            MONEY(16,2) as multa2003,
            MONEY(16,2) as adeudo2004,
            MONEY(16,2) as recargos2004,
            MONEY(16,2) as actualizacion2004,
            MONEY(16,2) as multa2004,
            MONEY(16,2) as adeudo2005,
            MONEY(16,2) as recargos2005,
            MONEY(16,2) as actualizacion2005,
            MONEY(16,2) as multa2005,
            MONEY(16,2) as adeudo2006,
            MONEY(16,2) as recargos2006,
            MONEY(16,2) as actualizacion2006,
            MONEY(16,2) as multa2006,
            MONEY(16,2) as adeudo2007,
            MONEY(16,2) as recargos2007,
            MONEY(16,2) as actualizacion2007,
            MONEY(16,2) as multa2007,
            MONEY(16,2) as adeudo2008,
            MONEY(16,2) as recargos2008,
            MONEY(16,2) as actualizacion2008,
            MONEY(16,2) as multa2008,
            MONEY(16,2) as adeudo2009,
            MONEY(16,2) as recargos2009,
            MONEY(16,2) as actualizacion2009,
            MONEY(16,2) as multa2009,
            MONEY(16,2) as adeudo2010,
            MONEY(16,2) as recargos2010,
            MONEY(16,2) as actualizacion2010,
            MONEY(16,2) as multa2010,
            MONEY(16,2) as adeudo2011,
            MONEY(16,2) as recargos2011,
            MONEY(16,2) as actualizacion2011,
            MONEY(16,2) as multa2011,
            MONEY(16,2) as adeudo2012,
            MONEY(16,2) as recargos2012,
            MONEY(16,2) as actualizacion2012,
            MONEY(16,2) as multa2012,
            MONEY(16,2) as adeudo2013,
            MONEY(16,2) as recargos2013,
            MONEY(16,2) as actualizacion2013,
            MONEY(16,2) as multa2013,
            MONEY(16,2) as adeudo2014,
            MONEY(16,2) as recargos2014,
            MONEY(16,2) as actualizacion2014,
            MONEY(16,2) as multa2014,
            MONEY(16,2) as adeudo2015,
            MONEY(16,2) as recargos2015,
            MONEY(16,2) as actualizacion2015,
            MONEY(16,2) as multa2015,
            MONEY(16,2) as adeudo2016,
            MONEY(16,2) as recargos2016,
            MONEY(16,2) as actualizacion2016,
            MONEY(16,2) as multa2016,
            MONEY(16,2) as adeudo2017,
            MONEY(16,2) as recargos2017,
            MONEY(16,2) as actualizacion2017,
            MONEY(16,2) as multa2017,
            MONEY(16,2) as adeudo2018,
            MONEY(16,2) as recargos2018,
            MONEY(16,2) as actualizacion2018,
            MONEY(16,2) as multa2018,
            MONEY(16,2) as adeudo2019,
            MONEY(16,2) as recargos2019,
            MONEY(16,2) as actualizacion2019,
            MONEY(16,2) as multa2019,
            MONEY(16,2) as adeudo2020,
            MONEY(16,2) as recargos2020,
            MONEY(16,2) as actualizacion2020,
            MONEY(16,2) as multa2020,
            MONEY(16,2) as adeudo2021,
            MONEY(16,2) as recargos2021,
            MONEY(16,2) as actualizacion2021,
            MONEY(16,2) as multa2021,
            MONEY(16,2) as adeudo2022,
            MONEY(16,2) as recargos2022,
            MONEY(16,2) as actualizacion2022,
            MONEY(16,2) as multa2022,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total,
            char(5000) as folios;
  
define v_rec2001, v_rec2002, v_rec2003, v_rec2004, v_rec2005, v_rec2006,
       v_rec2007, v_rec2008, v_rec2009, v_rec2010, v_rec2011, v_rec2012, v_rec2013,
       v_rec2014, v_rec2015, v_rec2016, v_rec2017, v_rec2018, v_rec2019, v_rec2020, v_rec2021, v_rec2022  MONEY(16,2);

define v_ade2001, v_ade2002, v_ade2003, v_ade2004, v_ade2005, v_ade2006,
       v_ade2007, v_ade2008, v_ade2009, v_ade2010, v_ade2011, v_ade2012, v_ade2013,
       v_ade2014, v_ade2015, v_ade2016, v_ade2017, v_ade2018, v_ade2019, v_ade2020, v_ade2021, v_ade2022  MONEY(16,2); 

define v_act2001, v_act2002, v_act2003, v_act2004, v_act2005, v_act2006,
       v_act2007, v_act2008, v_act2009, v_act2010, v_act2011, v_act2012, v_act2013,
       v_act2014, v_act2015, v_act2016, v_act2017, v_act2018, v_act2019, v_act2020, v_act2021, v_act2022  MONEY(16,2); 

define v_mul2001, v_mul2002, v_mul2003, v_mul2004, v_mul2005, v_mul2006,
       v_mul2007, v_mul2008, v_mul2009, v_mul2010, v_mul2011, v_mul2012, v_mul2013,
       v_mul2014, v_mul2015, v_mul2016, v_mul2017, v_mul2018, v_mul2019, v_mul2020, v_mul2021, v_mul2022  MONEY(16,2);
 
define v_actuaizacionanterior, v_actualizacion money(16,2);
define v_recargostotal money(16,2);
define v_multaanterior, v_multa, v_descrenta MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer, v_msgrenta char(30);          
define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(3);           define v_blq char(2);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);       define v_zona int;
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_actuaizacionanterior=0;
let v_multaanterior=0;
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 


foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,nvl(sum(d.importe),0)
,fn_getademerc(a.id_local,2001,12),fn_getrecmerc(a.id_local,2001,12),fn_getactmerc(a.id_local,2001,12),fn_getmulmerc(a.id_local,2001,12)
,fn_getademerc(a.id_local,2002,12),fn_getrecmerc(a.id_local,2002,12),fn_getactmerc(a.id_local,2002,12),fn_getmulmerc(a.id_local,2002,12)
,fn_getademerc(a.id_local,2003,12),fn_getrecmerc(a.id_local,2003,12),fn_getactmerc(a.id_local,2003,12),fn_getmulmerc(a.id_local,2003,12)
,fn_getademerc(a.id_local,2004,12),fn_getrecmerc(a.id_local,2004,12),fn_getactmerc(a.id_local,2004,12),fn_getmulmerc(a.id_local,2004,12)
,fn_getademerc(a.id_local,2005,12),fn_getrecmerc(a.id_local,2005,12),fn_getactmerc(a.id_local,2005,12),fn_getmulmerc(a.id_local,2005,12)
,fn_getademerc(a.id_local,2006,12),fn_getrecmerc(a.id_local,2006,12),fn_getactmerc(a.id_local,2006,12),fn_getmulmerc(a.id_local,2006,12)
,fn_getademerc(a.id_local,2007,12),fn_getrecmerc(a.id_local,2007,12),fn_getactmerc(a.id_local,2007,12),fn_getmulmerc(a.id_local,2007,12)
,fn_getademerc(a.id_local,2008,12),fn_getrecmerc(a.id_local,2008,12),fn_getactmerc(a.id_local,2008,12),fn_getmulmerc(a.id_local,2008,12)
,fn_getademerc(a.id_local,2009,12),fn_getrecmerc(a.id_local,2009,12),fn_getactmerc(a.id_local,2009,12),fn_getmulmerc(a.id_local,2009,12)
,fn_getademerc(a.id_local,2010,12),fn_getrecmerc(a.id_local,2010,12),fn_getactmerc(a.id_local,2010,12),fn_getmulmerc(a.id_local,2010,12)
,fn_getademerc(a.id_local,2011,12),fn_getrecmerc(a.id_local,2011,12),fn_getactmerc(a.id_local,2011,12),fn_getmulmerc(a.id_local,2011,12)
,fn_getademerc(a.id_local,2012,12),fn_getrecmerc(a.id_local,2012,12),fn_getactmerc(a.id_local,2012,12),fn_getmulmerc(a.id_local,2012,12)
,fn_getademerc(a.id_local,2013,12),fn_getrecmerc(a.id_local,2013,12),fn_getactmerc(a.id_local,2013,12),fn_getmulmerc(a.id_local,2013,12)
,fn_getademerc(a.id_local,2014,12),fn_getrecmerc(a.id_local,2014,12),fn_getactmerc(a.id_local,2014,12),fn_getmulmerc(a.id_local,2014,12)
,fn_getademerc(a.id_local,2015,12),fn_getrecmerc(a.id_local,2015,12),fn_getactmerc(a.id_local,2015,12),fn_getmulmerc(a.id_local,2015,12)
,fn_getademerc(a.id_local,2016,12),fn_getrecmerc(a.id_local,2016,12),fn_getactmerc(a.id_local,2016,12),fn_getmulmerc(a.id_local,2016,12)
,fn_getademerc(a.id_local,2017,12),fn_getrecmerc(a.id_local,2017,12),fn_getactmerc(a.id_local,2017,12),fn_getmulmerc(a.id_local,2017,12)
,fn_getademerc(a.id_local,2018,12),fn_getrecmerc(a.id_local,2018,12),fn_getactmerc(a.id_local,2018,12),fn_getmulmerc(a.id_local,2018,12)
,fn_getademerc(a.id_local,2019,12),fn_getrecmerc(a.id_local,2019,12),fn_getactmerc(a.id_local,2019,12),fn_getmulmerc(a.id_local,2019,12)
,fn_getademerc(a.id_local,2020,12),fn_getrecmerc(a.id_local,2020,12),fn_getactmerc(a.id_local,2020,12),fn_getmulmerc(a.id_local,2020,12)
,fn_getademerc(a.id_local,2021,12),fn_getrecmerc(a.id_local,2021,12),fn_getactmerc(a.id_local,2021,12),fn_getmulmerc(a.id_local,2021,12)
,fn_getademerc(a.id_local,2022,pmes),fn_getrecmerc(a.id_local,2022,pmes),fn_getactmerc(a.id_local,2022,pmes),fn_getmulmerc(a.id_local,2022,pmes)
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_zona,v_superf,v_est,v_bloqueo,v_cvecuo,
v_ade,v_ade2001,v_rec2001,v_act2001,v_mul2001,v_ade2002,v_rec2002,v_act2002,v_mul2002,
v_ade2003,v_rec2003,v_act2003,v_mul2003,v_ade2004,v_rec2004,v_act2004,v_mul2004,v_ade2005,v_rec2005,v_act2005,v_mul2005,v_ade2006,v_rec2006,v_act2006,v_mul2006,
v_ade2007,v_rec2007,v_act2007,v_mul2007,v_ade2008,v_rec2008,v_act2008,v_mul2008,v_ade2009,v_rec2009,v_act2009,v_mul2009,v_ade2010,v_rec2010,v_act2010,v_mul2010,
v_ade2011,v_rec2011,v_act2011,v_mul2011,v_ade2012,v_rec2012,v_act2012,v_mul2012,v_ade2013,v_rec2013,v_act2013,v_mul2013,v_ade2014,v_rec2014,v_act2014,v_mul2014,
v_ade2015,v_rec2015,v_act2015,v_mul2015,v_ade2016,v_rec2016,v_act2016,v_mul2016,v_ade2017,v_rec2017,v_act2017,v_mul2017,v_ade2018,v_rec2018,v_act2018,v_mul2018,
v_ade2019,v_rec2019,v_act2019,v_mul2019,v_ade2020,v_rec2020,v_act2020,v_mul2020,v_ade2021,v_rec2021,v_act2021,v_mul2021,v_ade2022,v_rec2022,v_act2022,v_mul2022
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where b.tipo_emision=ptip and a.vigencia='A'
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
and d.id_local=a.id_local and (d.axo<2000  or (d.periodo<=12 and d.axo=2000))
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,bloqueo,a.clave_cuota
having (sum(d.importe)>0) or (fn_getademerc(a.id_local,2001,12))>0 or (fn_getademerc(a.id_local,2002,12))>0
or (fn_getademerc(a.id_local,2003,12))>0 or (fn_getademerc(a.id_local,2004,12))>0
or (fn_getademerc(a.id_local,2005,12))>0 or (fn_getademerc(a.id_local,2006,12))>0 
or (fn_getademerc(a.id_local,2007,12))>0 or (fn_getademerc(a.id_local,2008,12))>0 
or (fn_getademerc(a.id_local,2009,12))>0 or (fn_getademerc(a.id_local,2010,12))>0
or (fn_getademerc(a.id_local,2011,12))>0 or (fn_getademerc(a.id_local,2012,12))>0
or (fn_getademerc(a.id_local,2013,12))>0 or (fn_getademerc(a.id_local,2014,12))>0
or (fn_getademerc(a.id_local,2015,12))>0 or (fn_getademerc(a.id_local,2016,12))>0 
or (fn_getademerc(a.id_local,2017,12))>0 or (fn_getademerc(a.id_local,2018,12))>0
or (fn_getademerc(a.id_local,2019,12))>0 or (fn_getademerc(a.id_local,2020,12))>0
or (fn_getademerc(a.id_local,2021,12))>0 or (fn_getademerc(a.id_local,2022,pmes))>0
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

if v_est='A' then
   if v_bloqueo=4 then
      let v_estado='VIGENTE-BLOQUEADO';
   else
      let v_estado='VIGENTE';
   end if;
else
   let v_estado='BAJA';
end if;

select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

-- para obtener los datos de gastos
let v_folio=0;
select nvl(count(folio),0),nvl(sum(importe_gastos),0)
into v_folio,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  
let v_total=0;

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=v_idl and (a.axo<2000  or (a.periodo<=12 and a.axo=2000)) 
and b.mes=month(today)
order by axo,periodo

-- obtiene la actualiacion
let v_actualizacion=0;
execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, v_aimporte) into v_actualizacion;
let v_actuaizacionanterior=v_actuaizacionanterior+v_actualizacion;

-- calcula descuento en renta
let v_descrenta=0;
let v_msgrenta='';
execute PROCEDURE sp_desctorenta( v_idl, v_aaxo, v_aperiodo, v_aimporte) into v_descrenta, v_msgrenta;

-- calcula la multa
let v_multa=0;
execute procedure spd_11_calc_multa(v_nme, (v_aimporte-v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
let v_multaanterior=v_multaanterior+v_multa;

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if today>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

-- verifica los periodos de adeudo
select a.id_local, ( 
(select min(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo)))),
((select Max(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo))))
into v_ida,v_ini,v_fin
from   ta_11_adeudo_local a   
where  a.id_local=v_idl 
group by a.id_local;
let v_periodo=trim(v_ini);

-- verifica los folios de requerimientos
let v_requerimientos='';
foreach
select id_control,fecha_emision,folio,fecha_practicado,( 
(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
from   ta_15_apremios a   
where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
and a.fecha_emision>=mdy(1,1,2013)
order by a.fecha_emision,a.folio
let v_requerimientos=trim(v_requerimientos)||v_fol||',';
end foreach; -- cierre de apremios

let v_requerimientos=substr(v_requerimientos,1,(length(v_requerimientos)-1));
let v_total=v_ade+v_recargostotal+v_actuaizacionanterior+v_multaanterior+v_ade2001+v_rec2001+v_ade2002+v_rec2002+
v_ade2003+v_rec2003+v_ade2004+v_rec2004+v_ade2005+v_rec2005+v_ade2006+v_rec2006+v_ade2007+v_rec2007+
v_ade2008+v_rec2008+v_ade2009+v_rec2009+v_ade2010+v_rec2010+v_ade2011+v_rec2011+v_ade2012+v_rec2012+
v_ade2013+v_rec2013+v_ade2014+v_rec2014+v_ade2015+v_rec2015+v_ade2016+v_rec2016+v_ade2017+v_rec2017+
v_ade2018+v_rec2018+v_ade2019+v_rec2019+v_ade2020+v_rec2020+v_ade2021+v_rec2021+v_ade2022+v_rec2022+v_gastos+
v_act2001+v_act2002+v_act2003+v_act2004+v_act2005+v_act2006+v_act2007+v_act2008+v_act2009+v_act2010+
v_act2011+v_act2012+v_act2013+v_act2014+v_act2015+v_act2016+v_act2017+v_act2018+v_act2019+v_act2020+v_act2021+v_act2022+
v_mul2001+v_mul2002+v_mul2003+v_mul2004+v_mul2005+v_mul2006+v_mul2007+v_mul2008+v_mul2009+v_mul2010+
v_mul2011+v_mul2012+v_mul2013+v_mul2014+v_mul2015+v_mul2016+v_mul2017+v_mul2018+v_mul2019+v_mul2020+v_mul2021+v_mul2022;

return trim(v_mer),v_ofi,v_nme,trim(v_sec),v_loc,trim(v_let),trim(v_blq),trim(v_nombre),v_zona,v_superf,v_costomtr,
trim(v_estado),trim(v_periodo),v_ade,v_recargostotal,v_actuaizacionanterior,v_multaanterior,v_ade2001,v_rec2001,v_act2001,v_mul2001,v_ade2002,v_rec2002,v_act2002,v_mul2002,
v_ade2003,v_rec2003,v_act2003,v_mul2003,v_ade2004,v_rec2004,v_act2004,v_mul2004,v_ade2005,v_rec2005,v_act2005,v_mul2005,v_ade2006,v_rec2006,v_act2006,v_mul2006,
v_ade2007,v_rec2007,v_act2007,v_mul2007,v_ade2008,v_rec2008,v_act2008,v_mul2008,v_ade2009,v_rec2009,v_act2009,v_mul2009,v_ade2010,v_rec2010,v_act2010,v_mul2010,
v_ade2011,v_rec2011,v_act2011,v_mul2011,v_ade2012,v_rec2012,v_act2012,v_mul2012,v_ade2013,v_rec2013,v_act2013,v_mul2013,v_ade2014,v_rec2014,v_act2014,v_mul2014,
v_ade2015,v_rec2015,v_act2015,v_mul2015,v_ade2016,v_rec2016,v_act2016,v_mul2016,v_ade2017,v_rec2017,v_act2017,v_mul2017,v_ade2018,v_rec2018,v_act2018,v_mul2018,
v_ade2019,v_rec2019,v_act2019,v_mul2019,v_ade2020,v_rec2020,v_act2020,v_mul2020,v_ade2021,v_rec2021,v_act2021,v_mul2021,v_ade2022,v_rec2022,v_act2022,v_mul2022
,v_gastos,v_total,trim(v_requerimientos)
with resume;
end foreach; -- cierre del principal

end procedure;

create function "pgcabrer".spd_11_adeudodetalleb(p_idlocal int)
returning   int as axo,
            int as mes,
            money(18,2) as adeudo,
            money(18,2) as desc_adeudo,
            money(18,2) as ade_apagar,
            money(18,2) as recargos,
            money(18,2) as desc_recargos,
            money(18,2) as rec_apagar,
            money(18,2) as multa,
            money(18,2) as desc_multa,
            money(18,2) as mul_apagar,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total,
            varchar(100) as descuentos;

define v_axomin, v_mesmin, v_folreq, v_porcmul, dias_habil, dias_cuantos, v_aaxo, v_aperiodo int;
define v_dmes, v_desc, v_porc, p_mer, p_cvecuo, v_descrenta90 int;
define v_fecemi, v_fecreq, v_fecha_desc, v_fecha_rec date;
define v_multa, v_gastos, v_gastost, v_muldesc, v_aimporte, v_monto, v_impdesc, v_impcovid19, v_actualizacion money(18,2);
define v_ade_apagar, v_rec_apagar, v_mul_apagar, v_total, v_recargos, v_descuento, v_fact_actual money(18,2);
define v_mensaje, v_leyenda, v_descrenta, v_descrec, v_msgrenta, v_msgmulta, v_descmul varchar(100);

begin
    on exception in (-958)
       delete from tmp_adeudomerc;
    end exception;
create temp table tmp_adeudomerc(
  axo int,
  mes int,
  adeudo money(18,2),
  desc_adeudo money(18,2),
  ade_apagar money(18,2),
  recargos money(18,2),
  desc_recargos money(18,2),
  rec_apagar money(18,2),
  multa money(18,2),
  desc_multa money(18,2),
  mul_apagar money(18,2),
  actualizacion money(18,2),
  gastos money(18,2),
  total money(18,2),
  descuentos varchar(100)) with no log;
end;

let v_impcovid19=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_gastost=0;
let v_aperiodo=0;
let v_impdesc=0;
let v_muldesc=0;
let v_actualizacion=0;
let v_descrenta90=0;
let v_msgrenta='';

-- para obtener el mercado y cve de cuota
select num_mercado, clave_cuota into p_mer, p_cvecuo from ta_11_locales where id_local=p_idlocal;

-- para sacar el a�o minimo
--select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=p_idlocal;
-- para sacar el mes minimo      
--select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=p_idlocal and axo=v_axomin;

--if p_mer=70 then
--   let v_axomin=2017;
--   let v_mesmin=1;
--end if;

 -- para obtener el datos de multa y gastos
foreach
   select b.fecha_emision,nvl(b.folio,0), nvl(b.importe_multa,0),nvl(importe_gastos,0),nvl(b.porcentaje_multa,0),nvl(b.fecha_practicado,null)
   into v_fecemi,v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
   from ta_15_apremios b where b.modulo=11 and b.control_otr=p_idlocal and b.vigencia='1' and b.clave_practicado='P'
   order by  1,2
   let v_gastost=v_gastost+v_gastos;
end foreach;


   let dias_cuantos=0;

/*   select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales
   where fecha between v_fecreq and today;
   
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
--           let v_multa=v_multa*50/100;
           let v_muldesc=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
--              let v_multa=v_multa*80/100;
              let v_muldesc=v_multa*20/100;
           end if;
        end if;
    else
--        let v_multa=(v_multa*(100-v_porcmul))/100;
        let v_muldesc=(v_multa*v_porcmul)/100;
    end if; */ 


    -- obtiene el adeudo mensal
    foreach
    select a.axo, a.periodo, a.importe, b.mes, b.fecha_descuento, b.fecha_recargos, d.id_contribuy_renta
    into   v_aaxo, v_aperiodo, v_aimporte, v_dmes, v_fecha_desc, v_fecha_rec, v_desc
    from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d
    where a.id_local=p_idlocal 
    and b.mes=month(today) and d.id_local=a.id_local
    order by a.axo, a.periodo

    let v_porc=0;
    let v_monto=0;
    let v_impdesc=0;
    let v_impcovid19=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    if (p_mer=90) or (p_cvecuo=19) then
       let v_monto=v_aimporte;
    else
    if p_mer=214 then
       let v_impdesc=(v_aimporte*v_desc)/100;
       let v_monto=v_aimporte;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_monto=v_aimporte;
             else          
                let v_impdesc=v_aimporte*.10;
                let v_monto=v_aimporte;
             end if;
          else
             let v_impdesc=v_aimporte*.10;
             let v_monto=v_aimporte;  
          end if;
       else
          let v_monto=v_aimporte;
       end if;  
    end if;
    end if;

    -- calcula descuento de renta
    let v_descrenta90=0;
    execute procedure sp_desctorenta(p_idlocal,v_aaxo,v_aperiodo,v_aimporte) into v_descrenta90,v_msgrenta;

    -- calcula multa
    if (p_cvecuo=19) and (v_aaxo=2022) and (v_aperiodo=1) and today<=mdy(1,20,2022) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
       let v_multa=0;
    else
       let v_multa=0;
       execute procedure spd_11_calc_multa(p_mer, (v_aimporte-v_descrenta90), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
    end if;

    -- calcula descuento de multa
    let v_muldesc=0;
    execute PROCEDURE sp_desctomulta( p_idlocal, v_aaxo, v_aperiodo, v_multa) into v_muldesc,v_msgmulta;

    -- calcula recargos
    if (p_cvecuo=19) and (v_aaxo=2022) and (v_aperiodo=1) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
       execute procedure admin_recargos_13(p_mer,v_folreq,((v_aimporte-v_descrenta90)+v_impdesc),mdy(v_aperiodo,21,v_aaxo)) into v_recargos;
    else
       execute procedure admin_recargos_13(p_mer,v_folreq,((v_aimporte-v_descrenta90)+v_impdesc),mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos;
    end if;

    -- calcula descuento de recargos
    let v_descuento=0;
    execute procedure sp_desctomerc(p_idlocal,v_aaxo,v_aperiodo,1,(v_recargos+v_impcovid19),null,0,'',0,11) into v_descuento,v_mensaje;

    -- calcula actualizacion
    if v_impdesc=0 then
       execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, (v_aimporte-v_descrenta90)) into v_actualizacion;
    end if;

    let v_ade_apagar=0; 
    let v_rec_apagar=0; 
    let v_mul_apagar=0; 
    let v_total=0;
    let v_ade_apagar=v_aimporte-v_impdesc-v_descrenta90; 
    let v_rec_apagar=v_recargos-v_descuento; 
    let v_mul_apagar=v_multa-v_muldesc; 
    let v_total=v_ade_apagar+v_rec_apagar+v_actualizacion+v_mul_apagar;
    let v_descrenta=' ';
    let v_descrec=' ';
    let v_descmul=' ';
    if  v_descrenta90>0 then
        let v_descrenta=v_descrenta||'Renta'||' - '; 
    end if;
    if  v_impdesc>0 then
        let v_descrenta=v_descrenta||'Pronto Pago'||' - '; 
    end if;
    if  v_muldesc>0 then
        let v_descmul='Multa'||' - ';
    end if;
    if  v_descuento>0 then
        let v_descrec='Recargo'||' - ';
    end if;
    let v_impdesc=v_impdesc+v_descrenta90;
    let v_leyenda=v_descrenta||v_descmul||v_descrec;
    let v_leyenda=trim(substr(v_leyenda,1,(length(v_leyenda)-2)));
    if p_mer=70 then 
       if v_aaxo>=2017 then
          return v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
              v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda with resume;
          insert into tmp_adeudomerc values(v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
              v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda); 
       end if;
    else
       return v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
           v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda with resume;
       insert into tmp_adeudomerc values(v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
           v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda); 
    end if;
    end foreach;

end function;

create procedure "pgcabrer".sp_bajaconvenios_automatico(ptipo int, pvencidas int, pfecven date, piduser int, pusuario varchar(8))
        returning   int as totbajas,
                    int as estado,
                    varchar(100) as mensaje;

define v_totbajas, v_estado, v_tipo, v_subtipo, v_numero_exp, v_axo_exp, v_id_conv_resto, v_modulo, v_id_referencia int;
define v_axod, v_mesd, v_axoh, v_mesh, v_pago_parcial, v_parc_vencidas, dias_habil, dias_cuantos int;
define v_letras_exp char(3);
define v_fecha_venc, v_fecha_inic, v_fecha_parcialidad date;
define v_mensaje varchar(100); 

let v_totbajas=0;
let v_estado=null;
let v_mensaje='';

foreach  
    -- busca los convenios vigentes por tipo y fecha de parcialidad vencida
    select d.tipo, d.subtipo, d.letras_exp, d.numero_exp, d.axo_exp, a.id_conv_resto, a.fecha_inicio, a.fecha_venc, b.modulo, b.id_referencia,
      b.axo_desde, b.mes_desde, b.axo_hasta, b.mes_hasta 
    into v_tipo, v_subtipo, v_letras_exp, v_numero_exp, v_axo_exp, v_id_conv_resto, v_fecha_inic, v_fecha_venc, v_modulo, v_id_referencia, 
      v_axod, v_mesd, v_axoh, v_mesh
    from ta_17_conv_diverso d, ta_17_conv_d_resto a, ta_17_referencia b, ta_17_adeudos_div e
    where d.tipo<>17 and e.fecha_venc<=pfecven and a.vigencia='A' and e.id_conv_resto=a.id_conv_resto and e.clave_pago is null
    and a.tipo=d.tipo and a.id_conv_diver=d.id_conv_diver and b.id_conv_resto=a.id_conv_resto
    group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14
    having  count(e.id_adeudo)>=pvencidas
    order by 1,2,3,4,5

    -- selecciona la segunda parcialidad venciada
    let v_parc_vencidas =0;
    foreach
      select pago_parcial, fecha_venc into v_pago_parcial, v_fecha_parcialidad 
       from ta_17_adeudos_div where id_conv_resto=v_id_conv_resto and clave_pago is null and fecha_venc<=today

      let v_parc_vencidas= v_parc_vencidas +1;
      if v_parc_vencidas=pvencidas then
         exit foreach;
      end if;
    end foreach;

    -- obtiene los dias inhabiles que hay del rango de fechas
    select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales
    where fecha between v_fecha_parcialidad and today;

    -- obtine los dias habiles transcurridos desde la fecha de la segunda parcialidad vencida
    let dias_cuantos=(today-v_fecha_parcialidad)-dias_habil;

    -- si los dias habiles son mayor de 5 se cancela el convenio de lo contrario se queda como vigente
    if dias_cuantos>5 then
       -- da de baja el convenio
       update ta_17_conv_d_resto set vigencia='B', id_usuario=piduser, fecha_actual=current where id_conv_resto=v_id_conv_resto;
       let v_totbajas=v_totbajas+1;
       let v_estado=0;
       let v_mensaje='Se dieron de baja correctamente';

       -- afecta la tabla de catastro si es multa, predial, licencia � anuncio
       if (v_modulo=3) or (v_modulo=5) or (v_modulo=9) or (v_modulo=10) then
          execute procedure catastro_gdl:spd_mtto_convenios(v_modulo, v_id_referencia, v_id_conv_resto, v_fecha_inic, v_fecha_venc, 'B', v_mesd, v_axod, v_mesh, v_axoh, 2);

          if v_modulo=9 then
             execute procedure catastro_gdl:conv_licanun(v_id_referencia,'L','B',v_id_conv_resto,pusuario) into v_estado;
          end if;

          if v_modulo=10 then
             execute procedure catastro_gdl:conv_licanun(v_id_referencia,'A','B',v_id_conv_resto,pusuario) into v_estado;
          end if;

          -- inserta el saldo a favor
          execute procedure spd_17_ins_saldos(v_id_conv_resto, v_id_referencia, v_modulo,(v_letras_exp||'/'||v_numero_exp||'/'||v_axo_exp), 'A') into v_estado, v_mensaje;
       end if;

       -- proceso para recativar mercados
       if v_modulo=11 then
           -- desbloquea tabla de locales
           update ta_11_locales set bloqueo=0 where id_local=v_id_referencia;
           if v_tipo=6 then
              update ta_11_bloqueo set fecha_final=v_fecha_venc where id_local=v_id_referencia and cve_bloqueo=1 and fecha_inicio=v_fecha_inic;
           else
              if v_tipo=7 then
                 update ta_11_bloqueo set fecha_final=v_fecha_venc where id_local=v_id_referencia and cve_bloqueo=2 and fecha_inicio=v_fecha_inic;
              else
                 update ta_11_bloqueo set fecha_final=v_fecha_venc where id_local=v_id_referencia and cve_bloqueo=3 and fecha_inicio=v_fecha_inic;
              end if;
           end if;
       end if;

       -- desbloquea aseo contratado
       if v_modulo=16 then
          update ta_16_contratos set status_vigencia='V' where control_contrato=v_id_referencia;
       end if;

       -- desbloquea estacionamientos exclusivo
       if v_modulo=28 then
          update esta_ifx:ex_contrato set estatus="V" where id=v_id_referencia;
       end if;
    end if;
end foreach;
return v_totbajas, v_estado, v_mensaje;
end procedure;

CREATE PROCEDURE "pgcabrer".spd_adeudomerc(p_merc smallint,p_mesh smallint,p_axoh smallint)	

returning  	integer as id_local,
        	smallint as rec,   
        	smallint as merc,   
        	smallint as cat,  
        	char(2) as seccion,
        	integer as local,
            char(3) as letra,
    		char(2) as bloque,
        	char(30) as nombre, 
        	char(40) as domicilio,
        	char(20) as adeicionales,
            int as giro,
            varchar(100) as descripciongiro,
            date as fechaalta, 
        	decimal(10,2) as superficie,
            money(15,2) as renta, 
        	smallint as mesdesde, 
        	smallint as axodesde, 
        	smallint as meshasta, 
        	smallint as axohasta,
        	money(15,2) as adeudo, 
        	money(15,2) as recargos, 
        	money(15,2) as multa,
        	money(15,2) as gastos,
        	money(15,2) as actualizacion,
        	money(15,2) as total,
        	money(15,2) as descuento, 
        	char(30) as mercado,
        	smallint as estatus,
        	char(60) as mensaje,
            char(200) as licencia,
            varchar(20) as reqlocal,
            varchar(20) as reqlic;

define v_estatus smallint;
define v_id_local,v_id,vid,p_licencia,p_idlicencia,p_bloqueado,p_idgiro,v_idgiro integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_letra1,v_let char(3);
define p_vigente char(1); 
define v_bloque1,v_blq char(2);
define v_dillic,v_dilloc char(1);
define v_nombre,p_txtbloqueado char(30);
define v_domicilio char(40);
define v_adicional,v_aprloc,v_aprlic char(20);
define v_superficie decimal(10,2);
define v_adeudo money(15,2);
define v_recargos,vactualizacion money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_actualizacion money(15,2);
define v_descuento,v_renta money(15,2);
define v_nom_mercado char(30);
define v_descripcion char(60);
define v_folio integer;
define v_per smallint;
define v_aid_local,v_follic,v_folloc integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec, v_fecha_alta date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp,v_lic integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo,v_merc,v_mer smallint;
define v_recacum money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc,v_cvecuo integer;
define v_total money(15,2);
define v_cat,v_ofna smallint;
define v_sec char(2);
define v_loc,v_idlic integer;
define v_licencia,v_licdesc char(200);
define p_actividad varchar(130);
define p_propietario, t_leyenda varchar(80);
define p_giro,v_giro varchar(96);
define t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, t_desc_recargos, t_rec_apagar money(18,2);
define t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total money(18,2);
define t_axo, t_mes int;
define vpropietario varchar(92);
define vcalle varchar(80);
define vnumext,vnumint varchar(10);
define vrecaudadora,vzona,vaxo_desde_ade,vmes_desde_ade int;
define vderechos,vanuncios,vimpresos,vrecargos,vmultas,vgastos,vtotal,vfvlicencias,vfvanuncios,vactualizacion_anun dec(14,2);

let v_axocalc=0; 
let v_id_local=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_nombre='';
let v_domicilio='';
let v_adicional='';
let v_superficie=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_nom_mercado='';
let v_estatus=0;
let v_descripcion='';
let v_licencia='';
let v_renta=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_merc=0;
let v_descuento=0;
let v_adeacum=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_mesmin=0;
let v_axomin=0;
let v_idlic=0;
let p_idgiro=0;

begin
    on exception in (-958)
       delete from locales;
    end exception;
create temp table locales( 
 tid_local  	integer,		--
 tofna		smallint,
 tmerc		smallint,
 tcat		smallint,
 tsec		char(2),
 tlocal		integer,
 tletra		char(3),
 tbloq		char(2),
 tmesdesde	smallint,		-- 
 taxodesde	smallint,		-- 
 tmeshasta	smallint,		-- 
 taxohasta	smallint,		--
 tnombre	char(30),		-- 
 tdomicilio	char(40),		--
 tadicional	char(20),  	-- 
 tsuperficie	decimal(10,2),	-- 
 tadeudo	money(15,2),	-- 
 trecargos	money(15,2),	-- 
 tmulta	money(15,2),	--
 tgastos	money(15,2),	--
 tactualizacion money(15,2),
 ttotal	money(15,2),	--
 tdescuento	money(15,2),	-- 
 tnombremercado	char(30),		--
 testatus		smallint,		--
 tmensaje	char(60),
 tlicencia char(200),
 treqlocal varchar(20),
 treqlic varchar(20),
 tidgiro int,
 tgiro varchar(100),
 tfalta date,
 trenta money(15,2))  with no log;		--
end;

    -- obtiene los datos generales
foreach
     select id_local,oficina,num_mercado,categoria,seccion,local,letra_local,bloque
	 into vid,v_ofna,v_mer,v_cat,v_sec,v_loc,v_let,v_blq 
     from ta_11_locales  where num_mercado=p_merc 
     order by oficina,num_mercado,categoria,seccion,local,letra_local,bloque
     if v_let is null then
        let v_letra1='';
     else
        let v_letra1=v_let;
     end if;
     if v_blq is null then
        let v_bloque1='';
     else
        let v_bloque1=v_blq;
     end if;

         select c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
         c.num_mercado,c.fecha_alta,c.clave_cuota
         into     v_id_local,v_desc,v_nombre,v_domicilio,v_adicional,v_superficie,v_vigencia,v_bloqueo,v_nom_mercado,v_merc,v_fecha_alta,v_cvecuo
         from    ta_11_locales c,ta_11_mercados e
         where c.id_local=vid  and e.oficina=c.oficina and e.num_mercado_nvo=c.num_mercado
	     group by c.id_local,c.id_contribuy_renta,c.nombre,c.domicilio,c.descripcion_local,c.superficie,c.vigencia,c.bloqueo,e.descripcion,
          c.num_mercado,c.fecha_alta,c.clave_cuota;

         if v_desc is null then
            let v_desc=0;
         end if;

         if  v_vigencia<>'A' then
             let v_estatus=4;
             let v_descripcion='LOCAL DADO DE BAJA';
         else
         if not exists(select * from ta_11_adeudo_local where id_local=v_id_local and ((axo=p_axoh and periodo<=p_mesh) or (axo<p_axoh))) then 	
            let v_estatus=5;
            let v_descripcion='LOCAL AL CORRIENTE DE PAGOS';
         else 
            let v_recacum=0;
 
         -- para sacar el a�o minimo
         if p_merc=70 then
            select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local and axo>2016;
         else
            select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id_local;
         end if;

         -- para sacar el mes minimo
         select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id_local and axo=v_axomin;

         -- calcula la renta
         execute procedure spd_11_calc_renta(year(today),v_cat,v_sec,v_cvecuo,v_superficie,v_mer,1) into v_renta;

         -- ejecuta tabla de detalle para generar tabla temporal
         foreach
           execute function spd_11_adeudodetalle(v_id_local) into t_axo, t_mes, t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, 
           t_desc_recargos, t_rec_apagar, t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total, t_leyenda
         end foreach;

         -- totales de tabla temporal  
         select sum(adeudo), sum(rec_apagar), sum(mul_apagar), max(gastos), sum(actualizacion),
               (sum(adeudo)+sum(rec_apagar)+sum(mul_apagar)+max(gastos)+sum(actualizacion)),
           nvl((select min(axo) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) )),0),
           nvl((select min(mes) from tmp_adeudomerc where axo=(select min(axo) from tmp_adeudomerc 
             where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) ))),0),
           nvl((select Max(axo) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) )),0),
           nvl((select max(mes) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) ) 
             and axo=(select Max(axo) from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) ))),0)
         into v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axomin, v_mesmin, v_axohst, v_meshst 
         from tmp_adeudomerc where ( (axo>v_axomin or (mes>=v_mesmin and axo=v_axomin)) and (axo<p_axoh or (mes<=p_mesh and axo=p_axoh)) );

         if v_adeudo>0 then 
            if  v_bloqueo=1 then
                let v_estatus=0; -- ANTES ESTATUS 3
                let v_descripcion='LOCAL CON ADEUDO CONVENIADO';
            else
                let v_estatus=0;
                let v_descripcion='LOCAL CON ADEUDO';
            end if;
         else
            let v_estatus=5;
            let v_descripcion='LOCAL AL CORRIENTE DE PAGOS';          
         end if;
        end if;
        end if;
     let v_licencia='';
     let p_giro=0;

     foreach
     select nvl(b.licencia,0),nvl(b.id_licencia,0) into v_lic,v_idlic
     from ta_11_licencias a,catastro_gdl:licencias b where a.id_local=v_id_local
     and a.vigencia='V' and b.id_licencia=a.id_licencia

       execute procedure catastro_gdl:spget_lic_estatus(v_lic) into p_licencia,p_idlicencia,p_actividad,p_propietario,
                       p_bloqueado,p_txtbloqueado,p_vigente,p_idgiro,p_giro;

       foreach
       execute procedure catastro_gdl:spget_lic_datosconv('L',v_idlic,year(today)) into vpropietario,vcalle,
                         vnumext,vnumint,vrecaudadora,vzona,vaxo_desde_ade,vmes_desde_ade,
                         vderechos,vfvlicencias,vanuncios,vfvanuncios,vimpresos,vrecargos,vactualizacion,vactualizacion_anun,vmultas,vgastos,vtotal
       end foreach;

       if vtotal=0 then
          let v_licencia=trim(v_licencia)||p_licencia||'-PAGADA,';
       else
          let v_licencia=trim(v_licencia)||p_licencia||'-ADEUDA,';
       end if;
     end foreach;
     let v_licencia=substr(v_licencia,1,(length(v_licencia)-1));

     -- agrega las not y req de locales 4/08/2014
     let v_aprloc='';
     foreach
     select diligencia,nvl(count(*),0) into v_dilloc,v_folloc from ta_15_apremios 
     where modulo=11 and control_otr=v_id_local
     and vigencia='1' and clave_practicado='P' and year(fecha_emision)=year(today)
     group by diligencia order by diligencia
     let v_aprloc=trim(v_aprloc)||' '||v_dilloc||'-'||v_folloc;
     end foreach;
     -- agrega las not y req de licencias 4/08/2014
     let v_aprlic='';

     foreach
     select cveproceso,nvl(count(*),0) into v_dillic,v_follic from catastro_gdl:reqlicencias
     where id_licencia=v_idlic
     and vigencia='V' and fecprac is not null and year(fecemi)=year(today)
     group by cveproceso order by cveproceso
     let v_aprlic=trim(v_aprlic)||' '||v_dillic||'-'||v_follic;
     end foreach;

     let v_aprlic=trim(v_aprlic);

     if v_estatus=0 then
       insert into locales values(v_id_local, v_ofna, v_merc, v_cat, v_sec,v_loc, v_letra1, v_bloque1, v_mesmin, v_axomin, v_meshst,
		    v_axohst, v_nombre, v_domicilio, v_adicional, v_superficie, v_adeudo, v_recargos,
		    v_multa, v_gastos, v_actualizacion, v_total, v_descuento, v_nom_mercado, v_estatus, v_descripcion, trim(v_licencia),trim(v_aprloc),trim(v_aprlic),
            p_idgiro,p_giro,v_fecha_alta,v_renta);
     end if;	

end foreach;

foreach
select tid_local,tofna,tmerc,tcat,tsec,tlocal,tletra,tbloq,tmesdesde,taxodesde,tmeshasta, 
     taxohasta,tnombre,tdomicilio,tadicional,tsuperficie,tadeudo,trecargos,tmulta,tgastos,tactualizacion,
     ttotal,tdescuento,tnombremercado,testatus,tmensaje,tlicencia,treqlocal,treqlic,tidgiro,tgiro,tfalta,trenta
into v_id_local,v_ofna, v_merc, v_cat, v_sec, v_loc, v_letra1, v_bloque1, v_mesmin, v_axomin, v_meshst,
	 v_axohst, v_nombre, v_domicilio, v_adicional, v_superficie, v_adeudo, v_recargos,
	v_multa, v_gastos, v_actualizacion, v_total, v_descuento, v_nom_mercado, v_estatus, v_descripcion, v_licdesc,v_aprloc,v_aprlic,
    v_idgiro,v_giro,v_fecha_alta,v_renta
from locales order by tofna,tmerc,tcat,tsec,tlocal,tletra,tbloq

return v_id_local,v_ofna, v_merc, v_cat,v_sec,v_loc, v_letra1,v_bloque1, v_nombre, v_domicilio, 
    v_adicional, v_idgiro, v_giro, v_fecha_alta, v_superficie, v_renta, v_mesmin, v_axomin, v_meshst, v_axohst,v_adeudo, v_recargos,
	v_multa, v_gastos, v_actualizacion, v_total, v_descuento, v_nom_mercado, v_estatus, v_descripcion, trim(v_licdesc),v_aprloc,v_aprlic
with resume;
end foreach;
-- borrar tabla temporal
delete from locales;
end procedure;

create function "pgcabrer".spd_11_mesesadeudoaxo(p_rec int, p_mer int, p_axo int, p_mes int, p_vig char(1))
returning  varchar(100) as nombre_mercado,
           int as oficina,
           int as mercado,
           int as categoria,
           char(2) as seccion,
           int as local,
           char(3) as letra,
           char(3) as bloque,
           varchar(100) as nombre,
           decimal(7,2) as superficie,
           money(18,2) as renta,
           money(18,2) as adeudo,
           money(18,2) as recargos,
           money(18,2) as multa,
           money(18,2) as gastos,
           money(18,2) as actualizacion,
           money(18,2) as total,
           int as axo, 
           varchar(30) as meses,
           char(1) as vigencia,
           varchar(250) as folios;

define v_adeudo, v_adeapagar, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_renta, v_importe money(18,2);    
define t_axo, v_axo, v_mes, v_axodsd, v_mesdsd, v_axohst, v_meshst, v_id, v_rec, v_merc, v_cat, v_local, v_cvecuo int;
define t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, t_desc_recargos, t_rec_apagar money(18,2);
define t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total money(18,2);
define v_sec char(2);
define v_vig char(1);
define v_meses varchar(30);
define v_let, v_blq char(3);
define v_super decimal(7,2);
define v_nom_merc, v_nombre varchar(100);
define t_leyenda varchar(100);
define v_folios varchar(250);
DEFINE cust_qry LVARCHAR(1000);
DEFINE l_cust_num INTEGER;

let v_folios=0;
--set debug file to 'spd_11_mesesadeudoaxo.txt';
--trace on;
-- selecciona locales
  LET cust_qry = " select a.id_local, a.oficina, a.num_mercado, a.categoria, a.seccion, a.local, a.letra_local, a.bloque, a.nombre, a.superficie "
       ||" , a.clave_cuota, a.vigencia, b.descripcion, sum(d.importe) from ta_11_locales a, ta_11_mercados b, ta_11_adeudo_local d " 
       ||" where a.oficina="||p_rec;
    if p_mer<>0 then
       LET cust_qry = cust_qry||" and a.num_mercado="||p_mer;
    end if;
    if p_vig<>'0' then
       if p_vig='A' then
          LET cust_qry = cust_qry||" and a.vigencia='"||p_vig||"'";
       else
          LET cust_qry = cust_qry||" and a.vigencia in ('B','C','D')";
       end if;
    end if;
    LET cust_qry = cust_qry||" and d.id_local=a.id_local and b.tipo_emision<>'B' and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado" 
       ||" group by a.id_local, a.oficina, a.num_mercado, a.categoria, a.seccion, a.local, a.letra_local, a.bloque, a.nombre, a.superficie "
       ||" , a.clave_cuota, a.vigencia, b.descripcion "
       ||" order by a.oficina, a.num_mercado, a.categoria, a.seccion, a.local, a.letra_local, a.bloque";

   PREPARE stmt_id FROM cust_qry;
   DECLARE cust_cur cursor FOR stmt_id;
   OPEN cust_cur ;
     WHILE (1 = 1)
         FETCH cust_cur into v_id, v_rec, v_merc, v_cat, v_sec, v_local, v_let, v_blq, v_nombre, v_super, v_cvecuo, v_vig, v_nom_merc, v_importe;
 
        IF (SQLCODE != 100) THEN
           -- ejecuta tabla de detalle para generar tabla temporal
           foreach
             execute function spd_11_adeudodetalle(v_id) into t_axo, v_mes, t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, 
             t_desc_recargos, t_rec_apagar, t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total, t_leyenda
           end foreach;

           -- totales de tabla temporal
           foreach
             select axo, sum(adeudo), sum(rec_apagar), sum(mul_apagar), max(gastos), sum(actualizacion),
              (sum(adeudo)+sum(rec_apagar)+sum(mul_apagar)+max(gastos)+sum(actualizacion))
             into v_axo, v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total 
             from tmp_adeudomerc where (axo<p_axo  or (mes<=p_mes and axo=p_axo))
             group by axo order by axo

             -- meses de adeudo
             let v_meses='';
             foreach
               select mes into v_mes from tmp_adeudomerc where axo=v_axo order by mes
               let v_meses=trim(v_meses)||v_mes||',';
             end foreach; 
             let v_meses=substr(v_meses,1,(length(v_meses)-1));

             -- calcula la renta
             let v_renta=0;
             execute procedure spd_11_calc_renta(v_axo, v_cat, v_sec, v_cvecuo, v_super, v_merc, 0) into v_renta;

             return v_nom_merc, v_rec, v_merc, v_cat, v_sec, v_local, v_let, v_blq, v_nombre, v_super, v_renta, 
                    v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axo, v_meses, v_vig, v_folios with resume;
           end foreach;
           -- borrar tabla temporal
           delete from tmp_adeudomerc;
        ELSE
           EXIT;
        END IF
 
       END WHILE
 
       CLOSE cust_cur;
 
           FREE cust_cur ;
 
           FREE stmt_id ;
--trace off;
end function;

CREATE PROCEDURE "pgcabrer".sp16_contratos_adeudo ( parTipo char(1), parVigencia char(1), parReporte char(1), pref varchar(20) )
{######################################################################
#  Procedimiento:    sp16_contratos
#  Descripcion:      Interfaz de consulta  ASEO CONTRATADO
#
#  Parametros	parTipo		=	'C'=Zona Centro, 'H'=Hospitalario, 'O'=Ordinario, 'T'=Todos
#  de entrada:	parVigencia	=	'V'=VIGENTE, 'N'=CONVENIADO, 'C'=CANCELADO, 'S'=SUSPENDIDO, 'T'=TODOS
#		parReporte	=	'V'=Adeudos Vigentes, 'T'=Todo el adeudo ( letra diferente de 'V' )
#                             	pref		=	Hasta el periodo requerido         ejem: '2013-10'
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
	returning	int as Control_Contrato,
		int as Num_Contrato,
		varchar(80) as Calle,
		varchar(10) as Numext,
		varchar(10) as Numint,
		varchar(50) as Colonia,
		char(1) as Sector,
		--varchar(10) as Cp,	--v_cp, v_rfc, v_municipio, v_estado, v_curp, 
		--varchar(13) as Rfc,
		--varchar(50) as Municipio,
		--varchar(50) as Estado,
		--varchar(18) as Curp,
		char(10) as Status_Contrato,

		int as Num_Empresa,
		varchar(80) as Nombre_Empresa,
		--varchar(80) as Representante_Empresa,	--v_representante_empresa, v_tipo, 

		--char(1) as Tipo_Aseo,
		varchar(80) as Tipo_Aseo_Descripcion,

		char(1) as Cve_Recoleccion,
		varchar(80) as Unidad_Recoleccion,
		int as Cantidad_Recoleccion,
		char(7) as Inicio_Oblig,
		char(7) as Fin_Oblig, 

		Money(12,2) as Adeudos_SCR,
		Money(12,2) as Adeudos_Pag,

	      	char(7) as PRIMER_ADEUDO,

		Money(12,2) as Adeudos,
		Money(12,2) as Recargos,
		Money(12,2) as Req_Multa,
		Money(12,2) as Req_Gastos,
        Money(12,2) as Actualizacion,
		varchar(200) AS DOCUMENTOS,
		varchar(200) AS LICENCIAS;
-- TRAMPA
define XX_CTROL_ASEO	int;

define v_control_contrato	int;
define v_numero_contrato	int;
define v_calle		varchar(80);
define v_numext		varchar(10);
define v_numint               	varchar(10);
define v_colonia              	varchar(50);
define v_sector		char(1);
define v_cp                       	varchar(10);
define v_rfc                       	varchar(13);
define v_municipio          	varchar(50);
define v_estado               	varchar(50);
define v_curp                    	varchar(18);
define v_Status_Contrato	char(10);

define v_num_empresa	int;
define v_Nombre_Empresa, v_Representante_Empresa	varchar(80);

define v_tipo, v_status_c		char(1);
define v_ctrol_aseo, v_ctrol_emp, v_ctrol_recolec, v_cantidad_recolec, v_id_rec int;
define v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja	date;

define v_Cve_Recoleccion			char(1);
define v_Tipo_Aseo_Descripcion, v_Unidad_Recoleccion	varchar(80);

define v_inicio_oblig, v_fin_oblig	char(7);

define a_Periodo_CN, a_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE		varchar(7);	-- periodo de adeudos
define  v_ref     char(7);

-- ADEUDOS PAGADOS
define pag_periodo	char(7);
define pag_cantidad	int;
define pag_importe, pag_tot_importe	money(12,2);
define pag_Tipo_Adeudo	varchar(80);
define pag_status_vigencia	char(10);
define pag_fecha		date;
define pag_id_rec		int;
define pag_caja		char(2);
define pag_oper		int;
define pag_rcbo		char(20);
define pag_usuario		char(20);


-- ADEUDOS CONDONADOS/CANCELADOS/PRESCRITOS
define scr_periodo	char(7);
define scr_cantidad	int;
define scr_importe, scr_tot_importe	money(12,2);
define scr_Tipo_Adeudo	varchar(80);
define scr_status_vigencia	char(10);
define scr_fecha		date;
define scr_id_rec		int;
define scr_caja		char(2);
define scr_oper		int;
define scr_rcbo		char(20);
define scr_usuario		char(20);

-- ADEUDOS
define F02_Periodo, F02_primer_adeudo			char(7);
define F02_Concepto, F02_Licencias, F02_Documentos		varchar(200);
define F02_Cant_Recolec, F02_cont_primer_adeudo		int;
define F02_Adeudos, F02_Recargos, F02_Multa, F02_Gastos, F02_Actualizacion	Money(12,2);
define TF02_Adeudos, TF02_Recargos, TF02_Multa, TF02_Gastos, TF02_Actualizacion	Money(12,2);

-- REQ
define v_r_rubro, v_r_cta_aplic		int;
define v_r_importe			money(12,2);
define v_DetFolReq			varchar(100);

-- LICENCIAS
define v_status_licencias		int;
define v_concepto_licencias		char(100);

	Let F02_Actualizacion = 0;
    Let TF02_Actualizacion = 0;
Let v_control_contrato = 0;
Let v_numero_contrato = 0;
Let v_calle = ' ';
Let v_numext = ' ';
Let v_numint = ' ';
Let v_colonia = ' ';
Let v_sector = ' ';
Let v_cp = ' ';
Let v_rfc = ' ';
Let v_municipio = ' ';
Let v_estado = ' ';
Let v_curp = ' ';
Let v_status_contrato = ' ';

Let v_num_empresa = 0;
Let v_nombre_empresa = ' ';
Let v_representante_empresa = ' ';

Let v_ctrol_aseo = 0;
Let v_ctrol_emp = 0;
Let v_ctrol_recolec = 0;
Let v_cantidad_recolec = 0;
Let v_id_rec = 0;

Let v_tipo_aseo_descripcion = ' ';
Let v_cve_recoleccion = ' ';
Let v_unidad_recoleccion = ' ';

Let v_inicio_oblig = '';
Let v_fin_oblig = '';

-- PERIODO DE CORTE
Let a_Periodo_CN = ' ';
Let a_Periodo_EXE = ' ';
Let r_Periodo_CN = ' ';
Let r_Periodo_EXE = ' ';
Let v_ref = ' ';
Let XX_CTROL_ASEO = 0;

if parTipo = 'H' then
	Let XX_CTROL_ASEO = 4;
end if;
if parTipo = 'O' then
	Let XX_CTROL_ASEO = 8;
end if;
if parTipo = 'C' then
	Let XX_CTROL_ASEO = 9;
end if;

EXECUTE PROCEDURE con16_LPeriodo () INTO a_Periodo_CN, a_Periodo_EXE;

Let r_Periodo_CN = a_Periodo_CN;
Let r_Periodo_EXE = a_Periodo_EXE;
if parReporte <> 'V' then
	if trim(pref)='' then
   		let v_ref=year(today) || '-' || 12;
   		--let v_ref=9999 || '-' || 12;
	else
   		let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
	end if;
	Let a_Periodo_CN = v_ref;
	Let a_Periodo_EXE = v_ref;
end if;
-- FIN DE PERIODO DE RECORTE

FOREACH
SELECT a.control_contrato, a.num_contrato, a.domicilio, a.sector, a.status_vigencia, 
( case 
when a.status_vigencia = 'V' then 'VIGENTE' 
when a.status_vigencia = 'N' then 'CONVENIADO' 
when a.status_vigencia = 'C' then 'CANCELADO'  
when a.status_vigencia = 'S' then 'SUSPENDIDO' 
end ),
a.ctrol_aseo, a.ctrol_emp, a.num_empresa, a.ctrol_recolec, a.cantidad_recolec, a.id_rec,
a.fecha_hora_alta, a.aso_mes_oblig, a.fecha_hora_baja 

INTO  v_control_contrato, v_numero_contrato, v_calle, v_sector, v_status_c, 
v_Status_Contrato,
v_ctrol_aseo, v_ctrol_emp, v_num_empresa, v_ctrol_recolec, v_cantidad_recolec, v_id_rec,
v_fecha_hora_alta, v_aso_mes_oblig, v_fecha_hora_baja

FROM ta_16_contratos a, ta_16_tipo_aseo b 
WHERE A.CTROL_ASEO = XX_CTROL_ASEO
and b.ctrol_aseo = a.ctrol_aseo
Order By ctrol_aseo, num_contrato 

	Let v_colonia                     = 'COL. CENTRO';
                  Let v_municipio                 = 'GUADALAJARA';
                  Let v_estado                      = 'JALISCO';
	foreach	
	SELECT tipo_aseo, descripcion INTO v_tipo, v_Tipo_Aseo_Descripcion  from ta_16_tipo_aseo where ctrol_Aseo = v_ctrol_aseo
    end foreach;

    foreach
	SELECT descripcion, representante  INTO v_Nombre_Empresa, v_Representante_Empresa 
	FROM ta_16_empresas WHERE ctrol_emp = v_ctrol_emp and num_empresa = v_num_empresa
    end foreach;
    foreach
	SELECT cve_recolec, descripcion  INTO  v_Cve_Recoleccion, v_Unidad_Recoleccion  FROM ta_16_unidades WHERE ctrol_recolec = v_ctrol_recolec
    end foreach;

	Let v_inicio_oblig = Year(v_aso_mes_oblig)||'-'||Month(v_aso_mes_oblig);
	Let v_fin_oblig = Year(v_fecha_hora_baja)||'-'||Month(v_fecha_hora_baja);

	-- ADEUDOS CONDONADOS/CANCELADOS/PRESCRITOS
	Let scr_periodo = '';
	Let scr_Tipo_Adeudo = '';
	Let scr_cantidad = 0;
	Let scr_importe = 0;
	Let scr_tot_importe = 0;
	Let scr_status_vigencia = '';
	Let scr_fecha = Current;
	Let scr_id_rec = 0;
	Let scr_caja = '';
	Let scr_oper = 0;
	Let scr_rcbo = '';
	Let scr_usuario = '';
	FOREACH
		EXECUTE PROCEDURE sp16_Adeudos_NoVig ( v_tipo, v_numero_contrato, 'N' )  
		INTO  scr_periodo, scr_Tipo_Adeudo, scr_cantidad, scr_importe, scr_status_vigencia, scr_fecha, scr_id_rec, scr_caja, scr_oper, scr_rcbo, scr_usuario

		Let scr_tot_importe = scr_tot_importe + scr_importe;
	END FOREACH;

	-- ADEUDOS PAGADOS
	Let pag_periodo = '';
	Let pag_Tipo_Adeudo = '';
	Let pag_cantidad = 0;
	Let pag_importe = 0;
	Let pag_tot_importe = 0;
	Let pag_status_vigencia = '';
	Let pag_fecha = Current;
	Let pag_id_rec = 0;
	Let pag_caja = '';
	Let pag_oper = 0;
	Let pag_rcbo = '';
	Let pag_usuario = '';
	FOREACH
		EXECUTE PROCEDURE sp16_Adeudos_NoVig ( v_tipo, v_numero_contrato, 'P' )  
		INTO  pag_periodo, pag_Tipo_Adeudo, pag_cantidad, pag_importe, pag_status_vigencia, pag_fecha, pag_id_rec, pag_caja, pag_oper, pag_rcbo, pag_usuario

		Let pag_tot_importe = pag_tot_importe + pag_importe;
	END FOREACH;

	-- ADEUDOS
	Let F02_cont_primer_adeudo = 0;
	Let F02_Periodo = '';
	Let F02_primer_adeudo = '';
	Let F02_Concepto = '';
	Let F02_Licencias = '';
	Let F02_Documentos = '';
	Let F02_Cant_Recolec = 0;

	Let F02_Adeudos = 0;
	Let TF02_Adeudos = 0;
	Let F02_Recargos = 0;
	Let TF02_Recargos = 0;

	Let F02_Multa = 0;
	Let TF02_Multa = 0;
	Let F02_Gastos = 0;
	Let TF02_Gastos = 0;

	-- LICENCIAS RELACIONADAS
	--Let v_status_licencias = 0;  Let v_concepto_licencias = ' ';
	--EXECUTE PROCEDURE sp16_LicenciaGiro_F1 ( v_tipo, v_numero_contrato ) INTO v_status_licencias, v_concepto_licencias;
	--if v_status_licencias > 0 then
	--	Let F02_Licencias = Trim(v_concepto_licencias);
	--	--RETURN va_Axo || '-' || LPAD(va_Mes,2,'0'), v_concepto_licencias, Null, Null, Null, Null, Null    with resume;
	--end if;

	-- ADEUDOS POR RECOLECCION
	FOREACH
		EXECUTE PROCEDURE sp16_Adeudos_F02 ( v_tipo, v_numero_contrato, parReporte, v_ref )  
		INTO  F02_Periodo, F02_Concepto, F02_Cant_Recolec, F02_Adeudos, F02_Recargos, F02_Multa, F02_Gastos, F02_Actualizacion
	
		if F02_Concepto <> '' then
			if substr(F02_Concepto,1,8) = 'Licencia' then
				Let F02_Licencias = Trim(F02_Concepto);
			end if;
			if (F02_Multa <> 0) or (F02_Gastos <> 0) then
				Let F02_Documentos = Trim(F02_Concepto);
				Let TF02_Multa = TF02_Multa + F02_Multa;
				Let TF02_Gastos = TF02_Gastos + F02_Gastos;
				--if F02_cont_primer_adeudo = 0 then
				--	Let F02_primer_adeudo = F02_Periodo;
				--	Let F02_cont_primer_adeudo = 1;
				--end if;
			end if;
			if (F02_Adeudos <> 0) or (F02_Recargos <> 0) then
				Let TF02_Adeudos = TF02_Adeudos + F02_Adeudos;
				Let TF02_Recargos = TF02_Recargos + F02_Recargos;
                Let TF02_Actualizacion = TF02_Actualizacion + F02_Actualizacion;
				if F02_cont_primer_adeudo = 0 then
					Let F02_primer_adeudo = F02_Periodo;
					Let F02_cont_primer_adeudo = 1;
				end if;
			end if;
		end if;
	
	END FOREACH;

--

if parTipo = 'T' then
	if parVigencia = 'T' then
		RETURN v_control_contrato, 
		v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, 
		--v_cp, v_rfc, v_municipio, v_estado, v_curp, 
		v_status_contrato, 
		v_num_empresa, v_nombre_empresa, 
		--v_representante_empresa, v_tipo, 
		v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
		v_inicio_oblig, v_fin_oblig, scr_tot_importe, pag_tot_importe, 
		F02_primer_adeudo, TF02_Adeudos, TF02_Recargos, TF02_Multa, TF02_Gastos, TF02_Actualizacion, F02_Documentos, F02_Licencias  with resume;
	else
		if parVigencia = v_status_c then
			RETURN v_control_contrato, 
			v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, 
			--v_cp, v_rfc, v_municipio, v_estado, v_curp, 
			v_status_contrato, 
			v_num_empresa, v_nombre_empresa, 
			--v_representante_empresa, v_tipo, 
			v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
			v_inicio_oblig, v_fin_oblig, scr_tot_importe, pag_tot_importe, 
			F02_primer_adeudo, TF02_Adeudos, TF02_Recargos, TF02_Multa, TF02_Gastos, TF02_Actualizacion, F02_Documentos, F02_Licencias  with resume;
		end if;
	end if;
else
	if parTipo = v_tipo then
		if parVigencia = 'T' then
			RETURN v_control_contrato, 
			v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, 
			--v_cp, v_rfc, v_municipio, v_estado, v_curp, 
			v_status_contrato, 
			v_num_empresa, v_nombre_empresa, 
			--v_representante_empresa, v_tipo, 
			v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
			v_inicio_oblig, v_fin_oblig, scr_tot_importe, pag_tot_importe, 
			F02_primer_adeudo, TF02_Adeudos, TF02_Recargos, TF02_Multa, TF02_Gastos, TF02_Actualizacion, F02_Documentos, F02_Licencias  with resume;
		else
			if parVigencia = v_status_c then
				RETURN v_control_contrato, 
				v_numero_contrato, v_calle, v_numext, v_numint, v_colonia, v_sector, 
				--v_cp, v_rfc, v_municipio, v_estado, v_curp, 
				v_status_contrato, 
				v_num_empresa, v_nombre_empresa, 
				--v_representante_empresa, v_tipo, 
				v_tipo_aseo_descripcion, v_cve_recoleccion, v_unidad_recoleccion, v_cantidad_recolec, 
				v_inicio_oblig, v_fin_oblig, scr_tot_importe, pag_tot_importe, 
				F02_primer_adeudo, TF02_Adeudos, TF02_Recargos, TF02_Multa, TF02_Gastos, TF02_Actualizacion, F02_Documentos, F02_Licencias  with resume;
			end if;
		end if;
	end if;
end if;
--
	-- ADEUDOS CONDONADOS/CANCELADOS/PRESCRITOS
	Let scr_periodo = '';
	Let scr_Tipo_Adeudo = '';
	Let scr_cantidad = 0;
	Let scr_importe = 0;
	Let scr_tot_importe = 0;
	Let scr_status_vigencia = '';
	Let scr_fecha = Current;
	Let scr_id_rec = 0;
	Let scr_caja = '';
	Let scr_oper = 0;
	Let scr_rcbo = '';
	Let scr_usuario = '';

	-- ADEUDOS PAGADOS
	Let pag_periodo = '';
	Let pag_Tipo_Adeudo = '';
	Let pag_cantidad = 0;
	Let pag_importe = 0;
	Let pag_tot_importe = 0;
	Let pag_status_vigencia = '';
	Let pag_fecha = Current;
	Let pag_id_rec = 0;
	Let pag_caja = '';
	Let pag_oper = 0;
	Let pag_rcbo = '';
	Let pag_usuario = '';

	Let F02_cont_primer_adeudo = 0;
	Let F02_Periodo = '';
	Let F02_primer_adeudo = '';
	Let F02_Concepto = '';
	Let F02_Licencias = '';
	Let F02_Documentos = '';
	Let F02_Cant_Recolec = 0;

	Let F02_Adeudos = 0;
	Let TF02_Adeudos = 0;
	Let F02_Recargos = 0;
	Let TF02_Recargos = 0;
	Let F02_Actualizacion = 0;
    Let TF02_Actualizacion = 0;

	Let F02_Multa = 0;
	Let TF02_Multa = 0;
	Let F02_Gastos = 0;
	Let TF02_Gastos = 0;
--
END FOREACH;

end procedure;

create procedure "pgcabrer".spd_11_pagosdetmerc(pmer int,pdsd date,phst date)
returning   int as idlocal,
            int as rec,
            int as merc,
            int as cat,
            char(2) as seccion,
            int as local,
            char(3) as letra,
            char(2) as bloque,
            date as fechapago,
            int as recpago,
            char(2) as cajapago,
            int as operpago,
            varchar(10) as perdsd,
            varchar(10) as perhst,
            money(16,2) as arrendamiento,
            money(16,2) as recargos,
            money(16,2) as multa,
            money(16,2) as gastos,
            money(16,2) as gastosfolio,
            int as folio,
            char(1) as diligencia,
            date as fechaemision,
            date as fechapractica,
            date as fechaentrega,
            int as ejecutor;

define v_id,v_rec,v_merc,v_cat,v_local,v_recpago,v_operpago,v_folio,v_ejecutor,xrec,xoper int;
define v_seccion,v_cajapago,xcaja char(2);
define v_letra char(3);
define v_bloque char(2);
define v_diligencia char(1);
define v_fechapago,v_fechaemision,v_fechapractica,v_fechaentrega,xfecha date;
define v_importe,v_arrendamiento,v_recargos,v_multa,v_gastos,v_gasfol money(16,2);
define v_perdsd,v_perhst varchar(10);
define v_cuenta,v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst int; 

let xfecha=null;
let xrec=0;
let xcaja='';
let xoper=0;

foreach
select b.id_local,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,
((select min(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago)||'-'||
(select min(periodo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago and axo=
(select min(axo) from ta_11_pagos_local  where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago))),
((select Max(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago)||'-'||
(select max(periodo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago and axo=
(select Max(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago))),
d.folio,d.diligencia,d.fecha_emision,d.fecha_practicado,d.fecha_entrega1,d.ejecutor,nvl(d.importe_pago,0)
into v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
v_operpago,v_perdsd,v_perhst,v_folio,v_diligencia,v_fechaemision,v_fechapractica,v_fechaentrega,v_ejecutor,
v_gasfol
from ta_11_pagos_local a, ta_11_locales b,outer ta_15_apremios d
where (a.fecha_pago between pdsd and phst) and b.num_mercado=pmer and b.id_local=a.id_local 
and d.fecha_pago=a.fecha_pago and d.recaudadora=a.oficina_pago 
and d.caja=a.caja_pago and d.operacion=a.operacion_pago
group by b.id_local,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,13,14,
d.folio,d.diligencia,d.fecha_emision,d.fecha_practicado,d.fecha_entrega1,d.ejecutor,d.importe_pago
order by b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,d.folio

select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,cuenta_descmulta,cuenta_gastos 
into v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst
from ta_11_mercados where num_mercado_nvo=v_merc;

let v_arrendamiento=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;

foreach
select cuenta,importe into v_cuenta,v_importe from ta_12_recibosdet 
where fecha=v_fechapago and id_rec=v_recpago and caja=v_cajapago and operacion=v_operpago
and cuenta in(v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst)

if (v_cuenta=v_ctaact) or (v_cuenta=v_ctarzg) then let v_arrendamiento=v_importe; 
else if (v_cuenta=v_ctarec) or (v_cuenta=v_ctadrec) then let v_recargos=v_importe;
else if (v_cuenta=v_ctamul) or (v_cuenta=v_ctadmul) then let v_multa=v_importe;
else if v_cuenta=v_ctagst then let v_gastos=v_importe;
end if; end if; end if; end if;

end foreach

if ((v_fechapago=xfecha) and (v_recpago=xrec) and (v_cajapago=xcaja) and (v_operpago=xoper)) then
   return v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
   v_operpago,v_perdsd,v_perhst,0,0,0,0,v_gasfol,v_folio,v_diligencia,
   v_fechaemision,v_fechapractica,v_fechaentrega,v_ejecutor with resume;
else
   return v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
   v_operpago,v_perdsd,v_perhst,v_arrendamiento,v_recargos,v_multa,v_gastos,v_gasfol,v_folio,v_diligencia,
   v_fechaemision,v_fechapractica,v_fechaentrega,v_ejecutor with resume;
end if;

let xfecha=v_fechapago;
let xrec=v_recpago;
let xcaja=v_cajapago;
let xoper=v_operpago;
end foreach;
end procedure;

CREATE PROCEDURE "pgcabrer".sp34_suspension_manto ( parOpc int, parContrato int, parAxo int , parMes int, parDescrip varchar(255), parUsuario char(10), parFecSusp date )
-- parOpc ( 1 Suspensi�n, 2 Cancela la Suspensi�n ) 
-- parContrato = id_34_datos
returning
	integer as codigo_status,
	varchar(100) as mensaje,
	integer as Axo,
	integer as Mes,
	date as fecha_alta,
	date as fecha_mov; 

define v_codigo_status		int;
define v_mensaje			varchar(100);
define v_estado_contrato	char(1);
define p_id				int;
define v_fecha_alta, v_fecha_mov			date;
define vid					int;

let v_codigo_status = -1;
let v_mensaje = ''; 

let v_estado_contrato = '';
Let p_id = 0;

if parOpc = 1 then -- Suspension de Servicio
   if exists (SELECT * FROM t34_suspensiones WHERE id_contrato = parContrato and estado = 'S') then
	  SELECT estado, fecha_alta INTO v_estado_contrato, v_fecha_alta FROM t34_suspensiones WHERE id_contrato = parContrato and estado = 'S';
	  RETURN -1, 'Contrato de Valet Parking esta en Suspensi�n de Servicios desde '||v_fecha_alta, 0,0, Null, Null  with resume;
   else
	  update t34_datos set id_stat = 24  where id_34_datos = parContrato;
		
      insert into t34_suspensiones values ( 0, parContrato, parAxo, parMes, 0, 0, parDescrip, 'S', parFecSusp, parUsuario, current, Null, Null );
	  LET vid = dbinfo("sqlca.sqlerrd1");
	  if vid <> 0 then
	     RETURN 1, 'Contrato de Valet Parking ha sido puesto en Suspension de Servicios', 0,0, Null, Null  with resume;
	  else
	     RETURN -1, 'Ocurri� un error al momento de Suspender el Contrato de Valet Parking, avisa al administrador', 0,0, Null, Null  with resume;
	  end if;
   end if;
end if;

if parOpc = 2 then -- Cancela Suspension
	if exists (SELECT * FROM t34_suspensiones WHERE id_contrato = parContrato and estado = 'S') then
		SELECT estado, fecha_alta  INTO v_estado_contrato, v_fecha_alta  FROM t34_suspensiones WHERE id_contrato = parContrato and estado = 'S';
		if v_estado_contrato = 'C' then
			RETURN -1, 'Contrato de Valet Parking tiene Cancelaci�n de la Suspensi�n de Servicios el '||v_fecha_mov, 0,0, Null, Null  with resume;
		else
			if v_estado_contrato = 'S' then
				update t34_datos set id_stat = 22  where id_34_datos = parContrato;
		
				update t34_suspensiones set estado = 'C', fecha_baja = current, usuario_baja = parUsuario WHERE id_contrato = parContrato and estado = 'S';
				
				RETURN 1, 'Se Cancel� la Suspensi�n de Servicios Satisfactoriamente', 0,0, Null, Null  with resume;
			else
				RETURN -1, 'Contrato de Valet Parking tiene Estado desconocido, avisa al administrador', 0,0, Null, Null  with resume;
			end if;
		end if;
	else
		RETURN -1, 'Contrato de Valet Parking NO tiene Suspensi�n de Servicios', 0,0, Null, v_fecha_mov  with resume;
	end if;
end if;	

END PROCEDURE;

CREATE PROCEDURE "pgcabrer".con34_gdetade_01 ( par_Tabla Char(1), p_Control Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
                returning varchar(255) as Concepto,
                               Money(12,2) as Importe_Adeudos,
                               Money(12,2) as Importe_Recargos,
                               Money(12,2) as Importe_Multa,
                               Money(12,2) as Importe_Gastos,
                               Money(12,2) as Importe_Actualizacion;
               

{
#  Procedimiento: con34_Gdetade_01
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Concepto : El concepto general del registro a mostrar
#                                      Importe : El importe de los Adeudos
#                                      Importe : El importe de los Recargos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                                    Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq                                                                   Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos                                                    Money(12,2);
  define v_DetFolReq                                                                                                  varchar(120);
  define v_diligencia                                                                                                                     char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago                                                                                                        Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2                                 Money(12,2);
  define v_Mes                                                                                                               varchar(2);

  define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato                                                      Integer;
  define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato                                      varchar(120);

       define v_Importe_recargo, v_TotRecargos, v_Reg_1, v_multas, v_actualizacion, v_tot_actualizacion, v_tot_multas                Money(12,2);
       define v_mensaje_proc                                                                                                     varchar(255);
  define v_tipo_var								Char(1);
--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE, v_refSUS                             varchar(7);
  define v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade                                                        varchar(7);
  --define v_Periodo_CN, v_Periodo_EXE                                                                                          varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo, Axo_v, v_axo_inicio, v_mes_inicio                             Integer;
--****************************************************************************************************************************** 
   Let v_Contador = 0;
   
   Let v_Detalle_T = ' ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   let v_importe_multa=0;
   let v_tot_actualizacion=0;
   let v_tot_multas=0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_rec1 = 0;
   Let v_importe_rec2 = 0;
   Let v_axo = 0;
                Let v_Lineas_Dato = 0;
   Let v_refSUS='';

  -- requerimientos
  -- requerimientos termina

  -- fecha_limite
SELECT 	Year(fechalimite), Month(fechalimite), Day(fechalimite)  
INTO 	Axo_v, Mes_v, Dia_v
FROM 	t34_fechalimite
WHERE 	cve_tab = par_tabla
AND 	Month(fechalimite) = Month(Current)  
AND 	Year(fechalimite) = Year(Current);

if 	Day(Current) <= Dia_v then
	if 	Mes_v = 1 then
		Let Mes_v = 12;
        Let Axo_v = Axo_v - 1;
    else
        Let Mes_v = Mes_v - 1;
    end if;
End if;

                EXECUTE PROCEDURE con34_glperiodo ( par_Tabla ) INTO v_Periodo_CN;  
  -- fecha limite termina

  Let r_Periodo_CN = v_Periodo_CN;
  if p_Rep <> 'V' then
     Let v_Periodo_CN = p_Fecha_fin;
  end if;

-- verifica si tiene suspensi�n de servicio
if exists(select * from t34_suspensiones WHERE id_contrato = p_Control and estado='S') then
   SELECT 	axo_inicio, mes_inicio iNTO v_axo_inicio, v_mes_inicio fROM t34_suspensiones WHERE id_contrato = p_Control and estado='S';
   if v_mes_inicio = 1 then
	  Let v_refSUS = ((v_axo_inicio - 1)||'-'||12);
      Let aso_actual = (v_axo_inicio - 1);
   else
      Let v_refSUS = (v_axo_inicio||'-'||(v_mes_inicio - 1));
      Let aso_actual = v_axo_inicio;
   end if;
   if v_refSUS < v_Periodo_CN then
	  Let v_Periodo_CN = v_refSUS;
   end if;
end if;

  	-- REQUERIMIENTOS
        EXECUTE PROCEDURE con34_grequerim_01 ( 34, p_Control ) INTO v_DetFolReq, v_importe_multa, v_tot_gastos;  
	--	if v_tot_gastos <> 0 or if v_importe_multa <> 0 then -- antes con multa de notificacion
		if v_tot_gastos <> 0 then
			RETURN v_DetFolReq, 0, 0, 0, v_tot_gastos, null  with resume;
		end if;
  	-- FIN REQUERIMIENTOS

                --Let v_Lineas_Dato = 0;
                --Let v_Detalle_Dato = '';
                --               Select ('Descuento de Recargos en periodo(s) del ' || axoinicio || '-' || mesinicio || 
                --                               ' al ' || axofin || '-' || mesfin || ' por el ' || porcentaje || ' %'), 
                --                               (axoinicio || '-' || mesinicio), axofin || '-' || mesfin, porcentaje
                --                               INTO v_Detalle_Dato, v_Periodo_Inicio, v_Periodo_fin, v_porc
                --                               from ta_16_descrec
                --                               Where id_contrato = p_Control_contrato and vigencia = 'V';

	--	if v_Detalle_Dato <> '' then
	--		Let v_Lineas_Dato = v_Lineas_Dato + 1;
	--	end if;
	-- AQUI TERMINA 

Let v_tipo_var = '';

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);

  FOR aso_proceso = 1989 to aso_actual 

                ------------------------------------- ADEUDOS
                               Let v_Lineas_CN = 0;
                               Let v_Detalle_CN = ' Mes(s) --';

                               foreach
                                               Select Year(h.periodo), h.periodo,  h.importe, Month(h.periodo), H.tipo_var
                                                              Into v_axo, v_aso_mes_pago, v_importe, v_Mes, v_tipo_var
                                                               From t34_pagos H, t34_status b
                                                               Where H.id_datos = p_Control 
                                                              and H.periodo <= ( v_Periodo_CN ) 
                                                               and Year(h.periodo) = aso_proceso       
                                                              and b.id_34_stat = h.id_stat and b.cve_stat = 'V'
                                                               Order By h.id_34_pagos, h.periodo


		if v_importe > 0 then
			if v_tipo_var = 'F'  then
				if v_Lineas_CN > 0 then
					Let v_Detalle_CN = v_Detalle_CN|| ',F' || v_Mes;
				else
					Let v_Detalle_CN = v_Detalle_CN|| 'F' || v_Mes;
				end if;
				--
                                   			Let v_totAdeudos = v_totAdeudos + v_importe;
				--
			end if;
			if v_tipo_var = 'A'  then
				if v_Lineas_CN > 0 then
					Let v_Detalle_CN = v_Detalle_CN|| ',A' || v_Mes;
				else
					Let v_Detalle_CN = v_Detalle_CN|| 'A' || v_Mes;
				end if;
				--
                                   			Let v_totAdeudos = v_totAdeudos + v_importe;
				--
			end if;
			if v_tipo_var = 'T'  then
				if v_Lineas_CN > 0 then
					Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
				else
					Let v_Detalle_CN = v_Detalle_CN|| v_Mes;
				end if;
				--
                                   			Let v_totAdeudos = v_totAdeudos + v_importe;

				Select sum(por_recargo) Into v_Importe_recargo
                                                		From t34_porcentajes  Where periodo_porc between (v_aso_mes_pago) and (r_Periodo_CN);

                                   			if v_Importe_recargo <> 0 then
                                      			Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       			--EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
					--		INTO v_importe_rec2, v_mensaje_proc;
                                       			--if v_importe_rec2 > 0 then
                                        			-- Let v_TotRecargos = v_TotRecargos + (v_importe_rec1 - v_importe_rec2);  -- modificado de sumando a restando
                                        			--  Let v_Lineas_Dato = v_Lineas_Dato + 1;    
					Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
                if v_importe_rec1 >0 then
                   --- calculo de multas
                   let v_multas =0;
                   execute procedure sp34_calc_multa(v_importe ,mdy( v_Mes, Dia_v, v_Axo) ) into v_multas;
                   let v_tot_multas = v_tot_multas + v_multas;
                end if;

                -- calculo de actualizacion
                let v_actualizacion=0;
                execute function spd_11_calc_actualizacion(v_Axo, v_Mes, v_importe) into v_actualizacion;
                let v_tot_actualizacion = v_tot_actualizacion + v_actualizacion;
				end if;
			end if;
			Let v_Lineas_CN = v_Lineas_CN + 1;
		else
			Let v_Contador = v_Contador + 1;
		end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;
                               end foreach;

--     Grabando registro
   if  (v_Lineas_CN > 0) then
       Let v_Detalle_T = 'Adeudos del ' || aso_proceso;  -- Adicionado la leyenda de Adeudos por Arrendamiento del
       if v_Lineas_CN > 0 then
                Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
       end if;
       return v_Detalle_T , v_totAdeudos, v_TotRecargos, v_tot_multas, 0, v_tot_actualizacion  with resume;
       Let v_Contador = v_Contador + 1;
   end if;


   Let v_Detalle_T = ' ';
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   let v_tot_multas=0;
   let v_tot_actualizacion = 0;

  END FOR;

   if v_Contador = 0 then
       return 'NO HAY ADEUDO DENTRO DEL PERIODO SELECCIONADO' , Null, Null, Null, Null, null  with resume;
   else
       if v_Lineas_Dato > 0 then
          return v_Detalle_Dato , Null, Null, Null, Null, null  with resume;
       end if;
   end if;

END PROCEDURE;

CREATE PROCEDURE "pgcabrer".admin_adeudos_detalle_25_tot ( par_Tabla Char(2), par_Control Char(10), pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_25
#  Descripcion:      Interfaz de consulta de detalle para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros         par_Tabla     = Rubro de ingreso 
#  de entrada:         par_Control   = Dato de Control del registro
#                             pref   = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
                --returning  Integer as Rubro,
                --               Integer as Concepto,
                --               Integer as Cuenta_Aplicacion,
                --               VarChar(30) as Referencia,
                --               VarChar(120) as Descripcion,
                --               Money(12,2) as Monto,
                --               Money(12,2) as Acumulado;
                returning  Integer as Cuenta_Aplicacion,
                               VarChar(50) as Referencia,
                               Money(12,2) as Monto;

--********** totales *******************************
define t_cuenta	int;
define t_concepto_abrev varchar(50);
define t_monto, t_monto_t	money(12,2);


define v_tipo_var                                                                                                                        Char(1);               
define v_id_34_datos, v_id_control_req, v_axo_inicio, v_mes_inicio                        Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas            Money(12,2);
define v_porcentaje_multa                                                                                                     Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2, v_actualizacion           Money(12,2);
define v_aso_mes_pago                                                                                                          Date;
define v_Axo, v_Mes, Axo_v, Mes_v, Dia_v                                                                    Integer;
define v_mensaje_proc                                                                                                            varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                                               varchar(7);
define v_contador                                                                                                                       Smallint;
define  v_ref, v_refSUS     char(7);
--****************************************************************************************************************************************** ctas de aplicacion
  define v_cta_multas, v_cta_dscto_multas, v_cta_gastos                                                                        Integer;
  define v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza                                           Integer;
  define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza                                                           Integer;
  define v_cta_rcgos_ade, v_cta_rcgos_exced, v_cta_actualizacion                                                                                Integer;
  define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced                                                                        Integer;
  define v_tipo_obligacion                                                                                                                        Char(50);
  define v_concepto                                                                                                                                    VarChar(100);
--******************************************************************************************************************************************

begin
    on exception in (-958)
       delete from tmp_total_otras_oblig;
    end exception;
create temp table tmp_total_otras_oblig(
  rubro int,
  concepto int,
  cuenta int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
       delete from tmp_detalle_otras_oblig;
    end exception;
create temp table tmp_detalle_otras_oblig(
  control_contrato int,
  aso_mes_pago char(7),
  ctrol_operacion int,
  tipo_movto char(1) ) with no log;
end;

let v_refSUS='';

  SELECT Year(fechalimite), Month(fechalimite), Day(fechalimite)  INTO Axo_v, Mes_v, Dia_v
                FROM t34_fechalimite
                WHERE cve_tab = par_tabla
                AND Month(fechalimite) = Month(Current)  AND Year(fechalimite) = Year(Current);

      if Day(Current) <= Dia_v then
                if Mes_v = 1 then
                               Let Mes_v = 12;
                               Let Axo_v = Axo_v - 1;
                else
                               Let Mes_v = Mes_v - 1;
                end if;
      end if;

EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  


if trim(pref)='' then
   let v_ref=9999 || '-' || 12;
else
   let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
end if;

let v_id_34_datos = 0;
if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
                SELECT a.id_34_datos  INTO v_id_34_datos  FROM t34_datos A    WHERE a.cve_tab = par_Tabla and a.control = par_Control;

   -- verifica si tiene suspensi�n de servicio
   if exists(select * from t34_suspensiones WHERE id_contrato = v_id_34_datos and estado='S') then
      SELECT 	axo_inicio, mes_inicio iNTO v_axo_inicio, v_mes_inicio fROM t34_suspensiones WHERE id_contrato = v_id_34_datos and estado='S';
      if v_mes_inicio = 1 then
         let v_refSUS=(v_axo_inicio - 1) || '-' || 12;
      else
         let v_refSUS=v_axo_inicio || '-' || (v_mes_inicio - 1);
      end if;
      if v_refSUS < v_ref then
	     Let v_ref = v_refSUS;
      end if;
   end if;

                -- VARIABLES A 0
                Let v_concepto = '';
                Let v_cta_multas = 0;
                Let v_cta_dscto_multas = 0;
                Let v_cta_gastos = 0;
                Let v_cta_adeudos_act = 0;
                Let v_cta_adeudos_dev = 0;
                Let v_cta_adeudos_reza = 0;
               Let v_cta_rcgos_ade = 0;
                Let v_cta_dcto_rcgos_ade = 0;

                Let v_tipo_var = '';
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               Let v_tot_gastos = 0;
                Let v_acumulado = 0;
                Let v_importe = 0;
                Let v_Importe_recargo = 0;
                Let v_importe_rec1 = 0;
                Let v_importe_rec2 = 0;
                Let v_contador = 0;


                -- APREMIOS
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_porcentaje_multa
                               FROM ta_15_apremios
                               WHERE modulo = 34  AND control_otr = v_id_34_datos  AND vigencia = "1" AND clave_practicado = "P"
                               Order By id_control

                             /*  Let v_tot_multas = v_importe_multa; -- quitar multa de notificaci�n
                               if v_porcentaje_multa < 100 then
                                               Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                               Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                               else
                                               Let v_tot_dscto_multas = 0;
                               end if;*/
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                               insert into tmp_detalle_otras_oblig values ( v_id_control_req, v_ref, 0, 'R' );
                end foreach;
                
                -- TERMINA APREMIOS

                               -- INICIAN PERIODOS
                               foreach
                                               SELECT a.periodo, a.importe, Year(a.periodo), Month(a.periodo), a.tipo_var   INTO  v_aso_mes_pago, v_importe, v_Axo, v_Mes, v_tipo_var  
                                                               FROM t34_pagos a, t34_status b    WHERE id_datos = v_id_34_datos  and periodo <= v_ref
                                                               AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('V')
                                                               ORDER BY a.periodo

                                               insert into tmp_detalle_otras_oblig values ( v_id_34_datos, v_Axo || '-' || v_Mes, 0, 'A' );
                                               if v_importe > 0 then
                                                               if v_contador = 0 then
                                                                          /*    if v_tot_multas > 0 then -- se quita multa de notificaci�n
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_multas;  
					    --RETURN 0,0, v_cta_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_multas, v_acumulado with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_multas, v_acumulado );
                                                                              end if;
                                                                              if v_tot_dscto_multas <> 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
					    --RETURN 0,0, v_cta_dscto_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_dscto_multas, v_acumulado with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_dscto_multas, v_acumulado );
                                                                              end if; */
                                                                              if v_tot_gastos > 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_gastos;  
					    --RETURN 0,0, v_cta_gastos, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_gastos, v_acumulado with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, v_concepto, v_tot_gastos, v_acumulado );
                                                                              end if;
                                                                              Let v_contador = 1;
                                                               end if;

                                                               if v_tipo_var = 'T' then
                                                                              if Year(v_aso_mes_pago) < Year(Current) then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ADEUDO REZAGO' ) INTO v_cta_adeudos_reza, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe;
					    --RETURN 0,0, v_cta_adeudos_reza, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_reza, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                                                                              else
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ADEUDO ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe;
					    --RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                                                                              end if;
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ACTUALIZACION' ) INTO v_cta_actualizacion, v_concepto;
                                                                                              execute function spd_11_calc_actualizacion(v_Axo, v_Mes, v_importe) into v_actualizacion;
                                                                                             -- Let	v_actualizacion = dbestacion:fcn_inpc_x_mes ( (v_Axo * 100) + v_Mes) * v_importe / 100 ;
                                                                                              if v_actualizacion > 0 then
                                                                                                 Let v_acumulado = v_acumulado + v_actualizacion;
                                                                                                 insert into tmp_total_otras_oblig values ( 0,0, v_cta_actualizacion, v_Axo || '/' || v_Mes, v_concepto, v_actualizacion, v_acumulado );
                                                                                              end if;   
                                                                              SELECT sum(por_recargo)   INTO v_Importe_recargo  FROM t34_porcentajes  
                                                                                              WHERE periodo_porc BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

                                                                              if v_Importe_recargo <> 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'RCGO. ADEUDO' ) INTO v_cta_rcgos_ade, v_concepto;
                                                                                              Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                                                                              Let v_acumulado = v_acumulado + v_importe_rec1;
                                                                                              --RETURN 0,0, v_cta_rcgos_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec1, v_acumulado  with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec1, v_acumulado );
					    EXECUTE PROCEDURE sp_desctomerc (v_id_34_datos, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 34) INTO v_importe_rec2, v_mensaje_proc;
                                                                              end if;
                                                                              if v_importe_rec2 > 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. RECARGO' ) INTO v_cta_dcto_rcgos_ade, v_concepto;
                                                                                              Let v_importe_rec2 = v_importe_rec2 * -1;
                                                                                              Let v_acumulado = v_acumulado + v_importe_rec2;
                                                                                              --RETURN 0,0, v_cta_dcto_rcgos_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec2, v_acumulado  with resume;
					    insert into tmp_total_otras_oblig values ( 0,0, v_cta_dcto_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec2, v_acumulado );
                                                                              end if;
                                                                              let v_tot_multas = 0;
                                                                              let v_tot_dscto_multas =0;
                                                                              if v_Importe_recargo <> 0 then                                                                                          
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
                                                                                              execute procedure sp34_calc_multa(v_importe ,mdy( v_Mes, Dia_v, v_Axo) ) into v_tot_multas;
                                                                                              if v_tot_multas > 0 then 
                                                                                                 Let v_acumulado = v_acumulado + v_tot_multas;  
                                                                                                 insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_multas, v_acumulado );
                                                                                                 -- descuento de multa
                                                                                                 execute PROCEDURE sp34_desctomulta( v_id_34_datos, v_axo, v_Mes, v_tot_multas) into v_tot_dscto_multas, v_mensaje_proc;   
                                                                                                 if v_tot_dscto_multas <> 0 then
                                                                                                    EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
                                                                                                    let v_tot_dscto_multas = v_tot_dscto_multas * -1;
                                                                                                    Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
                                                                                                    insert into tmp_total_otras_oblig values ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_dscto_multas, v_acumulado );
                                                                                                 end if;
                                                                                              end if;
                                                                              end if;

                                                               else
                                                                              if v_tipo_var = 'F' then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'F', 'FORMA' ) INTO v_cta_adeudos_act, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe; 
					    --RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                                                                              end if;
                                                                              if v_tipo_var = 'A' then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'A', 'AUTORIZACION ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_importe;  
					    --RETURN 0,0, v_cta_adeudos_act, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                                                                              end if;
                                                               end if;
			end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                               Let v_importe_rec1 = 0;
                               Let v_importe_rec2 = 0;
                               end foreach;
                               -- TERMINAN PERIODOS
                                                               if v_contador = 0 then
                                                                            /*  if v_tot_multas > 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_multas;  
					    --RETURN 0,0, v_cta_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'MULTAS ', v_tot_multas, v_acumulado with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, 'MULTAS ', v_tot_multas, v_acumulado );
                                                                              end if;
                                                                              if v_tot_dscto_multas <> 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
					    --RETURN 0,0, v_cta_dscto_multas, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado  with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado );
                                                                              end if;*/
                                                                              if v_tot_gastos > 0 then
                                                                                              EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
                                                                                              Let v_acumulado = v_acumulado + v_tot_gastos;  
					    --RETURN 0,0, v_cta_gastos, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'GASTOS ', v_tot_gastos, v_acumulado  with resume;
                                                                                              insert into tmp_total_otras_oblig values ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, 'GASTOS ', v_tot_gastos, v_acumulado );
                                                                              end if;
                                                               end if;

	Let t_monto_t = 0;
	foreach
	select a.cuenta, b.abrev, sum(a.monto)   INTO t_cuenta, t_concepto_abrev, t_monto 
	from tmp_total_otras_oblig a, t34_ctas_aplic b
	where b.cuenta = a.cuenta and b.cve_tab=par_Tabla
	group by a.cuenta, b.abrev
	order by a.cuenta

	RETURN t_cuenta, t_concepto_abrev, t_monto    with resume;
	Let t_monto_t = t_monto_t + t_monto;
	end foreach;
	RETURN Null, Null, Null    with resume;
	RETURN Null, 'TOTAL ADEUDO', t_monto_t    with resume;

end if;
end procedure;

CREATE PROCEDURE "pgcabrer".admin_encabezados_25 ( par_Tabla Char(2), par_Control Char(10) )
{######################################################################
#  Procedimiento:    admin_encabezados_25
#  Descripcion:      Interfaz de consulta de encabezados para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros        par_Tabla     = Rubro de ingreso 
#  de entrada:       par_Control   = Dato de Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_encabezados en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning  varchar(92) as propietario,
                               varchar(80) as calle,
                               varchar(10) as numext,
                               varchar(10) as numint,
                               varchar(50) as colonia,
                               varchar(10) as cp,
                               varchar(13) as rfc,
                               varchar(50) as municipio,
                               varchar(50) as estado,
                               varchar(18) as curp,
                               lvarchar(500) as descripcion,
                               int as cartera,
                               varchar(255) as leyenda,
                               varchar(255) as leyendaRecibo,
                               int as impidecobro;
               
define v_id_34_datos   Integer;
define v_importe           Money(15,2);

define v_id_stat	int;
define v_status_vigencia              	Char(1);
define v_status_vigencia_leyenda Varchar(100);

define v_propietario     varchar(92);
define v_calle                  varchar(80);
define v_numext            varchar(10);
define v_numint             varchar(10);
define v_colonia             varchar(50);
define v_cp                       varchar(10);
define v_rfc                      varchar(13);
define v_municipio        varchar(50);
define v_estado              varchar(50);
define v_curp                   varchar(18);
define v_descripcion     varchar(10);
define v_cartera                             int; --1 si la Cuenta espec�fica tiene adeudos y 0 en caso contrario
define v_leyenda           varchar(100); -- TENIA 50
define v_leyendaRecibo             varchar(255);
define v_codigo                              int;
define v_Encontrado    int;

Let v_Encontrado = 0;

let v_id_34_datos                          = 0;
let v_importe                   = 0;

Let v_id_stat = 0;
Let v_status_vigencia=' ';
Let v_status_vigencia_leyenda=' ';

let v_propietario             = ' ';
let v_calle                          = ' ';
let v_numext                    = ' ';
let v_numint                     = ' ';
let v_colonia                     = ' ';
let v_cp                               = ' ';
let v_rfc                              = ' ';
let v_municipio                                = ' ';
let v_estado      = ' ';
let v_curp                           = ' ';
let v_descripcion             = ' ';
let v_cartera                     = 0;
let v_leyenda    = 'NO PROCEDE COBRO';
let v_leyendaRecibo     = ' ';
let v_codigo                      = -1;


if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
                SELECT a.id_34_datos, a.concesionario, a.ubicacion, id_stat  INTO v_id_34_datos, v_propietario, v_calle, v_id_stat  
                               FROM t34_datos A    WHERE a.cve_tab = par_Tabla and a.control = par_Control;
                               
                                               let v_municipio                                = 'GUADALAJARA';
                                               let v_estado      = 'JALISCO';
                                               
                                               select count(*) into v_Encontrado from t34_rel_multas  where id_34_datos = v_id_34_datos and vigencia = 'V';

                                               select cve_stat, descripcion into v_status_vigencia, v_status_vigencia_leyenda from t34_status where cve_tab = par_Tabla and id_34_stat = v_id_stat;

                                                                              if exists( SELECT * FROM t34_pagos WHERE id_datos = v_id_34_datos ) then
                                                                                              SELECT sum(a.importe) INTO v_importe  FROM t34_pagos a, t34_status b    
                                                                                                              WHERE id_datos = v_id_34_datos  AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E' AND b.cve_stat in ('V');
                                                                                              if v_importe > 0 then
                                                                                                              if v_Encontrado > 0 then
                                                                                                                             let v_cartera      = 1;
                                                                                                                             let v_leyenda   = 'TIENE MULTAS PENDIENTES DE PAGO SOLICITAR ACLARACION Y TIENE ADEUDOS';
                                                                                                                             let v_codigo       = -1;
                                                                                                              else
                                                                                                                             let v_cartera      = 1;
                                                                                                                             let v_leyenda   = 'PROCEDE COBRO';
                                                                                                                             let v_codigo       = 0;
                                                                                                              end if;
                                                                                              else
                                                                                                              if v_Encontrado > 0 then
                                                                                                                             let v_cartera      = 0;
                                                                                                                             let v_leyenda    = 'TIENE MULTAS PENDIENTES DE PAGO SOLICITAR ACLARACION, Y NO TIENE ADEUDOS';
                                                                                                                             let v_codigo       = -1;
                                                                                                              else
                                                                                                                             let v_cartera      = 0;
                                                                                                                             let v_leyenda    = 'NO TIENE ADEUDOS';
                                                                                                                             let v_codigo       = -1;

                                                                                                              end if;

                                                                                              end if;
                                                                              else
                                                                                              if v_Encontrado > 0 then
                                                                                                              let v_cartera      = 0;
                                                                                              let v_leyenda = 'TIENE MULTAS PENDIENTES DE PAGO SOLICITAR ACLARACION Y NO EXISTEN ADEUDOS';
                                                                                              let v_codigo  = -1;
                                                                                              else
                                                                                                              let v_cartera      = 0;
                                                                                              let v_leyenda = 'NO EXISTEN ADEUDOS';
                                                                                              let v_codigo  = -1;
                                                                                              end if;
                                                                              end if;
               if v_status_vigencia <> 'V' then
                  if v_status_vigencia <> 'S' then
                     let v_cartera                     = 0;
                     let v_leyenda    = 'NO PROCEDE COBRO CONTRATO '||v_status_vigencia_leyenda;
                  end if;   
               end if;

                RETURN v_propietario, v_calle, v_numext, v_numint, v_colonia, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_descripcion, v_cartera, v_leyenda, v_leyendaRecibo, v_codigo;
else
                RETURN v_propietario, v_calle, v_numext, v_numint, v_colonia, v_cp, v_rfc, v_municipio, v_estado, v_curp, v_descripcion, v_cartera, v_leyenda, v_leyendaRecibo, v_codigo;
end if;
                                          
end procedure;

create procedure "pgcabrer".sp_15_ex_aplicanotificacion(prec int, pmod int, pidmod int, pfol int, padeudo money(18,2), precargo money(18,2),
pmulta money(18,2), pactualizacion money(18,2), paxohst int, pmeshst int, piduser int)

returning int as folio;

define v_gastos money(18,2);
define v_id_control, d_axo, d_mes, d_tipo, d_porc_multa int;
define d_adeudo, d_recargos, d_descto, d_id_adeudo, d_actualizacion, d_multa money(18,2);
define d_conc varchar(50);
define d_factor decimal(23,16);
define d_porc_act decimal(16,11);
define d_porc_rec decimal(5,2);

-- obtiene la cantidad de gastos del a�o y mes actual
select gtos_notif into v_gastos from ta_15_gastos where fecha_axo=year(today) and fecha_mes=month(today);

-- aplica folio de notificacion
insert into ta_15_apremios (id_control, zona, modulo, control_otr, folio, diligencia, importe_global, importe_multa, importe_recargo, 
importe_gastos, zona_apremio, fecha_emision, clave_practicado, fecha_practicado, fecha_entrega1, fecha_entrega2, fecha_citatorio, hora,
ejecutor, clave_secuestro, clave_remate, fecha_remate, porcentaje_multa, observaciones, fecha_pago, recaudadora, caja, operacion,
importe_pago, vigencia, fecha_actualiz, usuario, clave_mov, hora_practicado, fea_secuencia, importe_actualizacion)
values(0, prec, pmod, pidmod, pfol, 'N', padeudo, pmulta, precargo, v_gastos, 0, today, 'S', null, null, null, null, null, null, null,
null, null, 100, null, null, null, null, null, null, '1', today, piduser, '1', null, null, pactualizacion);

-- obtiene el serial id_control de la notificacion
let v_id_control = dbinfo("sqlca.sqlerrd1");

if pmod=13 then
   foreach
     -- ejecuta el procedimeinto de adeudo detallado por mes de adeudo
     -- **para a�o desde checar si todo el adedo o solo 5 a�os mas actual modificar al final
     execute procedure sp_13_notif_detalle (pidmod, 2001, paxohst ) into d_axo, d_adeudo, d_recargos, d_porc_rec, d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa

     -- inserta detalle de adeudo en periodos de notificacion
     insert into ta_15_periodos (id_control, control_otr, ayo, periodo, importe, recargos, cantidad, tipo, porc_recargo, actualizacion,
       porc_actualizacion, factor_aplicar, multa, porc_multa)
     values(0, v_id_control, d_axo, 12, d_adeudo, d_recargos, d_adeudo, 0, d_porc_rec, d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa);
   end foreach;
end if; 

if pmod=24 then
   foreach
     -- ejecuta el procedimeinto de adeudo detallado por mes de adeudo
     execute procedure dbestacion:notif_pub_detalle ( 2, pidmod, paxohst, pmeshst ) into d_conc, d_axo, d_mes, d_tipo, d_adeudo, d_recargos, d_porc_rec, d_descto, 
                                   d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa

     -- inserta detalle de adeudo en periodos de notificacion
     insert into ta_15_periodos (id_control, control_otr, ayo, periodo, importe, recargos, cantidad, tipo, porc_recargo, actualizacion,
       porc_actualizacion, factor_aplicar, multa, porc_multa)
     values(0, v_id_control, d_axo, d_mes, d_adeudo, d_recargos, d_adeudo, d_tipo, d_porc_rec, d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa);
   end foreach;
end if; 

if pmod=28 then
   foreach
     -- ejecuta el procedimeinto de adeudo detallado por mes de adeudo
     execute procedure dbestacion:notif_exc_detalle ( 2, pidmod, paxohst, pmeshst ) into d_conc, d_axo, d_mes, d_adeudo, d_recargos, d_porc_rec, d_descto, d_tipo, 
                                   d_id_adeudo, d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa

     -- inserta detalle de adeudo en periodos de notificacion
     insert into ta_15_periodos (id_control, control_otr, ayo, periodo, importe, recargos, cantidad, tipo, porc_recargo, actualizacion,
       porc_actualizacion, factor_aplicar, multa, porc_multa)
     values(0, v_id_control, d_axo, d_mes, d_adeudo, d_recargos, d_adeudo, d_tipo, d_porc_rec, d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa);
   end foreach;
end if; 

return pfol;
end procedure;

create procedure "pgcabrer".sp_13_notif_detalle(pfolio int, paxod int, paxoh int)
    returning   int as axo,
                money(12,2) as adeudo, 
                money(10,2) as recargos,
                decimal(7,2) as porc_recargos,
                money(10,2) as actualizacion,
                decimal(16,11) as porc_actualizacion,
                decimal(23,16) as factor_aplicar,
                money(10,2) as multa,
                int as porc_multa;

define v_adeudo, v_recargos, v_actualizacion, v_multa money(12,2);
define v_factor_aplicar decimal(23,16);
define v_porc_actualizacion, v_incp_viejo decimal(16,11);
define v_porc_multa, v_axodesde, v_axo_pagado, v_axo int;
define v_porcentaje decimal(7,2);


SELECT axo_pagado INTO v_axo_pagado
  FROM ta_13_datosrcm WHERE control_rcm = pfolio;

if (v_axo_pagado + 1) < (year(today) - 5) THEN
   let v_axodesde = year(today) - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;

foreach 
    select axo_adeudo, importe, importe_recargos, nvl(actualizacion,0)
    into v_axo, v_adeudo, v_recargos, v_actualizacion      
    from ta_13_adeudosrcm 
    where control_rcm = pfolio and vigencia = 'V' and (axo_adeudo between paxod and paxoh)
    order by 1

    let v_porc_multa=0;
    let v_multa=0;
    if v_recargos>0 then
       let v_porc_multa=30;
       let v_multa=((v_adeudo * v_porc_multa) / 100);
    end if;

    let v_porcentaje=0;
    select porcentaje_global into v_porcentaje from ta_13_recargosrcm where axo=v_axo and mes=month(today);

    let v_factor_aplicar=0;
    let v_porc_actualizacion=0;
    if v_actualizacion>0 then
       if v_axo <=2019 then
          execute FUNCTION catastro_gdl:fn_actualizacionfactor(2019, 1, v_adeudo) into v_factor_aplicar, v_porc_actualizacion, v_incp_viejo;
       else
          execute FUNCTION catastro_gdl:fn_actualizacionfactor(v_axo, 1, v_adeudo) into v_factor_aplicar, v_porc_actualizacion, v_incp_viejo;
       end if;
    end if;

    return v_axo, v_adeudo, v_recargos, v_porcentaje, v_actualizacion, v_porc_actualizacion, v_factor_aplicar, v_multa, v_porc_multa with resume;

end foreach;

end procedure;

create function "pgcabrer".sp_13_genera_notificacion(pcementerio char(1), pfold int, pfolh int, paxo int, pmes int, pmeses int, pimpd int, pimph int, p60 char(1))
returning   int as folio,
            char(1) as cementerio,
            varchar(100) as datos_fosa,
            varchar(100) as propietario,
            varchar(100) as domicilio,
            varchar(6) as exterior,
            varchar(6) as interior,
            int as axoinicio,
            int as axofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;

define v_folio, v_axoinicial, v_axofinal int;
define v_cementerio char(1);
define v_datos_fosa, v_propietario, v_domicilio varchar(100);
define v_exterior, v_interior varchar(6);
define v_adeudo, v_recargos,  v_actualizacion, v_multa, v_gastos, v_total money(18,2);
DEFINE cust_qry LVARCHAR(2000);
DEFINE l_cust_num INTEGER;

let v_adeudo=0; 
let v_recargos=0; 
let v_multa=0; 
let v_actualizacion=0; 
let v_gastos=0; 
let v_total=0;

LET cust_qry = " select distinct d.control_rcm, d.cementerio, ('C-'||clase||' '||clase_alfa||' S-'||seccion||' '||seccion_alfa||' L-'||linea||' '||linea_alfa||' F-'||fosa||' '||fosa_alfa)  " 
   ||" , d.nombre, d.domicilio, exterior, interior, sum(a.importe), sum(a.importe_recargos), sum(a.actualizacion), sum(case when a.importe_recargos>0 then (a.importe*.30) else 0 end) " 
   ||" ,((select (nvl(sum(importe_gastos),0)) from ta_15_apremios where modulo=13 and control_otr=d.control_rcm and clave_practicado='P' and vigencia='1')) "
   ||" ,(select nvl(min(ds.axo_adeudo),0) from ta_13_adeudosrcm ds where ds.control_rcm = d.control_rcm and axo_adeudo<="||paxo||" and vigencia='V' group by ds.control_rcm) "
   ||" ,(select nvl(max(ds.axo_adeudo),0) from ta_13_adeudosrcm ds where ds.control_rcm = d.control_rcm and axo_adeudo<="||paxo||" and vigencia='V' group by ds.control_rcm) "
   ||" from ta_13_datosrcm d, ta_13_adeudosrcm a, tc_13_cementerios t " 
   ||" where d.cementerio='"||pcementerio||"' and d.vigencia='V' and (d.control_rcm between "||pfold||" and "||pfolh||") and a.axo_adeudo<="||paxo
   ||" and a.control_rcm=d.control_rcm and a.vigencia='V' and t.cementerio=d.cementerio ";

LET cust_qry = cust_qry||" and d.control_rcm not in (select control_otr from ta_15_apremios where diligencia = 'N' and vigencia='1' and modulo=13 and (today-fecha_emision)<61) "; 

--   //Cambio 5 Junio 2014 para que no salga notif durante los primeros 60 dias de ya practicado
--   //cambio 11/11/2014 donde valide si fec.prac es nula emita notificacion por correo
   if p60='S' then
      LET cust_qry = cust_qry||"  and ((d.control_rcm in (select unique r.control_otr from ta_15_apremios r "
      ||"  where r.modulo = 13  and r.vigencia = '1' and (nvl((today-fecha_practicado),0)>60 or nvl((today-fecha_practicado),0)=0))) "
      ||"   or (d.control_rcm not in (select control_otr from ta_15_apremios where modulo=13 and control_otr=d.control_rcm and vigencia='1'))) ";
   end if;

   LET cust_qry = cust_qry||" group by 1,2,3,4,5,6,7 " 
   ||" having ( (select (nvl(sum(importe),0)) from ta_13_adeudosrcm where control_rcm=d.control_rcm and axo_adeudo<="||paxo||" and vigencia='V') between "||pimpd||" and "||pimph||") "
   ||" order by 1 ";

   PREPARE stmt_id FROM cust_qry;
   DECLARE cust_cur cursor FOR stmt_id;
   OPEN cust_cur ;

     WHILE (1 = 1)
        FETCH cust_cur into v_folio, v_cementerio, v_datos_fosa, v_propietario, v_domicilio, v_exterior, v_interior, 
                            v_adeudo, v_recargos,  v_actualizacion, v_multa, v_gastos, v_axoinicial, v_axofinal;

        IF (SQLCODE != 100) THEN         
              let v_total=0;
              let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
              return v_folio, v_cementerio, v_datos_fosa, v_propietario, v_domicilio, v_exterior, v_interior, v_axoinicial, v_axofinal, 
                                        v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
        ELSE
           EXIT;
        END IF

     END WHILE
   CLOSE cust_cur;

   FREE cust_cur;
 
   FREE stmt_id;


end function;

create procedure "pgcabrer".spd_15_sinade(p_folio int, p_mod int, p_rec int)
              returning money as adeudo;


define v_adeudo money;
define v_impte money;
define v_cvere  int;
define v_control  int;
define v_ayo    int;
define v_per    int;
define v_tipo   int;
define v_axomes char(06);

let v_cvere=0;
let v_adeudo=0;
let v_control=0;

select  id_control,control_otr into   v_cvere, v_control
 from ta_15_apremios where zona=p_rec and folio=p_folio and modulo=p_mod;

foreach
  select ayo, periodo, tipo
  into v_ayo, v_per, v_tipo
  from ta_15_periodos where control_otr=v_cvere         
  if p_mod=13 then
     select nvl(sum(importe),0)
     into v_impte
     from    ta_13_adeudosrcm
     where control_rcm=v_control and vigencia='V' and axo_adeudo=v_ayo;
     let v_adeudo=v_adeudo+v_impte;
  end if;
  if p_mod=11 then
     select nvl(sum(importe),0)
     into v_impte
     from    ta_11_adeudo_local
     where id_local=v_control  and axo=v_ayo and periodo=v_per;
     let v_adeudo=v_adeudo+v_impte;
  end if;        
  if p_mod=14 then
--     select nvl(fn_getadeinfraccion(b.folio,b.infraccion,b.axo,b.fecha_folio,b.placa,0,0,'F'),0)
     select nvl(dbestacion:cons14_solicrep_PF (b.placa,b.axo,b.folio),0)
     into v_impte
     from  dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
     where a.id=v_control  and b.axo=v_ayo and b.folio=v_per and b.placa=a.placa;
     let v_adeudo=v_adeudo+v_impte;
  end if;
  if p_mod=16 then     
     select nvl(sum(importe),0)
     into v_impte
     from    ta_16_pagos
     where   control_contrato=v_control  and year(aso_mes_pago)=v_ayo and month(aso_mes_pago)=v_per
             and status_vigencia='V';
     let v_adeudo=v_adeudo+v_impte;
  end if; 
  if p_mod=24 then
     select nvl(sum(ade_importe),0)
     into v_impte
     from    dbestacion:pubadeudo
     where pubmain_id=v_control  and axo=v_ayo and mes=v_per;
     let v_adeudo=v_adeudo+v_impte;
  end if; 
  if p_mod=28 then
     select nvl(sum(ade_importe),0)
     into v_impte
     from    dbestacion:ex_adeudo
     where ex_contrato_id=v_control  and axo=v_ayo and mes=v_per;
     let v_adeudo=v_adeudo+v_impte;
  end if;        
end foreach;
 return v_adeudo;
end procedure;

create procedure "pgcabrer".spd_15_foliospag(prec int, pmod int, pfold int, pfolh int, pfemi date, pfpagd date, pfpagh date)
returning  int as idcontrol,
           int as moddulo,
           int as idmodulo,
           int as folio,
           date as fechaemision,
           money(18,2) as importepago,
           date as fechapago,
           varchar(20) as perinicial,
           varchar(20) as perfinal,
           varchar(30) as registro;

define v_idcontrol, v_rec, v_moddulo, v_idmodulo, v_folio int;
define v_perinicial, v_perfinal varchar(20);
define v_registro varchar(30);
define v_fechaemision, v_fechapago date;
define v_importepago money(18,2);

foreach
select a.id_control,a.zona,a.modulo,a.control_otr,a.folio,a.fecha_emision,sum(b.importe_pago), b.fecha_pago,

((select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),

((select Max(axo) from ta_11_pagos_local where id_local=b.id_local)||'-'||
(select max(periodo) from ta_11_pagos_local where id_local=b.id_local and axo=
(select Max(axo) from ta_11_pagos_local where id_local=b.id_local) ) ) 

into v_idcontrol, v_rec, v_moddulo, v_idmodulo, v_folio, v_fechaemision, v_importepago, v_fechapago, v_perinicial, v_perfinal
from ta_15_apremios a,ta_11_pagos_local b 
where a.zona=prec and a.fecha_emision=pfemi and (b.fecha_pago between pfpagd and pfpagh)
and a.modulo=pmod and (a.folio between pfold and pfolh)
and b.id_local=a.control_otr
group by a.id_control,a.zona,a.modulo,a.control_otr,a.folio,a.fecha_emision,8,9,10

if pmod=11 then
   select (oficina||'-'||num_mercado||'-'||categoria||'-'||seccion||'-'||local||'-'||nvl(letra_local,'')||'-'||nvl(bloque,'')) into v_registro
     from ta_11_locales where id_local=v_idmodulo;
end if;

if pmod=13 then
   select control_rcm into v_registro from ta_13_datosrcm where control_rcm=v_idmodulo;
end if;

if pmod=14 then
   select placa into v_registro from dbestacion:ta_padron where id=v_idmodulo;
end if;

if pmod=16 then 
   select (b.tipo_aseo||'-'||a.num_contrato) into v_registro 
     from ta_16_contratos a, ta_16_tipo_aseo b where a.control_contrato=v_idmodulo and b.ctrol_aseo=a.ctrol_aseo; 
end if;

if pmod=24 then
   select numesta into v_registro from dbestacion:pubmain where id=v_idmodulo;
end if;

if pmod=28 then
   select no_exclusivo into v_registro from dbestacion:ex_contrato where id=v_idmodulo;
end if;

return v_idcontrol, v_moddulo, v_idmodulo, v_folio, v_fechaemision, v_importepago, v_fechapago, v_perinicial, v_perfinal, v_registro with resume;
end foreach;

end procedure;

CREATE PROCEDURE "informix".sp_permisos_usuario_ingresos(p_usuario_origen CHAR(8), p_usuario_destino CHAR(8))
RETURNING
    VARCHAR(100) AS mensaje;

-- Definici�n de variables
DEFINE v_cuantos_origen INTEGER;
DEFINE v_cuantos_destino INTEGER;
DEFINE v_id_usuario_origen INTEGER;
DEFINE v_id_usuario_destino INTEGER;

-- Se cuentan cu�ntos usuarios existen con los usuarios dados
SELECT COUNT(*) INTO v_cuantos_origen FROM usuarios WHERE usuario = p_usuario_origen;
SELECT COUNT(*) INTO v_cuantos_destino FROM usuarios WHERE usuario = p_usuario_destino;

-- Si hay un solo usuario por cada nombre dado (origen y destino), procede a dar de alta los tags
IF v_cuantos_origen = 1 AND v_cuantos_destino = 1 THEN
    SELECT id INTO v_id_usuario_origen FROM usuarios WHERE usuario = p_usuario_origen;
    SELECT id INTO v_id_usuario_destino FROM usuarios WHERE usuario = p_usuario_destino;

    INSERT INTO ta_autoriza
    SELECT v_id_usuario_destino, id_modulo, tag  
        FROM ta_autoriza   
        WHERE id_usuario = v_id_usuario_origen
        AND (id_modulo||'-'||tag) NOT IN (SELECT (id_modulo||'-'||tag) FROM ta_autoriza WHERE id_usuario = v_id_usuario_destino);
    RETURN 'Todo bien :D';
ELSE
    RETURN '(!) ERROR: Hubo un problema con los usuarios, favor de verificar si existen o si hay duplicidad';
END IF;

END PROCEDURE;

create procedure "pgcabrer".pagos_convenios(ptipo int, psubt int, prec int, paxo int, pvig char(1))
    returning    int as tipo, 
                int as subtipo, 
                char(3) as letras_exp, 
                int as numero_exp, 
                int as axo_exp, 
                varchar(100) as nombre, 
                date as fecha_inicio, 
                date as fecha_venc, 
                money(18,2) as cantidad_total, 
                money(18,2) as cantidad_inicio,
                varchar(10) as estado, 
                varchar(30) as cuenta, 
                varchar(30) as recibo, 
                money(18,2) as importe_pago, 
                int as pago_parcial, 
                int as total_parciales, 
                date as fecha_pago, 
                int as oficina_pago, 
                char(2) as caja_pago, 
                int as operacion_pago,
                varchar(100) as nombre_tipo,
                varchar(100) as nombre_subtipo;  

define vtipo, vsubtipo, vnumero_exp, vaxo_exp, vpago_parcial, vtotal_parciales, voficina_pago, voperacion_pago int;
define vletras_exp, vletras char(3);  
define vnombre, vntipo, vnsubtipo varchar(100); 
define vfecha_inicio, vfecha_venc, vfecha_pago date; 
define vcantidad_total, vcantidad_inicio, vimporte_pago money(18,2); 
define vestado varchar(10); 
define vcuenta, vrecibo varchar(30);
define vcaja_pago char(2);
DEFINE cust_qry LVARCHAR(2000);
DEFINE l_cust_num INTEGER;

let vletras='';

if  prec=1 then let vletras='ZC1'; end if;
if  prec=2 then let vletras='ZO2'; end if;
if  prec=3 then let vletras='ZO3'; end if;
if  prec=4 then let vletras='ZM4'; end if;
if  prec=5 then let vletras='ZC5'; end if;

LET cust_qry = " select a.tipo, a.subtipo, a.letras_exp, a.numero_exp, a.axo_exp, b.nombre, b.fecha_inicio, b.fecha_venc, b.cantidad_total, b.cantidad_inicio "
        ||" , case when b.vigencia ='P' then 'PAGADO' WHEN b.vigencia ='B'THEN 'BAJA' ELSE 'VIGENTE' END, r.referencia "
        ||" , (select trim(foliorecibo) from ta_12_recibos where fecha=d.fecha_pago AND id_rec=d.oficina_pago AND caja=d.caja_pago AND operacion=d.operacion_pago) "
        ||" , d.importe_pago, d.pago_parcial, d.total_parciales, d.fecha_pago, d.oficina_pago, d.caja_pago, d.operacion_pago, t.descripcion, s.desc_subtipo "
        ||" from ta_17_conv_diverso a, ta_17_conv_d_resto b, outer ta_17_conv_pagos d, ta_17_referencia r, ta_17_tipos t, ta_17_subtipo_conv s ";
if ptipo=0 then
   LET cust_qry = cust_qry||" where a.tipo>=1 ";
else
   LET cust_qry = cust_qry||" where a.tipo="||ptipo;
end if;
if psubt>0 then 
   LET cust_qry = cust_qry||" and a.subtipo="||psubt;
end if;
if prec>0 then 
   LET cust_qry = cust_qry||" and a.letras_exp='"||vletras||"'";
end if
if paxo>0 then
   LET cust_qry = cust_qry||" and a.axo_exp="||paxo;
end if;
if pvig<>'T' then
   LET cust_qry = cust_qry||" and b.vigencia='"||pvig||"'";
end if;
LET cust_qry = cust_qry||" and b.id_conv_diver=a.id_conv_diver and b.tipo=a.tipo and d.id_conv_resto=b.id_conv_resto ";
LET cust_qry = cust_qry||" and r.id_conv_resto=b.id_conv_resto and r.rowid = (select min(rowid) from ta_17_referencia where id_conv_resto=r.id_conv_resto) ";
LET cust_qry = cust_qry||" and t.tipo=a.tipo and s.tipo=a.tipo and s.subtipo=a.subtipo ";
LET cust_qry = cust_qry||" order by a.tipo, a.subtipo, a.letras_exp, a.numero_exp, a.axo_exp, d.pago_parcial ";

   PREPARE stmt_id FROM cust_qry;
   DECLARE cust_cur cursor FOR stmt_id;
   OPEN cust_cur ;

     WHILE (1 = 1)
 
        FETCH cust_cur into vtipo, vsubtipo, vletras_exp, vnumero_exp, vaxo_exp, vnombre, vfecha_inicio, vfecha_venc, vcantidad_total, vcantidad_inicio,
              vestado, vcuenta, vrecibo, vimporte_pago, vpago_parcial, vtotal_parciales, vfecha_pago, voficina_pago, vcaja_pago, voperacion_pago, vntipo, vnsubtipo;
 
        IF (SQLCODE != 100) THEN
           return vtipo, vsubtipo, vletras_exp, vnumero_exp, vaxo_exp, vnombre, vfecha_inicio, vfecha_venc, vcantidad_total, vcantidad_inicio,
              vestado, vcuenta, vrecibo, vimporte_pago, vpago_parcial, vtotal_parciales, vfecha_pago, voficina_pago, vcaja_pago, voperacion_pago, vntipo, vnsubtipo with resume;
        ELSE
           EXIT;
        END IF
 
       END WHILE
 
       CLOSE cust_cur;
 
           FREE cust_cur ;
 
           FREE stmt_id ;  

end procedure;

create procedure "pgcabrer".spd_11_padron_adeudo_total_5axos(paxo int,pmes int,ptip char(1))
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(60) as nombre,
            integer as zona,
            decimal(8,2) as superficie,
            money(7,2) as costo_mtr2013,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo,
            MONEY(16,2) as recargos,
            MONEY(16,2) as multa,
            MONEY(16,2) as actualizacion,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total;
  
define v_actualizaciontotal, v_actualizacion money(16,2);
define v_recargostotal money(16,2);
define v_multatotal, v_multa, v_descrenta MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer, v_msgrenta char(30);          
define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(3);           define v_blq char(2);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);       define v_zona int;
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_actualizaciontotal=0;
let v_multatotal=0;
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 


foreach
  select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
  a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,nvl(sum(d.importe),0)
  into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_zona,v_superf,v_est,v_bloqueo,v_cvecuo,v_adeudo
  from ta_11_locales a,ta_11_mercados b,ta_11_adeudo_local d
  where b.tipo_emision in (ptip,'O') and a.vigencia='A'
  and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
  and d.id_local=a.id_local and 
  ( (d.axo>2018  or (d.periodo>=1  and d.axo=2018)) and
  (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo)) )
  group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
  a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,bloqueo,a.clave_cuota
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

  if v_est='A' then
     if v_bloqueo=4 then
        let v_estado='VIGENTE-BLOQUEADO';
     else
        let v_estado='VIGENTE';
     end if;
  else
     let v_estado='BAJA';
  end if;

  select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
  and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

  -- para obtener los datos de gastos
  let v_folio=0;
  select nvl(count(folio),0),nvl(sum(importe_gastos),0)
  into v_folio,v_gastos
  from   ta_15_apremios a  
  where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

  let v_recargostotal=0; 
  let v_multatotal=0; 
  let v_actualizaciontotal=0;
  let v_total=0;

  -- todos los periodos del local
  foreach
    select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
    into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
    from   ta_11_adeudo_local a,ta_11_fecha_desc b 
    where id_local=v_idl and
    ( (a.axo>2018  or (a.periodo>=1  and a.axo=2018)) 
    and (a.axo<paxo  or (a.periodo<=pmes and a.axo=paxo)) )
    and b.mes=month(today)
    order by axo,periodo

    -- obtiene la actualiacion
    let v_actualizacion=0;
    execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, v_aimporte) into v_actualizacion;
    let v_actualizaciontotal=v_actualizaciontotal+v_actualizacion;

    -- calcula descuento en renta
    let v_descrenta=0;
--    let v_msgrenta='';
--    execute PROCEDURE sp_desctorenta( v_idl, v_aaxo, v_aperiodo, v_aimporte) into v_descrenta, v_msgrenta;

    -- calcula la multa
    let v_multa=0;
    execute procedure spd_11_calc_multa(v_nme, (v_aimporte-v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
    let v_multatotal=v_multatotal+v_multa;

    -- obtiene el porcentaje de recargos
    let v_porc=0;
    let v_recargos=0;
    if today>=v_fecha_rec then
       select sum(porcentaje_mes) into v_porc from ta_12_recargos
       where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
             (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
    else
       select sum(porcentaje_mes) into v_porc from ta_12_recargos
       where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
             (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
    end if;

    if  v_porc is null then
        let v_porc=0;
    end if;

    if  v_folio = 0 then
        if v_porc > 100 then
           let v_recargos=trunc(v_aimporte*100)/100;
        else
           let v_recargos=trunc(v_aimporte*v_porc)/100;
        end if;
    else
        if v_porc > 250 then
           let v_recargos=trunc(v_aimporte*250)/100;
        else
           let v_recargos=trunc(v_aimporte*v_porc)/100;
       end if;
    end if;

    -- acumula recargos por a�o
    let v_recargostotal=v_recargostotal+v_recargos;

    end foreach; -- cierre de los periodos

  -- verifica los periodos de adeudo
  select a.id_local, ( 
  (select min(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2018  or (periodo>=1  and axo=2018))
  and (axo<paxo  or (periodo<=pmes and axo=paxo)))) ||'-'||
  (select min(periodo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2018  or (periodo>=1  and axo=2018))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) and axo=
   (select min(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2018  or (periodo>=1  and axo=2018))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) ) ) ),
  ( 
  (select max(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2018  or (periodo>=1  and axo=2018))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))))||'-'||
  (select max(periodo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2018  or (periodo>=1  and axo=2018))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) and axo=
   (select max(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2018  or (periodo>=1  and axo=2018))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) ) ) )
  into v_ida,v_ini,v_fin
  from   ta_11_adeudo_local a   
  where  a.id_local=v_idl 
  and ( (a.axo>2018  or (a.periodo>=1  and a.axo=2018)) 
  and   (a.axo<paxo  or (a.periodo<=pmes and a.axo=paxo)) )
  group by a.id_local;

  let v_periodo=trim(v_ini)||' al '||trim(v_fin);

  let v_total=v_adeudo+v_recargostotal+v_actualizaciontotal+v_multatotal+v_gastos;

  return trim(v_mer),v_ofi,v_nme,trim(v_sec),v_loc,trim(v_let),trim(v_blq),trim(v_nombre),v_zona,v_superf,v_costomtr,
  trim(v_estado),trim(v_periodo),v_adeudo,v_recargostotal,v_multatotal,v_actualizaciontotal,v_gastos,v_total with resume;
end foreach; -- cierre del principal

end procedure;

CREATE PROCEDURE "pgcabrer".con16_detade_01 ( p_Control_contrato Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
{######################################################################
#  Procedimiento:    Con16_detade_01
#  Descripcion:      Interfaz de consulta de Estado de Cuenta Concentrado para el cobro de ASEO CONTRATADO en el m�dulo de ModulosGdl
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
# p_Rep : Tipo de reporte a obtener
#                           p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                           p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento vencidos dentro de ASEO CONTRATADO
#  Llama a:          
#  
######################################################################}
returning varchar(255) as Concepto,
Money(12,2) as Importe_Adeudos,
Money(12,2) as Importe_Recargos,
Money(12,2) as Importe_Multa,
Money(12,2) as Importe_Gastos,
Money(12,2) as Importe_Act;

--************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
define v_Contador Integer;
--************************************************************************************************************** APREMIOS
define v_id_control, v_folio_req, v_FolReq Integer;
define v_importe_multa, v_tot_multas, v_tot_dscto_multas, v_importe_gastos, v_tot_gastos Money(12,2);
define v_diligencia char(1);
--************************************************************************************************************** ADEUDOS / RECARGOS
define v_aso_mes_pago Date;
define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2,v_totActualizacion Money(12,2);
define v_Axo, v_Mes, v_Axo_pp, v_Mes_pp int;
define v_Lineas_CN, v_Lineas_EX, v_Lineas_Dato Integer;
define v_Detalle_CN, v_Detalle_EX, v_Detalle_T, v_Detalle_Dato varchar(120);
define v_Importe_recargo, v_porcentaje_multa, v_TotRecargos, v_TotDsctoRrgos, v_Reg_1 Money(12,2);
define v_mensaje_proc varchar(255);

define v_Ctrol_Operacion, v_exedencias int;
define v_descripcion varchar(50);
--************************************************************************************************************** AUXILIARES DE PERIODOS
define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy varchar(4);
define a_Periodo_CN, a_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE varchar(7);
define v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade varchar(7);
define v_Periodo varchar(9);
define aso_proceso, aso_actual, v_porc Integer;
--**************************************************************************************************************
define v_Follic Integer;
define v_DetFollic varchar(120);

define  v_ref     char(7);

define v_importe_Dscto_Tot, v_importe_Dscto Money(12,2);  -- adicionado por GMG 31/12/2019 para descuento por pronto pago

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
define v_aplica char(1);
define v_porc_adic int;

-- Descuento por pronto pago
define pp_fecha_inicio, pp_fecha_fin date;
define pp_porc_dscto decimal(5,2);

define v_r_rubro, v_r_cta_aplic, v1_r_cta_aplic, v2_r_cta_aplic, v3_r_cta_aplic int;
define v_r_importe, v1_r_importe, v2_r_importe, v3_r_importe money(12,2);
define v_DetFolReq, v0_DetFolReq, v1_DetFolReq, v2_DetFolReq, v3_DetFolReq, v_concepto varchar(100);

define v_porcdescto int;
define v_mensaje varchar(255);
define v_Multa20, v_DsctoMulta money(12,2);
define v_Multa20_tot, v_DsctoMulta_tot money(12,2);

define v_actualizacion money(12,2);

Let v_porcdescto = 0;
Let v_mensaje = '';
Let v_Multa20 = 0;
Let v_DsctoMulta = 0;
Let v_Multa20_tot = 0;
Let v_DsctoMulta_tot= 0;
   
Let v_Detalle_T = ' ';
Let v_importe = 0;
Let v_Importe_recargo = 0;
Let v_totAdeudos = 0;
Let v_TotRecargos = 0;
Let v_TotDsctoRrgos = 0;
Let v_importe_rec1 = 0;
Let v_importe_rec2 = 0;
Let v_axo = 0;
Let v_Lineas_Dato = 0;
Let v_actualizacion = 0;
Let v_totActualizacion = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO a_Periodo_CN, a_Periodo_EXE;

Let r_Periodo_CN = a_Periodo_CN;
Let r_Periodo_EXE = a_Periodo_EXE;
if p_rep <> 'V' then
if trim(p_Fecha_fin)='' then
    Let v_ref=year(today) || '-' || 12;
Let v_Axo_pp = Year(today);
else
    let v_ref=substr(p_Fecha_fin,1,4) || '-' || substr(p_Fecha_fin,6,2);
Let v_Axo_pp = substr(v_ref,1,4);
end if;
Let v_Mes_pp = substr(v_ref,6,2);

Let a_Periodo_CN = v_ref;
Let a_Periodo_EXE = v_ref;
else
if trim(p_Fecha_fin)='' then
Let v_Axo_pp = year(today);
Let v_Mes_pp = 12;
else
Let v_Axo_pp = substr(p_Fecha_fin,1,4);
Let v_Mes_pp = substr(p_Fecha_fin,6,2);
end if;
end if;
-- if (v_Axo_pp = Year(today)) and (v_Mes_pp = 12) then

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
SELECT aplica INTO v_aplica FROM ta_aplicareq;

-- Descuento por pronto pago
SELECT fecha_inicio, fecha_fin, porc_dscto INTO pp_fecha_inicio, pp_fecha_fin, pp_porc_dscto FROM ta_16_Dscto_pp WHERE status = 'V';

if exists( SELECT * FROM ta_16_contratos WHERE control_contrato = p_Control_contrato ) then

-- LICENCIAS RELACIONADAS
EXECUTE PROCEDURE sp16_LicenciaGiro_F0 ( p_Control_contrato ) INTO v_Follic, v_DetFollic;
if v_Follic > 0 then
RETURN v_DetFollic, Null, Null, Null, Null, Null     with resume;
end if;

-- REQUERIMIENTOS
Let v_r_rubro = 0;  Let v_r_cta_aplic = 0;  
Let v_r_importe = 0;  Let v1_r_importe = 0;  Let v2_r_importe = 0;  Let v3_r_importe = 0;
Let v_DetFolReq = ' ';  Let v1_DetFolReq = ' ';  Let v2_DetFolReq = ' ';  Let v3_DetFolReq = ' ';
FOREACH
EXECUTE PROCEDURE sp_Requerim_F00 ( 16, p_Control_contrato )  INTO v_r_rubro, v_r_cta_aplic, v_r_importe, v_DetFolReq
if v_r_rubro =  0 then  Let v0_DetFolReq = v_DetFolReq;  end if; -- Descripcion de documentos
if v_r_rubro =  1 then  Let v1_DetFolReq = v_DetFolReq;  Let v1_r_importe = v_r_importe;  end if; -- Importe de Multa
if v_r_rubro =  2 then  Let v2_DetFolReq = v_DetFolReq;  Let v2_r_importe = v_r_importe;  end if; -- Descuento a la Multa
if v_r_rubro =  3 then  Let v3_DetFolReq = v_DetFolReq;  Let v3_r_importe = v_r_importe;  end if; -- Importe de Gastos
END FOREACH;

if v_aplica = 'S' then
if ( v1_r_importe <> 0 ) and ( v3_r_importe <> 0 ) then
RETURN v0_DetFolReq, Null, Null, v1_r_importe, v3_r_importe,Null  with resume;
if v2_r_importe <> 0 then
RETURN v2_DetFolReq, Null, Null, v2_r_importe, Null, Null  with resume;
end if;
else
if ( v1_r_importe = 0 ) and ( v3_r_importe <> 0 ) then
RETURN v3_DetFolReq, Null, Null, Null, v3_r_importe, Null  with resume;
end if;
end if;
else
if v3_r_importe <> 0 then
RETURN v3_DetFolReq, Null, Null, Null, v3_r_importe, Null  with resume;
end if;
end if;

Let aso_proceso = 0;
Let aso_actual = Year(Current);

FOR aso_proceso = 1989 to aso_actual
Let v_Lineas_EX = 0;
        Let v_Detalle_EX = ' EXE. Mes(s) --';
 
Let v_Lineas_CN = 0;
        Let v_Detalle_CN = ' C.N. Mes(s) --';
FOREACH

SELECT a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
,calc_actualizacion_aseo(Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.importe)
INTO v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion,v_actualizacion
FROM ta_16_pagos a, ta_16_operacion b
WHERE a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= a_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion = 6
And Year(a.aso_mes_pago) = aso_proceso and b.ctrol_operacion = a.ctrol_operacion
UNION ALL
SELECT a.aso_mes_pago, Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion
,calc_actualizacion_aseo(Year(a.aso_mes_pago), Month(a.aso_mes_pago), a.importe)
FROM ta_16_pagos a, ta_16_operacion b
WHERE a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= a_Periodo_CN  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
--Where a.Control_Contrato = p_Control_contrato  and a.aso_mes_pago <= a_Periodo_EXE  and a.Status_Vigencia = 'V' and a.ctrol_operacion <> 6
And Year(a.aso_mes_pago) = aso_proceso and b.ctrol_operacion = a.ctrol_operacion
ORDER BY 1, 4

-- incrustado
if v_importe > 0 then
if v_Ctrol_Operacion = 6 then
-- INICIO DEL 10% POR PRONTO PAGO
if pp_porc_dscto > 0 and p_rep <> 'V' then
if today >= pp_fecha_inicio and today <= pp_fecha_fin then
if v_Axo = Year(today) and (v_Mes_pp = 12) then -- if v_Axo = Year(today) then  -- solo a�o actual sustituido
Let v_importe_Dscto = (v_importe * pp_porc_dscto);
Let v_importe_Dscto_Tot = v_importe_Dscto_Tot + v_importe_Dscto;
--Let v_importe_Dscto = v_importe_Dscto * -1;
end if;
end if;
end if;
-- FIN DEL 10% POR PRONTO PAGO

if v_Lineas_CN > 0 then
Let v_Detalle_CN = v_Detalle_CN|| ',' || v_Mes;
                else
Let v_Detalle_CN = v_Detalle_CN||v_Mes;
                end if;
                Let v_totAdeudos = v_totAdeudos + v_importe;
                Let v_Lineas_CN = v_Lineas_CN + 1;
                Let v_totActualizacion = v_totActualizacion + v_actualizacion;

SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos
WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN);
else
if v_Lineas_EX > 0 then
Let v_Detalle_EX = v_Detalle_EX|| ',' || v_Mes;
                else
                    Let v_Detalle_EX = v_Detalle_EX||v_Mes;
                end if;
                Let v_totAdeudos = v_totAdeudos + v_importe;
                Let v_Lineas_EX = v_Lineas_EX + 1;

SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos
WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN); -- (r_Periodo_EXE);
end if;
end if;

if v_Importe_recargo <> 0 then  -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA en periodos vencidos
execute PROCEDURE sp_multa_DestoMulta ( 16, p_Control_contrato, v_axo, v_Mes, v_importe ) INTO v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;
if v_Multa20 <> 0 then
Let v_Multa20_tot = v_Multa20_tot + v_Multa20;
end if;
if v_DsctoMulta <> 0 then
Let v_DsctoMulta_tot = v_DsctoMulta_tot + v_DsctoMulta;
end if;
end if;

        if v_Importe_recargo <> 0 then
Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
Let v_TotRecargos = v_TotRecargos + v_importe_rec1;
            EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16)
            INTO v_importe_rec2, v_mensaje_proc;
end if;
        if v_importe_rec2 <> 0 then
Let v_importe_rec2 = v_importe_rec2 * -1;
Let v_TotDsctoRrgos = v_TotDsctoRrgos + v_importe_rec2;
        end if;

Let v_importe = 0;
        Let v_Importe_recargo = 0;
        Let v_importe_rec1 = 0;
        Let v_importe_rec2 = 0;
Let v_importe_Dscto = 0;
        END FOREACH;

--     Grabando registro
if  (v_Lineas_CN > 0) or (v_Lineas_EX > 0) then
--Let v_Detalle_T = 'Adeudos del ' || aso_proceso || ' ';
Let v_Detalle_T = aso_proceso;
if v_Lineas_CN > 0 then
Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
end if;
if v_Lineas_EX > 0 then
Let v_Detalle_T = v_Detalle_T|| ' ' || v_Detalle_EX;
end if;
return v_Detalle_T , v_totAdeudos, v_TotRecargos, Null, Null, v_totActualizacion  with resume;
if v_TotDsctoRrgos > 0 then
Let v_TotDsctoRrgos = v_TotDsctoRrgos * -1;
                return 'Dscto. al Rcgo del Adeudo' , Null, v_TotDsctoRrgos, Null, Null, Null  with resume;
end if;
if v_importe_Dscto_Tot <> 0 then
Let v_importe_Dscto_Tot = v_importe_Dscto_Tot * -1;
RETURN ' 10% Dscto p/pp', v_importe_Dscto_Tot, Null, Null, Null, Null with resume;
end if;
end if;

Let v_totAdeudos = 0;
Let v_TotRecargos = 0;
Let v_TotDsctoRrgos = 0;
Let v_Detalle_T = '';
Let v_importe_Dscto_Tot = 0;
LET v_totActualizacion = 0;
END FOR;

-- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
if v_aplica <> 'S' then
if v_Multa20_tot <> 0 then
RETURN 'Multas ', Null, Null, v_Multa20_tot, Null, Null with resume;
end if;
if v_DsctoMulta_tot <> 0 then
Let v_DsctoMulta_tot = v_DsctoMulta_tot * -1;
RETURN 'Descto. a Multa ', Null, Null, v_DsctoMulta_tot, Null, Null with resume;
end if;
end if;

end if;

end procedure;

create function "pgcabrer".spd_11_adeudodetalle(p_idlocal int)
returning   int as axo,
            int as mes,
            money(18,2) as adeudo,
            money(18,2) as desc_adeudo,
            money(18,2) as ade_apagar,
            money(18,2) as recargos,
            money(18,2) as desc_recargos,
            money(18,2) as rec_apagar,
            money(18,2) as multa,
            money(18,2) as desc_multa,
            money(18,2) as mul_apagar,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total,
            varchar(100) as descuentos;

define v_axomin, v_mesmin, v_folreq, v_porcmul, dias_habil, dias_cuantos, v_aaxo, v_aperiodo int;
define v_dmes, v_desc, v_porc, p_mer, p_cvecuo, v_descrenta90 int;
define v_fecemi, v_fecreq, v_fecha_desc, v_fecha_rec date;
define v_multa, v_gastos, v_gastost, v_muldesc, v_aimporte, v_monto, v_impdesc, v_impcovid19, v_actualizacion money(18,2);
define v_ade_apagar, v_rec_apagar, v_mul_apagar, v_total, v_recargos, v_descuento, v_fact_actual money(18,2);
define v_mensaje, v_leyenda, v_descrenta, v_descrec, v_msgrenta, v_msgmulta, v_descmul varchar(100);

begin
    on exception in (-958)
       delete from tmp_adeudomerc;
    end exception;
create temp table tmp_adeudomerc(
  axo int,
  mes int,
  adeudo money(18,2),
  desc_adeudo money(18,2),
  ade_apagar money(18,2),
  recargos money(18,2),
  desc_recargos money(18,2),
  rec_apagar money(18,2),
  multa money(18,2),
  desc_multa money(18,2),
  mul_apagar money(18,2),
  actualizacion money(18,2),
  gastos money(18,2),
  total money(18,2),
  descuentos varchar(100)) with no log;
end;

let v_impcovid19=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_gastost=0;
let v_aperiodo=0;
let v_impdesc=0;
let v_muldesc=0;
let v_actualizacion=0;
let v_descrenta90=0;
let v_msgrenta='';

-- para obtener el mercado y cve de cuota
select num_mercado, clave_cuota into p_mer, p_cvecuo from ta_11_locales where id_local=p_idlocal;

-- para sacar el a�o minimo
--select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=p_idlocal;
-- para sacar el mes minimo      
--select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=p_idlocal and axo=v_axomin;

--if p_mer=70 then
--   let v_axomin=2017;
--   let v_mesmin=1;
--end if;

 -- para obtener el datos de multa y gastos
foreach
   select b.fecha_emision,nvl(b.folio,0), nvl(b.importe_multa,0),nvl(importe_gastos,0),nvl(b.porcentaje_multa,0),nvl(b.fecha_practicado,null)
   into v_fecemi,v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
   from ta_15_apremios b where b.modulo=11 and b.control_otr=p_idlocal and b.vigencia='1' and b.clave_practicado='P'
   order by  1,2
   let v_gastost=v_gastost+v_gastos;
end foreach;


   let dias_cuantos=0;

/*   select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales
   where fecha between v_fecreq and today;
   
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
--           let v_multa=v_multa*50/100;
           let v_muldesc=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
--              let v_multa=v_multa*80/100;
              let v_muldesc=v_multa*20/100;
           end if;
        end if;
    else
--        let v_multa=(v_multa*(100-v_porcmul))/100;
        let v_muldesc=(v_multa*v_porcmul)/100;
    end if; */ 


    -- obtiene el adeudo mensal
    foreach
    select a.axo, a.periodo, a.importe, b.mes, b.fecha_descuento, b.fecha_recargos, d.id_contribuy_renta
    into   v_aaxo, v_aperiodo, v_aimporte, v_dmes, v_fecha_desc, v_fecha_rec, v_desc
    from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d
    where a.id_local=p_idlocal 
    and b.mes=month(today) and d.id_local=a.id_local
    order by a.axo, a.periodo

    let v_porc=0;
    let v_monto=0;
    let v_impdesc=0;
    let v_impcovid19=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    if (p_mer=90) or (p_cvecuo=19) then
       let v_monto=v_aimporte;
    else
    if p_mer=214 then
       let v_impdesc=(v_aimporte*v_desc)/100;
       let v_monto=v_aimporte;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_monto=v_aimporte;
             else          
                let v_impdesc=v_aimporte*.10;
                let v_monto=v_aimporte;
             end if;
          else
             let v_impdesc=v_aimporte*.10;
             let v_monto=v_aimporte;  
          end if;
       else
          let v_monto=v_aimporte;
       end if;  
    end if;
    end if;

    -- calcula descuento de renta
    let v_descrenta90=0;
    execute procedure sp_desctorenta(p_idlocal,v_aaxo,v_aperiodo,v_aimporte) into v_descrenta90,v_msgrenta;

    -- calcula multa
    if (p_cvecuo=19) and (v_aaxo=2023) and (v_aperiodo=1) and today<=mdy(2,10,2023) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
       let v_multa=0;
    else
       let v_multa=0;
       execute procedure spd_11_calc_multa(p_mer, (v_aimporte-v_descrenta90), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
    end if;

    -- calcula descuento de multa
    let v_muldesc=0;
    execute PROCEDURE sp_desctomulta( p_idlocal, v_aaxo, v_aperiodo, v_multa) into v_muldesc,v_msgmulta;

    -- calcula recargos
    if (p_cvecuo=19) and (v_aaxo=2023) and (v_aperiodo=1) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
     --  execute procedure admin_recargos_13(p_mer,v_folreq,((v_aimporte-v_descrenta90)+v_impdesc),mdy(v_aperiodo,21,v_aaxo)) into v_recargos; -- para el mismo mes
       execute procedure admin_recargos_13(p_mer,v_folreq,((v_aimporte-v_descrenta90)+v_impdesc),mdy(2,11,v_aaxo)) into v_recargos; -- para mes diferente      
    else
       execute procedure admin_recargos_13(p_mer,v_folreq,((v_aimporte-v_descrenta90)+v_impdesc),mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos;
    end if;

    -- calcula descuento de recargos
    let v_descuento=0;
    execute procedure sp_desctomerc(p_idlocal,v_aaxo,v_aperiodo,1,(v_recargos+v_impcovid19),null,0,'',0,11) into v_descuento,v_mensaje;

    -- calcula actualizacion
    if v_impdesc=0 then
       execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, (v_aimporte-v_descrenta90)) into v_actualizacion;
    end if;

    let v_ade_apagar=0; 
    let v_rec_apagar=0; 
    let v_mul_apagar=0; 
    let v_total=0;
    let v_ade_apagar=v_aimporte-v_impdesc-v_descrenta90; 
    let v_rec_apagar=v_recargos-v_descuento; 
    let v_mul_apagar=v_multa-v_muldesc; 
    let v_total=v_ade_apagar+v_rec_apagar+v_actualizacion+v_mul_apagar;
    let v_descrenta=' ';
    let v_descrec=' ';
    let v_descmul=' ';
    if  v_descrenta90>0 then
        let v_descrenta=v_descrenta||'Renta'||' - '; 
    end if;
    if  v_impdesc>0 then
        let v_descrenta=v_descrenta||'Pronto Pago'||' - '; 
    end if;
    if  v_muldesc>0 then
        let v_descmul='Multa'||' - ';
    end if;
    if  v_descuento>0 then
        let v_descrec='Recargo'||' - ';
    end if;
    let v_impdesc=v_impdesc+v_descrenta90;
    let v_leyenda=v_descrenta||v_descmul||v_descrec;
    let v_leyenda=trim(substr(v_leyenda,1,(length(v_leyenda)-2)));
    if p_mer=70 then 
       if v_aaxo>=2017 then
          return v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
              v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda with resume;
          insert into tmp_adeudomerc values(v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
              v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda); 
       end if;
    else
       return v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
           v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda with resume;
       insert into tmp_adeudomerc values(v_aaxo, v_aperiodo, v_aimporte, v_impdesc, v_ade_apagar, v_recargos, v_descuento, v_rec_apagar, 
           v_multa, v_muldesc, v_mul_apagar, v_actualizacion, v_gastost, v_total, v_leyenda); 
    end if;
    end foreach;

end function;

create procedure "pgcabrer".spd_11_padronade_libertad(paxo int,pmes int,ptip char(1))
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(30) as adicionales,
            varchar(60) as nombre,
            integer as zona,
            date as fecha_alta,
            decimal(8,2) as superficie,
            money(7,2) as costo_mtr2013,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo_anterior,
            MONEY(16,2) as recargos_anterior,
            MONEY(16,2) as actualizacion_anterior,
            MONEY(16,2) as multa_anterior,
            MONEY(16,2) as adeudo2001,
            MONEY(16,2) as recargos2001,
            MONEY(16,2) as actualizacion2001,
            MONEY(16,2) as multa2001,
            MONEY(16,2) as adeudo2002,
            MONEY(16,2) as recargos2002,
            MONEY(16,2) as actualizacion2002,
            MONEY(16,2) as multa2002,
            MONEY(16,2) as adeudo2003,
            MONEY(16,2) as recargos2003,
            MONEY(16,2) as actualizacion2003,
            MONEY(16,2) as multa2003,
            MONEY(16,2) as adeudo2004,
            MONEY(16,2) as recargos2004,
            MONEY(16,2) as actualizacion2004,
            MONEY(16,2) as multa2004,
            MONEY(16,2) as adeudo2005,
            MONEY(16,2) as recargos2005,
            MONEY(16,2) as actualizacion2005,
            MONEY(16,2) as multa2005,
            MONEY(16,2) as adeudo2006,
            MONEY(16,2) as recargos2006,
            MONEY(16,2) as actualizacion2006,
            MONEY(16,2) as multa2006,
            MONEY(16,2) as adeudo2007,
            MONEY(16,2) as recargos2007,
            MONEY(16,2) as actualizacion2007,
            MONEY(16,2) as multa2007,
            MONEY(16,2) as adeudo2008,
            MONEY(16,2) as recargos2008,
            MONEY(16,2) as actualizacion2008,
            MONEY(16,2) as multa2008,
            MONEY(16,2) as adeudo2009,
            MONEY(16,2) as recargos2009,
            MONEY(16,2) as actualizacion2009,
            MONEY(16,2) as multa2009,
            MONEY(16,2) as adeudo2010,
            MONEY(16,2) as recargos2010,
            MONEY(16,2) as actualizacion2010,
            MONEY(16,2) as multa2010,
            MONEY(16,2) as adeudo2011,
            MONEY(16,2) as recargos2011,
            MONEY(16,2) as actualizacion2011,
            MONEY(16,2) as multa2011,
            MONEY(16,2) as adeudo2012,
            MONEY(16,2) as recargos2012,
            MONEY(16,2) as actualizacion2012,
            MONEY(16,2) as multa2012,
            MONEY(16,2) as adeudo2013,
            MONEY(16,2) as recargos2013,
            MONEY(16,2) as actualizacion2013,
            MONEY(16,2) as multa2013,
            MONEY(16,2) as adeudo2014,
            MONEY(16,2) as recargos2014,
            MONEY(16,2) as actualizacion2014,
            MONEY(16,2) as multa2014,
            MONEY(16,2) as adeudo2015,
            MONEY(16,2) as recargos2015,
            MONEY(16,2) as actualizacion2015,
            MONEY(16,2) as multa2015,
            MONEY(16,2) as adeudo2016,
            MONEY(16,2) as recargos2016,
            MONEY(16,2) as actualizacion2016,
            MONEY(16,2) as multa2016,
            MONEY(16,2) as adeudo2017,
            MONEY(16,2) as recargos2017,
            MONEY(16,2) as actualizacion2017,
            MONEY(16,2) as multa2017,
            MONEY(16,2) as adeudo2018,
            MONEY(16,2) as recargos2018,
            MONEY(16,2) as actualizacion2018,
            MONEY(16,2) as multa2018,
            MONEY(16,2) as adeudo2019,
            MONEY(16,2) as recargos2019,
            MONEY(16,2) as actualizacion2019,
            MONEY(16,2) as multa2019,
            MONEY(16,2) as adeudo2020,
            MONEY(16,2) as recargos2020,
            MONEY(16,2) as actualizacion2020,
            MONEY(16,2) as multa2020,
            MONEY(16,2) as adeudo2021,
            MONEY(16,2) as recargos2021,
            MONEY(16,2) as actualizacion2021,
            MONEY(16,2) as multa2021,
            MONEY(16,2) as adeudo2022,
            MONEY(16,2) as recargos2022,
            MONEY(16,2) as actualizacion2022,
            MONEY(16,2) as multa2022,
            MONEY(16,2) as adeudo2023,
            MONEY(16,2) as recargos2023,
            MONEY(16,2) as actualizacion2023,
            MONEY(16,2) as multa2023,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total,
            char(5000) as folios;
  
define v_rec2001, v_rec2002, v_rec2003, v_rec2004, v_rec2005, v_rec2006,
       v_rec2007, v_rec2008, v_rec2009, v_rec2010, v_rec2011, v_rec2012, v_rec2013,
       v_rec2014, v_rec2015, v_rec2016, v_rec2017, v_rec2018, v_rec2019, v_rec2020, v_rec2021, v_rec2022, v_rec2023  MONEY(16,2);

define v_ade2001, v_ade2002, v_ade2003, v_ade2004, v_ade2005, v_ade2006,
       v_ade2007, v_ade2008, v_ade2009, v_ade2010, v_ade2011, v_ade2012, v_ade2013,
       v_ade2014, v_ade2015, v_ade2016, v_ade2017, v_ade2018, v_ade2019, v_ade2020, v_ade2021, v_ade2022, v_ade2023  MONEY(16,2); 

define v_act2001, v_act2002, v_act2003, v_act2004, v_act2005, v_act2006,
       v_act2007, v_act2008, v_act2009, v_act2010, v_act2011, v_act2012, v_act2013,
       v_act2014, v_act2015, v_act2016, v_act2017, v_act2018, v_act2019, v_act2020, v_act2021, v_act2022, v_act2023  MONEY(16,2); 

define v_mul2001, v_mul2002, v_mul2003, v_mul2004, v_mul2005, v_mul2006,
       v_mul2007, v_mul2008, v_mul2009, v_mul2010, v_mul2011, v_mul2012, v_mul2013,
       v_mul2014, v_mul2015, v_mul2016, v_mul2017, v_mul2018, v_mul2019, v_mul2020, v_mul2021, v_mul2022, v_mul2023  MONEY(16,2);
 
define v_actuaizacionanterior, v_actualizacion money(16,2);
define v_recargostotal money(16,2);
define v_multaanterior, v_multa, v_descrenta MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado, v_adicionales varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer, v_msgrenta char(30);          
define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(3);           define v_blq char(2);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi, v_fecha_alta date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);       define v_zona int;
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_actuaizacionanterior=0;
let v_multaanterior=0;
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 


foreach
select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,nvl(sum(d.importe),0)
,fn_getademerc(a.id_local,2001,12),fn_getrecmerc(a.id_local,2001,12),fn_getactmerc(a.id_local,2001,12),fn_getmulmerc(a.id_local,2001,12)
,fn_getademerc(a.id_local,2002,12),fn_getrecmerc(a.id_local,2002,12),fn_getactmerc(a.id_local,2002,12),fn_getmulmerc(a.id_local,2002,12)
,fn_getademerc(a.id_local,2003,12),fn_getrecmerc(a.id_local,2003,12),fn_getactmerc(a.id_local,2003,12),fn_getmulmerc(a.id_local,2003,12)
,fn_getademerc(a.id_local,2004,12),fn_getrecmerc(a.id_local,2004,12),fn_getactmerc(a.id_local,2004,12),fn_getmulmerc(a.id_local,2004,12)
,fn_getademerc(a.id_local,2005,12),fn_getrecmerc(a.id_local,2005,12),fn_getactmerc(a.id_local,2005,12),fn_getmulmerc(a.id_local,2005,12)
,fn_getademerc(a.id_local,2006,12),fn_getrecmerc(a.id_local,2006,12),fn_getactmerc(a.id_local,2006,12),fn_getmulmerc(a.id_local,2006,12)
,fn_getademerc(a.id_local,2007,12),fn_getrecmerc(a.id_local,2007,12),fn_getactmerc(a.id_local,2007,12),fn_getmulmerc(a.id_local,2007,12)
,fn_getademerc(a.id_local,2008,12),fn_getrecmerc(a.id_local,2008,12),fn_getactmerc(a.id_local,2008,12),fn_getmulmerc(a.id_local,2008,12)
,fn_getademerc(a.id_local,2009,12),fn_getrecmerc(a.id_local,2009,12),fn_getactmerc(a.id_local,2009,12),fn_getmulmerc(a.id_local,2009,12)
,fn_getademerc(a.id_local,2010,12),fn_getrecmerc(a.id_local,2010,12),fn_getactmerc(a.id_local,2010,12),fn_getmulmerc(a.id_local,2010,12)
,fn_getademerc(a.id_local,2011,12),fn_getrecmerc(a.id_local,2011,12),fn_getactmerc(a.id_local,2011,12),fn_getmulmerc(a.id_local,2011,12)
,fn_getademerc(a.id_local,2012,12),fn_getrecmerc(a.id_local,2012,12),fn_getactmerc(a.id_local,2012,12),fn_getmulmerc(a.id_local,2012,12)
,fn_getademerc(a.id_local,2013,12),fn_getrecmerc(a.id_local,2013,12),fn_getactmerc(a.id_local,2013,12),fn_getmulmerc(a.id_local,2013,12)
,fn_getademerc(a.id_local,2014,12),fn_getrecmerc(a.id_local,2014,12),fn_getactmerc(a.id_local,2014,12),fn_getmulmerc(a.id_local,2014,12)
,fn_getademerc(a.id_local,2015,12),fn_getrecmerc(a.id_local,2015,12),fn_getactmerc(a.id_local,2015,12),fn_getmulmerc(a.id_local,2015,12)
,fn_getademerc(a.id_local,2016,12),fn_getrecmerc(a.id_local,2016,12),fn_getactmerc(a.id_local,2016,12),fn_getmulmerc(a.id_local,2016,12)
,fn_getademerc(a.id_local,2017,12),fn_getrecmerc(a.id_local,2017,12),fn_getactmerc(a.id_local,2017,12),fn_getmulmerc(a.id_local,2017,12)
,fn_getademerc(a.id_local,2018,12),fn_getrecmerc(a.id_local,2018,12),fn_getactmerc(a.id_local,2018,12),fn_getmulmerc(a.id_local,2018,12)
,fn_getademerc(a.id_local,2019,12),fn_getrecmerc(a.id_local,2019,12),fn_getactmerc(a.id_local,2019,12),fn_getmulmerc(a.id_local,2019,12)
,fn_getademerc(a.id_local,2020,12),fn_getrecmerc(a.id_local,2020,12),fn_getactmerc(a.id_local,2020,12),fn_getmulmerc(a.id_local,2020,12)
,fn_getademerc(a.id_local,2021,12),fn_getrecmerc(a.id_local,2021,12),fn_getactmerc(a.id_local,2021,12),fn_getmulmerc(a.id_local,2021,12)
,fn_getademerc(a.id_local,2022,12),fn_getrecmerc(a.id_local,2022,12),fn_getactmerc(a.id_local,2022,12),fn_getmulmerc(a.id_local,2022,12)
,fn_getademerc(a.id_local,2023,pmes),fn_getrecmerc(a.id_local,2023,pmes),fn_getactmerc(a.id_local,2023,pmes),fn_getmulmerc(a.id_local,2023,pmes)
,a.descripcion_local,a.fecha_alta 
into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_zona,v_superf,v_est,v_bloqueo,v_cvecuo,
v_ade,v_ade2001,v_rec2001,v_act2001,v_mul2001,v_ade2002,v_rec2002,v_act2002,v_mul2002,
v_ade2003,v_rec2003,v_act2003,v_mul2003,v_ade2004,v_rec2004,v_act2004,v_mul2004,v_ade2005,v_rec2005,v_act2005,v_mul2005,v_ade2006,v_rec2006,v_act2006,v_mul2006,
v_ade2007,v_rec2007,v_act2007,v_mul2007,v_ade2008,v_rec2008,v_act2008,v_mul2008,v_ade2009,v_rec2009,v_act2009,v_mul2009,v_ade2010,v_rec2010,v_act2010,v_mul2010,
v_ade2011,v_rec2011,v_act2011,v_mul2011,v_ade2012,v_rec2012,v_act2012,v_mul2012,v_ade2013,v_rec2013,v_act2013,v_mul2013,v_ade2014,v_rec2014,v_act2014,v_mul2014,
v_ade2015,v_rec2015,v_act2015,v_mul2015,v_ade2016,v_rec2016,v_act2016,v_mul2016,v_ade2017,v_rec2017,v_act2017,v_mul2017,v_ade2018,v_rec2018,v_act2018,v_mul2018,
v_ade2019,v_rec2019,v_act2019,v_mul2019,v_ade2020,v_rec2020,v_act2020,v_mul2020,v_ade2021,v_rec2021,v_act2021,v_mul2021,v_ade2022,v_rec2022,v_act2022,v_mul2022,
v_ade2023,v_rec2023,v_act2023,v_mul2023,v_adicionales, v_fecha_alta
from ta_11_locales a,ta_11_mercados b,outer ta_11_adeudo_local d
where b.tipo_emision=ptip and a.vigencia='A' and b.num_mercado_nvo=34
and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
and d.id_local=a.id_local and (d.axo<2000  or (d.periodo<=12 and d.axo=2000))
group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,bloqueo,a.clave_cuota,a.descripcion_local, a.fecha_alta
--having (sum(d.importe)>0) or (fn_getademerc(a.id_local,2001,12))>0 or (fn_getademerc(a.id_local,2002,12))>0
--or (fn_getademerc(a.id_local,2003,12))>0 or (fn_getademerc(a.id_local,2004,12))>0
--or (fn_getademerc(a.id_local,2005,12))>0 or (fn_getademerc(a.id_local,2006,12))>0 
--or (fn_getademerc(a.id_local,2007,12))>0 or (fn_getademerc(a.id_local,2008,12))>0 
--or (fn_getademerc(a.id_local,2009,12))>0 or (fn_getademerc(a.id_local,2010,12))>0
--or (fn_getademerc(a.id_local,2011,12))>0 or (fn_getademerc(a.id_local,2012,12))>0
--or (fn_getademerc(a.id_local,2013,12))>0 or (fn_getademerc(a.id_local,2014,12))>0
--or (fn_getademerc(a.id_local,2015,12))>0 or (fn_getademerc(a.id_local,2016,12))>0 
--or (fn_getademerc(a.id_local,2017,12))>0 or (fn_getademerc(a.id_local,2018,12))>0
--or (fn_getademerc(a.id_local,2019,12))>0 or (fn_getademerc(a.id_local,2020,12))>0
--or (fn_getademerc(a.id_local,2021,12))>0 or (fn_getademerc(a.id_local,2022,12))>0
--or (fn_getademerc(a.id_local,2023,pmes))>0
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

if v_est='A' then
   if v_bloqueo=4 then
      let v_estado='VIGENTE-BLOQUEADO';
   else
      let v_estado='VIGENTE';
   end if;
else
   let v_estado='BAJA';
end if;

select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

-- para obtener los datos de gastos
let v_folio=0;
select nvl(count(folio),0),nvl(sum(importe_gastos),0)
into v_folio,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  
let v_total=0;

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=v_idl and (a.axo<2000  or (a.periodo<=12 and a.axo=2000)) 
and b.mes=month(today)
order by axo,periodo

-- obtiene la actualiacion
let v_actualizacion=0;
execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, v_aimporte) into v_actualizacion;
let v_actuaizacionanterior=v_actuaizacionanterior+v_actualizacion;

-- calcula descuento en renta
let v_descrenta=0;
let v_msgrenta='';
execute PROCEDURE sp_desctorenta( v_idl, v_aaxo, v_aperiodo, v_aimporte) into v_descrenta, v_msgrenta;

-- calcula la multa
let v_multa=0;
execute procedure spd_11_calc_multa(v_nme, (v_aimporte-v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
let v_multaanterior=v_multaanterior+v_multa;

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if today>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

-- verifica los periodos de adeudo
select a.id_local, ( 
(select min(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo)))),
((select Max(axo) from ta_11_adeudo_local where id_local=a.id_local 
and (axo<paxo  or (periodo<=pmes and axo=paxo))))
into v_ida,v_ini,v_fin
from   ta_11_adeudo_local a   
where  a.id_local=v_idl 
group by a.id_local;
let v_periodo=trim(v_ini);

-- verifica los folios de requerimientos
let v_requerimientos='';
foreach
select id_control,fecha_emision,folio,fecha_practicado,( 
(select min(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select min(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select min(ayo) from ta_15_periodos where control_otr=a.id_control) ) ),(
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control)||'-'||
(select max(periodo) from ta_15_periodos where control_otr=a.id_control and ayo=
(select Max(ayo) from ta_15_periodos where control_otr=a.id_control) ) )
into v_ida,v_emi,v_fol,v_pra,v_ini,v_fin
from   ta_15_apremios a   
where  a.modulo=11 and a.control_otr=v_idl and a.vigencia='1' and a.clave_practicado='P'
and a.fecha_emision>=mdy(1,1,2013)
order by a.fecha_emision,a.folio
let v_requerimientos=trim(v_requerimientos)||v_fol||',';
end foreach; -- cierre de apremios

let v_requerimientos=substr(v_requerimientos,1,(length(v_requerimientos)-1));
let v_total=v_ade+v_recargostotal+v_actuaizacionanterior+v_multaanterior+v_ade2001+v_rec2001+v_ade2002+v_rec2002+
v_ade2003+v_rec2003+v_ade2004+v_rec2004+v_ade2005+v_rec2005+v_ade2006+v_rec2006+v_ade2007+v_rec2007+
v_ade2008+v_rec2008+v_ade2009+v_rec2009+v_ade2010+v_rec2010+v_ade2011+v_rec2011+v_ade2012+v_rec2012+
v_ade2013+v_rec2013+v_ade2014+v_rec2014+v_ade2015+v_rec2015+v_ade2016+v_rec2016+v_ade2017+v_rec2017+
v_ade2018+v_rec2018+v_ade2019+v_rec2019+v_ade2020+v_rec2020+v_ade2021+v_rec2021+v_ade2022+v_ade2023+v_rec2022+v_rec2023+v_gastos+
v_act2001+v_act2002+v_act2003+v_act2004+v_act2005+v_act2006+v_act2007+v_act2008+v_act2009+v_act2010+
v_act2011+v_act2012+v_act2013+v_act2014+v_act2015+v_act2016+v_act2017+v_act2018+v_act2019+v_act2020+v_act2021+v_act2022+v_act2023+
v_mul2001+v_mul2002+v_mul2003+v_mul2004+v_mul2005+v_mul2006+v_mul2007+v_mul2008+v_mul2009+v_mul2010+
v_mul2011+v_mul2012+v_mul2013+v_mul2014+v_mul2015+v_mul2016+v_mul2017+v_mul2018+v_mul2019+v_mul2020+v_mul2021+v_mul2022+v_mul2023;

return trim(v_mer),v_ofi,v_nme,trim(v_sec),v_loc,trim(v_let),trim(v_blq),v_adicionales,trim(v_nombre),v_zona,v_fecha_alta,v_superf,v_costomtr,
trim(v_estado),trim(v_periodo),v_ade,v_recargostotal,v_actuaizacionanterior,v_multaanterior,v_ade2001,v_rec2001,v_act2001,v_mul2001,v_ade2002,v_rec2002,v_act2002,v_mul2002,
v_ade2003,v_rec2003,v_act2003,v_mul2003,v_ade2004,v_rec2004,v_act2004,v_mul2004,v_ade2005,v_rec2005,v_act2005,v_mul2005,v_ade2006,v_rec2006,v_act2006,v_mul2006,
v_ade2007,v_rec2007,v_act2007,v_mul2007,v_ade2008,v_rec2008,v_act2008,v_mul2008,v_ade2009,v_rec2009,v_act2009,v_mul2009,v_ade2010,v_rec2010,v_act2010,v_mul2010,
v_ade2011,v_rec2011,v_act2011,v_mul2011,v_ade2012,v_rec2012,v_act2012,v_mul2012,v_ade2013,v_rec2013,v_act2013,v_mul2013,v_ade2014,v_rec2014,v_act2014,v_mul2014,
v_ade2015,v_rec2015,v_act2015,v_mul2015,v_ade2016,v_rec2016,v_act2016,v_mul2016,v_ade2017,v_rec2017,v_act2017,v_mul2017,v_ade2018,v_rec2018,v_act2018,v_mul2018,
v_ade2019,v_rec2019,v_act2019,v_mul2019,v_ade2020,v_rec2020,v_act2020,v_mul2020,v_ade2021,v_rec2021,v_act2021,v_mul2021,v_ade2022,v_rec2022,v_act2022,v_mul2022,
v_ade2023,v_rec2023,v_act2023,v_mul2023,v_gastos,v_total,trim(v_requerimientos)
with resume;
end foreach; -- cierre del principal

end procedure;

CREATE FUNCTION "pgcabrer".spd_11_mesesadeudoaxo_libertad(p_rec int, p_mer int, p_axo int, p_mes int, p_vig char(1))
returning  varchar(100) as nombre_mercado,
           int as oficina,
           int as mercado,
           int as categoria,
           char(2) as seccion,
           int as local,
           char(3) as letra,
           char(3) as bloque,
           varchar(20) as adicionales,
           varchar(100) as nombre,
           date as fecha_alta,
           decimal(7,2) as superficie,
           money(18,2) as renta,
           money(18,2) as adeudo,
           money(18,2) as recargos,
           money(18,2) as multa,
           money(18,2) as gastos,
           money(18,2) as actualizacion,
           money(18,2) as total,
           int as axo, 
           varchar(30) as meses,
           char(1) as vigencia,
           varchar(250) as folios;

define v_adeudo, v_adeapagar, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_renta, v_importe money(18,2);    
define t_axo, v_axo, v_mes, v_axodsd, v_mesdsd, v_axohst, v_meshst, v_id, v_rec, v_merc, v_cat, v_local, v_cvecuo int;
define t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, t_desc_recargos, t_rec_apagar money(18,2);
define t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total money(18,2);
define v_fecha_alta date;
define v_sec char(2);
define v_vig char(1);
define v_meses, v_adicionales varchar(30);
define v_let, v_blq char(3);
define v_super decimal(7,2);
define v_nom_merc, v_nombre varchar(100);
define t_leyenda varchar(100);
define v_folios varchar(250);
DEFINE cust_qry LVARCHAR(1000);
DEFINE l_cust_num INTEGER;

let v_folios=0;
--set debug file to 'spd_11_mesesadeudoaxo.txt';
--trace on;
-- selecciona locales
  LET cust_qry = " select a.id_local, a.oficina, a.num_mercado, a.categoria, a.seccion, a.local, a.letra_local, a.bloque, a.descripcion_local, a.nombre, a.fecha_alta, a.superficie "
       ||" , a.clave_cuota, a.vigencia, b.descripcion, sum(d.importe) from ta_11_locales a, ta_11_mercados b, outer ta_11_adeudo_local d " 
       ||" where a.oficina="||p_rec;
    if p_mer<>0 then
       LET cust_qry = cust_qry||" and a.num_mercado="||p_mer;
    end if;
    if p_vig<>'0' then
       if p_vig='A' then
          LET cust_qry = cust_qry||" and a.vigencia='"||p_vig||"'";
       else
          LET cust_qry = cust_qry||" and a.vigencia in ('B','C','D')";
       end if;
    end if;
    LET cust_qry = cust_qry||" and d.id_local=a.id_local and b.tipo_emision<>'B' and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado" 
       ||" group by a.id_local, a.oficina, a.num_mercado, a.categoria, a.seccion, a.local, a.letra_local, a.bloque, a.descripcion_local, a.nombre, a.fecha_alta, a.superficie "
       ||" , a.clave_cuota, a.vigencia, b.descripcion "
       ||" order by a.oficina, a.num_mercado, a.categoria, a.seccion, a.local, a.letra_local, a.bloque";

   PREPARE stmt_id FROM cust_qry;
   DECLARE cust_cur cursor FOR stmt_id;
   OPEN cust_cur ;
     WHILE (1 = 1)
         FETCH cust_cur into v_id, v_rec, v_merc, v_cat, v_sec, v_local, v_let, v_blq, v_adicionales, v_nombre, v_fecha_alta, v_super, v_cvecuo, v_vig, v_nom_merc, v_importe;
 
        IF (SQLCODE != 100) THEN
           -- ejecuta tabla de detalle para generar tabla temporal
           foreach
             execute function spd_11_adeudodetalle(v_id) into t_axo, v_mes, t_adeudo, t_desc_adeudo, t_ade_apagar, t_recargos, 
             t_desc_recargos, t_rec_apagar, t_multa, t_desc_multa, t_mul_apagar, t_actualizacion, t_gastos, t_total, t_leyenda
           end foreach;

           -- totales de tabla temporal
           foreach
             select axo, sum(adeudo), sum(rec_apagar), sum(mul_apagar), max(gastos), sum(actualizacion),
              (sum(adeudo)+sum(rec_apagar)+sum(mul_apagar)+max(gastos)+sum(actualizacion))
             into v_axo, v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total 
             from tmp_adeudomerc where (axo<p_axo  or (mes<=p_mes and axo=p_axo))
             group by axo order by axo

             -- meses de adeudo
             let v_meses='';
             foreach
               select mes into v_mes from tmp_adeudomerc where axo=v_axo order by mes
               let v_meses=trim(v_meses)||v_mes||',';
             end foreach; 
             let v_meses=substr(v_meses,1,(length(v_meses)-1));

             -- calcula la renta
             let v_renta=0;
             execute procedure spd_11_calc_renta(v_axo, v_cat, v_sec, v_cvecuo, v_super, v_merc, 0) into v_renta;

             return v_nom_merc, v_rec, v_merc, v_cat, v_sec, v_local, v_let, v_blq, v_adicionales, v_nombre, v_fecha_alta, v_super, v_renta, 
                    v_adeudo, v_recargos, v_multa, v_gastos, v_actualizacion, v_total, v_axo, v_meses, v_vig, v_folios with resume;
           end foreach;
           -- borrar tabla temporal
           delete from tmp_adeudomerc;
        ELSE
           EXIT;
        END IF
 
       END WHILE
 
       CLOSE cust_cur;
 
           FREE cust_cur ;
 
           FREE stmt_id ;
--trace off;
end function;

create procedure "pgcabrer".sp34_calc_multa(pimp money(18,2),pven date)
returning   money(18,2) as multa;

define v_multa money(18,2);
define v_porc int;


-- la mulat se pone directo porque maribel dispuso que para estacionamientos es 20% 15/063/2023 peticion por correo
let v_porc=30;

-- **** se deshabilita la consulta de la tabla porque para estacionometros es 20% 15/063/2023 peticion por correo
--select porc_multa_calc into v_porc from dbestacion:parametros;

let v_multa=0;

   if year(today)=year(pven) then
      if month(today)>month(pven) then
         let v_multa=trunc(pimp*v_porc)/100; 
      else
      if month(today)=month(pven) then
            if day(today)<day(pven) then
               let v_multa=0;
            else
               let v_multa=trunc(pimp*v_porc)/100;
            end if;
      else
      if month(today)<month(pven) then
            let v_multa=0;
          else
            let v_multa=trunc(pimp*v_porc)/100;
          end if; 
        end if;          
      end if;       
   else
      let v_multa=trunc(pimp*v_porc)/100;
   end if;

return v_multa;
end procedure;

create procedure "pgcabrer".spd_11_pagosdetmercsinacc(pmer int,pdsd date,phst date)
returning   int as idlocal,
            int as rec,
            int as merc,
            int as cat,
            char(2) as seccion,
            int as local,
            char(3) as letra,
            char(2) as bloque,
            date as fechapago,
            int as recpago,
            char(2) as cajapago,
            int as operpago,
            varchar(10) as perdsd,
            varchar(10) as perhst,
            money(16,2) as arrendamiento;

define v_id,v_rec,v_merc,v_cat,v_local,v_recpago,v_operpago,v_folio,v_ejecutor,xrec,xoper int;
define v_seccion,v_cajapago,xcaja char(2);
define v_letra char(3);
define v_bloque char(2);
define v_diligencia char(1);
define v_fechapago,v_fechaemision,v_fechapractica,v_fechaentrega,xfecha date;
define v_importe,v_arrendamiento,v_recargos,v_multa,v_gastos,v_gasfol money(16,2);
define v_perdsd,v_perhst varchar(10);
define v_cuenta,v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst int; 

let xfecha=null;
let xrec=0;
let xcaja='';
let xoper=0;

foreach
select b.id_local,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,
((select min(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago)||'-'||
(select min(periodo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago and axo=
(select min(axo) from ta_11_pagos_local  where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago))),
((select Max(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago)||'-'||
(select max(periodo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago and axo=
(select Max(axo) from ta_11_pagos_local where id_local=a.id_local and oficina_pago=a.oficina_pago 
and caja_pago=a.caja_pago and operacion_pago=a.operacion_pago))), sum(a.importe_pago)
into v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
v_operpago,v_perdsd,v_perhst, v_arrendamiento
from ta_11_pagos_local a, ta_11_locales b
where (a.fecha_pago between pdsd and phst) and b.num_mercado=pmer and b.id_local=a.id_local 
group by b.id_local,b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago,13,14
order by b.oficina,b.num_mercado,b.categoria,b.seccion,b.local,b.letra_local,b.bloque,
a.fecha_pago,a.oficina_pago,a.caja_pago,a.operacion_pago

select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,cuenta_descmulta,cuenta_gastos 
into v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst
from ta_11_mercados where num_mercado_nvo=v_merc;

/*foreach
select cuenta,importe into v_cuenta,v_importe from ta_12_recibosdet 
where fecha=v_fechapago and id_rec=v_recpago and caja=v_cajapago and operacion=v_operpago
and cuenta in(v_ctaact,v_ctarzg,v_ctarec,v_ctadrec,v_ctamul,v_ctadmul,v_ctagst)

if (v_cuenta=v_ctaact) or (v_cuenta=v_ctarzg) then let v_arrendamiento=v_importe; 
else if (v_cuenta=v_ctarec) or (v_cuenta=v_ctadrec) then let v_recargos=v_importe;
else if (v_cuenta=v_ctamul) or (v_cuenta=v_ctadmul) then let v_multa=v_importe;
else if v_cuenta=v_ctagst then let v_gastos=v_importe;
end if; end if; end if; end if;

end foreach */

   return v_id,v_rec,v_merc,v_cat,v_seccion,v_local,v_letra,v_bloque,v_fechapago,v_recpago,v_cajapago,
   v_operpago,v_perdsd,v_perhst,v_arrendamiento with resume;

let xfecha=v_fechapago;
let xrec=v_recpago;
let xcaja=v_cajapago;
let xoper=v_operpago;
end foreach;
end procedure;

create procedure "pgcabrer".spd_11_padron_adeudo_total_rango(paxo int,pmes int,ptip char(1))
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(60) as nombre,
            integer as zona,
            decimal(8,2) as superficie,
            money(7,2) as costo_mtr2013,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo,
            MONEY(16,2) as recargos,
            MONEY(16,2) as multa,
            MONEY(16,2) as actualizacion,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total;
  
define v_actualizaciontotal, v_actualizacion money(16,2);
define v_recargostotal money(16,2);
define v_multatotal, v_multa, v_descrenta MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre varchar(60);
define v_periodo varchar(20);
define v_mer, v_msgrenta char(30);          
define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc integer;
define v_let char(3);           define v_blq char(2);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);       define v_zona int;
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_actualizaciontotal=0;
let v_multatotal=0;
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 


foreach
  select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
  a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,nvl(sum(d.importe),0)
  into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_zona,v_superf,v_est,v_bloqueo,v_cvecuo,v_adeudo
  from ta_11_locales a,ta_11_mercados b,ta_11_adeudo_local d
  where b.tipo_emision in (ptip,'O') and a.vigencia='A'
  and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
  and d.id_local=a.id_local and 
  ( (d.axo>2021  or (d.periodo>=10  and d.axo=2021)) and
  (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo)) )
  group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
  a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,bloqueo,a.clave_cuota
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

  if v_est='A' then
     if v_bloqueo=4 then
        let v_estado='VIGENTE-BLOQUEADO';
     else
        let v_estado='VIGENTE';
     end if;
  else
     let v_estado='BAJA';
  end if;

  select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
  and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

  -- para obtener los datos de gastos
  let v_folio=0;
  select nvl(count(folio),0),nvl(sum(importe_gastos),0)
  into v_folio,v_gastos
  from   ta_15_apremios a  
  where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

  let v_recargostotal=0; 
  let v_multatotal=0; 
  let v_actualizaciontotal=0;
  let v_total=0;

  -- todos los periodos del local
  foreach
    select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
    into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
    from   ta_11_adeudo_local a,ta_11_fecha_desc b 
    where id_local=v_idl and
    ( (a.axo>2021  or (a.periodo>=10  and a.axo=2021)) 
    and (a.axo<paxo  or (a.periodo<=pmes and a.axo=paxo)) )
    and b.mes=month(today)
    order by axo,periodo

    -- obtiene la actualiacion
    let v_actualizacion=0;
    execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, v_aimporte) into v_actualizacion;
    let v_actualizaciontotal=v_actualizaciontotal+v_actualizacion;

    -- calcula descuento en renta
    let v_descrenta=0;
--    let v_msgrenta='';
--    execute PROCEDURE sp_desctorenta( v_idl, v_aaxo, v_aperiodo, v_aimporte) into v_descrenta, v_msgrenta;

    -- calcula la multa
    let v_multa=0;
    execute procedure spd_11_calc_multa(v_nme, (v_aimporte-v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
    let v_multatotal=v_multatotal+v_multa;

    -- obtiene el porcentaje de recargos
    let v_porc=0;
    let v_recargos=0;
    if today>=v_fecha_rec then
       select sum(porcentaje_mes) into v_porc from ta_12_recargos
       where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
             (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
    else
       select sum(porcentaje_mes) into v_porc from ta_12_recargos
       where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
             (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
    end if;

    if  v_porc is null then
        let v_porc=0;
    end if;

    if  v_folio = 0 then
        if v_porc > 100 then
           let v_recargos=trunc(v_aimporte*100)/100;
        else
           let v_recargos=trunc(v_aimporte*v_porc)/100;
        end if;
    else
        if v_porc > 250 then
           let v_recargos=trunc(v_aimporte*250)/100;
        else
           let v_recargos=trunc(v_aimporte*v_porc)/100;
       end if;
    end if;

    -- acumula recargos por a�o
    let v_recargostotal=v_recargostotal+v_recargos;

    end foreach; -- cierre de los periodos

  -- verifica los periodos de adeudo
  select a.id_local, ( 
  (select min(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2021  or (periodo>=10  and axo=2021))
  and (axo<paxo  or (periodo<=pmes and axo=paxo)))) ||'-'||
  (select min(periodo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2021  or (periodo>=10  and axo=2021))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) and axo=
   (select min(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2021  or (periodo>=10  and axo=2021))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) ) ) ),
  ( 
  (select max(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2021  or (periodo>=10  and axo=2021))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))))||'-'||
  (select max(periodo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2021  or (periodo>=10  and axo=2021))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) and axo=
   (select max(axo) from ta_11_adeudo_local where id_local=a.id_local and ( (axo>2021  or (periodo>=10  and axo=2021))
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) ) ) )
  into v_ida,v_ini,v_fin
  from   ta_11_adeudo_local a   
  where  a.id_local=v_idl 
  and ( (a.axo>2021  or (a.periodo>=10  and a.axo=2021)) 
  and   (a.axo<paxo  or (a.periodo<=pmes and a.axo=paxo)) )
  group by a.id_local;

  let v_periodo=trim(v_ini)||' al '||trim(v_fin);

  let v_total=v_adeudo+v_recargostotal+v_actualizaciontotal+v_multatotal+v_gastos;

  return trim(v_mer),v_ofi,v_nme,trim(v_sec),v_loc,trim(v_let),trim(v_blq),trim(v_nombre),v_zona,v_superf,v_costomtr,
  trim(v_estado),trim(v_periodo),v_adeudo,v_recargostotal,v_multatotal,v_actualizaciontotal,v_gastos,v_total with resume;
end foreach; -- cierre del principal

end procedure;

create procedure "pgcabrer".spd_17_parcvencida()
returning   varchar(15) as convenio,
            varchar(60) as nombre,
            varchar(60) as domicilio,
            varchar(30) as subtipo,
            date as fechaconv,
            money(16,2) as totalconv,
            varchar(20) as periodos,
            integer as parcconv,
            varchar(20) as registro,
            varchar(10) as parcvenc,
            money(16,2) as adeudo,
            money(16,2) as intereses,
            money(16,2) as recargos,
            money(16,2) as total;

define v_nombre,v_domicilio varchar(60);
define v_tipo,v_subtipo varchar(30);
define v_registro,v_periodo varchar(20);
define v_convenio varchar(15);
define v_letras char(3);
define v_parcvenc varchar(10);
define v_iddiver,v_idresto,v_numero,v_axo,v_parcialidad,v_parcconv integer;
define v_adeudo,v_intereses,v_recargos,v_total,v_totconv money(16,2);
define v_fechaconv date;

foreach
select b.id_conv_resto,a.letras_exp,a.numero_exp,a.axo_exp,b.nombre,
(trim(b.calle)||' Ext. '||b.num_exterior||' Int. '||b.num_interior||' Inc. '||trim(b.inciso)) domicilio,
(trim(a.letras_exp)||'/'||a.numero_exp||'/'||a.axo_exp) convenio,
i.descripcion,d.desc_subtipo,
case when b.pago_final>0 then (b.total_pagos+2) else (b.total_pagos+1) end parcconv,
nvl((select count(id_adeudo) from ta_17_adeudos_div where id_conv_resto=b.id_conv_resto and 
clave_pago is null and fecha_venc<today),0) parcVenc,sum(e.importe),
 sum(  CASE
      WHEN ((cp.nvaforma='S') and (b.fecha_inicio>=cp.fecha_inicio)) THEN  e.interes
      WHEN ((a.tipo=17) and (year(b.fecha_inicio)>=2020)) THEN e.interes
      ELSE admin_intereses_22(b.id_conv_resto,b.fecha_inicio,e.pago_parcial,e.cve_parcialidad)
   END),
0, b.fecha_inicio,b.cantidad_total
into v_idresto,v_letras,v_numero,v_axo,v_nombre,v_domicilio,v_convenio,v_tipo,v_subtipo,v_parcconv,v_parcvenc,
v_adeudo,v_intereses,v_recargos,v_fechaconv,v_totconv
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_subtipo_conv d,ta_17_tipos i, ta_17_adeudos_div e, ta_17_catparcnvo cp
where b.vigencia='A' and a.tipo=b.tipo  and a.id_conv_diver=b.id_conv_diver
and a.tipo=d.tipo and a.subtipo=d.subtipo and a.tipo=i.tipo and cp.tipo=a.tipo
and e.id_conv_resto=b.id_conv_resto and e.clave_pago is null and e.fecha_venc<today
group by b.id_conv_resto,a.letras_exp,a.numero_exp,a.axo_exp,b.nombre,6,7,i.descripcion,d.desc_subtipo,10,11
,b.fecha_inicio,b.cantidad_total 
order by a.letras_exp,a.numero_exp,a.axo_exp 


let v_registro='';
foreach
select referencia into v_registro 
from ta_17_referencia where id_conv_resto=v_idresto
end foreach;

foreach
select 
((select min(mes_desde) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today)||'/'||
(select min(axo_desde) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today and 
pago_parcial=(select min(pago_parcial) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today) ) )
||' A '||((select Max(mes_desde) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today)||'/'||
(select max(axo_hasta) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today and 
pago_parcial=(select Max(pago_parcial) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today) ) ),
(select min(pago_parcial) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today)||' A LA '||
(select Max(pago_parcial) from ta_17_adeudos_div where id_conv_resto=a.id_conv_resto and clave_pago is null and fecha_venc<today)
into v_periodo,v_parcvenc from ta_17_adeudos_div a where a.id_conv_resto=v_idresto
and a.clave_pago is null and a.fecha_venc<today
order by  pago_parcial
end foreach;

let v_total=0;
let v_total=v_adeudo+v_intereses+v_recargos;

return v_convenio,v_nombre,v_domicilio,v_subtipo,v_fechaconv,v_totconv,v_periodo,v_parcconv,v_registro,v_parcvenc,
v_adeudo,v_intereses,v_recargos,v_total with resume;
end foreach;
end procedure;

create procedure "pgcabrer".spd_17_liqtotgral(pmod int,pid int,paxo int,pmes int)
returning   varchar(100) as nombre,
            varchar(50) as calle,
            varchar(20) as exterior,
            varchar(20) as interior,
            int as recaudadora,
            int as zona,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst,
            money(16,2) as importe,
            money(16,2) as fvgiros, 
            money(16,2) as anuncios,
            money(16,2) as fvanuncios,
            money(16,2) as impreso,
            money(16,2) as recargos,
            money(16,2) as actualizacion,
            money(16,2) as actualizacion_anun,
            money(16,2) as gastos,
            money(16,2) as multa,
            money(16,2) as total,
            int as status,
            varchar(100) as mensaje;

define v_nombre,v_mensaje varchar(100);
define v_calle,v_colonia varchar(50);
define v_ur,v_vig char(1);
define v_ext,v_int,v_exto,v_into,v_ext1,v_int1,v_cvecat varchar(20);
define v_rec,v_zona,v_axod,v_mesd,v_axoh,v_mesh,v_status,v_cvecuenta,v_cuenta int;
define v_importe,v_importe2,v_anuncios,v_anuncios2,v_impreso,v_recargos,v_gastos,v_multa,v_total,v_actualizacion,v_actualizacion_anun money(16,2);

let v_anuncios=0;
let v_ur='';
let v_colonia='';
let v_vig='';
let v_cuenta=0;
let v_impreso=0;
let v_cvecuenta=0;
let v_mensaje='';
let v_status=0;
let v_nombre='';
let v_calle='';
let v_cvecat='';
let v_ext=0;
let v_int=0;
let v_rec=0;
let v_zona=0;
let v_axod=0;
let v_mesd=0;
let v_axoh=0;
let v_mesh=0;
let v_importe=0;
let v_anuncios=0;
let v_impreso=0;
let v_recargos=0;
let v_gastos=0;
let v_multa=0;
let v_total=0;
let v_importe2=0;
let v_anuncios2=0;
let v_actualizacion=0;
let v_actualizacion_anun=0;

if pmod=5 then
   execute procedure catastro_gdl:convenios_predial_tot(pid,paxo,pmes) into v_cvecuenta,v_nombre,v_cvecat,v_rec,v_ur,v_cuenta,
   v_calle,v_ext,v_int,v_colonia,v_vig,v_axod,v_mesd,v_axoh,v_mesh,v_importe,v_recargos,v_gastos,v_multa,v_total,v_status,v_mensaje,v_actualizacion;
   let v_ext1=substring(v_ext from 1 for locate(v_ext,' '));
   if (v_ext1='') or (v_ext1 is null) then
      let v_ext1=v_ext;
   end if;
   let v_int1=substring(v_int from 1 for locate(v_int,' '));
   if (v_int1='') or (v_int1 is null) then
      let v_int1=v_int;
   end if;
   let v_exto=v_ext;
   let v_into=v_int;
   let v_ext=substr(v_ext,1,(length(trim(v_ext1))));
   let v_int=substr(v_int,1,(length(trim(v_int1))));
   if (v_ext='') or (v_ext>='A') then
      let v_calle=trim(v_calle)||' '||v_exto;
      let v_ext=0;
   end if;
   if (v_int='') or (v_int>='A') then
      let v_calle=trim(v_calle)||' '||v_into;
      let v_int=0;
   end if;
end if;
if pmod=9 then
   execute procedure catastro_gdl:spget_lic_datosconv('L',pid,paxo) into v_nombre,v_calle,v_ext,v_int,v_rec,v_zona,
   v_axod,v_mesd,v_importe,v_importe2,v_anuncios,v_anuncios2,v_impreso,v_recargos,v_actualizacion,v_actualizacion_anun,v_multa,v_gastos,v_total;
   let v_ext1=substring(v_ext from 1 for locate(v_ext,' '));
   if (v_ext1='') or (v_ext1 is null) then
      let v_ext1=v_ext;
   end if;
   let v_int1=substring(v_int from 1 for locate(v_int,' '));
   if (v_int1='') or (v_int1 is null) then
      let v_int1=v_int;
   end if;
   let v_ext=substr(v_ext,1,(length(trim(v_ext1))));
   let v_int=substr(v_int,1,(length(trim(v_int1))));
   if v_ext='' then
      let v_ext=0;
   end if;
   if v_int='' then
      let v_int=0;
   end if;
   let v_axoh=paxo;
   let v_mesh=12;
   if v_total>0 then
      let v_status=0;
      let v_mensaje='';
   else
      let v_status=-1;
      let v_mensaje=v_nombre;
   end if; 
end if;
if pmod=10 then
   execute procedure catastro_gdl:spget_lic_datosconv('A',pid,paxo) into v_nombre,v_calle,v_ext,v_int,v_rec,v_zona,
   v_axod,v_mesd,v_importe,v_importe2,v_anuncios,v_anuncios2,v_impreso,v_recargos,v_actualizacion,v_actualizacion_anun,v_multa,v_gastos,v_total;
   let v_ext1=substring(v_ext from 1 for locate(v_ext,' '));
   if (v_ext1='') or (v_ext1 is null) then
      let v_ext1=v_ext;
   end if;
   let v_int1=substring(v_int from 1 for locate(v_int,' '));
   if (v_int1='') or (v_int1 is null) then
      let v_int1=v_int;
   end if;
   let v_ext=substr(v_ext,1,(length(trim(v_ext1))));
   let v_int=substr(v_int,1,(length(trim(v_int1))));
   if v_ext='' then
      let v_ext=0;
   end if;
   if v_int='' then
      let v_int=0;
   end if;
   let v_axoh=paxo;
   let v_mesh=12;
   if v_total>0 then
      let v_status=0;
      let v_mensaje='';
   else
      let v_status=-1;
      let v_mensaje=v_nombre;
   end if; 
end if;
if pmod=11 then
   execute procedure spd_11_conv_liqtot(pid,paxo,pmes) into v_nombre,v_calle,v_ext,v_int,v_rec,v_zona,
   v_axod,v_mesd,v_axoh,v_mesh,v_importe,v_recargos,v_gastos,v_multa,v_actualizacion,v_total,v_status,v_mensaje;
end if;
if pmod=16 then
   execute procedure sp16_ConvTotales(pid,paxo,pmes) into v_nombre,v_calle,v_ext,v_int,v_rec,v_zona,
   v_axod,v_mesd,v_axoh,v_mesh,v_importe,v_anuncios,v_recargos,v_gastos,v_multa,v_actualizacion,v_total,v_status,v_mensaje;
end if;
if pmod=24 then
   execute procedure dbestacion:sp24_convtotales(pid,paxo,pmes) into v_nombre,v_calle,v_ext,v_int,v_rec,v_zona,
   v_axod,v_mesd,v_axoh,v_mesh,v_importe,v_anuncios,v_recargos,v_gastos,v_multa,v_actualizacion,v_total,v_status,v_mensaje;
end if;
if pmod=28 then
   execute procedure dbestacion:sp28_convtotales(pid,paxo,pmes) into v_nombre,v_calle,v_ext,v_int,v_rec,v_zona,
   v_axod,v_mesd,v_axoh,v_mesh,v_importe,v_anuncios,v_recargos,v_gastos,v_multa,v_actualizacion,v_total,v_status,v_mensaje;
end if;

return trim(v_nombre),trim(v_calle),trim(v_ext),trim(v_int),v_rec,v_zona,v_axod,v_mesd,v_axoh,v_mesh,v_importe,v_importe2,
v_anuncios,v_anuncios2,v_impreso,v_recargos,v_actualizacion,v_actualizacion_anun,v_gastos,v_multa,v_total,v_status,v_mensaje;
end procedure;

create procedure "pgcabrer".spd_17_liqdetgral(pmod int,pid int,paxo int,pmes int)
returning   varchar(30) as concepto,
            int as axo,
            int as mes,
            int as ctaimporte,
            money(16,2) as importe,
            int as ctarecargos,
            money(16,2) as recargos,
            int as ctaactualizacion,
            money(16,2) as actualizacion,
            int as ctamulta,
            money(16,2) as multa;

define v_concepto varchar(30);
define v_axo, v_mes, v_ctaimporte, v_ctarecargos, v_ctaactualizacion, v_ctamulta int;
define v_importe, v_recargos, v_actualizacion, v_multa money(16,2);

let v_ctaactualizacion=0;
let v_actualizacion=0;
let v_ctamulta=0;
let v_multa=0;

if pmod=5 then -- predial
   foreach
   execute procedure catastro_gdl:convenios_predial_detalle(pid,paxo,pmes) into v_concepto,v_axo,v_mes,v_ctaimporte,
                                                            v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa
   return v_concepto,v_axo,v_mes,v_ctaimporte,v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa with resume;
   end foreach;
end if;
if pmod=11 then -- mercados
   foreach
   execute procedure spd_11_conv_liqdet(pid,paxo,pmes) into v_concepto,v_axo,v_mes,v_ctaimporte,
                                                            v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa
   return v_concepto,v_axo,v_mes,v_ctaimporte,v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa with resume;
   end foreach;
end if;
if pmod=16 then -- aseo contratado
   foreach
   execute procedure sp16_ConvDet(pid,paxo,pmes) into v_concepto,v_axo,v_mes,v_ctaimporte,
                                                      v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion
   return v_concepto,v_axo,v_mes,v_ctaimporte,v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,0,0 with resume;
   end foreach;
end if;
if pmod=24 then -- estacionamientos publicos
   foreach
   execute procedure dbestacion:sp24_convdet(pid,paxo,pmes) into v_concepto,v_axo,v_mes,v_ctaimporte,
                                                            v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa
   return v_concepto,v_axo,v_mes,v_ctaimporte,v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa with resume;
   end foreach;
end if;
if pmod=28 then -- estacionamientos exclusivos
   foreach
   execute procedure dbestacion:sp28_convdet(pid,paxo,pmes) into v_concepto,v_axo,v_mes,v_ctaimporte,
                                                            v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa
   return v_concepto,v_axo,v_mes,v_ctaimporte,v_importe,v_ctarecargos,v_recargos,v_ctaactualizacion,v_actualizacion,v_ctamulta,v_multa with resume;
   end foreach;
end if;
end procedure;

create procedure "pgcabrer".spd_17_cuentasapl(pmod int,pid int,pparc int,pidconv int)
returning   int as cuenta,
            varchar(100) as descripcion,
            money(16,2) as importe;

define vcuenta,vctaact,vctarzg,vctaimp,vctarec,vctamul,vctagst,vctafvlic,vctafvanun,vctarecdesc,vctaactualizacion int;
define vctaactanu,vctarzganu,aaxo,ames,vaxod,vmesd,vaxoh,vmesh,actaimporte,actarecargos,aparc,vctaactualizacionanun int;
define dimporte,aimporte,arecargos,gimporte,aacumulado,acalcacumulado,aimpparc,aimpcalc,lactualizacion_anun money(16,2);
define lderechos,lrecargos,lanuncios,lformas,lgastos,lmulta,limporte,lfvlicencias,lfvanuncios,lactualizacion money(16,2);
define vur char(1);
define vdescripcion varchar(100);
define aconcepto varchar(30);

begin
    on exception in (-958)
       delete from tmp_desgloce;
    end exception;
create temp table tmp_desgloce(
  concepto varchar(30),
  axo int,
  mes int,
  cuenta int,
  monto money(14,2)) with no log;
end;

let vcuenta=0;
let vdescripcion='';
let vctaactanu=0;
let vctafvanun=0;
let vctafvlic=0;
let vctaactualizacion=0;

if pmod>0 then
   -- verifica los periodos del adeudo
   select importe,axo_desde,mes_desde,axo_hasta,mes_hasta into gimporte,vaxod,vmesd,vaxoh,vmesh 
   from ta_17_adeudos_div where id_conv_resto=pidconv and pago_parcial=pparc;

   if pmod=3 then -- cuentas multas municipales
      select b.cvectaapl,b.cta_vencido,(select cta_gasto from catastro_gdl:c_ctasxmodulo where id_modulo=6) into vctaact,vctarzg,vctagst 
      from catastro_gdl:multas a,catastro_gdl:c_dependencias b
      where a.id_multa=pid and b.id_dependencia=a.id_dependencia;

      -- obtiene datos de accesorios de convenios
      select nvl(impuesto,0),nvl(gastos,0)
      into lderechos,lgastos
      from ta_17_referencia where id_conv_resto=pidconv;

      if pparc=1 then
         let limporte=gimporte-lgastos;
         insert into tmp_desgloce values('MULTA',0,0,vctaact,limporte);
         insert into tmp_desgloce values('GASTOS',0,0,vctagst,lgastos);
      else
         insert into tmp_desgloce values('MULTA',0,0,vctaact,gimporte);
      end if;

      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta

      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;
      if dimporte>0 then               
         return vcuenta,vdescripcion,dimporte with resume;
      end if;
      end foreach;      
   else
   if pmod=4 then -- licencias de construccion
      -- suma adeudo de las parcialidades anteriores a la actual
      select nvl(sum(importe),0) into aimpparc 
      from ta_17_adeudos_div where id_conv_resto=pidconv and pago_parcial<pparc;

      -- obtiene las cuentas de la table de detalle
      let acalcacumulado=0;
      foreach
       select a.cuenta,a.monto,a.acumulado,b.descripcion into actaimporte, aimporte, aacumulado, aconcepto 
       from ta_17_det_obraspub a, outer cg_12_cuentas b
       where a.id_conv_resto=pidconv and a.monto>0 and b.cta_aplicacion=a.cuenta
       order by a.cuenta

       let acalcacumulado=acalcacumulado+aimporte;
       if aimpparc = 0 then
          select nvl(sum(monto),0) into dimporte from tmp_desgloce;
          if dimporte<>gimporte then 
             if gimporte <= acalcacumulado then
                insert into tmp_desgloce values(aconcepto,pparc,0,actaimporte,gimporte);
             end if;
          end if;
       else
          if aimpparc <= acalcacumulado then
             let acalcacumulado=acalcacumulado-aimpparc;
             select nvl(sum(monto),0) into dimporte from tmp_desgloce;
             if dimporte<>gimporte then
                if gimporte <= acalcacumulado then
                   let acalcacumulado=acalcacumulado-gimporte;
                   insert into tmp_desgloce values(aconcepto,pparc,0,actaimporte,gimporte);
                else
                   let aimpcalc=acalcacumulado;         
                   insert into tmp_desgloce values(aconcepto,pparc,0,actaimporte,acalcacumulado);
                end if;
             end if;
          else
             select nvl(sum(monto),0) into dimporte from tmp_desgloce where axo=pparc;
             if dimporte<>gimporte then
                insert into tmp_desgloce values(aconcepto,pparc,0,actaimporte,aimporte);
             end if;
          end if;
       end if;    
       end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,concepto,nvl(sum(monto),0)  into vcuenta,vdescripcion,dimporte from tmp_desgloce
      group by cuenta,concepto order by cuenta
      if dimporte>0 then               
         return vcuenta,vdescripcion,dimporte with resume;
      end if;
      end foreach;
   else
   if pmod=5 then -- cuentas de predial
      -- verifica los adeudos para separa totales por cuenta de aplicacion
      foreach
      execute procedure catastro_gdl:convenios_predial_detalle(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                     aimporte,actarecargos,arecargos,vctaactualizacion,lactualizacion,vctamul,lmulta
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         if aimporte > 0 then
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         end if;  
         if arecargos > 0 then     
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
         if lmulta > 0 then   
            insert into tmp_desgloce values('MULTA',aaxo,ames,vctamul,lmulta);
         end if;
         if lactualizacion > 0 then
            insert into tmp_desgloce values('ACTUALIZACION',aaxo,ames,vctaactualizacion,lactualizacion);        
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;               
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else   
   if pmod=9 then -- cuentas de licencias
      select nvl(b.ctaaplic,0),nvl(ctaaplic_rez,0),421200002,451041,452041,454041,219000000,459141,459151 
      into vctaact,vctarzg,vctaimp,vctarec,vctamul,vctagst,vctafvlic,vctaactualizacion,vctaactualizacionanun 
      from catastro_gdl:licencias a,catastro_gdl:c_giros b 
      where a.id_licencia=pid and b.id_giro=a.id_giro;
      -- obtiene cuenta de anuncios
      foreach 
      select nvl(b.ctaaplic,0),nvl(ctaaplic_rez,0),nvl(222000000,0) into vctaactanu,vctarzganu,vctafvanun
      from catastro_gdl:anuncios a,catastro_gdl:c_giros b
      where a.id_licencia=pid and b.id_giro=a.id_giro
      end foreach;
      -- obtiene datos de accesorios de convenios
      select first 1 nvl(impuesto,0),nvl(recargos,0),nvl(gastos,0),nvl(multa,0),nvl(anuncio,0),nvl(impreso,0),
       nvl(fvlicencias,0),nvl(fvanuncios,0),nvl(actualizacion,0),nvl(actualizacion_anun,0)
      into lderechos,lrecargos,lgastos,lmulta,lanuncios,lformas,lfvlicencias,lfvanuncios,lactualizacion,lactualizacion_anun
      from ta_17_referencia where id_conv_resto=pidconv;
      if pparc=1 then
         let limporte=gimporte-(lrecargos+lgastos+lmulta+lanuncios+lformas+lfvlicencias+lfvanuncios+lactualizacion);
         insert into tmp_desgloce values('DERECHOS',0,0,vctaact,limporte);
         insert into tmp_desgloce values('FONDO VERDE DERECHOS',0,0,vctafvlic,lfvlicencias);
         insert into tmp_desgloce values('ANUNCIOS',0,0,vctaactanu,lanuncios);
         insert into tmp_desgloce values('FONDO VERDE ANUNCIOS',0,0,vctafvanun,lfvanuncios);
         insert into tmp_desgloce values('RECARGOS',0,0,vctarec,lrecargos);
         insert into tmp_desgloce values('ACTUALIZACION GIRO',0,0,vctaactualizacion,lactualizacion);
         insert into tmp_desgloce values('ACTUALIZACION ANUNCIO',0,0,vctaactualizacionanun,lactualizacion_anun);
         insert into tmp_desgloce values('IMPRESO',0,0,vctaimp,lformas);
         insert into tmp_desgloce values('GASTOS',0,0,vctagst,lgastos);
         insert into tmp_desgloce values('MULTA',0,0,vctamul,lmulta);
      else
         insert into tmp_desgloce values('DERECHOS',0,0,vctaact,gimporte);
      end if;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;
      if dimporte>0 then               
         return vcuenta,vdescripcion,dimporte with resume;
      end if;
      end foreach;
   else
   if pmod=10 then -- cuentas de anuncios  
      select nvl(b.ctaaplic,0),nvl(ctaaplic_rez,0),421200002,451051,452051,454051,222000000,459151 
      into vctaactanu,vctarzganu,vctaimp,vctarec,vctamul,vctagst,vctafvanun,vctaactualizacion 
      from catastro_gdl:anuncios a,catastro_gdl:c_giros b 
      where a.id_anuncio=pid and b.id_giro=a.id_giro;
      -- obtiene datos de accesorios de convenios
      select first 1 nvl(impuesto,0),nvl(recargos,0),nvl(gastos,0),nvl(multa,0),nvl(anuncio,0),nvl(impreso,0),nvl(fvanuncios,0),nvl(actualizacion_anun,0)
      into lderechos,lrecargos,lgastos,lmulta,lanuncios,lformas,lfvanuncios,lactualizacion
      from ta_17_referencia where id_conv_resto=pidconv;
      if pparc=1 then
         let limporte=gimporte-(lrecargos+lgastos+lmulta+lanuncios+lformas+lactualizacion);
         insert into tmp_desgloce values('DERECHOS',0,0,vctaactanu,limporte);
         insert into tmp_desgloce values('FONDO VERDE DERECHOS',0,0,vctafvanun,lfvanuncios);
         insert into tmp_desgloce values('RECARGOS',0,0,vctarec,lrecargos);
         insert into tmp_desgloce values('ACTUALIZACION ANUNCIO',0,0,vctaactualizacion,lactualizacion);
         insert into tmp_desgloce values('IMPRESO',0,0,vctaimp,lformas);
         insert into tmp_desgloce values('GASTOS',0,0,vctagst,lgastos);
         insert into tmp_desgloce values('MULTA',0,0,vctamul,lmulta);
      else
         insert into tmp_desgloce values('DERECHOS',0,0,vctaactanu,gimporte);
      end if;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;
      if dimporte>0 then               
         return vcuenta,vdescripcion,dimporte with resume;
      end if;
      end foreach;
   else 
   if pmod=11 then -- mercados
      -- verifica los adeudos para separa totales por cuenta de aplicacion
      foreach
      execute procedure spd_11_conv_liqdet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos,vctaactualizacion,lactualizacion,vctamul,lmulta
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         if lmulta>0 then     
            insert into tmp_desgloce values('MULTA',aaxo,ames,vctamul,lmulta);
         end if;
         if arecargos>0 then     
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
         if lactualizacion>0 then
            insert into tmp_desgloce values('ACTUALIZACION',aaxo,ames,vctaactualizacion,lactualizacion);
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select a.cuenta,b.descripcion,nvl(sum(a.monto),0) into vcuenta,vdescripcion,dimporte 
       from tmp_desgloce a, outer ta_12_ctas_odoo b
       where b.axo=year(today) and b.interface=13 and b.cta_aplic=a.cuenta
       group by a.cuenta, b.descripcion order by a.cuenta           
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else 
   if pmod=16 then -- aseo contratado
      -- verifica los adeudos para separar totales por cuenta de aplicacion
      foreach
      execute procedure sp16_ConvDet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos,vctaactualizacion,lactualizacion
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         if arecargos>0 then     
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
         if lactualizacion>0 then
            insert into tmp_desgloce values('ACTUALIZACION',aaxo,ames,vctaactualizacion,lactualizacion);
         end if;
      -- verifica los adeudos de la parcialidad y graba a temporal
  /*    if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         if arecargos=0 then     
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         else
            insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if; */
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;               
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else
   if pmod=18 then -- especios abiertos
      select d.cuenta_ingreso,391000000,391040000 into vctaact,vctarec,vctarecdesc
      from ta_17_conv_d_resto a,ta_17_conv_diverso b,ta_17_subtipo_conv d
      where a.id_conv_resto=pidconv and b.id_conv_diver=a.id_conv_diver and b.tipo=a.tipo
      and d.tipo=b.tipo and d.subtipo=b.subtipo;

      -- obtiene datos de accesorios de convenios
      select nvl(impuesto,0),nvl(recargos,0)
      into lderechos,lrecargos
      from ta_17_referencia where id_conv_resto=pidconv;

      if pparc=1 then
         let limporte=gimporte-lrecargos;
         insert into tmp_desgloce values('CUOTA',0,0,vctaact,limporte);
         insert into tmp_desgloce values('RECARGOS',0,0,vctarec,lrecargos);
      else
         insert into tmp_desgloce values('CUOTA',0,0,vctaact,gimporte);
      end if;

      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta

      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;
      if dimporte>0 then               
         return vcuenta,vdescripcion,dimporte with resume;
      end if;
      end foreach;
   else
   if pmod=24 then -- Estacionamientos Publicos
      -- verifica los adeudos para separa totales por cuenta de aplicacion
      foreach
      execute procedure dbestacion:sp24_convdet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos,vctaactualizacion,lactualizacion,vctamul,lmulta
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         if arecargos>0 then     
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
         if lactualizacion>0 then
            insert into tmp_desgloce values('ACTUALIZACION',aaxo,ames,vctaactualizacion,lactualizacion);            
         end if;
         if lmulta>0 then
            insert into tmp_desgloce values('MULTA',aaxo,ames,vctamul,lmulta);            
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from cg_12_cuentas where cta_aplicacion=vcuenta;               
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else
   if pmod=28 then -- Estacionamientos exclusivos
      -- verifica los adeudos para separa totales por cuenta de aplicacion
      foreach
      execute procedure dbestacion:sp28_convdet(pid,vaxoh,vmesh) into aconcepto,aaxo,ames,actaimporte,
                                                                 aimporte,actarecargos,arecargos,vctaactualizacion,lactualizacion,vctamul,lmulta
      -- verifica los adeudos de la parcialidad y graba a temporal
      if ((aaxo>vaxod or (ames>=vmesd and aaxo=vaxod))) then 
         insert into tmp_desgloce values(aconcepto,aaxo,ames,actaimporte,aimporte);
         if arecargos>0 then     
            insert into tmp_desgloce values('RECARGOS',aaxo,ames,actarecargos,arecargos);
         end if;
         if lactualizacion>0 then
            insert into tmp_desgloce values('ACTUALIZACION',aaxo,ames,vctaactualizacion,lactualizacion);            
         end if;
         if lmulta>0 then
            insert into tmp_desgloce values('MULTA',aaxo,ames,vctamul,lmulta);            
         end if;
      end if;
      end foreach;
      -- obtiene el total por cuenta de aplicacion de temporal
      foreach
      select cuenta,nvl(sum(monto),0) into vcuenta,dimporte from tmp_desgloce
      group by cuenta order by cuenta
      -- obtiene la descripcion de la cuenta
      select descripcion into vdescripcion
      from ta_12_ctas_odoo where cta_aplic=vcuenta and axo=year(today);               
      return vcuenta,vdescripcion,dimporte with resume;
      end foreach;
   else 
      return 0,'',0;
   end if; end if; end if; end if; end if; end if; end if; end if; end if; end if;
else
   foreach -- todas la cuentas
   select nvl(cta_aplicacion,0),descripcion into vcuenta,vdescripcion
   from cg_12_cuentas where tipo_pago is null and vigencia<>'B'
   return vcuenta,vdescripcion,0 with resume;
   end foreach;
end if; 

end procedure;

create procedure "pgcabrer".spd_11_generacarteramex(prec int,paxo int)
returning   int as locales,
            int as meses,
            int as existeade,
            int as existepagcan;

define vid,vofi,vmer,vcat,vloc,vaxo,vcvecuo,v_cont int;
define vtotloc,vtotmeses,vtotexia,vtotextpc int;
define vsec char(2);
define vlet,vblq char(1);
define vsuperf decimal(7,2);
define vimpcuo,vade money(18,2);

let vtotloc=0;
let vtotmeses=0;
let vtotexia=0;
let vtotextpc=0;

foreach
  select a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,a.superficie,
  c.axo,c.clave_cuota,c.importe_cuota
  into vid,vofi,vmer,vcat,vsec,vloc,vlet,vblq,vsuperf,vaxo,vcvecuo,vimpcuo
  from ta_11_locales a,ta_11_mercados b,ta_11_cuo_locales c
  where a.oficina=prec and a.vigencia='A' and a.bloqueo<4 and b.tipo_emision<>'B' and a.num_mercado=2
  and a.oficina=b.oficina and a.num_mercado=b.num_mercado_nvo
  and c.axo=paxo and a.categoria=c.categoria and a.seccion=c.seccion and a.clave_cuota=c.clave_cuota
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

  let vtotloc=vtotloc+1;
  -- calcula renta
  let vade=0;
  if vsec='PS' then
     if vcvecuo=4 then
        let vade=vsuperf*vimpcuo;
     else
        if (paxo < 2019) or (paxo >= 2020) then
           let vade=(vimpcuo*vsuperf)*30;
        else
           let vade=vsuperf*vimpcuo;
        end if;
     end if
  else
     let vade=vsuperf*vimpcuo;
  end if;

  -- graba el adeudo mensual
  for v_cont= 1 to 12
      if ((not exists(select * from ta_11_pagos_local where id_local=vid and axo=vaxo and periodo=v_cont)) and
         (not exists(select * from ta_11_ade_loc_canc where id_local=vid and axo=vaxo and periodo=v_cont))) then
         if not exists(select * from ta_11_adeudo_local where id_local=vid and axo=vaxo and periodo=v_cont) then
            insert into ta_11_adeudo_local values(0,vid,vaxo,v_cont,vade,current,18);
            let vtotmeses=vtotmeses+1;
         else
            let vtotexia=vtotexia+1;
         end if
      else 
         let vtotextpc=vtotextpc+1; 
      end if; 
  end for; 
end foreach;

return vtotloc,vtotmeses,vtotexia,vtotextpc;
end procedure;

create procedure "pgcabrer".spd_11_padron_adeudo_total(paxo int,pmes int,ptip char(1))
returning   char(30) as mercado,
            smallint as Rec,
            smallint as Merc,
            char(2) as seccion,
            integer as local,
            char(3) as letra,
            char(2) as bloque,
            varchar(60) as nombre,
            integer as zona,
            decimal(8,2) as superficie,
            money(7,2) as costo_mtr2013,
            char(20) as estado,
            char(20) as periodo,
            MONEY(16,2) as adeudo,
            MONEY(16,2) as recargos,
            MONEY(16,2) as multa,
            MONEY(16,2) as actualizacion,
            MONEY(16,2) as gastos,
            MONEY(16,2) as total,
            integer as ejecutor,
            varchar(60) as nombre_ejecutor;
  
define v_actualizaciontotal, v_actualizacion money(16,2);
define v_recargostotal money(16,2);
define v_multatotal, v_multa, v_descrenta MONEY(16,2); 
define v_gastos MONEY(16,2);
define v_total MONEY(16,2);
define v_requerimientos char(5000);
define v_estado varchar(20);
define v_nombre, v_nom_ejec varchar(60);
define v_periodo varchar(20);
define v_mer, v_msgrenta char(30);          
define v_ofi,v_bloqueo smallint;
define v_nme smallint;          define v_cat SMALLINT;
define v_sec char(2);           define v_loc,v_ejecutor integer;
define v_let char(3);           define v_blq char(2);
define v_est char(1);           define v_idl integer;
define v_axo smallint;          define v_adeudo money(16,2);
define v_ida integer;           define v_emi date;
define v_fol,v_id_control integer;           define v_pra date;
define v_ini char(7);           define v_fin char(7);
define v_ade money(16,2);       define v_zona int;
define v_aid_local integer;     define v_aaxo,v_cvecuo smallint;
define v_aperiodo smallint;     define v_aimporte,v_costomtr money(16,2);
define v_dmes smallint;         define v_fecha_desc date;
define v_fecha_rec date;        define v_porc,v_superf decimal(10,2);
define v_folio smallint;        define v_recargos money(16,2);

let v_adeudo=0;   
let v_recargostotal=0;  
let v_actualizaciontotal=0;
let v_multatotal=0;
let v_multa=0;
let v_gastos=0;
let v_total=0;
let v_requerimientos='';
let v_porc=0;     
let v_folio=0; 
let v_ejecutor=0; 
let v_nom_ejec='';


foreach
  select b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
  a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,a.bloqueo,a.clave_cuota,nvl(sum(d.importe),0)
  into v_mer,v_idl,v_ofi,v_nme,v_cat,v_sec,v_loc,v_let,v_blq,v_nombre,v_zona,v_superf,v_est,v_bloqueo,v_cvecuo,v_adeudo
  from ta_11_locales a,ta_11_mercados b,ta_11_adeudo_local d
  where b.tipo_emision in (ptip,'O') and a.vigencia='A'
  and b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
  and d.id_local=a.id_local and (d.axo<paxo  or (d.periodo<=pmes and d.axo=paxo))
  group by b.descripcion,a.id_local,a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,
  a.bloque,a.nombre,b.id_zona,a.superficie,a.vigencia,bloqueo,a.clave_cuota
  order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque

  if v_est='A' then
     if v_bloqueo=4 then
        let v_estado='VIGENTE-BLOQUEADO';
     else
        let v_estado='VIGENTE';
     end if;
  else
     let v_estado='BAJA';
  end if;

  select importe_cuota into v_costomtr from ta_11_cuo_locales where axo=year(today)
  and categoria=v_cat and seccion=v_sec and clave_cuota=v_cvecuo;

  -- para obtener los datos de gastos
  let v_folio=0;
  select  max(id_control), nvl(count(folio),0), nvl(sum(importe_gastos),0)
  into   v_id_control, v_folio, v_gastos
  from   ta_15_apremios a  
  where  modulo=11 and control_otr=v_idl and vigencia='1' and clave_practicado='P';

  let v_ejecutor=0; 
  let v_nom_ejec='';
  foreach
  select max(a.ejecutor), b.nombre  into v_ejecutor, v_nom_ejec
  from   ta_15_apremios a, ta_15_ejecutores b   
  where  a.id_control=v_id_control and b.cve_eje=a.ejecutor
  group by 2
  end foreach;

  let v_recargostotal=0; 
  let v_multatotal=0; 
  let v_actualizaciontotal=0;
  let v_total=0;

  -- todos los periodos del local
  foreach
    select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
    into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
    from   ta_11_adeudo_local a,ta_11_fecha_desc b 
    where id_local=v_idl and (a.axo<paxo  or (a.periodo<=pmes and a.axo=paxo)) 
    and b.mes=month(today)
    order by axo,periodo

    -- obtiene la actualiacion
    let v_actualizacion=0;
    execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, v_aimporte) into v_actualizacion;
    let v_actualizaciontotal=v_actualizaciontotal+v_actualizacion;

    -- calcula descuento en renta
    let v_descrenta=0;
--    let v_msgrenta='';
--    execute PROCEDURE sp_desctorenta( v_idl, v_aaxo, v_aperiodo, v_aimporte) into v_descrenta, v_msgrenta;

    -- calcula la multa
    let v_multa=0;
    execute procedure spd_11_calc_multa(v_nme, (v_aimporte-v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
    let v_multatotal=v_multatotal+v_multa;

    -- obtiene el porcentaje de recargos
    let v_porc=0;
    let v_recargos=0;
    if today>=v_fecha_rec then
       select sum(porcentaje_mes) into v_porc from ta_12_recargos
       where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
             (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
    else
       select sum(porcentaje_mes) into v_porc from ta_12_recargos
       where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
             (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
    end if;

    if  v_porc is null then
        let v_porc=0;
    end if;

    if  v_folio = 0 then
        if v_porc > 100 then
           let v_recargos=trunc(v_aimporte*100)/100;
        else
           let v_recargos=trunc(v_aimporte*v_porc)/100;
        end if;
    else
        if v_porc > 250 then
           let v_recargos=trunc(v_aimporte*250)/100;
        else
           let v_recargos=trunc(v_aimporte*v_porc)/100;
       end if;
    end if;

    -- acumula recargos por a�o
    let v_recargostotal=v_recargostotal+v_recargos;

    end foreach; -- cierre de los periodos

  -- verifica los periodos de adeudo
  select a.id_local, ( 
  (select min(axo) from ta_11_adeudo_local where id_local=a.id_local 
  and (axo<paxo  or (periodo<=pmes and axo=paxo)))||'-'||
  (select min(periodo) from ta_11_adeudo_local where id_local=a.id_local 
  and (axo<paxo  or (periodo<=pmes and axo=paxo)) and axo=
   (select min(axo) from ta_11_adeudo_local where id_local=a.id_local 
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) ) ),
  ( 
  (select max(axo) from ta_11_adeudo_local where id_local=a.id_local 
  and (axo<paxo  or (periodo<=pmes and axo=paxo)))||'-'||
  (select max(periodo) from ta_11_adeudo_local where id_local=a.id_local 
  and (axo<paxo  or (periodo<=pmes and axo=paxo)) and axo=
   (select max(axo) from ta_11_adeudo_local where id_local=a.id_local 
  and (axo<paxo  or (periodo<=pmes and axo=paxo))) ) )
  into v_ida,v_ini,v_fin
  from   ta_11_adeudo_local a   
  where  a.id_local=v_idl 
  group by a.id_local;

  let v_periodo=trim(v_ini)||' al '||trim(v_fin);

  let v_total=v_adeudo+v_recargostotal+v_actualizaciontotal+v_multatotal+v_gastos;

  return trim(v_mer),v_ofi,v_nme,trim(v_sec),v_loc,trim(v_let),trim(v_blq),trim(v_nombre),v_zona,v_superf,v_costomtr,
  trim(v_estado),trim(v_periodo),v_adeudo,v_recargostotal,v_multatotal,v_actualizaciontotal,v_gastos,v_total, v_ejecutor, v_nom_ejec with resume;
end foreach; -- cierre del principal

end procedure;

create function "pgcabrer".fn_getmuldescmerc(fid int,faxo int,fmes int)
returning money(16,2) as descmulta;

define v_descuento, v_multa, v_multatotal, v_aimporte, v_descrenta  money(16,2);
define v_folio, v_aid_local, v_aaxo, v_aperiodo, v_dmes, v_merc, v_desc, v_primermes int;
define v_fecha_desc, v_fecha_rec date;
define v_msgrenta varchar(30);

select num_mercado, nvl(id_contribuy_renta,0) into v_merc, v_desc
from ta_11_locales where id_local=fid;

let v_multatotal=0; 
let v_descuento=0; 

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=fid and (axo<faxo  or (periodo<=fmes and axo=faxo)) and b.mes=month(today)
order by axo,periodo

if v_merc =214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
else
   -- calcula descuento en renta 
   let v_descrenta=0;
   let v_msgrenta='';
   execute PROCEDURE sp_desctorenta( v_aid_local, v_aaxo, v_aperiodo, v_aimporte) into v_descrenta, v_msgrenta;
end if;

-- calcula la multa
let v_multa=0;
execute procedure spd_11_calc_multa(v_merc, (v_aimporte-v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;

-- acumula multa por a�o
let v_multatotal=v_multatotal+v_multa;

end foreach; -- cierre de los periodos

return v_multatotal;
end function;

CREATE FUNCTION "informix".kio13_total(var_control INTEGER, var_axo INT)
RETURNING 
    CHAR(1) AS slinea, 
    INT AS sclave, 
    MONEY(15,2) AS stotal, 
    INT AS sctaapli, 
    VARCHAR(60) AS sobserv;

DEFINE v_uap INTEGER;
DEFINE v_control INTEGER;
DEFINE v_axo INTEGER;
DEFINE v_mes SMALLINT;
DEFINE vpar_axo INTEGER;
DEFINE vpar_impte MONEY(15,2);
DEFINE vpar_recar MONEY(15,2);
DEFINE v_axo_alta INTEGER;
DEFINE v_descuento INTEGER; 
DEFINE v_impdesc MONEY(15,2);
DEFINE v_recardesc MONEY(15,2);
DEFINE v_desctot MONEY(15,2);
DEFINE v_desctotre MONEY(15,2);
DEFINE var_cem CHAR(1);
DEFINE v_porc_global DECIMAL(5,3);
DEFINE v_cementerio CHAR(1);
DEFINE v_axo_pagado INTEGER;
DEFINE v_observaciones VARCHAR(60);
DEFINE v_tipo CHAR(1);
DEFINE v_clave INT;
DEFINE v_texto VARCHAR(100);
DEFINE v_concepto VARCHAR(250);
DEFINE v_nomcem VARCHAR(60);
DEFINE v_imptot MONEY(15,2);
DEFINE v_periodo VARCHAR(30);
DEFINE v_axodesde INTEGER;
DEFINE v_obs VARCHAR(60);
DEFINE v_ctaapl1 INT;
DEFINE v_ctaapl2 INT;
DEFINE v_totim MONEY(15,2);
DEFINE v_totre MONEY(15,2);
DEFINE v_totimac MONEY(15,2);
DEFINE v_totreac MONEY(15,2);
DEFINE v_cuenta INTEGER;
DEFINE v_ctaapli INTEGER;
DEFINE v_ctaapla INTEGER;
DEFINE v_ctaaplr INTEGER;
DEFINE v_ctadescto INTEGER;
DEFINE v_ajuste MONEY(15,2);
DEFINE v_ctaapl_act MONEY(15,2);
DEFINE v_lError     INT;
DEFINE v_lISAMError INT;
DEFINE v_vcMensaje  VARCHAR(255);
DEFINE v_actualizacion  MONEY(15,2);
DEFINE v_actualizaciontot  MONEY(15,2);
DEFINE v_id_descuento_regargo INT; -- ID del descuento en recargo automatico

--LET var_axo = 2019;
LET v_axo = YEAR(TODAY);
LET v_mes = MONTH(TODAY);
--LET v_mes = 2;
LET v_imptot = 0;
LET v_concepto = '';
LET v_periodo = '';
LET v_desctot = 0;
LET v_desctotre = 0;
LET v_totim = 0;
LET v_totre = 0;
LET v_totimac = 0;
LET v_totreac = 0;
LET v_actualizacion = 0;
LET v_actualizaciontot = 0;

--set debug file to 'kio13tot.log';
--trace on;

IF var_axo = 0 THEN
    LET var_axo = YEAR(TODAY);
END IF;

SELECT control_rcm, cementerio, axo_pagado
    INTO v_control, v_cementerio, v_axo_pagado
FROM ta_13_datosrcm WHERE control_rcm = var_control;

SELECT nombre, cta_aplicacion, cta_vencido, cta_descto, cta_actualizacion
    INTO v_nomcem, v_ctaapl1, v_ctaapl2, v_ctadescto, v_ctaapl_act
FROM tc_13_cementerios WHERE cementerio = v_cementerio;

IF NOT EXISTS(SELECT * FROM ta_13_datosrcm WHERE control_rcm = v_control) THEN
   LET v_clave = -1; 
   LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   RETURN 'E', v_clave, 0, 0, v_texto; 
END IF;  

IF v_axo_pagado = v_axo THEN
   LET v_clave = -2; 
   LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   RETURN 'E', v_clave, 0, 0, v_texto; 
END IF;     

/*IF (v_axo_pagado + 1) < (v_axo - 5) THEN
   LET v_axodesde = v_axo - 5;
ELSE
   LET v_axodesde = v_axo_pagado + 1;
END IF;*/

IF NOT EXISTS(SELECT * FROM tmp_cem_norecgos WHERE control_rcm = var_control) THEN
    -- IF (v_axo_pagado + 1) < (v_axo - 5) THEN
        -- LET v_axodesde = v_axo - 5;
    -- ELSE
        LET v_axodesde = v_axo_pagado + 1; --anterior
        -- LET v_axodesde = 1990 + 1;
    -- END IF;
ELSE
    LET v_axodesde = v_axo_pagado + 1;
    -- LET v_axodesde = 1990 + 1;
END IF;

LET v_clave = 0; 

-- Descuento de recargos solamente si el a�o a pagar (el ultimo parametro) es el a�o actual, ya que el descuento es cuando se paga en su totalidad
IF (TODAY >= MDY(11,18,2022)) AND (TODAY <= MDY(11,21,2022)) OR 
    (TODAY >= MDY(11,13,2023)) AND (TODAY <= MDY(11,24,2023)) THEN -- (!) Cambiar las fechas
    EXECUTE PROCEDURE catastro_gdl:ins_recarcem(v_control, v_axodesde, var_axo, 'auto75', 75, 4) INTO v_id_descuento_regargo;
    IF var_axo = YEAR(TODAY) THEN
        EXECUTE PROCEDURE catastro_gdl:ins_recarcem(v_control, v_axodesde, var_axo, 'auto75', 75, 1) INTO v_id_descuento_regargo;
    END IF;
END IF;

---Para calcular el importe total
FOREACH 
SELECT b.axo_adeudo, case when b.axo_adeudo = YEAR(TODAY) THEN v_ctaapl1 ELSE v_ctaapl2 END, 
    NVL(b.importe,0), NVL(b.importe_recargos,0), NVL(b.descto_impote,0), NVL(b.descto_recargos,0), NVL(b.actualizacion,0)
        INTO vpar_axo, v_cuenta, vpar_impte, vpar_recar, v_impdesc, v_recardesc, v_actualizacion
    FROM ta_13_adeudosrcm b, ta_13_datosrcm r 
    WHERE r.control_rcm = v_control AND b.control_rcm = r.control_rcm 
        AND b.axo_adeudo BETWEEN v_axodesde AND var_axo
    ORDER BY 1

     IF ( ((v_mes >= 1)  AND (v_mes <=2) AND (v_cuenta=v_ctaapl1)) ) OR 
        (EXISTS(SELECT control_rcm FROM ta_13_dpp WHERE control_rcm = v_control AND vigente = 'V' AND axo_adeudo = vpar_axo)) THEN
        IF v_impdesc = 0 THEN
           LET vpar_impte = vpar_impte - TRUNC(((vpar_impte) * 0.1), 2);
        END IF;
     END IF;
     
     IF vpar_axo < v_axo THEN
        LET v_totim = (v_totim + vpar_impte); 
        LET v_totre = (v_totre + vpar_recar); 
        LET v_desctot = (v_desctot + v_impdesc); 
        LET v_desctotre = (v_desctotre + v_recardesc); 
        LET v_actualizaciontot = v_actualizaciontot + v_actualizacion;
        LET v_ctaapli=v_cuenta;
     ELSE   
        LET v_totimac = (v_totimac + vpar_impte); 
        LET v_totreac = (v_totreac + vpar_recar); 
        LET v_desctot = (v_desctot + v_impdesc); 
        LET v_desctotre = (v_desctotre + v_recardesc); 
        LET v_actualizaciontot = v_actualizaciontot + v_actualizacion;
        LET v_ctaapla=v_cuenta;
     END IF;

    IF vpar_axo = var_axo THEN

        IF v_totimac > 0 THEN
           LET v_obs = 'MANTENIMIENTO ';
           LET v_imptot = v_imptot + v_totimac; 
           RETURN 'D', v_clave, vpar_impte, v_ctaapla, v_obs WITH RESUME;    
        END IF;

        IF v_totim > 0 THEN
            LET v_obs = 'MANTENIMIENTO REZAGO ';
            LET v_imptot = v_imptot + v_totim;
            RETURN 'D', v_clave, v_totim, v_ctaapli, v_obs WITH RESUME; 
        END IF;   

        IF v_totre > 0 THEN
           LET v_ctaaplr = 390300000; -- (?)
           LET v_obs = 'RECARGOS REZAGO ';
           LET v_imptot = v_imptot + v_totre; 
           RETURN 'D', v_clave, v_totre,v_ctaaplr, v_obs WITH RESUME; 
        END IF;   

        IF v_totreac > 0 THEN
            LET v_ctaaplr = 390300000;
            LET v_obs = 'RECARGOS ';
            LET v_imptot = v_imptot + v_totreac; 
            RETURN 'D', v_clave, v_totreac, v_ctaaplr, v_obs WITH RESUME; 
        END IF; 
        
        IF v_desctot > 0 THEN
            LET v_ctaaplr = v_ctadescto;
            LET v_obs = 'DESCTO MANT. ';
            LET v_imptot = v_imptot - v_desctot; 
            RETURN 'D', v_clave, (v_desctot*-1), v_ctaaplr, v_obs WITH RESUME; 
        END IF; 

        IF v_desctotre > 0 THEN
            LET v_ctaaplr = v_ctadescto;
            LET v_obs = 'DESCTO RECARGOS ';
            LET v_imptot = v_imptot - v_desctotre; 
            RETURN 'D', v_clave, (v_desctotre*-1), v_ctaaplr, v_obs WITH RESUME; 
        END IF; 

        IF v_actualizaciontot > 0 THEN
            LET v_obs = 'ACTUALIZACION ';
            LET v_imptot = v_imptot + v_actualizaciontot; 
            RETURN 'D', v_clave, v_actualizaciontot, v_ctaapl_act, v_obs WITH RESUME; 
        END IF;
    END IF; 
END FOREACH;

EXECUTE PROCEDURE spd_redondeokiosco(v_imptot) INTO v_ctaaplr, v_ajuste;
IF v_ajuste <> 0 THEN    
    RETURN 'D', v_clave, v_ajuste, v_ctaaplr, 'AJUSTE ARTICULO 14 LEY DE INGRESOS ' WITH RESUME; 
    LET v_imptot = v_imptot + v_ajuste; 
END IF;
RETURN 'T', v_clave, v_imptot, 000000000, 'TOTAL '; 

--trace off;

END function;

create function "pgcabrer".fn_getrecdescmerc(fid int,faxo int,fmes int)
returning money(16,2) as RECARGOS;

define v_recargos,v_multa,v_gastos,v_recargostotal,v_aimporte money(16,2);
define v_folio,v_aid_local,v_aaxo,v_aperiodo,v_dmes,v_merc,v_desc,v_primermes int;
define v_porc decimal(7,2);
define v_fecha_desc,v_fecha_rec date;

select num_mercado,nvl(id_contribuy_renta,0) into v_merc,v_desc
from ta_11_locales where id_local=fid;

-- para obtener los datos de multa y gastos
let v_folio=0;
select nvl(count(folio),0),nvl(max(importe_multa),0),nvl(sum(importe_gastos),0)
 into v_folio,v_multa,v_gastos
from   ta_15_apremios a  
where  modulo=11 and control_otr=fid and vigencia='1' and clave_practicado='P';

let v_recargostotal=0;  

-- todos los periodos del local
foreach
select a.id_local,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aid_local,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_local a,ta_11_fecha_desc b 
where id_local=fid and (axo<faxo  or (periodo<=fmes and axo=faxo)) 
and b.mes=month(today)
order by axo,periodo
if v_merc =214 then
   let v_aimporte=(v_aimporte*(100-v_desc))/100;
end if;

-- obtiene el porcentaje de recargos
let v_porc=0;
let v_recargos=0;
if v_merc <>214 then
   if today>=v_fecha_rec then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_aperiodo  and axo =v_aaxo)) and
            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   end if;
else 
   if v_aperiodo=1 then let v_primermes=1;
   else if v_aperiodo=2 then let v_primermes=4;
   else if v_aperiodo=3 then let v_primermes=7;
   else if v_aperiodo=4 then let v_primermes=10;
   else let v_primermes=0;
   end if;
   end if;
   end if;
   end if;

   if v_primermes=month(today) then
      if today>=v_fecha_rec then
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                  (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
      else
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
                 (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
      end if;
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>v_aaxo  or (mes>=v_primermes  and axo =v_aaxo)) and
              (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
    end if;
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  v_folio = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(v_aimporte*100)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(v_aimporte*250)/100;
    else
       let v_recargos=trunc(v_aimporte*v_porc)/100;
    end if;
end if;

-- acumula recargos por a�o
let v_recargostotal=v_recargostotal+v_recargos;

end foreach; -- cierre de los periodos

return v_recargostotal;
end function;

CREATE PROCEDURE "pgcabrer".ins34_gen_contrato ( par_tabla Char(1), par_control Char(10), par_conces Char(200), par_ubica Char (200), 
                                                                   par_sup Money(7,2), par_Axo_Ini Smallint, par_Mes_Ini Smallint, par_ofna Integer, par_sector Char(1), par_zona Integer, 
                                                                   par_lic Integer, par_Descrip Char(100), par_NomCom Char(200), par_Lugar Char(200), par_Obs Char(200), par_usuario char(10) )
{######################################################################
#  Procedimiento:    ins34_gen_contrato
#  Descripcion:      Interfaz de ALTA a registro de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		     	par_control = dato de control del registro
#		     	par_conces = concesionario
#                    		par_ubica = ubicacion
#                    		par_sup = superficie
#                    		par_Axo_Ini = a�o de inicio de obligacion
#                    		par_Mes_Ini = mes de inicio de obligacion
#                    		par_ofna = recaudadora de control
#                    		par_sector = sector de control
#                    		par_zona = zona de control
#                    		par_lic = licencia del giro
#                    		par_Descrip = descripcion de la unidad a calculo para adeudos
#                    		par_NomCom = nombre comercial
#                    		par_Lugar = lugar
#                    		par_Obs = observaciones
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;


-----------Define las variables de retorno----------------
define v_estatus 	int;
define v_leyenda    	varchar(255);
               
define vf_estatus 	int;
define vf_leyenda    	varchar(255);
define v1_estatus 	int;
define v1_leyenda    	varchar(255);
define v2_estatus 	int;
define v2_leyenda    	varchar(255);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

--
define v_id_34_datos, v_id_34_stat_tab, v_id_34_unidad		int;
define v_id_34_stat_concep, v_id_34_stat_adic			int;
define v_tipo_var						Char(1);
define axo_actual						Int;

--

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'Error en transaccion ins34_gen_contrato ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

Let v_estatus	= 0;
Let v_leyenda    	= 'No se creo el ARRENDAMIENTO/DERECHO, comunicate con el Administrador del sistema';

Let vf_estatus	= 0;
Let vf_leyenda    	= 'NO SE CREO EL REGISTRO DE LA FORMA';

Let v1_estatus 	= 0;
Let v1_leyenda    	= 'NO CREARON LOS ADEUDOS, REVISAR';
Let v2_estatus 	= 0;
Let v2_leyenda    	= 'NO CREARON LOS ADEUDOS, REVISAR';

Let v_id_34_datos 		= 0;
Let v_id_34_stat_tab 	= 0;
Let v_id_34_unidad		= 0;
Let v_id_34_stat_concep	= 0;
Let v_id_34_stat_adic	= 0;
Let v_tipo_var 		= '';
Let axo_actual 		= Year(Current);

if par_Axo_Ini > axo_actual then
	Let v_leyenda = 'El A�o de Inicio no puede ser Mayor al A�o Actual';
	Let v_estatus = -1;
else
	if par_Axo_Ini = axo_actual - 5 then
		Let v_leyenda = 'El A�o de Inicio no puede ser Menor 5 a�os que el A�o Actual';
		Let v_estatus = -1;
	else
		if exists(Select * from t34_datos Where cve_tab = par_tabla and control = par_control) then
			Let v_leyenda = 'No se puede dar de alta el ARRENDAMIENTO/DERECHO, pues ya existe';
         			Let v_estatus  = -1;
		else
			-- obtiene el id de status para dar de alta el registro de ARRENDAMIENTO/DERECHO
			SELECT id_34_stat INTO v_id_34_stat_tab from t34_status where cve_tab = par_tabla and cve_stat = 'V' ;

			-- obtiene el id de la unidad que tendra el registro de ARRENDAMIENTO/DERECHO
			SELECT id_34_unidad INTO v_id_34_unidad FROM t34_unidades Where ejercicio = par_Axo_Ini And descripcion = par_Descrip and cve_unidad = 'T';

			-- graba el registro de ARRENDAMIENTO/DERECHO
                               		INSERT INTO t34_datos VALUES (0, par_tabla, par_control, par_conces, par_ubica, par_sup, mdy(par_Mes_Ini, 01, par_Axo_Ini), null, 
                                                      			par_ofna, par_sector, par_zona, par_lic, par_usuario, today, null, v_id_34_unidad, v_id_34_stat_tab);
                               		LET v_id_34_datos = dbinfo("sqlca.sqlerrd1");

			if v_id_34_datos > 0 then
				select id_34_stat into v_id_34_stat_concep from t34_status where cve_tab = 'D' and cve_stat = 'V';

				if par_NomCom <> '' then  -- graba NOMBRE DEL GIRO COMERCIAL
					INSERT INTO t34_conceptos VALUES (0, v_id_34_datos, 'N', par_NomCom, par_usuario, v_id_34_stat_concep);
				end if;
				if par_Lugar <> '' then  -- graba UBICACION DEL GIRO
					INSERT INTO t34_conceptos VALUES (0, v_id_34_datos, 'L', par_Lugar, par_usuario, v_id_34_stat_concep);
				end if;
				if par_Obs <> '' then  -- graba OBSERVACIONES
					INSERT INTO t34_conceptos VALUES (0, v_id_34_datos, 'O', par_Obs, par_usuario, v_id_34_stat_concep);
				end if;

				if par_tabla = '3' then  -- graba ('1'=CATEGORIA, 'SS'=SECCION, Null=BLOQUE) SOLO PARA RASTRO
					-- obtiene el id de status para dar de alta el dato adicional
					SELECT id_34_stat INTO v_id_34_stat_adic FROM t34_status WHERE cve_tab = 'C' AND cve_stat = 'V';
					INSERT INTO t34_adicionales VALUES (0, v_id_34_datos, '1', 'SS', Null, par_usuario, v_id_34_stat_adic);
				end if;

				-- GENERACION DE EL ADEUDO POR LA FORMA
				EXECUTE PROCEDURE ins34_gen_forma ( par_tabla, v_id_34_datos, par_Axo_Ini, par_Mes_Ini, par_usuario ) INTO vf_estatus, vf_leyenda;

				-- INICIO DEL RESTO
				if par_Axo_Ini = axo_actual then
					-- REGISTRAR ADEUDOS DEL EJERCICIO ACTUAL
					if par_tabla = '5' then  
						Let v_tipo_var = 'A';
					else
						Let v_tipo_var = 'T';
					end if;
					EXECUTE PROCEDURE ins34_gen_adeudos 
					( par_tabla, v_id_34_datos, par_sup, par_Axo_Ini, par_Mes_Ini, par_Descrip, v_tipo_var, par_usuario ) 
					INTO v1_estatus, v1_leyenda;
					if v1_estatus = 1 then
						Let v_leyenda    	= v1_leyenda;
						Let v_estatus	= v1_estatus;
					else
						Let v_leyenda    	= v1_leyenda;
						Let v_estatus	= v1_estatus;
					end if;
				end if;

				if par_Axo_Ini < axo_actual then
					-- REGISTRAR ADEUDOS DEL EJERCICIO ANTERIOR
					if par_tabla = '5' then  
						Let v_tipo_var = 'A';
					else
						Let v_tipo_var = 'T';
					end if;
					EXECUTE PROCEDURE ins34_gen_adeudos 
					( par_tabla, v_id_34_datos, par_sup, par_Axo_Ini, par_Mes_Ini, par_Descrip, v_tipo_var, par_usuario ) 
					INTO v1_estatus, v1_leyenda;
					if v1_estatus = 1 then
						-- REGISTRAR ADEUDOS DEL EJERCICIO ACTUAL
						EXECUTE PROCEDURE ins34_gen_adeudos 
						( par_tabla, v_id_34_datos, par_sup, axo_actual, 01, par_Descrip, 'T', par_usuario ) 
						INTO v2_estatus, v2_leyenda;
						if v2_estatus = 1 then
							Let v_leyenda    	= v2_leyenda;
							Let v_estatus	= v2_estatus;
						else
							Let v_leyenda    	= v2_leyenda;
							Let v_estatus	= v2_estatus;
						end if;
					else
						Let v_leyenda    	= v1_leyenda;
						Let v_estatus	= v1_estatus;
					end if;
				end if;
				-- FIN DEL RESTO

			else
         				Let v_leyenda = 'No se creo el ARRENDAMIENTO/DERECHO, comunicate con el Administrador del sistema';
         				Let v_estatus  = -1;

			end if;
		end if;	
	end if;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

create procedure "pgcabrer".arregla_convenio_manual(pid_conv int)
returning int as status;

define vestatus, v_id_usuario int;
define v_parcial, v_axodsd, v_mesdsd, v_axohst, meshst, v_tipo int;
define v_importe, v_interes, v_pago_total money(16,2);
define v_vencimiento, v_inicio date;
define v_cveparc, v_nvaforma char(1);

select id_usuario into v_id_usuario from ta_17_conv_d_resto where id_conv_resto=pid_conv;
let vestatus=0;
foreach
  execute procedure spd_17_desgloce2021(pid_conv) 
    into v_parcial,v_importe,v_interes,v_pago_total,v_vencimiento,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst
  if  v_parcial>1 then
      insert into ta_17_adeudos_div values(0,pid_conv,v_parcial,v_pago_total,v_importe,v_interes,v_vencimiento,
        v_id_usuario,current,null,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst,v_importe,0);
        let vestatus=vestatus+1;
  end if;
end foreach;
return vestatus;
end procedure;

CREATE FUNCTION "informix".spd_17_desgloce(pid int)
returning   int as parcial,
            money(16,2) as importe,
            date as vencimiento,
            char(1) as cveparcial,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst;

define v_parcial,v_axodsd,v_mesdsd,v_axohst,meshst,v_idlocal,v_ctaimp,v_ctarec,v_ctaact,v_ctamul int;
define v_pagos,v_mod,v_axodet,v_mesdet,v_cont,v_reg,v_linea,v_diac int; 
define v_apdsd,v_mpdsd,v_aphst,v_mphst,v_totlin,v_totreg,v_mes,v_dia,v_axo int; 
define v_imprte,v_inicial,v_impdet,v_recdet,v_saldo,v_impparc,v_actdet,v_muldet money(16,2);
define v_vencimiento,v_inicio,v_mensual date;
define v_cveparc,v_tipo_pago char(1);
define v_concdet varchar(30);

begin
    on exception in (-958)
       delete from tmp_detalle;
    end exception;
create temp table tmp_detalle(
  registro int,
  concepto varchar(30),
  axo int,
  mes int,
  ctaimp int,
  renta money(14,2),
  ctarec int,
  recargos money(14,2),
  ctaact int,
  actualizacion money(14,2), 
  ctamul int,
  multa money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_saldo=0;
let v_reg=0;
let v_vencimiento=null;
let v_mensual=null;
let v_totlin=0;
let v_totreg=0;
let v_linea=0;
let v_apdsd=0;
let v_mpdsd=0;
let v_aphst=0;
let v_mphst=0;
let v_linea=0;
let v_diac=0;

if not exists(select * from ta_17_conv_d_resto where id_conv_resto=pid) then 
   return 0,0,null,'',0,0,0,0;
end if;

select nvl(a.cantidad_inicio,0),nvl(a.total_pagos,0),a.fecha_inicio,nvl(b.modulo,0),nvl(b.id_referencia,0),nvl(b.axo_desde,0),
 nvl(b.mes_desde,0),nvl(b.axo_hasta,0),nvl(b.mes_hasta,0),a.tipo_pago 
into v_inicial,v_pagos,v_inicio,v_mod,v_idlocal,v_axodsd,v_mesdsd,v_axohst,meshst,v_tipo_pago
from ta_17_conv_d_resto a,ta_17_referencia b where a.id_conv_resto=pid
and b.id_conv_resto=a.id_conv_resto;

if v_mod=5 then --predial
   foreach
   execute procedure catastro_gdl:convenios_predial_detalle(v_idlocal,v_axohst,meshst) 
   into v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet
   if v_muldet is null then
      let v_muldet=0;
   end if; 
   let v_saldo=v_saldo+v_impdet+v_recdet+v_actdet+v_muldet;
   let v_reg=v_reg+1;
   insert into tmp_detalle values(v_reg,v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet,v_saldo);
   end foreach;
end if;
if v_mod=11 then -- mercados
   foreach
   execute procedure spd_11_conv_liqdet(v_idlocal,v_axohst,meshst) 
   into v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet
   let v_saldo=v_saldo+v_impdet+v_recdet+v_actdet+v_muldet;
   let v_reg=v_reg+1;
   insert into tmp_detalle values(v_reg,v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet,v_saldo);
   end foreach;
end if;
if v_mod=16 then -- aseo contratado
   foreach
   execute procedure sp16_ConvDet(v_idlocal,v_axohst,meshst) 
   into v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet
   let v_saldo=v_saldo+v_impdet+v_recdet+v_actdet;
   let v_reg=v_reg+1;
   insert into tmp_detalle values(v_reg,v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,0,0,v_saldo);
   end foreach;
end if;
if v_mod=24 then -- Estacionamientos Publicos
   foreach
   execute procedure dbestacion:sp24_convdet(v_idlocal,v_axohst,meshst) 
   into v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet
   let v_saldo=v_saldo+v_impdet+v_recdet+v_actdet+v_muldet; -- Se agrega la multa en el acumulado
   let v_reg=v_reg+1;
   insert into tmp_detalle values(v_reg,v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet,v_saldo);
   end foreach;
end if;
if v_mod=28 then -- Estacionamientos exclusivos
   foreach
   execute procedure dbestacion:sp28_convdet(v_idlocal,v_axohst,meshst) 
   into v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet
   let v_saldo=v_saldo+v_impdet+v_recdet+v_actdet+v_muldet;
   let v_reg=v_reg+1;
   insert into tmp_detalle values(v_reg,v_concdet,v_axodet,v_mesdet,v_ctaimp,v_impdet,v_ctarec,v_recdet,v_ctaact,v_actdet,v_ctamul,v_muldet,v_saldo);
   end foreach;
end if;

-- sacar el pago inicial
select nvl(registro,0),nvl(acumulado,0), 
(select nvl(min(axo),0) from tmp_detalle where acumulado<=v_inicial),
(select nvl(min(mes),0) from tmp_detalle where acumulado<=v_inicial and axo=
(select nvl(min(axo),0) from tmp_detalle where acumulado<=v_inicial) ) ,
(select nvl(Max(axo),0) from tmp_detalle where acumulado<=v_inicial),
(select nvl(max(mes),0) from tmp_detalle where acumulado<=v_inicial and axo=
(select nvl(Max(axo),0) from tmp_detalle where acumulado<=v_inicial) ) 
into v_linea,v_impparc,v_apdsd,v_mpdsd,v_aphst,v_mphst
from tmp_detalle where acumulado=v_inicial;
let v_vencimiento=v_inicio;
let v_mensual=v_inicio;
if v_apdsd is null then
   let v_apdsd=0;
end if;
if v_mpdsd is null then
   let v_mpdsd=0;
end if;
if v_aphst is null then
   let v_aphst=0;
end if;
if v_mphst is null then
   let v_mphst=0;
end if;
return 1,v_inicial,v_vencimiento,'I',v_apdsd,v_mpdsd,v_aphst,v_mphst with resume;
if v_linea is null then
   let v_linea=0;
end if;

-- sacar las parcialidades
select nvl(count(*),0),nvl(ROUND((count(*)/v_pagos)),0) into v_totreg,v_totlin
from tmp_detalle where registro>v_linea;

for v_cont=1 to v_pagos
   if v_cont=v_pagos then
      select nvl(count(*),0) into v_totlin
      from tmp_detalle where registro>v_linea;
   end if; 
   select nvl(max(registro),0),nvl(sum(renta+recargos+actualizacion+multa),0), 
   (select nvl(min(axo),0) from tmp_detalle where registro between (v_linea+1) and (v_linea+v_totlin)),
   (select nvl(min(mes),0) from tmp_detalle where registro between (v_linea+1) and (v_linea+v_totlin) and axo=
   (select nvl(min(axo),0) from tmp_detalle where registro between (v_linea+1) and (v_linea+v_totlin)) ) ,
   (select nvl(Max(axo),0) from tmp_detalle where registro between (v_linea+1) and (v_linea+v_totlin)),
   (select nvl(max(mes),0) from tmp_detalle where registro between (v_linea+1) and (v_linea+v_totlin) and axo=
   (select nvl(Max(axo),0) from tmp_detalle where registro between (v_linea+1) and (v_linea+v_totlin)) )
   into v_linea,v_impparc,v_apdsd,v_mpdsd,v_aphst,v_mphst
   from tmp_detalle where registro between (v_linea+1) and (v_linea+v_totlin);
   let v_diac=day(v_inicio);
   if v_diac = 31 then
      if  (month(v_mensual) = 4 or month(v_mensual) =6 or month(v_mensual) =9 or month(v_mensual) =11) then   
          let v_diac=30;
      else
          if month(v_mensual) = 2 then  
             let v_diac = 28;
          end if;
      end if;
   end if;
   if v_diac = 30 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   if v_diac = 29 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   execute function fn_17_calc_venc(mdy(month(v_mensual),v_diac,year(v_mensual)),v_tipo_pago) 
                    into v_vencimiento,v_mensual;
--   execute function fn_17_calc_venc(mdy(month(v_mensual),day(v_inicio),year(v_mensual)),v_tipo_pago) 
--                    into v_vencimiento,v_mensual;
--   execute function fn_17_calc_venc(mdy(month(v_vencimiento),day(v_inicio),year(v_vencimiento)),v_tipo_pago) 
--                    into v_vencimiento;
   return v_cont+1,v_impparc,v_vencimiento,'P',v_apdsd,v_mpdsd,v_aphst,v_mphst with resume;
end for;

end function;

CREATE FUNCTION "pgcabrer".admin_encabezados_13(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10))

-- Se bloquea mercado 95 plaza guadalajara para no cobrar pet. pot correo 19/07/2022
returning   varchar(92) as Nombrecompleto,
            varchar(80) as calle,
            varchar(10) as Exterior,
            varchar(10) as interior,
            varchar(50) as colonia,
            varchar(10) as codigopostal,
            varchar(13) as RFC,
            varchar(50) as municipio,
            varchar(50) as estado,
            varchar(18) as curp,
            integer as carteraxcobar,
            varchar(255) as leyenda,
            VARCHAR(255) as leyendarecibo,
            integer as codigo;

define  v_descripcionrecibo lvarchar(500);
define  v_carteraxcobar,v_codigo,v_adeudo,v_id,v_contador,v_bloqueo, vaxomin, vaxomax integer;
define  v_leyenda varchar(255);
define  v_desc varchar(60);
define  v_nombre varchar(92);
define  v_calle varchar(80);
define  v_ext,v_int varchar(10);
define  v_vig char(1);
define  v_blq,v_bloque1 varchar(2);
define  v_let,v_letra1 varchar(3);
define  v_multa, v_descuento, v_recargos, v_desc_multa, v_desc_recargo money(18,2);
define  v_porcentaje, v_porc_Rec int;

let v_contador=0;
  if (trim(pmer) = '214') then
          return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'MERCADO BLOQUEADO, NO SE PUEDE COBRAR ','',-1;
  end if;
/*
  if prec=1 and pmer=34 and psecc='SS' and ploc=1021 and plet='0' and pblq='0' then
     return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'LOCAL BLOQUEADO, NO SE PUEDE COBRAR ','',-1;
  end if;
*/
if not exists(select * from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc) then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'NO EXISTE NUMERO DE LOCAL','',-1;
else
   foreach
   select id_local,letra_local,bloque into v_id,v_let,v_blq 
   from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
   if v_let is null then
      let v_letra1='0';
   else
      let v_letra1=v_let;
   end if;
   if v_blq is null then
      let v_bloque1='0';
   else
      let v_bloque1=v_blq;
   end if;
   if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
       let v_contador=v_contador+1;

       select a.nombre,a.vigencia,a.bloqueo,nvl(d.descripcion,''),nvl(count(b.id_adeudo_local),0),min(b.axo),max(b.axo)
       into v_nombre,v_vig,v_bloqueo,v_desc,v_adeudo, vaxomin, vaxomax 
       from ta_11_locales a,outer ta_11_adeudo_local b, outer ta_11_cvebloqueo d
       where a.id_local=v_id and b.id_local=a.id_local and d.cve_bloqueo=a.bloqueo 
       group by a.nombre,a.vigencia,a.bloqueo,d.descripcion;

   --    if trim(pmer)=34 then
   --       if (today>=mdy(5,13,2019)) and (today<=mdy(6,15,2019)) then 
   --          execute procedure spd_15_descautrm(v_id, 'S', 'S');
   --      end if;
   --    end if;

      -- Para verficar descuento de multa que no exceda de 200 mil
       let v_multa=0; 
       let v_descuento=0;
       let v_porcentaje=0;
       let v_porc_Rec=0;
       let v_desc_multa=0; 
       let v_desc_recargo=0;

       if not exists( select * from ta_11_descmulta where id_local=v_id and estado='V') then
          if (today>=mdy(11,13,2023)) and (today<=mdy(11,24,2023)) then
             let v_porcentaje=80;
          else
             let v_porcentaje=0;
          end if;
       else
          select porcentaje into v_porcentaje from ta_11_descmulta where id_local=v_id and estado='V';
       end if;

       if not exists( select * from ta_11_descrec where id_local=v_id and vigencia='V') then
          if (today>=mdy(11,13,2023)) and (today<=mdy(11,24,2023)) then
             let v_porc_Rec=75;
          else
             let v_porc_Rec=0;
          end if;
       else
          select porcentaje into v_porc_Rec from ta_11_descrec where id_local=v_id and vigencia='V';
       end if;

       execute function fn_getrecdescmerc(v_id, year(today), month(today)) into v_recargos;
       execute function fn_getmuldescmerc(v_id, year(today), month(today)) into v_multa;
       let v_desc_multa = (v_multa * v_porcentaje) / 100;
       let v_desc_recargo = (v_recargos * v_porc_Rec) / 100;
       let v_descuento = v_desc_multa + v_desc_recargo;

       if v_vig<>'A' then
          return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONVENIO DADO DE BAJA','',-1;
       end if;
       if v_bloqueo>0 then
          return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'LOCAL BLOQUEADO-'||v_desc,'',-1;
       end if;
       if (v_vig='A') and (v_bloqueo=0) and (v_adeudo=0) then
          return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'LOCAL SIN ADEUDO','',-1;
       else
          if v_descuento>200000 then
             return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'EL DESCUENTO EXCEDE DE 200 MIL','',-1;
          else
             if (v_vig='A') and (v_bloqueo=0) and (v_adeudo>0) then 
                if (pmer=70) and (vaxomin=2016) and (vaxomax=2016) then
                   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'LOCAL SIN ADEUDO','',-1;
                else
                   return v_nombre,'','','',' ',' ',' ',' ',' ',' ',1,'LOCAL CON ADEUDO, PUEDE COBRARSE','',0;
                end if;
             end if;
          end if;
       end if;
   end if;
   end foreach;
if v_contador=0 then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'NO EXISTE NUMERO DE LOCAL','',-1;
end if;
end if;
end function;

CREATE FUNCTION "informix".admin_adeudos_detalle_13(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(120) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia,v_mensaje varchar(30);
define  v_cveparc char(1);
define  v_letra1,v_let varchar(3); 
define  v_bloque1,v_blq varchar(2);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses decimal(14,2);
define  v_aimporte,v_descuento,v_porc,v_gastost,v_impdesc,v_muldesc decimal(14,2);
define  v_folreq,dias_cuantos,dias_habil,v_axomin,v_mesmin int;
define  v_fecreq,v_fecha_desc,v_fecha_rec,v_fecemi date;
define  v_id,v_idresto,v_idadeudo,v_parc,v_aaxo,v_aperiodo,v_dmes,v_desc,v_contador,v_porcdesc,v_cvecuo int;
define  v_ref char(7);
define  v_cuentaapl,v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp int;

begin
    on exception in (-958)
       delete from tmp_totalesmerc;
    end exception;
create temp table tmp_totalesmerc(
  rubro int,
  concepto int,
  cuenta int,
  axo int,
  mes int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;
let v_contador=0;
let v_gastost=0;
let v_aperiodo=0;
let v_impdesc=0;
let v_muldesc=0;

if trim(pref)='' then
   let v_ref=year(today)||'/12';
--   let v_ref='9999/12';
else
   let v_ref=trim(pref);
end if;

foreach
select id_local,letra_local,bloque,clave_cuota into v_id,v_let,v_blq,v_cvecuo 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    -- obtiene las cuentas de aplicacion para el mercado
    select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,
           cuenta_descmulta,cuenta_gastos,cuenta_descpp 
    into v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp
    from ta_11_mercados where num_mercado_nvo=pmer;
    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id;
    -- para sacar el mes minimo       
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id and axo=v_axomin;

    if pmer=70 then
       let v_axomin=2017;
       let v_mesmin=1;
    end if;

    if trim(pmer)=34 then
       if (today>=mdy(8,8,2019)) and (today<=mdy(8,31,2019)) then 
          execute procedure spd_15_descautrm(v_id, 'S', 'S',substr(v_ref,1,4),substr(v_ref,6,2) );
       end if;
    end if;
    if trim(pmer)=1 then
       if (today>=mdy(8,30,2019)) and (today<=mdy(9,30,2019)) then 
          execute procedure spd_15_descautrm(v_id, 'S', 'S',substr(v_ref,1,4),substr(v_ref,6,2) );
       end if;
    end if;
    -- para obtener el datos de multa y gastos
    foreach
    select b.fecha_emision,nvl(b.folio,0), nvl(b.importe_multa,0),nvl(importe_gastos,0),
    nvl(b.porcentaje_multa,0),nvl(b.fecha_practicado,null)
    into v_fecemi,v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
    from ta_15_apremios b
    where b.modulo=11 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
    order by  1,2 
    let v_gastost=v_gastost+v_gastos;
    end foreach;

    let dias_cuantos=0;

    select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales 
    where fecha between v_fecreq and today;
    
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
--           let v_multa=v_multa*50/100;
           let v_muldesc=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
--              let v_multa=v_multa*80/100;
              let v_muldesc=v_multa*20/100;
           end if;
        end if;
    else
--        let v_multa=(v_multa*(100-v_porcmul))/100;
        let v_muldesc=(v_multa*v_porcmul)/100;
    end if;

    if v_multa>0 then
       let v_acumulado=v_acumulado+v_multa;
       return 0,0,v_ctamul,v_axomin||'/'||lpad(v_mesmin,2,'0'),'MULTA '||v_folreq,v_multa,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctamul,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'MULTA '||v_folreq,v_multa,v_acumulado);
    end if;

    if v_muldesc>0 then
       let v_muldesc=v_muldesc*-1;
       let v_acumulado=v_acumulado+v_muldesc;
       return 0,0,v_ctadesmul,v_axomin||'/'||lpad(v_mesmin,2,'0'),'DESCUENTO MULTA '||v_folreq,v_muldesc,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctadesmul,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'DESCUENTO MULTA '||v_folreq,v_muldesc,v_acumulado);
    end if;

    if v_gastost>0 then
       let v_acumulado=v_acumulado+v_gastost;
       return 0,0,v_ctagst,v_axomin||'/'||lpad(v_mesmin,2,'0'),'GASTOS '||v_folreq,v_gastost,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctagst,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'GASTOS '||v_folreq,v_gastost,v_acumulado);
    end if;

    foreach
    select a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos,
           d.id_contribuy_renta
    into   v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec,v_desc
    from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d
    where a.id_local=v_id and 
    ( (a.axo>v_axomin  or (periodo>=v_mesmin  and axo=v_axomin)) and
   ((a.axo=substr(v_ref,1,4)  and a.periodo<=substr(v_ref,6,2)) or (a.axo<substr(v_ref,1,4))) )   

    and b.mes=month(today) and d.id_local=a.id_local 
    order by a.axo,a.periodo
    let v_porc=0;
    let v_monto=0;
    let v_impdesc=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    if (pmer=90) or (v_cvecuo=19) then
       let v_monto=v_aimporte;
    else
    if pmer=214 then
       let v_impdesc=(v_aimporte*v_desc)/100;
       let v_monto=v_aimporte;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_monto=v_aimporte;
             else
                let v_impdesc=v_aimporte*.10;
                let v_monto=v_aimporte;
             end if;
          else
             let v_impdesc=v_aimporte*.10;
             let v_monto=v_aimporte;   
          end if;
       else
          let v_monto=v_aimporte;
       end if;   
    end if;
    end if;
    if  v_aaxo=year(today) then
        let v_cuentaapl=v_ctaact;
    else
        let v_cuentaapl=v_ctarzg;
    end if;
    let v_acumulado=v_acumulado+v_monto;
    if pmer=214 then
       return 0,0,v_cuentaapl,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'PAGO TRIMESTRAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'PAGO TRIMESTRAL',v_monto,v_acumulado);
    else
       return 0,0,v_cuentaapl,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'ARRENDAMIENTO MENSUAL 1',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'ARRENDAMIENTO MENSUAL 1',v_monto,v_acumulado);
    end if;

    if v_impdesc>0 then
       let v_impdesc=v_impdesc*-1;
       let v_acumulado=v_acumulado+v_impdesc;
       if pmer=214 then
          return 0,0,v_ctadespp,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado);
       else
          return 0,0,v_ctadespp,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado);
       end if;
    end if;

    if (v_cvecuo=19) and (v_aaxo=2024) and (v_aperiodo=1) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2018 peticion de Claudia Jara por correo
       execute procedure admin_recargos_13(pmer,v_folreq,(v_monto+v_impdesc),mdy(v_aperiodo,23,v_aaxo)) into v_recargos;
    else
       execute procedure admin_recargos_13(pmer,v_folreq,(v_monto+v_impdesc),mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos;
    end if;

    if v_recargos>0 then
       let v_acumulado=v_acumulado+v_recargos;
       if pmer=214 then
          return 0,0,v_ctarec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO TRIMESTRAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO TRIMESTRAL',v_recargos,v_acumulado);
       else 
          return 0,0,v_ctarec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO MENSUAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO MENSUAL',v_recargos,v_acumulado);
       end if;
       let v_descuento=0; 
       execute procedure sp_desctomerc(v_id,v_aaxo,v_aperiodo,1,v_recargos,null,0,'',0,11) into v_descuento,v_mensaje;
       if v_descuento>0 then
          let v_porcdesc=substr(v_mensaje,length(v_mensaje)-2,3);
          let v_descuento=v_descuento*-1;
          let v_acumulado=v_acumulado+v_descuento;
          if pmer=214 then
             return 0,0,v_ctadesrec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          else 
             return 0,0,v_ctadesrec,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          end if;
       end if;
    end if;
    end foreach;
end if;
end foreach;

end function;

CREATE FUNCTION "informix".admin_recargos_13(pmer int,pfol int,pimp money(18,2),pven date)
returning   money(18,2) as recargos;

define v_recargos money(18,2);
define v_porc decimal(5,2);
define v_aperiodo,v_primermes int;

let v_aperiodo=0;

/*
if (pmer=19 and year(pven)>=2019) or (pmer=37 and year(pven)>=2019) or (pmer=70 and year(pven)>=2019) then -- quitar esta validacion terminando la promocion
   if (today>=mdy(1,1,2024)) and (today<=mdy(2,6,2024)) then
      let v_recargos=0;
      return v_recargos;
   end if;  
end if;
*/
if pmer <>214 then
   if day(today)<day(pven) then
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>year(pven)  or (mes>=month(pven)  and axo=year(pven))) and
            (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>year(pven) or (mes>=month(pven)  and axo=year(pven))) and
            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
   end if;
else 
   if month(pven)=1 then let v_primermes=1;
   else if month(pven)=2 then let v_primermes=4;
   else if month(pven)=3 then let v_primermes=7;
   else if month(pven)=4 then let v_primermes=10;
   else let v_primermes=0;
   end if;
   end if;
   end if;
   end if;

   if (month(today)=1) or (month(today)=4) or (month(today)=7) or (month(today)=10)  then
      if day(today)<day(pven) then
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>year(pven)  or (mes>=v_primermes  and axo=year(pven))) and
               (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
      else
         select sum(porcentaje_mes) into v_porc from ta_12_recargos
         where ( (axo>year(pven) or (mes>=v_primermes  and axo=year(pven))) and
               (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
      end if;
   else
      select sum(porcentaje_mes) into v_porc from ta_12_recargos
      where ( (axo>year(pven) or (mes>=v_primermes  and axo=year(pven))) and
            (axo<year(today)  or (mes<=month(today) and axo =year(today))) );   
   end if;
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if  pfol = 0 then
    if v_porc > 100 then
       let v_recargos=trunc(pimp*100)/100;
    else
       let v_recargos=trunc(pimp*v_porc)/100;
    end if;
else
    if v_porc > 250 then
       let v_recargos=trunc(pimp*250)/100;
    else
       let v_recargos=trunc(pimp*v_porc)/100;
    end if;
end if;
return v_recargos;
end function;

CREATE FUNCTION "informix".cob34_gdetade_01 ( par_tabla Char(1), par_Id Integer, par_Axo Smallint, par_Mes Smallint )
{######################################################################
#  Procedimiento:    cob34_gdetade_01
#  Descripcion:      Interfaz de DETALLE de adeudos de OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla = Rubro de Ingreso
#		     	par_Id = Id de control del registro
#                    		par_Axo = a�o de corte
#                    		par_Mes = mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}
                returning VarChar(200) as Concepto,
		Integer as Axo,
		Integer as Mes,
		Money(12,2) as Importe_Pagar,
		Money(12,2) as Recargos_Pagar,
		Money(12,2) as Dscto_Importe,
		Money(12,2) as Dscto_Recargos,
        Money(12,2) as Actualizacion_Pagar,
        Money(12,2) as Multa_pagar,
        money(12,2) as Dscto_multa;
               

--**********************************************************************************************
  define v_Periodo_CN, r_Periodo_CN   varchar(7);
  define v_importe, v_recargo, v_por_recargo, v_importe_rgo, v_importe_dsctor_cgo, v_importe_total, v_actualizacion, v_multa, v_importe_dsctor_multa, v_importe_resp		Money(12,2);
  define v_Axo, v_Mes	Integer;
  define v_tipo_var		Char(1);
define v_mensaje_proc   varchar(255);
--****************************************************************************************************************************************** ctas de aplicacion
  define v_cta_multas, v_cta_gastos, Axo_v, Mes_v, Dia_v, v_axo_inicio, v_mes_inicio	Integer;
  define v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza			Integer;
  define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza				Integer;
  define v_cta_rcgos_ade, v_cta_rcgos_exced, par_AxoS, par_mesS			Integer;
  define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced					Integer;
  define v_tipo_obligacion, v_Dato							Char(50);
--******************************************************************************************************************************************
	
                EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  
  -- pedazo adicionado
  Let r_Periodo_CN = v_Periodo_CN;

Let v_importe =0;
let v_importe_resp = 0;
Let v_recargo =0;
Let v_por_recargo =0;
Let v_importe_rgo =0;
Let v_importe_dsctor_cgo =0;
Let v_importe_dsctor_multa =0;
let v_actualizacion=0;
Let v_tipo_var = '';
Let v_Dato = '';
Let v_mensaje_proc = '';
let par_AxoS=0; 
let par_mesS=0;

-- verifica si tiene suspensi�n de servicio
if exists(select * from t34_suspensiones WHERE id_contrato = par_Id and estado='S') then
   SELECT 	axo_inicio, mes_inicio iNTO v_axo_inicio, v_mes_inicio fROM t34_suspensiones WHERE id_contrato = par_Id and estado='S';
   if v_mes_inicio = 1 then
	  Let par_AxoS = (v_axo_inicio - 1);
      Let par_MesS = 12;
   else
	  Let par_AxoS = v_axo_inicio;
      Let par_MesS = (v_mes_inicio - 1);
   end if;
   if par_AxoS < par_Axo then
	  Let par_Axo = par_AxoS;
   end if; 
   if par_MesS < par_Mes then
	  Let par_Mes = par_MesS;
   end if;
end if;

SELECT 	Year(fechalimite), Month(fechalimite), Day(fechalimite)  
INTO 	Axo_v, Mes_v, Dia_v
FROM 	t34_fechalimite
WHERE 	cve_tab = par_tabla
AND 	Month(fechalimite) = Month(Current)  
AND 	Year(fechalimite) = Year(Current);

if 	Day(Current) <= Dia_v then
	if 	Mes_v = 1 then
		Let Mes_v = 12;
        Let Axo_v = Axo_v - 1;
    else
        Let Mes_v = Mes_v - 1;
    end if;
End if;

FOREACH
        SELECT Year(a.periodo), Month(a.periodo), a.importe, a.recargo, a.tipo_var  INTO v_Axo, v_Mes, v_importe, v_recargo, v_tipo_var  
		FROM t34_pagos a, t34_status b    WHERE a.id_datos = par_Id  AND a.periodo <= par_Axo || '-' || par_Mes
			AND b.id_34_stat = a.id_stat AND b.cve_tab = 'E'  AND b.cve_stat in ('V')
			ORDER BY periodo

        -- calcula actualizacion    
        if (v_importe > 0) and (v_tipo_var = 'T') then 
           let v_actualizacion=0;
           execute function spd_11_calc_actualizacion(v_Axo, v_Mes, v_importe) into v_actualizacion;
         --  Let	v_actualizacion = dbestacion:fcn_inpc_x_mes ( (v_Axo * 100) + v_Mes) * v_importe / 100 ; -- formula anterior
        end if;   
		if v_tipo_var = 'F' then
			Let v_importe_rgo = 0;
            let v_multa =0;
            let v_importe_dsctor_multa =0;
		else
			if v_importe > 0 then 
               Select sum(por_recargo) Into v_por_recargo From t34_porcentajes Where periodo_porc between v_Axo || '-' || v_Mes and (v_Periodo_CN);

				if v_por_recargo > 0 then
                    Let v_importe_rgo = (v_importe * v_por_recargo) / 100;
					EXECUTE PROCEDURE sp_desctomerc ( par_Id, v_Axo, v_Mes, 1, v_importe_rgo, Null, Null, Null, Null, 34) INTO v_importe_dsctor_cgo, v_mensaje_proc;
					Let v_importe_dsctor_cgo = v_importe_dsctor_cgo * -1;
				else
                   	Let v_importe_rgo = 0;
					Let v_importe_dsctor_cgo =0;
				end if;
			else
				Let v_importe_rgo = 0;
				Let v_importe_dsctor_cgo =0;
			end if;
		end if;
        if v_importe_rgo > 0 then
           execute procedure sp34_calc_multa(v_importe ,mdy( v_Mes, Dia_v, v_Axo) ) into v_multa;
         --  let v_multa= (v_importe * .30);
           execute PROCEDURE sp34_desctomulta( par_Id, v_Axo, v_Mes, v_multa) into v_importe_dsctor_multa, v_mensaje_proc;
           Let v_importe_dsctor_multa = v_importe_dsctor_multa * -1;
        else
           let v_multa= 0;
           Let v_importe_dsctor_multa =0;  
        end if;
	if v_importe > 0 then
		EXECUTE PROCEDURE cob34_gctaaplic_01 ( par_tabla, v_tipo_var ) INTO v_cta_multas, v_cta_gastos, 
				v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza, v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza, 
				v_cta_rcgos_ade, v_cta_rcgos_exced, v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced, v_tipo_obligacion;
	end if;
	if v_tipo_var = 'F' then
		Let v_Dato = 'Adeudo por Forma de Apertura ';
	end if;
	if v_tipo_var = 'A' then
		Let v_Dato = 'Adeudo por Autorizacion ';
	end if;
	if v_tipo_var = 'T' then
		Let v_Dato = 'Adeudo por ' || Trim(v_tipo_obligacion) || ' del ' || v_Axo || '-' || v_Mes;
		--Let v_Dato = 'Adeudo por ' || Trim(v_tipo_obligacion);
	end if;
-- Se agrega para cumplir con requerimiento de maribel 14 de Marzo de 2024 JIRA
if  par_Id in (547, 577) then
    let v_importe_rgo = 0;
    let v_actualizacion = 0;
    let v_multa = 0;
 end if;
	RETURN v_Dato, v_Axo, v_Mes, v_importe, v_importe_rgo, 0, v_importe_dsctor_cgo, v_actualizacion, v_multa, v_importe_dsctor_multa   with resume;
	Let v_Dato = '';

END FOREACH;
                                           
end function;

CREATE FUNCTION "informix".con34_gdetade_02 ( par_Tabla Char(1), p_Control Integer, p_Rep Char(1), p_Fecha_fin Char(7) )
                returning varchar(100) as Concepto,
              Integer as Cant_Recolec,
              Money(12,2) as Importe_Adeudos,
              Money(12,2) as Importe_Recargos,
              Money(12,2) as Importe_Multas,
              Money(12,2) as Importe_Actualizacion,
              Money(12,2) as Importe_Gastos;
               

{
#  Procedimiento: con34_Gdetade_02
#  Descripcion:  Genera una consulta del detalle de Adeudos por contrato
#  Parametros de entrada: p_Control_contrato : id de busqueda del Contrato
#                                       p_Rep : Tipo de reporte a obtener
#                                       p_Axo_fin : Axo final hasta donde se desea obtener el reporte
#                                       p_Mes_fin : Mes final hasta donde se desea obtener el reporte
#  Parametros de salida:   Fecha :   Periodo de Adeudo   
#                                      Concepto : El concepto de cobro
#                                      Numero : Unidades recolectadas
#                                      Importe : El importe de los Adeudos/multa
#                                      Importe : El importe de los Recargos/gastos
#  Elaboro:    c. Gilberto Moreno
#  Modifico: 
#  Fecha Modificaci�n : 
}

--****************************************************************************************************************************** CONTADOR GENERAL DE REGISTROS
  define v_Contador                                                                                                                    Integer;
--****************************************************************************************************************************** APREMIOS
  define v_id_control, v_folio_req, v_FolReq, v_Lineas_Dato                                                   Integer;
  define v_importe_multa, v_importe_gastos, v_tot_gastos, v_importe_actualizacion   Money(12,2);
  define v_DetFolReq                                                                                                  varchar(120);
  define v_diligencia                                                                                                                     char(1);
--****************************************************************************************************************************** ADEUDOS / RECARGOS
  define v_aso_mes_pago                                                                                                        Date;
  define v_importe, v_totAdeudos, v_importe_rec1, v_importe_rec2                                 Money(12,2);

  define v_Ctrol_Operacion, v_exedencias                                                                        Integer;
  define v_descripcion                                                                                                 varchar(50);
  define v_Detalle_Dato                                                                                                             varchar(100);

       define v_Importe_recargo, v_TotRecargos                                                               Money(12,2);
       define v_mensaje_proc                                                                                                     varchar(255);
  define v_tipo_var								Char(1);

--****************************************************************************************************************************** AUXILIARES DE PERIODOS
  define Mes_v, Dia_v, Mes_Hoy, Aso_Hoy, Axo_v                                                                      varchar(4);
  define v_Periodo_CN, v_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE, v_refSUS                            varchar(7);
  define v_Periodo_Inicio, v_Periodo_fin, v_Periodo_Ade                                                        varchar(7);
  define v_Periodo                                                                                                                       varchar(9);
  define aso_proceso, aso_actual, v_porc, v_axo, v_Mes, v_axo_inicio, v_mes_inicio                Integer;
--****************************************************************************************************************************** 
-- set debug file to 'Gil.log';
-- trace on;   
Let v_Contador = 0;
Let v_tipo_var = '';
   Let v_descripcion = 'Cuota Normal ';
   Let v_importe = 0;
   Let v_Importe_recargo = 0;
   let v_importe_multa = 0;
   let v_importe_actualizacion = 0;
   Let v_totAdeudos = 0;
   Let v_TotRecargos = 0;
   Let v_importe_rec1 = 0;
   Let v_importe_rec2 = 0;
   Let v_axo = 0;
   Let v_Lineas_Dato = 0;
   Let v_refSUS='';

  -- fecha_limite
SELECT 	Year(fechalimite), Month(fechalimite), Day(fechalimite)  
INTO 	Axo_v, Mes_v, Dia_v
FROM 	t34_fechalimite
WHERE 	cve_tab = par_tabla
AND 	Month(fechalimite) = Month(Current)  
AND 	Year(fechalimite) = Year(Current);

if 	Day(Current) <= Dia_v then
	if 	Mes_v = 1 then
		Let Mes_v = 12;
        Let Axo_v = Axo_v - 1;
    else
        Let Mes_v = Mes_v - 1;
    end if;
End if;

                EXECUTE PROCEDURE con34_glperiodo ( par_Tabla ) INTO v_Periodo_CN;  
  -- fecha limite termina

  -- pedazo adicionado
  Let r_Periodo_CN = v_Periodo_CN;
  if p_Rep <> 'V' then
     Let v_Periodo_CN = p_Fecha_fin;
  end if;

-- verifica si tiene suspensi�n de servicio
if exists(select * from t34_suspensiones WHERE id_contrato = p_Control and estado='S') then
   SELECT 	axo_inicio, mes_inicio iNTO v_axo_inicio, v_mes_inicio fROM t34_suspensiones WHERE id_contrato = p_Control and estado='S';
   if v_mes_inicio = 1 then
	  Let v_refSUS = ((v_axo_inicio - 1)||'-'||12);
   else
      Let v_refSUS = (v_axo_inicio||'-'||(v_mes_inicio - 1));
   end if;
   if v_refSUS < v_Periodo_CN then
	  Let v_Periodo_CN = v_refSUS;
   end if;
end if;

  -- pedazo adicionado termina

  	-- REQUERIMIENTOS
                	EXECUTE PROCEDURE con34_grequerim_01 ( 34, p_Control ) INTO v_DetFolReq, v_importe_multa, v_tot_gastos;  
		--if v_importe_multa <> 0 or v_tot_gastos <> 0 then -- antes con multa de notificaci�n
        if v_tot_gastos <> 0 then  
			RETURN v_DetFolReq, Null, 0,0,0,0, v_tot_gastos  with resume;
		end if;
  	-- FIN REQUERIMIENTOS

                --Let v_Lineas_Dato = 0;
                --Let v_Detalle_Dato = '';
                --               Select ('Descuento de Recargos en periodo(s) del ' || axoinicio || '-' || mesinicio || 
                --                               ' al ' || axofin || '-' || mesfin || ' por el ' || porcentaje || ' %'), 
                --                               (axoinicio || '-' || mesinicio), axofin || '-' || mesfin, porcentaje
                --                               INTO v_Detalle_Dato, v_Periodo_Inicio, v_Periodo_fin, v_porc
                --                               from ta_16_descrec
                --                               Where id_contrato = p_Control_contrato and vigencia = 'V';

	--	if v_Detalle_Dato <> '' then
	--		Let v_Lineas_Dato = v_Lineas_Dato + 1;
	--	end if;
	-- AQUI TERMINA 

                               foreach
                                               Select Year(h.periodo), h.periodo,  h.importe, Month(h.periodo), H.tipo_var
                                                              Into v_axo, v_aso_mes_pago, v_importe, v_Mes, v_tipo_var 
                                                               From t34_pagos H, t34_status b
                                                               Where H.id_datos = p_Control 
                                                              and H.periodo <= ( v_Periodo_CN ) 
                                                              and b.id_34_stat = h.id_stat and b.cve_stat = 'V'
                                                               Order By h.id_34_pagos, h.periodo
             
                               if v_importe > 0 then
                                               Select sum(por_recargo) 
                                               Into v_Importe_recargo
                                                From t34_porcentajes
                                                Where periodo_porc between (v_aso_mes_pago) and (r_Periodo_CN);
                               end if;
		if (v_tipo_var = 'F') or (v_tipo_var = 'A') then
			Let v_Importe_recargo = 0;
            let v_importe_multa = 0;
            let v_importe_actualizacion = 0;
  
		end if;

                               if v_importe > 0 then
                                   Let v_totAdeudos = v_totAdeudos + v_importe;
                                   if v_Importe_recargo <> 0 then
                                      Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                                       --EXECUTE PROCEDURE sp_desctomerc (p_Control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
                                       --if v_importe_rec2 > 0 then
                                       --  Let v_TotRecargos = v_importe_rec1 - v_importe_rec2;  -- modificado de sumando a restando
                                       --else
                                         Let v_TotRecargos = v_importe_rec1;
                                       --end if;
                                       
                                   end if;
                                   if v_importe_rec1 >0 then
                                      --- calculo de multas
                                      let v_importe_multa =0;
                                      execute procedure sp34_calc_multa(v_importe ,mdy( v_Mes, Dia_v, v_Axo) ) into v_importe_multa;
                                   end if;
                                   -- calculo de actualizacion
                                   let v_importe_actualizacion=0;
                                   execute function spd_11_calc_actualizacion(v_Axo, v_Mes, v_importe) into v_importe_actualizacion;

		if v_tipo_var = 'F' then
                                   		RETURN 'Adeudo por Forma de Apertura', Null, v_importe, v_TotRecargos, v_importe_multa, v_importe_actualizacion, 0  with resume;
		end if;
		if v_tipo_var = 'A' then
                                   		RETURN 'Adeudo por Autorizacion', Null, v_importe, v_TotRecargos, v_importe_multa, v_importe_actualizacion, 0  with resume;
		end if;
		if v_tipo_var = 'T' then
        if p_Control in (547, 577) and ( Year(v_aso_mes_pago) = 2023 or Month(v_aso_mes_pago) <= 2)   then
            let v_TotRecargos = 0;
            let v_importe_multa = 0;
            let v_importe_actualizacion = 0;
        end if;
                                   		RETURN 'Adeudo por Periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), null, v_importe, v_TotRecargos, v_importe_multa, v_importe_actualizacion, 0  with resume;
		end if;
                                   	--RETURN v_descripcion || ' con periodo del ' || Year(v_aso_mes_pago) || '-' || Month(v_aso_mes_pago), null, v_importe, v_TotRecargos                 with resume;
                                    Let v_Contador = v_Contador + 1;
                               end if;

                               Let v_importe = 0;
                               Let v_Importe_recargo = 0;
                                Let v_importe_rec1 = 0;
                                Let v_importe_rec2 = 0;
                                Let v_Importe_multa = 0;
                                Let v_Importe_actualizacion = 0;

                               Let v_totAdeudos = 0;
                               Let v_TotRecargos = 0;
                               end foreach;



   if v_Contador = 0 then
       return 'NO HAY ADEUDO DENTRO DEL PERIODO SELECCIONADO' , Null, Null, Null, null, null, null  with resume;
   else
       if v_Lineas_Dato > 0 then
          return v_Detalle_Dato, Null, Null, Null, null, null, null       with resume;
       end if;
   end if;
--trace off;
end function;

create procedure "informix".admin_adeudos_detalle_30odoo(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(120) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia,v_mensaje varchar(30);
define  v_cveparc char(1);
define  v_letra1,v_let varchar(3);
define  v_bloque1,v_blq varchar(2);
define  v_solicitud,v_monto,v_acumulado decimal(14,2);
define  v_id,v_idresto,v_idadeudo,v_contador,v_axo,v_mes,v_axo1,v_mes1 int;
define  v_ref char(7);
define  v_recargos date;

begin
    on exception in (-958)
       delete from tmp_totcertificado;
    end exception;
create temp table tmp_totcertificado(
  rubro int,
  concepto int,
  cuenta int,
  axo int,
  mes int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_contador=0;
let v_axo1=0;
let v_mes1=0;

foreach
select id_local,letra_local,bloque into v_id,v_let,v_blq 
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    -- sacar el periodo d pago
--    select fecha_recargos into v_recargos from ta_11_fecha_desc where mes=month(today);
--    let v_axo=year(today);
--    let v_mes=month(today);
--    if today<v_recargos then
--       if v_mes=1 then
--          let v_mes=12;
--          let v_axo=year(today)-1;
--       else
--          let v_mes=month(today)-1;
--       end if;
--    end if;
    -- ultimo periodo de pago
    select nvl(Max(axo),0) into v_axo from ta_11_pagos_local where id_local=v_id;
    select nvl(max(periodo),0) into v_mes from ta_11_pagos_local where id_local=v_id 
     and axo=(select nvl(Max(axo),0) from ta_11_pagos_local where id_local=v_id);

    -- calcula siguiente mes
    if v_mes=12 then
       let v_mes1=1;
       let v_axo1=v_axo+1;
    else
       let v_mes1=v_mes+1;
       let v_axo1=v_axo; 
    end if;
  

    -- si no exste el siguiente mes como adeudo busca en meses cancelados 
    if (v_axo=year(today)) and (v_mes=12) then
       -- obtiene el costo del certificado
       select costo_noadeudo into v_monto from catastro_gdl:parametros; 
       -- obtiene el costo de la solicitud  
       select costo_solnoadeudo into v_solicitud from ta_12_parametros;
    
       let v_acumulado=v_acumulado+v_monto;
       return 0,431314, get_odoo_cta( 431314 , 30),v_axo||'/'||lpad(v_mes,2,'0'),'CERTIFICADO DE NO ADEUDO',v_monto,v_acumulado with resume;
       insert into tmp_totcertificado values(0,0,431314,v_axo,v_mes,v_axo||'/'||lpad(v_mes,2,'0'),
                'CERTIFICADO DE NO ADEUDO ',v_monto,v_acumulado);
       let v_acumulado=v_acumulado+v_solicitud;
       return 0,421100007, get_odoo_cta( 421100007 , 30),v_axo||'/'||lpad(v_mes,2,'0'),'SOLICITUD',v_solicitud,v_acumulado with resume;
       insert into tmp_totcertificado values(0,0,421100007,v_axo,v_mes,v_axo||'/'||lpad(v_mes,2,'0'),
                'SOLICITUD ',v_solicitud,v_acumulado);
    else
       if not exists(select * from ta_11_adeudo_local where id_local=v_id and axo=v_axo1 and periodo=v_mes1) then
          select nvl(Max(axo),0) into v_axo from ta_11_ade_loc_canc where id_local=v_id;
          select nvl(max(periodo),0) into v_mes from ta_11_ade_loc_canc where id_local=v_id 
         and axo=(select nvl(Max(axo),0) from ta_11_ade_loc_canc where id_local=v_id);
       end if;

         -- obtiene el costo del certificado
         select costo_noadeudo into v_monto from catastro_gdl:parametros; 
         -- obtiene el costo de la solicitud  
         select costo_solnoadeudo into v_solicitud from ta_12_parametros;
    
         let v_acumulado=v_acumulado+v_monto;
         return 0,431314, get_odoo_cta( 431314 , 30),v_axo||'/'||lpad(v_mes,2,'0'),'CERTIFICADO DE NO ADEUDO ' || v_id,v_monto,v_acumulado with resume;
         insert into tmp_totcertificado values(0,0,431314,v_axo,v_mes,v_axo||'/'||lpad(v_mes,2,'0'),
                'CERTIFICADO DE NO ADEUDO ',v_monto,v_acumulado);
         let v_acumulado=v_acumulado+v_solicitud;
         return 0,421100007, get_odoo_cta( 421100007 , 30),v_axo||'/'||lpad(v_mes,2,'0'),'SOLICITUD',v_solicitud,v_acumulado with resume;
         insert into tmp_totcertificado values(0,0,421100007,v_axo,v_mes,v_axo||'/'||lpad(v_mes,2,'0'),
                'SOLICITUD ',v_solicitud,v_acumulado);
    end if;
end if;
end foreach;

end procedure;

CREATE FUNCTION "pgcabrer".admin_encabezados_22(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10))

{# FECHA ACTUALIZACION : 2021-AGO-19
 # MODIFICO : BENITA  CABRERA
 # RAZON : SE AGREGO MENSAJE DE BLOQUEO
 # Se agrega leyenda para los convenios venciados}

returning   varchar(92) as Nombrecompleto,
            varchar(80) as calle,
            varchar(10) as Exterior,
            varchar(10) as interior,
            varchar(50) as colonia,
            varchar(10) as codigopostal,
            varchar(13) as RFC,
            varchar(50) as municipio,
            varchar(50) as estado,
            varchar(18) as curp,
            integer as carteraxcobar,
            varchar(255) as leyenda,
            varchar(255) as leyendaRECIBO,
            integer as codigo;

define  v_descripcionrecibo lvarchar(500);
define  v_carteraxcobar,v_codigo,v_adeudo, v_bloqueo, v_idconvenio integer;
define  v_leyenda varchar(255);
define  v_nombre varchar(92);
define  v_calle varchar(80);
define  v_ext,v_int varchar(10);
define  v_vig char(1);
define  v_vencimiento char(1);

if not exists(select * from ta_17_conv_diverso a,ta_17_conv_d_resto b
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver) then
       return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'NO EXISTE CONVENIO','',-1;
end if;

select nombre,calle,num_exterior,(num_interior||' '||inciso),vigencia, b.bloqueo,nvl(count(d.id_adeudo),0), b.id_conv_resto
into v_nombre,v_calle,v_ext,v_int,v_vig,v_bloqueo,v_adeudo, v_idconvenio
from ta_17_conv_diverso a,ta_17_conv_d_resto b,outer ta_17_adeudos_div d
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and clave_pago is null and d.id_conv_resto=b.id_conv_resto
group by nombre,calle,num_exterior,4,vigencia,b.bloqueo, b.id_conv_resto;

if exists (select * from ta_17_notificaciones where id_convenio=v_idconvenio and vigencia='V' ) then
   let v_vencimiento='S';
else
   let v_vencimiento='N';
end if;

if v_vig='P' then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONVENIO PAGADO','',-1;
end if;

if v_vig='B' then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONVENIO DADO DE BAJA','',-1;
end if;

if v_vig='Z' then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'Convenio Incumplido, pasar a la Direcci�n de Pol�tica Fiscal','',-1;
end if;


if v_bloqueo>0 then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONVENIO BLOQUEADO','',-1;
end if;

if (v_vig='A') and (v_adeudo=0) then
   return ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',0,'CONVENIO SIN ADEUDO','',-1;
else
if (v_vig='A') and (v_vencimiento='S' ) then 
   return v_nombre,v_calle,v_ext,v_int,' ',' ','XAXX010101000',' ',' ',' ',1,'CONVENIO INCUMPLIDO, FAVOR DE COMUNICARSE AL DEPARTAMENTO DE EJECUCI�N FISCAL PARA ACTUALIZAR EL C�LCULO, EXT.1607, 1613, 1724, 1725 Y 1729','',0;
else
if (v_vig='A') and (v_adeudo>0) then 
   return v_nombre,v_calle,v_ext,v_int,' ',' ','XAXX010101000',' ',' ',' ',1,'CONVENIO CON ADEUDO, PUEDE COBRARSE','',0;
end if;
end if;
end if;

end function;

CREATE FUNCTION "informix".admin_adeudos_detalle_22odoo(pinterface int,ptipo char(10),psubt char(10),plet varchar(10),
pnum varchar(10),paxo varchar(10),pseg varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(50) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia, v_descripcion varchar(30);
define  v_cveparc, v_nvaforma char(1);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses,v_interesade decimal(14,2);
define  v_cuentaapl,v_folreq,dias_cuantos,dias_habil,v_ctarec,v_ctaint,v_ctaing int;
define  v_vencimiento,v_fecreq, v_fecinicio, v_inicio date;
define  v_id,v_idresto,v_idadeudo,v_ref,v_parc,v_min,v_max int;

begin
    on exception in (-958)
       delete from tmp_totalesconv;
    end exception;
create temp table tmp_totalesconv(
  rubro int,
  concepto int,
  cuenta int,
  referencia int,
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;

if trim(pref)='' then
   let v_ref=999;
else
   let v_ref=pref;
end if;

select b.id_conv_resto,nvl(e.cuenta_recargos,0),nvl(min(d.pago_parcial),0),nvl(max(d.pago_parcial),0)
,nvl(e.cuenta_intereses,0),nvl(e.cuenta_ingreso,0)
into v_id,v_ctarec,v_min,v_max,v_ctaint,v_ctaing
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d,ta_17_subtipo_conv e
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref and e.tipo=a.tipo and e.subtipo=a.subtipo
group by 1,2,5,6;

-- verifica el tipo de convenio para la nueva forma
select nvaforma, fecha_inicio into v_nvaforma, v_inicio from ta_17_catparcnvo where tipo=ptipo;

 -- para obtener el datos de multa y gastos
foreach
select nvl(b.folio,0), nvl(b.importe_multa,0),nvl(sum(importe_gastos),0),nvl(b.porcentaje_multa,0),
nvl(b.fecha_practicado,null)
into v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
from ta_15_apremios b
where b.modulo=17 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
group by 1,2,4,5 order by  1
end foreach;

let dias_cuantos=0;

select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales
where fecha between v_fecreq and today;
   
let dias_cuantos=(today-v_fecreq)-dias_habil;
if  v_porcmul=100 then
    if dias_cuantos <=6 then
       let v_multa=v_multa*50/100;
    else
       if (dias_cuantos >=7) and (dias_cuantos<=16) then
          let v_multa=v_multa*80/100;
       else  
          let v_multa=(v_multa*(100-v_porcmul))/100;
       end if;
    end if;
else
    let v_multa=(v_multa*(100-v_porcmul))/100;
end if;

if v_multa>0 then
   let v_acumulado=v_acumulado+v_multa;
   return 0,0,0,lpad(v_min,2,'0'),'MULTA CONVENIO ' || v_multa,v_multa,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,lpad(v_min,2,'0'),'MULTA CONVENIO ' || v_multa,v_multa,v_acumulado);
end if;

if v_gastos>0 then
   let v_acumulado=v_acumulado+v_gastos;
   return 0,0,0,lpad(v_min,2,'0'),'GASTOS CONVENIO',v_gastos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,0,lpad(v_min,2,'0'),'GASTOS CONVENIO',v_gastos,v_acumulado);  
end if;

foreach
select b.id_conv_resto,d.id_adeudo,d.pago_parcial,d.importe,d.fecha_venc,d.cve_parcialidad,b.fecha_inicio,d.interes
into v_idresto,v_idadeudo,v_parc,v_importe,v_vencimiento,v_cveparc,v_fecinicio,v_interesade
from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d
where a.tipo=ptipo and a.subtipo=psubt and a.letras_exp=plet
and a.numero_exp=pnum and axo_exp=paxo
and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
and d.pago_parcial<=v_ref
order by d.pago_parcial

  foreach  
  select cuenta_apl, importe, b.descripcion into v_cuentaapl, v_monto, v_descripcion
  from ta_17_desg_parcial a, outer ta_12_ctas_odoo b --cg_12_cuentas b
  where id_adeudo=v_idadeudo and b.cta_aplic=a.cuenta_apl and b.axo=year(today) --b.cta_aplicacion=a.cuenta_apl
  order by id_desgloce

  let v_acumulado=v_acumulado+v_monto;
  return 0, v_cuentaapl, get_odoo_cta22( v_cuentaapl ),lpad(v_parc,2,'0'),'CONVENIO 1'|| v_descripcion,v_monto,v_acumulado with resume;  
  insert into tmp_totalesconv values(0,0,v_cuentaapl,lpad(v_parc,2,'0'),'CONVENIO 2'|| v_descripcion,v_monto,v_acumulado);
  end foreach;
 
-- execute procedure admin_intereses_22(v_idresto,v_vencimiento,v_parc,v_cveparc) into v_intereses; antes
if (v_nvaforma='S') and (v_fecinicio>=v_inicio) then
   let v_intereses=v_interesade;
else
   if (ptipo=17) and (year(v_fecinicio)>=2020) then
      let v_intereses=v_interesade;
   else
      execute procedure admin_intereses_22(v_idresto,v_fecinicio,v_parc,v_cveparc) into v_intereses;
   end if;
end if;
let v_recargos=0;

if v_idresto=12553 then  --- POR ORDENES DE DIRECTOR DE INGRESOS
   if today>v_vencimiento then  -- se elimina porque no lo contempla la ley aplica desde 17/12/2019
      execute procedure admin_recargos_20((v_importe+v_intereses),v_vencimiento) into v_recargos;
   end if;
END IF;

if v_recargos>0 then
   let v_acumulado=v_acumulado+v_recargos;
   return 0,v_ctarec, get_odoo_cta( v_ctarec , 22),lpad(v_parc,2,'0'),'RECARGOS CONVENIO',v_recargos,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctarec,lpad(v_parc,2,'0'),'RECARGOS CONVENIO',v_recargos,v_acumulado);
end if;

if v_intereses>0 then
   let v_acumulado=v_acumulado+v_intereses;
   return 0,v_ctaint, get_odoo_cta( v_ctaint , 22),lpad(v_parc,2,'0'),'INTERESES CONVENIO',v_intereses,v_acumulado with resume;
   insert into tmp_totalesconv values(0,0,v_ctaint,lpad(v_parc,2,'0'),'INTERESES CONVENIO',v_intereses,v_acumulado);
end if;

end foreach;

end function;

CREATE PROCEDURE "pgmoreno".sp16_adeudos_f02 ( p_tipo CHAR(1), p_numero INT, p_rep CHAR(1), pref VARCHAR(20) )
{######################################################################
#  Procedimiento:    sp16_Adeudos_F02
#  Descripcion:      Interfaz de consulta de detalle de Adeudos de ASEO CONTRATADO
#
#  Parametros	p_tipo		= tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:  p_numero	= Numero de Contrato
#				p_rep		= 'V'=Adeudos Vigentes, 'T'=Todo el adeudo ( letra diferente de 'V' )
#               pref		= Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}	
returning	CHAR(7) as Periodo,
VARCHAR(200) as Concepto,
INT as Cant_Recolec,
MONEY(12,2) as Importe_Adeudos,
MONEY(12,2) as Importe_Recargos,
MONEY(12,2) as Importe_Multa,
MONEY(12,2) as Importe_Gastos,
MONEY(12,2) as Actualizacion;

DEFINE v_control_contrato INT;
DEFINE a_Periodo_CN, a_Periodo_EXE, r_Periodo_CN, r_Periodo_EXE VARCHAR(7);
DEFINE v_ref CHAR(7);

DEFINE v_status_licencias INT;
DEFINE v_concepto_licencias CHAR(100);

DEFINE vr_Concepto VARCHAR(100);
DEFINE vr_Importe_Multa_Descto, vr_Importe_Gastos MONEY(12,2);

DEFINE v_r_rubro, v_r_cta_aplic, v1_r_cta_aplic, v2_r_cta_aplic, v3_r_cta_aplic	INT;
DEFINE v_r_importe, v1_r_importe, v2_r_importe, v3_r_importe MONEY(12,2);
DEFINE v_DetFolReq, v0_DetFolReq, v1_DetFolReq, v2_DetFolReq, v3_DetFolReq, v_concepto VARCHAR(100);
-- DEFINE v_importe_multa, v_tot_gastos, v_porcentaje_multaMONEY(12,2);
  
DEFINE v_Ctrol_Operacion, v_exedencias INT;
DEFINE v_descripcion VARCHAR(50);
DEFINE v_importe MONEY(12,2);
DEFINE v_aso_mes_pago DATE;
DEFINE v_Axo, v_Mes, v_Axo_pp, v_Mes_pp	INT;
DEFINE v_Importe_recargo, v_importe_rec1, v_importe_rec2 MONEY(12,2);
DEFINE v_mensaje_proc VARCHAR(200);

DEFINE v_contador INT;
DEFINE v_importe_Dscto_Tot, v_importe_Dscto MONEY(12,2); -- Adicionado por GMG 31/12/2019 para descuento por pronto pago

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
DEFINE v_aplica	CHAR(1);
DEFINE v_porc_adic INT;

-- Descuento por pronto pago
DEFINE pp_fecha_inicio, pp_fecha_fin DATE;
DEFINE pp_porc_dscto DECIMAL(5,2);

DEFINE v_porcdescto INT;
DEFINE v_mensaje VARCHAR(255);									
DEFINE v_Multa20, v_DsctoMulta MONEY(12,2);
DEFINE v_Multa20_tot, v_DsctoMulta_tot MONEY(12,2);
DEFINE v_actualizacion MONEY(16,2);

LET v_porcdescto = 0;
LET v_mensaje = '';
LET v_Multa20 = 0;
LET v_DsctoMulta = 0;
LET v_Multa20_tot = 0;
LET v_DsctoMulta_tot = 0;

LET v_status_licencias = 0;
LET v_concepto_licencias = ' ';

LET a_Periodo_CN = ' ';
LET a_Periodo_EXE = ' ';
LET r_Periodo_CN = ' ';
LET r_Periodo_EXE = ' ';

LET v_Ctrol_Operacion = 0;
LET v_exedencias = 0;
LET v_descripcion = ' ';
LET v_importe = 0;
LET v_Axo = 0;
LET v_Mes = 0;
LET v_Importe_recargo = 0;
LET v_importe_rec1 = 0;
LET v_importe_rec2 = 0;

LET v_contador = 0;
LET v_importe_Dscto = 0;
LET v_actualizacion = 0;

EXECUTE PROCEDURE con16_LPeriodo () INTO a_Periodo_CN, a_Periodo_EXE;

LET r_Periodo_CN = a_Periodo_CN;
LET r_Periodo_EXE = a_Periodo_EXE;
IF p_rep <> 'V' THEN
	IF TRIM(pref) = '' THEN
   		LET v_ref = YEAR(TODAY) || '-' || 12;
		LET v_Axo_pp = YEAR(TODAY);
	ELSE
   		LET v_ref = SUBSTR(pref,1,4) || '-' || SUBSTR(pref,6,2);
		LET v_Axo_pp = SUBSTR(v_ref,1,4);
	END IF;
	LET v_Mes_pp = SUBSTR(v_ref,6,2);

	LET a_Periodo_CN = v_ref;
	LET a_Periodo_EXE = v_ref;
ELSE
	IF TRIM(pref)='' THEN
		LET v_Axo_pp = YEAR(TODAY);
		LET v_Mes_pp = 12;
	ELSE
		LET v_Axo_pp = SUBSTR(pref,1,4);
		LET v_Mes_pp = SUBSTR(pref,6,2);
	END IF;
END IF;
-- IF (v_Axo_pp = YEAR(TODAY)) AND (v_Mes_pp = 12) THEN

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
SELECT aplica INTO v_aplica FROM ta_aplicareq;

-- Descuento por pronto pago
SELECT fecha_inicio, fecha_fin, porc_dscto INTO pp_fecha_inicio, pp_fecha_fin, pp_porc_dscto FROM ta_16_Dscto_pp WHERE status = 'V';

LET v_control_contrato = 0;
IF EXISTS( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero AND b.ctrol_aseo = a.ctrol_aseo AND b.tipo_aseo = p_tipo  ) THEN
	SELECT a.control_contrato INTO v_control_contrato FROM ta_16_contratos a, ta_16_tipo_aseo b
    WHERE a.num_contrato = p_numero AND b.ctrol_aseo = a.ctrol_aseo AND b.tipo_aseo = p_tipo;

	FOREACH
		SELECT a.aso_mes_pago, YEAR(a.aso_mes_pago), MONTH(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion, 
			calc_actualizacion_aseo(YEAR(a.aso_mes_pago), MONTH(a.aso_mes_pago), a.importe)
			INTO v_aso_mes_pago, v_Axo, v_Mes, v_Ctrol_Operacion, v_exedencias, v_importe, v_descripcion, v_actualizacion
		FROM ta_16_pagos a, ta_16_operacion b
		WHERE a.Control_Contrato = v_control_contrato  AND a.aso_mes_pago <= a_Periodo_CN  AND a.Status_Vigencia = 'V' AND a.ctrol_operacion = 6
		AND b.ctrol_operacion = a.ctrol_operacion
		UNION ALL
		SELECT a.aso_mes_pago, YEAR(a.aso_mes_pago), MONTH(a.aso_mes_pago), a.Ctrol_Operacion, a.exedencias, a.importe, b.descripcion,
			calc_actualizacion_aseo(YEAR(a.aso_mes_pago), MONTH(a.aso_mes_pago), a.importe)
		FROM ta_16_pagos a, ta_16_operacion b
		WHERE a.Control_Contrato = v_control_contrato  AND a.aso_mes_pago <= a_Periodo_CN  AND a.Status_Vigencia = 'V' AND a.ctrol_operacion <> 6
		--WHERE a.Control_Contrato = v_control_contrato  AND a.aso_mes_pago <= a_Periodo_EXE  AND a.Status_Vigencia = 'V' AND a.ctrol_operacion <> 6
		AND b.ctrol_operacion = a.ctrol_operacion
		ORDER BY 1, 4

		-- Desde aqui
		IF v_importe > 0 THEN
			IF v_contador = 0 THEN
				-- LICENCIAS RELACIONADAS
				EXECUTE PROCEDURE sp16_LicenciaGiro_F1 (p_tipo, p_numero) INTO v_status_licencias, v_concepto_licencias;
				IF v_status_licencias > 0 THEN
					RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v_concepto_licencias, NULL, NULL, NULL, NULL, NULL, NULL WITH RESUME;
				END IF;

				-- REQUERIMIENTOS
				LET v_r_rubro = 0; LET v_r_cta_aplic = 0;  
				LET v_r_importe = 0; LET v1_r_importe = 0; LET v2_r_importe = 0; LET v3_r_importe = 0;
				LET v_DetFolReq = ' '; LET v1_DetFolReq = ' '; LET v2_DetFolReq = ' '; LET v3_DetFolReq = ' ';

				FOREACH
					EXECUTE PROCEDURE sp_Requerim_F00(16, v_control_contrato) INTO v_r_rubro, v_r_cta_aplic, v_r_importe, v_DetFolReq
					IF v_r_rubro =  0 THEN LET v0_DetFolReq = v_DetFolReq; END IF;                                 -- Descripcion de documentos
					IF v_r_rubro =  1 THEN LET v1_DetFolReq = v_DetFolReq; LET v1_r_importe = v_r_importe; END IF; -- Importe de Multa
					IF v_r_rubro =  2 THEN LET v2_DetFolReq = v_DetFolReq; LET v2_r_importe = v_r_importe; END IF; -- Descuento a la Multa
					IF v_r_rubro =  3 THEN LET v3_DetFolReq = v_DetFolReq; LET v3_r_importe = v_r_importe; END IF; -- Importe de Gastos
				END FOREACH;
				
               -- IF p_numero = 2434 THEN
				IF v_aplica = 'S' THEN
					IF ( v1_r_importe <> 0 ) AND ( v3_r_importe <> 0 ) THEN
						RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v0_DetFolReq, NULL, NULL, NULL, v1_r_importe, v3_r_importe, NULL  WITH RESUME;
						IF v2_r_importe <> 0 THEN
							RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v2_DetFolReq, NULL, NULL, NULL, v2_r_importe, NULL, NULL  WITH RESUME;
						END IF;
					ELSE
						IF ( v1_r_importe = 0 ) AND ( v3_r_importe <> 0 ) THEN
							RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v3_DetFolReq, NULL, NULL, NULL, NULL, v3_r_importe, NULL  WITH RESUME;
						END IF;
					END IF;
				ELSE
					IF v3_r_importe <> 0 THEN
						RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), v3_DetFolReq, NULL, NULL, NULL, NULL, v3_r_importe, NULL  WITH RESUME;
					END IF;
				END IF;
            --    END IF;
			END IF; -- END IF v_contador = 0
		
			IF v_Ctrol_Operacion = 6 THEN
				-- INICIO DEL 10% POR PRONTO PAGO
				IF pp_porc_dscto > 0 AND p_rep <> 'V' THEN
					IF TODAY >= pp_fecha_inicio AND TODAY <= pp_fecha_fin THEN
						IF v_Axo = YEAR(TODAY) AND (v_Mes_pp = 12) THEN  -- solo a�o actual  -- AND (v_Mes_pp = 12) adicionado
							LET v_importe_Dscto = (v_importe * pp_porc_dscto);
							LET v_importe_Dscto = v_importe_Dscto * -1;
						END IF;
						--IF (v_Axo_pp = YEAR(TODAY)) AND (v_Mes_pp = 12) THEN  -- todo el adeudo
						--	LET v_importe_Dscto = (v_importe * pp_porc_dscto);
						--	LET v_importe_Dscto = v_importe_Dscto * -1;
						--END IF;
					END IF;
				END IF;
				-- FIN DEL 10% POR PRONTO PAGO
			
				SELECT SUM(porc_recargo) INTO v_Importe_recargo FROM ta_16_recargos 
				WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN);
			ELSE
	            SELECT SUM(porc_recargo) INTO v_Importe_recargo FROM ta_16_recargos 
	            WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (r_Periodo_CN); -- (r_Periodo_EXE);
			END IF;

			-- (!) La variable v_Importe_recargo trae la sumatoria del recargo del mes y a�o de adeudo hasta el mes vencido, mismo que est� en r_Periodo_CN

            LET v_Multa20 = 365;
            LET v_DsctoMulta = 10;
            LET v_mensaje = '';

			IF v_Importe_recargo <> 0 THEN  -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA en periodos vencidos
				EXECUTE PROCEDURE sp_multa_DestoMulta (16, v_control_contrato, v_axo, v_Mes, v_importe ) INTO v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;
				IF v_Multa20 <> 0 THEN
					LET v_Multa20_tot = v_Multa20_tot + v_Multa20;
				END IF;
				IF v_DsctoMulta <> 0 THEN
					LET v_DsctoMulta_tot = v_DsctoMulta_tot + v_DsctoMulta;
				END IF;
			END IF;

	        IF v_Importe_recargo <> 0 THEN
				LET v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
	            EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, NULL, NULL, NULL, NULL, 16) INTO v_importe_rec2, v_mensaje_proc;
			END IF;
	        IF v_importe_rec2 <> 0 THEN
				LET v_importe_rec2 = v_importe_rec2 * -1;
	        END IF;
			LET v_contador = 1;
		END IF;

		-- hasta aqui
		IF v_importe_rec1 <> 0 THEN
            IF p_numero != 1786 THEN
                RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, v_importe_rec1, v_importe*0.30, NULL, v_actualizacion  WITH RESUME; -- Antes de 2023-05-09
            ELSE
    			--RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, v_importe_rec1, v_Multa20, NULL, v_actualizacion  WITH RESUME;
                RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, v_importe_rec1, v_importe*0.30, NULL, v_actualizacion  WITH RESUME;
            END IF;
			IF v_importe_Dscto <> 0 THEN 
				RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' 10% Dscto p/pp', NULL, v_importe_Dscto, NULL, NULL, NULL, NULL 	WITH RESUME;
			END IF;
			IF v_importe_rec2 <> 0 THEN
	            RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Dscto. al Rcgo del Adeudo', NULL, NULL, v_importe_rec2, NULL, NULL, NULL 	WITH RESUME;
			END IF;
		ELSE
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' Periodo de Adeudo por ' || v_descripcion, v_exedencias, v_importe, NULL, NULL, NULL, v_actualizacion 	WITH RESUME;
			IF v_importe_Dscto <> 0 THEN 
				RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), ' 10% Dscto p/pp', NULL, v_importe_Dscto, NULL, NULL, NULL, NULL 	WITH RESUME;
			END IF;
		END IF;
		-- lo quite

		LET v_Importe_recargo = 0; -- revision
		LET v_importe_rec1 = 0;
		LET v_importe_rec2 = 0;
		LET v_importe_Dscto = 0;
		LET v_descripcion = '';
		LET v_exedencias = 0;
		LET v_importe = 0;

	END FOREACH;

	-- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
 /*   IF p_numero != 1786 THEN
	IF v_aplica <> 'S' THEN
		IF v_Multa20_tot <> 0 THEN
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), 'Multas ', NULL, NULL, NULL, v_Multa20_tot, NULL, NULL WITH RESUME;
		END IF;
		IF v_DsctoMulta_tot <> 0 THEN
			LET v_DsctoMulta_tot = v_DsctoMulta_tot * -1;
			RETURN v_Axo || '-' || LPAD(v_Mes,2,'0'), 'Descto. a Multa ', NULL, NULL, NULL, v_DsctoMulta_tot, NULL, NULL WITH RESUME;
		END IF;
	END IF;
    END IF; */

END IF;
END PROCEDURE;

CREATE FUNCTION "informix".kio13_datosenc_original(var_control INTEGER, var_axo INT)

RETURNING CHAR(1) AS slinea, INT AS sclave, VARCHAR(100) AS scomentario, VARCHAR(100) AS sregcomp,
    VARCHAR(60) AS snombre, VARCHAR(75) AS sdomcomp, VARCHAR(30)AS scol,VARCHAR(10) AS stdesc, dec(5,3) AS smetros,
    VARCHAR(60) AS snomcem, VARCHAR(250) AS sconcepto, MONEY(15,2) AS simptot,VARCHAR(30) AS speriodo,
    MONEY(15,2) AS simporte, MONEY(15,2) AS srecargo, MONEY(15,2) AS sdesctoimp,MONEY(15,2) AS sdesctorec,
    MONEY(15,2) AS sajuste, VARCHAR(60)AS sobserv, INT AS control;

-- esta version es la original de enero 2025 sin la promosion de la condonacion de recargos si paga todo el adeudo al a�o actual

DEFINE v_uap INTEGER;
DEFINE v_control INTEGER;
DEFINE v_axo INTEGER;
DEFINE v_mes SMALLINT;
DEFINE vpar_axo INTEGER;
DEFINE vpar_impte MONEY(15,2);
DEFINE vpar_metros dec(5,3);
DEFINE vpar_recar MONEY(15,2);
DEFINE v_axo_alta INTEGER;
DEFINE v_descuento INTEGER; 
DEFINE v_impdesc MONEY(15,2);
DEFINE v_recardesc MONEY(15,2);
DEFINE v_desctot MONEY(15,2);
DEFINE v_desctotre MONEY(15,2);
DEFINE var_cem CHAR(1);
DEFINE v_porc_global DECIMAL(5,3);
DEFINE v_cementerio CHAR(1);
DEFINE v_clase SMALLINT;
DEFINE v_clase_alfa VARCHAR(10);
DEFINE v_seccion SMALLINT;
DEFINE v_seccion_alfa VARCHAR(10);
DEFINE v_linea SMALLINT;
DEFINE v_linea_alfa VARCHAR(20);
DEFINE v_fosa SMALLINT;
DEFINE v_fosa_alfa VARCHAR(20);
DEFINE v_axo_pagado INTEGER;
DEFINE v_metros DECIMAL(5,3);
DEFINE v_nombre VARCHAR(60) ;
DEFINE v_colonia VARCHAR(30);
DEFINE v_observaciones VARCHAR(60);
DEFINE v_tipo CHAR(1);
DEFINE v_clave INT;
DEFINE v_texto VARCHAR(100);
DEFINE v_reg_cem VARCHAR(100);
DEFINE v_domcompleto VARCHAR(75);
DEFINE v_tipodesc VARCHAR(10);
DEFINE v_nomcem VARCHAR(60);
DEFINE v_concepto VARCHAR(250);
DEFINE v_concepto1 VARCHAR(250);
DEFINE v_imptot MONEY(15,2);
DEFINE v_periodo VARCHAR(30);
DEFINE v_axodesde INTEGER;
DEFINE v_obs VARCHAR(60);
DEFINE v_ctaapl1 INT;
DEFINE v_ctaapl2 INT;
DEFINE v_ctaapli INT;
DEFINE v_ctaaplr INT;
DEFINE v_ctaapldi INT;
DEFINE v_ctaapldr INT;
DEFINE v_ctaaplaju INT;
DEFINE v_totim MONEY(15,2);
DEFINE v_totre MONEY(15,2);
DEFINE v_totdi MONEY(15,2);
DEFINE v_totdr MONEY(15,2);
DEFINE v_cuenta INTEGER;
DEFINE v_ajuste MONEY(5,2);
DEFINE v_lError INT;
DEFINE v_lISAMError INT;
DEFINE v_vcMensaje VARCHAR(255);
DEFINE v_axohasta INT;
DEFINE v_axocont CHAR(35);
DEFINE v_axocont1 INT;
DEFINE v_cont INT;
DEFINE v_actualizacion MONEY(15,2);
DEFINE v_fecha_actual DATE;

-- ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
-- RETURN '-1',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,'', 'sp_13_datosrcm ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
-- END EXCEPTION

LET v_fecha_actual = TODAY;
--LET v_fecha_actual = '2023-07-01';
LET v_axo = YEAR(v_fecha_actual);
LET v_mes = MONTH(v_fecha_actual);
LET v_imptot = 0;
LET v_concepto = '';
LET v_concepto1 = '';
LET v_periodo = '';
LET v_obs = '';
LET v_desctot = 0;
LET v_totim = 0;
LET v_totre = 0;
LET v_totdi = 0;
LET v_totdr = 0;
LET v_ctaapli = 0;
LET v_ctaaplr = 0;
LET v_ctaapldi = 0;
LET v_ctaapldr = 0;
LET v_ctaaplaju = 0;

IF var_axo = 0 THEN
    LET var_axo = YEAR(v_fecha_actual);
END IF;
 
IF var_control > 0 THEN
    SELECT control_rcm, cementerio,cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
        clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, axo_pagado, metros, nombre, domicilio || ' ' || exterior ||' '|| interior, colonia, metros,
        CASE
            WHEN tipo = 'F' THEN 'FOSA' 
            WHEN tipo = 'G' THEN 'GAVETA' 
            WHEN tipo = 'U' THEN 'URNA'
            ELSE ''
        END
    INTO v_control, v_cementerio, v_reg_cem, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, 
        v_fosa, v_fosa_alfa, v_axo_pagado, v_metros, v_nombre, v_domcompleto, v_colonia, vpar_metros, v_tipodesc
    FROM ta_13_datosrcm WHERE control_rcm=var_control;
ELSE
    SELECT control_rcm, cementerio,cementerio || clase||' '||clase_alfa ||' '||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
        clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, axo_pagado, metros, nombre, domicilio || ' ' || exterior ||' '|| interior, colonia, metros,
    CASE WHEN tipo = 'F' THEN 'FOSA' 
        WHEN tipo = 'G' THEN 'GAVETA' 
        WHEN tipo = 'U' THEN 'URNA'
        ELSE ''
    END
    INTO v_control, v_cementerio, v_reg_cem, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, 
        v_fosa, v_fosa_alfa, v_axo_pagado, v_metros, v_nombre, v_domcompleto, v_colonia, vpar_metros, v_tipodesc
    FROM ta_13_datosrcm 
    WHERE cementerio = var_cementerio AND clase = var_clase AND clase_alfa = var_clasalf AND seccion = var_secc 
        AND seccion_alfa = var_seccalf AND linea = var_linea AND linea_alfa = var_linalf AND fosa = var_fosa AND fosa_alfa = var_fosalf;
END IF;

SELECT  nombre, cta_aplicacion, cta_vencido INTO v_nomcem, v_ctaapl1, v_ctaapl2 FROM tc_13_cementerios WHERE cementerio = v_cementerio; 

IF NOT EXISTS(SELECT * FROM ta_13_datosrcm WHERE control_rcm = v_control) THEN
    LET v_clave = -1; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
    RETURN 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,'',v_control; 
END IF;   

IF v_axo_pagado >= v_axo THEN
    LET v_clave = -2; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO PARA ESTE PERIODO';
    RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_nomcem, v_concepto, v_imptot, v_periodo, 0, 0, 0, 0, 0, '', v_control; 
END IF;

IF v_tipodesc <> 'FOSA'  THEN
    LET v_clave = -3; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO ES FOSA, NO SE PUEDE PAGAR';
    RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_nomcem, v_concepto, v_imptot, v_periodo, 0, 0, 0, 0, 0, '', v_control;
END IF;   

-- Para calcular recargos
IF NOT EXISTS (SELECT * FROM tmp_cem_norecgos WHERE control_rcm = v_control) THEN
   IF v_fecha_actual >= MDY(7, 1, 2025) THEN
      EXECUTE PROCEDURE spd_13_recargos(var_control, v_mes); -- Exencion de recargos para todo el adeudo hasta el 30 de junio de 2023
   END IF;
END IF;

SELECT MAX(axo_adeudo) INTO v_axohasta FROM ta_13_adeudosrcm WHERE control_rcm = var_control AND vigencia = 'V';

IF var_axo < v_axohasta THEN
    LET v_axohasta = var_axo;
END IF;

--IF (v_axo_pagado + 1) < (YEAR(v_fecha_actual) - 5) THEN
--    LET v_axodesde = (YEAR(v_fecha_actual) - 5);
--ELSE
    LET v_axodesde = v_axo_pagado + 1;
--END IF;

LET v_axocont = '';
LET v_cont = 0;

FOREACH 
    SELECT axo_adeudo INTO v_axocont1 FROM ta_13_adeudosrcm WHERE control_rcm = var_control AND vigencia = 'V' 
        AND axo_adeudo BETWEEN v_axodesde AND v_axohasta ORDER BY 1
    LET v_cont = v_cont + 1;
    IF v_cont = 1 THEN
        LET v_axocont = v_axocont1;
    ELSE
        LET v_axocont = TRIM(v_axocont) || ', ' || v_axocont1;
    END IF;
END FOREACH;

LET v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || v_axohasta;
LET v_concepto = 'PAGO DE MANTENIMIENTO DEL PANTEON '|| v_nomcem || ' DE: CLASE ' || v_clase ||' ' || v_clase_alfa || ' SECC. '|| v_seccion ;
LET v_concepto = TRIM(v_concepto) || ' ' || TRIM(v_seccion_alfa) || ' LINEA ' ||v_linea || ' ' || TRIM(v_linea_alfa) || ' FOSA ' || v_fosa || ' DE ' || v_metros || ' MTS.';

IF v_cont > 1 THEN
    LET v_concepto1 = 'ANUALIDADES: '|| v_axocont ||'.' ;
ELSE 
    LET v_concepto1 = 'ANUALIDAD: '|| v_axocont  ||'.';
END IF;

LET v_clave = 0; 
LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO SE PUEDE PAGAR';

IF v_axo <> var_axo THEN
    LET v_axo=var_axo;
END IF;

-- Se calcula el importe total
FOREACH 
    SELECT b.axo_adeudo, b.importe, b.importe_recargos, d.axo_descto, NVL(d.descuento,0), b.descto_impote, b.descto_recargos, NVL(b.actualizacion,0)
        INTO vpar_axo, vpar_impte, vpar_recar, v_axo_alta, v_descuento, v_impdesc, v_recardesc, v_actualizacion 	
    FROM ta_13_adeudosrcm b, ta_13_datosrcm r, OUTER ta_13_descpens d WHERE r.control_rcm = v_control 
        AND d.control_rcm = r.control_rcm AND d.axo_descto=b.axo_adeudo AND d.vigencia = 'V' 
        AND b.control_rcm = r.control_rcm AND b.axo_adeudo BETWEEN v_axodesde AND v_axo
    ORDER BY 1

    LET v_desctot = 0;
    LET v_desctotre = 0;
    IF  v_impdesc > 0 THEN
    LET v_obs = 'Desc Pensionado 50%';
    END IF;
    --se aplica descuento de pesionado
    IF ((v_mes >= 1)  AND (v_mes <=2) AND (vpar_axo=YEAR(v_fecha_actual))) THEN
    IF  v_impdesc=0 THEN
    LET v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
    LET v_obs=v_obs||' Incluye 10% Desc por pronto pago ';
    END IF;
    END IF;

    LET v_desctot  =  v_impdesc;
    LET v_desctotre  =   v_recardesc;
    LET v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) + v_actualizacion;
    LET v_totim = (v_totim + vpar_impte); 
    LET v_totre = (v_totre + vpar_recar); 
    LET v_totdi = (v_totdi + v_desctot); 
    LET v_totdr = (v_totdr + v_desctotre); 
END FOREACH;

IF v_imptot = 0 THEN
    LET v_clave = -4; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO PARA ESTE PERIODO';
    RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_concepto1, v_concepto, v_imptot, v_periodo, 0, 0, 0, 0, 0, '', v_control; 
END IF;

-- Regresa los datos de encabezado
-- EXECUTE PROCEDURE catastro_gdl:redondeocaja(v_imptot) INTO v_imptot, v_ajuste; 
EXECUTE PROCEDURE spd_redondeokiosco(v_imptot) INTO v_ctaaplaju, v_ajuste;
LET v_totdi = (v_totdi * -1); 
LET v_totdr = (v_totdr * -1);
LET v_imptot = v_imptot + v_ajuste;

RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_concepto1, v_concepto, v_imptot, v_periodo, v_totim, v_totre, v_totdi, v_totdr, v_ajuste, v_obs, v_control;

END function;

CREATE FUNCTION "informix".kio13_datosenc(var_control INTEGER, var_axo INT)

RETURNING CHAR(1) AS slinea, INT AS sclave, VARCHAR(100) AS scomentario, VARCHAR(100) AS sregcomp,
    VARCHAR(60) AS snombre, VARCHAR(75) AS sdomcomp, VARCHAR(30)AS scol,VARCHAR(10) AS stdesc, dec(5,3) AS smetros,
    VARCHAR(60) AS snomcem, VARCHAR(250) AS sconcepto, MONEY(15,2) AS simptot,VARCHAR(30) AS speriodo,
    MONEY(15,2) AS simporte, MONEY(15,2) AS srecargo, MONEY(15,2) AS sdesctoimp,MONEY(15,2) AS sdesctorec,
    MONEY(15,2) AS sajuste, VARCHAR(60)AS sobserv, INT AS control;

-- se incrementa el beneficio de la condinacion de los recargos si paga todo el adeudo hasta el a�o actual 02/01/2025

DEFINE v_uap INTEGER;
DEFINE v_control INTEGER;
DEFINE v_axo INTEGER;
DEFINE v_mes SMALLINT;
DEFINE vpar_axo INTEGER;
DEFINE vpar_impte MONEY(15,2);
DEFINE vpar_metros dec(5,3);
DEFINE vpar_recar MONEY(15,2);
DEFINE v_axo_alta INTEGER;
DEFINE v_descuento INTEGER; 
DEFINE v_impdesc MONEY(15,2);
DEFINE v_recardesc MONEY(15,2);
DEFINE v_desctot MONEY(15,2);
DEFINE v_desctotre MONEY(15,2);
DEFINE var_cem CHAR(1);
DEFINE v_porc_global DECIMAL(5,3);
DEFINE v_cementerio CHAR(1);
DEFINE v_clase SMALLINT;
DEFINE v_clase_alfa VARCHAR(10);
DEFINE v_seccion SMALLINT;
DEFINE v_seccion_alfa VARCHAR(10);
DEFINE v_linea SMALLINT;
DEFINE v_linea_alfa VARCHAR(20);
DEFINE v_fosa SMALLINT;
DEFINE v_fosa_alfa VARCHAR(20);
DEFINE v_axo_pagado INTEGER;
DEFINE v_metros DECIMAL(5,3);
DEFINE v_nombre VARCHAR(60) ;
DEFINE v_colonia VARCHAR(30);
DEFINE v_observaciones VARCHAR(60);
DEFINE v_tipo CHAR(1);
DEFINE v_clave INT;
DEFINE v_texto VARCHAR(100);
DEFINE v_reg_cem VARCHAR(100);
DEFINE v_domcompleto VARCHAR(75);
DEFINE v_tipodesc VARCHAR(10);
DEFINE v_nomcem VARCHAR(60);
DEFINE v_concepto VARCHAR(250);
DEFINE v_concepto1 VARCHAR(250);
DEFINE v_imptot MONEY(15,2);
DEFINE v_periodo VARCHAR(30);
DEFINE v_axodesde INTEGER;
DEFINE v_obs VARCHAR(60);
DEFINE v_ctaapl1 INT;
DEFINE v_ctaapl2 INT;
DEFINE v_ctaapli INT;
DEFINE v_ctaaplr INT;
DEFINE v_ctaapldi INT;
DEFINE v_ctaapldr INT;
DEFINE v_ctaaplaju INT;
DEFINE v_totim MONEY(15,2);
DEFINE v_totre MONEY(15,2);
DEFINE v_totdi MONEY(15,2);
DEFINE v_totdr MONEY(15,2);
DEFINE v_cuenta INTEGER;
DEFINE v_ajuste MONEY(5,2);
DEFINE v_lError INT;
DEFINE v_lISAMError INT;
DEFINE v_vcMensaje VARCHAR(255);
DEFINE v_axohasta INT;
DEFINE v_axocont CHAR(35);
DEFINE v_axocont1 INT;
DEFINE v_cont INT;
DEFINE v_actualizacion MONEY(15,2);
DEFINE v_fecha_actual DATE;

-- ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
-- RETURN '-1',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,'', 'sp_13_datosrcm ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
-- END EXCEPTION

LET v_fecha_actual = TODAY;
--LET v_fecha_actual = '2023-07-01';
LET v_axo = YEAR(v_fecha_actual);
LET v_mes = MONTH(v_fecha_actual);
LET v_imptot = 0;
LET v_concepto = '';
LET v_concepto1 = '';
LET v_periodo = '';
LET v_obs = '';
LET v_desctot = 0;
LET v_totim = 0;
LET v_totre = 0;
LET v_totdi = 0;
LET v_totdr = 0;
LET v_ctaapli = 0;
LET v_ctaaplr = 0;
LET v_ctaapldi = 0;
LET v_ctaapldr = 0;
LET v_ctaaplaju = 0;

IF var_axo = 0 THEN
    LET var_axo = YEAR(v_fecha_actual);
END IF;
 
IF var_control > 0 THEN
    SELECT control_rcm, cementerio,cementerio ||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| clase||' '||clase_alfa ||' '|| fosa||' '||fosa_alfa,
        clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, axo_pagado, metros, nombre, domicilio || ' ' || exterior ||' '|| interior, colonia, metros,
        CASE
            WHEN tipo = 'F' THEN 'FOSA' 
            WHEN tipo = 'G' THEN 'GAVETA' 
            WHEN tipo = 'U' THEN 'URNA'
            ELSE ''
        END
    INTO v_control, v_cementerio, v_reg_cem, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, 
        v_fosa, v_fosa_alfa, v_axo_pagado, v_metros, v_nombre, v_domcompleto, v_colonia, vpar_metros, v_tipodesc
    FROM ta_13_datosrcm WHERE control_rcm=var_control;
ELSE
    SELECT control_rcm, cementerio,cementerio || clase||' '||clase_alfa ||' '||' '||seccion||' '||seccion_alfa ||' '|| linea ||' '|| linea_alfa ||' '|| fosa||' '||fosa_alfa,
        clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, axo_pagado, metros, nombre, domicilio || ' ' || exterior ||' '|| interior, colonia, metros,
    CASE WHEN tipo = 'F' THEN 'FOSA' 
        WHEN tipo = 'G' THEN 'GAVETA' 
        WHEN tipo = 'U' THEN 'URNA'
        ELSE ''
    END
    INTO v_control, v_cementerio, v_reg_cem, v_clase, v_clase_alfa, v_seccion, v_seccion_alfa, v_linea, v_linea_alfa, 
        v_fosa, v_fosa_alfa, v_axo_pagado, v_metros, v_nombre, v_domcompleto, v_colonia, vpar_metros, v_tipodesc
    FROM ta_13_datosrcm 
    WHERE cementerio = var_cementerio AND clase = var_clase AND clase_alfa = var_clasalf AND seccion = var_secc 
        AND seccion_alfa = var_seccalf AND linea = var_linea AND linea_alfa = var_linalf AND fosa = var_fosa AND fosa_alfa = var_fosalf;
END IF;

SELECT  nombre, cta_aplicacion, cta_vencido INTO v_nomcem, v_ctaapl1, v_ctaapl2 FROM tc_13_cementerios WHERE cementerio = v_cementerio; 

IF NOT EXISTS(SELECT * FROM ta_13_datosrcm WHERE control_rcm = v_control) THEN
    LET v_clave = -1; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
    RETURN 'E',v_clave,v_texto,v_reg_cem,v_nombre,v_domcompleto,v_colonia,v_tipodesc,vpar_metros,v_nomcem,v_concepto,v_imptot,v_periodo,0,0,0,0,0,'',v_control; 
END IF;   

IF v_axo_pagado >= v_axo THEN
    LET v_clave = -2; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO PARA ESTE PERIODO';
    RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_nomcem, v_concepto, v_imptot, v_periodo, 0, 0, 0, 0, 0, '', v_control; 
END IF;

IF v_tipodesc <> 'FOSA'  THEN
    LET v_clave = -3; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO ES FOSA, NO SE PUEDE PAGAR';
    RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_nomcem, v_concepto, v_imptot, v_periodo, 0, 0, 0, 0, 0, '', v_control;
END IF;   

-- Para calcular recargos
if (var_axo = year(v_fecha_actual) and v_fecha_actual < mdy(7,1,2025)) or (v_fecha_actual >= mdy(7,1,2025)) then
   IF NOT EXISTS (SELECT * FROM tmp_cem_norecgos WHERE control_rcm = v_control) THEN
  -- IF v_fecha_actual >= MDY(7, 1, 2025) THEN
      update ta_13_adeudosrcm set importe_recargos= 0, descto_recargos = 0 where control_rcm=v_control and vigencia='V' and (id_pago is null or id_pago=0) and axo_adeudo<year(today);
    else
      EXECUTE PROCEDURE spd_13_recargos(var_control, v_mes); -- Exencion de recargos para todo el adeudo hasta el 30 de junio de 2023
    END IF;
else
   EXECUTE PROCEDURE spd_13_recargos(var_control, v_mes); -- Exencion de recargos para todo el adeudo hasta el 30 de junio de 2023
END IF;

SELECT MAX(axo_adeudo) INTO v_axohasta FROM ta_13_adeudosrcm WHERE control_rcm = var_control AND vigencia = 'V';

IF var_axo < v_axohasta THEN
    LET v_axohasta = var_axo;
END IF;

--IF (v_axo_pagado + 1) < (YEAR(v_fecha_actual) - 5) THEN
--    LET v_axodesde = (YEAR(v_fecha_actual) - 5);
--ELSE
    LET v_axodesde = v_axo_pagado + 1;
--END IF;

LET v_axocont = '';
LET v_cont = 0;

FOREACH 
    SELECT axo_adeudo INTO v_axocont1 FROM ta_13_adeudosrcm WHERE control_rcm = var_control AND vigencia = 'V' 
        AND axo_adeudo BETWEEN v_axodesde AND v_axohasta ORDER BY 1
    LET v_cont = v_cont + 1;
    IF v_cont = 1 THEN
        LET v_axocont = v_axocont1;
    ELSE
        LET v_axocont = TRIM(v_axocont) || ', ' || v_axocont1;
    END IF;
END FOREACH;

LET v_periodo = 'DESDE 1 ' || v_axodesde || ' HASTA 12 ' || v_axohasta;
LET v_concepto = 'PAGO DE MANTENIMIENTO DEL PANTEON '|| v_nomcem || ' DE: CLASE ' || v_clase ||' ' || v_clase_alfa || ' SECC. '|| v_seccion ;
LET v_concepto = TRIM(v_concepto) || ' ' || TRIM(v_seccion_alfa) || ' LINEA ' ||v_linea || ' ' || TRIM(v_linea_alfa) || ' FOSA ' || v_fosa || ' DE ' || v_metros || ' MTS.';

IF v_cont > 1 THEN
    LET v_concepto1 = 'ANUALIDADES: '|| v_axocont ||'.' ;
ELSE 
    LET v_concepto1 = 'ANUALIDAD: '|| v_axocont  ||'.';
END IF;

LET v_clave = 0; 
LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO SE PUEDE PAGAR';

IF v_axo <> var_axo THEN
    LET v_axo=var_axo;
END IF;

-- Se calcula el importe total
FOREACH 
    SELECT b.axo_adeudo, b.importe, b.importe_recargos, d.axo_descto, NVL(d.descuento,0), b.descto_impote, b.descto_recargos, NVL(b.actualizacion,0)
        INTO vpar_axo, vpar_impte, vpar_recar, v_axo_alta, v_descuento, v_impdesc, v_recardesc, v_actualizacion 	
    FROM ta_13_adeudosrcm b, ta_13_datosrcm r, OUTER ta_13_descpens d WHERE r.control_rcm = v_control 
        AND d.control_rcm = r.control_rcm AND d.axo_descto=b.axo_adeudo AND d.vigencia = 'V' 
        AND b.control_rcm = r.control_rcm AND b.axo_adeudo BETWEEN v_axodesde AND v_axo
    ORDER BY 1

    LET v_desctot = 0;
    LET v_desctotre = 0;
    IF  v_impdesc > 0 THEN
    LET v_obs = 'Desc Pensionado 50%';
    END IF;
    --se aplica descuento de pesionado
    IF ((v_mes >= 1)  AND (v_mes <=2) AND (vpar_axo=YEAR(v_fecha_actual))) THEN
    IF  v_impdesc=0 THEN
    LET v_impdesc   =v_impdesc + trunc(((vpar_impte-v_impdesc) * 0.1),2);
    LET v_obs=v_obs||' Incluye 10% Desc por pronto pago ';
    END IF;
    END IF;

    LET v_desctot  =  v_impdesc;
    LET v_desctotre  =   v_recardesc;
    LET v_imptot = (v_imptot + vpar_impte + vpar_recar) - (v_desctot+v_desctotre) + v_actualizacion;
    LET v_totim = (v_totim + vpar_impte); 
    LET v_totre = (v_totre + vpar_recar); 
    LET v_totdi = (v_totdi + v_desctot); 
    LET v_totdr = (v_totdr + v_desctotre); 
END FOREACH;

IF v_imptot = 0 THEN
    LET v_clave = -4; 
    LET v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO PARA ESTE PERIODO';
    RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_concepto1, v_concepto, v_imptot, v_periodo, 0, 0, 0, 0, 0, '', v_control; 
END IF;

-- Regresa los datos de encabezado
-- EXECUTE PROCEDURE catastro_gdl:redondeocaja(v_imptot) INTO v_imptot, v_ajuste; 
EXECUTE PROCEDURE spd_redondeokiosco(v_imptot) INTO v_ctaaplaju, v_ajuste;
LET v_totdi = (v_totdi * -1); 
LET v_totdr = (v_totdr * -1);
LET v_imptot = v_imptot + v_ajuste;

RETURN 'E', v_clave, v_texto, v_reg_cem, v_nombre, v_domcompleto, v_colonia, v_tipodesc, vpar_metros, v_concepto1, v_concepto, v_imptot, v_periodo, v_totim, v_totre, v_totdi, v_totdr, v_ajuste, v_obs, v_control;

END function;

CREATE FUNCTION "pgcabrer".spd_11_calc_actualizacionpbc(p_axo int, p_mes int, p_renta money(18,2))
returning  money(18,2) as actualizacion;

define v_actualizacion, v_fact_actual money(18,2);

let v_actualizacion=0;
let v_fact_actual=0;

-- petici�n por correo de Nacho autorizado por la Tesorera de fecha 13/11/2020
if p_axo<=2018 then
   let p_axo=2019;
   let p_mes=1;
end if;

if exists (select * from ta_12_parametros where calc_actualizacion_merc='S') then
   execute function catastro_gdl:fn_actualizacion(p_axo, p_mes, p_renta, 0) into v_fact_actual;
   let v_actualizacion =  v_fact_actual - p_renta ; 
--   if  v_actualizacion < 0 or p_mes > month(today) or today <= (p_axo || '-' || p_mes || '-5' ) then
   if  v_actualizacion < 0  then
       let v_actualizacion = 0;
   end if;
end if; 

return v_actualizacion;

end function;

CREATE FUNCTION "pgcabrer".spd_11_calc_actualizacion(p_axo int, p_mes int, p_renta money(18,2))
returning  money(18,2) as actualizacion;

define v_actualizacion, v_fact_actual money(18,2);

let v_actualizacion=0;
let v_fact_actual=0;

-- petici�n por correo de Nacho autorizado por la Tesorera de fecha 13/11/2020
if p_axo<=2018 then
   let p_axo=2019;
   let p_mes=1;
end if;

if exists (select * from ta_12_parametros where calc_actualizacion_merc='S') then
   execute function catastro_gdl:fn_actualizacion(p_axo, p_mes, p_renta) into v_fact_actual;
   let v_actualizacion =  v_fact_actual - p_renta ; 
--   if  v_actualizacion < 0 or p_mes > month(today) or today <= (p_axo || '-' || p_mes || '-5' ) then
   if  v_actualizacion < 0  then
       let v_actualizacion = 0;
   end if;
end if; 

return v_actualizacion;

end function;

CREATE FUNCTION "informix".calc_actualizacion_aseo(p_axo int , p_mes int , p_importe money(16,2))
RETURNING money(16,2) as actualizacion;
   define  v_fact_actual        money(16,2);
   define  v_actualizacion      money(16,2);
   define  v_mes              int;
   define  v_axo              int;

   let v_mes=p_mes;
   let v_axo=p_axo;
   if p_axo<=2018 then
      let v_axo=2019;
      let v_mes=1;
   end if;
    
   execute procedure catastro_gdl:fn_actualizacion(v_axo , v_mes  ,p_importe) into v_fact_actual ;
   let v_actualizacion =  v_fact_actual - p_importe ; 
   if v_actualizacion < 0 then
      let v_actualizacion = 0;
   end if;
  -- if v_axo=year(today) then
  --    let v_actualizacion = 0;  
  -- end if;      
  RETURN  v_actualizacion  ;
  
END function;

CREATE PROCEDURE "pgcabrer".spd_13_constot(var_control integer, var_axo int)
                 returning  char(1) as slinea, int as sclave, 
                 money(15,2) as stotal,  int as sctaapli,varchar(60)as sobserv;

define v_uap    integer;
define v_control    integer;
define v_axo    integer;
define v_mes   smallint;
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define v_axo_alta integer;
define v_descuento INTEGER; 
define v_impdesc money(15,2);
define v_recardesc  money(15,2);
define v_desctot  money(15,2);
define v_desctotre  money(15,2);
define v_actualizacion money(15,2);
define v_totactualizacion money(15,2);
define var_cem char(1);
define v_porc_global DECIMAL(5,3);
define  v_cementerio CHAR(1);
define  v_axo_pagado INTEGER;
define  v_observaciones VARCHAR(60);
define  v_tipo CHAR(1);
define  v_vigencia CHAR(1);
define  v_clave int;
define  v_texto   varchar(100);
define  v_concepto varchar(250);
define  v_nomcem VARCHAR(60);
define  v_imptot money(15,2);
define  v_periodo varchar(30);
define  v_axodesde    integer;
define  v_obs varchar(60);
define v_ctaapl1     int;
define v_ctaapl2     int;
define  v_totim money(15,2);
define  v_totre money(15,2);
define  v_totimac money(15,2);
define  v_totreac money(15,2);

define v_cuenta integer;
define v_ctaapli integer;
define v_ctaapla integer;
define v_ctaaplr integer;
define v_ctadescto integer;
define v_ctaact integer;
define v_ajuste money(15,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);



let v_axo=year(today);
let v_mes=month(today);
--let v_mes=2;
let v_imptot=0;
let v_concepto = '';
let v_periodo='';
let v_desctot = 0;
let v_desctotre = 0;

let  v_totim=0;
let  v_totre=0;
let  v_totimac=0;
let  v_totreac=0;
let  v_totactualizacion=0;

if (var_axo < year(today) and today < mdy(7,1,2025)) or (today >= mdy(7,1,2025)) 
   or (var_control in (100033, 125252, 114755))  then
   if var_control not in (47645, 39418) then
      EXECUTE PROCEDURE spd_13_recargos(var_control, MONTH(today));
   else
    --EXECUTE PROCEDURE spd_13_recargos(var_control, MONTH(today));
      update ta_13_adeudosrcm set importe_recargos= 0, descto_recargos = 0 where control_rcm=var_control and vigencia='V' and (id_pago is null or id_pago=0) and axo_adeudo<year(today);
   end if;
else
   if var_control not in (select control_rcm from tmp_cem_norecgos) then -- 02/07/2023
    --EXECUTE PROCEDURE spd_13_recargos(v_control, MONTH(today));
   update ta_13_adeudosrcm set importe_recargos= 0, descto_recargos = 0 where control_rcm=var_control and vigencia='V' and (id_pago is null or id_pago=0) and axo_adeudo<year(today);
    else
    EXECUTE PROCEDURE spd_13_recargos(var_control, MONTH(today));
  end if;
end if;

--EXECUTE PROCEDURE spd_13_recargos(var_control, month(today)); -- anterior sin la rutina de arriba

select control_rcm, cementerio,axo_pagado, vigencia
into v_control, v_cementerio,v_axo_pagado,v_vigencia
from ta_13_datosrcm where control_rcm=var_control;

select  nombre, cta_aplicacion, cta_vencido, cta_descto, cta_actualizacion
into v_nomcem,v_ctaapl1,v_ctaapl2, v_ctadescto , v_ctaact
from tc_13_cementerios where cementerio=v_cementerio;

if not exists(select * from ta_13_datosrcm where control_rcm=v_control) then
   let v_clave = 1; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO EXISTE';
   return 'T',v_clave,0,0,v_texto; 
end if;      
if v_axo_pagado=v_axo  then
   let v_clave = 2; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO NO TIENE ADEUDO';
   return 'T',v_clave,0,0,v_texto; 
end if;     
if v_vigencia='B'  then
   let v_clave = 3; 
   let v_texto = 'EL NUMERO DE CONTROL DE CEMENTERIO ESTA DADO DE BAJA';
   return 'T',v_clave,0,0,v_texto; 
end if;     
if (v_axo_pagado + 1) < (v_axo - 5) then
   let v_axodesde = v_axo - 5;
else
   let v_axodesde = v_axo_pagado + 1;
end if;
let v_clave = 0; 

---Para calcular el importe total
foreach 
select b.axo_adeudo, case when b.axo_adeudo =year(today) then v_ctaapl1 
        else v_ctaapl2 end,b.importe, b.importe_recargos, nvl((b.descto_impote),0),nvl((b.descto_recargos),0),nvl(b.actualizacion,0)
        into vpar_axo,v_cuenta, vpar_impte, vpar_recar,v_impdesc,v_recardesc,v_actualizacion 	
        from ta_13_adeudosrcm b, ta_13_datosrcm r where r.control_rcm=v_control and
             b.control_rcm=r.control_rcm and b.axo_adeudo between v_axodesde and var_axo and b.vigencia='V'  
        order by 1
 
     if ((v_mes >= 1)  and (v_mes <=2) and (v_cuenta=v_ctaapl1)) then
        if v_impdesc=0 then
           let v_impdesc  = trunc(((vpar_impte) * 10/100),2);
        end if;
     end if;
     
     if vpar_axo<v_axo then
        let v_totim = (v_totim + vpar_impte); 
        let v_totre = (v_totre + vpar_recar); 
        let v_desctot = (v_desctot + v_impdesc); 
        let v_desctotre = (v_desctotre + v_recardesc); 
        let v_totactualizacion = v_totactualizacion + v_actualizacion;
        let v_ctaapli=v_cuenta;
     else   
        let v_totimac = (v_totimac + vpar_impte); 
        let v_totreac = (v_totreac + vpar_recar); 
        let v_desctot = (v_desctot + v_impdesc); 
        let v_desctotre = (v_desctotre + v_recardesc); 
        let v_totactualizacion = v_totactualizacion + v_actualizacion;
        let v_ctaapla=v_cuenta;
     end if;
  if vpar_axo=var_axo then
     if v_totim>0 then
        let v_obs = 'Mantenimiento Rezago '||v_nomcem;
        let v_imptot = v_imptot+v_totim; 
        return 'T',v_clave, v_totim,v_ctaapli, v_obs with resume; 
     end if;   
     
    if v_totre>0 then
       let v_ctaaplr=390300000;
       let v_obs = 'Recargos Rezago ';
       let v_imptot = v_imptot+v_totre; 
       return 'T',v_clave, v_totre,v_ctaaplr, v_obs with resume; 
    end if;   

    if v_totimac>0 then
       let v_obs = 'Mantenimiento '||v_nomcem;
       let v_imptot = v_imptot+v_totimac; 
       return 'T',v_clave, vpar_impte, v_ctaapla, v_obs with resume;    
    end if;

    if v_totreac>0 then
       let v_ctaaplr=390300000;
       let v_obs = 'Recargos ';
       let v_imptot = v_imptot+v_totreac; 
      return 'T',v_clave, v_totreac,v_ctaaplr, v_obs with resume; 
    end if; 
    if v_desctot>0 then
       let v_ctaaplr=v_ctadescto;
       let v_obs = 'Descto Imp ';
       let v_imptot = v_imptot-v_desctot; 
      return 'T',v_clave, (v_desctot*-1),v_ctaaplr, v_obs with resume; 
    end if; 
    if v_desctotre>0 then
       let v_ctaaplr=v_ctadescto;
       let v_obs = 'Descto Rec ';
       let v_imptot = v_imptot-v_desctotre; 
      return 'T',v_clave, (v_desctotre*-1),v_ctaaplr, v_obs with resume; 
    end if; 
    if v_totactualizacion>0 then
       let v_obs = 'Actualizacion ';
       let v_imptot = v_imptot+v_totactualizacion; 
      return 'T',v_clave, v_totactualizacion,v_ctaact, v_obs with resume; 
    end if; 
  
 end if; 
end foreach;

  
    return 'T',v_clave, v_imptot,0, 'TOTAL GENERAL'; 

    execute procedure catastro_gdl:redondeocaja(v_imptot) into v_imptot, v_ajuste; 
     if v_ajuste <> 0 then    
        return 'T',v_clave, v_ajuste, 550800000,'AJUSTE ARTICULO 14 LEY DE INGRESOS '; 
     end if;
    return 'T',v_clave, (v_imptot+v_ajuste),0, 'TOTAL GENERAL'; 
end procedure;

CREATE PROCEDURE "pgcabrer".cob34_gdatosg_02 ( par_Tabla Char(1), par_Control Char(15) )
{######################################################################
#  Procedimiento:    cob34_gdatosg_02
#  Descripcion:      Interfaz de CONSULTA del registro de control en OTRAS OBLIGACIONES por modulo
#
#  Parametros        	par_tabla	= Rubro de Ingreso
#			par_Control	= Control del registro
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:              
#
#  Llamado por:      Procedimiento llamado por el modulo
#  Llama a:          
#  
######################################################################}

	returning	Integer as Status,
		VarChar(200) as Concepto_status,
		Integer as Id_Datos,
		Char(15) as Control,
                               	VarChar(200) as Concesionario,
                               	VarChar(200) as Ubicacion,
                               	VarChar(200) as NomComercial,
                               	VarChar(200) as Lugar,
                               	VarChar(200) as Obs,
                               	VarChar(200) as Adicionales,
		VarChar(50) as StatusRegistro,
		VarChar(100) as Unidades,
		Char(15) as Categoria,
		Char(10) as Seccion,
		Char(10) as Bloque,
		Char(1) as Sector,
                               	Decimal(7,2) as Superficie,
		Date as FechaInicio,
		Date as FechaFin,
                               	Integer as Recaudadora,
                               	Integer as Zona,
                               	Integer as Licencia,
                               	Integer as Giro,
		VarChar(50) as tipoObligacion;

--**********************************************************************************************
  define v_id_34_datos, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro		Integer;
  define v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs		VarChar(200);
  define v_superficie								Decimal(7,2);
  define v_fecha_inicio, v_fecha_fin						Date;
  define v_sector								Char(1);
  define v_status, v_tipoObligacion						VarChar(50);
  define v_unidades 							VarChar(100);
  define v_categoria 							Char(15);
  define v_control, v_seccion, v_bloque 						Char(10);

--************************************************************************

Let v_id_34_datos = 0;
Let v_id_recaudadora = 0;
Let v_id_zona = 0;
Let v_licencia = 0;
Let v_id_giro = 0;
Let v_superficie = 0;

Let v_concesionario = '';
Let v_ubicacion = '';
Let v_nom_comercial = '';
Let v_lugar = '';
Let v_obs = '';
Let v_sector = '';
Let v_status = '';
Let v_unidades = '';
Let v_categoria = '';
Let v_control = '';
Let v_seccion = '';
Let v_bloque = '';
Let v_tipoObligacion = '';

Let v_fecha_inicio = mdy(01,01,1900);
Let v_fecha_fin = mdy(01,01,1900);

if exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
                SELECT a.id_34_datos, a.control, a.concesionario, a.ubicacion, (z.descripcion) status, (f.descripcion) unidades, a.sector, a.superficie, a.fecha_inicio, a.fecha_fin, 
	a.id_recaudadora, a.id_zona, a.licencia

	INTO v_id_34_datos, v_control, v_concesionario, v_ubicacion, v_status, v_unidades, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, 
	v_id_recaudadora, v_id_zona, v_licencia

	FROM t34_datos A, t34_status Z, t34_unidades F
	WHERE a.cve_tab = par_Tabla and a.control = par_Control
	AND Z.id_34_stat = A.id_stat
	AND F.id_34_unidad = A.id_unidad;

	SELECT (a.concepto) nom_comercial  INTO  v_nom_comercial  FROM t34_conceptos a, t34_status b 
	where a.id_datos = v_id_34_datos and a.tipo = 'N'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

	SELECT (a.concepto) lugar  INTO  v_lugar  FROM t34_conceptos a, t34_status b 
	where a.id_datos = v_id_34_datos and a.tipo = 'L'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

	SELECT (a.concepto) obs  INTO  v_obs  FROM t34_conceptos a, t34_status b 
	where a.id_datos = v_id_34_datos and a.tipo = 'O'  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

	SELECT a.categoria, a.seccion, a.bloque INTO v_categoria, v_seccion, v_bloque  FROM t34_adicionales a, t34_status b 
	WHERE a.id_datos = v_id_34_datos  and b.id_34_stat = a.id_stat and b.cve_stat = 'V';

	if v_licencia > 0 then
		if exists( SELECT * FROM catastro_gdl:licencias where licencia = v_licencia ) then
			SELECT id_giro INTO v_id_giro  FROM catastro_gdl:licencias where licencia = v_licencia;
		else
			Let v_id_giro = 0;
		end if;
	else
		Let v_id_giro = 0;
	end if;
	
	SELECT tipo_Obligacion INTO v_tipoObligacion FROM t34_ctasaplic WHERE cve_tab = par_Tabla AND tipo_var = 'T';
	
	if (v_status = 'VIGENTE') OR (v_status = 'SUSPENDIDO') then
		RETURN 1, 'Encontro el registro', v_id_34_datos, par_Control, v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs, Null, v_status, v_unidades, v_categoria, 
		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion	with resume;
	else
		RETURN -1, 'Encontro el registro pero no esta VIGENTE', v_id_34_datos, par_Control, v_concesionario, v_ubicacion, v_nom_comercial, v_lugar, v_obs, Null, v_status, v_unidades, v_categoria, 
		v_seccion, v_bloque, v_sector, v_superficie, v_fecha_inicio, v_fecha_fin, v_id_recaudadora, v_id_zona, v_licencia, v_id_giro, v_tipoObligacion	with resume;
	end if;
else
	RETURN -1, 'No se encontro registro con tal dato', Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null	with resume;
end if;
                                          
end procedure;

CREATE FUNCTION "informix".admin_adeudos_detalle_25odoo  ( par_Tabla Char(2), par_Control Char(10), pref varchar(20) )
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_25
#  Descripcion:      Interfaz de consulta de detalle para el cobro de OTRAS OBLIGACIONES en el sistema ADMIN
#
#  Parametros par_Tabla     = Rubro de ingreso
#  de entrada:      par_Control   = Dato de Control del registro
#                   pref   = Hasta el periodo requerido    ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  en db_ingresos 
######################################################################}
returning  Integer as Rubro,
Integer as Concepto,
Integer as Cuenta_Aplicacion,
VarChar(30) as Referencia,
VarChar(120) as Descripcion,
Money(12,2) as Monto,
Money(12,2) as Acumulado;

define v_tipo_var 																			Char(1);              
define v_id_34_datos, v_id_control_req                                                      Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas    Money(12,2);
define v_porcentaje_multa                                                                   Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           Money(12,2);
define v_aso_mes_pago                                                                       Date;
define v_Axo, v_Mes, Axo_v, Mes_v, Dia_v, v_axo_inicio, v_mes_inicio                        Integer;
define v_mensaje_proc                                                                       varchar(255);
define v_Periodo_CN, v_Periodo_EXE, v_refSUS                                                varchar(7);
define v_contador                                                                           Smallint;
define v_ref 																				char(7);
--****************************************************************************************************************************************** ctas de aplicacion
define v_cta_multas, v_cta_dscto_multas, v_cta_gastos                                       Integer;
define v_cta_adeudos_act, v_cta_adeudos_dev, v_cta_adeudos_reza                             Integer;
define v_cta_exced_act, v_cta_exced_dev, v_cta_exced_reza                                   Integer;
define v_cta_rcgos_ade, v_cta_rcgos_exced,v_cta_multa_ade,v_cta_dcto_multa_ade              Integer;
define v_cta_dcto_rcgos_ade, v_cta_dcto_rcgos_exced                                         Integer;
define v_tipo_obligacion                                                                    Char(50);
define v_concepto                                                                           VarChar(100);
define perioI 						integer;
define v_actualizacion 					decimal(18,2);
--******************************************************************************************************************************************
-- adicionado 18/12/2019 para obtener id de rubro de ingreso
define v_id_unidad int;
define v_cve_unidad, v_cve_operatividad char(1);
define v_descripcion varchar(100);

begin
    on exception in (-958)
delete from tmp_total_otras_oblig;
    end exception;
create temp table tmp_total_otras_oblig( rubro int, concepto int, cuenta int, referencia varchar(30), descripcion varchar(120),
				  monto money(14,2), acumulado money(14,2)) with no log;
end;

begin
    on exception in (-958)
delete from tmp_detalle_otras_oblig;
    end exception;
create temp table tmp_detalle_otras_oblig( control_contrato int, aso_mes_pago char(7), ctrol_operacion int, tipo_movto char(1) ) with no log;
end;


SELECT 	Year(fechalimite), Month(fechalimite), Day(fechalimite)  
INTO 	Axo_v, Mes_v, Dia_v
FROM 	t34_fechalimite
WHERE 	cve_tab = par_tabla
AND 	Month(fechalimite) = Month(Current)  
AND 	Year(fechalimite) = Year(Current);

if 	Day(Current) <= Dia_v then
	if 	Mes_v = 1 then
		Let Mes_v = 12;
        Let Axo_v = Axo_v - 1;
    else
        Let Mes_v = Mes_v - 1;
    end if;
End if;

EXECUTE PROCEDURE con34_glperiodo ( par_tabla ) INTO v_Periodo_CN;  

if 	trim(pref)='' then
    let v_ref=year(today)|| '-' ||'12';
--	let v_ref=9999 || '-' || 12;
else
	let v_ref=substr(pref,1,4) || '-' || substr(pref,6,2);
End if;

let 	v_id_34_datos = 0;
Let 	v_id_unidad = 0;
let     v_refSUS='';

if 	exists( SELECT * FROM t34_datos WHERE cve_tab = par_Tabla  AND control = par_Control ) then
    SELECT 	a.id_34_datos, a.id_unidad  
	INTO 	v_id_34_datos, v_id_unidad  
	FROM 	t34_datos A    
	WHERE 	a.cve_tab = par_Tabla 
	AND  	a.control = par_Control;

    -- verifica si tiene suspensi�n de servicio
    if exists(select * from t34_suspensiones WHERE id_contrato = v_id_34_datos and estado='S') then
       SELECT 	axo_inicio, mes_inicio iNTO v_axo_inicio, v_mes_inicio fROM t34_suspensiones WHERE id_contrato = v_id_34_datos and estado='S';
       if v_mes_inicio = 1 then
          let v_refSUS=(v_axo_inicio - 1) || '-' || 12;
       else
          let v_refSUS=v_axo_inicio || '-' || (v_mes_inicio - 1);
       end if;
       if v_refSUS < v_ref then
	      Let v_ref = v_refSUS;
       end if;
    end if;

	-- OBTENER EL RUBRO DE INGRESO
	Let v_cve_unidad 		= '';
	Let v_cve_operatividad 	= '';
	Let v_descripcion 		= '';
	SELECT 	cve_unidad, cve_operatividad, descripcion 
	INTO 	v_cve_unidad, v_cve_operatividad, v_descripcion  
	FROM 	t34_unidades  
	WHERE 	id_34_unidad = v_id_unidad;

    -- VARIABLES A 0
    Let v_concepto = '';
    Let v_cta_multas = 0;
    Let v_cta_dscto_multas = 0;
    Let v_cta_gastos = 0;
    Let v_cta_adeudos_act = 0;
    Let v_cta_adeudos_dev = 0;
    Let v_cta_adeudos_reza = 0;
    Let v_cta_rcgos_ade = 0;
    Let v_cta_dcto_rcgos_ade = 0;
    Let	v_actualizacion = 0;

    Let v_tipo_var = '';
    Let v_tot_multas = 0;
    Let v_porcentaje_multa = 0;
    Let v_tot_dscto_multas = 0;

    Let v_importe_multa = 0;
    Let v_importe_gastos = 0;
    Let v_tot_gastos = 0;
    Let v_acumulado = 0;
    Let v_importe = 0;
    Let v_Importe_recargo = 0;
    Let v_importe_rec1 = 0;
    Let v_importe_rec2 = 0;
    Let v_contador = 0;

    -- APREMIOS
    FOREACH
		SELECT 	id_control, importe_multa, importe_gastos, porcentaje_multa  
		INTO 	v_id_control_req, v_importe_multa, v_importe_gastos, v_porcentaje_multa
		FROM 	ta_15_apremios
		WHERE 	modulo = 34  
		AND 	control_otr = v_id_34_datos
		AND 	vigencia = "1" 
		AND 	clave_practicado = "P"
		Order 	By id_control

		Let v_tot_multas = v_importe_multa;
		if 	v_porcentaje_multa < 100 then
			Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
			Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
		else
			Let v_tot_dscto_multas = 0;
		End if;
		
		Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

		INSERT INTO  tmp_detalle_otras_oblig 
		VALUES ( v_id_control_req, v_ref, 0, 'R' );
    
	END FOREACH;
    -- TERMINA APREMIOS


    -- INICIAN PERIODOS
    FOREACH
		SELECT 	a.periodo, a.importe, Year(a.periodo), Month(a.periodo), a.tipo_var   
		INTO  	v_aso_mes_pago, v_importe, v_Axo, v_Mes, v_tipo_var  
		FROM 	t34_pagos a, t34_status b    
		WHERE 	id_datos = v_id_34_datos  
		and 	periodo <= v_ref
		AND 	b.id_34_stat = a.id_stat 
		AND 	b.cve_tab = 'E' 
		AND 	b.cve_stat in ('V')
		ORDER 	BY a.periodo

		INSERT 	INTO  tmp_detalle_otras_oblig 
		VALUES  ( v_id_34_datos, v_Axo || '-' || v_Mes, 0, 'A' );
		
		if 	v_importe > 0 then
			if 	v_contador = 0 then
				/*if 	v_tot_multas > 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
					Let v_concepto = 'MULTAS';
					if 	par_Tabla = '5' then
						Let v_cta_multas = 515003004;
					End if;
					
                    Let v_acumulado = v_acumulado + v_tot_multas;  
					RETURN 0, v_cta_multas, get_odoo_cta( v_cta_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_multas, v_acumulado with resume;
					INSERT INTO tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_multas, v_acumulado );
                End if;*/
				
				/*if 	v_tot_dscto_multas <> 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
					Let v_concepto = 'DSCTO. MULTAS';
					if 	par_Tabla = '5' then
						Let v_cta_dscto_multas = 515043004;
					end if;
					
                    Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
					RETURN 0, v_cta_dscto_multas, get_odoo_cta( v_cta_dscto_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_dscto_multas, v_acumulado  with resume;
                    INSERT INTO  tmp_total_otras_oblig 
					VALUES  ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, v_concepto, v_tot_dscto_multas, v_acumulado );
                End if;*/

                if 	v_tot_gastos > 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
					Let v_concepto = 'GASTOS';
					if 	par_Tabla = '5' then
						Let v_cta_gastos = 550620010;
					end if;
					
                    Let v_acumulado = v_acumulado + v_tot_gastos;  
					RETURN 0, v_cta_gastos, get_odoo_cta( v_cta_gastos , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_gastos, v_acumulado  with resume;
                    INSERT INTO tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, v_concepto, v_tot_gastos, v_acumulado );
                End if;
				
                Let v_contador = 1;
            End if;

            if 	v_tipo_var = 'T' then
				--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'ADEUDO ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
				if 	par_Tabla = '5' then
					Let v_concepto = 'REFRENDO ACTUAL';
					if 	v_descripcion = 'Empresas Especializadas VP' then
						Let v_cta_adeudos_act = 370400000;
					End if;
					if 	v_descripcion = 'Con cobro para el usuario VP' then
						Let v_cta_adeudos_act = 340500003;
					End if;
					if 	v_descripcion = 'Sin cobro para el usuario VP' then
						Let v_cta_adeudos_act = 340500004;
					End if;
				Else
					Let v_concepto = 'ADEUDO ACTUAL';
					if 	par_Tabla = '1' then
						if 	v_axo = year(today) then
							Let v_cta_adeudos_act = 353200000;
						else
							Let v_cta_adeudos_act = 353230000;  -- rezago
						End if;
					End if;
					
					if 	par_Tabla = '2' then
						if 	v_axo = year(today) then
							Let v_cta_adeudos_act = 353800000;
						else
							Let v_cta_adeudos_act = 353830000;  -- rezago
						End if;
					End if;
					
					if 	par_Tabla = '4' then
						if 	v_descripcion = '1ra. Especial SP' then
							Let v_cta_adeudos_act = 340400001;
						End if;
						if 	v_descripcion = '1ra. SP' then
							Let v_cta_adeudos_act = 340400002;
						End if;
						if 	v_descripcion = '2da. SP' then
							Let v_cta_adeudos_act = 340400003;
						End if;
						if 	v_descripcion = '3ra. SP' then
							Let v_cta_adeudos_act = 340400004;
						End if;
						if 	v_descripcion = 'Otros SP' then
							Let v_cta_adeudos_act = 340400005;
						End if;
					End if;
				End if;
				
                Let v_acumulado = v_acumulado + v_importe;  
				RETURN 0, v_cta_adeudos_act, get_odoo_cta( v_cta_adeudos_act , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
                INSERT INTO tmp_total_otras_oblig 
				VALUES ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );

                SELECT 	sum(por_recargo)   
				INTO 	v_Importe_recargo  
				FROM 	t34_porcentajes  
                WHERE 	periodo_porc BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);
                -- Modificado por Ignacio Rodriguez el 22 de febrero de 2024 a peticion de Angy Villalobos por instrucci�n del Tesorero
                -- Los EVP (Valet Parking) 565 y 595 correspondientes a los v_id_34_datos 547 y 577 se quitan accesorios
                
                if  v_id_34_datos in (134,547,577) then
                   let v_Importe_recargo = 0;
                end if;
                
                -- Se termina condicional, se debe de quitar una vez pagado

                if 	v_Importe_recargo <> 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'RCGO. ADEUDO' ) INTO v_cta_rcgos_ade, v_concepto;
					Let v_concepto = 'RCGO. ADEUDO';
					if 	par_Tabla = '5' then
						Let v_cta_rcgos_ade = 390900000;
					else
						Let v_cta_rcgos_ade = 390500000;
					End if;
                    
					Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                    Let v_acumulado = v_acumulado + v_importe_rec1;
                    RETURN 0, v_cta_rcgos_ade, get_odoo_cta( v_cta_rcgos_ade , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec1, v_acumulado  with resume;
                    INSERT INTO tmp_total_otras_oblig 
					VALUES  ( 0,0, v_cta_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec1, v_acumulado );  
					
                    -- inicia calculo de multa adeudo vencido
                    let v_tot_multas = 0; 
                    execute procedure sp34_calc_multa(v_importe ,mdy( Month(v_aso_mes_pago), Dia_v, Year(v_aso_mes_pago)) ) into v_tot_multas;
                    if v_tot_multas>0 then
                       let v_acumulado = v_acumulado + v_tot_multas;
					   let v_concepto = 'MULTAS'  ;
                       if 	par_Tabla = '5' then
						    Let v_cta_multa_ade = 452011;
					   else
                       if 	par_Tabla = '4' then
						    Let v_cta_multa_ade = 452081;
                       else
                            Let v_cta_multa_ade = 452091;
                       end if;
                       end if;
                       RETURN 0, v_cta_multa_ade, v_cta_multa_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_multas, v_acumulado  with resume;
                       INSERT INTO tmp_total_otras_oblig 
					   VALUES  ( 0,0, v_cta_multa_ade, v_Axo || '/' || v_Mes, v_concepto, v_tot_multas, v_acumulado );
                    end if;

					-- inicia codigo nuevo inpc Actualizacion 	
					Let	perioI = (v_Axo * 100) + v_Mes;
                    execute function spd_11_calc_actualizacion(v_Axo, v_Mes, v_importe) into v_actualizacion;
--					Let	v_actualizacion = dbestacion:fcn_inpc_x_mes ( perioI ) * v_importe_rec1 / 100 ;  -- calculo anterior
                    if v_actualizacion>0 then
					   let v_acumulado = v_acumulado + v_actualizacion;
					   let v_concepto = 'ACTUALIZACION'  ;
                       RETURN 0, 459132, 459132, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_actualizacion, v_acumulado  with resume;
                       INSERT INTO tmp_total_otras_oblig 
					   VALUES  ( 0,0, 459132, v_Axo || '/' || v_Mes, v_concepto, v_actualizacion, v_acumulado );  
					   -- Termina codigo nuevo inpc Actualizacion
                    end if;
					
					EXECUTE PROCEDURE sp_desctomerc (v_id_34_datos, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 34) INTO v_importe_rec2, v_mensaje_proc;
                End if;
				
                if 	v_importe_rec2 > 0 then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. RECARGO' ) INTO v_cta_dcto_rcgos_ade, v_concepto;
					Let v_concepto = 'DSCTO. RECARGO';
					if 	par_Tabla = '5' then
						Let v_cta_dcto_rcgos_ade = 390940000;
					else
						Let v_cta_dcto_rcgos_ade = 390540000;
					End if;
					
                    Let v_importe_rec2 = v_importe_rec2 * -1;
                    Let v_acumulado = v_acumulado + v_importe_rec2;
                    RETURN 0, v_cta_dcto_rcgos_ade, get_odoo_cta( v_cta_dcto_rcgos_ade , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe_rec2, v_acumulado  with resume;
					INSERT INTO  tmp_total_otras_oblig 
					VALUES  ( 0,0, v_cta_dcto_rcgos_ade, v_Axo || '/' || v_Mes, v_concepto, v_importe_rec2, v_acumulado );
                End if;

                -- descuento de multa
                let v_tot_dscto_multas =0;
                execute PROCEDURE sp34_desctomulta( v_id_34_datos, v_axo, v_Mes, v_tot_multas) into v_tot_dscto_multas, v_mensaje_proc;
                if v_tot_dscto_multas>0 then
                   let v_tot_dscto_multas = v_tot_dscto_multas * -1;
                   let v_acumulado = v_acumulado + v_tot_dscto_multas;
				   let v_concepto = 'DSCTO. MULTAS'  ;
                   if  par_Tabla = '5' then
					   Let v_cta_dcto_multa_ade = 452911;
				   else
                   if  par_Tabla = '4' then
					   Let v_cta_dcto_multa_ade = 452981;
                   else   
                       Let v_cta_dcto_multa_ade = 452991;
                   end if;
                   end if;
                   RETURN 0, v_cta_dcto_multa_ade, v_cta_dcto_multa_ade, Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_tot_dscto_multas, v_acumulado  with resume;
                   INSERT INTO tmp_total_otras_oblig 
				   VALUES  ( 0,0, v_cta_dcto_multa_ade, v_Axo || '/' || v_Mes, v_concepto, v_tot_dscto_multas, v_acumulado );
                end if;

            Else
				if 	v_tipo_var = 'F' then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'F', 'FORMA' ) INTO v_cta_adeudos_act, v_concepto;
					Let v_concepto = 'FORMA';
					if 	par_Tabla = '5' then
						Let v_cta_adeudos_act = 421200012;
					End if;
				
					Let v_acumulado = v_acumulado + v_importe;  
					RETURN 0, v_cta_adeudos_act, get_odoo_cta( v_cta_adeudos_act , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
					INSERT INTO  tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
                End if;

                if 	v_tipo_var = 'A' then
					--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'A', 'AUTORIZACION ACTUAL' ) INTO v_cta_adeudos_act, v_concepto;
					if 	par_Tabla = '5' then
						Let v_concepto = 'AUTORIZACION ACTUAL';
						if 	v_descripcion = 'Empresas Especializadas VP' then
							Let v_cta_adeudos_act = 370300000;
						End if;
						if 	v_descripcion = 'Con cobro para el usuario VP' then
							Let v_cta_adeudos_act = 340500001;
						End if;
						if 	v_descripcion = 'Sin cobro para el usuario VP' then
							Let v_cta_adeudos_act = 340500002;
						End if;
					End if;
			
					Let v_acumulado = v_acumulado + v_importe;  
					RETURN 0, v_cta_adeudos_act, get_odoo_cta( v_cta_adeudos_act , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), v_concepto, v_importe, v_acumulado  with resume;
					INSERT INTO  tmp_total_otras_oblig 
					VALUES ( 0,0, v_cta_adeudos_act, v_Axo || '/' || v_Mes, v_concepto, v_importe, v_acumulado );
				End if;
			End if;
		End if;

		Let v_importe = 0;
		Let v_Importe_recargo = 0;
		Let v_importe_rec1 = 0;
		Let v_importe_rec2 = 0;
    END FOREACH;
    -- TERMINAN PERIODOS

	if 	v_contador = 0 then
		/*if 	v_tot_multas > 0 then
			--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'MULTAS' ) INTO v_cta_multas, v_concepto;
			Let v_concepto = 'MULTAS';
			if 	par_Tabla = '5' then
				Let v_cta_multas = 515003004;
			End if;
        
			Let v_acumulado = v_acumulado + v_tot_multas;  
			RETURN 0, v_cta_multas, get_odoo_cta( v_cta_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'MULTAS ', v_tot_multas, v_acumulado with resume;
			INSERT INTO tmp_total_otras_oblig 
			VALUES ( 0,0, v_cta_multas, v_Axo || '/' || v_Mes, 'MULTAS ', v_tot_multas, v_acumulado );
		End if;*/
	
		/*if 	v_tot_dscto_multas <> 0 then
			--EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'DSCTO. MULTAS' ) INTO v_cta_dscto_multas, v_concepto;
			Let v_concepto = 'DSCTO. MULTAS';
			if 	par_Tabla = '5' then
				Let v_cta_dscto_multas = 515043004;
			End if;
			
			Let v_acumulado = v_acumulado + v_tot_dscto_multas;  
			RETURN 0, v_cta_dscto_multas, get_odoo_cta( v_cta_dscto_multas , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado  with resume;
			INSERT INTO tmp_total_otras_oblig 
			VALUES  ( 0,0, v_cta_dscto_multas, v_Axo || '/' || v_Mes, 'DSCTO. MULTAS ', v_tot_dscto_multas, v_acumulado );
		End if;*/
 
		if 	v_tot_gastos > 0 then
			EXECUTE PROCEDURE con34_GCta_apl ( par_Tabla, 'E', 'T', 'GASTOS' ) INTO v_cta_gastos, v_concepto;
			Let v_concepto = 'GASTOS';

			if 	par_Tabla = '5' then
				Let v_cta_gastos = 550620010;
			End if;
			
			Let v_acumulado = v_acumulado + v_tot_gastos;  
			RETURN 0, v_cta_gastos, get_odoo_cta( v_cta_gastos , 25), Year(v_aso_mes_pago) || '/' || Month(v_aso_mes_pago), 'GASTOS ', v_tot_gastos, v_acumulado  with resume;
			INSERT INTO tmp_total_otras_oblig 
			VALUES ( 0,0, v_cta_gastos, v_Axo || '/' || v_Mes, 'GASTOS ', v_tot_gastos, v_acumulado );
		End if;
	End if;
End if;

END function
;

CREATE PROCEDURE "pgcabrer".sp16_convtotales ( parControl int, parAso int, parMes int )
{######################################################################
#  Procedimiento:    sp16_ConvTotales
#  Descripcion:      Interfaz de consulta de detalle para CONVENIOS de ASEO CONTRATADO
#
#  Parametros		parControl 	= Control del contrato de aseo
#  de entrada:		parAso		= A�o de corte
#                       parMes		= Mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            3 mayo 2016
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning  Varchar(80) as Nom_Empresa,
				varchar(80) as Domicilio,
				int as Nun_Ext,
				int as Num_Int,
				int as Recaudadora,
				int as Zona,

				int as Aso_desde,
				int as Mes_desde,
				int as Aso_hasta,
				int as Mes_hasta,

				money(12,2) as Imp_Adeudo,
				money(12,2) as ImpExced_Adeudo,
				money(12,2) as Recargos,
				money(12,2) as Gastos,
				money(12,2) as Multa,
				money(12,2) as Actualizacion,
				money(12,2) as Total,

				int as Status,
				varchar(50) as Mensaje;

define v_control_contrato, v_Nom_Empresa, V_Domicilio				varchar(80);
define v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona				int;
define v_Aso_desde, v_Mes_desde, v_Aso_hasta, v_Mes_hasta			int;
define v_Imp_Adeudo, v_ImpExced_Adeudo, v_Recargos, v_Gastos, v_Multa, v_actualizacion, v_importe_actualizacion		money(12,2);     
define v_Status									int;
define v_Mensaje								varchar(50); 
 
               
define v_ctrol_operacion, v_id_control_req					Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas        Money(12,2);
define v_porcentaje_multa                                                                       Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           	Money(12,2);
define v_aso_mes_pago                                                                           Date;
define v_Axo, v_Mes                                                                             Integer;
define v_mensaje_proc                                                                           varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                              varchar(7);
define v_contador                                                                               Smallint;

Let v_control_contrato = 0;
Let v_Nom_Empresa = '';
Let V_Domicilio = '';

Let v_Nun_Ext = 0;
Let v_Num_Int = 0;
Let v_Recaudadora = 0;
Let v_Zona = 0;

Let v_Aso_desde = 0;
Let v_Mes_desde = 0;
Let v_Aso_hasta = 0;
Let v_Mes_hasta = 0;

Let v_Imp_Adeudo = 0;
Let v_ImpExced_Adeudo = 0;
Let v_Recargos = 0;
Let v_Gastos = 0;
Let v_Multa = 0;
let v_actualizacion = 0;
let v_importe_actualizacion = 0;

Let v_Status = -1;
Let v_Mensaje = 'NO EXISTE CONTRATO';


EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_zonas d   
		WHERE a.control_contrato = parControl and b.ctrol_aseo = a.ctrol_aseo and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp
				and d.ctrol_zona = a.ctrol_zona  ) then
		SELECT a.control_contrato, (c.descripcion) nom_emp, a.domicilio, (0) Num_Ext, (0) Num_Int, a.id_rec, d.zona
			INTO v_control_contrato, v_Nom_Empresa, V_Domicilio, v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona   
			FROM ta_16_contratos a, ta_16_tipo_aseo b, ta_16_empresas c, ta_16_zonas d  
			WHERE a.control_contrato = parControl  and b.ctrol_aseo = a.ctrol_aseo
			and c.num_empresa = a.num_empresa and c.ctrol_emp = a.ctrol_emp  and d.ctrol_zona = a.ctrol_zona;

                -- VARIABLES A 0
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               	Let v_tot_gastos = 0;


                Let v_acumulado = 0;
                Let v_importe = 0;
                Let v_Importe_recargo = 0;
                let v_importe_actualizacion = 0;
                Let v_importe_rec1 = 0;
                Let v_importe_rec2 = 0;
                Let v_contador = 0;

                -- APREMIOS
                Let v_id_control_req = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_Axo = 0;
                Let v_Mes = 0; 
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               
                               Let v_tot_multas = v_importe_multa;
                               if v_porcentaje_multa < 100 then
                                               Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                               --Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                               else
                                               Let v_tot_dscto_multas = 0;
                               end if;
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;
			-- v_tot_multas - v_tot_dscto_multas
			-- v_tot_gastos

                end foreach;
                -- TERMINA APREMIOS
            Let v_tot_multas = 0;
            Let v_importe_multa = 0;

		-- INICIAN PERIODOS
            foreach
			SELECT  aso_mes_pago,  Year(aso_mes_pago), Month(aso_mes_pago), importe, ctrol_operacion, 
               nvl(calc_actualizacion_aseo(YEAR(aso_mes_pago), MONTH(aso_mes_pago), importe),0) 
            INTO     v_aso_mes_pago, v_Axo, v_Mes, v_importe, v_ctrol_operacion, v_actualizacion
            FROM ta_16_pagos 
            WHERE Control_Contrato = v_control_contrato  
            AND aso_mes_pago <= parAso || '-' || parMes
            AND status_vigencia = 'V'  Order By aso_mes_pago, ctrol_operacion

			if v_importe > 0 then
				if v_contador = 0 then
					Let v_Aso_desde = v_Axo;
					Let v_Mes_desde = v_Mes;
                end if;
                
				if v_ctrol_operacion = 6 then
                   SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos  
					WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);
					if v_Importe_recargo <> 0 then
                       Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
					   EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
					end if;
					Let v_Imp_Adeudo = v_Imp_Adeudo + v_importe;
					Let v_Recargos = v_Recargos + (v_importe_rec1 - v_importe_rec2);
                    if v_importe_rec1 >0 then
                       Let v_importe_multa = (v_importe * .30);
                       Let v_tot_multas = v_tot_multas + v_importe_multa;
                    end if;
                    let v_importe_actualizacion = v_importe_actualizacion + v_actualizacion;
				else
                    SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos  
					WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN); --(v_Periodo_EXE);
					if v_Importe_recargo <> 0 then
                       Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
					   EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) INTO v_importe_rec2, v_mensaje_proc;
					end if;
					Let v_ImpExced_Adeudo = v_ImpExced_Adeudo + v_importe;
					Let v_Recargos = v_Recargos + (v_importe_rec1 - v_importe_rec2);
                    if v_importe_rec1 >0 then
                       Let v_importe_multa = (v_importe * .30);
                       Let v_tot_multas = v_tot_multas + v_importe_multa;
                    end if;
                    let v_importe_actualizacion = v_importe_actualizacion + v_actualizacion;
                end if;
			Let v_contador = 1;
			end if;

            Let v_importe = 0;
            Let v_Importe_recargo = 0;
            let v_actualizacion = 0;
            Let v_importe_rec1 = 0;
            Let v_importe_rec2 = 0;
            end foreach;
		-- TERMINAN PERIODOS

		Let v_Aso_hasta = v_Axo;
		Let v_Mes_hasta = v_Mes;
		if (v_Imp_Adeudo > 0) or (v_ImpExced_Adeudo > 0) then
			Let v_Status = 0;
			Let v_Mensaje = 'PROCEDE COBRO';
		else
			Let v_Status = -1;
			Let v_Mensaje = 'NO TIENE ADEUDO';
		end if;

end if;

	RETURN v_Nom_Empresa, V_Domicilio, v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona, v_Aso_desde, v_Mes_desde, v_Aso_hasta, v_Mes_hasta, 
	v_Imp_Adeudo, v_ImpExced_Adeudo, v_Recargos, v_tot_gastos, (v_tot_multas - v_tot_dscto_multas), v_importe_actualizacion,
	v_Imp_Adeudo + v_ImpExced_Adeudo + v_Recargos + v_tot_gastos + (v_tot_multas - v_tot_dscto_multas) + v_importe_actualizacion, 
	v_Status, v_Mensaje;

end procedure;

CREATE PROCEDURE "pgcabrer".sp16_convdet ( parControl int, parAso int, parMes int )
{######################################################################
#  Procedimiento:    sp16_ConvDet
#  Descripcion:      Interfaz de consulta de detalle para CONVENIOS de ASEO CONTRATADO
#
#  Parametros		parControl 	= Control del contrato de aseo
#  de entrada:		parAso		= A�o de corte
#                       parMes		= Mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            29 ABRIL 2016
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
                returning  Varchar(30) as Concepto,
				int as AsoAdeudo,
				int as MesAdeudo,
				int as CtaAplAdeudo,
				money(12,2) as ImpAplAdeudo,
				int as CtaAplRcgo,
				money(12,2) as ImpAplRcgo,
				int as CtaAplAct,
				money(12,2) as ImpAplAct;
               
define v_control_contrato, v_ctrol_operacion, v_id_control_req					Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas        Money(12,2);
define v_porcentaje_multa                                                                       Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2, v_actualizacion     	Money(12,2);
define v_aso_mes_pago                                                                           Date;
define v_Axo, v_Mes                                                                             Integer;
define v_mensaje_proc                                                                           varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                              varchar(7);
define v_contador                                                                               Smallint;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;

if exists( SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.control_contrato = parControl and b.ctrol_aseo = a.ctrol_aseo  ) then
             SELECT a.control_contrato  INTO  v_control_contrato   FROM ta_16_contratos a, ta_16_tipo_aseo b
                               WHERE a.control_contrato = parControl and b.ctrol_aseo = a.ctrol_aseo;

                -- VARIABLES A 0
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               	Let v_tot_gastos = 0;


                Let v_acumulado = 0;
                Let v_importe = 0;
                let v_actualizacion = 0;
                Let v_Importe_recargo = 0;
                Let v_importe_rec1 = 0;
                Let v_importe_rec2 = 0;
                Let v_contador = 0;

                -- APREMIOS
                Let v_id_control_req = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_Axo = 0;
                Let v_Mes = 0; 

                foreach
                     SELECT id_control, importe_multa, importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa                       
                     INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      FROM ta_15_apremios
                       WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               
                               Let v_tot_multas = v_importe_multa;
                               if v_porcentaje_multa < 100 then
                                               Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                               --Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                               else
                                               Let v_tot_dscto_multas = 0;
                               end if;
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                end foreach;
                -- TERMINA APREMIOS

		-- INICIAN PERIODOS
                foreach
			SELECT  aso_mes_pago,  Year(aso_mes_pago), Month(aso_mes_pago), importe, ctrol_operacion, nvl(calc_actualizacion_aseo(YEAR(aso_mes_pago), MONTH(aso_mes_pago), importe),0) 
                        INTO     v_aso_mes_pago, v_Axo, v_Mes, v_importe, v_ctrol_operacion, v_actualizacion
                        	FROM ta_16_pagos 
                                WHERE Control_Contrato = v_control_contrato  
                                AND aso_mes_pago <= parAso || '-' || parMes
                                AND status_vigencia = 'V'  Order By aso_mes_pago, ctrol_operacion


			if v_importe > 0 then
				if v_contador = 0 then
                                	if v_tot_multas > 0 then
						RETURN 'Multas ', v_Axo, v_Mes, 515002003, v_tot_multas - v_tot_dscto_multas, 0, 0, 0, 0  with resume;
					end if;
                                        if v_tot_gastos > 0 then
						RETURN 'Gastos ', v_Axo, v_Mes, 992104009, v_tot_gastos, 0, 0, 0, 0  with resume;
                                        end if;
                                end if;

				if v_ctrol_operacion = 6 then
                                	SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos  
						WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);
					if v_Importe_recargo <> 0 then
                                        	Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
						EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
                                                				INTO v_importe_rec2, v_mensaje_proc;
					end if;
                                        if Year(v_aso_mes_pago) < Year(Current) then
						RETURN 'Rezago del Adeudo ', v_Axo, v_Mes, 250130000, v_importe, 390200000, v_importe_rec1 - v_importe_rec2, 174003, v_actualizacion  with resume;
                                        else
						RETURN 'Actual de Adeudo ', v_Axo, v_Mes, 250100000, v_importe, 390200000, v_importe_rec1 - v_importe_rec2, 174003, v_actualizacion  with resume;
                                        end if;
				else
                                	SELECT sum(porc_recargo)   INTO v_Importe_recargo  FROM ta_16_recargos  
						WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN); --(v_Periodo_EXE);
					if v_Importe_recargo <> 0 then
                                        	Let v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
						EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, Null, Null, Null, Null, 16) 
                                                				INTO v_importe_rec2, v_mensaje_proc;
					end if;
                                	if Year(v_aso_mes_pago) < Year(Current) then
						RETURN 'Rezago Excedente ', v_Axo, v_Mes, 250230000, v_importe, 390200000, v_importe_rec1 - v_importe_rec2, 174003, v_actualizacion  with resume;
                                        else
						RETURN 'Actual Excedente ', v_Axo, v_Mes, 250200000, v_importe, 390200000, v_importe_rec1 - v_importe_rec2, 174003, v_actualizacion  with resume;
                                        end if;
                                end if;
			Let v_contador = 1;
			end if;

                Let v_importe = 0;
                Let v_Importe_recargo = 0;
                Let v_importe_rec1 = 0;
                Let v_importe_rec2 = 0;
                end foreach;
		-- TERMINAN PERIODOS

end if;
end procedure;

CREATE FUNCTION "informix".admin_encabezados_14(
   p_segmento1 CHAR(10), p_segmento2 CHAR(10), p_segmento3 CHAR(10), p_segmento4 CHAR(10), p_segmento5 CHAR(10), p_segmento6 CHAR(10))

RETURNING VARCHAR(92) AS sNombreCompLETo, VARCHAR(80) AS scalle, VARCHAR(10) AS sNoExt, VARCHAR(10) AS sInt, VARCHAR(50) AS scolonia, 
   VARCHAR(10)AS scodigo_postal, VARCHAR(13) AS sRFC, VARCHAR(50) AS sMunicipio, VARCHAR(50) AS sEstado, VARCHAR(18) AS sCURP,                                      
   --lVARCHAR(500)AS sDescripcion_recibo,
   SMALLINT AS sporCobrar, VARCHAR(255) AS Leyenda, VARCHAR(255) AS Leyenda_rbo, SMALLINT AS Impide_cobro;


DEFINE v_control INTEGER;
DEFINE v_axo INTEGER;
DEFINE v_mes SMALLINT;
DEFINE v_axo_pagado INTEGER;
DEFINE v_nombre VARCHAR(60) ;
DEFINE v_colonia VARCHAR(30);
DEFINE v_observaciones VARCHAR(60);
DEFINE v_vigencia CHAR(1);
DEFINE v_clave int;
DEFINE v_texto VARCHAR(100);
DEFINE v_domcompLETo VARCHAR(75);
DEFINE v_exte VARCHAR(10);
DEFINE v_inte VARCHAR(10);

LET v_axo = YEAR(TODAY);
LET v_mes = MONTH(TODAY);
LET v_control = p_segmento1;

IF NOT EXISTS (SELECT * FROM ta_13_datosrcm WHERE control_rcm = v_control) THEN
   RETURN ' ', ' ', ' ' , ' ' , ' ', ' ', ' ', ' ', ' ', ' ', 0, ' No Existe ', ' ', 1; 
END IF;      
  
SELECT axo_pagado, nombre, domicilio, exterior, interior, colonia, vigencia
   INTO v_axo_pagado, v_nombre,v_domcompleto, v_exte, v_inte, v_colonia, v_vigencia
FROM ta_13_datosrcm WHERE control_rcm = v_control;

IF v_axo_pagado = v_axo THEN
   RETURN v_nombre, v_domcompleto, v_exte, v_inte, v_colonia, ' ', ' ', ' ', ' ', ' ', 0, 'Al corriente de pagos ', ' ', 1; 
END IF; 
IF v_vigencia = 'B' THEN
   RETURN v_nombre, v_domcompleto, v_exte, v_inte, v_colonia, ' ', ' ', ' ', ' ', ' ', 0, 'Dado de Baja ', ' ', 1; 
END IF; 


-- Se agrega tabla temporal para evitar calculo de recargos (29/01/2021)
IF NOT EXISTS (SELECT * FROM tmp_cem_norecgos WHERE control_rcm = v_control) THEN
   IF TODAY >= MDY(7, 1, 2025) THEN
      EXECUTE PROCEDURE spd_13_recargos(v_control, v_mes); -- Exencion de recargos para todo el adeudo hasta el 30 de junio de 2023 (10/01/2023)
   END IF;
END IF;


RETURN v_nombre, v_domcompleto, v_exte, v_inte, v_colonia, ' ', ' ', ' ', ' ', ' ', 1, 'Listo para cobro  ', ' ', 0; 

END FUNCTION;

CREATE FUNCTION "pgcabrer".admin_adeudos_detalle_14odoo(p_segmento1 CHAR(10), p_segmento2 CHAR(10),p_segmento3 CHAR(10),p_segmento4 CHAR(10),
     p_segmento5 CHAR(10),p_segmento6 CHAR(10), p_Apagar CHAR(20))
RETURNING  INT AS sNoRubro, INT AS sNoConcepto, INT AS sCuenta_aplicacion,
    VARCHAR(50) AS sreferencia1, VARCHAR(50) AS sDescripcion, dec(14,2) AS sMonto, dec(14,2) AS sAcumulado;

DEFINE v_control INTEGER;
DEFINE v_axo INTEGER;
DEFINE v_mes SMALLINT;
DEFINE vpar_axo INTEGER;
DEFINE vpar_impte MONEY(15,2);
DEFINE vpar_recar MONEY(15,2);
DEFINE v_axo_mon INTEGER;
DEFINE v_descuento INTEGER; 
DEFINE v_impdesc MONEY(15,2);
DEFINE v_recardesc MONEY(15,2);
DEFINE v_actualizacion MONEY(15,2);
DEFINE v_desctot MONEY(15,2);
DEFINE v_desctotre MONEY(15,2);
DEFINE var_cem CHAR(1);
DEFINE v_cementerio CHAR(1);
DEFINE v_axo_pagado INTEGER;
DEFINE v_vigencia CHAR(1);
DEFINE v_imptot MONEY(15,2);
DEFINE v_impmonto MONEY(15,2);
DEFINE v_periodo VARCHAR(30);
DEFINE v_axodesde INTEGER;
DEFINE var_axo INTEGER;
DEFINE v_obs VARCHAR(60);
DEFINE v_ctaapl1 INT;
DEFINE v_ctaapl2 INT;
DEFINE v_ctaapl3 INT;
DEFINE v_ctaapl4 INT;
DEFINE v_ctaapl5 INT;
DEFINE v_ctaapli INT;
DEFINE v_ctaaplr INT;
DEFINE v_ctaapldi INT;
DEFINE v_ctaapldr INT;
DEFINE  v_acumula MONEY(15,2);
DEFINE v_ctaapl_act MONEY(15,2);
DEFINE v_id_descuento_regargo INT; -- ID del descuento en recargo automatico
DEFINE v_fecha_actual DATE;

LET v_axo=YEAR(TODAY);
LET v_mes=MONTH(TODAY);
LET v_obs ='';
LET v_impmonto = 0;
LET v_desctot  = 0;
LET v_axo_mon  = 0;
LET v_acumula  = 0;

LET v_control= p_segmento1;
LET var_axo= NVL((p_Apagar),0);
LET v_imptot=0;
LET v_fecha_actual = TODAY;
--LET v_fecha_actual = '2023-07-01'; -- DEBUG

--SELECT * FROM ta_13_recargosrcm WHERE axo = 2023 
--UPDATE ta_13_recargosrcm SET porcentaje_global = 1.47*mes WHERE axo = 2023 AND mes < 8
--SELECT * FROM ta_13_recargosrcm WHERE axo = 2023 AND mes < 8
--IF v_control<>132855 then
   execute PROCEDURE spd_actualrcm (v_control, 18);
--end if;

if (var_axo <= year(v_fecha_actual) and v_fecha_actual < mdy(7,1,2025)) or (v_fecha_actual >= mdy(7,1,2025)) 
   or (v_control in (100033, 125252, 114755))  then
   if v_control not in (47645, 39418) then
      EXECUTE PROCEDURE spd_13_recargos(v_control, MONTH(v_fecha_actual));
   else
    --EXECUTE PROCEDURE spd_13_recargos(v_control, MONTH(v_fecha_actual));
      update ta_13_adeudosrcm set importe_recargos= 0, descto_recargos = 0 where control_rcm=v_control and vigencia='V' and (id_pago is null or id_pago=0) and axo_adeudo<year(today);
   end if;
else
   if v_control not in (select control_rcm from tmp_cem_norecgos) then -- 02/07/2023
    --EXECUTE PROCEDURE spd_13_recargos(v_control, MONTH(v_fecha_actual));
   update ta_13_adeudosrcm set importe_recargos= 0, descto_recargos = 0 where control_rcm=v_control and vigencia='V' and (id_pago is null or id_pago=0) and axo_adeudo<year(today);
    else
    EXECUTE PROCEDURE spd_13_recargos(v_control, MONTH(v_fecha_actual));
  end if;
end if;

IF NOT EXISTS(SELECT * FROM ta_13_datosrcm WHERE control_rcm = v_control) THEN
    RETURN 0,0,0,' ',' ',0,0; 
END IF;        

SELECT cementerio, axo_pagado, vigencia
    INTO v_cementerio, v_axo_pagado, v_vigencia
FROM ta_13_datosrcm WHERE control_rcm = v_control;

SELECT  cta_aplicacion, cta_vencido, cta_descto,cta_desctopens,cta_desctopens_rez ,cta_actualizacion
    INTO v_ctaapl1, v_ctaapl2 , v_ctaapl3 ,v_ctaapl4, v_ctaapl5, v_ctaapl_act
FROM tc_13_cementerios WHERE cementerio=v_cementerio;

IF v_axo_pagado = v_axo THEN
    RETURN 0,0,0,' ',' ',0,0; 
END IF;      

IF v_vigencia = 'B' THEN
    RETURN 0,0,0,' ',' ',0,0; 
END IF;

IF NOT EXISTS(SELECT * FROM tmp_cem_norecgos WHERE control_rcm = v_control) THEN
 --   IF (v_axo_pagado + 1) < (v_axo - 5) THEN
--        LET v_axodesde = v_axo - 5;
 --   ELSE
        LET v_axodesde = v_axo_pagado + 1; --anterior
--        LET v_axodesde = 1990 + 1;
 --   END IF;
ELSE
    LET v_axodesde = v_axo_pagado + 1;
--    LET v_axodesde = 1990 + 1;
END IF;

IF v_axo <> var_axo THEN
    LET v_axo = var_axo;
END IF;

LET v_desctot = 0;
LET v_desctotre = 0;

IF v_imptot > 0 THEN
    FOREACH 
        SELECT b.axo_adeudo, (b.importe+b.importe_recargos) - (b.descto_impote+ b.descto_recargos)
        INTO vpar_axo, vpar_impte
        FROM ta_13_adeudosrcm b WHERE  b.control_rcm=v_control AND b.axo_adeudo BETWEEN v_axodesde AND v_axo
        ORDER BY 1
        LET v_impmonto = v_impmonto + vpar_impte;
        IF  v_impmonto <= v_imptot THEN
            LET v_axo_mon =  vpar_axo; 
        END IF;
    END FOREACH;
    LET v_axo=v_axo_mon;
END IF;

-- Descuento de recargos solamente si el a�o a pagar (el ultimo parametro) es el a�o actual, ya que el descuento es cuando se paga en su totalidad

IF (TODAY >= MDY(11,18,2022)) AND (TODAY <= MDY(11,21,2022)) OR 
    (TODAY >= MDY(11,13,2023)) AND (TODAY <= MDY(11,24,2023)) OR -- (!) Cambiar las fechas
    (TODAY >= MDY(11,01,2024)) AND (TODAY <= MDY(12,31,2024)) THEN------
    EXECUTE PROCEDURE catastro_gdl:ins_recarcem(v_control, v_axodesde, v_axo, 'auto75', 75, 4) INTO v_id_descuento_regargo;
    IF v_axo = YEAR(TODAY) THEN 
      -- if v_control <> 44648 then
          EXECUTE PROCEDURE catastro_gdl:ins_recarcem(v_control, v_axodesde, v_axo, 'auto75', 75, 1) INTO v_id_descuento_regargo;
      -- end if;
    END IF;
END IF;

FOREACH SELECT b.axo_adeudo, b.importe, b.importe_recargos, NVL(d.descuento,0), b.descto_impote, b.descto_recargos, NVL(b.actualizacion,0)
    INTO vpar_axo, vpar_impte, vpar_recar, v_descuento, v_impdesc, v_recardesc, v_actualizacion      
    FROM ta_13_adeudosrcm b, ta_13_datosrcm r, OUTER ta_13_descpens d
    WHERE r.control_rcm = v_control AND d.control_rcm = r.control_rcm AND d.axo_descto = b.axo_adeudo AND d.vigencia = 'V' 
    AND b.vigencia = 'V' AND b.control_rcm = r.control_rcm AND b.axo_adeudo BETWEEN v_axodesde AND v_axo
    ORDER BY 1

    IF v_descuento <> 0 THEN    
        IF vpar_axo < v_axo THEN
            LET v_ctaapldi = v_ctaapl5; --rezago pensionado
        ELSE
            LET v_ctaapldi = v_ctaapl4;
        END IF;
        LET v_desctot = v_desctot + v_impdesc;
        LET v_obs = 'INCLUYE DESC. '|| v_descuento ||'% POR PENSIONADO'; 
    ELSE
        LET v_obs = ''; 
    END IF;

    LET v_desctotre = v_recardesc;
    IF ( ((MONTH(v_fecha_actual) >= 1)  AND (MONTH(v_fecha_actual) <= 2) AND (vpar_axo=YEAR(TODAY))) ) OR EXISTS(SELECT control_rcm FROM ta_13_dpp WHERE control_rcm = v_control AND vigente = 'V' AND axo_adeudo = vpar_axo) THEN
        IF v_impdesc = 0 THEN
            LET v_desctot = v_desctot + trunc(((vpar_impte-v_impdesc) * 0.1),2);
            LET v_ctaapldi = v_ctaapl3;
            IF  v_obs = '' THEN
                LET v_obs = v_obs || 'INCLUYE DESC. 10% POR PRONTO PAGO'; 
            ELSE
                LET v_obs = v_obs || ' Y 10% POR PRONTO PAGO'; 
            END IF;
        END IF;
    END IF;

    IF vpar_axo = YEAR(TODAY) THEN
        LET v_ctaapli = v_ctaapl1;
    ELSE
        LET v_ctaapli = v_ctaapl2;
    END IF;  

    IF vpar_recar > 0 THEN
        LET v_ctaaplr = 390300000;
    END IF;    

    IF v_desctot > 0 THEN
        -- LET v_ctaapldi=v_ctaapl3;
        LET v_desctot = v_desctot * -1;
    END IF;    

    IF v_desctotre > 0 THEN
        LET v_ctaapldr = 390340000;
        LET v_desctotre = v_desctotre* -1;
    END IF;    

    LET v_acumula = v_acumula + vpar_impte;
    RETURN 0,v_ctaapli, get_odoo_cta( v_ctaapli , 14) , vpar_axo, 'Mantenimiento' ||vpar_axo,  vpar_impte, v_acumula WITH RESUME;

    IF v_desctot <> 0 THEN
        LET v_acumula = v_acumula + v_desctot;

        IF v_acumula > 0 THEN
            RETURN 0,v_ctaapldi, get_odoo_cta( v_ctaapldi , 14),vpar_axo, v_obs || vpar_axo, (v_desctot ), v_acumula WITH RESUME;
        ELSE
            RETURN 0,413921, 413921,vpar_axo, v_obs || vpar_axo,    (v_desctot ), v_acumula WITH RESUME;
        END IF;

        LET v_desctot=0;
    END IF;

    IF vpar_recar > 0 THEN
        LET v_acumula=v_acumula+vpar_recar;
        RETURN 0,v_ctaaplr, get_odoo_cta( v_ctaaplr , 14),vpar_axo , 'Recargos ' || vpar_axo , vpar_recar, v_acumula WITH RESUME;
    END IF;
    
    IF v_desctotre <> 0 THEN
        LET v_acumula = v_acumula + v_desctotre;
        RETURN 0,v_ctaapldr , get_odoo_cta( v_ctaapldr , 14), vpar_axo, v_obs||'Descto Recarg SS' || vpar_axo,  v_desctotre , v_acumula WITH RESUME;
    END IF;


    --IF v_actualizacion <> 0 and (v_control not in (39418) and vpar_axo <> year(today) ) THEN excluye 
    --IF v_actualizacion <> 0 and vpar_axo <> year(today) THEN se quita la por instrucciones de Maribel para que cargue la Actualizacion para el a�o Actual
    IF v_actualizacion <> 0 THEN
        LET v_acumula = v_acumula + v_actualizacion;
        RETURN 0,v_ctaapl_act , get_odoo_cta( v_ctaapl_act , 14), vpar_axo, v_obs||'Actualizacion ' || vpar_axo,  v_actualizacion , v_acumula WITH RESUME;
    END IF;

END FOREACH;
END FUNCTION;

CREATE FUNCTION "informix".admin_pago_14(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10), p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10), p_Apagar char(20), p_certifp money,p_imptep money,
                                  p_redonp money, p_idcobro int, p_foliorbo varchar(30), p_fechapago date, p_recrbo int,  p_centrorbo int,p_cajarbo char(20),
                                  p_nomcajero  varchar(40), p_cajero    varchar(08), p_adicional1 varchar(100), p_adicional2 varchar(100),
                                  p_adicional3 varchar(100), p_adicional4 varchar(100), p_adicional5 varchar(100), p_adicional6 varchar(100),
                                  p_adicional7 varchar(100), p_adicional8 varchar(100), p_adicional9 varchar(100), p_adicional10 varchar(100),
                                  p_adicional11 varchar(100), p_adicional12 varchar(100), p_adicional13 varchar(100), p_adicional14 varchar(100),
                                  p_adicional15 varchar(100))
                RETURNING int as sbien, varchar(255) as mensage;



define v_lError     int;
define v_lISAMError, v_tok int;
define v_vcMensaje,v_tmsg  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);
define vcvepago     int;
define v_axop     int;
define v_axof,v_cont,v_uno,v_dos     int;
define v_control,v_idusu    integer;
define  par_axod,v_ctaapl1   int;
define  par_axoh   int;
define  par_importe money;
define  par_recar   money;
define  par_tot   money;
define  v_nombre,v_colonia  varchar(80);
define  v_domcompleto,v_desade VARCHAR(75);
define  v_exte,v_refe      VARCHAR(10);
define  v_inte      VARCHAR(10);
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -911, 'admin_pago_14 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

 --set debug file to "pago14.txt";
 --trace on;
  let v_r = 'N';
let v_control= nvl(p_segmento1,0);
let v_cont   = 0;
let v_axof   = 0;
let par_axod = 0;
let v_tok    = 0;
let v_idusu    = 0;
let par_axoh = nvl(p_Apagar,0); 

SELECT cementerio, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, 
         nombre,domicilio, exterior, interior,colonia
into  v_cem, v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa,
      v_nombre,v_domcompleto,v_exte,v_inte,v_colonia
FROM ta_13_datosrcm where control_rcm=v_control;

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;

SELECT axofin
into  v_axof
FROM  ta_13_descrec where id_folio =v_control and vigencia='V';

if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if v_control>0 then
    BEGIN WORK;
   let v_r = 'S';
    insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
    id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcnumero,
    axofolio,id_usuario,fecha_act,descripcion, id_centro, foliorecibo) 
    values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro, p_certifp,'P',13, v_control, 0, '',1,par_axod,12,par_axoh,
    v_nombre, (Trim(v_domcompleto)||' '||trim(v_exte) ||' '||trim(v_inte)), v_colonia, v_control, 0, v_idusu, current,
    (p_nomcajero||' '||p_foliorbo||' '||v_cem||' '||v_clase||' '||trim(v_calfa)||' '||v_seccion||' '||trim(v_salfa)||' '||v_linea||' '||trim(v_lalfa)||' '||v_fosa||' '||trim(v_falfa)),
     p_centrorbo, p_foliorbo);

    foreach
     execute PROCEDURE admin_adeudos_detalle_14odoo(v_control,'','','','','', p_Apagar) -- se agrega odoo para que sea el que toma caja, antes sin adoo
     into v_uno,v_dos, v_ctaapl1,v_refe,v_desade,par_importe, par_recar 
     let v_cont=v_cont+1;
     insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
     values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,v_desade,v_ctaapl1, par_importe);
     if par_axod = 0 then
        let par_axod=v_refe;
     end if;
    end foreach;

    if p_redonp <> 0 then
       let v_cont=v_cont+1;
       insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
       values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,'Redondeo ',55080000, p_redonp);
    end if;

    INSERT INTO ta_13_pagosrcm  VALUES(p_fechapago, p_recrbo, p_cajarbo, p_idcobro, 0, v_control, v_cem, v_clase, v_calfa, v_seccion, v_salfa, 
        v_linea, v_lalfa, v_fosa, v_falfa, par_axod, par_axoh, p_certifp, 0, 'A', 0, today);

   let vcvepago=dbinfo("sqlca.sqlerrd1");

   update ta_13_adeudosrcm set  vigencia='P', id_pago=vcvepago
     where control_rcm=v_control and axo_adeudo between par_axod and par_axoh and vigencia='V';


   if par_axoh>=v_axof then
      update ta_13_descrec
     set vigencia='P', fec_pag=p_fechapago, id_rec=p_recrbo, caja=p_cajarbo, operac=p_idcobro 
      where id_folio =v_control and vigencia='V';
  end if;

    update ta_13_datosrcm set axo_pagado=par_axoh where control_rcm=v_control;

   update ta_13_descpens set vigencia='P' where control_rcm=v_control and axo_descto between par_axod and par_axoh and vigencia='V';

 --  EXECUTE procedure spd_13_insextra_admin(v_control, p_adicional2, p_adicional3, p_adicional4,p_adicional5, p_adicional6) into v_tok, v_tmsg;

   -- pone como pagado el registro para no calcular actualizacion
   update ta_13_noactualizacion set vigencia='P' where control_rcm=v_control;

   -- poner como pagado el registro para otorgar pronto pago
   update ta_13_dpp set vigente='P' where control_rcm=v_control;

  COMMIT WORK;  
return 0,'Pagado ' || vcvepago;
else
return -1,'REFERENCIA NO EXISTE   **FOLIO ' ||v_control;
end if;
--trace off;
END function;

CREATE FUNCTION "informix".odoo_pago_14(p_segmento1 char(10), p_segmento2 char(10),p_segmento3 char(10), p_segmento4 char(10),
                                  p_segmento5 char(10),p_segmento6 char(10), p_Apagar char(20), p_certifp money,p_imptep money,
                                  p_redonp money, p_idcobro int, p_foliorbo varchar(30), p_fechapago date, p_recrbo int,  p_centrorbo int,p_cajarbo char(20),
                                  p_nomcajero  varchar(40), p_cajero    varchar(08))
                RETURNING int as sbien, varchar(255) as mensage;



define v_lError     int;
define v_lISAMError, v_tok int;
define v_vcMensaje,v_tmsg  varchar(255);
define v_cem        char(1);
define v_clase      int;
define v_calfa      varchar(30);
define v_seccion    int;
define v_salfa      varchar(30);
define v_linea      int;
define v_lalfa      varchar(30);
define v_fosa       int;
define v_falfa      varchar(30);
define vcvepago     int;
define v_axop     int;
define v_axof,v_cont,v_uno,v_dos     int;
define v_control,v_idusu    integer;
define  par_axod,v_ctaapl1   int;
define  par_axoh   int;
define  par_importe money;
define  par_recar   money;
define  par_tot   money;
define  v_nombre,v_colonia  varchar(80);
define  v_domcompleto,v_desade VARCHAR(75);
define  v_exte,v_refe      VARCHAR(10);
define  v_inte      VARCHAR(10);
define v_r char(1);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -1, 'admin_pago_14 ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

-- set debug file to "pago14";
-- trace on;
  let v_r = 'N';
let v_control= nvl(p_segmento1,0);
let v_cont   = 0;
let v_axof   = 0;
let par_axod = 0;
let v_tok    = 0;
let v_idusu    = 0;
let par_axoh = nvl(p_Apagar,0); 

SELECT cementerio, clase, clase_alfa, seccion, seccion_alfa, linea, linea_alfa, fosa, fosa_alfa, 
         nombre,domicilio, exterior, interior,colonia
into  v_cem, v_clase, v_calfa, v_seccion, v_salfa, v_linea, v_lalfa, v_fosa, v_falfa,
      v_nombre,v_domcompleto,v_exte,v_inte,v_colonia
FROM ta_13_datosrcm where control_rcm=v_control;

select nvl(id_usuario,0) 
into v_idusu 
from ta_12_passwords where usuario=p_cajero;

SELECT axofin
into  v_axof
FROM  ta_13_descrec where id_folio =v_control and vigencia='V';

if v_idusu=0 then
   let v_idusu=335;
end if;

if v_idusu is null then
   let v_idusu=335;
end if;

if v_control>0 then
    BEGIN WORK;
   let v_r = 'S';
    insert into ta_12_recibos(fecha,id_rec,caja,operacion,importe,cvepago,id_modulo,id_regmodulo,
    id_rec_cta,regmunur,mesdesde,axodesde,meshasta,axohasta,nombre,domicilio,concepto,rfcnumero,
    axofolio,id_usuario,fecha_act,descripcion, id_centro, foliorecibo) 
    values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro, p_certifp,'P',13, v_control, 0, '',1,par_axod,12,par_axoh,
    v_nombre, (Trim(v_domcompleto)||' '||trim(v_exte) ||' '||trim(v_inte)), v_colonia, v_control, 0, v_idusu, current,
    (p_nomcajero||' '||p_foliorbo||' '||v_cem||' '||v_clase||' '||trim(v_calfa)||' '||v_seccion||' '||trim(v_salfa)||' '||v_linea||' '||trim(v_lalfa)||' '||v_fosa||' '||trim(v_falfa)),
     p_centrorbo, p_foliorbo);

    foreach
     execute PROCEDURE admin_adeudos_detalle_14odoo(v_control,'','','','','', p_Apagar) 
     into v_uno,v_dos, v_ctaapl1,v_refe,v_desade,par_importe, par_recar 
     let v_cont=v_cont+1;
     insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
     values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,v_desade,v_ctaapl1, par_importe);
     if par_axod = 0 then
        let par_axod=v_refe;
     end if;
    end foreach;

    if p_redonp <> 0 then
       let v_cont=v_cont+1;
       insert into ta_12_recibosdet(fecha,id_rec,caja,operacion,linea,descripcion,cuenta,importe)
       values(p_fechapago,p_recrbo,p_cajarbo,p_idcobro,v_cont,'Redondeo ',55080000, p_redonp);
    end if;

    INSERT INTO ta_13_pagosrcm  VALUES(p_fechapago, p_recrbo, p_cajarbo, p_idcobro, 0, v_control, v_cem, v_clase, v_calfa, v_seccion, v_salfa, 
        v_linea, v_lalfa, v_fosa, v_falfa, par_axod, par_axoh, p_certifp, 0, 'A', 0, today);

   let vcvepago=dbinfo("sqlca.sqlerrd1");

   update ta_13_adeudosrcm set  vigencia='P', id_pago=vcvepago
     where control_rcm=v_control and axo_adeudo between par_axod and par_axoh and vigencia='V';


   if par_axoh>=v_axof then
      update ta_13_descrec
     set vigencia='P', fec_pag=p_fechapago, id_rec=p_recrbo, caja=p_cajarbo, operac=p_idcobro 
      where id_folio =v_control and vigencia='V';
  end if;

    update ta_13_datosrcm set axo_pagado=par_axoh where control_rcm=v_control;

   update ta_13_descpens set vigencia='P' where control_rcm=v_control and axo_descto between par_axod and par_axoh and vigencia='V';

 --  EXECUTE procedure spd_13_insextra_admin(v_control, p_adicional2, p_adicional3, p_adicional4,p_adicional5, p_adicional6) into v_tok, v_tmsg;

   -- pone como pagado el registro para no calcular actualizacion
   update ta_13_noactualizacion set vigencia='P' where control_rcm=v_control;

   -- poner como pagado el registro para otorgar pronto pago
   update ta_13_dpp set vigente='P' where control_rcm=v_control;

  COMMIT WORK;  
return 0,'Pagado ' || vcvepago;
else
return 1,'Folio a PAGAR no encontrado ' ||v_control;
end if;
--trace off;
END FUNCTION;

create procedure "pgcabrer".spd_17_convenios_vencidos()
returning   char(15) as expediente,
            varchar(30) as referencia,
            varchar(30) as tipo,
            varchar(30) as subtipo,
            varchar(60) as nombre,
            varchar(60) as calle,
            int as exterior,
            int as interior,
            varchar(10) as inciso,
            date as fechainicio,
            date as fechafinal,
            varchar(100) as giro,
            varchar(20) as periodoconveniado,
            money(18,2) as adeudovencido,
            money(18,2) as recargos,
            money(18,2) as intereses;

define vexp,vinc varchar(15);
define vper varchar(20);
define vtipo,vsubt,vref varchar(30);
define vnombre,vcalle varchar(60); 
define vidresto,vext,vint,vparc,vnum,vaxo,vmod, vtipon int; 
define vfini,vffin,vfven, v_inicio date; 
define vcveparc, v_nvaforma char(1); 
define vlet char(3);
define vgiro varchar(100);
define vadevenc,vrecargos,vrec,vintereses,vinte,vadeudo,v_interesade money(18,2);
define vp_lic,vp_id,vp_blq,vp_idg int;
define vp_act varchar(130);
define vp_prop varchar(80); 
define vp_txtblq varchar(30);
define vp_vig char(1);

foreach
  select b.id_conv_resto,a.tipo,a.axo_exp,a.letras_exp,a.numero_exp,(trim(a.letras_exp)||'/'||a.numero_exp||'/'||a.axo_exp),
  f.descripcion,e.desc_subtipo,b.nombre,b.calle, b.num_exterior,b.num_interior,b.inciso,b.fecha_inicio,b.fecha_venc,sum(d.importe), sum(d.interes)
  into vidresto,vtipon,vaxo,vlet,vnum,vexp,vtipo,vsubt,vnombre,vcalle,vext,vint,vinc,vfini,vffin,vadeudo,v_interesade
  from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d, ta_17_tipos f,ta_17_subtipo_conv e
  where b.vigencia in ('A','Z') and b.fecha_venc <today and a.tipo<>14
  and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
  and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
  and f.tipo=b.tipo and e.tipo=a.tipo and e.subtipo=a.subtipo
  group by b.id_conv_resto,a.tipo,a.axo_exp,a.letras_exp,a.numero_exp,2,f.descripcion,e.desc_subtipo,b.nombre,b.calle,
  b.num_exterior,b.num_interior,b.inciso,b.fecha_inicio,b.fecha_venc
  order by a.axo_exp,a.letras_exp,a.numero_exp

  -- verifica el tipo de convenio para la nueva forma
  select nvaforma, fecha_inicio into v_nvaforma, v_inicio from ta_17_catparcnvo where tipo=vtipon;
 
  foreach
  select modulo,referencia,(mes_desde||'-'||axo_desde||' al '||mes_hasta||'-'||axo_hasta) into vmod,vref,vper 
  from ta_17_referencia where id_conv_resto=vidresto order by modulo desc
  end foreach;

  let vgiro='';
  if (vmod=9) or (vmod=10) then
     execute procedure catastro_gdl:spget_lic_estatus(trim(vref)) into vp_lic,vp_id,vp_act,vp_prop,vp_blq,vp_txtblq,vp_vig,vp_idg,vgiro;
  end if;

  let vintereses=0;
  let vrecargos=0;
  let vinte=0;
  let vrec=0;
  foreach
    select pago_parcial,importe,cve_parcialidad,fecha_venc into vparc,vadevenc,vcveparc,vfven
    from ta_17_adeudos_div
    where id_conv_resto=vidresto and fecha_venc <today and clave_pago is null 

    if (v_nvaforma='S') and (vfini>=v_inicio) then
       let vintereses=v_interesade;
    else
       if (vtipon=17) and (year(vfini)>=2020) then
          let vintereses=v_interesade;
       else
          execute procedure admin_intereses_22(vidresto,vfini,vparc,vcveparc) into vinte;
          let vintereses=vintereses+vinte;
       end if;
    end if;
   end foreach; 

    let vrecargos=0; 
  return vexp,vref,vtipo,vsubt,vnombre,vcalle,vext,vint,vinc,vfini,vffin,vgiro,vper,vadeudo,vrecargos,vintereses with resume;
end foreach;

end procedure;

create procedure "pgcabrer".spd_17_adevencidos()
returning   char(15) as expediente,
            varchar(30) as referencia,
            varchar(30) as tipo,
            varchar(30) as subtipo,
            varchar(60) as nombre,
            varchar(60) as calle,
            int as exterior,
            int as interior,
            varchar(10) as inciso,
            date as fechainicio,
            date as fechafinal,
            varchar(100) as giro,
            varchar(20) as periodoconveniado,
            money(18,2) as adeudovencido,
            money(18,2) as recargos,
            money(18,2) as intereses;

define vexp,vinc varchar(15);
define vper varchar(20);
define vtipo,vsubt,vref varchar(30);
define vnombre,vcalle varchar(60); 
define vidresto,vext,vint,vparc,vnum,vaxo,vmod, vtipon int; 
define vfini,vffin,vfven, v_inicio date; 
define vcveparc, v_nvaforma char(1); 
define vlet char(3);
define vgiro varchar(100);
define vadevenc,vrecargos,vrec,vintereses,vinte,vadeudo,v_interesade money(18,2);
define vp_lic,vp_id,vp_blq,vp_idg int;
define vp_act varchar(130);
define vp_prop varchar(80); 
define vp_txtblq varchar(30);
define vp_vig char(1);

foreach
  select b.id_conv_resto,a.tipo,a.axo_exp,a.letras_exp,a.numero_exp,(trim(a.letras_exp)||'/'||a.numero_exp||'/'||a.axo_exp),
  f.descripcion,e.desc_subtipo,b.nombre,b.calle, b.num_exterior,b.num_interior,b.inciso,b.fecha_inicio,b.fecha_venc,sum(d.importe), sum(d.interes)
  into vidresto,vtipon,vaxo,vlet,vnum,vexp,vtipo,vsubt,vnombre,vcalle,vext,vint,vinc,vfini,vffin,vadeudo,v_interesade
  from ta_17_conv_diverso a,ta_17_conv_d_resto b,ta_17_adeudos_div d, ta_17_tipos f,ta_17_subtipo_conv e
  where b.vigencia in ('A','Z') and d.fecha_venc <today and a.tipo<>14
  and b.tipo=a.tipo and b.id_conv_diver=a.id_conv_diver
  and d.clave_pago is null and d.id_conv_resto=b.id_conv_resto
  and f.tipo=b.tipo and e.tipo=a.tipo and e.subtipo=a.subtipo
  group by b.id_conv_resto,a.tipo,a.axo_exp,a.letras_exp,a.numero_exp,2,f.descripcion,e.desc_subtipo,b.nombre,b.calle,
  b.num_exterior,b.num_interior,b.inciso,b.fecha_inicio,b.fecha_venc
  order by a.axo_exp,a.letras_exp,a.numero_exp

  -- verifica el tipo de convenio para la nueva forma
  select nvaforma, fecha_inicio into v_nvaforma, v_inicio from ta_17_catparcnvo where tipo=vtipon;
 
  foreach
  select modulo,referencia,(mes_desde||'-'||axo_desde||' al '||mes_hasta||'-'||axo_hasta) into vmod,vref,vper 
  from ta_17_referencia where id_conv_resto=vidresto order by modulo desc
  end foreach;

  let vgiro='';
  if (vmod=9) or (vmod=10) then
     execute procedure catastro_gdl:spget_lic_estatus(trim(vref)) into vp_lic,vp_id,vp_act,vp_prop,vp_blq,vp_txtblq,vp_vig,vp_idg,vgiro;
  end if;

  let vintereses=0;
  let vrecargos=0;
  let vinte=0;
  let vrec=0;
  foreach
    select pago_parcial,importe,cve_parcialidad,fecha_venc into vparc,vadevenc,vcveparc,vfven
    from ta_17_adeudos_div
    where id_conv_resto=vidresto and fecha_venc <today and clave_pago is null 

    if (v_nvaforma='S') and (vfini>=v_inicio) then
       let vintereses=v_interesade;
    else
       if (vtipon=17) and (year(vfini)>=2020) then
          let vintereses=v_interesade;
       else
          execute procedure admin_intereses_22(vidresto,vfini,vparc,vcveparc) into vinte;
          let vintereses=vintereses+vinte;
       end if;
    end if;
   end foreach; 

    let vrecargos=0; 
  return vexp,vref,vtipo,vsubt,vnombre,vcalle,vext,vint,vinc,vfini,vffin,vgiro,vper,vadeudo,vrecargos,vintereses with resume;
end foreach;

end procedure;

CREATE FUNCTION "informix".admin_adeudos_detalle_13odoobeny(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(120) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia,v_mensaje,v_msgrenta,v_msgmulta varchar(30);
define  v_cveparc char(1);
define  v_letra1,v_let varchar(3);
define  v_bloque1,v_blq varchar(2);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses, v_actualizacion,v_descrenta decimal(14,2);
define  v_aimporte,v_descuento,v_porc,v_gastost,v_impdesc,v_muldesc, v_impcovid19, V_PCV19 decimal(14,2);
define  v_folreq,dias_cuantos,dias_habil,v_axomin,v_mesmin,v_porccovid19, v_porcdescrenta, v_porcdescmulta int;
define  v_fecreq,v_fecha_desc,v_fecha_rec,v_fecemi date;
define  v_id,v_idresto,v_idadeudo,v_parc,v_aaxo,v_aperiodo,v_dmes,v_desc,v_contador,v_porcdesc,v_cvecuo int;
define  v_ref char(7);
define  v_cuentaapl,v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp, v_ctaactualizacion int;

begin
    on exception in (-958)
       delete from tmp_totalesmerc;
    end exception;
create temp table tmp_totalesmerc(
  rubro int,
  concepto int,
  cuenta int,
  axo int,
  mes int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_porccovid19=0;
let v_impcovid19=0;
let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_actualizacion=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;
let v_contador=0;
let v_gastost=0;
let v_aperiodo=0;
let v_impdesc=0;
let v_muldesc=0;
let v_descrenta=0;
let v_msgrenta='';

if trim(pref)='' then
--   if trim(pmer)=95 then
--      let v_ref=2021||'/12';
--   else
      let v_ref=year(today)||'/12';
--   end if;
--   let v_ref='2020/12';
else
   let v_ref=trim(pref);
end if;


foreach
select id_local,letra_local,bloque,clave_cuota into v_id,v_let,v_blq,v_cvecuo
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    -- obtiene las cuentas de aplicacion para el mercado
    select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,
           cuenta_descmulta,cuenta_gastos,cuenta_descpp,cuenta_actualizacion
    into v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp,v_ctaactualizacion
    from ta_11_mercados where num_mercado_nvo=pmer;

    -- cuentas para locales exteriores del rastro cambios 2020
    if (pmer=90) and (v_cvecuo=17) then
       let v_ctaact=132010090;
       let v_ctarzg=132030090;
    end if;

    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id;
    -- para sacar el mes minimo      
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id and axo=v_axomin;

    if pmer=70 then
       let v_axomin=2017;
       let v_mesmin=1;
    end if;

    if trim(pmer)<>90 then
 --      if (today>=mdy(8,20,2020)) and (today<=mdy(10,31,2020)) then 
 --         execute procedure spd_15_descautrm(v_id, 'S', 'S',substr(v_ref,1,4),substr(v_ref,6,2) ); -- procedimiento anterior para multa de notificacion
 --      end if;
        if (pmer = 70 and today >= '2024-02-06') or (pmer != 70 or v_id = 14196) then
            if (substr(v_ref,1,4)='2024') and (substr(v_ref,6,2)='12') then
                execute procedure spd_15_descautrm(v_id, substr(v_ref,1,4),substr(v_ref,6,2),'A'); -- procedimiento actual para multa calculada
            else
                execute procedure spd_15_descautrm(v_id, substr(v_ref,1,4),substr(v_ref,6,2),'B'); -- procedimiento actual para multa calculada
            end if;
        end if;
    end if;

    -- para obtener el datos de multa y gastos
    foreach
    select b.fecha_emision,nvl(b.folio,0), nvl(b.importe_multa,0),nvl(importe_gastos,0),
    nvl(b.porcentaje_multa,0),nvl(b.fecha_practicado,null)
    into v_fecemi,v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
    from ta_15_apremios b
    where b.modulo=11 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
    order by  1,2
    let v_gastost=v_gastost+v_gastos;
    end foreach;

/*    let dias_cuantos=0;

    select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales
    where fecha between v_fecreq and today;
   
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
--           let v_multa=v_multa*50/100;
           let v_muldesc=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
--              let v_multa=v_multa*80/100;
              let v_muldesc=v_multa*20/100;
           end if;
        end if;
    else
--        let v_multa=(v_multa*(100-v_porcmul))/100;
        let v_muldesc=(v_multa*v_porcmul)/100;
    end if; */

    if v_gastost>0 then
       let v_acumulado=v_acumulado+v_gastost;
       return 0,v_ctagst, get_odoo_cta( v_ctagst , 13),v_axomin||'/'||lpad(v_mesmin,2,'0'),'GASTOS '||v_folreq,v_gastost,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctagst,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'GASTOS '||v_folreq,v_gastost,v_acumulado);
    end if;

    foreach
    select a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos,
           d.id_contribuy_renta
    into   v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec,v_desc
    from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d
    where a.id_local=v_id and
    ( (a.axo>v_axomin  or (periodo>=v_mesmin  and axo=v_axomin)) and
   ((a.axo=substr(v_ref,1,4)  and a.periodo<=substr(v_ref,6,2)) or (a.axo<substr(v_ref,1,4))) )  

    and b.mes=month(today) and d.id_local=a.id_local
    order by a.axo,a.periodo

    if v_id in(8926,7404,7405) then
       let v_fecha_desc='2025-05-07';
    end if; 
    if v_id in(8926,7404,7405) then
       let v_fecha_rec='2025-05-08';
    end if;

    let v_porc=0;
    let v_monto=0;
    let v_impdesc=0;
    let v_impcovid19=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    if (pmer=90) or (v_cvecuo=19) then
       let v_monto=v_aimporte;
    else
    if pmer=214 then
       let v_impdesc=(v_aimporte*v_desc)/100;
       let v_monto=v_aimporte;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_monto=v_aimporte;
             else          
                let v_impdesc=v_aimporte*.10;
                let v_monto=v_aimporte;
             end if;
          else
             let v_impdesc=v_aimporte*.10;
             let v_monto=v_aimporte;  
          end if;
       else          
          let v_monto=v_aimporte;
       end if;  
    end if;
    end if;
    if  v_aaxo=year(today) then
        let v_cuentaapl=v_ctaact;
    else
        let v_cuentaapl=v_ctarzg;
    end if;

    -- Se agrega correcci�n para DAGA de pago de varios locales que se pag� primero Diciembre y quedo el hueco de noviembre
    --if v_id in (2445,2446,2452,2451,2483,2439,2440,2435,2436,2437,2459,2429,2428,2427,2432,2448,2461,2462,2486,2477,2476) and year(today) = 2020 then
    --    let v_impdesc=v_aimporte*.10; -- Forzamos el DPP
    --end if;

    let v_acumulado=v_acumulado+v_monto;
    if pmer=214 then
       return 0,v_cuentaapl, get_odoo_cta( v_cuentaapl , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'PAGO TRIMESTRAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'PAGO TRIMESTRAL',v_monto,v_acumulado);
    else
       return 0,v_cuentaapl, get_odoo_cta( v_cuentaapl , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado);
    end if;

   -- calcula descuento en renta se agrega el 16/07/2021
   let v_descrenta=0;
   let v_msgrenta='';
   execute PROCEDURE sp_desctorenta( v_id, v_aaxo, v_aperiodo, v_monto) into v_descrenta, v_msgrenta;
   if v_descrenta>0 then
      let v_porcdescrenta=substr(v_msgrenta,length(v_msgrenta)-2,3);
      let v_descrenta=v_descrenta*-1;
      let v_acumulado=v_acumulado+v_descrenta;
      if pmer=214 then
         return 0,414902, get_odoo_cta( 414902 , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO ARRENDAMIENTO TRIMESTRAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado with resume;
         insert into tmp_totalesmerc values(0,0,414902,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO ARRENDAMIENTO TRIMESTRAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado);
      else
         return 0,414902, get_odoo_cta( 414902 , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO ARRENDAMIENTO MENSUAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado with resume;
         insert into tmp_totalesmerc values(0,0,414902,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO ARRENDAMIENTO MENSUAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado);
      end if;
   end if;

    if v_impdesc>0 then
       if pmer=214 then
          let v_impdesc=v_impdesc*-1;
          let v_acumulado=v_acumulado+v_impdesc;
          return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado);
       else
--          if (v_aaxo=2020) and (v_aperiodo>=4 and v_aperiodo<=6) then
--             let v_impdesc=v_monto*-1;
--             let v_acumulado=v_acumulado+v_impdesc;
--             return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado with resume;
--             insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
--                'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado);
--          else
             let v_impdesc=v_impdesc*-1;
             let v_acumulado=v_acumulado+v_impdesc;   
             return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado);
--          end if;
       end if;
--    else
--       if (v_aaxo=2020) and (v_aperiodo>=4 and v_aperiodo<=6) and (pmer<>90) and (v_cvecuo<>19) then
--          let v_impdesc=v_monto*-1;
--          let v_acumulado=v_acumulado+v_impdesc;
--          return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado with resume;
--          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
--                'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado);
--       end if;
    end if;

    -- calcula multa
    if ((v_cvecuo=19) and (v_aaxo=2025) and (v_aperiodo=1) and today<=mdy(2,1,2025)) then --or (pmer = 70 and today<=mdy(2,10,2024) and v_id <> 14196) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
       let v_multa=0;
    else    
       let v_multa=0;
       execute procedure spd_11_calc_multa(pmer, (v_monto+v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
       if v_multa>0 then
          let v_acumulado=v_acumulado+v_multa;
          return 0,v_ctamul, get_odoo_cta( v_ctamul , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'MULTA MENSUAL',v_multa,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctamul,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'MULTA MENSUAL',v_multa,v_acumulado);
       end if;
    end if;

    -- calcula descuento de multa
    let v_muldesc=0;
    execute PROCEDURE sp_desctomulta( v_id, v_aaxo, v_aperiodo, v_multa) into v_muldesc,v_msgmulta;
    if v_muldesc>0 then
       let v_porcdescmulta=substr(v_msgmulta,length(v_msgmulta)-2,3);
       let v_muldesc=v_muldesc*-1;
       let v_acumulado=v_acumulado+v_muldesc;
       return 0,v_ctadesmul, get_odoo_cta( v_ctadesmul , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO MULTA MENSUAL '||v_porcdescmulta||'%',v_muldesc,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctadesmul,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO MULTA MENSUAL '||v_porcdescmulta||'%',v_muldesc,v_acumulado);
    end if; 

    -- calculo de recargos
    if (v_cvecuo=19) and (v_aaxo=2025) and (v_aperiodo=1) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
    -- execute procedure admin_recargos_13(pmer,v_folreq,((v_monto+v_descrenta)+v_impdesc),mdy(v_aperiodo,11,v_aaxo)) into v_recargos; -- anterior sin v_descrenta mes de enero
       execute procedure admin_recargos_13(pmer,v_folreq,((v_monto+v_descrenta)+v_impdesc),mdy(2,1,v_aaxo)) into v_recargos; -- anterior sin v_descrenta mes diferente
    else
       execute procedure admin_recargos_13(pmer,v_folreq,((v_monto+v_descrenta)+v_impdesc),mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos; -- anterior sin v_descrenta
    end if;
   
 --   if (pmer=19 and v_aaxo>=2019) or (pmer=37 and v_aaxo>=2019) then -- quitar esta validacion terminando la promocion
 --      if (today>=mdy(3,4,2020)) and (today<=mdy(3,20,2020)) then
 --          let v_recargos=0;
 --      end if;  
 --   end if;
    
    -- Se agrega correcci�n para DAGA de pago de varios locales que se pag� primero Diciembre y quedo el hueco de noviembre
    --if v_id in (2445,2446,2452,2451,2483,2439,2440,2435,2436,2437,2459,2429,2428,2427,2432,2448,2461,2462,2486,2477,2476) and year(today) = 2020 then
    --    let v_recargos = 0; -- Forzamos no cobrar recargos
    --end if;
    if v_recargos>0 then
       let v_acumulado=v_acumulado+v_recargos;
       if pmer=214 then
          return 0,v_ctarec, get_odoo_cta( v_ctarec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO TRIMESTRAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO TRIMESTRAL',v_recargos,v_acumulado);
       else
          return 0,v_ctarec, get_odoo_cta( v_ctarec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO MENSUAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO MENSUAL',v_recargos,v_acumulado);
       end if;

--     if year(today)=2020 then
--        if month(today)=4 then 
--           if today>=v_fecha_rec then
--              let v_porccovid19=1;
--           else
--              let v_porccovid19=0;
--           end if;
--        else 
--        if month(today)=5 then 
--           if today>=v_fecha_rec then
--              let v_porccovid19=2;
--           else
--              let v_porccovid19=1;
--           end if;
--        else 
--        if month(today)=6 then 
--           if today>=v_fecha_rec then
--              let v_porccovid19=3;
--           else
--              let v_porccovid19=2;
--           end if;
--        else 
--           let  v_porccovid19=0;
--        end if; end if; end if; 
--     else
--        let v_porccovid19=0;
--     end if;

--     if v_porccovid19=1 then let V_PCV19=1.47;
--     else if v_porccovid19=2 then let V_PCV19=2.94;
--     else if v_porccovid19=3 then let V_PCV19=4.41;
--     end if; end if; end if;

       -- calculo descuento de recargos por contingencia de covid19
--       let v_impcovid19=0;
--       if (v_recargos>0) and (v_porccovid19>0) and (pmer<>90) then
--          execute procedure sp_desctomerc(v_id,v_aaxo,v_aperiodo,5,(v_monto+v_impdesc),null,0,'',v_porccovid19,11) into v_impcovid19,v_mensaje;
--          if v_impcovid19>0 then
--             let v_impcovid19=v_impcovid19*-1;
--             let v_acumulado=v_acumulado+v_impcovid19;  
--             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL CONTINGENCIA COVID-19 '||V_PCV19||'%',v_impcovid19,v_acumulado with resume;
--             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
--                'DESCUENTO RECARGO MENSUAL CONTINGENCIA COVID-19 '||V_PCV19||'%',v_impcovid19,v_acumulado);
--          end if;
--       end if;

       -- Calcula descuento de recargos
       let v_descuento=0;
       execute procedure sp_desctomerc(v_id,v_aaxo,v_aperiodo,1,(v_recargos+v_impcovid19),null,0,'',0,11) into v_descuento,v_mensaje;
       if v_descuento>0 then
          let v_porcdesc=substr(v_mensaje,length(v_mensaje)-2,3);
          let v_descuento=v_descuento*-1;
          let v_acumulado=v_acumulado+v_descuento;
          if pmer=214 then
             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          else
             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          end if;
       end if;
    end if;

    -- calcula actualizacion
    let v_actualizacion=0;
    if  v_impdesc=0 then
        execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, (v_monto+v_descrenta)) into v_actualizacion;
        if v_actualizacion>0 then
           let v_acumulado=v_acumulado+v_actualizacion;
           return 0,v_ctaactualizacion, get_odoo_cta( v_ctaactualizacion , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'ACTUALIZACION',v_actualizacion,v_acumulado with resume;
           insert into tmp_totalesmerc values(0,0,v_ctaactualizacion,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
           'ACTUALIZACION',v_actualizacion,v_acumulado);
        end if;
    end if;

    end foreach;
end if;
end foreach;

end function;

CREATE FUNCTION "informix".admin_adeudos_detalle_13odoo(pinterface int,prec char(10),pmer char(10),psecc varchar(10),
ploc varchar(10),plet varchar(10),pblq varchar(10),pref varchar(20))

returning   integer as rubro,
            integer as concepto,
            integer as cuentaaplicacion,
            varchar(30) as referencia,
            varchar(120) as descripcion,
            decimal(14,2) as monto,
            decimal(14,2) as acumulado;

define  v_referencia,v_mensaje,v_msgrenta,v_msgmulta varchar(30);
define  v_cveparc char(1);
define  v_letra1,v_let varchar(3);
define  v_bloque1,v_blq varchar(2);
define  v_importe,v_monto,v_acumulado,v_multa,v_porcmul,v_gastos,v_recargos,v_intereses, v_actualizacion,v_descrenta decimal(14,2);
define  v_aimporte,v_descuento,v_porc,v_gastost,v_impdesc,v_muldesc, v_impcovid19, V_PCV19 decimal(14,2);
define  v_folreq,dias_cuantos,dias_habil,v_axomin,v_mesmin,v_porccovid19, v_porcdescrenta, v_porcdescmulta int;
define  v_fecreq,v_fecha_desc,v_fecha_rec,v_fecemi date;
define  v_id,v_idresto,v_idadeudo,v_parc,v_aaxo,v_aperiodo,v_dmes,v_desc,v_contador,v_porcdesc,v_cvecuo int;
define  v_ref char(7);
define  v_cuentaapl,v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp, v_ctaactualizacion int;

begin
    on exception in (-958)
       delete from tmp_totalesmerc;
    end exception;
create temp table tmp_totalesmerc(
  rubro int,
  concepto int,
  cuenta int,
  axo int,
  mes int,
  referencia varchar(30),
  descripcion varchar(120),
  monto money(14,2),
  acumulado money(14,2)) with no log;
end;

let v_porccovid19=0;
let v_impcovid19=0;
let v_acumulado=0;
let v_fecreq=0;
let v_folreq=0;
let v_multa=0;
let v_gastos=0;
let v_actualizacion=0;
let v_porcmul=0;
let v_recargos=0;
let v_intereses=0;
let v_contador=0;
let v_gastost=0;
let v_aperiodo=0;
let v_impdesc=0;
let v_muldesc=0;
let v_descrenta=0;
let v_msgrenta='';

if trim(pref)='' then
--   if trim(pmer)=95 then
--      let v_ref=2021||'/12';
--   else
      let v_ref=year(today)||'/12';
--   end if;
--   let v_ref='2020/12';
else
   let v_ref=trim(pref);
end if;


foreach
select id_local,letra_local,bloque,clave_cuota into v_id,v_let,v_blq,v_cvecuo
from ta_11_locales where oficina=prec and num_mercado=pmer and seccion=psecc and local=ploc
if v_let is null then
   let v_letra1='0';
else
   let v_letra1=v_let;
end if;
if v_blq is null then
   let v_bloque1='0';
else
   let v_bloque1=v_blq;
end if;
if  (trim(v_letra1)=trim(plet)) and (trim(v_bloque1)=trim(pblq)) then
    let v_contador=v_contador+1;
    -- obtiene las cuentas de aplicacion para el mercado
    select cuenta_ingreso,cuenta_rezago,cuenta_recargos,cuenta_descrecargo,cuenta_multa,
           cuenta_descmulta,cuenta_gastos,cuenta_descpp,cuenta_actualizacion
    into v_ctaact,v_ctarzg,v_ctarec,v_ctadesrec,v_ctamul,v_ctadesmul,v_ctagst,v_ctadespp,v_ctaactualizacion
    from ta_11_mercados where num_mercado_nvo=pmer;

    -- cuentas para locales exteriores del rastro cambios 2020
    if (pmer=90) and (v_cvecuo=17) then
       let v_ctaact=132010090;
       let v_ctarzg=132030090;
    end if;

    -- para sacar el a�o minimo
    select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=v_id;
    -- para sacar el mes minimo      
    select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=v_id and axo=v_axomin;

    if pmer=70 then
       let v_axomin=2017;
       let v_mesmin=1;
    end if;

    if trim(pmer)<>90 then
 --      if (today>=mdy(8,20,2020)) and (today<=mdy(10,31,2020)) then 
 --         execute procedure spd_15_descautrm(v_id, 'S', 'S',substr(v_ref,1,4),substr(v_ref,6,2) ); -- procedimiento anterior para multa de notificacion
 --      end if;
        if (pmer = 70 and today >= '2024-02-06') or (pmer != 70 or v_id = 14196) then
            if (substr(v_ref,1,4)='2024') and (substr(v_ref,6,2)='12') then
                execute procedure spd_15_descautrm(v_id, substr(v_ref,1,4),substr(v_ref,6,2),'A'); -- procedimiento actual para multa calculada
            else
                execute procedure spd_15_descautrm(v_id, substr(v_ref,1,4),substr(v_ref,6,2),'B'); -- procedimiento actual para multa calculada
            end if;
        end if;
    end if;

    -- para obtener el datos de multa y gastos
    foreach
    select b.fecha_emision,nvl(b.folio,0), nvl(b.importe_multa,0),nvl(importe_gastos,0),
    nvl(b.porcentaje_multa,0),nvl(b.fecha_practicado,null)
    into v_fecemi,v_folreq,v_multa,v_gastos,v_porcmul,v_fecreq
    from ta_15_apremios b
    where b.modulo=11 and b.control_otr=v_id and b.vigencia='1' and b.clave_practicado='P'
    order by  1,2
    let v_gastost=v_gastost+v_gastos;
    end foreach;

/*    let dias_cuantos=0;

    select nvl(count(*),0) into dias_habil from catastro_gdl:no_laborales
    where fecha between v_fecreq and today;
   
    let dias_cuantos=(today-v_fecreq)-dias_habil;
    if  v_porcmul=100 then
        if dias_cuantos <=6 then
--           let v_multa=v_multa*50/100;
           let v_muldesc=v_multa*50/100;
        else
           if (dias_cuantos >=7) and (dias_cuantos<=16) then
--              let v_multa=v_multa*80/100;
              let v_muldesc=v_multa*20/100;
           end if;
        end if;
    else
--        let v_multa=(v_multa*(100-v_porcmul))/100;
        let v_muldesc=(v_multa*v_porcmul)/100;
    end if; */

    if v_gastost>0 then
       let v_acumulado=v_acumulado+v_gastost;
       return 0,v_ctagst, get_odoo_cta( v_ctagst , 13),v_axomin||'/'||lpad(v_mesmin,2,'0'),'GASTOS '||v_folreq,v_gastost,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctagst,v_axomin,v_mesmin,v_axomin||'/'||lpad(v_mesmin,2,'0'),
                'GASTOS '||v_folreq,v_gastost,v_acumulado);
    end if;

    foreach
    select a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos,
           d.id_contribuy_renta
    into   v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec,v_desc
    from    ta_11_adeudo_local a,ta_11_fecha_desc b,ta_11_locales d
    where a.id_local=v_id and
    ( (a.axo>v_axomin  or (periodo>=v_mesmin  and axo=v_axomin)) and
   ((a.axo=substr(v_ref,1,4)  and a.periodo<=substr(v_ref,6,2)) or (a.axo<substr(v_ref,1,4))) )  

    and b.mes=month(today) and d.id_local=a.id_local
    order by a.axo,a.periodo

-- para locales que no deban cobrar recragos multa y actualizacion, as� como descuento de pronto pago 
 --   if v_id in(8926,7404,7405) then
 --      let v_fecha_desc='2025-05-07';
 --   end if; 
 --   if v_id in(8926,7404,7405) then
 --      let v_fecha_rec='2025-05-08';
 --   end if;

    let v_porc=0;
    let v_monto=0;
    let v_impdesc=0;
    let v_impcovid19=0;
    if  v_desc is null then
        let v_desc=0;
    end if;
    if (pmer=90) or (v_cvecuo=19) then
       let v_monto=v_aimporte;
    else
    if pmer=214 then
       let v_impdesc=(v_aimporte*v_desc)/100;
       let v_monto=v_aimporte;
    else
       if ((v_aaxo>year(today)  or (v_aperiodo>=month(today)  and v_aaxo=year(today)))) then
          if v_aperiodo=month(today) then
             if today>v_fecha_desc then
                let v_monto=v_aimporte;
             else          
                let v_impdesc=v_aimporte*.10;
                let v_monto=v_aimporte;
             end if;
          else
             let v_impdesc=v_aimporte*.10;
             let v_monto=v_aimporte;  
          end if;
       else          
          let v_monto=v_aimporte;
       end if;  
    end if;
    end if;
    if  v_aaxo=year(today) then
        let v_cuentaapl=v_ctaact;
    else
        let v_cuentaapl=v_ctarzg;
    end if;

    -- Se agrega correcci�n para DAGA de pago de varios locales que se pag� primero Diciembre y quedo el hueco de noviembre
    --if v_id in (2445,2446,2452,2451,2483,2439,2440,2435,2436,2437,2459,2429,2428,2427,2432,2448,2461,2462,2486,2477,2476) and year(today) = 2020 then
    --    let v_impdesc=v_aimporte*.10; -- Forzamos el DPP
    --end if;

    let v_acumulado=v_acumulado+v_monto;
    if pmer=214 then
       return 0,v_cuentaapl, get_odoo_cta( v_cuentaapl , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'PAGO TRIMESTRAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'PAGO TRIMESTRAL',v_monto,v_acumulado);
    else
       return 0,v_cuentaapl, get_odoo_cta( v_cuentaapl , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_cuentaapl,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'ARRENDAMIENTO MENSUAL',v_monto,v_acumulado);
    end if;

   -- calcula descuento en renta se agrega el 16/07/2021
   let v_descrenta=0;
   let v_msgrenta='';
   execute PROCEDURE sp_desctorenta( v_id, v_aaxo, v_aperiodo, v_monto) into v_descrenta, v_msgrenta;
   if v_descrenta>0 then
      let v_porcdescrenta=substr(v_msgrenta,length(v_msgrenta)-2,3);
      let v_descrenta=v_descrenta*-1;
      let v_acumulado=v_acumulado+v_descrenta;
      if pmer=214 then
         return 0,414902, get_odoo_cta( 414902 , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO ARRENDAMIENTO TRIMESTRAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado with resume;
         insert into tmp_totalesmerc values(0,0,414902,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO ARRENDAMIENTO TRIMESTRAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado);
      else
         return 0,414902, get_odoo_cta( 414902 , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO ARRENDAMIENTO MENSUAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado with resume;
         insert into tmp_totalesmerc values(0,0,414902,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO ARRENDAMIENTO MENSUAL '||v_porcdescrenta||'%',v_descrenta,v_acumulado);
      end if;
   end if;

    if v_impdesc>0 then
       if pmer=214 then
          let v_impdesc=v_impdesc*-1;
          let v_acumulado=v_acumulado+v_impdesc;
          return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO '||v_desc||'%',v_impdesc,v_acumulado);
       else
--          if (v_aaxo=2020) and (v_aperiodo>=4 and v_aperiodo<=6) then
--             let v_impdesc=v_monto*-1;
--             let v_acumulado=v_acumulado+v_impdesc;
--             return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado with resume;
--             insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
--                'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado);
--          else
             let v_impdesc=v_impdesc*-1;
             let v_acumulado=v_acumulado+v_impdesc;   
             return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO POR PRONTO PAGO 10%',v_impdesc,v_acumulado);
--          end if;
       end if;
--    else
--       if (v_aaxo=2020) and (v_aperiodo>=4 and v_aperiodo<=6) and (pmer<>90) and (v_cvecuo<>19) then
--          let v_impdesc=v_monto*-1;
--          let v_acumulado=v_acumulado+v_impdesc;
--          return 0,v_ctadespp, get_odoo_cta( v_ctadespp , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado with resume;
--          insert into tmp_totalesmerc values(0,0,v_ctadespp,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
--                'DESCUENTO CONTINGENCIA COVID-19 100%',v_impdesc,v_acumulado);
--       end if;
    end if;

    -- calcula multa
    if ((v_cvecuo=19) and (v_aaxo=2025) and (v_aperiodo=1) and today<=mdy(2,1,2025)) then --or (pmer = 70 and today<=mdy(2,10,2024) and v_id <> 14196) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
       let v_multa=0;
    else    
       let v_multa=0;
       execute procedure spd_11_calc_multa(pmer, (v_monto+v_descrenta), mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_multa;
       if v_multa>0 then
          let v_acumulado=v_acumulado+v_multa;
          return 0,v_ctamul, get_odoo_cta( v_ctamul , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'MULTA MENSUAL',v_multa,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctamul,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'MULTA MENSUAL',v_multa,v_acumulado);
       end if;
    end if;

    -- calcula descuento de multa
    let v_muldesc=0;
    execute PROCEDURE sp_desctomulta( v_id, v_aaxo, v_aperiodo, v_multa) into v_muldesc,v_msgmulta;
    if v_muldesc>0 then
       let v_porcdescmulta=substr(v_msgmulta,length(v_msgmulta)-2,3);
       let v_muldesc=v_muldesc*-1;
       let v_acumulado=v_acumulado+v_muldesc;
       return 0,v_ctadesmul, get_odoo_cta( v_ctadesmul , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO MULTA MENSUAL '||v_porcdescmulta||'%',v_muldesc,v_acumulado with resume;
       insert into tmp_totalesmerc values(0,0,v_ctadesmul,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO MULTA MENSUAL '||v_porcdescmulta||'%',v_muldesc,v_acumulado);
    end if; 

    -- calculo de recargos
    if (v_cvecuo=19) and (v_aaxo=2025) and (v_aperiodo=1) then -- cambiar cada a�o el a�o, mes y dia de recargos 11/01/2022 peticion de Claudia Jara por correo
    -- execute procedure admin_recargos_13(pmer,v_folreq,((v_monto+v_descrenta)+v_impdesc),mdy(v_aperiodo,11,v_aaxo)) into v_recargos; -- anterior sin v_descrenta mes de enero
       execute procedure admin_recargos_13(pmer,v_folreq,((v_monto+v_descrenta)+v_impdesc),mdy(2,1,v_aaxo)) into v_recargos; -- anterior sin v_descrenta mes diferente
    else
       execute procedure admin_recargos_13(pmer,v_folreq,((v_monto+v_descrenta)+v_impdesc),mdy(v_aperiodo,day(v_fecha_rec),v_aaxo)) into v_recargos; -- anterior sin v_descrenta
    end if;
   
 --   if (pmer=19 and v_aaxo>=2019) or (pmer=37 and v_aaxo>=2019) then -- quitar esta validacion terminando la promocion
 --      if (today>=mdy(3,4,2020)) and (today<=mdy(3,20,2020)) then
 --          let v_recargos=0;
 --      end if;  
 --   end if;
    
    -- Se agrega correcci�n para DAGA de pago de varios locales que se pag� primero Diciembre y quedo el hueco de noviembre
    --if v_id in (2445,2446,2452,2451,2483,2439,2440,2435,2436,2437,2459,2429,2428,2427,2432,2448,2461,2462,2486,2477,2476) and year(today) = 2020 then
    --    let v_recargos = 0; -- Forzamos no cobrar recargos
    --end if;
    if v_recargos>0 then
       let v_acumulado=v_acumulado+v_recargos;
       if pmer=214 then
          return 0,v_ctarec, get_odoo_cta( v_ctarec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO TRIMESTRAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO TRIMESTRAL',v_recargos,v_acumulado);
       else
          return 0,v_ctarec, get_odoo_cta( v_ctarec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'RECARGO MENSUAL',v_recargos,v_acumulado with resume;
          insert into tmp_totalesmerc values(0,0,v_ctarec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'RECARGO MENSUAL',v_recargos,v_acumulado);
       end if;

--     if year(today)=2020 then
--        if month(today)=4 then 
--           if today>=v_fecha_rec then
--              let v_porccovid19=1;
--           else
--              let v_porccovid19=0;
--           end if;
--        else 
--        if month(today)=5 then 
--           if today>=v_fecha_rec then
--              let v_porccovid19=2;
--           else
--              let v_porccovid19=1;
--           end if;
--        else 
--        if month(today)=6 then 
--           if today>=v_fecha_rec then
--              let v_porccovid19=3;
--           else
--              let v_porccovid19=2;
--           end if;
--        else 
--           let  v_porccovid19=0;
--        end if; end if; end if; 
--     else
--        let v_porccovid19=0;
--     end if;

--     if v_porccovid19=1 then let V_PCV19=1.47;
--     else if v_porccovid19=2 then let V_PCV19=2.94;
--     else if v_porccovid19=3 then let V_PCV19=4.41;
--     end if; end if; end if;

       -- calculo descuento de recargos por contingencia de covid19
--       let v_impcovid19=0;
--       if (v_recargos>0) and (v_porccovid19>0) and (pmer<>90) then
--          execute procedure sp_desctomerc(v_id,v_aaxo,v_aperiodo,5,(v_monto+v_impdesc),null,0,'',v_porccovid19,11) into v_impcovid19,v_mensaje;
--          if v_impcovid19>0 then
--             let v_impcovid19=v_impcovid19*-1;
--             let v_acumulado=v_acumulado+v_impcovid19;  
--             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL CONTINGENCIA COVID-19 '||V_PCV19||'%',v_impcovid19,v_acumulado with resume;
--             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
--                'DESCUENTO RECARGO MENSUAL CONTINGENCIA COVID-19 '||V_PCV19||'%',v_impcovid19,v_acumulado);
--          end if;
--       end if;

       -- Calcula descuento de recargos
       let v_descuento=0;
       execute procedure sp_desctomerc(v_id,v_aaxo,v_aperiodo,1,(v_recargos+v_impcovid19),null,0,'',0,11) into v_descuento,v_mensaje;
       if v_descuento>0 then
          let v_porcdesc=substr(v_mensaje,length(v_mensaje)-2,3);
          let v_descuento=v_descuento*-1;
          let v_acumulado=v_acumulado+v_descuento;
          if pmer=214 then
             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO TRIMESTRAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          else
             return 0,v_ctadesrec, get_odoo_cta( v_ctadesrec , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado with resume;
             insert into tmp_totalesmerc values(0,0,v_ctadesrec,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
                'DESCUENTO RECARGO MENSUAL '||v_porcdesc||'%',v_descuento,v_acumulado);
          end if;
       end if;
    end if;

    -- calcula actualizacion
    let v_actualizacion=0;
    if  v_impdesc=0 then
        execute function spd_11_calc_actualizacion(v_aaxo, v_aperiodo, (v_monto+v_descrenta)) into v_actualizacion;
        if v_actualizacion>0 then
           let v_acumulado=v_acumulado+v_actualizacion;
           return 0,v_ctaactualizacion, get_odoo_cta( v_ctaactualizacion , 13),v_aaxo||'/'||lpad(v_aperiodo,2,'0'),'ACTUALIZACION',v_actualizacion,v_acumulado with resume;
           insert into tmp_totalesmerc values(0,0,v_ctaactualizacion,v_aaxo,v_aperiodo,v_aaxo||'/'||lpad(v_aperiodo,2,'0'),
           'ACTUALIZACION',v_actualizacion,v_acumulado);
        end if;
    end if;

    end foreach;
end if;
end foreach;

end function;

create function "pgcabrer".spd_16_calc_vencimiento_nuevos ( pfecha date, pclave_dia char(1) )
    returning   date as v_fecha_vencimiento;

define v_fecha_vencimiento date;
define dias_cuantos, dias_habil, v_cont int;

let v_fecha_vencimiento=null;

if pclave_dia='N' then

   let v_fecha_vencimiento=pfecha+5;

   let dias_cuantos=0;
   select nvl(count(*),0) into dias_habil from catastro_gdl:no_laboraleslic where fecha =v_fecha_vencimiento;

   while dias_cuantos <> dias_habil
     let v_fecha_vencimiento = v_fecha_vencimiento+1;
     select nvl(count(*),0) into dias_habil from catastro_gdl:no_laboraleslic where fecha =v_fecha_vencimiento;
  end while;
  let v_fecha_vencimiento = v_fecha_vencimiento+1;
end if;

if pclave_dia='H' then 

   let v_fecha_vencimiento=pfecha+1;
   let dias_cuantos=6;
   let v_cont=0;
   while  v_cont <> dias_cuantos
       select nvl(count(*),0) into dias_habil from catastro_gdl:no_laboraleslic where fecha =v_fecha_vencimiento;
       if dias_habil = 0 then
          let v_cont = v_cont+1;
       end if; 
       let v_fecha_vencimiento = v_fecha_vencimiento+1;
   end while;

end if;

return v_fecha_vencimiento;
   
end function;

create procedure "pgcabrer".spd_17_desgloce2021_arregla_manual(pid int, pparc int)
returning   int as parcial,
            money(16,2) as importe,
            money(16,2) as interes,
            money(16,2) as pago_total,
            date as vencimiento,
            char(1) as cveparcial,
            int as axodsd,
            int as mesdsd,
            int as axohst,
            int as meshst;

define v_parcial,v_axodsd,v_mesdsd,v_axohst,meshst,v_idlocal,v_ctaimp,v_ctarec,v_ctaact,v_ctamul int;
define v_pagos,v_mod,v_axodet,v_mesdet,v_cont,v_reg,v_linea,v_diac, v_pago_parcial int; 
define v_apdsd,v_mpdsd,v_aphst,v_mphst,v_totlin,v_totreg,v_mes,v_dia,v_axo int; 
define v_imprte,v_inicial,v_impdet,v_recdet,v_saldo,v_impparc,v_actdet,v_muldet,v_cant_total money(16,2);
define v_parc_total, v_interes, pparcial, v_importe_pago, v_interes_pagado money(18,2);
define v_porc decimal(11,8);
define v_vencimiento,v_inicio,v_mensual date;
define v_cveparc,v_tipo_pago, v_cve_parcialidad char(1);
define v_concdet varchar(30);

begin
    on exception in (-958)
       delete from tmp_detalle2021;
    end exception;
create temp table tmp_detalle2021(
  parcialidad int,
  adeudo money(14,2),
  interes money(14,2), 
  pago money(14,2),
  vencimiento date,
  cveparcial char(1)) with no log;
end;

let v_saldo=0;
let v_reg=0;
let v_vencimiento=null;
let v_mensual=null;
let v_totlin=0;
let v_totreg=0;
let v_linea=0;
let v_apdsd=0;
let v_mpdsd=0;
let v_aphst=0;
let v_mphst=0;
let v_linea=0;
let v_diac=0;
let v_cant_total=0;
let pparcial=0;
let v_interes_pagado=0;

if not exists(select * from ta_17_conv_d_resto where id_conv_resto=pid) then 
   return 0, 0, 0, 0, null, ' ', 0, 0, 0, 0;
end if;

foreach
  select nvl(a.cantidad_inicio,0),nvl(a.total_pagos,0),a.fecha_inicio,nvl(b.modulo,0),nvl(b.id_referencia,0),nvl(b.axo_desde,0),
   nvl(b.mes_desde,0),nvl(b.axo_hasta,0),nvl(b.mes_hasta,0),a.tipo_pago,nvl(a.cantidad_total,0)
  into v_inicial,v_pagos,v_inicio,v_mod,v_idlocal,v_axodsd,v_mesdsd,v_axohst,meshst,v_tipo_pago,v_cant_total
  from ta_17_conv_d_resto a,ta_17_referencia b where a.id_conv_resto=pid
  and b.id_conv_resto=a.id_conv_resto
end foreach;

-- obtine el porcentaje del interes
select nvl(porcentaje,0) into v_porc from ta_12_intereses where axo=year(v_inicio) and mes=month(v_inicio);
if v_porc is null then
   let v_porc=0;
end if;

-- Empieza el calculo las parcialidades

-- obtiene los pagos ya realizados
let v_saldo=v_cant_total; 
if pparc >= 2 then
   foreach
     select  p.importe_pago, p.pago_parcial, ap.cve_parcialidad, ap.interes into v_importe_pago, v_pago_parcial, v_cve_parcialidad, v_interes_pagado 
     from ta_17_conv_pagos p, ta_17_adeudos_div ap where p.id_conv_resto = pid and  p.pago_parcial<pparc 
     and ap.id_conv_resto=p.id_conv_resto and ap.pago_parcial=p.pago_parcial

      if v_cve_parcialidad = 'P' then
         let v_inicio = v_inicio + 30;
      end if;
      insert into tmp_detalle2021 values(v_pago_parcial, v_importe_pago, v_interes_pagado, v_importe_pago, v_inicio, v_cve_parcialidad);     
      let v_saldo = v_saldo - v_importe_pago;
   end foreach;
end if;

-- inserta parcialidades
execute function fn_17_calc_parcialidad(v_porc, (v_pagos-v_pago_parcial), v_saldo) into pparcial;
let v_vencimiento=v_inicio;
let v_mensual=v_inicio;
let v_impparc=0;
for v_cont=pparc to v_pagos
   let v_interes=(v_porc * v_saldo) / 100;
   let v_impparc=pparcial - v_interes;

   let v_diac=day(v_inicio);
   if v_diac = 31 then
      if  (month(v_mensual) = 4 or month(v_mensual) =6 or month(v_mensual) =9 or month(v_mensual) =11) then   
          let v_diac=30;
      else
          if month(v_mensual) = 2 then  
             let v_diac = 28;
          end if;
      end if;
   end if;
   if v_diac = 30 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   if v_diac = 29 then
      if month(v_mensual) = 2 then  
         let v_diac = 28;
      end if;
   end if;
   execute function fn_17_calc_venc(mdy(month(v_mensual),v_diac,year(v_mensual)),v_tipo_pago) into v_vencimiento,v_mensual;
   insert into tmp_detalle2021 values(v_cont, v_impparc, v_interes,  v_impparc+v_interes, v_vencimiento, 'P');
   let v_saldo=v_saldo - v_impparc;
end for;

-- regresa las parcialidades calculadas
foreach
  select parcialidad, adeudo, interes, pago, vencimiento, cveparcial 
  into v_linea, v_impparc, v_interes, v_parc_total, v_vencimiento, v_cveparc
  from tmp_detalle2021 order by parcialidad

  return v_linea, v_impparc, v_interes, v_parc_total, v_vencimiento, v_cveparc, 0, 0, 0, 0 with resume;
end foreach;

end procedure;

create procedure "pgcabrer".arregla_convenio_manual(pid_conv int, pparc int)
returning int as status;

define vestatus, v_id_usuario int;
define v_parcial, v_axodsd, v_mesdsd, v_axohst, meshst, v_tipo int;
define v_importe, v_interes, v_pago_total money(16,2);
define v_vencimiento, v_inicio date;
define v_cveparc, v_nvaforma char(1);

select id_usuario into v_id_usuario from ta_17_conv_d_resto where id_conv_resto=pid_conv;
let vestatus=0;
foreach
  execute procedure spd_17_desgloce2021_arregla_manual(pid_conv, pparc) 
    into v_parcial,v_importe,v_interes,v_pago_total,v_vencimiento,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst
  if  v_parcial>=pparc then
      insert into ta_17_adeudos_div values(0,pid_conv,v_parcial,v_pago_total,v_importe,v_interes,v_vencimiento,
        v_id_usuario,current,null,v_cveparc,v_axodsd,v_mesdsd,v_axohst,meshst,v_importe,0);
        let vestatus=vestatus+1;
  end if;
end foreach;
return vestatus;
end procedure;

CREATE PROCEDURE "pgcabrer".spd_11_padtotmerc(p_axo int)
returning	char(30) as Nombre,
            smallint as Rec,
            smallint as Merc,
            smallint as Cat,
            char(2) as Secc,
            integer as Local,
            char(1) as Letra,
            char(1) as Bloque,
            char(20) as adicional,
            char(60) as Locatario,
            decimal(15,2) as superficie,
            money(15,2) as Renta,
            date as Alta,
            date as Baja,
            char(1) as estado;
define vofn smallint;
define vmer smallint;
define vcat smallint;
define vsec char(2);
define vloc integer;
define vcve smallint;
define vsup decimal(15,2);
define vrenta money(15,2);
define vdes char(30);
define vtloc integer;
define vtsup decimal(15,2);
define vtrenta money(15,2);
define vtmer smallint;
define vtdes char(30);
define vlet char(1);
define vblq char(1);
define vadd char(20);
define vnom char(60);
define vfalt date;
define vfbaj date;
define vest char(1);

begin
    on exception in (-958)
       delete from tmp_padronmerc;
    end exception;
create temp table tmp_padronmerc(
  oficina smallint NOT NULL,
  num_mercado smallint NOT NULL,
  categoria SMALLINT,
  seccion char(2),
  local integer,
  letra char(1),
  bloque char(1),
  adicional char(20),
  nombre char(60),
  superficie decimal(16,2),
  renta MONEY(16,2),
  fechaalt date,
  fechabaj date,
  estado char(1),
  descripcion char(30)
);
end;

foreach
select a.oficina,a.num_mercado,a.categoria,a.seccion,a.local,a.letra_local,a.bloque,a.descripcion_local,a.nombre,a.fecha_alta,a.fecha_baja,a.vigencia,a.clave_cuota,a.superficie,b.descripcion 
into vofn,vmer,vcat,vsec,vloc,vlet,vblq,vadd,vnom,vfalt,vfbaj,vest,vcve,vsup,vdes
from ta_11_locales a,ta_11_mercados b
where   b.tipo_emision in ('M','O')  --<>'B' and a.num_mercado not in(99,214)
and b.num_mercado_nvo=a.num_mercado
order by a.oficina,a.num_mercado,a.categoria,a.seccion,a.local

execute procedure spd_11_calc_renta(p_axo,vcat,vsec,vcve,vsup,vmer,1) into vrenta;
insert into tmp_padronmerc values(vofn,vmer,vcat,vsec,vloc,vlet,vblq,vadd,vnom,vsup,vrenta,vfalt,vfbaj,vest,vdes);
end foreach;

--foreach
--select a.num_mercado,b.descripcion,count(*),sum(a.superficie),sum(a.renta)
--into vtmer,vtdes,vtloc,vtsup,vtrenta
--from tmp_padronmerc a, ta_11_mercados b
--where b.oficina=a.oficina and b.num_mercado_nvo=a.num_mercado
--group by a.num_mercado,b.descripcion
--order by a.num_mercado

--return vtmer,vtdes,vtloc,vtsup,vtrenta

foreach
select descripcion,oficina,num_mercado,categoria,seccion,local,letra,bloque,adicional,nombre,superficie,renta,fechaalt,fechabaj,estado
into vdes,vofn,vmer,vcat,vsec,vloc,vlet,vblq,vadd,vnom,vsup,vrenta,vfalt,vfbaj,vest
from tmp_padronmerc 
order by oficina,num_mercado,categoria,seccion,local,letra,bloque

return vdes,vofn,vmer,vcat,vsec,vloc,vlet,vblq,vadd,vnom,vsup,vrenta,vfalt,vfbaj,vest
with resume;
end foreach;
end procedure;

create procedure "pgcabrer".sp_99_altaregistro(pcontrato int, pnombre varchar(100), pcalle varchar(100), pmetros decimal(5,2), pcostomtr money(18,2), ptipo char(1))
    returning   int as estado,
                varchar(100) as mensaje;

define v_idcontrol, v_estado, v_cont int;
define v_costototal, v_mensualidad money(18,2);
define v_mensaje varchar(100);

let v_estado = '0';
let v_mensaje = '';

if not exists (select * from ta_99_proyecto_obra_pavimiento where contrato=pcontrato) then
   let v_costototal = pmetros * pcostomtr;
   insert into ta_99_proyecto_obra_pavimiento (id_control, contrato, nombre, calle, metros, costomtr, costototal, tipo_pavimento) 
      values(0, pcontrato, pnombre, pcalle, pmetros, pcostomtr, v_costototal, ptipo);
   let v_idcontrol = dbinfo("sqlca.sqlerrd1"); 

  let v_mensualidad = v_costototal / 12;
  for v_cont=1 to 12
    
    insert into ta_99_adeudos_obra (id_adeudo, id_control, axo, mes, mensualidad, numero_recibo, estado)
       values(0, v_idcontrol, year(today), v_cont, v_mensualidad, null, 'V');

  end for; 
   let v_estado = '0';
   let v_mensaje = 'El contrato se registro correctamente';   
else
   let v_estado = '-1';
   let v_mensaje = 'Ya existe el numero de contrato.. Verifica';   
end if;

return v_estado, v_mensaje;

end procedure;

CREATE FUNCTION "pgcabrer".admin_adeudos_detalle_18odoo(p_tipo CHAR(1), p_numero INT, pref VARCHAR(20))
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_18
#  Descripcion:      Interfaz de consulta de detalle para el cobro de Aseo Contratado en el sistema ADMIN
#
#  Parametros       p_tipo = tipo de registro C = Zona Centro O = Ordinario H = Hospitalario
#  de entrada:      p_numero = Numero de Contrato
#                   pref = Hasta el periodo requerido         ejem: '2013-10'
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
RETURNING 
    INTEGER AS Rubro,
    INTEGER AS Concepto,
    INTEGER AS Cuenta_Aplicacion,
    VARCHAR(30) AS Referencia,
    VARCHAR(120) AS Descripcion,
    MONEY(12,2) AS Monto,
    MONEY(12,2) AS Acumulado;

DEFINE v_control_contrato, v_ctrol_operacion, v_id_control_req INTEGER;
DEFINE v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas MONEY(12,2);
DEFINE v_porcentaje_multa SMALLINT;
DEFINE v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2 MONEY(12,2);
DEFINE v_aso_mes_pago, v_fecha_alta, v_fecha_vencimiento DATE;
DEFINE v_Axo, v_Mes, v_Axo_pp, v_Mes_pp INTEGER;
DEFINE v_mensaje_proc VARCHAR(255);
DEFINE v_Periodo_CN, v_Periodo_EXE VARCHAR(7);
DEFINE v_ref CHAR(7);
DEFINE v_importe_Dscto_Tot, v_importe_Dscto MONEY(12,2); -- Adicionado por GMG 31/12/2019 para descuento por pronto pago
DEFINE v_ctrol_recolec INT;  -- Adicionado por Gilberto Moreno 31/12/2019 para obtener el tipo de recoleccion
DEFINE v_cve_recolec CHAR(1);  -- Adicionado por Gilberto Moreno 31/12/2019 para obtener el tipo de recoleccion
DEFINE v_cta_apl INT; -- Adicionado por Gilberto Moreno 31/12/2019 para obtener el tipo de recoleccion
DEFINE v_cta_descrip VARCHAR(50);  -- adicionado por Gilberto Moreno 31/12/2019 para obtener el tipo de recoleccion

-- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
DEFINE v_aplica CHAR(1);
DEFINE v_porc_adic INT;

-- Descuento por pronto pago
DEFINE pp_fecha_inicio, pp_fecha_fin DATE;
DEFINE pp_porc_dscto DECIMAL(5,2);

DEFINE v_porcdescto INT;
DEFINE v_mensaje VARCHAR(255);
DEFINE v_Multa20, v_DsctoMulta MONEY(12,2);
DEFINE v_Multa20_tot, v_DsctoMulta_tot MONEY(12,2);
DEFINE v_actualizacion MONEY(16,2);

BEGIN 
    ON EXCEPTION IN (-958)
        DELETE FROM tmp_totalaseo;
    END EXCEPTION;

    CREATE TEMP TABLE tmp_totalaseo(
        rubro INT,
        concepto INT,
        cuenta INT,
        referencia VARCHAR(30),
        descripcion VARCHAR(120),
        monto MONEY(14,2),
        acumulado MONEY(14,2)) WITH NO log;
END;

BEGIN
    ON EXCEPTION IN (-958)
        DELETE FROM tmp_detalleaseo;
    END EXCEPTION;
    CREATE TEMP TABLE tmp_detalleaseo(
        control_contrato INT,
        aso_mes_pago CHAR(7),
        ctrol_operacion INT,
        tipo_movto CHAR(1)
    ) WITH NO log;
END;

EXECUTE PROCEDURE con16_LPeriodo () INTO v_Periodo_CN, v_Periodo_EXE;
IF TRIM(pref) = '' THEN
    LET v_ref = YEAR(TODAY) || '-' || 12;
ELSE
    LET v_ref = SUBSTR(pref,1,4) || '-' || SUBSTR(pref,6,2);
END IF;

LET v_Axo_pp = SUBSTR(v_ref, 1, 4);
LET v_Mes_pp = SUBSTR(v_ref, 6, 2);

-- Aplicacion normal de requerimientos o no (v_aplica = 'S' -se aplica el req normal -)
SELECT aplica INTO v_aplica FROM ta_aplicareq;

-- Descuento por pronto pago
SELECT fecha_inicio, fecha_fin, porc_dscto INTO pp_fecha_inicio, pp_fecha_fin, pp_porc_dscto FROM ta_16_Dscto_pp WHERE status = 'V';

LET v_porcdescto = 0;
LET v_mensaje = '';
LET v_Multa20 = 0;
LET v_DsctoMulta = 0;
LET v_Multa20_tot = 0;
LET v_DsctoMulta_tot = 0;

LET v_ctrol_recolec = 0;
LET v_cve_recolec = '';
LET v_cta_apl = 0;
LET v_cta_descrip = '';
LET v_control_contrato = 0;

IF EXISTS(SELECT a.* FROM ta_16_contratos a, ta_16_tipo_aseo b WHERE a.num_contrato = p_numero AND b.ctrol_aseo = a.ctrol_aseo AND b.tipo_aseo = p_tipo) THEN -- BEGIN - IF EXISTS
    SELECT a.control_contrato, ctrol_recolec, date(fecha_hora_alta) INTO v_control_contrato, v_ctrol_recolec, v_fecha_alta FROM ta_16_contratos a, ta_16_tipo_aseo b
    WHERE a.num_contrato = p_numero  AND b.ctrol_aseo = a.ctrol_aseo AND b.tipo_aseo = p_tipo;

    SELECT cve_recolec into v_cve_recolec  from ta_16_unidades where ctrol_recolec = v_ctrol_recolec;

    -- VARIABLES A 0
    LET v_tot_multas = 0;
    LET v_porcentaje_multa = 0;
    LET v_tot_dscto_multas = 0;

    LET v_importe_multa = 0;
    LET v_importe_gastos = 0;
    LET v_tot_gastos = 0;
    LET v_acumulado = 0;
    LET v_importe = 0;
    LET v_Importe_recargo = 0;
    LET v_importe_rec1 = 0;
    LET v_importe_rec2 = 0;
    LET v_actualizacion = 0;

    -- APREMIOS
    LET v_id_control_req = 0;
    LET v_importe_multa = 0;
    LET v_importe_gastos = 0;
    LET v_Axo = 0;
    LET v_Mes = 0;

    FOREACH
        SELECT id_control, importe_multa, importe_gastos, YEAR(fecha_practicado), MONTH(fecha_practicado), porcentaje_multa  
            INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
        FROM ta_15_apremios
            WHERE modulo = 16  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
        ORDER BY id_control

        IF v_aplica = 'S' THEN -- Aplicacion normal de requerimientos o no ( v_aplica = 'S' -se aplica el req normal -)
            LET v_tot_multas = v_importe_multa;
            IF v_porcentaje_multa < 100 THEN
                LET v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                LET v_tot_dscto_multas = v_tot_dscto_multas * -1; -- Convertirlo a negativo
            ELSE
                LET v_tot_dscto_multas = 0;
            END IF;
            LET v_tot_gastos = v_tot_gastos + v_importe_gastos;
        ELSE
            LET v_tot_gastos = v_tot_gastos + v_importe_gastos;
        END IF;

        INSERT INTO tmp_detalleaseo VALUES (v_id_control_req, v_ref, 0, 'R');
    END FOREACH;

    -- TERMINA APREMIOS
    IF v_aplica = 'S' THEN
        IF v_tot_multas > 0 THEN
            LET v_acumulado = v_acumulado + v_tot_multas;
            RETURN 0, 515002003, get_odoo_cta(515002003, 18), v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado WITH RESUME;
            INSERT INTO tmp_totalaseo VALUES (0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_tot_multas, v_acumulado);
        END IF;
        IF v_tot_dscto_multas <> 0 THEN
            LET v_acumulado = v_acumulado + v_tot_dscto_multas;
            RETURN 0, 515042003, get_odoo_cta(515042003, 18), v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado WITH RESUME;
            INSERT INTO tmp_totalaseo VALUES (0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_tot_dscto_multas, v_acumulado);
        END IF;
        IF v_tot_gastos > 0 THEN
            LET v_acumulado = v_acumulado + v_tot_gastos;
            RETURN 0, 992104009, get_odoo_cta(992104009, 18), v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado WITH RESUME;
            INSERT INTO tmp_totalaseo VALUES (0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado);
        END IF;
    ELSE
        IF v_tot_gastos > 0 THEN
            LET v_acumulado = v_acumulado + v_tot_gastos;
            RETURN 0, 992104009, get_odoo_cta(992104009, 18), v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado WITH RESUME;
            INSERT INTO tmp_totalaseo VALUES (0,0, 992104009, v_Axo || '/' || v_Mes, 'Gastos ', v_tot_gastos, v_acumulado );
        END IF;
    END IF;


    FOREACH -- INICIAN PERIODOS
        SELECT aso_mes_pago, YEAR(aso_mes_pago), MONTH(aso_mes_pago), importe, ctrol_operacion, calc_actualizacion_aseo(YEAR(aso_mes_pago), MONTH(aso_mes_pago), importe)
        INTO v_aso_mes_pago, v_Axo, v_Mes, v_importe, v_ctrol_operacion, v_actualizacion
        FROM ta_16_pagos
        WHERE Control_Contrato = v_control_contrato  
        AND aso_mes_pago <= v_ref
        AND status_vigencia = 'V' ORDER BY aso_mes_pago, ctrol_operacion

        INSERT INTO tmp_detalleaseo VALUES (v_control_contrato, v_Axo || '-' || v_Mes, v_ctrol_operacion, 'A');

        IF v_importe > 0 THEN -- BEGIN - v_importe > 0
            IF v_ctrol_operacion = 6 THEN
                IF YEAR(v_aso_mes_pago) < YEAR(Current) THEN
                    -- Rezago
                    LET v_cta_apl = 250130000;
                    LET v_cta_descrip = 'Rezago del Adeudo ';
                ELSE
                    -- Actual
                    IF (v_cve_recolec = 'N') OR (v_cve_recolec = 'M') OR (v_cve_recolec = 'T') OR (v_cve_recolec = 'O') THEN
                        IF v_cve_recolec = 'N' THEN -- N, TONELADA
                            LET v_cta_apl = 180000001;
                        END IF;
                        IF v_cve_recolec = 'M' THEN -- M,MT3
                            LET v_cta_apl = 180000002;
                        END IF;
                        IF v_cve_recolec = 'T' THEN -- T,TAMBOS
                            LET v_cta_apl = 180000003;
                        END IF;
                        IF v_cve_recolec = 'O' THEN -- O,BOLSA 60 X 65 CM
                            LET v_cta_apl = 180000004;
                        END IF;
                    ELSE
                        LET v_cta_apl = 180000003;
                    END IF;
                    LET v_cta_descrip = 'Actual de Adeudo ';
                END IF;

                LET v_acumulado = v_acumulado + v_importe;
                RETURN 0, v_cta_apl, get_odoo_cta(v_cta_apl , 18), v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado WITH RESUME;
                INSERT INTO tmp_totalaseo VALUES (0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado);

                --IF v_actualizacion > 0 and ( (pref <> '' and today >= year(today)||'-'|| v_Mes ||'-15') or  v_Axo < year(today) )  THEN
                  -->

                  IF (v_actualizacion > 0 and today >= year(today)||'-'|| v_Mes ||'-06')  or ( (v_actualizacion >0 and pref <> '' and today >= year(today)||'-'|| v_Mes ||'-06') or  v_Axo < year(today) )  THEN
                    LET v_cta_apl = 459171;
                    LET v_cta_descrip = 'Actualizacion Adeudo';
                    LET v_acumulado = v_acumulado + v_actualizacion;

                    RETURN 0, v_cta_apl, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_actualizacion, v_acumulado WITH RESUME;
                    INSERT INTO tmp_totalaseo VALUES (0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_actualizacion, v_acumulado);

                    
                      /*
                    --aplicar descuento 50
                    if v_control_contrato in (7499) then
                        LET v_acumulado = v_acumulado - (v_importe * (0.3 * 0.5));
                        RETURN 0, 515042003, get_odoo_cta(515042003, 18), v_Axo || '/' || v_Mes, 'Dscto. a Multas ', (v_importe * (0.3 * -0.5)), v_acumulado WITH RESUME;
                        INSERT INTO tmp_totalaseo VALUES (0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', (v_importe * (0.3 * -0.5)), v_acumulado );
                    end if;
                   
                    --aplicar descuento 30
                    if v_control_contrato in (8408,8409) then
                        LET v_acumulado = v_acumulado - (v_importe * (0.3 * 0.3));
                        RETURN 0, 515042003, get_odoo_cta(515042003, 18), v_Axo || '/' || v_Mes, 'Dscto. a Multas ', (v_importe * (0.3 * -0.3)), v_acumulado WITH RESUME;
                        INSERT INTO tmp_totalaseo VALUES (0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', (v_importe * (0.3 * -0.3)), v_acumulado );
                    end if;
                    */
                END IF;


                SELECT SUM(porc_recargo) INTO v_Importe_recargo FROM ta_16_recargos WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_CN);

                -- *** se valida la fecha de vencimiento, los contratos nuevos tiene 5 dias naturales de gracia para no cobrar recargos
                   -- *** parametros del procedimieno: fecha de alta y tipo de dia (N)-Naturales � (H) habiles *** PETICION DE MARIBEL POR CORREO
                execute function spd_16_calc_vencimiento_nuevos ( v_fecha_alta, 'N' ) into v_fecha_vencimiento;
                if  v_fecha_vencimiento > today then
                    let v_Importe_recargo =0;
                end if;



              IF (v_Importe_recargo <> 0 and today >= year(today)||'-'|| v_Mes ||'-05')  or ( (v_Importe_recargo <>0 and pref <> '' and today >= year(today)||'-'|| v_Mes ||'-05') or  v_Axo < year(today) )  THEN
                    LET v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                    LET v_acumulado = v_acumulado + v_importe_rec1;
                    RETURN 0, 390200000, get_odoo_cta(390200000, 18), v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado WITH RESUME;
                    INSERT INTO tmp_totalaseo VALUES (0,0, 390200000, v_Axo || '/' || v_Mes, 'Recargo del Adeudo ', v_importe_rec1, v_acumulado);
                    EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, NULL, NULL, NULL, NULL, 16) INTO v_importe_rec2, v_mensaje_proc;

                /*IF (p_tipo = 'C') AND (p_numero = 1562) THEN
                    LET v_acumulado = v_acumulado + (v_importe*0.30);
                    RETURN 0, 390200000, get_odoo_cta(390200000, 18), v_Axo || '/' || v_Mes, 'Multa ', (v_importe*0.30), v_acumulado WITH RESUME;
                    INSERT INTO tmp_totalaseo VALUES (0,0, 390200000, v_Axo || '/' || v_Mes, 'Multa ', (v_importe*0.30), v_acumulado);
                END IF;*/
                END IF;
            -->
            --select * from db_ingresos:ta_12_ctas_odoo where axo = 2023

                IF v_importe_rec2 > 0 THEN
                   LET v_importe_rec2 = v_importe_rec2 * -1;
                   LET v_acumulado = v_acumulado + v_importe_rec2;
                   RETURN 0, 390240000, get_odoo_cta(390240000, 18), v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado WITH RESUME;
                   INSERT INTO tmp_totalaseo VALUES (0,0, 390240000, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Adeudo ', v_importe_rec2, v_acumulado);
         --       END IF;
              END IF; -- END - v_importe > 0

                IF v_Importe_recargo <> 0 THEN
                   LET v_acumulado = v_acumulado + (v_importe * 0.3);
                   RETURN 0, 515002003, get_odoo_cta(515002003, 18), v_Axo || '/' || v_Mes, 'Multas P', (v_importe * 0.3), v_acumulado WITH RESUME;
                   INSERT INTO tmp_totalaseo VALUES (0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas P', (v_importe * 0.3), v_acumulado );

                    -->
                    
                    --aplicar descuento 75
                    if v_control_contrato in (4640) then
                        LET v_acumulado = v_acumulado - (v_importe * (0.3 * 0.35));
                        RETURN 0, 515042003, get_odoo_cta(515042003, 18), v_Axo || '/' || v_Mes, 'Dscto. a Multas ', (v_importe * (0.3 * -0.35)), v_acumulado WITH RESUME;
                        INSERT INTO tmp_totalaseo VALUES (0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', (v_importe * (0.3 * -0.35)), v_acumulado );
                    end if;
                 end if;

                -- INICIO -- Descuento por pronto pago
                IF pp_porc_dscto > 0 THEN -- AND p_rep <> 'V'
                    IF TODAY >= pp_fecha_inicio AND TODAY <= pp_fecha_fin THEN
                        IF v_Axo = YEAR(TODAY) AND (v_Mes_pp = 12) THEN -- solo a�o actual
                            LET v_importe_Dscto = (v_importe * pp_porc_dscto);
                            LET v_importe_Dscto = v_importe_Dscto * -1;
                            LET v_acumulado = v_acumulado + v_importe_Dscto;
                            RETURN 0, 180000009, get_odoo_cta(180000009, 18), v_Axo || '/' || v_Mes, '10% Dscto p/pp ', v_importe_Dscto, v_acumulado WITH RESUME;
                            INSERT INTO tmp_totalaseo VALUES (0,0, 180000009, v_Axo || '/' || v_Mes, '10% Dscto p/pp ', v_importe_Dscto, v_acumulado);
                        END IF;
                    END IF;
                END IF;
                -- FIN -- Descuento por pronto pago

            ELSE
                IF YEAR(v_aso_mes_pago) < YEAR(Current) THEN
                    -- Rezago
                    LET v_cta_apl = 250230000;
                    LET v_cta_descrip = 'Rezago del Excedente ';
                ELSE
                    -- Actual
                    IF (v_cve_recolec = 'N') OR (v_cve_recolec = 'M') OR (v_cve_recolec = 'T') OR (v_cve_recolec = 'O') THEN
                        IF v_cve_recolec = 'N' THEN -- N, TONELADA
                            LET v_cta_apl = 180000001;
                        END IF;
                        IF v_cve_recolec = 'M' THEN -- M,MT3
                            LET v_cta_apl = 180000002;
                        END IF;
                        IF v_cve_recolec = 'T' THEN -- T,TAMBOS
                            LET v_cta_apl = 180000007;
                        END IF;
                        IF v_cve_recolec = 'O' THEN -- O,BOLSA 60 X 65 CM
                            LET v_cta_apl = 180000008;
                        END IF;
                    ELSE
                        LET v_cta_apl = 180000007;
                    END IF;
                    LET v_cta_descrip = 'Actual del Excedente ';
                END IF;

                LET v_acumulado = v_acumulado + v_importe;
                RETURN 0, v_cta_apl, get_odoo_cta(v_cta_apl, 18), v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado WITH RESUME;
                INSERT INTO tmp_totalaseo VALUES (0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_importe, v_acumulado);

                SELECT SUM(porc_recargo) INTO v_Importe_recargo FROM ta_16_recargos WHERE aso_mes_recargo BETWEEN (v_aso_mes_pago) AND (v_Periodo_EXE); --  (v_Periodo_CN);


                IF v_actualizacion > 0  THEN
                   LET v_cta_apl = 459171;
                   LET v_cta_descrip = 'Actualizacion Excedente';
                   LET v_acumulado = v_acumulado + v_actualizacion;

                   RETURN 0, v_cta_apl, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_actualizacion, v_acumulado WITH RESUME;
                   INSERT INTO tmp_totalaseo VALUES (0,0, v_cta_apl, v_Axo || '/' || v_Mes, v_cta_descrip, v_actualizacion, v_acumulado);
                end if;
            
                IF v_Importe_recargo <> 0 THEN        
                   LET v_acumulado = v_acumulado + (v_importe * 0.3);
                   RETURN 0, 515002003, get_odoo_cta(515002003, 18), v_Axo || '/' || v_Mes, 'Multas Excedente', (v_importe * 0.3), v_acumulado WITH RESUME;
                   INSERT INTO tmp_totalaseo VALUES (0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas Excedente', (v_importe * 0.3), v_acumulado );
                end if;

                -- descuento multa de excedente
                if v_control_contrato in (4640) then
                   LET v_acumulado = v_acumulado - (v_importe * (0.3 * 0.35));
                   RETURN 0, 515042003, get_odoo_cta(515042003, 18), v_Axo || '/' || v_Mes, 'Dscto. a Multas Excedente', (v_importe * (0.3 * -0.35)), v_acumulado WITH RESUME;
                   INSERT INTO tmp_totalaseo VALUES (0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas Excedente', (v_importe * (0.3 * -0.35)), v_acumulado );
                end if;
  
                IF v_Importe_recargo <> 0 THEN  -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA en periodos vencidos
                   EXECUTE PROCEDURE sp_multa_DestoMulta(16, v_control_contrato, v_axo, v_Mes, v_importe) INTO v_porcdescto, v_Multa20, v_DsctoMulta, v_mensaje;
                   IF v_Multa20 <> 0 THEN
                      LET v_Multa20_tot = v_Multa20_tot + v_Multa20;
                   END IF;
                   IF v_DsctoMulta <> 0 THEN
                      LET v_DsctoMulta_tot = v_DsctoMulta_tot + v_DsctoMulta;
                   END IF;
                END IF;

            --IF v_Importe_recargo <> 0 and ( (pref <> '' and today >= '2024-02-16') or v_Axo < year(today) )  THEN
            -->
                IF (v_Importe_recargo <> 0 and today >= year(today)||'-'|| v_Mes ||'-05')  or ( (v_Importe_recargo <>0 and pref <> '' and today >= year(today)||'-'|| v_Mes ||'-05') or  v_Axo < year(today) )  THEN
                    LET v_importe_rec1 = (v_importe * v_Importe_recargo) / 100;
                    LET v_acumulado = v_acumulado + v_importe_rec1;
                    RETURN 0, 390200000, get_odoo_cta(390200000, 18), v_Axo || '/' || v_Mes, 'Recargo del Excedente ', v_importe_rec1, v_acumulado WITH RESUME;
                    INSERT INTO tmp_totalaseo VALUES (0,0, 390200000, v_Axo || '/' || v_Mes, 'Recargo del Excedente ', v_importe_rec1, v_acumulado);
                    EXECUTE PROCEDURE sp_desctomerc (v_control_contrato, v_axo, v_Mes, 1, v_importe_rec1, NULL, NULL, NULL, NULL, 16) INTO v_importe_rec2, v_mensaje_proc;

                /*IF (p_tipo = 'C') AND (p_numero = 1562) THEN
                    LET v_acumulado = v_acumulado + (v_importe*0.30);
                    RETURN 0, 390200000, get_odoo_cta(390200000, 18), v_Axo || '/' || v_Mes, 'Multa ', (v_importe*0.30), v_acumulado WITH RESUME;
                    INSERT INTO tmp_totalaseo VALUES (0,0, 390200000, v_Axo || '/' || v_Mes, 'Multa ', (v_importe*0.30), v_acumulado);
                END IF;*/
                END IF;
            -->
            --select * from db_ingresos:ta_12_ctas_odoo where axo = 2023

                IF v_importe_rec2 > 0 THEN
                   LET v_importe_rec2 = v_importe_rec2 * -1;
                   LET v_acumulado = v_acumulado + v_importe_rec2;
                   RETURN 0, 390240000, get_odoo_cta(390240000 , 18), v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Excedente ', v_importe_rec2, v_acumulado WITH RESUME;
                   INSERT INTO tmp_totalaseo VALUES (0,0, 390240000, v_Axo || '/' || v_Mes, 'Dscto. al Rcgo del Excedente ', v_importe_rec2, v_acumulado);
                END IF;
              END IF; -- END - v_importe > 0
            END IF;

        LET v_importe = 0;
        LET v_Importe_recargo = 0;
        LET v_importe_rec1 = 0;
        LET v_importe_rec2 = 0;
    END FOREACH; -- TERMINAN PERIODOS

    -- APLICACION DEL 20% DE MULTA AL ADEUDO Y DESCUENTOS DE LA MULTA
 /*   IF v_aplica <> 'S' THEN
        IF v_Multa20_tot <> 0 THEN
            LET v_acumulado = v_acumulado + v_Multa20_tot;
            RETURN 0, 515002003, get_odoo_cta(515002003, 18), v_Axo || '/' || v_Mes, 'Multas ', v_Multa20_tot, v_acumulado WITH RESUME;
            INSERT INTO tmp_totalaseo VALUES (0,0, 515002003, v_Axo || '/' || v_Mes, 'Multas ', v_Multa20_tot, v_acumulado );
        END IF;
        IF v_DsctoMulta_tot <> 0 THEN
            LET v_DsctoMulta_tot = v_DsctoMulta_tot * -1;
            LET v_acumulado = v_acumulado + v_DsctoMulta_tot;
            RETURN 0, 515042003, get_odoo_cta(515042003, 18), v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_DsctoMulta_tot, v_acumulado WITH RESUME;
            INSERT INTO tmp_totalaseo VALUES (0,0, 515042003, v_Axo || '/' || v_Mes, 'Dscto. a Multas ', v_DsctoMulta_tot, v_acumulado );
        END IF;
    END IF; */
END IF; -- END - IF EXISTS
END function;


CREATE PROCEDURE "informix".spd10_actualiza(control_pas integer)

define LicControl       integer; 
define LControl_pag       integer; 
define Lnumerolicen       INTEGER; 
define LAXO_APAGAR  INTEGER;
define LIMPORTE_APAGAR  MONEY(15,2);
define LFECHA_PAGO      DATE;
define LOFNA_PAGO       SMALLINT;
define LCAJA_PAGO       ChaR(1);
define LOPER_PAGO       INTEGER;
define LIMPORTE_PAGO    MONEY(15, 2);
define LPorc_apagar     smallint;    
define LVIGENCIA       smallint;
define LUSUARIO         INTEGER;
define LFECHA_CAMBIO    DATEtime  year to second;

foreach
select * into LControl_pag,  Lnumerolicen, LAXO_APAGAR, LIMPORTE_APAGAR, LFECHA_PAGO,
                   LOFNA_PAGO, LCAJA_PAGO, LOPER_PAGO,  LIMPORTE_PAGO,  LPorc_apagar,
                   LVIGENCIA, LUSUARIO,  LFECHA_CAMBIO
from ta_10_pagos400 where control_pag > control_pas

   select control into liccontrol
   from ta_10_licencias where numero_licencia=lnumerolicen;

   insert into ta_10_pagoslicen values (0,LicControl, LAXO_APAGAR, LIMPORTE_APAGAR, LFECHA_PAGO,
                   LOFNA_PAGO, LCAJA_PAGO, LOPER_PAGO,  LIMPORTE_PAGO,  LPorc_apagar,
                   LVIGENCIA, LUSUARIO,  LFECHA_CAMBIO);
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd15_notifi(reca char(1) , gastos  money(12,2), usuario integer )

      define  contador    integer;
      define  ct_multa    money(12,2);
      define  ct_control  integer;
      define  ct_zona          smallint;


      if reca = 'J' then 
         let ct_zona = 1;
      end if;
     if reca = 'R' then 
         let ct_zona = 2;
        end if;
     if reca = 'L' then 
         let ct_zona = 3;
       end if ;
     if reca = 'H' then 
         let ct_zona = 4;
        end if;  



        select max(folio)
            into  contador
        from ta_15_apremios where zona = ct_zona and modulo = 08 and diligencia = 'N' ;

       foreach
          select   id_control , importe_inicial 
              into  ct_control , ct_multa
              from ta_08_multas where sector = reca and fecha_baja is null and fecha_pago is null and
                                            diligencia is null
             
            let contador = contador + 1;
            insert into ta_15_apremios (id_control, zona,modulo, control_otr , Folio ,diligencia, importe_multa, 
                                                       importe_gastos, fecha_emision, porcentaje_multa, fecha_actualiz, usuario)
                                          values (0, ct_zona , 08, ct_control, contador, 'N', ct_multa , gastos , today , 100,  today, usuario); 
           update ta_08_multas set diligencia = 'N' where id_control = ct_control;
 

     end foreach;
   end procedure;

CREATE PROCEDURE "informix".spd_11_borrarade (
	parm_control			integer)
delete from ta_11_adeudo_local
 where id_local=parm_control; 
end procedure;

CREATE PROCEDURE "informix".spd_11_cambio_merc(
parm_rec smallint)
define    v_oficina_f smallint;
define    v_mercado_f smallint;
define    v_categoria_f smallint;
define    v_descripcion_f varchar(30);
define    v_cta_ingreso_f integer;
define    v_cta_energia_f integer;
define    v_zona_f smallint;
define    v_rec_ant_p smallint;
define    v_merc_ant_p smallint;
define    v_rec_nv_p smallint;
define    v_merc_nv_p smallint;
begin work;
foreach
    select a.rec_ant,a.merc_ant,a.rec_nv,a.merc_nv,b.oficina,b.num_mercado_nvo,b.categoria,b.descripcion,b.cuenta_ingreso,b.cuenta_energia,b.id_zona into
           v_rec_ant_p,v_merc_ant_p,v_rec_nv_p,v_merc_nv_p,v_oficina_f,v_mercado_f,v_categoria_f,v_descripcion_f,v_cta_ingreso_f,v_cta_energia_f, v_zona_f
          from ta_11_cat_mercpaso a,ta_11_mercados b
          where a.rec_ant=parm_rec
          and a.rec_ant=b.oficina
          and a.merc_ant=b.num_mercado_nvo
          order by a.rec_ant desc,a.merc_ant desc

          insert into ta_11_mercados values( v_rec_nv_p,v_merc_nv_p,v_categoria_f,v_descripcion_f,v_cta_ingreso_f,v_cta_energia_f, v_zona_f);

          update ta_11_locales set oficina=v_rec_nv_p,num_mercado=v_merc_nv_p where oficina=v_oficina_f and num_mercado=v_mercado_f;

          delete from ta_11_mercados where oficina=v_oficina_f and num_mercado_nvo=v_mercado_f; 

end foreach;
commit work;
end procedure;

CREATE PROCEDURE "informix".spd_11_enerdetalle(
parm_id integer, -- id local
parm_mer smallint) -- num. mercado

define v_idenergia,v_en,ven integer;
define v_mesdsd,v_axodsd smallint;
define v_meshst,v_axohst smallint;
define v_adeudo money(15,2);
define v_recargos money(15,2);
define v_multa money(15,2);
define v_gastos money(15,2);
define v_descuento money(15,2);
define v_folio integer;
define v_per smallint;
define v_aidenergia integer;
define v_aaxo smallint;
define v_aperiodo smallint;
define v_aimporte money(15,2);
define v_mes smallint;
define v_axo smallint;
define v_dmes smallint;
define v_fecha_desc date;
define v_fecha_rec date;
define v_porc decimal(10,2);
define v_vigencia char(1);
define v_id_localp integer;
define v_axop smallint;
define v_periodop smallint;
define v_contador,v_locales smallint;
define v_bloqueo smallint;
define v_recacum money(15,2);
define v_recacum1 money(15,2);
define v_adeacum money(15,2);
define v_impcalc money(15,2);
define v_axomin,v_axocalc smallint;
define v_mesmin,v_mescalc,v_primermes smallint;
define v_desc integer;
define v_total money(15,2);
define v_concepto varchar(100);
define v_axoc smallint;
define v_importec money(15,2);
define v_ident char(2);
define v_meses smallint;
define cont smallint;
define v_impcalc1 money(15,2);

let cont=0;
let v_meses=0;
let v_ident='';
let v_concepto='ADEUDO ENERGIA ELEC. ';
let v_axoc=0;
let v_idenergia=0;
let v_mesdsd=0;
let v_axodsd=0;
let v_meshst=0;
let v_axohst=0;
let v_adeudo=0;
let v_recargos=0;
let v_multa=0;
let v_gastos=0;
let v_recargos=0;
let v_contador=0;
let v_locales=0;
let v_folio=0;
let v_descuento=0;
let v_adeacum=0;
let v_recacum1=0;
let v_primermes=0;
let v_impcalc=0;
let v_total=0;
let v_impcalc1=0;

-- obtiene los datos generales
select id_energia into v_idenergia from ta_11_energia where id_local=parm_id;


let v_per=0;
let v_porc=0;
let v_recacum=0;
let v_impcalc=0; 
    
-- todos los adeudos pendientes hasta mes actual
foreach
select a.id_energia,a.axo,a.periodo,a.importe,b.mes,b.fecha_descuento,b.fecha_recargos 
into   v_aidenergia,v_aaxo,v_aperiodo,v_aimporte,v_dmes,v_fecha_desc,v_fecha_rec
from   ta_11_adeudo_energ a,ta_11_fecha_desc b 
where id_energia=v_idenergia
and ((a.axo=year(today) and a.periodo<=month(today)) or (a.axo<year(today))) 
and b.mes=month(today)
order by axo,periodo
let v_porc=0;
let v_recacum=0;
let v_recacum1=0;
let v_impcalc=0;
let v_impcalc1=0;   

--if parm_mer=34 then
   if v_aaxo<=2002 then
      let v_impcalc1=v_aimporte/2;
      let v_meses=2;
      let v_axohst=v_aaxo;
      if v_aperiodo=1 then let v_meshst=1;
      else if v_aperiodo=2 then let v_meshst=3;
      else if v_aperiodo=3 then let v_meshst=5;
      else if v_aperiodo=4 then let v_meshst=7;
      else if v_aperiodo=5 then let v_meshst=9;
      else let v_meshst=11;
      end if;
      end if;
      end if;
      end if;
      end if;
   else
      let v_impcalc1=v_aimporte;
      let v_meses=1;
      let v_meshst=v_aperiodo;
      let v_axohst=v_aaxo; 
   end if;
--else
--   let v_impcalc=v_aimporte;
--   let v_meses=1;
--   let v_meshst=v_aperiodo;
--   let v_axohst=v_aaxo;
--end if;

-- obtiene el porcentaje de recargos
for cont=1 to v_meses 
if today>=v_fecha_rec then
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_axohst  or (mes>=v_meshst  and axo =v_axohst)) and
         (axo<year(today)  or (mes<=month(today) and axo =year(today))) );
else
   select sum(porcentaje_mes) into v_porc from ta_12_recargos
   where ( (axo>v_axohst  or (mes>=v_meshst  and axo =v_axohst)) and
         (axo<year(today)  or (mes<=(month(today)-1) and axo =year(today))) );
end if;

if  v_porc is null then
    let v_porc=0;
end if;

if v_porc > 100 then
   let v_recacum1=(v_impcalc1*100)/100;
else
   let v_recacum1=(v_impcalc1*v_porc)/100;
end if;
if v_axohst<=2002 then
   let v_meshst=v_meshst+1;
end if; 
let v_recacum=v_recacum+v_recacum1;
let v_impcalc=v_impcalc+v_impcalc1;
end for;

if ((v_axoc=0) or (v_axoc=v_aaxo)) then
   let v_concepto=v_concepto||v_aperiodo||' ';
   let v_axoc=v_aaxo;
   let v_adeudo=v_adeudo+v_impcalc;
   let v_recargos=v_recargos+v_recacum;
else
   insert into tmp_edocuenta values(v_idenergia,'E',v_axoc,v_concepto,v_adeudo);
   insert into tmp_edocuenta values(v_idenergia,'',v_axoc,'RECARGOS ENERGIA ELEC.',v_recargos);
   let v_concepto='ADEUDO ENERGIA ELEC.'||v_aperiodo||' ';
   let v_axoc=v_aaxo;
   let v_adeudo=v_impcalc;
   let v_recargos=v_recacum;
end if;
end foreach;

if v_adeudo>0 then
   insert into tmp_edocuenta values(v_idenergia,'E',v_axoc,v_concepto,v_adeudo);
end if;
if v_recargos>0 then
   insert into tmp_edocuenta values(v_idenergia,'',v_axoc,'RECARGOS ENERGIA ELEC.',v_recargos);
end if;
end procedure;

CREATE PROCEDURE "informix".spd_11_pago_kiosco (
	parm_num_kiosco		integer,
	parm_fechap_kiosco	date,
	parm_hora_kiosco		char(10),
	parm_trans_kiosco		integer,
	parm_modulo		smallint,
	parm_id_referencia		integer,
	parm_cantidad		money(15,2),
	parm_clave_pago		char(1),
	parm_id_usuario		integer)
define v_folio varchar(18);
define v_cantidad_1 money(15,2);
define v_cantidad_2 money(15,2);
define v_caja char(1);
define v_recp smallint;
define v_mes smallint;
define v_axo smallint;
let v_mes=month(today);
let v_axo=year(today);
let v_recp=0;
let v_caja='';
let v_cantidad_1=0;
let v_cantidad_2=0;
if parm_modulo=11 then
   if parm_clave_pago='K' then
      let v_folio=('KIOSCO-'||parm_num_kiosco);

--           inserta el pago a mercados
      insert into ta_11_pagos_local values (0,parm_id_referencia,v_axo,v_mes,parm_fechap_kiosco,v_recp,v_caja,parm_trans_kiosco,parm_cantidad,v_folio,current,parm_id_usuario);

--           borra el adeudo en mercados
      delete from ta_11_adeudo_local where id_local=parm_id_referencia and axo=v_axo and periodo=v_mes;

--           inserta el pago en la tabla de kiosco
      insert into ta_pagos_kiosco values(0,parm_num_kiosco,parm_fechap_kiosco,parm_hora_kiosco,parm_trans_kiosco,parm_modulo,parm_id_referencia,parm_cantidad,v_cantidad_1,v_cantidad_2,null,v_recp,v_caja,0,parm_clave_pago);

   end if;   
end if;
end procedure;

CREATE PROCEDURE "informix".spd_13_actualrcm()
define    v_control integer;
define    v_control_rcm integer;
define    v_fecing  date;
define    v_recing  smallint;
define    v_caja     CHAR(1);
define    v_opcaja integer;
define    v_cementerio char(1);
define    v_clase    smallint;
define    v_clase_alfa varchar(10,0);
define    v_seccion smallint;
define    v_secc_alfa varchar(10,0);
define    v_linea      smallint;
define    v_linea_alfa varchar(20,0);
define    v_fosa      smallint;
define    v_fosa_alfa varchar(20,0);
define    v_axo_desde integer;
define    v_axo_hasta  integer;
define    v_importe_anual money(15,2);
define    v_axo_pagado integer;
define    v_metros decimal (5,3);
define    v_nombre varchar(60,0);
define    v_docmicilio varchar(60,0);
define    v_exter  char(6);
define    v_inter char(6);
define    v_colonia varchar(30,0);

foreach
   SELECT *
   into  v_control, v_fecing,v_recing,v_caja,v_opcaja,v_cementerio,v_clase,v_clase_alfa,v_seccion,v_secc_alfa,            v_linea,v_linea_alfa,v_fosa,v_fosa_alfa,v_axo_desde,v_axo_hasta,v_importe_anual,v_axo_pagado,
           v_metros,v_nombre,v_docmicilio,v_exter,v_inter,v_colonia
   from        ta_13_cem400
   if not exists( select * from ta_13_datosrcm
                       where cementerio=v_cementerio and clase=v_clase and clase_alfa=v_clase_alfa 
                                  and seccion=v_seccion and seccion_alfa=v_secc_alfa and linea=v_linea and                                              linea_alfa=v_linea_alfa and fosa=v_fosa and fosa_alfa=v_fosa_alfa) then          
    insert into ta_13_datosrcm  values(0,v_cementerio,v_clase,v_clase_alfa,v_seccion,v_secc_alfa,
             v_linea,v_linea_alfa,v_fosa,v_fosa_alfa,v_axo_hasta,v_metros,v_nombre,v_docmicilio,v_exter,v_inter,
             v_colonia,' ',2,current,'F');
       end if; 
end foreach;

foreach
   SELECT *
   into   v_control,v_fecing,v_recing,v_caja,v_opcaja,v_cementerio,v_clase,v_clase_alfa,v_seccion,v_secc_alfa,             v_linea,v_linea_alfa,v_fosa,v_fosa_alfa,v_axo_desde,v_axo_hasta,v_importe_anual,v_axo_pagado, 
            v_metros,v_nombre,v_docmicilio,v_exter,v_inter,v_colonia
   from        ta_13_cem400
   if exists( select * from ta_13_datosrcm
                       where cementerio=v_cementerio and clase=v_clase and clase_alfa=v_clase_alfa 
                                  and seccion=v_seccion and seccion_alfa=v_secc_alfa and linea=v_linea and                                              linea_alfa=v_linea_alfa and fosa=v_fosa and fosa_alfa=v_fosa_alfa and nombre=v_nombre 
                            and axo_pagado<v_axo_hasta) then        
    update ta_13_datosrcm  set axo_pagado=v_axo_hasta,usuario=2,fecha_mov=current
                       where cementerio=v_cementerio and clase=v_clase and clase_alfa=v_clase_alfa 
                                  and seccion=v_seccion and seccion_alfa=v_secc_alfa and linea=v_linea and                                              linea_alfa=v_linea_alfa and fosa=v_fosa and fosa_alfa=v_fosa_alfa;
       end if; 
end foreach;
foreach
   SELECT a.*,b.control_rcm
   into   v_control,v_fecing,v_recing,v_caja,v_opcaja,v_cementerio,v_clase,v_clase_alfa,v_seccion,v_secc_alfa,             v_linea,v_linea_alfa,v_fosa,v_fosa_alfa,v_axo_desde,v_axo_hasta,v_importe_anual,v_axo_pagado, 
            v_metros,v_nombre,v_docmicilio,v_exter,v_inter,v_colonia,v_control_rcm
   from        ta_13_cem400 a, ta_13_datosrcm b
  where a.cementerio=b.cementerio and a.clase=b.clase and a.clase_alfa=b.clase_alfa 
                                  and a.seccion=b.seccion and a.seccion_alfa=b.seccion_alfa and a.linea=b.linea and                                              a.linea_alfa=b.linea_alfa and a.fosa=b.fosa and a.fosa_alfa=b.fosa_alfa                 
   if not exists( select * from ta_13_pagosrcm
                       where fecing=v_fecing and recing=v_recing and cajing=v_caja  and opcaja=v_opcaja) then        
    insert into ta_13_pagosrcm  values(v_fecing,v_recing,v_caja,v_opcaja,0,v_control_rcm,
             v_cementerio,v_clase,v_clase_alfa,v_seccion,v_secc_alfa,v_linea,v_linea_alfa,v_fosa,v_fosa_alfa,
              v_axo_desde, v_axo_hasta,v_importe_anual,0,'A',2,current);
       end if; 
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_16_creadeta()

    		on exception in (-310)
       		delete From Det_Apremios;
    		end exception;
	    create temp table Det_Apremios (Control_Contrato 	integer,
                                            Detalle   		varchar(120), 
                                            Importe_Multas 	money(12,2),
                                            Importe_Gastos 	money(12,2));
end procedure;

CREATE PROCEDURE "informix".spd_16_creadetp()

--Begin
    on exception in (-310)
       delete From Det_Pagos;
    end exception;
create temp table Det_Pagos (Control_Contrato 	integer,
                                                Ejercicio 		integer,
                                                Detalle   		varchar(130), 
                                                Importe_Adeudos 	money(12,2),
                                                Importe_Recargos 	money(12,2),
                                                Importe_Multas 	money(12,2),
                                                Importe_Gastos 	money(12,2));
--End;

end procedure;

CREATE PROCEDURE "informix".spd_16_detapremios ( p_Control Integer)

  define v_Lineas_Folios 	Smallint;
  define v_Detalle_Apremios 					varchar(100);
  define v_Recargos, v_Multas, v_Gastos 			Money(12,2);

  define v_id_control, v_modulo, v_control_otr, v_folio  		Integer;
  define v_importe_multa, v_importe_gastos			Money(12,2);
-- 
  Let v_Multas = 0;
  Let v_Gastos = 0;
  Let v_Detalle_Apremios = 'FOLIOS REQUERIDOS : ';
  Let v_Lineas_Folios = 0;
  foreach
       Select id_control, modulo, control_otr, folio, importe_multa, importe_gastos 
           Into v_id_control, v_modulo, v_control_otr, v_folio, v_importe_multa, v_importe_gastos 
       From ta_15_apremios 
       Where modulo = 16 and control_otr = p_Control
       and vigencia = '1' and clave_practicado = 'P' 
       Order By id_control

           Let v_Multas = v_importe_multa;
           Let v_Gastos = v_Gastos + v_importe_gastos;
           Let v_Detalle_Apremios = v_Detalle_Apremios||v_folio||',';
           Let v_Lineas_Folios = v_Lineas_Folios + 1;
     
  end foreach;

if v_Lineas_Folios > 0 then
       Insert into Det_Pagos values
                       (p_Control, v_Lineas_Folios, v_Detalle_Apremios, 0, 0, v_Multas, v_Gastos);
end if;

end procedure;

CREATE PROCEDURE "informix".spd_16_detpagos ( p_Control Integer, p_Ejercicio Integer, p_Per1 Char(7), p_Per2 Char(7), p_Per3 Char(7), p_Status Char(1) )

  define v_Mes                  					varchar(4);
  define v_Lineas_CN, v_Lineas_EX, v_Lineas_CO 		Smallint;
  define v_Detalle_T, v_Detalle_CN,v_Detalle_EX, v_Detalle_CO 	varchar(120);
  define v_Adeudos, v_Recargos 				Money(12,2);
  define v_Importe_recargo					Decimal(5,2);
  define H_Aso, H_Mes, H_Dia				Smallint;
  define Aso_L, Mes_L, Dia_L					Smallint;

  define v_aso_mes_pago             Date;
  define v_importe                         Money(12,2);
  define v_exedencias	     Smallint;
  define v_Aso_Hoy, v_Mes_Hoy Smallint;
  define v_Aso_Ini, v_Mes_Ini Smallint;
--   definir los periodos del adeudo

  Let v_Aso_Hoy = Year(Current);
  Let v_Mes_Hoy = Month(Current);
  Let v_Adeudos = 0;
  Let v_Recargos = 0;
  Let v_Detalle_T = ' ';

--  CUOTA NORMAL

  Let v_Lineas_CN = 0;
  Let v_Detalle_CN = ' CN--';
  foreach
    Select h.aso_mes_pago, h.importe, h.exedencias,Month(h.aso_mes_pago) || ', '
        Into v_aso_mes_pago, v_importe, v_exedencias, v_Mes 
     From ta_16_pagos H, ta_16_operacion I
     Where H.Control_Contrato = p_Control and H.Ctrol_Operacion = 6 
          and H.aso_mes_pago between (p_Per1) and (p_Per2)
          and H.Status_Vigencia = p_Status
          and I.ctrol_operacion = H.ctrol_operacion
      Order by 1,2,3
                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between (v_aso_mes_pago) and v_Aso_Hoy||'-'||v_Mes_Hoy;

  Let v_Detalle_CN = v_Detalle_CN||v_Mes;
  Let v_Adeudos = v_Adeudos + v_importe;
  if v_Importe_recargo <> 0 then
     Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
  end if;
  Let v_Lineas_CN = v_Lineas_CN + 1;
  end foreach;

-- EXEDENCIAS
  Let v_Lineas_EX = 0;
  Let v_Detalle_EX = ' EX--';
  foreach
    Select h.aso_mes_pago, h.importe, h.exedencias,Month(h.aso_mes_pago) || ', '
        Into v_aso_mes_pago, v_importe, v_exedencias, v_Mes 
     From ta_16_pagos H, ta_16_operacion I
     Where H.Control_Contrato = p_Control and H.Ctrol_Operacion = 7 
          and H.aso_mes_pago between (p_Per1) and (p_Per3)
          and H.Status_Vigencia = p_Status
          and I.ctrol_operacion = H.ctrol_operacion
      Order by 1,2,3

     Let v_Aso_Ini = Year(v_aso_mes_pago);
     Let v_Mes_Ini = Month(v_aso_mes_pago);
  if v_Mes_Ini = 11 then
     Let v_Aso_Ini = v_Aso_Ini + 1;
     Let v_Mes_Ini = 1;
  end if;
  if v_Mes_Ini = 12 then
     Let v_Aso_Ini = v_Aso_Ini + 1;
     Let v_Mes_Ini = 2;
  end if;
  if v_Mes_Ini < 11 then
     Let v_Mes_Ini = v_Mes_Ini + 2;
  end if;

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between v_Aso_Ini||'-'||v_Mes_Ini and v_Aso_Hoy||'-'||v_Mes_Hoy;

  Let v_Detalle_EX = v_Detalle_EX||v_Mes;
  Let v_Adeudos = v_Adeudos + v_importe;
  if v_Importe_recargo <> 0 then
     Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
  end if;
  Let v_Lineas_EX = v_Lineas_EX + 1;
  end foreach;

-- CONTENEDORES
  Let v_Lineas_CO = 0;
  Let v_Detalle_CO = ' CO--';
  foreach
    Select h.aso_mes_pago, h.importe, h.exedencias,Month(h.aso_mes_pago) || ', '
        Into v_aso_mes_pago, v_importe, v_exedencias, v_Mes 
     From ta_16_pagos H, ta_16_operacion I
     Where H.Control_Contrato = p_Control and H.Ctrol_Operacion = 8 
          and H.aso_mes_pago between (p_Per1) and (p_Per3)
          and H.Status_Vigencia = p_Status
          and I.ctrol_operacion = H.ctrol_operacion
      Order by 1,2,3

     Let v_Aso_Ini = Year(v_aso_mes_pago);
     Let v_Mes_Ini = Month(v_aso_mes_pago);
  if v_Mes_Ini = 11 then
     Let v_Aso_Ini = v_Aso_Ini + 1;
     Let v_Mes_Ini = 1;
  end if;
  if v_Mes_Ini = 12 then
     Let v_Aso_Ini = v_Aso_Ini + 1;
     Let v_Mes_Ini = 2;
  end if;
  if v_Mes_Ini < 11 then
     Let v_Mes_Ini = v_Mes_Ini + 2;
  end if;

                                                    Select sum(porc_recargo) 
   			    Into v_Importe_recargo
                                                    From ta_16_recargos 
                                                           Where aso_mes_recargo between v_Aso_Ini||'-'||v_Mes_Ini and v_Aso_Hoy||'-'||v_Mes_Hoy;

  Let v_Detalle_CO = v_Detalle_CO||v_Mes;
  Let v_Adeudos = v_Adeudos + v_importe;
  if v_Importe_recargo <> 0 then
     Let v_Recargos = v_Recargos + ((v_importe * v_Importe_recargo) / 100);
  end if;
  Let v_Lineas_CO = v_Lineas_CO + 1;
  end foreach;


--     Grabando registro 
   if v_Lineas_CN > 0 then
      Let v_Detalle_T = v_Detalle_T||v_Detalle_CN;
   end if;
   if v_Lineas_EX > 0 then
      Let v_Detalle_T = v_Detalle_T||v_Detalle_EX;
   end if;
   if v_Lineas_CO > 0 then
      Let v_Detalle_T = v_Detalle_T||v_Detalle_CO;
   end if;


   if ( (v_Lineas_CN > 0) or (v_Lineas_EX > 0) or (v_Lineas_CO > 0) ) then
       Insert into Det_Pagos values
                       (p_Control, p_Ejercicio, v_Detalle_T, v_Adeudos, v_Recargos, 0, 0);
   end if;

end procedure;

CREATE PROCEDURE "informix".spd_17_afecta_case(
parm_id_control integer,
parm_axo_mes_desde char(07),
parm_axo_mes_hasta char(07),
parm_fecha_pago date,
parm_oficina_pago smallint,
parm_caja_pago char(01),
parm_oper_pago integer,
parm_cve_req char(01),
parm_folio_rcbo char(18),
parm_id_usuario  integer)
define  v_id_control integer;
define  v_aso_mes datetime  year to month;
define  v_ctrol_operacion integer;
define  v_importe money(10,2);
define  v_status_vigencia char(01);
define  v_exedencias smallint;
define  v_cve_operacion char(01);
define  v_descripcion char(30);
define  v_modulo smallint;
define  v_control_otr integer;
define  v_folioreq integer;
define  v_diligencia char(01);
define  v_importe_gastos money(10,2);
define  v_cve_practicado char(01);
define  v_vigencia char(01);
foreach
   select a.control_contrato,a.aso_mes_pago,a.ctrol_operacion,a.importe,a.status_vigencia,a.exedencias,e.cve_operacion,e.descripcion into v_id_control,v_aso_mes,v_ctrol_operacion,v_importe,v_status_vigencia,v_exedencias,v_cve_operacion,v_descripcion
	from    ta_16_pagos a, ta_16_operacion e
	where a.control_contrato=parm_id_control
	and a.ctrol_operacion=e.ctrol_operacion
	and (e.cve_operacion='C' or e.cve_operacion='E')
	and a.status_vigencia='V' 
	and a.aso_mes_pago between parm_axo_mes_desde and parm_axo_mes_hasta
	order by a.aso_mes_pago,a.ctrol_operacion
    update ta_16_pagos  set  status_vigencia='P',fecha_hora_pago=parm_fecha_pago,id_rec=parm_oficina_pago,caja=parm_caja_pago,consec_operacion=parm_oper_pago,folio_rcbo=parm_folio_rcbo,usuario=parm_id_usuario
    where control_contrato=v_id_control and aso_mes_pago=v_aso_mes and ctrol_operacion=v_ctrol_operacion;  
end foreach;
if  parm_cve_req='S' then
    foreach
    select modulo,control_otr,folio,diligencia,importe_gastos,clave_practicado,vigencia into v_modulo,v_control_otr,v_folioreq,v_diligencia,v_importe_gastos,v_cve_practicado,v_vigencia 
    from ta_15_apremios
    where modulo=16
    and control_otr=v_id_control
    and vigencia='1'
    and clave_practicado='P'
    order by folio
    update ta_15_apremios set vigencia=2,fecha_pago=parm_fecha_pago,recaudadora=parm_oficina_pago,caja=parm_caja_pago,
        operacion=parm_oper_pago,importe_pago=v_importe_gastos
        where modulo=v_modulo and  control_otr=v_control_otr and folio=v_folioreq;
    end foreach;
end if;
end procedure;

CREATE PROCEDURE "informix".spd_17_afecta_cene(
parm_id_energia integer,
parm_axo_desde smallint,
parm_mes_desde smallint,
parm_axo_hasta smallint,
parm_mes_hasta smallint,
parm_fecha_pago date,
parm_oficina_pago smallint,
parm_caja_pago char(01),
parm_oper_pago integer,
parm_cve_req char(01),
parm_folio char(18),
parm_id_usuario  integer)
define  v_id_energia integer;
define  v_axo smallint;
define  v_periodo  smallint;
define  v_importe money(10,2);
define  v_modulo smallint;
define  v_control_otr integer;
define  v_folioreq integer;
define  v_diligencia char(01);
define  v_importe_gastos money(10,2);
define  v_cve_practicado char(01);
define  v_vigencia char(01);
define  v_cve_consumo char(01);
define  v_cantidad decimal(7,2);
foreach
   select id_energia,cve_consumo,cantidad,axo,periodo,importe into v_id_energia,v_cve_consumo,v_cantidad,v_axo,v_periodo,v_importe
        from ta_11_adeudo_energ
        where id_energia=parm_id_local
        and ( (axo>parm_axo_desde  or (periodo>=parm_mes_desde and axo=parm_axo_desde)) 
        and (axo<parm_axo_hasta  or (periodo<=parm_mes_hasta and axo=parm_axo_hasta)) )
        order by axo asc,periodo asc
    insert into ta_11_pago_energia  values(0,v_id_energia,v_axo,v_periodo,parm_fecha_pago,parm_oficina_pago,parm_caja_pago,parm_oper_pago,v_importe,
        v_cve_consumo,v_cantidad,parm_folio,current,parm_id_usuario);
    delete from ta_11_adeudo_local where id_local=v_id_local and axo=v_axo and periodo=v_periodo;    
end foreach;
if  parm_cve_req='S' then
    foreach
    select modulo,control_otr,folio,diligencia,importe_gastos,clave_practicado,vigencia into v_modulo,v_control_otr,v_folioreq,v_diligencia,v_importe_gastos,v_cve_practicado,v_vigencia 
    from ta_15_apremios
    where modulo=33
    and control_otr=v_id_energia
    and vigencia='1'
    and clave_practicado='P'
    order by folio
    update ta_15_apremios set vigencia=2,fecha_pago=parm_fecha_pago,recaudadora=parm_oficina_pago,caja=parm_caja_pago,
        operacion=parm_oper_pago,importe_pago=v_importe_gastos
        where modulo=v_modulo and  control_otr=v_control_otr and folio=v_folioreq;
    end foreach;
end if;
end procedure;

CREATE PROCEDURE "informix".spd_17_afecta_cmer(
parm_id_local integer,
parm_axo_desde smallint,
parm_mes_desde smallint,
parm_axo_hasta smallint,
parm_mes_hasta smallint,
parm_fecha_pago date,
parm_oficina_pago smallint,
parm_caja_pago char(1),
parm_oper_pago integer,
parm_cve_req char(1),
parm_folio char(18),
parm_id_usuario  integer)
define  v_id_local integer;
define  v_axo smallint;
define  v_periodo  smallint;
define  v_importe money(10,2);
define  v_modulo smallint;
define  v_control_otr integer;
define  v_folioreq integer;
define  v_diligencia char(1);
define  v_importe_gastos money(10,2);
define  v_cve_practicado char(1);
define  v_vigencia char(1);
if  (parm_axo_desde>0) and (parm_mes_desde>0) and (parm_axo_hasta>0) and (parm_mes_hasta>0) then
   foreach
   select id_local,axo,periodo,importe into v_id_local,v_axo,v_periodo,v_importe
        from ta_11_adeudo_local
        where id_local=parm_id_local
        and ( (axo>parm_axo_desde  or (periodo>=parm_mes_desde and axo=parm_axo_desde)) 
        and (axo<parm_axo_hasta  or (periodo<=parm_mes_hasta and axo=parm_axo_hasta)) )
        order by axo asc,periodo asc
        insert into ta_11_pagos_local  values(0,v_id_local,v_axo,v_periodo,parm_fecha_pago,parm_oficina_pago,parm_caja_pago,parm_oper_pago,v_importe,
                 parm_folio,current,parm_id_usuario);
        delete from ta_11_adeudo_local where id_local=v_id_local and axo=v_axo and periodo=v_periodo;    
    end foreach;
end if;
if  parm_cve_req='S' then
    foreach
    select modulo,control_otr,folio,diligencia,importe_gastos,clave_practicado,vigencia into v_modulo,v_control_otr,v_folioreq,v_diligencia,v_importe_gastos,v_cve_practicado,v_vigencia 
    from ta_15_apremios
    where modulo=11
    and control_otr=parm_id_local
    and vigencia='1'
    and clave_practicado='P'
    order by folio
    update ta_15_apremios set vigencia=2,fecha_pago=parm_fecha_pago,recaudadora=parm_oficina_pago,caja=parm_caja_pago,
        operacion=parm_oper_pago,importe_pago=v_importe_gastos
        where modulo=v_modulo and  control_otr=v_control_otr and folio=v_folioreq;
    end foreach;
end if;
end procedure;

CREATE PROCEDURE "informix".spd_17_b_p400cont()
define    v_colonia smallint;
define    v_calle  smallint; 
define    v_reg integer;
foreach
   select colonia,calle,count(*) into v_colonia,v_calle,v_reg from ta_17_paso_p_400
        group by colonia,calle
        order  by colonia,calle 
   delete from ta_17_paso_p_400 where colonia=v_colonia and calle=v_calle;  
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_17_limpia_paso()
define    v_colonia smallint;
define    v_reg integer;
foreach
   select colonia,count(colonia) into v_colonia,v_reg from ta_17_paso_cont
        group by colonia
        order  by colonia 
   delete from ta_17_paso_cont where colonia=v_colonia;  
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_a_cant_pgos (par_p Smallint)
   define v_imp_rec		money(12,2);
   define v_Control_contrato    integer;

foreach
  select a.Control_contrato
      into v_Control_contrato
  from ta_16_contratos a
          where a.ctrol_aseo = 9 and a.aso_mes_oblig >= '2000-01'

		update ta_16_pagos set
			exedencias = importe / 37.00
		where control_contrato = v_Control_contrato
			and status_vigencia = 'V'
			and aso_mes_pago between '2007-01' and '2007-12';

end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_abcmultas(
               parid_control                  integer,
               pardependencia             char(01)      , 	
               paraxo_acta                   integer        ,
               parnumero_acta             integer       ,				
               parnumero_insp            smallint        ,
               parnombre                     varchar(50)  ,
               pardomicilio                   varchar(30)  ,
               parsector                       char(01)      ,
               parnumero_orden          integer        ,
               parnumero_zona           smallint       ,
               parsub_zona                 smallint       ,
               partipo_infrac                smallint         ,
               paractividad_giro          varchar(40)   ,
               parley                            smallint          ,
               parimporte_inicial          money(15, 2) ,
               parimporte_pagar          money(15, 2) ,
               parnumero_licencia       integer,           
               parnumero_lote             integer  ,
               parvigencia                  char (01) ,
               parnumero_control       smallint,
               parporc_multa              smallint ,
               parporc_gastos            smallint,
               parfecha_alta              date ,
               parfecha_baja             date ,
               parusuario                    integer ,
               parcontribuyente           integer ,	
            parOpc char(1)
		)
		
define  varfecha_pago    date ;
define     varofna_pago     smallint ;
define     varcaja_pago     char (01) ;
define     varoper_pago     integer  ;
define     varimporte_pago money(15,2) ;
		
--si la opcion fue insertar
if parOpc='I' then
           insert into ta_08_multas values( 0,  pardependencia ,  paraxo_acta, parnumero_acta ,
               parnumero_insp  ,
               parnombre   ,
               pardomicilio ,
               parsector     ,
               parnumero_orden     ,
               parnumero_zona       ,
               parsub_zona             ,
               partipo_infrac            ,
               paractividad_giro      ,
               parley                        ,
               parimporte_inicial      ,
               0    ,
               parnumero_licencia  ,           
               parnumero_lote        ,
               parvigencia              ,
               parnumero_control   ,
               0       ,
               0       ,
               today   , 
               parfecha_alta           ,
               null   ,
               null   ,
               null     ,
               null      , 
               null     ,
               null  ,
               null,
               parusuario            ,
              current,
              0)	;
-- Actualiza si la multa si ya esta pagada en pagos provicionales.
if exists(select * from ta_08_pagos_prov where
	dependencia  = pardependencia and
                axo_acta = paraxo_acta  and
                numero_acta = parnumero_acta
	 ) then
                select  fecha_pago  , ofna_pago, caja_pago  , oper_pago , importe_pago 
                into varfecha_pago  , varofna_pago, varcaja_pago  , varoper_pago , varimporte_pago
                 from ta_08_pagos_prov
                where
	dependencia  = pardependencia and
                axo_acta = paraxo_acta  and
                numero_acta = parnumero_acta;

	update ta_08_multas set 
               fecha_pago    = varfecha_pago      ,
               recaudadora   = varofna_pago   ,
               caja                = varcaja_pago  , 
               operacion       = varoper_pago ,
               vigencia                = 'P'             ,
               importe_pago  = varimporte_pago
	where
	dependencia  = pardependencia and
                axo_acta = paraxo_acta  and
                numero_acta = parnumero_acta ;
--
            delete from ta_08_pagos_prov
                 where
	dependencia  = pardependencia and
                axo_acta = paraxo_acta  and
                numero_acta = parnumero_acta ;
            end if;

end if;
if parOpc='M' then

insert into ta_08_HMultas select * from ta_08_multas where id_control = parid_control;

update ta_08_multas set  
               numero_inspector =   parnumero_insp  ,
               nombre                 =   parnombre   ,
               domicilio                =  pardomicilio ,
               sector                    =  parsector     ,
               numero_orden       =  parnumero_orden     ,
               numero_zona        =  parnumero_zona       ,
               sub_zona                = parsub_zona             ,
               tipo_infrac             = partipo_infrac            ,
               actividad_giro      = paractividad_giro      ,
               ley                        =  parley                        ,
               importe_pagar       = parimporte_pagar,
               numero_licencia    = parnumero_licencia  ,           
               numero_lote          = parnumero_lote        ,
               vigencia                = parvigencia              ,
               usuario                   =    parusuario            ,
              fecha_cambio        = current
       where id_control = parid_control;
end if;


if parOpc='D' then

update ta_08_multas set  fecha_baja = parfecha_baja ,
                                         fecha_baja_real = today,
                                        fecha_cambio = current
         where 
            id_control = parid_control;
end if;
end procedure;

CREATE PROCEDURE "informix".spd_borra_pagmerc(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parusuario 	integer,
		parOpc                    char(1))

 define varid_pago   integer;
 define varid_local   integer;
 define varaxo         integer;
 define varperiodo   smallint;
 define varimpte      money(15,2);
 define varimpte_cal    money(15,2);
 define varfec_des  date;

--set debug file to "marco.log";
--trace on;

if 	parOpc='C' then
foreach
            select id_pago_local,id_local,axo,periodo,importe_pago  into
            varid_pago,varid_local,varaxo,varperiodo,varimpte from ta_11_pagos_local
                   where  fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
    		caja_PAGO=parCaja and operacion_PAGO=parOperacion
               if varaxo=year(current) and varperiodo=month(current) then
                  select  fecha_descuento into varfec_des  from ta_11_fecha_desc where mes=varperiodo;
               else
                 let varfec_des= "01/01/2003";
                end if;
               if varfec_des>=parfecha then
                  let varimpte_cal =(((varimpte  *(0.1))/9) * 100);
               else
                  let varimpte_cal =varimpte;
              end if;
            insert into ta_11_adeudo_local values(0, varid_local,varaxo,varperiodo,varimpte_cal,current,parusuario);     
end foreach;
end if;
           delete from ta_11_pagos_local 
                   where  fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
   		caja_PAGO=parCaja and operacion_PAGO=parOperacion;
           update ta_15_apremios set fecha_pago =0,recaudadora=0,caja='',operacion=0,vigencia='1'
                        where  modulo=11 and fecha_pago=parFecha and recaudadora=parId_rec and
    		caja=parCaja and operacion=parOperacion;

--trace off;
end procedure;

CREATE PROCEDURE "informix".spd_borra_pagmnvo(
    		parFecha 	date,
    		parId_rec 	smallint,
    		parCaja 		char(2),
    		parOperacion 	integer,
    		parusuario 	integer,
		parOpc                    char(1))


--set debug file to "marco.log";
--trace on;

          delete from ta_11_pagos_local 
                   where  fecha_pago=parFecha and OFICINA_PAGO=parId_rec and
   		caja_PAGO=parCaja and operacion_PAGO=parOperacion;

--trace off;
end procedure;

CREATE PROCEDURE "informix".spd_del_adevc (P Smallint)
             define v_Control_contrato 	integer;
             define v_Fecha_baja	     	Date;

  foreach
    Select Control_contrato, Fecha_hora_baja
      into v_Control_contrato, v_Fecha_baja
    From ta_16_contratos
             where status_vigencia = 'C'

                        Delete from ta_16_pagos
                             where Control_contrato = v_Control_contrato
		and aso_mes_pago > v_Fecha_baja
		and ((status_vigencia = 'V') or (status_vigencia = 'C'));
  end foreach;

  end procedure;

CREATE PROCEDURE "informix".spd_graba_cont()
define ct_cem  char(01);
define ct_clas   smallint;
define ct_clasa varchar(10,0);
define ct_sec    smallint;
define ct_seca  varchar(10,0);
define ct_lin      smallint;
define ct_lina    varchar(20,0);
define ct_fos     smallint;
define ct_fosa   varchar(20,0);
define ct_cont   integer;
foreach
        select cementerio, clase,clase_alfa,seccion,seccion_alfa,linea,linea_alfa,fosa,fosa_alfa,control_rcm
        into ct_cem,ct_clas,ct_clasa,ct_sec,ct_seca,ct_lin,ct_lina,ct_fos,ct_fosa,ct_cont 
        from ta_13_datosrcm where cementerio='V' and clase=1 and (seccion between 5 and 999)
        update ta_13_pagosrcm set control_rcm=ct_cont where cementerio = ct_cem  and clase=ct_clas and clase_alfa=ct_clasa and seccion=ct_sec and seccion_alfa=ct_seca and linea=ct_lin and linea_alfa=ct_lina and fosa=ct_fos and fosa_alfa=ct_fosa ;
end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_pag_nvome(par_id integer, par_cuantas smallint, par_renta money(16,2),par_us integer,par_opc char(1))
define var_ctas smallint;
define var_axo smallint;
let var_ctas=par_cuantas;
let var_axo=year(current);
if par_opc='G' then
while var_ctas<13 
     insert into ta_11_adeudo_local values (0,par_id,var_axo,var_ctas,par_renta,current,par_us);
    let var_ctas=var_ctas+1;
end while;
elif par_opc='B' then
     delete from ta_11_adeudo_local where id_local=par_id and (axo=year(current) and periodo>month(current));
end if;
end procedure;

CREATE PROCEDURE "informix".spd_12_estadistica(
                                                    par_fecha   date,
                                                    par_f1         date,
                                                    par_f2          date,
                                                    par_axom    integer,
                                                    par_axom1  integer,
                                                    par_usuario integer,
                                                    par_ip char(20))
define    v_titulo smallint;
define    v_capitulo char(02);
define    v_cta_aplicacion integer;
define    v_descripcion VARCHAR(60,0);
define    v_impte_dia money(15, 2);
define    v_doc_dia INTeger;
define    v_impte_mes money(15, 2);
define    v_doc_mes INTeger;
define    v_impte_ax money(15, 2);
define    v_doc_ax INTeger;

delete from ta_12_estadisticas where (fecha_act<today) or 
 (fecha_act=today and host_ip=par_ip); 

foreach
   SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, 
                  sum(a.importe_cta),sum(a.documento)
   into         v_titulo,v_capitulo,v_cta_aplicacion,v_descripcion,v_impte_dia,v_doc_dia  
   from        cg_12_importes a , cg_12_cuentas b
   where     a.fecing=par_fecha and a.cta_aplicacion=b.cta_aplicacion 
   group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

   if not exists( select * from ta_12_estadisticas
                       where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion) then
          insert into ta_12_estadisticas  values( par_fecha,v_titulo,v_capitulo,v_cta_aplicacion, v_descripcion, v_impte_dia, v_doc_dia,0,0,0,0,today,par_usuario,par_ip);
   else
          update ta_12_estadisticas set   impte_diario=v_impte_dia,doc_diario=v_doc_dia
          where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion;
       end if; 
end foreach;

foreach
   SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion,sum(a.importe_cta),sum(trunc(a.documento)) 
   into         v_titulo,v_capitulo,v_cta_aplicacion,v_descripcion,v_impte_mes,v_doc_mes  
   from        cg_12_importes a , cg_12_cuentas b
   where a.fecing between par_f1 and par_f2 
             and a.fecing<=par_fecha and a.cta_aplicacion=b.cta_aplicacion 
   group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

   if not exists( select * from ta_12_estadisticas
                       where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion) then
          insert into ta_12_estadisticas  values( par_fecha,v_titulo,v_capitulo,v_cta_aplicacion, v_descripcion,0,0, v_impte_mes, v_doc_mes,0,0,today,par_usuario,par_ip);
   else
          update ta_12_estadisticas set   impte_mensual=v_impte_mes,doc_mensual=v_doc_mes
          where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion;
       end if; 
end foreach;

foreach
   SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion,sum(a.importe),sum(a.numero_doctos)  
   into         v_titulo,v_capitulo,v_cta_aplicacion,v_descripcion,v_impte_ax,v_doc_ax  
   from        ta_12_ingresoanual a , cg_12_cuentas b
   where a.axo_mes>=par_axom  and a.axo_mes<par_axom1 and a.cta_aplicacion=b.cta_aplicacion
   group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

   if not exists( select * from ta_12_estadisticas
                       where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion) then
          insert into ta_12_estadisticas  values( par_fecha,v_titulo,v_capitulo,v_cta_aplicacion, v_descripcion,0,0,0,0, v_impte_ax, v_doc_ax,today,par_usuario,par_ip);
   else
          update ta_12_estadisticas set   impte_anual=v_impte_ax,doc_anual=v_doc_ax
          where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion;
       end if; 
end foreach;


end procedure;

CREATE PROCEDURE "informix".spd_cgdocumento(
                                                    par_fecha   date,
                                                    par_fecha1  date)
                                                  
                                                 
                 
define    v_fecha     date;
define    v_rec         smallint;
define    v_caja       char(2);
define    v_opera     integer;
define    v_numero  integer;
define    v_control  integer;


foreach
   SELECT a.fecing,a.recing,a.cajing,a.opcaja,numero,control_id
   into         v_fecha,v_rec,v_caja,v_opera,v_numero,v_control
   from       CG_12_ingreso a, CG_12_importes b
   where    (a.fecing>=par_fecha and a.fecing<=par_fecha1) and numero>0 and
   tipo_rbo='12' and cta_aplicacion in(110110000, 110120000) and a.fecing=b.fecing and a.recing=b.recing and a.cajing=b.cajing and a.opcaja=b.opcaja

   update CG_12_importes  set   documento=v_numero
          where fecing=v_fecha and recing=v_rec and cajing=v_caja and opcaja = v_opera and control_id=v_control;

end foreach;foreach
   SELECT a.fecing,a.recing,a.cajing,a.opcaja,numero,control_id
   into         v_fecha,v_rec,v_caja,v_opera,v_numero,v_control
   from        cg_12_ingreso a, cg_12_importes b
   where    (a.fecing>=par_fecha and a.fecing<=par_fecha1) and numero>0 and
   tipo_rbo='12'  and cta_aplicacion = 991700001 and a.fecing=b.fecing and a.recing=b.recing and a.cajing=b.cajing and a.opcaja=b.opcaja

   update cg_12_importes  set   documento=v_numero
          where fecing=v_fecha and recing=v_rec and cajing=v_caja and opcaja = v_opera and control_id=v_control;

end foreach;
end procedure;

CREATE PROCEDURE "informix".spd_12_documento(
                                                    par_fecha   date,
                                                    par_fecha1  date)
                                                  
                                                 
                 
define    v_fecha     date;
define    v_rec         smallint;
define    v_caja       char(2);
define    v_opera     integer;
define    v_numero  integer;
define    v_control  integer;


foreach
   SELECT a.fecing,a.recing,a.cajing,a.opcaja,numero,control_id
   into         v_fecha,v_rec,v_caja,v_opera,v_numero,v_control
   from        cg_12_ingreso a, cg_12_importes b
   where    (a.fecing>=par_fecha and a.fecing<=par_fecha1) and numero>0 and
   tipo_rbo='12' and cta_aplicacion = 110110000 and a.fecing=b.fecing and a.recing=b.recing and a.cajing=b.cajing and a.opcaja=b.opcaja

   update cg_12_importes  set   documento=v_numero
          where fecing=v_fecha and recing=v_rec and cajing=v_caja and opcaja = v_opera and control_id=v_control;

end foreach;
foreach
   SELECT a.fecing,a.recing,a.cajing,a.opcaja,numero,control_id
   into         v_fecha,v_rec,v_caja,v_opera,v_numero,v_control
   from        cg_12_ingreso a, cg_12_importes b
   where    (a.fecing>=par_fecha and a.fecing<=par_fecha1) and numero>0 and
   tipo_rbo='12'  and cta_aplicacion = 991700001 and a.fecing=b.fecing and a.recing=b.recing and a.cajing=b.cajing and a.opcaja=b.opcaja

   update cg_12_importes  set   documento=v_numero
          where fecing=v_fecha and recing=v_rec and cajing=v_caja and opcaja = v_opera and control_id=v_control;

end foreach;
end procedure;

CREATE PROCEDURE "saranda".calc_desclicrecar(v_folio  int, v_opc int, v_tipo char(1), v_id int)
   define  v_porcent            int;
   define  v_recar         money(16,2);
   define  v_descrec        money(16,2);
   define  v_idanun           int;
   define  v_axo           int;

 if v_tipo ='L' then
    foreach
        SELECT a.recargos,b.porcentaje,a.id_anuncio,a.axo     
        INTO   v_recar, v_porcent,v_idanun,v_axo
        FROM detsal_lic  a, descreclic b
        WHERE a.id_licencia=v_folio and b.id_descto=v_id and a.id_licencia=b.licencia and b.tipo=v_tipo 
           and a.axo between b.axoini and b.axofin
           
        LET v_descrec = 0;

        if v_opc=1 then
           LET v_descrec = (v_recar * v_porcent)/100;
        end if;

        UPDATE detsal_lic set desc_recargos=v_descrec
        WHERE id_licencia=v_folio and id_anuncio=v_idanun and axo=v_axo and cvepago=0;
    end foreach;
end if;

if v_tipo ='A' then
      foreach
        SELECT a.recargos,b.porcentaje,a.id_licencia,a.axo
          INTO v_recar, v_porcent,v_idanun,v_axo
        FROM detsal_lic  a, descreclic b
        WHERE a.id_anuncio=v_folio and a.id_anuncio=b.licencia and b.tipo=v_tipo 
             and b.id_descto=v_id  and a.axo between b.axoini and b.axofin
 
         if v_opc=1 then
            LET v_descrec = (v_recar * v_porcent)/100;
        else
           LET v_descrec = 0;
        end if;

           UPDATE detsal_lic set desc_recargos=v_descrec
           WHERE id_anuncio=v_folio and id_licencia=v_idanun and axo=v_axo and cvepago=0;
      end foreach;
end if; 
EXECUTE PROCEDURE informix.calc_sdosl(v_folio);

END PROCEDURE;

create procedure "bcabrera".spd_pagossite(vfecha1 date,vfecha2 date)
define rfecha date;
define rid_rec smallint;
define rcaja char(2);
define roperacion integer;
define rcvecuenta integer;
define rmodulo smallint;
define raxodsd smallint;
define rmesdsd smallint;
define raxohst smallint;
define rmeshst smallint;
define rpagado money(16,2);
define rimpuesto money(16,2);
define rrecargos money(16,2);
define rmulta money(16,2);
define rgastos money(16,2);
define rredondeo money(16,2);
define rsubsidio money(16,2);

foreach
select a.fecha,a.id_rec,a.caja,a.operacion,a.rfcnumero,a.id_modulo,a.axodesde,a.mesdesde,
a.axohasta,a.meshasta,a.importe,
nvl((select sum(importe) from ta_12_recibosdet 
where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja and operacion=a.operacion
and cuenta in (110110000,110210000,921100002,921100001)),0),
nvl((select sum(importe) from ta_12_recibosdet 
where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja and operacion=a.operacion
and cuenta in (150100000,150200000)),0),
nvl((select sum(importe) from ta_12_recibosdet 
where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja and operacion=a.operacion
and cuenta =510100000),0),
nvl((select sum(importe) from ta_12_recibosdet 
where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja and operacion=a.operacion
and cuenta =992100009),0),
nvl((select sum(importe) from ta_12_recibosdet 
where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja and operacion=a.operacion
and cuenta =550800000),0),
nvl((select sum(importe) from ta_12_recibosdet 
where fecha=a.fecha and id_rec=a.id_rec and caja=a.caja and operacion=a.operacion
and cuenta =992100014),0) 
into rfecha,rid_rec,rcaja,roperacion,rcvecuenta,rmodulo,raxodsd,rmesdsd,raxohst,rmeshst,rpagado,
rimpuesto,rrecargos,rmulta,rgastos,rredondeo,rsubsidio
from ta_12_recibos a 
where (a.fecha between vfecha1 and vfecha2) and a.id_modulo=5 and a.cvepago='P'

insert into pagossite values(rfecha,rid_rec,rcaja,roperacion,rcvecuenta,rmodulo,raxodsd,rmesdsd,
raxohst,rmeshst,rpagado,(rimpuesto+rsubsidio),rrecargos,rmulta,rgastos,rredondeo,null,null,null,null,null);

end foreach
end procedure
;

CREATE PROCEDURE "informix".sp_verifica_pagossite()
{######################################################################
#  Procedimiento:    sp_verifica_pagossite
#  Descripcion:      Verifica los pagos realizados con el sistema site, y anotar sus diferencias 
#
#  Parametros       
#  de entrada:      
#               
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            13 Septiembre 2011   
#
#  Llamado por:      Programa Cajero de Tesoreria       
#  Llama a:          
#  
######################################################################}
--** ESTATUS para N=conciliado sin error, D=diferencia en importes 

define v_estatus	char(1);
define v_mensaje	varchar(100);
define v_estatusn	char(1);
define v_estatusi	char(1);
define v_estatusm	char(1);
define v_estatusg	char(1);
define v_estatusr	char(1);

define v_fecha date;
define v_id_rec int;
define v_caja char(2);
define v_operacion int;

define v_folio int;
define v_importe money(16,2);
define v_difimp money(16,2);
define v_recppag  money(16,2);
define v_imppag  money(16,2);
define v_multa  money(16,2);
define v_gasto money(16,2);
define v_axodesde int;
define v_axohasta int;
define v_bimdesde int;
define v_bimhasta int;
define v_lrecargos  money(16,2);
define v_limpuestos  money(16,2);
define v_lmultas  money(16,2);
define v_lgastos money(16,2);
define v_clavepago int;
define v_lredondeo  money(16,2);
--set debug file to "lineacarga.log";
--   trace on;
------------------------------------------------------------------------------------------------------------------
   let v_estatus = "";
   let v_estatusn = "";
   let v_estatusi = "";
   let v_estatusm = "";
   let v_estatusg = "";
   let v_estatusr = "";
   --obtener los datos del registro de predial  
  -- select * from pagossite
foreach
   select cvecuenta,pagado,axodesde,axohasta,mesdesde,meshasta,
          recargos,impuesto,gastos,multa,redondeo,
 	  fecha,id_rec,caja,operacion into 
	  v_folio,v_importe,v_axodesde ,v_axohasta,v_bimdesde,v_bimhasta,
          v_lrecargos,v_limpuestos,v_lgastos,v_lmultas,v_lredondeo, 
          v_fecha,v_id_rec,v_caja,v_operacion
          from pagossite 
          where estadon not in ( "A", "Z", "P", "D","F") or estadon is null
      --le quita el redondeo al pagado	
      let v_importe = v_importe - v_lredondeo;
      -- Revisa la informacion de saldos
      if exists (SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  

			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4) then
	if v_bimhasta = 6 then
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         else
          SELECT SUM(d.recfac-d.recpag-d.recvir) RecpPag, 
               		SUM(d.impfac-d.imppag-d.impvir) Impppag,
                       	(Saldos.multa-Saldos.multavir) multa,
                        Saldos.gasto into v_recppag, v_imppag, v_multa,v_gasto
			FROM catastro_gdl:detsaldos d, catastro_gdl:saldos Saldos
			WHERE  d.cvecuenta = v_folio  
			      AND  Saldos.cvecuenta = d.cvecuenta
			      AND  d.saldo > 0 and exento='N'
			      AND  ( (d.axosal>v_axodesde  or (d.bimsal>=v_bimdesde  and d.axosal =v_axodesde)) and
		                   (d.axosal<v_axohasta  or (d.bimsal<=v_bimhasta and d.axosal =v_axohasta))  )
			GROUP BY 3,4;
         end if;
   let v_estatusn = "";
   let v_estatusi = "";
   let v_estatusm = "";
   let v_estatusg = "";
   let v_estatusr = "";
-- Se verifica como diferencia en importe
         if v_importe = (v_recppag + v_imppag + v_multa + v_gasto) then
            let v_estatusn = "N";
	    let v_mensaje = "IMPORTE PAGADO CORRECTAMENTE";
         else
	   -- Verificar cual es la diferencia	
           if	(v_imppag <> v_limpuestos) then
            	let v_estatusi = "I";
	    	let v_mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN IMPORTE FACTURADO";
           end if;
           if v_multa <> v_lmultas then
            	let v_estatusm = "M";
		let v_mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN MULTAS";
           end if;
           if v_gasto <> v_lgastos then
            	let v_estatusg = "G";
            	let v_mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN GASTOS";
           end if;
           if v_recppag <> v_lrecargos then
            	let v_estatusr = "R";
            	let v_mensaje = "LA CUENTA DE PREDIAL TIENE DIFERENCIA EN GASTOS";
           end if;
	 end if;
	 update  pagossite set
     			estadon=v_estatusn, 
     			estadoi=v_estatusi, 
     			estadom=v_estatusm, 
     			estadog=v_estatusg, 
     			estador=v_estatusr 
	 where fecha = v_fecha and id_rec = v_id_rec and caja = v_caja and operacion = v_operacion;
      end if; --existe en SALDOS

end foreach;
end procedure;

CREATE PROCEDURE "saranda".spd_adeudos_rcm ()

define v_control integer;
define v_axo integer;
define v_importe money;
define v_recargos money;

foreach

  select control_rcm into v_control from ta_13_datosrcm where axo_pagado<2011

--  execute procedure  spd_adeudorcm(v_control) into v_axo,v_importe,v_recargos;
  execute procedure  spd_adeudorcm(v_control,2);


end foreach;
end procedure;

CREATE PROCEDURE "saranda".paso()
define   Vcontrol_des int;
define      Vcontrol_rcm	INTEGER;
define      Vaxo_alta   	INTEGER;
define      Vdecuento   	INTEGER;
define      Vusuario    	INTEGER;
define      Vfecha_mov  	DATE;
define      Vaxo_ini    	INTEGER;

foreach

select control_des, control_rcm, axo_alta, decuento, usuario, fecha_mov, axo_ini 
into Vcontrol_des, Vcontrol_rcm, Vaxo_alta, Vdecuento, Vusuario, Vfecha_mov, Vaxo_ini 
from ta_13_descpens
insert into ta_13_descpens1 values(Vcontrol_des, Vcontrol_rcm, Vaxo_alta, Vdecuento, Vusuario, Vfecha_mov, Vaxo_ini); 
end foreach;
end procedure;

CREATE PROCEDURE "saranda".spd_abc_adercm (v_control int, v_opc int,v_usu int)

--define v_axo integer;

--  select axo_pagado into v_axo from ta_13_datosrcm where control_rcm=v_control;
if v_opc = 1 then
  execute procedure  spd_adeudorcm(v_control,v_usu);
end if;
if v_opc = 2 then
  execute procedure  spd_bajarcm(v_control,v_usu);
end if;
if v_opc = 3 then
  execute procedure  spd_actualrcm(v_control,v_usu);
end if;
end procedure;

create procedure "bcabrera".spd_difpredial()

define v_rec,v_oper int;
define v_caja char(2);
define v_certificado,v_detalle,v_diferencia,v_impcta money(16,2);

foreach
select a.id_rec,a.caja,a.operacion,nvl(a.importe,0),
nvl(sum(b.importe),0),nvl((a.importe-sum(b.importe)),0)
into v_rec,v_caja,v_oper,v_certificado,v_detalle,v_diferencia
from ta_12_recibos a, ta_12_recibosdet b
where a.fecha=mdy(1,2,2012)
--and a.id_rec=5
and cvepago='C' 
and b.fecha=a.fecha
and b.id_rec=a.id_rec
and b.caja=a.caja
and b.operacion=a.operacion
group by a.id_rec,a.caja,a.operacion,a.importe
having (a.importe-sum(b.importe))<>0
order by a.id_rec,a.caja,a.operacion

select importe into v_impcta from ta_12_recibosdet 
where fecha=mdy(1,2,2012) and id_rec=v_rec and caja=v_caja
and operacion=v_oper and cuenta=110110000; 

update ta_12_recibosdet set importe=v_impcta+v_diferencia 
where fecha=mdy(1,2,2012) and id_rec=v_rec and caja=v_caja
and operacion=v_oper and cuenta=110110000; 
end foreach;

end procedure;

create PROCEDURE "saranda".spd_bajarcm (v_control int, v_usu int)

define v_axo integer;
define v_axoi integer;
define v_importe  money(15,2);
define v_recar  money(15,2);

let v_axo=year(today);

if exists(select * from ta_13_adeudosrcm where control_rcm=v_control) then
update ta_13_adeudosrcm set vigencia='B', usuario=v_usu , fecha_mov=today 
where control_rcm=v_control and vigencia='V' and axo_adeudo<=v_axo;
end if;
end procedure;

CREATE PROCEDURE "imtorre".calc_tmppredpresc()

define v_cvecuenta int; 
define v_impuesto money(12,2) ;
define v_recargos money(12,2) ;


foreach
select  a.cvecuenta , nvl(sum(a.impfac),0), nvl(sum(a.recfac),0) 
   into v_cvecuenta , v_impuesto , v_recargos 
         from catastro_gdl:detsaldos a, catastro_gdl:convcta b 
         where a.axosal < 2007  and  a.cvecuenta = b.cvecuenta and b.urbrus = 'U' 
               and b.vigente ='V' and a.saldo > 10
          group by 1

update tm_rezagopred set impto_presc = v_impuesto , recgo_presc = v_recargos
       where cvecuenta = v_cvecuenta ;

end foreach;

end procedure;

CREATE PROCEDURE "imtorre".calc_tmppredpresc1()

define v_cvecuenta int; 
define v_impuesto money(12,2) ;
define v_recargos money(12,2) ;


foreach
select  a.cvecuenta , nvl(sum(a.impfac),0), nvl(sum(a.recfac),0) 
   into v_cvecuenta , v_impuesto , v_recargos 
         from catastro_gdl:detsaldos a, catastro_gdl:convcta b 
         where a.axosal < 2007  and  a.cvecuenta = b.cvecuenta and b.urbrus = 'R' 
               and b.vigente ='V' and a.saldo > 10
          group by 1

update tm_rezagopred set impto_presc = v_impuesto , recgo_presc = v_recargos
       where cvecuenta = v_cvecuenta ;

end foreach;

end procedure;

CREATE PROCEDURE "pgmoreno".cg_ins_movs (par_Id_poliza Integer, 
				par_cta_aplic Integer, par_origen smallint, 
				par_cta_mayor CHAR(4), par_cta_sub01 CHAR(2), par_cta_sub02 CHAR(4), par_cta_sub03 CHAR(5), par_cta_sub04 CHAR(5), 
				par_cargo MONEY(16,2), par_abono MONEY(16,2), par_id_registro Integer, 
				par_periodo CHAR(30), par_conc CHAR(80))

                   insert into cg_poliza_movimientos values
                          ( 0, par_Id_poliza, par_cta_aplic, par_origen, par_cta_mayor, par_cta_sub01, par_cta_sub02, par_cta_sub03, par_cta_sub04, 
		par_cargo, par_abono, par_id_registro, par_periodo, par_conc, 'A', Null, Null );

end procedure;

CREATE PROCEDURE "pgmoreno".cg_upd_movs (par_Id_poliza Integer, par_control Integer)

               update cg_poliza_movimientos set
                 clave = 'B',
                 autorizo_baja = user,
                 fecha_hora_baja = Today
               where id_poliza = par_Id_poliza and control = par_control;

end procedure;

CREATE PROCEDURE "informix".cajero_ctrorec_abc ( p_IdCentro int, p_Reca int, p_Nombre Char(100), p_Domicilio Char(100), p_EntreCalles Char(100), 
                                                                         p_Horario Char(100), p_Telefonos Char(50), p_CveCatastral Char(15), p_Conexion Char(15), p_Cajas int, p_Ip_Fija Char(1), p_Opcion Char(1) )

if p_Opcion = 'A' then
              INSERT INTO ta_12_centrosrecaud VALUES
                               ( p_IdCentro, p_Reca, p_Nombre, p_Domicilio, p_EntreCalles, 
                                p_Horario, p_Telefonos, p_CveCatastral, p_Conexion, p_Cajas, p_Ip_Fija );
end if;

if p_Opcion = 'B' then
              DELETE FROM ta_12_centrosrecaud where id_centro = p_IdCentro and id_recaudora = p_Reca;
end if;

if p_Opcion = 'C' then
              UPDATE ta_12_centrosrecaud SET
                               nombre = p_Nombre,
                               domicilio = p_Domicilio,
                               domicilio2 = p_EntreCalles,
                               horario = p_Horario,
                               telefonos = p_Telefonos,
                               cvecatastral = p_CveCatastral,
                               conexion = p_Conexion,
                               cajas = p_Cajas,
                               ip_fija = p_Ip_Fija
                   where id_centro = p_IdCentro and id_recaudora = p_Reca;
end if;

end procedure;

CREATE PROCEDURE "saranda".cg_ins_ajuste (par_poliza Integer, par_fecha date, par_cta Integer, par_impte MONEY,par_usua int)
                

                INSERT INTO ta_12_ajustes(fecha_ajuste, cta_aplicacion, control_id, 
            importe_ajuste, fecha_actualiza, usuario, id_poliza) 
               values    (par_fecha, par_cta, 0, par_impte, today, par_usua, par_poliza);

end procedure;

CREATE PROCEDURE "saranda".cg_borra_ajuste (par_poliza Integer)
                

               delete from ta_12_ajustes
                where id_poliza= par_poliza;

end procedure;

CREATE PROCEDURE "informix".sp_maq_eventos(p_hostname CHAR(256),p_ip CHAR(25),p_usuario_intento CHAR(50), p_usuario_win CHAR(50),p_mac varchar(255))
{######################################################################
#  Procedimiento:    sp_maq_eventos
#  Descripcion:      Registra los eventos o intentos de logeo en modulos
#
#  Parametros        p_hostname          = nombre de la maquina
#  de entrada:       p_ip        = ip de la maquina
#                    p_usuario_intento = usuario de informix con el que intentan entrar
#                    p_usuario_win = usuario de windows
#		     p_mac =mac adress de la maquina	
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            06 Dicienbre 2012   
#
#  Llamado por:            
#  Llama a:          security:sp_maq_eventos 
#  
######################################################################}

execute PROCEDURE security:"informix".sp_maq_eventos(p_hostname,p_ip,p_usuario_intento,p_usuario_win,p_mac);

END PROCEDURE
;

CREATE PROCEDURE "informix".sp_cg_pres_aseo ( p_Axo integer, p_Usuario integer )

     define  v_Control_Contrato, v_Num_contrato, v_Ctrol_aseo, v_Ctrol_recolec, v_Cantidad_recolec integer;
     define  v_mes, v_ultimo_mes, v_numero, v_idpoliza, v_ctaaplica  integer;
     define  v_Fecha date;
     define  v_costo_unidad, v_importe, v_importe_total, v_importe_cont money(12,2);

     define v_cta_m11, v_cta_m21 CHAR(4);
     define v_cta_m12, v_cta_m22 CHAR(2);
     define v_cta_m13, v_cta_m23 CHAR(4);
     define v_cta_m14, v_cta_m24 CHAR(5);
     define v_cta_m15, v_cta_m25 CHAR(5);

     SELECT B.cta_aplicacion, B.cta_m11, B.cta_m12, B.cta_m13, B.cta_m14, B.cta_m15,     B.cta_m21, B.cta_m22, B.cta_m23, B.cta_m24, B.cta_m25
          INTO v_ctaaplica,         v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15,  v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25
          FROM TA_16_TIPO_ASEO a,ta_12_cuentasmci b 
          WHERE a.ctrol_aseo = 9 AND b.cta_aplicacion=a.cta_aplicacion AND b.momentos = 10 AND b.vigencia = 'V';

     SELECT max(numero) into v_numero FROM cg_polizas WHERE ejercicio = p_axo AND mes = 1 AND tipo =3 ;
                if v_numero is null then
                let v_numero = 0;
                end if;
                let v_numero = v_numero +1;

                insert into cg_polizas ( id_poliza , ejercicio , mes , tipo , numero , fecha ,id_modulo ,
                               id_proceso, id_rec , concepto , concepto_gral, clave ,  capturo , tipo_proceso)
                values (0, p_Axo, 1, 3, v_numero, today, 16,1, 9, 'PRESUPUESTO INICIAL '|| p_Axo,'ejecucion del proceso sp_cg_pres_aseo', 'A', user , 'A');
                LET v_idpoliza = dbinfo("sqlca.sqlerrd1");

                Let v_Control_Contrato = 0;
                Let v_Num_contrato = 0;
                Let v_Ctrol_aseo = 0;
                Let v_Ctrol_recolec = 0;
                Let v_Cantidad_recolec = 0;
                Let v_costo_unidad = 0;

                Let v_importe_cont = 0;
                Let v_importe_total = 0;
     FOREACH
                Select a.Control_Contrato, a.Num_contrato, a.Ctrol_aseo, a.Ctrol_recolec, a.Cantidad_recolec, c.costo_unidad
                    Into v_Control_Contrato, v_Num_contrato, v_Ctrol_aseo, v_Ctrol_recolec, v_Cantidad_recolec, v_costo_unidad
                From ta_16_contratos a, ta_16_unidades b, ta_16_unidades c 
                Where a.Status_vigencia = "V" 
                And b.Ctrol_recolec = a.Ctrol_recolec And c.Cve_Recolec = b.Cve_Recolec 
                And c.Ejercicio_Recolec = p_Axo
                Order By a.Ctrol_aseo, a.Num_contrato 

                Let v_mes = 1;
                Let v_ultimo_mes = 12;
                Let v_importe = v_Cantidad_recolec * v_costo_unidad;
                FOR v_mes = 1 to v_ultimo_mes
                                Let v_Fecha = mdy(v_mes,01,p_Axo);
                               Insert into ta_16_Pagos values
                                               ( v_Control_Contrato, v_Fecha, 6, v_importe, 'V', Null, 0, Null, 0, Null, p_Usuario, v_Cantidad_recolec);
                Let v_importe_cont = v_importe_cont + v_importe;
                Let v_importe_total = v_importe_total + v_importe;
                END FOR;

                insert into cg_poliza_movimientos (
                               control, id_poliza, cta_aplicacion, cta_mayor, cta_sub01, cta_sub02, cta_sub03, 
                               cta_sub04 ,  cargo, abono ,id_registro , periodo,  concepto)
                values (0, v_idpoliza, v_ctaaplica, v_cta_m11, v_cta_m12, v_cta_m13, v_cta_m14, v_cta_m15, 
                            v_importe_cont, 0, v_Control_Contrato, 'Del 1 al 12 del '|| p_Axo  , 'Presupuesto inicial de Aseo '|| p_Axo) ;

                Let v_importe_cont = 0;  -- DESPUES DE HABER GRABADO EL REGISTRO DEL CONTRATO DEJAR IMPORTE EN CEROS

     END FOREACH;
                insert into cg_poliza_movimientos (
                               control, id_poliza, cta_aplicacion, cta_mayor, cta_sub01, cta_sub02, cta_sub03, 
                               cta_sub04 ,  cargo, abono ,id_registro , periodo,  concepto)
                values (0, v_idpoliza, v_ctaaplica, v_cta_m21, v_cta_m22, v_cta_m23, v_cta_m24, v_cta_m25, 
                                0, v_importe_total, v_Control_Contrato, 'Del 1 al 12 del '|| p_Axo  , 'Presupuesto inicial de Aseo '|| p_Axo) ;

                Let v_importe_total = 0;  -- DESPUES DE HABER GRABADO EL REGISTRO DE LA SUMA FINAL DE CONTRATOS

END procedure;

CREATE PROCEDURE "saranda".spd_12_estadistica2010(
                                                    par_fecha   date,
                                                    par_f1         date,
                                                    par_f2          date,
                                                    par_axom    integer,
                                                    par_axom1  integer,
                                                    par_usuario integer,
                                                    par_ip char(20))
define    v_titulo smallint;
define    v_capitulo char(02);
define    v_cta_aplicacion integer;
define    v_descripcion VARCHAR(60,0);
define    v_impte_dia money(15, 2);
define    v_doc_dia INTeger;
define    v_impte_mes money(15, 2);
define    v_doc_mes INTeger;
define    v_impte_ax money(15, 2);
define    v_doc_ax INTeger;

delete from ta_12_estadisticas where (fecha_act<today) or 
 (fecha_act=today and host_ip=par_ip); 

foreach
   SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion, 
                  sum(a.importe_cta),sum(a.documento)
   into         v_titulo,v_capitulo,v_cta_aplicacion,v_descripcion,v_impte_dia,v_doc_dia  
   from        ta_12_importes a , ta_12_cuentas b
   where     a.fecing=par_fecha and a.cta_aplicacion=b.cta_aplicacion 
   group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

   if not exists( select * from ta_12_estadisticas
                       where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion) then
          insert into ta_12_estadisticas  values( par_fecha,v_titulo,v_capitulo,v_cta_aplicacion, v_descripcion, v_impte_dia, v_doc_dia,0,0,0,0,today,par_usuario,par_ip);
   else
          update ta_12_estadisticas set   impte_diario=v_impte_dia,doc_diario=v_doc_dia
          where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion;
       end if; 
end foreach;

foreach
   SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion,sum(a.importe_cta),sum(trunc(a.documento)) 
   into         v_titulo,v_capitulo,v_cta_aplicacion,v_descripcion,v_impte_mes,v_doc_mes  
   from        ta_12_importes a , ta_12_cuentas b
   where a.fecing between par_f1 and par_f2 
             and a.fecing<=par_fecha and a.cta_aplicacion=b.cta_aplicacion 
   group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

   if not exists( select * from ta_12_estadisticas
                       where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion) then
          insert into ta_12_estadisticas  values( par_fecha,v_titulo,v_capitulo,v_cta_aplicacion, v_descripcion,0,0, v_impte_mes, v_doc_mes,0,0,today,par_usuario,par_ip);
   else
          update ta_12_estadisticas set   impte_mensual=v_impte_mes,doc_mensual=v_doc_mes
          where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion;
       end if; 
end foreach;

foreach
   SELECT b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion,sum(a.importe),sum(a.numero_doctos)  
   into         v_titulo,v_capitulo,v_cta_aplicacion,v_descripcion,v_impte_ax,v_doc_ax  
   from        ta_12_ingresoanual a , ta_12_cuentas b
   where a.axo_mes>=par_axom  and a.axo_mes<par_axom1 and a.cta_aplicacion=b.cta_aplicacion
   group by b.titulo, b.capitulo, b.cta_aplicacion, b.descripcion 

   if not exists( select * from ta_12_estadisticas
                       where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion) then
          insert into ta_12_estadisticas  values( par_fecha,v_titulo,v_capitulo,v_cta_aplicacion, v_descripcion,0,0,0,0, v_impte_ax, v_doc_ax,today,par_usuario,par_ip);
   else
          update ta_12_estadisticas set   impte_anual=v_impte_ax,doc_anual=v_doc_ax
          where fecha=par_fecha and titulo=v_titulo and capitulo=v_capitulo and cta_aplicacion = v_cta_aplicacion;
       end if; 
end foreach;


end procedure;

create procedure  "informix".sp_cg_devengo_predu(p_axo integer, p_bim integer, CTA1 INTEGER, CTA2 INTEGER)
    
 define    cgo_mayor CHAR(4) ;
 define    cgo_sub01 CHAR(2) ;
 define    cgo_sub02 CHAR(4) ;
 define    cgo_sub03 CHAR(5) ;
 define    cgo_sub04 CHAR(5) ;
 define    abo_mayor CHAR(4) ;
 define    abo_sub01 CHAR(2) ;
 define    abo_sub02 CHAR(4) ;
 define    abo_sub03 CHAR(5) ;
 define    abo_sub04 CHAR(5) ;
-- modulo 5
-- proceso 3 generacion de recargos
define v_numero int;
define v_idpoliza int;
define v_impuesto money(16,2);
define v_recargos money(16,2);
define v_cvecuenta integer;
define v_tot_impuesto money(16,2);
define v_bim integer;
define v_porcrecar DECIMAL(5,2);
define v_tot_recargos money(16,2);
define v_ctaaplica integer;
define v_cta_pred char(11);
let v_ctaaplica = 110220000;
let v_tot_impuesto = 0;
let v_tot_recargos = 0;

select max(numero) into v_numero from cg_polizas where ejercicio = p_axo and mes = month(today) and tipo = 3 ;
if v_numero is null then
   let v_numero = 0;
end if;
let v_numero = v_numero + 1;
insert into cg_polizas ( id_poliza , ejercicio , mes , tipo , numero , fecha ,id_modulo ,
    id_proceso, id_rec , concepto , concepto_gral, clave ,  capturo , tipo_proceso)
values (0, p_axo, month(today), 3, v_numero, today, 5,4, 9, 'DEVENGADO PREDIAL DEL BIMENTRE'|| p_bim ,'ejecucion del proceso sp_cg_devengo_pred', 'A', user , 'A');
LET v_idpoliza = dbinfo("sqlca.sqlerrd1");
-- leer el momento contable para recargos. Predial Rustico.
select cta_m11 , cta_m12 , cta_m13 , cta_m14 , cta_m15 , cta_m21 , cta_m22 , cta_m23 , cta_m24 , cta_m25
into cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,   abo_mayor 
,   abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 
 from ta_12_cuentasmci where cta_aplicacion =  v_ctaaplica and momentos = 1 and vigencia = 'V';


---  insertar cada registro por cuenta al impuesto.
FOREACH 

   select  a.cvecuenta , sum(a.impfac) into v_cvecuenta ,v_impuesto
         from catastro_gdl:detsaldos a, catastro_gdl:convcta b 
         where a.CVECUENTA BETWEEN CTA1 AND CTA2 AND a.axosal = p_axo and a.bimsal = p_bim  and a.saldo > 0 and a.imppag =0 and
         a.cvecuenta = b.cvecuenta and urbrus = 'U' and vigente ='V'
          group by 1
 select recaud || '-' || urbrus || '-' || cuenta into v_cta_pred from catastro_gdl:convcta where cvecuenta = v_cvecuenta;
 insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
  values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
   v_impuesto , 0, v_cvecuenta , 'Bim '|| p_bim  , 'Devengado Urbano :'|| v_cta_pred ) ;   
  let v_tot_impuesto = v_tot_impuesto + v_impuesto;
END FOREACH;

insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono , id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
   0, v_tot_impuesto , 0, 'Bim '|| p_bim  , 'Devengado Urbano') ;
---  insertar momento 3  para cuentas por cobrar y nada

select cta_m11 , cta_m12 , cta_m13 , cta_m14 , cta_m15 , cta_m21 , cta_m22 , cta_m23 , cta_m24 , cta_m25
into cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,   abo_mayor 
,   abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 
 from ta_12_cuentasmci where cta_aplicacion =  v_ctaaplica and momentos = 3 and vigencia = 'V';

 insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
  values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
   v_tot_impuesto , 0, 0 ,  'Bim '|| p_bim  , 'Devengado Urbano' ) ;   

insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono , id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
   0, v_tot_impuesto , 0, 'Bim '|| p_bim  , 'Devengado Urbano') ;


end procedure
;

create procedure  "informix".sp_cg_devengo_predr(p_axo integer, p_bim integer)
    
 define    cgo_mayor CHAR(4) ;
 define    cgo_sub01 CHAR(2) ;
 define    cgo_sub02 CHAR(4) ;
 define    cgo_sub03 CHAR(5) ;
 define    cgo_sub04 CHAR(5) ;
 define    abo_mayor CHAR(4) ;
 define    abo_sub01 CHAR(2) ;
 define    abo_sub02 CHAR(4) ;
 define    abo_sub03 CHAR(5) ;
 define    abo_sub04 CHAR(5) ;
-- modulo 5
-- proceso 3 generacion de recargos
define v_numero int;
define v_idpoliza int;
define v_impuesto money(16,2);
define v_recargos money(16,2);
define v_cvecuenta integer;
define v_tot_impuesto money(16,2);
define v_bim integer;
define v_porcrecar DECIMAL(5,2);
define v_tot_recargos money(16,2);
define v_ctaaplica integer;
define v_cta_pred char(11);
let v_ctaaplica = 110220000;
let v_tot_impuesto = 0;
let v_tot_recargos = 0;

select max(numero) into v_numero from cg_polizas where ejercicio = p_axo and mes = month(today) and tipo = 3 ;
if v_numero is null then
   let v_numero = 0;
end if;
let v_numero = v_numero + 1;
insert into cg_polizas ( id_poliza , ejercicio , mes , tipo , numero , fecha ,id_modulo ,
    id_proceso, id_rec , concepto , concepto_gral, clave ,  capturo , tipo_proceso)
values (0, p_axo, month(today), 3, v_numero, today, 5,4, 9, 'DEVENGADO PREDIAL DEL BIMENTRE'|| p_bim ,'ejecucion del proceso sp_cg_devengo_pred', 'A', user , 'A');
LET v_idpoliza = dbinfo("sqlca.sqlerrd1");
-- leer el momento contable para recargos. Predial Rustico.
select cta_m11 , cta_m12 , cta_m13 , cta_m14 , cta_m15 , cta_m21 , cta_m22 , cta_m23 , cta_m24 , cta_m25
into cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,   abo_mayor 
,   abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 
 from ta_12_cuentasmci where cta_aplicacion =  v_ctaaplica and momentos = 1 and vigencia = 'V' ;




---  insertar cada registro por cuenta al impuesto.
FOREACH 

   select  a.cvecuenta , sum(a.impfac) into v_cvecuenta ,v_impuesto
         from catastro_gdl:detsaldos a, catastro_gdl:convcta b 
         where a.axosal = p_axo and a.bimsal = p_bim and a.saldo > 0 and a.imppag =0 and a.cvecuenta = b.cvecuenta and urbrus = 'R' and vigente ='V'
          group by 1
  select recaud || '-' || urbrus || '-' || cuenta into v_cta_pred from catastro_gdl:convcta where cvecuenta = v_cvecuenta;

 insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
  values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
   v_impuesto , 0, v_cvecuenta , 'Bim '|| p_bim  , 'Devengado Rustico' ) ;   
  let v_tot_impuesto = v_tot_impuesto + v_impuesto;
END FOREACH;

insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono , id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
   0, v_tot_impuesto , 0, 'Bim '|| p_bim  , 'Devengado Rustico:'|| v_cta_pred) ;
---  insertar momento 3  para cuentas por cobrar y nada

select cta_m11 , cta_m12 , cta_m13 , cta_m14 , cta_m15 , cta_m21 , cta_m22 , cta_m23 , cta_m24 , cta_m25
into cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,   abo_mayor 
,   abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 
 from ta_12_cuentasmci where cta_aplicacion =  v_ctaaplica and momentos = 3 and vigencia = 'V' ;

 insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono, id_registro , periodo ,  concepto)
  values (0, v_idpoliza , v_ctaaplica , cgo_mayor ,   cgo_sub01 ,cgo_sub02  , cgo_sub03 ,   cgo_sub04 ,
   v_tot_impuesto , 0, 0 ,  'Bim '|| p_bim  , 'Devengado Rustico' ) ;   

insert into cg_poliza_movimientos (
    control,  id_poliza  ,  cta_aplicacion , cta_mayor , cta_sub01 , cta_sub02 , cta_sub03 ,
    cta_sub04 ,  cargo, abono , id_registro , periodo,  concepto)
values (0, v_idpoliza , v_ctaaplica , abo_mayor, abo_sub01 ,  abo_sub02 ,   abo_sub03,    abo_sub04 ,
   0, v_tot_impuesto , 0, 'Bim '|| p_bim  , 'Devengado Rustico') ;


end procedure
;

CREATE PROCEDURE "informix".upd34_rade_01 ( par_id_34_pagos Integer, par_Fecha Date, par_Id_Rec Integer, par_Caja Char(2), 
                                                               par_Consec Integer, par_Folio_rcbo Char(15), par_status Char(1) )

define v_id_34_stat                                                                     Integer;

--************************************************************************ STATUS
SELECT id_34_stat INTO v_id_34_stat from t34_status where cve_tab = 'E' and cve_stat = par_status;
--************************************************************************

                UPDATE t34_pagos SET
                               fecha_hora_pago = par_Fecha,
                               id_recaudadora = par_Id_Rec,
                               caja = par_Caja,
                               operacion = par_Consec,
                               folio_recibo = par_Folio_rcbo,
                               usuario = user,
                               id_stat = v_id_34_stat
                WHERE id_34_pagos = par_id_34_pagos;

end procedure;

CREATE PROCEDURE "informix".paso11_a_34 (par_letra Char(1) )

  define v_id_local, v_local, v_Axo, v_Periodo, v_id_34_datos, v_oficina_pago, v_operacion_pago		Integer;
  define v_letra_local									Char(1);
  define v_Control										Char(10);
  define v_nombre										VarChar(60);
  define v_arrendatario									VarChar(30);
  define v_domicilio										VarChar(40);
  define v_superficie										Decimal(7,2);
  define v_Importe, v_importe_pago								Money(12,2);
  define v_fecha_alta, v_fecha_baja, v_fecha_pago						Date;
  define v_id_licencia, v_licencia, v_id_34_stat_datos, v_id_34_stat_pagos, v_id_34_stat_adic, v_id_34_stat_pagos_p, v_clave_cuota		Integer;
  define v_caja_pago									Char(2);

  Let v_id_local = 0;
  Let v_local = 0;
  Let v_Control = '';
  Let v_nombre = '';
  Let v_arrendatario = '';
  Let v_domicilio = '';
  Let v_superficie = 0;
  Let v_Axo = 0;
  Let v_Periodo = 0;
  Let v_Importe = 0;
  Let v_clave_cuota = 0;

  Let v_id_licencia = 0;
  Let v_licencia = 0;
  Let v_id_34_stat_datos = 0;
  Let v_id_34_stat_pagos = 0;
  Let v_id_34_stat_adic = 0;
  Let v_id_34_stat_pagos_p = 0;

  Let v_oficina_pago = 0;
  Let v_caja_pago = '';
  Let v_operacion_pago = 0;
  Let v_importe_pago = 0;


	select id_34_stat into v_id_34_stat_datos from t34_status where cve_tab = '3' and cve_stat = 'V';
	select id_34_stat into v_id_34_stat_pagos from t34_status where cve_tab = 'E' and cve_stat = 'V';
	select id_34_stat into v_id_34_stat_pagos_p from t34_status where cve_tab = 'E' and cve_stat = 'P';
	select id_34_stat into v_id_34_stat_adic from t34_status where cve_tab = 'C' and cve_stat = 'V';

FOREACH
                SELECT id_local, local, letra_local, nombre, arrendatario, 'RASTRO MPAL. DE GDL.', superficie, fecha_alta, fecha_baja, clave_cuota
		INTO v_id_local, v_local, v_letra_local, v_nombre, v_arrendatario, v_domicilio, v_superficie, v_fecha_alta, v_fecha_baja, v_clave_cuota
		FROM ta_11_locales
		WHERE num_mercado = 90
		ORDER BY id_local

		Let v_id_licencia = 0;
		SELECT id_licencia INTO v_id_licencia FROM ta_11_licencias where id_local = v_id_local;
		if v_id_licencia > 0 then
			SELECT licencia INTO v_licencia FROM catastro_gdl:licencias WHERE  id_licencia = v_id_licencia;
		end if;

	if v_letra_local <> '' then
		Let v_Control = v_local || '-' || v_letra_local;
	else
		Let v_Control = v_local;
	end if;
 	if v_clave_cuota = 16 then
		Let v_clave_cuota = 1;
	else
		Let v_clave_cuota = 2;
	end if;

	if v_fecha_baja > 0 then
		insert into t34_datos values (0,3,v_Control, v_nombre, v_domicilio, v_superficie, v_fecha_alta, v_fecha_baja,  5, 'J', 7,  
						v_licencia, user,Today, Null, v_clave_cuota, v_id_34_stat_datos );
	else
		insert into t34_datos values (0,3,v_Control, v_nombre, v_domicilio, v_superficie, v_fecha_alta, Null,  5, 'J', 7,  
						v_licencia, user,Today, Null, v_clave_cuota, v_id_34_stat_datos );
	LET v_id_34_datos = dbinfo("sqlca.sqlerrd1");
	end if;

	insert into t34_adicionales values (0, v_id_34_datos, '1', 'SS', Null, user, v_id_34_stat_adic);

	FOREACH
		SELECT Axo, Periodo, Importe  INTO v_Axo, v_Periodo, v_Importe
			FROM ta_11_adeudo_local    WHERE id_local = v_id_local

			insert into t34_pagos values ( 0, v_id_34_datos, mdy(v_Periodo,01,v_Axo), v_Importe, 0, Null, 0, Null, 0, Null, user, v_id_34_stat_pagos );
	END FOREACH;
	FOREACH
		SELECT Axo, Periodo, fecha_pago, oficina_pago, caja_pago, operacion_pago, importe_pago  
			INTO v_Axo, v_Periodo, v_fecha_pago, v_oficina_pago, v_caja_pago, v_operacion_pago, v_importe_pago
			FROM ta_11_pagos_local    WHERE id_local = v_id_local

			insert into t34_pagos values ( 0, v_id_34_datos, mdy(v_Periodo,01,v_Axo), v_importe_pago, 0, 
				v_fecha_pago, v_oficina_pago, v_caja_pago, v_operacion_pago, Null, user, v_id_34_stat_pagos_p );
	END FOREACH;


END FOREACH;
end procedure;

create procedure "informix".ldopercaja_auto()
  --  RETURNING int as id_modulo , char(30) as descripcion, int as operaciones,   money(16,2) as importe ,   datetime year to fraction(3) as fecha;
 define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_contfecha int;
define v_fechatime datetime year to fraction(3) ;
define contar int;
define v_fecha date;

  for contar = 5 to 1 step -1
  
     let v_fecha = today - contar;
   
   foreach 
     select x0.id_modulo ,x1.descripcion ,count(*) ,sum(x0.importe ) , CURRENT year to fraction(3) 
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
     from ta_12_recibos x0 , ta_12_moduloscat x1 
     where (((x0.fecha = v_fecha ) AND (x0.cvepago = 'P' ) ) AND (x1.id_modulo = x0.id_modulo ) ) and x0.id_modulo <> 15
     group by x0.id_modulo ,   x1.descripcion 
    let v_contfecha = 0;
    select count(*) into v_contfecha from   ta12_ingrexmodulo where modulo = v_id_modulo and fecha = v_fecha ;
     if v_contfecha > 0 then

       update ta12_ingrexmodulo set operaciones = v_cantidad, importe = v_importe,  fecha_act = current 
       where modulo = v_id_modulo and fecha = v_fecha;

    else
     insert into ta12_ingrexmodulo (modulo,  fecha , operaciones, importe,  fecha_act) 
    values (v_id_modulo , v_fecha, v_cantidad , v_importe , v_fechatime);
    end if;
   -- return  v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime with resume;
    end foreach;
   end for;

 
end procedure;

CREATE PROCEDURE "saranda".spd_adeudos_rcm1 ()

define v_control integer;
define v_axo integer;
define v_importe money;
define v_recargos money;

foreach

  select control_rcm into v_control from ta_13_datosrcm where  vigencia='V' 

  insert into ta_13_adeudosrcm values( 0,v_control,2014,390, 0,0,0,'V',2,today,null);


end foreach;
end procedure;

create procedure "informix".ldopercajaint(p_fecha date) 
   define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_contfecha int;
define v_fechatime datetime year to fraction(3) ;

     foreach 
     select x0.id_modulo ,x1.descripcion ,count(*) ,sum(x0.importe ) , CURRENT year to fraction(3) 
     into     v_id_modulo , v_descripcion , v_cantidad , v_importe, v_fechatime   
     from ta_12_recibos x0 , ta_12_moduloscat x1 
     where (((x0.fecha = p_fecha ) AND (x0.cvepago = 'P' ) ) AND (x1.id_modulo = x0.id_modulo ) ) and x0.id_modulo <> 15
     group by x0.id_modulo ,   x1.descripcion 
    let v_contfecha = 0;
    select count(*) into v_contfecha from   ta12_ingrexmodulo where modulo = v_id_modulo and fecha = p_fecha ;
     if v_contfecha > 0 then

       update ta12_ingrexmodulo set operaciones = v_cantidad, importe = v_importe,  fecha_act = today
       where modulo = v_id_modulo and fecha = p_fecha;

    else
     insert into ta12_ingrexmodulo (modulo,  fecha , operaciones, importe,  fecha_act) 
    values (v_id_modulo , p_fecha, v_cantidad , v_importe , v_fechatime);
    end if;
 
    end foreach

 
end procedure;

CREATE procedure "saranda".spd_12_actualtodasctas2014()
    
define v_m11, v_m21,v_m13,v_m23    char(4);
define v_m12, v_m22   char(2);
define v_m14, v_m15,v_m24,v_m25   char(5);
define v_cta, v_ori   int;
define v_des          varchar(50);
define v_xcob, v_pre, v_xeje, v_mod, v_dev, v_rec         varchar(24);

foreach
  SELECT cta_aplicacion, cta_mayor, cta_sub01, cta_sub02, cta_sub03, cta_sub04 
  into   v_cta, v_m11,v_m12,v_m13,v_m14,v_m15  
  FROM cg_12_cuentas2014
  if exists(select * from cg_12_cuentas where cta_aplicacion=v_cta and vigencia <>'B') then
     update cg_12_cuentas set cta_mayor=v_m11, cta_sub01=v_m12, cta_sub02=v_m13, cta_sub03=v_m14, cta_sub04=v_m15
     ,fecha_act=today,usuario=242
     where cta_aplicacion=v_cta ;
  end if;
end foreach;
foreach
  SELECT cta_aplicacion, momentos, cta_m11, cta_m12, cta_m13, cta_m14, cta_m15, cta_m21, cta_m22, cta_m23, cta_m24, cta_m25
  into   v_cta, v_ori, v_m11, v_m12,v_m13, v_m14, v_m15, v_m21, v_m22,v_m23, v_m24, v_m25
  FROM cg_12_cuentasmci2014
  if exists(select * from ta_12_cuentasmci where cta_aplicacion=v_cta and vigencia ='V' and momentos=v_ori) then
     update ta_12_cuentasmci set cta_m11=v_m11, cta_m12=v_m12, cta_m13=v_m13, cta_m14=v_m14, cta_m15=v_m15,
     cta_m21=v_m21, cta_m22=v_m22, cta_m23=v_m23, cta_m24=v_m24, cta_m25=v_m25,fecha_act=today,usuario=242  
     where cta_aplicacion=v_cta and momentos=v_ori;
  end if;
end foreach;
end procedure;

CREATE procedure "saranda".spd_12_actualdeudctas2014()
    
define v_m11, v_m21,v_m13,v_m23    char(4);
define v_m12, v_m22   char(2);
define v_m14, v_m15,v_m24,v_m25   char(5);
define v_cta, v_ori   int;
define v_des          varchar(50);
define v_xcob, v_pre, v_xeje, v_mod, v_dev, v_rec         varchar(24);
define v_nom varchar(60);
foreach

  SELECT cta_mayor, cta_sub01, cta_sub02, cta_sub03, cta_sub04, nombre,
 (case when cta_mayorn='' then '0000' else cta_mayorn end),
 (case when cta_sub01n='' then '00' else cta_sub01n end), (case when cta_sub02n='' then '0000' else cta_sub02n end), 
 (case when cta_sub03n='' then '00000' else cta_sub03n end), (case when cta_sub04n='' then '00000' else cta_sub04n end) 
  into   v_m11,v_m12,v_m13,v_m14,v_m15,v_nom, v_m21,v_m22,v_m23,v_m24,v_m25  
    FROM cg_12_deudores2014

  if exists(select * from cg_12_deudores where cta_mayor=v_m11 and cta_sub01=v_m12 and cta_sub02=v_m13 and
     cta_sub03=v_m14 and cta_sub04=v_m15 and nombre=v_nom and vigencia <>'B') then
     update cg_12_deudores set cta_mayor=v_m21, cta_sub01=v_m22, cta_sub02=v_m23, cta_sub03=v_m24, cta_sub04=v_m25
     ,fecha_act=today,usuario=242
     where cta_mayor=v_m11 and cta_sub01=v_m12 and cta_sub02=v_m13 and
     cta_sub03=v_m14 and cta_sub04=v_m15 and nombre=v_nom ;
  end if;
end foreach;
end procedure;

CREATE PROCEDURE "informix".ld_cargaingresos(p_axo int , p_mes int)

-----------Define las variables de retorno----------------

define v_titulo 	int;
define v_capitulo 	int;
define v_cta_aplic	int;
define v_importe money(15,2);
define v_contreg int;
FOREACH
SELECT  b.titulo, b.capitulo, b.cta_aplicacion , nvl (sum(a.importe_cta),0) 
into   v_titulo ,v_capitulo ,v_cta_aplic , v_importe
from cg_12_importes a , cg_12_cuentas b 
where a.cta_aplicacion=b.cta_aplicacion  
and year(a.fecing) = p_axo and month(a.fecing) = p_mes
group by 1,2,3

--verificar registros nivel afectable cuenta de aplicacion
   select count(*) into v_contreg from   ta_pres_dev_ing where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
     if v_contreg =  0 then
        insert into  ta_pres_dev_ing (ejercicio,  titulo , capitulo, cta_aplicacion,  fecha_ingreso_mod) 
        values (p_axo ,v_titulo , v_capitulo, v_cta_aplic , today);
    end if;
--verificar registros nivel afectable capitulo
   select count(*) into v_contreg from   ta_pres_dev_ing where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
     if v_contreg =  0 then
        insert into  ta_pres_dev_ing (ejercicio,  titulo , capitulo,cta_aplicacion,  fecha_ingreso_mod) 
        values (p_axo ,v_titulo , v_capitulo, 0 , today);
    end if;
--verificar registros nivel afectable titulo
   select count(*) into v_contreg from   ta_pres_dev_ing where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
     if v_contreg =  0 then
        insert into  ta_pres_dev_ing (ejercicio,  titulo , capitulo,cta_aplicacion,  fecha_ingreso_mod) 
        values (p_axo ,v_titulo , 0, 0 , today);
    end if;

-- cargar el dato.
 if p_mes = 01 then
    update ta_pres_dev_ing set ingreso_01 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_01 = ingreso_01 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_01 = ingreso_01 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 02 then
    update ta_pres_dev_ing set ingreso_02 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_02 = ingreso_02 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_02 = ingreso_02 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 03 then
    update ta_pres_dev_ing set ingreso_03 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_03 = ingreso_03 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_03 = ingreso_03 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 04 then
    update ta_pres_dev_ing set ingreso_04 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_04 = ingreso_04 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_04 = ingreso_04 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
if p_mes = 05 then
    update ta_pres_dev_ing set ingreso_05 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_05 = ingreso_05 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_05 = ingreso_05 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 06 then
    update ta_pres_dev_ing set ingreso_06 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_06 = ingreso_06 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_06 = ingreso_06 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 07 then
    update ta_pres_dev_ing set ingreso_07 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_07 = ingreso_07 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_07 = ingreso_07 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 08 then
    update ta_pres_dev_ing set ingreso_08 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_08 = ingreso_08 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_08 = ingreso_08 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
if p_mes = 09 then
    update ta_pres_dev_ing set ingreso_09 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_09 = ingreso_09 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_09 = ingreso_09 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 10 then
    update ta_pres_dev_ing set ingreso_10 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_10 = ingreso_10 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_10 = ingreso_10 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 11 then
    update ta_pres_dev_ing set ingreso_11 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_11 = ingreso_11 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_11 = ingreso_11 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;
 if p_mes = 12 then
    update ta_pres_dev_ing set ingreso_12 = v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = v_cta_aplic ;
    update ta_pres_dev_ing set ingreso_12 = ingreso_12 + v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = v_capitulo and cta_aplicacion = 0 ;
    update ta_pres_dev_ing set ingreso_12 = ingreso_12 +  v_importe where ejercicio = p_axo and
      titulo = v_titulo and capitulo = 0 and cta_aplicacion = 0 ;
  end if;

end FOREACH;
end procedure
;

CREATE PROCEDURE "saranda".spd_13_recarmasiv(v_controld int, v_controlh int)                           

define v_mes       smallint;
define v_parcial   int;
define v_axo       int;
define v_axoade       int;
define v_control       int;
define v_importe            money(15,2);
define v_impterec          money(15,2);

let v_mes=month(today);
let v_axo=year(today);
--let v_mes=01;
--let v_axo=2012;
select porcentaje_parcial into v_parcial from ta_13_recargosrcm where axo=v_axo  and mes=v_mes;

if exists(select * from ta_13_recargosrcm where axo=v_axo and mes=v_mes) then
   foreach
     select control_rcm, axo_adeudo, (importe - nvl((descto_impote),0)) into v_control, v_axoade, v_importe 
     from   ta_13_adeudosrcm
     where  vigencia='V' and axo_adeudo>=2009  and control_rcm between v_controld and v_controlh

      update ta_13_adeudosrcm set importe_recargos=trunc((v_importe * (select porcentaje_global from ta_13_recargosrcm where (axo=v_axoade  and mes=v_mes))/100), 2)  
       where control_rcm=v_control and axo_adeudo= v_axoade;

 --      let v_impterec= trunc(((v_importe* v_parcial) /100),2);
--       execute procedure spd_cgmov_cement(today,13, v_control,0,v_impterec, v_axoade, 1, 0);
   end foreach;
end if;

end procedure;

create procedure "informix".ldconducta_predial(p_fecha date) 
   define v_id_modulo int;
define v_descripcion char(30)  ;
define  v_cantidad int;
define  v_importe money(16,2);
define v_contfecha int;
define v_fechatime datetime year to fraction(3) ;
define  v_cuentas int;
define  v_facturado money(16,2); define v_pagado money(16,2); define v_descuento  money(16,2);


    select count(distinct cvecuenta) , sum(impfac)  , sum(imppag)  , sum(impvir) 
    into v_cuentas , v_facturado , v_pagado , v_descuento
    from detsaldos where cvecuenta in (
    select cvecuenta from pagos where fecha = p_fecha and cveconcepto = 1 and cvecanc is null)
     and axosal = 2015 ;

    let v_contfecha = 0;
    select count(*) into v_contfecha from   conducta_predialxdia where mes = month(p_fecha) and dia = day(p_fecha) ;
    

   if v_contfecha =  0 then
      insert into conducta_predialxdia values(month(p_fecha),day(p_fecha),0,0,0,0,0,0,0,0);
   end if;

       update conducta_predialxdia set cuentas_2015 = v_cuentas, facturado_2015 = v_facturado,  pagado_2015 = v_pagado ,
       descuento_2015 = v_descuento 
       where mes = month(p_fecha) and dia = day(p_fecha) ;
---  2014
   select count(distinct cvecuenta) , sum(impfac)  , sum(imppag)  , sum(impvir) 
    into v_cuentas , v_facturado , v_pagado , v_descuento
    from detsaldos where cvecuenta in (
    select cvecuenta from pagos where fecha = mdy(month(p_fecha), day(p_fecha) , year(p_fecha) -1)
    and cveconcepto = 1 and cvecanc is null)
     and axosal = 2014 ;
    update conducta_predialxdia set cuentas_2014 = v_cuentas, facturado_2014 = v_facturado,  pagado_2014 = v_pagado ,
       descuento_2014 = v_descuento 
       where mes = month(p_fecha) and dia = day(p_fecha) ;

 
end procedure;

CREATE PROCEDURE "informix".sp_notpredbf_gast(p_reca int)
   define v_cvecuenta      int;
   define v_gasto_10  money(16,2);
 --set debug file to "buenfin.log";
 -- trace on;

  FOREACH 
   select cvecuenta into v_cvecuenta from reqbfpredial where  gastos > 0 and  vigencia = 'V'

    select sum(gasto_req) into v_gasto_10
    from reqpredial  
    where cvecuenta = v_cvecuenta and vigencia = 'V'  and fecent is not null and axoreq > 2009 ;
    if v_gasto_10 is null then
    let v_gasto_10 = 0;
    end if;
    update reqbfpredial  set gasto_10 = v_gasto_10 , gasto_req = 140.20
    where cvecuenta = v_cvecuenta and gastos > 0 and  cveejecut = 624 and vigencia = 'V';

 END FOREACH;
-- trace off;
END PROCEDURE;

CREATE PROCEDURE "informix".task_midnight()
 -- executa la actualizacion de las operaciones del ingreso para indicadores y graficas.
    execute procedure ldopercaja_auto();
  -- este procedimiento cancela los descuentos a recargos otorgados que no fueron pagados.
    execute procedure catastro_gdl:spd_bajadesctosrec();
--  la cancelaci�n de las transmisiones no pagadas de forma autom�tica " proceso requerido por Andres o Javier de Catatro"
    EXECUTE PROCEDURE  catastro_gdl:sp48_cancelvencidas();
--  se ejecuta solo los 15 de cada mes
-- AVISAR A FERMIN O ALEJANDRA o AL ENCARGADO DE LOS LOG para que queden CONTINUOS.
--  SE CREA UNA TABLE DE DIAS QUE CORREN PROCESOS ESPECIFICOS POR FECHA.
--  PROCESOS PARA PREDIAL  CALCULO DE RECARGOS
   IF (SELECT COUNT(*) FROM PROC_X_EVENTO WHERE FECHA = TODAY -1 AND ID_MODULO = 5 ) > 0 THEN 
    execute PROCEDURE catastro_gdl:taskregospredsimple();
    end if;
-- SE EJECUTA EL DIA 1 de cada mes o cuando se indique para correr los recagos de Licencias.
-- AVISAR A FERMIN O ALEJANDRA o AL ENCARGADO DE LOS LOG para que queden CONTINUOS.
  IF (SELECT COUNT(*) FROM PROC_X_EVENTO WHERE FECHA = TODAY -1 AND ID_MODULO = 9 ) > 0 THEN
     
    execute procedure catastro_gdl:taskregoslic2();
     IF MONTH(TODAY) = 2 THEN
    update catastro_gdl:parametros_web set fecha_venc = MDY( MONTH(TODAY),28,YEAR(TODAY)) , fecha_act = current where id_modulo = 9;
     ELSE 
    update catastro_gdl:parametros_web set fecha_venc = MDY( MONTH(TODAY), 30,YEAR(TODAY)), fecha_act = current where id_modulo = 9;
     END IF;
    -- solo activalrlo para 1 de mayo ya que a partir del 3 bimenstre se cobran recargos
    -- execute PROCEDURE catastro_gdl:taskregospredsimple();
  end if;
  IF (SELECT COUNT(*) FROM PROC_X_EVENTO WHERE FECHA = TODAY -1 AND ID_MODULO = 14 ) > 0 THEN
     insert into dbestacion:recargos values(year(today), month(today), 1);
  end if;

   -- ACTUALIZACION DE CATASTRO PREDIAL  INDICADORES DIARIOS.
     execute PROCEDURE catastro_gdl:cuentapublica_midnight();
   -- ACTUALIZACION DE lICENCIAS 
     execute procedure catastro_gdl:cal_ind_adeudo_axolic( month(today));
  
END PROCEDURE;

create procedure "informix".corrige_n_kiosco(p_fecha date)
define v_rowid int;

  foreach select rowid into v_rowid 
  from ta_12_recibos where fecha = p_fecha and caja in ('K1','K2','K3','K4' , 'K5','K6') and nombre like '%Ñ%'

   update ta_12_recibos set nombre = REPLACE(nombre, 'Ñ', '�') where rowid = v_rowid ;

 end foreach;
end procedure;

create procedure "informix".adeudo_carteras_indic( );

define v_axo int;
define v_mes int;
define v_merc int;
define v_desc_01 varchar(100);
define v_desc_02 varchar(100);
define v_cantidad  money(16,2);
define v_importe  money(16,2);
define t_can  money(16,2);
define t_imp money(16,2);

   let v_axo = year(today);
   let v_mes = month(today);
-- select month(today) from catastro_gdl:parametros

--60	Adeudo Estac. Publicos
--61	Adeudo Estac. Publicos Importes 
  foreach
  execute PROCEDURE dbestacion:sp14_ind_esta_publicos_01() 
  into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 60 , v_cantidad  , 61 ,  v_importe );

--62	Adeudo Estac. Exclusivos Cuantos
--63	Adeudo Estac. Exclusivos Importes
 foreach
  execute PROCEDURE dbestacion:sp14_ind_esta_exclusivos_01() 
  into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 62 , v_cantidad  , 63 ,  v_importe );

--64	Adeudo Estacionometros Cuantos
--65	Adeudo Estacionometros Importes
  foreach
  execute PROCEDURE dbestacion:sp14_ind_esta_estacionometros_01() 
  into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes,  64 , v_cantidad  , 65 ,  v_importe );


--66	Adeudo Valet Parking Cuantos
--67	Adeudo Valet Parking Importes
  foreach
  execute PROCEDURE db_ingresos:sp34_ind_otras_oblig_01('5') 
   into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 66 , v_cantidad  , 67 ,  v_importe );

--68	Adeudo Aseo Contratado Cuantos
--69	Adeudo Aseo Contratado importe
  foreach
  execute PROCEDURE db_ingresos:sp16_ind_aseo_contratado_01() 
  into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes , 68 , v_cantidad  , 69 ,  v_importe );

--70	Adeudo Fuente de Sodas Cuantos
--71	Adeudo Fuente de Sodas Importes
  foreach
  execute PROCEDURE db_ingresos:sp34_ind_otras_oblig_01('1') 
  into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes , 70 , v_cantidad  , 71 ,  v_importe );

--72	Adeudo Juegos Mecanicos Cuantos
--73	Adeudo Juegos Mecanicos Importes
  foreach
  execute PROCEDURE db_ingresos:sp34_ind_otras_oblig_01('2')  
  into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 72 , v_cantidad  , 73 ,  v_importe );


--74	Adeudo Sanitarios Publicos Cuantos
--75	Adeudo Sanitarios Publicos Importes
  foreach
  execute PROCEDURE db_ingresos:sp34_ind_otras_oblig_01('4')  into v_desc_01 , v_cantidad , v_importe 
  end foreach;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 74 , v_cantidad  , 75 ,  v_importe );


--76	Adeudo Cementerios Cuantos
--77	Adeudo Cementerios Importes
 
select count(distinct d.control_rcm) ,sum(a.importe)  into   v_cantidad , v_importe
--,sum(a.descto_impote) as descuento
from db_ingresos:ta_13_datosrcm d 
inner join db_ingresos:ta_13_adeudosrcm a on a.control_rcm=d.control_rcm and a.vigencia='V' and a.axo_adeudo>=  (v_axo -5 )
left join db_ingresos:tc_13_cementerios c on c.cementerio=d.cementerio
where d.vigencia="V" ;
 execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 76 , v_cantidad  , 77 ,  v_importe );

--78	Adeudo Multas Municipales Cuantos
--79	Adeudo Multas Municipales importe
  select count(*) , sum(total)  
         into   v_cantidad , v_importe
         from catastro_gdl:multas 
 
  where fecha_cancelacion is null and cvepago is null and id_prescri is null and fec_condonar is null ;
  execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 78 , v_cantidad  , 79 ,  v_importe );
--80	Adeudo Mercados Cuantos
--81	Adeudo Mercados Importes
 -- execute procedure db_ingresos:spd_11_adeudomerc(2018, 09)
  let t_can = 0;
  let t_imp = 0;
 foreach
  execute procedure db_ingresos:spd_11_adeudomerc(v_axo, v_mes) 
  into  v_merc, v_desc_02, v_cantidad, v_importe 
  let t_can = t_can + v_cantidad;
  let t_imp = t_imp + v_importe;

  end foreach;
 execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes , 80 , t_can  , 81 ,  t_imp );
--82	Adeudo Licencias Giro Cuantos
--83	Adeudo Licencias Giro Importes
select count(distinct licencia),sum(forma+derechos+derechos2)   into   v_cantidad , v_importe
--,sum(desc_derechos+desc_forma) 
from catastro_gdl:licencias l 
inner join catastro_gdl:detsal_lic d on d.id_licencia=l.id_licencia and cvepago=0
where l.vigente="V" and licencia>0;
 execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 82 , v_cantidad  , 83 ,  v_importe );

--84	Adeudo Licencias Anuncios
--85	Adeudo Licencias Anuncios

select count(distinct id_anuncio), sum(forma+derechos+derechos2) into   v_cantidad , v_importe
--,sum(desc_derechos+desc_forma) 
 from catastro_gdl:licencias l 
inner join catastro_gdl:detsal_lic d on d.id_licencia=l.id_licencia and cvepago=0
where l.vigente="V" and empresa>0 ;
 execute procedure catastro_gdl:cal_ind_aduedo_cartera(v_axo , v_mes  , 84 , v_cantidad  , 85 ,  v_importe );



end procedure;

CREATE PROCEDURE "informix".sp_cambioperfildeusuario(a_usuarioviejo char(8),a_usuarionvo char(8))

define li_encuentra integer;
define li_idusuarioviejo integer;
define li_idusuarionvo integer;
define li_enc integer;

select id
into li_idusuarioviejo
from usuarios where usuario =a_usuarioviejo;


select id
into li_idusuarionvo
from usuarios where usuario =a_usuarionvo;


if li_idusuarioviejo  is not null or li_idusuarioviejo =1 then
	insert into ta_autoriza
	select li_idusuarionvo,id_modulo,tag 
	from ta_autoriza t_v
	where id_usuario = li_idusuarioviejo
    	and ( t_v.tag not in (select tag from ta_autoriza t_n where  t_n.id_modulo= t_v.id_modulo and t_n.tag = t_v.tag   and t_n.id_usuario=li_idusuarionvo));
else
 RAISE EXCEPTION -746,0,'El o los usuarios no existen'||a_usuarioviejo||" "||a_usuarionvo ;
end if

END PROCEDURE;

CREATE PROCEDURE "informix".tmp_cancela_odoo
()
define vid int;
define vinteface int;
define vfolio varchar(30);

    foreach select trx_idcobro, trx_interface, trx_foliorecibo 
        into vid, vinteface, vfolio
    from trx_odoo_pago where trx_cajero = 'ODOO'  
        and trx_foliorecibo between 'R30107-03174-008-0260' and 'R30107-03174-008-305'
        and trx_interface = 8

        execute procedure dbingresosvw:informix.odoo_cancela(vinteface,vid,vfolio,'ODOO');

    end foreach;
END PROCEDURE
;

create procedure "informix".spd_15_descautrm(pid int, prec char(1), pmul char(1), paxofin int, pmesfin int)

define v_descvig, v_folreq, v_cvereq, v_axomin, v_mesmin, v_axofin, v_mesfin int;
define v_fecha date;

if prec='S' then  -- aplica descuento en recargos

    -- verifica si existen descuentos vigentes
   if exists(select * from ta_11_descrec where id_local=pid and fecha_baja is null and usuario_baja is null and vigencia='V') then 
      
      -- si tiene descuento vigente lo cancela
     update ta_11_descrec set vigencia='C', fecha_baja=today, usuario_baja='dautmer' 
       where id_local=pid and fecha_baja is null and usuario_baja is null and vigencia='V';
   end if;   

      -- para sacar el a�o minimo
      select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=pid;

      -- para sacar el mes minimo       
      select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=pid and axo=v_axomin;

      -- selecciona fecha de vencimiento
      select fecha_recargos into v_fecha from ta_11_fecha_desc where mes=month(today);

      -- verifica si el mes actual ya esta vencido
      if paxofin=year(today) then
         if day(today)<day(v_fecha) then
            if month(today)=1 then      
               let v_mesfin=12;
               let v_axofin=year(today)-1;
            else
               let v_mesfin=month(today)-1;
               let v_axofin=year(today);
            end if;
         else
            let v_mesfin=month(today);
            let v_axofin=year(today);
         end if;
      else
         let v_mesfin=pmesfin;
         let v_axofin=paxofin;   
      end if;

      insert into ta_11_descrec (id_descto, id_local, axoinicio, mesinicio, axofin, mesfin, fecha_alta, usuario_alta, fecha_baja,
        usuario_baja, fec_pag, id_rec, caja, operac, vigencia, porcentaje ) 
        values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, today, 'dautmer', null, null, null, null, null, null,'V',75);

end if;

if pmul='S' then  -- aplica descuento en multa
   if exists (select * from ta_15_apremios b where b.modulo=11 and b.control_otr=pid and b.vigencia='1' and b.clave_practicado='P') then 

         -- para obtener el datos de multa
         foreach
         select id_control into v_cvereq from ta_15_apremios b
         where b.modulo=11 and b.control_otr=pid and b.vigencia='1' and b.clave_practicado='P'
         order by id_control
         end foreach;

         -- si tiene descuento vigente lo cancela
         if not exists( select * from ta_15_autorizados where control=v_cvereq and fecha_baja is null and estado=1) then
            --update ta_15_autorizados set fecha_baja=today, id_usuario=1034, estado=2, fecha_actual=today
            -- where control=v_cvereq;
   
         -- inserta el porcentaje de descuento
            insert into ta_15_autorizados (control, id_rec, cveaut, porcentaje, fecha_alta, id_usuarioa, fecha_baja, estado, id_usuario, fecha_actual)
             values(v_cvereq, 1, 4, 50, today, 1034, null, 1, 1034, today);

         -- cambia el porcentale de multa al folio de apremios
         update ta_15_apremios set porcentaje_multa=50 where id_control=v_cvereq;
         end if;

   end if; 
end if; 

end procedure;

CREATE PROCEDURE "informix".tmp_pred_pago2 ()
	define v_idpago int;
    define v_folio varchar(50);
    define v_rec varchar(10);
    define v_urbrus varchar(10);
    define v_cta varchar(10);
    define v_axopago int;
    define v_bimpago int;
    define v_total decimal(12,2);
    define v_redondeo decimal(12,2);
    define v_fecha date;
    define v_estatus varchar(10);    
    define v_impuesto decimal(12,2);
    define v_cvecuenta int;
    define v_msg varchar(30);
    
    foreach
    select o.id_pago, o.folio, substr(o.cuenta,1,1) rec,  substr(o.cuenta,3,1) urbrus, substr(o.cuenta,5,6) cta, 
        case when o.periodo <> '' then substr(o.periodo,1,4) else '2020' end axoPago,
        case when o.periodo <> '' then substr(o.periodo,6,4) else '6' end bimPago,
        o.total, nvl(o.redondeo,0) redondeo, o.fecha, o.estatus
    into v_idpago, v_folio, v_rec, v_urbrus, v_cta, v_axopago, v_bimpago,
        v_total, v_redondeo, v_fecha,  v_estatus
    from tmp_pagosodoo o
        left join trx_odoo_pago p on p.trx_idcobro = o.id_pago
    where p.trx_idcobro > 0 and o.estatus not in ('YA PAGADA','PAGADA') order by o.id_pago
    -- Inicio de foreach
        if v_bimpago = 11 then let v_bimpago = 6; end if;
     
        if v_bimpago <= 6 then
            -- Buscamos se encuentre aplicado el pago
            select sum(ds.impade) impuesto, max(ds.cvecuenta) into v_impuesto, v_cvecuenta
            from catastro_gdl:detsaldos ds 
                inner join catastro_gdl:convcta d on d.cvecuenta = ds.cvecuenta
            where d.recaud = v_rec and d.urbrus = v_urbrus and d.cuenta = v_cta 
                and ((ds.axosal * 10) + ds.bimsal) <= ((v_axopago * 10) + v_bimpago);

            let v_msg = 'YA PAGADA';

            if v_impuesto > 0 then
                -- Se deben los periodos anteriores, saldamos...
                update catastro_gdl:detsaldos set
                    imppag = impade,
                    recpag = recfac - recvir
                where cvecuenta = v_cvecuenta and saldo > 0
                    and ((axosal * 10) + bimsal) <= ((v_axopago * 10) + v_bimpago);    

                let v_msg = 'PAGADA';
            end if;

            -- Actualizamos estatus como ya pagada
            update tmp_pagosodoo set
                estatus = v_msg
            where id_pago = v_idpago;
        end if;
       
    end foreach;

END PROCEDURE
;

CREATE PROCEDURE "informix".tmp_pred_pago ()
	define v_idpago int;
    define v_folio varchar(50);
    define v_rec varchar(10);
    define v_urbrus varchar(10);
    define v_cta varchar(10);
    define v_periodo varchar(20);
    define v_total decimal(12,2);
    define v_redondeo decimal(12,2);
    define v_fecha date;
    define v_recaudadora int; --varchar(10);
    define v_centro int; --varchar(10);
    define v_caja varchar(10);
    define v_estatus varchar(10);
    define v_monto_ok decimal(12,2);    
    define v_clave int;
    define v_descripcion varchar(255);
    define v_impuesto decimal(12,2);
    define v_r, v_c int;
    
    foreach
    select o.id_pago, o.folio, substr(o.cuenta,1,1) rec,  substr(o.cuenta,3,1) urbrus, substr(o.cuenta,5,6) cta,
        o.periodo, o.total, nvl(o.redondeo,0) redondeo, o.fecha,
        o.recaudadora, o.centro, o.caja, o.estatus
    into v_idpago, v_folio, v_rec, v_urbrus, v_cta, 
        v_periodo, v_total, v_redondeo, v_fecha, 
        v_recaudadora, v_centro, v_caja, v_estatus
    from tmp_pagosodoo o
        left join trx_odoo_pago p on p.trx_idcobro = o.id_pago
    where p.trx_idcobro is null --and o.estatus not in ('YA PAGADA','PAGADA') 
    -- Inicio de foreach

        if v_estatus in ('paid','invoiced','YA PAGADA') then
            let v_monto_ok = v_total - v_redondeo;

            if trim(v_periodo) = '' then    
                let v_periodo = '2020-6-0';
            else
                let v_periodo = '2020-6-0';
            end if;

            let v_r = v_rec * 1;
            let v_c = v_cta * 1;

            select sum(ds.impade) into v_impuesto
            from catastro_gdl:detsaldos ds 
                inner join catastro_gdl:convcta d on d.cvecuenta = ds.cvecuenta
            where d.recaud = v_r and d.urbrus = v_urbrus and d.cuenta = v_c
                and ds.axosal <= 2020;
            
            if v_impuesto > 0 then
                -- Enviamos pago a odoo        
                
                execute procedure dbingresosvw:odoo_pago(8,v_rec,v_urbrus,v_cta,'','','',
                    v_periodo,0,v_total,v_monto_ok,v_redondeo,v_idpago,v_folio,
                    v_fecha,v_recaudadora,v_centro, v_caja,0,'','','','') into v_clave, v_descripcion;

                update tmp_pagosodoo set 
                    estatus = 'PAGADA'
                where id_pago = v_idpago; 
                --execute procedure dbingresosvw:odoo_pago(10,'4','U','136256','333431','','','',0,90932.06,90932.06,0,913512,'	E902-00048214',to_date(),9,902,'90206',0,'','','','')
            else
                update tmp_pagosodoo set 
                    estatus = 'YA PAGADA'
                where id_pago = v_idpago;
            end if;
        end if;        
    end foreach;

END PROCEDURE
;

CREATE PROCEDURE "dbarias".upd16_ade ( par_control Integer, par_periodo Char(7), par_Ctrol_Oper Integer, 
                                                               par_status_vig Char(1), par_Fecha Date, par_Id_Rec Integer, 
                                                               par_Caja Char(2), par_Consec Integer, par_Folio_rcbo Char(10),par_obs varchar(250))

define v_id_usuario                                                                     	Int;
define v_idcontrol, v_folio					Int;
define v_gastos						Money(12,2);

Let  v_idcontrol = 0;
Let  v_folio = 0;
Let  v_gastos = 0;

--************************************************************************USUARIO
SELECT id_usuario INTO v_id_usuario FROM ta_12_passwords WHERE usuario = user;
--************************************************************************

	if par_status_vig = 'P' then
              	update ta_16_pagos set
                            	status_vigencia = par_status_vig,
                               	fecha_hora_pago = par_Fecha,
                               	id_rec = par_Id_Rec,
                               	caja = par_Caja,
                               	consec_operacion = par_Consec,
                               	folio_rcbo = par_Folio_rcbo,
                               	usuario = v_id_usuario,
                                observaciones=par_obs
               	where control_contrato = par_control and aso_mes_pago = par_periodo 
                            	and ctrol_operacion = par_Ctrol_Oper and status_vigencia = 'V';
	else
              	update ta_16_pagos set
                            	status_vigencia = par_status_vig,
                               	fecha_hora_pago = par_Fecha,
                               	id_rec = 0,
                               	caja = '',
                               	consec_operacion = 0,
                               	folio_rcbo = par_Folio_rcbo,
                               	usuario = v_id_usuario,
                                observaciones=par_obs
               	where control_contrato = par_control and aso_mes_pago = par_periodo 
                            	and ctrol_operacion = par_Ctrol_Oper and status_vigencia = 'V';
	end if;

   foreach
	select nvl(a.id_control,0), nvl(a.folio,0), a.importe_gastos
	into v_idcontrol, v_folio, v_gastos 
	from    ta_15_apremios a, ta_15_periodos b
	where a.modulo = 16 and a.control_otr = par_control and a.vigencia = '1' and a.clave_practicado = 'P'
	and b.control_otr = a.id_control and b.ayo||'-'||b.periodo = par_periodo

	if par_status_vig = 'P' then
		-- poner como pagados los folios vigentes y practicados
   		update ta_15_apremios set 
			fecha_pago = par_Fecha, recaudadora = par_Id_Rec, caja = par_Caja, operacion = par_Consec, vigencia = '2', clave_mov = 'P', importe_pago = v_gastos
   		where modulo=16 and Id_control=v_idcontrol;
	else
		-- poner como Condonados/Cancelados/Prescritos
   		update ta_15_apremios set 
			fecha_pago = null, recaudadora = 0, caja = '', operacion = 0, vigencia = '3', importe_pago = 0
   		where modulo=16 and Id_control=v_idcontrol;
	end if;

   end foreach;

end procedure;

create procedure "pgcabrer".cancela_descuentos_automaticos()

define v_control, v_axoini, v_axofin, v_iddescto, v_idlicencia, v_mod, v_idcem, p_cvecuenta, p_axoini, p_axofin, p_id_descmulta int;
define r_cvecuenta, r_axoini, r_axofin, r_id_descmulta, v_rowid int;
define v_perdsd, v_perhst, v_perdsdm, v_perhstm char(5); 
define v_iddesctom, v_idlicenciam, v_modm int;
define v_tipo, v_tipom, v_kpgel, v_kpgelm char(1);

let v_mod=0;
let v_modm=0;

--- DESCUENTOS DE PREDIAL
    -- recargos
    foreach
      select rowid, cvecuenta, (axoini||bimini), (axofin||bimfin) into v_rowid, r_cvecuenta, v_perdsd, v_perhst from catastro_gdl:descrec 
          where fecalta<=today and vigencia='V' and axoini<=axofin
      if not exists( select * from catastro_gdl:detsaldos where cvecuenta=r_cvecuenta and ((axosal||bimsal) between v_perdsd and v_perhst) and fec_recibo is not null) then
         if not exists (select * from catastro_gdl:detsaldos where cvecuenta=r_cvecuenta and ((axosal||bimsal) between v_perdsd and v_perhst) and kpgel is not null) then
             update catastro_gdl:descrec set fecbaja=today, captbaja='midnight', vigencia='C' where rowid=v_rowid;
         end if;
      end if;
    end foreach;

    -- multas
    foreach
      select id_descmulta, cvecuenta, (axoini||bimini), (axofin||bimfin) into p_id_descmulta, p_cvecuenta, v_perdsdm, v_perhstm from catastro_gdl:descmulta 
          where fecalta<=today and estado='V' and axoini<=axofin
      if not exists( select * from catastro_gdl:detsaldos where cvecuenta=p_cvecuenta and ((axosal||bimsal) between v_perdsdm and v_perhstm) and fec_recibo is not null) then 
         if not exists (select * from catastro_gdl:detsaldos where cvecuenta=p_cvecuenta and ((axosal||bimsal) between v_perdsdm and v_perhstm) and kpgel is not null) then
             update catastro_gdl:descmulta set fecbaja=today, captbaja='midnight', estado='C' where id_descmulta=p_id_descmulta;
         end if;
      end if;
    end foreach; 

--- DESCUENTOS DE LICENCIAS DE GIRO
    -- recargos
    FOREACH
      select id_descto, tipo, licencia into v_iddescto, v_tipo, v_idlicencia
      from catastro_gdl:descreclic where fecalta<=today and estado='V'
      if v_tipo='L' then
         let v_mod=9;
      else
         let v_mod=10;
      end if;
      if not exists(select * from ta_17_referencia r, ta_17_conv_d_resto c
                     where r.modulo=v_mod and r.id_referencia=v_idlicencia and c.vigencia='A' and c.id_conv_resto=r.id_conv_resto) then

         update catastro_gdl:descreclic set fecbaja=today, captbaja='midnight', estado='C' where id_descto=v_iddescto;

         execute procedure catastro_gdl:calc_desclicrecar(v_idlicencia, 2, v_tipo, v_iddescto);
      end if;
    END FOREACH;

    -- multas
    FOREACH
      select id_descto, tipo, id_licanun into v_iddesctom, v_tipom, v_idlicenciam
      from catastro_gdl:descmultalic where fecalta<=today and vigencia='V'
      if v_tipom='L' then
         let v_modm=9;
      else
         let v_modm=10;
      end if;
      if not exists(select * from ta_17_referencia r, ta_17_conv_d_resto c
                     where r.modulo=v_modm and r.id_referencia=v_idlicenciam and c.vigencia='A' and c.id_conv_resto=r.id_conv_resto) then

         update catastro_gdl:descmultalic set fecbaja=today, userbaja='midnight', vigencia='C' where id_descto=v_iddesctom;
      end if;

    END FOREACH;

--- DESCUENTOS DE MULTAS MUNICIPALES
      update catastro_gdl:descmultampal set estado='C' where feccap<=today and estado='V';

--- DESCUENTO DE CEMENTERIOS
    FOREACH
      select id_folio, axoinicio, axofin into v_control, v_axoini, v_axofin 
      from ta_13_descrec where date(fecha_alta)<=today and vigencia='V'
   
      execute PROCEDURE catastro_gdl:ins_recarcem(v_control, v_axoini, v_axofin, 'midnight', 0, 2) into v_idcem;
    END FOREACH;

--- DESCUENTOS DE MERCADOS
    -- recargos
      update ta_11_descrec set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V';
 
    -- multas
      update ta_11_descmulta set fecha_baja=current, usu_baja='midnight', estado='C' where date(fecha_alta)<=today and estado='V';

--- DESCUENTOS DE ASEO CONTRATADO
    -- recargos
      update ta_16_descrec set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V';
    
    -- multas
      -- pendiente

--- DESCUENTO DE OTRAS OBLIGACIONES
    -- recargos
      update t34_descrec set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V'; 

    -- multas
      update t34_descmul set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V';

--- DESCUENTOS DE ESTACIONAMIENTOS PUBLICOS
    -- recargos
      update dbestacion:pub_descrec set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V';

    -- multas
      update dbestacion:pub_descmul set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V';

--- DESCUENTOS DE ESTACIONAMIENTOS EXCLUSIVOS
    -- recargos
      update dbestacion:ex_descrec set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V';

    -- multas
      update dbestacion:ex_descmul set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta)<=today and vigencia='V';

end procedure;

create procedure "informix".cancela_descuentos_automaticos_predial()

define v_control, v_axoini, v_axofin, v_iddescto, v_idlicencia, v_mod, v_idcem, p_cvecuenta, p_axoini, p_axofin, p_id_descmulta int;
define r_cvecuenta, r_axoini, r_axofin, r_id_descmulta, v_rowid int;
define v_perdsd, v_perhst, v_perdsdm, v_perhstm char(5); 
define v_iddesctom, v_idlicenciam, v_modm int;
define v_tipo, v_tipom, v_kpgel, v_kpgelm char(1);

let v_mod=0;
let v_modm=0;

--- DESCUENTOS DE PREDIAL
    -- recargos
    foreach
      select rowid, cvecuenta, (axoini||bimini), (axofin||bimfin) into v_rowid, r_cvecuenta, v_perdsd, v_perhst from catastro_gdl:descrec 
          where fecalta<=today and vigencia='V' and axoini<=axofin AND captalta = 'CORREOBF' AND cvecuenta NOT IN (SELECT cvecuenta FROM catastro_gdl:tmp_pred_bf_2022_pe)
      if not exists( select * from catastro_gdl:detsaldos where cvecuenta=r_cvecuenta and ((axosal||bimsal) between v_perdsd and v_perhst) and fec_recibo is not null) then
         if not exists (select * from catastro_gdl:detsaldos where cvecuenta=r_cvecuenta and ((axosal||bimsal) between v_perdsd and v_perhst) and kpgel is not null) then
             update catastro_gdl:descrec set fecbaja=today, captbaja='midnight', vigencia='C' where rowid=v_rowid;
         end if;
      end if;
    end foreach;

    -- multas
    foreach
      select id_descmulta, cvecuenta, (axoini||bimini), (axofin||bimfin) into p_id_descmulta, p_cvecuenta, v_perdsdm, v_perhstm from catastro_gdl:descmulta 
          where fecalta<=today and estado='V' and axoini<=axofin AND captalta = 'CORREOBF' AND cvecuenta NOT IN (SELECT cvecuenta FROM catastro_gdl:tmp_pred_bf_2022_pe)
      if not exists( select * from catastro_gdl:detsaldos where cvecuenta=p_cvecuenta and ((axosal||bimsal) between v_perdsdm and v_perhstm) and fec_recibo is not null) then 
         if not exists (select * from catastro_gdl:detsaldos where cvecuenta=p_cvecuenta and ((axosal||bimsal) between v_perdsdm and v_perhstm) and kpgel is not null) then
             update catastro_gdl:descmulta set fecbaja=today, captbaja='midnight', estado='C' where id_descmulta=p_id_descmulta;
         end if;
      end if;
    end foreach; 
END PROCEDURE;

create procedure "informix".cancela_descuentos_automaticos_bf2022()

define v_control, v_axoini, v_axofin, v_iddescto, v_idlicencia, v_mod, v_idcem, p_cvecuenta, p_axoini, p_axofin, p_id_descmulta int;
define r_cvecuenta, r_axoini, r_axofin, r_id_descmulta, v_rowid int;
define v_perdsd, v_perhst, v_perdsdm, v_perhstm char(5); 
define v_iddesctom, v_idlicenciam, v_modm int;
define v_tipo, v_tipom, v_kpgel, v_kpgelm char(1);

let v_mod=0;
let v_modm=0;

--- DESCUENTOS DE PREDIAL
    -- recargos
    /*foreach
      select rowid, cvecuenta, (axoini||bimini), (axofin||bimfin) into v_rowid, r_cvecuenta, v_perdsd, v_perhst from catastro_gdl:descrec 
          where fecalta<=today and vigencia='V' and axoini<=axofin AND captalta = 'CORREOBF'
      if not exists( select * from catastro_gdl:detsaldos where cvecuenta=r_cvecuenta and ((axosal||bimsal) between v_perdsd and v_perhst) and fec_recibo is not null) then
         if not exists (select * from catastro_gdl:detsaldos where cvecuenta=r_cvecuenta and ((axosal||bimsal) between v_perdsd and v_perhst) and kpgel is not null) then
             update catastro_gdl:descrec set fecbaja=today, captbaja='midnight', vigencia='C' where rowid=v_rowid;
         end if;
      end if;
    end foreach;

    -- multas
    foreach
      select id_descmulta, cvecuenta, (axoini||bimini), (axofin||bimfin) into p_id_descmulta, p_cvecuenta, v_perdsdm, v_perhstm from catastro_gdl:descmulta 
          where fecalta<=today and estado='V' and axoini<=axofin AND captalta = 'CORREOBF'
      if not exists( select * from catastro_gdl:detsaldos where cvecuenta=p_cvecuenta and ((axosal||bimsal) between v_perdsdm and v_perhstm) and fec_recibo is not null) then 
         if not exists (select * from catastro_gdl:detsaldos where cvecuenta=p_cvecuenta and ((axosal||bimsal) between v_perdsdm and v_perhstm) and kpgel is not null) then
             update catastro_gdl:descmulta set fecbaja=today, captbaja='midnight', estado='C' where id_descmulta=p_id_descmulta;
         end if;
      end if;
    end foreach; */

--- DESCUENTOS DE LICENCIAS DE GIRO
    -- recargos
    FOREACH
      select id_descto, tipo, licencia into v_iddescto, v_tipo, v_idlicencia
      from catastro_gdl:descreclic where fecalta BETWEEN '2022-11-18' AND '2022-11-21' and estado='V' AND captalta = 'desc75' AND tipo = 'L' AND licencia NOT IN (421997,471276,471275,201662)
      if v_tipo='L' then
         let v_mod=9;
      else
         let v_mod=10;
      end if;
      if not exists(select * from ta_17_referencia r, ta_17_conv_d_resto c
                     where r.modulo=v_mod and r.id_referencia=v_idlicencia and c.vigencia='A' and c.id_conv_resto=r.id_conv_resto) then

         update catastro_gdl:descreclic set fecbaja=today, captbaja='desc75', estado='C' where id_descto=v_iddescto AND captalta = 'desc75' AND tipo = 'L' AND licencia NOT IN (421997,471276,471275,201662);

         execute procedure catastro_gdl:calc_desclicrecar(v_idlicencia, 2, v_tipo, v_iddescto);
      end if;
    END FOREACH;

    -- multas
    FOREACH
      select id_descto, tipo, id_licanun into v_iddesctom, v_tipom, v_idlicenciam
      from catastro_gdl:descmultalic where fecalta BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND useralta = 'desc80' AND tipo = 'L' AND id_licanun NOT IN (421997,471276,471275,201662)
      if v_tipom='L' then
         let v_modm=9;
      else
         let v_modm=10;
      end if;
      if not exists(select * from ta_17_referencia r, ta_17_conv_d_resto c
                     where r.modulo=v_modm and r.id_referencia=v_idlicenciam and c.vigencia='A' and c.id_conv_resto=r.id_conv_resto) then

         update catastro_gdl:descmultalic set fecbaja=today, userbaja='desc80', vigencia='C' where id_descto=v_iddesctom AND useralta = 'desc80' AND tipo = 'L' AND id_licanun NOT IN (421997,471276,471275,201662);
      end if;

    END FOREACH;

--- DESCUENTOS DE MULTAS MUNICIPALES
-- SELECT * FROM catastro_gdl:descmultampal WHERE feccap BETWEEN '2022-11-18' AND '2022-11-21' AND estado = 'V' AND capturista = 'auto80' 
      update catastro_gdl:descmultampal set estado='C' where feccap BETWEEN '2022-11-18' AND '2022-11-21' and estado='V' AND capturista = 'auto80';

--- DESCUENTO DE CEMENTERIOS
-- SELECT * FROM db_ingresos:ta_13_descrec where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' AND vigencia = 'V' AND usuario_alta = 'auto75' 
    FOREACH
      select id_folio, axoinicio, axofin into v_control, v_axoini, v_axofin 
      from ta_13_descrec where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND usuario_alta = 'auto75'
   
      execute PROCEDURE catastro_gdl:ins_recarcem(v_control, v_axoini, v_axofin, 'auto75', 0, 2) into v_idcem;
    END FOREACH;

--- DESCUENTOS DE MERCADOS
    -- recargos
    -- SELECT * FROM ta_11_descrec where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND usuario_alta = 'dautmer';
      update ta_11_descrec set fecha_baja=current, usuario_baja='dautmer', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND usuario_alta = 'dautmer';
 
    -- multas
    -- SELECT * FROM ta_11_descmulta where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and estado='V' AND usu_alta = 'dautmer';
      update ta_11_descmulta set fecha_baja=current, usu_baja='dautmer', estado='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and estado='V' AND usu_alta = 'dautmer';

--- DESCUENTOS DE ASEO CONTRATADO
    -- recargos
    -- SELECT * FROM ta_16_descrec where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V';
      update ta_16_descrec set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V';
    
    -- multas
      -- pendiente

--- DESCUENTO DE OTRAS OBLIGACIONES
    -- recargos
    -- SELECT * FROM t34_descrec where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V'; 
      update t34_descrec set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V'; 

    -- multas
    -- SELECT * FROM t34_descmul where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V'; 
      update t34_descmul set fecha_baja=current, usuario_baja='midnight', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V';

--- DESCUENTOS DE ESTACIONAMIENTOS PUBLICOS
    -- recargos
    -- SELECT * FROM dbestacion:pub_descrec WHERE date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' AND vigencia = 'V' AND usuario_alta = 'CORREOBF'
      update dbestacion:pub_descrec set fecha_baja=current, usuario_baja='CORREOBF', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND usuario_alta = 'CORREOBF';

    -- multas
    -- SELECT * FROM dbestacion:pub_descmul WHERE date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' AND usuario_alta = 'CORREOBF' AND vigencia = 'V' 
      update dbestacion:pub_descmul set fecha_baja=current, usuario_baja='CORREOBF', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND usuario_alta = 'CORREOBF';

--- DESCUENTOS DE ESTACIONAMIENTOS EXCLUSIVOS
    -- recargos
    -- SELECT * FROM dbestacion:ex_descrec WHERE date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' AND usuario_alta = 'CORREOBF' AND vigencia = 'V'
      update dbestacion:ex_descrec set fecha_baja=current, usuario_baja='CORREOBF', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND usuario_alta = 'CORREOBF';

    -- multas
    -- SELECT * FROM dbestacion:ex_descmul WHERE date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21'
      update dbestacion:ex_descmul set fecha_baja=current, usuario_baja='CORREOBF', vigencia='C' where date(fecha_alta) BETWEEN '2022-11-18' AND '2022-11-21' and vigencia='V' AND usuario_alta = 'CORREOBF';

end procedure;

CREATE PROCEDURE "pgcabrer".spd_adeudorcm(var_control int,v_usu int)
                          --   returning  integer, 
                          --             money(15,2),
                          --            money(15,2);


define v_uap    integer;
define v_axo    integer;
define v_mes   smallint;
define v_metros decimal(5,3);
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define vpar_actualizacion  money(15,2);
define v_cem char(1);
define v_sum   smallint;
DEFINE vparperiodo INT;

create temp table ta_adercm1(
axo        smallint,
importe  money(15, 2),
recargos money(15, 2),
actualizacion money(15, 2))
   with no log;
 
let v_axo=year(today);
let v_mes=month(today); 
let v_sum=0;
let vparperiodo=(year(today) - 5); 

foreach
--select  (case when axo_pagado< (year(today) - 5 ) then (year(today) - 5) else axo_pagado+1 end),metros,cementerio
--         into v_uap,v_metros,v_cem from ta_13_datosrcm where control_rcm=var_control 

select   axo_pagado+1, metros,cementerio
         into v_uap,v_metros,v_cem from ta_13_datosrcm where control_rcm=var_control

        if v_uap<2008 then 
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),
         ((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(2019 , 1, ((trunc((b.cuota1* (v_metros)), 2))) ) - ((trunc((b.cuota1* (v_metros)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2007;
          let v_sum=2008-v_uap;

          let v_uap=v_uap+v_sum;
        else 
          if v_uap <= 2018 then

         --2018 y anteriones se calcula la actualizacion con 2019 mes 1
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion( 2019 , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2018;

         --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between 2019 and (v_axo - 1);

          else

         --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and (v_axo - 1);
          end if;

          --para el a�o actual no se calcula actualizacion
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,0.00
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota = v_axo;

        end if; 

end foreach;
foreach
  select  axo,importe ,recargos, actualizacion   into vpar_axo,vpar_impte, vpar_recar, vpar_actualizacion  from ta_adercm1
  --return   vpar_axo,vpar_impte, vpar_recar with resume;
  --insert into ta_13_adeudosrcm values( 0,var_control,vpar_axo,vpar_impte, vpar_recar,0,0,'V',v_usu,today,null);
  --Se agrega actualizacion
    insert into ta_13_adeudosrcm values( 0,var_control,vpar_axo,vpar_impte, vpar_recar,0,0,vpar_actualizacion,'V',v_usu,today,null); 
--  execute procedure spd_cgmov_cement(today,13, var_control,vpar_impte,vpar_recar, vpar_axo, 1, v_usu);
 end foreach;  

drop table ta_adercm1;

end procedure;

CREATE PROCEDURE "pgcabrer".spd_adeudorcmbeny(var_control int,v_usu int)
                          --   returning  integer, 
                          --             money(15,2),
                          --            money(15,2);


define v_uap    integer;
define v_axo    integer;
define v_mes   smallint;
define v_metros decimal(5,3);
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define vpar_actualizacion  money(15,2);
define v_cem char(1);
define v_sum   smallint;
DEFINE vparperiodo INT;

create temp table ta_adercm1(
axo        smallint,
importe  money(15, 2),
recargos money(15, 2),
actualizacion money(15, 2))
   with no log;
 
let v_axo=year(today);
let v_mes=month(today); 
let v_sum=0;
let vparperiodo=(year(today) - 5); 

foreach
--select  (case when axo_pagado< (year(today) - 5 ) then (year(today) - 5) else axo_pagado+1 end),metros,cementerio
--         into v_uap,v_metros,v_cem from ta_13_datosrcm where control_rcm=var_control 

select   axo_pagado+1, metros,cementerio
         into v_uap,v_metros,v_cem from ta_13_datosrcm where control_rcm=var_control

        if v_uap<2008 then 
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),
         ((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(2019 , 1, ((trunc((b.cuota1* (v_metros)), 2))) ) - ((trunc((b.cuota1* (v_metros)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2007;
          let v_sum=2008-v_uap;

          let v_uap=v_uap+v_sum;
        else 
          if v_uap <= 2018 then

         --2018 y anteriones se calcula la actualizacion con 2019 mes 1
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion( 2019 , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2018;

         --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between 2019 and (v_axo - 1);

          else

         --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and (v_axo - 1);
          end if;

          --para el a�o actual no se calcula actualizacion
         insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,0.00
           from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota = v_axo;

        end if; 

end foreach;
foreach
  select  axo,importe ,recargos, actualizacion   into vpar_axo,vpar_impte, vpar_recar, vpar_actualizacion  from ta_adercm1
  --return   vpar_axo,vpar_impte, vpar_recar with resume;
  --insert into ta_13_adeudosrcm values( 0,var_control,vpar_axo,vpar_impte, vpar_recar,0,0,'V',v_usu,today,null);
  --Se agrega actualizacion
  if (vpar_axo>=2008 and vpar_axo<=2017) then
    insert into ta_13_adeudosrcm values( 0,var_control,vpar_axo,vpar_impte, vpar_recar,0,0,vpar_actualizacion,'V',v_usu,today,null); 
--  execute procedure spd_cgmov_cement(today,13, var_control,vpar_impte,vpar_recar, vpar_axo, 1, v_usu);
  end if;
 end foreach;  

drop table ta_adercm1;

end procedure;

CREATE PROCEDURE "pgcabrer".spd_13_recargos(v_control int, par_mes   smallint)
                           

define vparperiodo1       smallint;
define vparmetros        decimal(5,3);
define vparperiodo       smallint;
define vparimporte            money(15,2);
define vparimpterec          money(15,2);


foreach
     select axo_adeudo, (importe - descto_impote) into vparperiodo1, vparimporte 
     from ta_13_adeudosrcm
     where control_rcm=v_control and vigencia='V' AND v_control NOT IN (26031)

      update ta_13_adeudosrcm set importe_recargos=trunc((vparimporte * (select porcentaje_global from ta_13_recargosrcm where (axo=vparperiodo1  and mes=par_mes))/100), 2)  
       where control_rcm=v_control and axo_adeudo= vparperiodo1;
end foreach;
end procedure;

create procedure "informix".spd_15_descautrm(pid int, paxofin int, pmesfin int, popc char(1))

define v_descvig, v_folreq, v_cvereq, v_axomin, v_mesmin, v_axofin, v_mesfin, v_id int;
define v_porc_descto_multa, v_porc_descto_rcgos, v_porc_descto_renta, v_cc1, v_cc2, v_cc3 int;
define v_fecha, v_fec_ini, v_fec_fin date;
define v_usuario varchar(8);
define v_recargos, v_multa, v_renta money(16,2);

let v_usuario = null;

-- FIX
LET v_fec_ini = NULL;
LET v_fec_fin = NULL;

if popc='A' then
-- verifica periodo de descuento automatico
foreach
select fec_ini , fec_fin , usu_aplica , porc_descto_rcgos , porc_descto_multa , porc_descto_renta
    into v_fec_ini , v_fec_fin , v_usuario , v_porc_descto_rcgos , v_porc_descto_multa , v_porc_descto_renta
from ta_11_parmetros_descuentos where vigente = 'V'
end foreach;

-- obtiene los recargos, multa y renta
execute function fn_getademerc(pid, paxofin, pmesfin) into v_renta;
execute function fn_getrecmerc(pid, paxofin, pmesfin) into v_recargos;
execute function fn_getmulmerc(pid, paxofin, pmesfin) into v_multa;

if v_usuario is not null then

   if v_fec_ini IS NOT NULL AND v_fec_fin IS NOT NULL THEN -- BEGIN: Validaci�n de que existan fechas de inicio y fin
   if today >= v_fec_ini  and today <= v_fec_fin then

      -- verifica si existen descuentos vigentes de recargos
      if exists(select * from ta_11_descrec where id_local=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos ) then 
      
         -- si tiene descuento vigente de recargos lo cancela
         update ta_11_descrec set vigencia='C', fecha_baja=today, usuario_baja='dautmer' 
           where id_local=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos;
      end if;   

      -- verifica si existen descuentos vigentes de multas
      if exists(select * from ta_11_descmulta where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_multa) then 
      
         -- si tiene descuento vigente de multa lo cancela
         update ta_11_descmulta set estado='C', fecha_baja=today, usu_baja='dautmer' 
           where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_multa;
      end if; 

      -- verifica si existen descuentos vigentes en arrendamiento (renta)
      if exists(select * from ta_11_descderechos where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_renta) then 
      
         -- si tiene descuento vigente de multa lo cancela
         update ta_11_descderechos set estado='C', fecha_baja=today, usu_baja='dautmer' 
           where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_renta;
      end if;

      -- para sacar el a�o minimo
      select  min(axo) into v_axomin from ta_11_adeudo_local where id_local=pid;

      -- para sacar el mes minimo       
      select min(periodo) into v_mesmin  from ta_11_adeudo_local where id_local=pid and axo=v_axomin;

      -- selecciona fecha de vencimiento
      select fecha_recargos into v_fecha from ta_11_fecha_desc where mes=month(today);

      -- verifica si el mes actual ya esta vencido
      if paxofin=year(today) then
         if day(today)<day(v_fecha) then
            if month(today)=1 then      
               let v_mesfin=12;
               let v_axofin=year(today)-1;
            else
               let v_mesfin=month(today)-1;
               let v_axofin=year(today);
            end if;
         else
            let v_mesfin=month(today);
            let v_axofin=year(today);
         end if;
      else
         let v_mesfin=pmesfin;
         let v_axofin=paxofin;   
      end if;

      -- vericar si tiene descuentos en recargos vigentes 
      select count(*) into v_cc1 from ta_11_descrec where id_local=pid and vigencia = 'V';

      -- vericar si tiene descuentos en multas vigentes
      select count(*) into v_cc2 from ta_11_descmulta where id_local=pid and estado = 'V';

      -- vericar si tiene descuentos en multas vigentes
      select count(*) into v_cc3 from ta_11_descderechos where id_local=pid and estado = 'V';

      -- insertar los descuento  recargos
      if  v_cc1 = 0   then
          if  (v_recargos > 0  and v_porc_descto_rcgos > 0 )  then
              insert into ta_11_descrec (id_descto, id_local, axoinicio, mesinicio, axofin, mesfin, fecha_alta, usuario_alta, fecha_baja,
              usuario_baja, fec_pag, id_rec, caja, operac, vigencia, porcentaje ) 
              values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, current, v_usuario, null, null, null, null, null, null,'V',v_porc_descto_rcgos);
          end if;
      end if;
      -- insertar los descuento  multa
      if  v_cc2 = 0   then
          if  (v_multa > 0  and v_porc_descto_multa > 0 )  then
              insert into ta_11_descmulta (id_descuento, id_local, axoini, mesini, axofin, mesfin, porcentaje, fecha_alta, usu_alta, fecha_baja,
              usu_baja, estado, id_pago, autoriza ) 
              values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, v_porc_descto_multa, current, v_usuario, null, null, 'V', null, 1);
          end if;
      end if;
      -- insertar los descuento  renta
      if  v_cc3 = 0   then
          if  (v_renta > 0  and v_porc_descto_renta > 0 )  then
              insert into ta_11_descderechos (id_descuento, id_local, axoini, mesini, axofin, mesfin, porcentaje, fecha_alta, usu_alta, fecha_baja,
              usu_baja, estado, id_pago, autoriza ) 
              values(0, pid, v_axomin, v_mesmin, paxofin, pmesfin, v_porc_descto_renta, current, v_usuario, null, null, 'V', null, 1); --descuento hasta donde paga
              --values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, v_porc_descto_renta, current, v_usuario, null, null, 'V', null, 1); --descuento hasta el mes vencido
          end if;
      end if;

   end if;
   END IF; -- END: Validaci�n de que existan fechas de inicio y fin
end if;
end if; --- cierre de la opcion admtb_social_pdiv

if popc='B' then
   foreach
     select fec_ini , fec_fin , usu_aplica , porc_descto_rcgos , porc_descto_multa , porc_descto_renta
     into v_fec_ini , v_fec_fin , v_usuario , v_porc_descto_rcgos , v_porc_descto_multa , v_porc_descto_renta
     from ta_11_parmetros_descuentos where vigente = 'V'
   end foreach;

   if v_fec_ini IS NOT NULL AND v_fec_fin IS NOT NULL THEN -- BEGIN: Validaci�n de que existan fechas de inicio y fin
   if today >= v_fec_ini  and today <= v_fec_fin then
      -- verifica si existen descuentos vigentes de recargos
      if exists(select * from ta_11_descrec where id_local=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos 
                and usuario_alta='dautmer') then 
      
      -- si tiene descuento vigente de recargos lo cancela
         update ta_11_descrec set vigencia='C', fecha_baja=today, usuario_baja='dautmer' 
         where id_local=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos and usuario_alta='dautmer';
      end if;   

      -- verifica si existen descuentos vigentes de multas
      if exists(select * from ta_11_descmulta where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_multa
                and usu_alta='dautmer' ) then 
      
         -- si tiene descuento vigente de multa lo cancela
         update ta_11_descmulta set estado='C', fecha_baja=today, usu_baja='dautmer' 
         where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_multa and usu_alta='dautmer';
      end if; 

      -- verifica si existen descuentos vigentes en arrendamiento (renta)
      if exists(select * from ta_11_descderechos where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_renta
                   and usu_alta='dautmer') then 
    
      -- si tiene descuento vigente de multa lo cancela
        update ta_11_descderechos set estado='C', fecha_baja=today, usu_baja='dautmer' 
        where id_local=pid and fecha_baja is null and usu_baja is null and estado='V' and porcentaje<=v_porc_descto_renta and usu_alta='dautmer';
      end if;
   END IF;
   END IF; -- END: Validaci�n de que existan fechas de inicio y fin
end if; -- cierre de la opcion B

end procedure;

CREATE PROCEDURE "informix".spd_13_calc_actualizacion(v_usu int)


/*
Calculo global de actualizacion 
Marco Ortega
30 Nov 2020
*/

define v_control integer;

    -- Eliminar la tabla si existe
    EXECUTE IMMEDIATE 'DROP TABLE pgcabrer.ta_adercm1';

foreach
    select control_rcm into v_control from ta_13_datosrcm where vigencia='V'

    execute PROCEDURE spd_actualrcm (v_control, v_usu);
end foreach;
end procedure;

CREATE PROCEDURE "pgcabrer".spd_actualrcm (v_control int, v_usu int)

define v_axo integer;
define v_axoade integer;
define v_axobaja integer;
define v_vig char(1);
define v_axoi integer;
define v_importe  money(15,2);
define v_uap    integer;
define v_mes   smallint;
define v_metros decimal(5,3);
define vpar_axo integer;
define vpar_impte money(15,2);
define vpar_recar  money(15,2);
define vpar_actualizacion  money(15,2);
define v_cem char(1);
define v_sum   smallint;
DEFINE vparperiodo INT;
DEFINE v_id INT;
define v_axo_act   integer;

-- valida si existe el folio en la tabla para no calcular actualizacion
IF v_control IN (SELECT control_rcm FROM ta_13_noactualizacion where control_rcm = v_control AND vigencia = 'V') THEN
   RETURN;
END IF;

create temp table ta_adercm1(
axo        smallint,
importe  money(15, 2),
recargos money(15, 2),
actualizacion money(15, 2)
)   with no log;

let v_mes=month(today); 
let v_sum=0;
let vparperiodo=(year(today) - 5); 
let v_axoi=0;
let v_axo_act = year(today);

select axo_pagado,vigencia,metros,cementerio into v_axo,v_vig,v_metros,v_cem from ta_13_datosrcm where control_rcm=v_control;
select nvl(min(axo_adeudo),0) into v_axoade from ta_13_adeudosrcm where control_rcm=v_control and vigencia='V';

if v_axo<year(today) then
   let v_axo=v_axo+1;
end if;
let v_uap=v_axo;

 
if v_vig='B' then
    update ta_13_adeudosrcm set vigencia='B', fecha_mov=today, usuario=v_usu 
     where control_rcm=v_control and vigencia='V';
    foreach
     select axo_adeudo,importe,importe_recargos
       into v_axoi,v_importe, vpar_recar
     from ta_13_adeudosrcm
     where control_rcm=v_control and fecha_mov=today and vigencia='B' and usuario=v_usu
--execute procedure spd_cgmov_cement(today,13, v_control,v_importe,vpar_recar, v_axoi, 2, v_usu);
    end foreach;
end if;

if v_axoade= 0 then
   if v_uap<2008 then 
      insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),
        ((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
        ,catastro_gdl:fn_actualizacion(2019 , 1, ((trunc((b.cuota1* (v_metros)), 2))) ) - ((trunc((b.cuota1* (v_metros)), 2)))
      from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2007;
      let v_sum=2008-v_uap;
      let v_uap=v_uap+v_sum;
   else
      if v_uap <= 2018 then

      --2018 y anteriones se calcula la actualizacion con 2019 mes 1
      insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(2019 , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
      from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2018;
      --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
      
      insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
      from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between 2019 and (v_axo_act - 1);
      else
      --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
      
      insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
      from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and (v_axo_act - 1);

      end if;

      --para el a�o actual no se calcula actualizacion
      insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
         ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
      from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota = v_axo_act;
   end if;

foreach
  select  axo,importe ,recargos, actualizacion   into vpar_axo,vpar_impte, vpar_recar, vpar_actualizacion  from ta_adercm1
  if not exists (select * from ta_13_adeudosrcm where control_rcm=v_control and axo_adeudo=vpar_axo) then
   --insert into ta_13_adeudosrcm values( 0,v_control,vpar_axo,vpar_impte, vpar_recar,0,0,'V',v_usu,today,null);
   --Se agrega actualizacion
     insert into ta_13_adeudosrcm values( 0,v_control,vpar_axo,vpar_impte, vpar_recar,0,0,vpar_actualizacion,'V',v_usu,today,null);
  -- execute procedure spd_cgmov_cement(today,13, v_control,vpar_impte,vpar_recar, vpar_axo, 1, v_usu);
  else
    select first 1 id_adeudo into v_id from ta_13_adeudosrcm where control_rcm=v_control and  axo_adeudo=vpar_axo;
     update  ta_13_adeudosrcm set importe=vpar_impte, importe_recargos=vpar_recar, vigencia='V', fecha_mov=today, usuario=v_usu
            ,actualizacion= vpar_actualizacion
       where control_rcm=v_control and  id_adeudo=v_id  and vigencia='V';
  end if;
 end foreach;  
end if;

if v_axoade>v_axo then
   if v_uap<2008 then 
      insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),
         ((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
          ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (v_metros)), 2))) ) - ((trunc((b.cuota1* (v_metros)), 2)))
          from ta_13_rcmcuotas b where
          b.cementerio=v_cem and b.axo_cuota between v_uap and 2007;
      let v_sum=2008-v_uap;
      let v_uap=v_uap+v_sum;
   else
      if v_uap <= 2018 then

        --2018 y anteriones se calcula la actualizacion con 2019 mes 1
        insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(2019 , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
          from ta_13_rcmcuotas b where
          b.cementerio=v_cem and b.axo_cuota between v_uap and 2018;

        --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
        insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
          from ta_13_rcmcuotas b where
          b.cementerio=v_cem and b.axo_cuota between 2019 and (v_axo_act - 1);

      else

        --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
        insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
          from ta_13_rcmcuotas b where
          b.cementerio=v_cem and b.axo_cuota between v_uap and (v_axo_act - 1);

      end if;
        
      --para el a�o actual no se calcula actualizacion
      insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
          from ta_13_rcmcuotas b where
          b.cementerio=v_cem and b.axo_cuota = v_axo_act;
   end if;
foreach
  select  axo,importe ,recargos,actualizacion   into vpar_axo,vpar_impte, vpar_recar, vpar_actualizacion  from ta_adercm1
  if not exists (select * from ta_13_adeudosrcm where control_rcm=v_control and axo_adeudo=vpar_axo) then
     --insert into ta_13_adeudosrcm values( 0,v_control,vpar_axo,vpar_impte, vpar_recar,0,0,'V',v_usu,today,null);
     --Se agrega actualizacion
     insert into ta_13_adeudosrcm values( 0,v_control,vpar_axo,vpar_impte, vpar_recar,0,0,vpar_actualizacion,'V',v_usu,today,null);
  -- execute procedure spd_cgmov_cement(today,13, v_control,vpar_impte,vpar_recar, vpar_axo, 1, v_usu);
  else
    select first 1 id_adeudo into v_id from ta_13_adeudosrcm where control_rcm=v_control and  axo_adeudo=vpar_axo;
     update  ta_13_adeudosrcm set importe=vpar_impte, importe_recargos=vpar_recar, vigencia='V', fecha_mov=today, usuario=v_usu 
             ,actualizacion= vpar_actualizacion
       where control_rcm=v_control and  id_adeudo=v_id  and vigencia='V';
  end if;
  end foreach;  
end if;

if v_axoade=v_axo then
    if v_uap<2008 then 
       insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (v_metros)), 2))),
         ((trunc((trunc((b.cuota1* (v_metros)), 2)* (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
         ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (v_metros)), 2))) ) - ((trunc((b.cuota1* (v_metros)), 2)))
       from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2007;
       let v_sum=2008-v_uap;
       let v_uap=v_uap+v_sum;
   else
      if v_uap <= 2018 then
        --2018 y anteriones se calcula la actualizacion con 2019 mes 1
        insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2) * (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
        ,catastro_gdl:fn_actualizacion(2019 , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
        from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between v_uap and 2018;
        
        --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
        insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2) * (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
        ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
        from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between 2019 and (v_axo_act - 1);

      else

-- aqui lo agregamos
        --Entre 2019 y menor al a�o actual con el a�o de cuota para actualizacion
        insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2) * (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
        ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
        from ta_13_rcmcuotas b where
           b.cementerio=v_cem and b.axo_cuota between 2019 and (v_axo_act - 1);

      end if;
        insert into ta_adercm1 select b.axo_cuota,((trunc((b.cuota1* (1)), 2))),
        ((trunc((trunc((b.cuota1* (1)), 2) * (select porcentaje_global from ta_13_recargosrcm where (axo=axo_cuota and mes=v_mes))/100), 2)))
        ,catastro_gdl:fn_actualizacion(b.axo_cuota , 1, ((trunc((b.cuota1* (1)), 2))) ) - ((trunc((b.cuota1* (1)), 2)))
        from ta_13_rcmcuotas b where
          b.cementerio=v_cem and b.axo_cuota = v_axo_act;
   end if;
foreach
  select  axo,importe ,recargos,actualizacion   into vpar_axo,vpar_impte, vpar_recar, vpar_actualizacion  from ta_adercm1 
  if not exists (select * from ta_13_adeudosrcm where control_rcm=v_control and axo_adeudo=vpar_axo) then
     --insert into ta_13_adeudosrcm values( 0,v_control,vpar_axo,vpar_impte, vpar_recar,0,0,'V',v_usu,today,null);
     --Se agrega actualizacion
     insert into ta_13_adeudosrcm values( 0,v_control,vpar_axo,vpar_impte, vpar_recar,0,0,vpar_actualizacion,'V',v_usu,today,null);
  -- execute procedure spd_cgmov_cement(today,13, v_control,vpar_impte,vpar_recar, vpar_axo, 1, v_usu);
  else
    select first 1 id_adeudo into v_id from ta_13_adeudosrcm where control_rcm=v_control and  axo_adeudo=vpar_axo;
     update  ta_13_adeudosrcm set importe=vpar_impte, importe_recargos=vpar_recar, vigencia='V', fecha_mov=today, usuario=v_usu 
       ,actualizacion=vpar_actualizacion
       where control_rcm=v_control and  id_adeudo=v_id and vigencia='V';
--       where control_rcm=v_control and  id_adeudo=v_id and vigencia<>'P'; -- asi estaba antes, activaba todos los adeudos diferentes a pagados (cancelados o bajas)
  end if;
 end foreach;  
end if;

if v_axoade<v_axo then
   update ta_13_adeudosrcm set vigencia='B', fecha_mov=today, usuario=v_usu 
   where control_rcm=v_control and vigencia='V' and axo_adeudo<v_axo;
foreach
 select axo_adeudo,importe,importe_recargos,actualizacion
       into v_axoi,v_importe, vpar_recar,vpar_actualizacion
 from ta_13_adeudosrcm where control_rcm=v_control and axo_adeudo<=v_axoi and fecha_mov=today 
    and vigencia='B' and usuario=v_usu
--execute procedure spd_cgmov_cement(today,13, v_control,v_importe,vpar_recar, v_axoi, 2, v_usu);
end foreach;
end if;

drop table ta_adercm1;
end procedure;


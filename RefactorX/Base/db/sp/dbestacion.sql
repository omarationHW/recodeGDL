CREATE PROCEDURE "informix".redondeocaja(nImporte money(15,2))
   RETURNING       money(15,2),money(5,2);
   DEFINE nImp     money(15,2);
   DEFINE nTmp     money(15,2);
   DEFINE nDif     money(5,2);
   DEFINE nDifresto     money(5,2);

   LET nTmp = TRUNC( nImporte );
   LET nDif = nImporte - nTmp;
   LET nDifresto = 0;
   LET nImp = 0;
   
   IF nDif > 0 THEN
      IF ((nDif > 0.00) AND (nDif < 0.25)) THEN
         LET nImp = nTmp;
         LET nDifresto =  nDif * -1;
      END IF;
      IF ((nDif >= 0.25) AND (nDif < 0.50)) THEN
         LET nImp = nTmp + 0.50;
         LET nDifresto = 0.50 - nDif;
      END IF;
      IF (nDif = 0.50) THEN
         LET nDifresto = 0;
         LET nImp = nImporte;
      END IF;
      IF ((nDif > 0.50) AND (nDif < 0.75)) THEN
         LET nImp = nTmp + 0.50;
         LET nDifresto = 0.50 - nDif;
      END IF;
      IF ((nDif >= 0.75) AND (nDif < 1)) THEN
         LET nImp = nTmp + 1;
         LET nDifresto = 1 - nDif;
      END IF;
   ELSE
      LET nImp = nImporte;
   END IF;
   RETURN nImp,nDifresto;
END PROCEDURE;

create procedure "informix".sp_alta_folios(V_axo int ,V_folio int,
V_fecha_folio date,V_placa char(7) , V_infraccion int ,V_estado int ,
v_vigilante int ,  v_capturista  int , v_zona int , v_espacio int) 

returning
int as id,
char(50) as mensaje;
define v_opc int ;
 define v_descrip char(50);
 let v_opc =0;
 let v_descrip = 'Folio Grabado Correctamente';

 begin
    on exception in (-239)
    let v_opc = -1;
    let v_descrip = 'No se Grabo el Folio';
    end exception;
    insert into ta14_folios_adeudo (axo, folio, fecha_folio, placa, infraccion  ,
 estado, vigilante, fec_cap , usu_inicial , zona, espacio) 
values(V_axo ,V_folio,V_fecha_folio,V_placa  , V_infraccion  ,V_estado  ,
v_vigilante, today  ,  v_capturista   , v_zona , v_espacio);
let v_opc =0;
 let v_descrip = 'Folio Grabado Correctamente';
end

return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".sp_descto_folios(V_axo int ,V_folio int,
v_fecha_otorga date,  V_fecha_limite date , v_porc_cobro int ,
  v_clave char(1) ,  v_obs char(100) ,  v_usu_inicial  int, v_opc1 int )

-- para la opcion de 2 solo requieres axo y folio. 
--   para la opcion 1 se requieren todos los parametros.
returning
int as id, char(50) as mensaje;
define v_opc int ;
 define v_descrip char(50);
 let v_opc =0;
 let v_descrip = 'Descuento aplicado Correctamente';
if v_opc1 = 1 then
 begin
    on exception in (-239)
    let v_opc = -1;
    let v_descrip = 'Descuento ya exitente';
    end exception;
insert into ta14_folios_free (
  axo ,  folio,  fecha_otorga ,  fecha_limite ,  porc_cobro, 
  clave ,  obs ,  fec_cap ,  usu_inicial )  values  (
  v_axo,  v_folio,  v_fecha_otorga ,  V_fecha_limite ,  v_porc_cobro,
  v_clave ,  v_obs ,  today,  v_usu_inicial ); 
 
let v_opc =0;
 let v_descrip = 'Descuento Grabado Correctamente';
end
end if;
if v_opc1 = 2 then 
   delete from ta14_folios_free where axo = v_axo and folio = v_folio;
   let v_opc =0;
   let v_descrip = 'Descuento Eliminado Correctamente';
end if;
if (v_opc1 < 1 or v_opc1 > 2) then 
   let v_opc =-1;
   let v_descrip = 'Opcion incorrecta del procedimiento';
end if;
return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".sp_modi_folio(V_axo int ,V_folio int,
V_fecha_folio date,V_placa char(7) , V_infraccion int ,V_estado int ) 

returning
int as id, char(50) as mensaje;
define v_opc int ;
define v_descrip char(50);

 let v_opc =0;
 let v_descrip = 'Folio Grabado Correctamente';

-- begin
--    on exception in (-239)
--    let v_opc = -1;
--    let v_descrip = 'No se Grabo el Folio';
--    end exception;
if exists(select * from ta14_folios_adeudo where  axo = v_axo and  folio = v_folio) then
    update  ta14_folios_adeudo set  placa = V_placa,
 	fecha_folio = V_fecha_folio ,
	infraccion = V_infraccion,
 	estado = V_estado
	where axo = v_axo and  folio = v_folio;
    let v_opc =0;
    let v_descrip = 'Folio Modificado Correctamente';
else
    let v_opc = -1;
    let v_descrip = 'El Folio no Existe';
end if;

return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".sp_rel_folios(opc1 int ,  p_fecha date , p_vigilante int )
returning int as vigilante ,
char(50) as inspector ,int as axo, int as folio, char(7) as placa, date as fecha_folio,
 int as estado, int as infraccion, int as tarifa ,char(20) as status,  char(10) as usuario;



-- inspector , axo,folio,placa, fecha_folio,
--estado, infraccion, tarifa,usuario
 define V_axo int ;
define V_folio int;
define  V_placa char(7) ;
define V_fecha_folio date;
define V_estado int;
define V_infraccion int; 
define V_tarifa money(6,2); 
define V_porc_cobro int ; 
define V_descripcion char(20);
define V_Pago char(20) ;
define V_usu_inicial  char(10);
define V_folionot char(10);
define v_num_acuerdo int;
define v_costo_fijo01 money(6,2);
define  v_ord char(1); 
define v_afec char(1);
define dias_cuantos  integer;
define dia_fecha integer;
define v_fechaval date;
define v_imp_apagar money(6,2);
define v_usuario char(10);
define v_inspector char(50);
define v_status char(20);
define v_vigilante int;
let dias_cuantos = 0;
let v_imp_apagar = 0;
-- por folio individual
if opc1 = 1 then 
   FOREACH

select a.vigilante, 
(trim(nvl(c.ap_pater,'.')) ||  ' ' || trim(nvl(c.ap_mater,'.'))   ||  ' ' || trim(c.nombre)) inspector
, a.axo,a.folio, a.placa, a.fecha_folio, a.estado,
a.infraccion , b.tarifa, 'Vigente' , x.usuario 
into v_vigilante, v_inspector, v_axo,v_folio, v_placa, v_fecha_folio, v_estado,
v_infraccion ,v_tarifa,v_status,v_usuario
from ta14_folios_adeudo a , TA14_tarifas b , ta14_personas c  ,conexion x 


where a.fecha_folio = p_fecha  
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and a.vigilante = c.id_esta_persona and a.usu_inicial =  x.id_usuario order by 1,3,4
 return  v_vigilante,v_inspector, V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,v_status, V_usuario
  with resume;
  END FOREACH;
 FOREACH
select a.vigilante, 
(trim(nvl(c.ap_pater,'.')) ||  ' ' || trim(nvl(c.ap_mater,'.'))   ||  ' ' || trim(c.nombre)) inspector
, a.axo,a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion , b.tarifa, 
d.descripcion , x.usuario
into  v_vigilante, v_inspector, v_axo,v_folio, v_placa, v_fecha_folio, v_estado,
v_infraccion ,v_tarifa,v_status , v_usuario
from ta14_folios_histo a , TA14_tarifas b , ta14_personas c , ta14_codigomovtos d, conexion x
where a.fecha_folio = p_fecha 
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and a.vigilante = c.id_esta_persona 
and a.codigo_movto = d.codigo_movto and a.usu_inicial =  x.id_usuario
order by 1,3,4

--and a.vigilante = :vigila


 return  v_vigilante,v_inspector, V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,v_status, V_usuario
  with resume;

  END FOREACH;
end if;

if opc1 = 2 then 
   FOREACH

select a.vigilante, 
(trim(nvl(c.ap_pater,'.')) ||  ' ' || trim(nvl(c.ap_mater,'.'))   ||  ' ' || trim(c.nombre)) inspector
, a.axo,a.folio, a.placa, a.fecha_folio, a.estado,
a.infraccion , b.tarifa, 'Vigente' , x.usuario 
into v_vigilante, v_inspector, v_axo,v_folio, v_placa, v_fecha_folio, v_estado,
v_infraccion ,v_tarifa,v_status,v_usuario
from ta14_folios_adeudo a , TA14_tarifas b , ta14_personas c  ,conexion x 


where a.fec_cap = p_fecha  
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and a.vigilante = c.id_esta_persona and a.usu_inicial =  x.id_usuario order by 1,3,4
 return  v_vigilante,v_inspector, V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,v_status, V_usuario
  with resume;
  END FOREACH;
 FOREACH
select a.vigilante, 
(trim(nvl(c.ap_pater,'.')) ||  ' ' || trim(nvl(c.ap_mater,'.'))   ||  ' ' || trim(c.nombre)) inspector
, a.axo,a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion , b.tarifa, 
d.descripcion , x.usuario
into  v_vigilante, v_inspector, v_axo,v_folio, v_placa, v_fecha_folio, v_estado,
v_infraccion ,v_tarifa,v_status , v_usuario
from ta14_folios_histo a , TA14_tarifas b , ta14_personas c , ta14_codigomovtos d, conexion x
where a.fec_cap = p_fecha 
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and a.vigilante = c.id_esta_persona 
and a.codigo_movto = d.codigo_movto and a.usu_inicial =  x.id_usuario
order by 1,3,4

--and a.vigilante = :vigila


 return  v_vigilante,v_inspector, V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,v_status, V_usuario
  with resume;

  END FOREACH;
end if;
-- para pago
if opc1 = 3 then 
 FOREACH
select a.vigilante, 
(trim(nvl(c.ap_pater,'.')) ||  ' ' || trim(nvl(c.ap_mater,'.'))   ||  ' ' || trim(c.nombre)) inspector
, a.axo,a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion , b.tarifa, 
d.descripcion , x.usuario
into  v_vigilante, v_inspector, v_axo,v_folio, v_placa, v_fecha_folio, v_estado,
v_infraccion ,v_tarifa,v_status , v_usuario
from ta14_folios_histo a , TA14_tarifas b , ta14_personas c , ta14_codigomovtos d, conexion x
where a.fecha_movto = p_fecha 
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and a.vigilante = c.id_esta_persona 
and a.codigo_movto = d.codigo_movto and a.usu_bajaauto =  x.id_usuario
order by 1,3,4



--and a.vigilante = :vigila


 return  v_vigilante,v_inspector, V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,v_status, V_usuario
  with resume;

  END FOREACH;
end if;
END PROCEDURE;

create procedure "informix".sp_rel_folpag(opc1 int ,  p_fecha date , p_reca int )
returning  smallint as reca , char(2) as caja , int as operacion ,
  int as axo, int as folio, char(7) as placa, date as fecha_folio,
 int as estado, int as infraccion , money(6,2) as tarifa, varchar(20) as codigo_movto;
-- inspector , axo,folio,placa, fecha_folio,
--estado, infraccion, tarifa,usuario
define v_reca smallint; define v_caja char(2); define  v_operacion int; 
 define V_axo int ;define V_folio int;define  V_placa char(7) ;
define V_fecha_folio date;define V_estado int;define V_infraccion int; 
define v_codigo_movto varchar(20); define V_tarifa money(6,2); 
define V_porc_cobro int ; define V_descripcion char(20);
define V_Pago char(20) ; define V_usu_inicial  char(10);
define V_folionot char(10); define v_num_acuerdo int;
define v_costo_fijo01 money(6,2);  
if p_reca = 9 then
   let opc1 = 2;
end if;

-- para recaudadora individual
if opc1 = 1 then 
   FOREACH
select rp.reca , rp.caja , rp.operacion , a.axo, a.folio, a.placa, a.fecha_folio,
 a.estado, a.infraccion , b.tarifa, c.descripcion
into v_reca , v_caja , v_operacion , v_axo, v_folio, v_placa, v_fecha_folio,
 v_estado, v_infraccion ,v_tarifa, v_codigo_movto
 from ta14_refrecibo rp, ta14_folios_histo a , TA14_tarifas b , ta14_codigomovtos c
where rp.reca = p_reca and rp.fecha_recibo = p_fecha
 and rp.control = a.control  and a.infraccion = b.num_clave  and
 a.fecha_folio between b.fecha_inicial and b.fecha_fin and c.codigo_movto = a.codigo_movto
 order by 1,2,3,5,4
   
 return  v_reca , v_caja , v_operacion , v_axo, v_folio, v_placa, v_fecha_folio,
 v_estado, v_infraccion ,v_tarifa, v_codigo_movto  with resume;
  END FOREACH;
 
end if;
if opc1 = 2 then 
   FOREACH
select rp.reca , rp.caja , rp.operacion , a.axo, a.folio, a.placa, a.fecha_folio,
 a.estado, a.infraccion , b.tarifa, c.descripcion
into v_reca , v_caja , v_operacion , v_axo, v_folio, v_placa, v_fecha_folio,
 v_estado, v_infraccion ,v_tarifa, v_codigo_movto
 from ta14_refrecibo rp, ta14_folios_histo a , TA14_tarifas b , ta14_codigomovtos c
where  rp.fecha_recibo = p_fecha
 and rp.control = a.control  and a.infraccion = b.num_clave  and
 a.fecha_folio between b.fecha_inicial and b.fecha_fin and c.codigo_movto = a.codigo_movto
 order by 1,2,3,5,4
   
 return  v_reca , v_caja , v_operacion , v_axo, v_folio, v_placa, v_fecha_folio,
 v_estado, v_infraccion ,v_tarifa, v_codigo_movto  with resume;
  END FOREACH;
 
end if;


END PROCEDURE;

create procedure "informix".sp_valida_fol_alta(V_axo int ,V_folio int,
V_placa char(7), v_fecha date , V_infraccion int , v_hora  datetime hour to minute) 

returning
int as id,
char(50) as mensaje;

-- validar que no exista el folio
-- validar que sea a otra placa el folio capturado

define v_opc int ;
 define v_descrip char(50);
define p_placa char(7);
define p_numcalco int;
define p_turno char(1); 
define p_hora_ini datetime hour to minute; 
define p_hora_fin datetime hour to minute;

select nvl(placa, '0') into p_placa from ta14_folios_adeudo where axo = v_axo and folio = v_folio;
if p_placa is null then
   let v_opc =0;
   let v_descrip = 'Procede captura';
else
if p_placa = v_placa then
   let v_opc = -1;
   let v_descrip = 'Folio ya capturado a la placa ';
else
    let v_opc = -2;
   let v_descrip = 'Folio ya capturado a diferente placa ';
end if;
end if;

-- validar que calcomania verifica tipo y horario solo para infraccion 1

if v_opc = 0 and v_infraccion = 1 then
 select nvl(a.num_calco,0), nvl(a.turno,'0') , b.hora_ini , b.hora_fin
 into p_numcalco , p_turno , p_hora_ini , p_hora_fin 
 from ta14_calcomanias a , ta14_turnos b 
 where a.placa = v_placa  and v_fecha between a.fecha_inicial and a.fecha_fin  and
       a.turno = b.turno;

 if p_numcalco > 0 then
    if v_hora >= p_hora_ini and v_hora <= p_hora_fin then
        let v_opc = -3;
        let v_descrip = 'Tiene calcomania en Horario ';
    end if;
  end if;
end if;
    
return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".spd14_cancecaj01(
		parfecha   date,
                                parreca      smallint,
                                parcaja      char(2),
                                paroperacion  integer,
                                parOpcion  smallint
		)
		returning smallint as id,  char(200) as mensaje ;

define varok   smallint;
define varobs char(200);

           let varok = 0;
          let varobs = 'No se efectuo ninguna Operaci�n';          

--set debug file to "c:\ivan.log";
--trace on;



if (paropcion = 1)  then

      insert into ta14_folios_adeudo 
               select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio       
                from  ta14_refrecibo a , ta14_folios_histo b  
              where  a.fecha_recibo = parfecha and  a.reca = parreca and   a.caja = parcaja and a.operacion = paroperacion and  a.control = b.control ;
        
   delete  from ta14_folios_histo 
              where  control in (select control from ta14_refrecibo where  fecha_recibo = parfecha and  reca = parreca and   caja = parcaja and operacion = paroperacion );

   delete from ta14_refrecibo 
              where  fecha_recibo = parfecha and  reca = parreca and   caja = parcaja and operacion = paroperacion ;

    let varok = 1;
     let varobs = 'se Regresa la informacion de este recibo a estacionometros correctamente';

end if;



if (paropcion = 2)  then

     
   delete  from ta14_calcomanias 
              where    fecha_pago = parfecha and  reca = parreca and   caja = parcaja and operacion = paroperacion ;

    let varok = 1;
     let varobs = 'Se Regresa la informacion de este recibo a CALCOMANIAS correctamente';

end if;


return varok, varobs;
--trace off;



end procedure
;

create procedure "informix".spd14_cancecaj02(
		parfecha   date,
                                parreca      smallint,
                                parcaja      char(2),
                                paroperacion  integer,
                                parOpcion  smallint
		)
		returning smallint,  char(200) ;

define varok   smallint;
define varobs char(200);

           let varok = 0;
          let varobs = 'No se efectuo ninguna Operaci�n';          

--set debug file to "c:\ivan.log";
--trace on;



if (paropcion = 1)  then

      insert into ta14_folios_adeudo 
               select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio       
                from  ta14_refrecibo a , ta14_folios_histo b  
              where  a.fecha_recibo = parfecha and  a.reca = parreca and   a.caja = parcaja and a.operacion = paroperacion and  a.control = b.control ;



       update ta14_notifica_edo set origen_pago = null ,  fechapago = null , gasto = 0 where num_acuerdo = 
   ( select  distinct num_acuerdo    
                from  ta14_refrecibo a , ta14_folios_histo b  
              where  a.fecha_recibo = parfecha and  a.reca = parreca and   a.caja = parcaja and a.operacion = paroperacion and  a.control = b.control 
)    ;


        
   delete  from ta14_folios_histo 
              where  control in (select control from ta14_refrecibo where  fecha_recibo = parfecha and  reca = parreca and   caja = parcaja and operacion = paroperacion );

   delete from ta14_refrecibo 
              where  fecha_recibo = parfecha and  reca = parreca and   caja = parcaja and operacion = paroperacion ;

    let varok = 1;
     let varobs = 'se Regresa la informacion de este recibo a estacionometros correctamente';

end if;



if (paropcion = 2)  then

     
   delete  from ta14_calcomanias 
              where    fecha_pago = parfecha and  reca = parreca and   caja = parcaja and operacion = paroperacion ;

    let varok = 1;
     let varobs = 'Se Regresa la informacion de este recibo a CALCOMANIAS correctamente';

end if;


return varok, varobs;
--trace off;



end procedure
;

create procedure "informix".spd14_conscel (parPlaca char(7))
				
	 returning char(150);

define varok   smallint;

define varcontrol, vfolio, vporc_cobro, vsqlporc_cobro, vacuerdo, dias_cuantos, cuantos_folios, dias_habil, vctaapl, vctagastos 	integer;
define vaxo, vestado, vinfra 											smallint; 
define vfecha, vfecha_ini, vfecha_fin, fecha_hoy, x1, x2 								date;
define vtarifa, vTot_apagar, vimp_apagar, vTotgastos, vimpgastos 							money(7,2);


if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then

	Let varok = 0;
	Let cuantos_folios = 0;
	Let vTot_apagar = 0;
	Let vTotgastos = 0;

	foreach 
	Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
	into 
		vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
	from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
		where a.placa = parplaca and a.infraccion = b.num_clave 
		and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
		a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
		order by 3 asc

	--- para obtener dias de vencimiento;

	let fecha_hoy = today;
	let x1 = vfecha;
	let x2 = vfecha;
	let dias_cuantos = 0;
	let dias_habil = 0;

	select count(*)  into dias_habil from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     	while x1 <= fecha_hoy 
        		IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          			let dias_cuantos =dias_cuantos+1;
         		end if;
     	let x1 = x1+1;
   	end while;

	let dias_cuantos =  dias_cuantos - dias_habil ;

	--para calcular el valor de la multa;
	if (vinfra <=4) and (dias_cuantos<=6) then
      		let vporc_cobro = 50 ;
   	else
     		let  vporc_cobro = 100;
	end if;
  	if vsqlporc_cobro <> 100 then
     		let vporc_cobro = vsqlporc_cobro;
  	end if;
     	let vimp_apagar = vporc_cobro / 100 * vtarifa;
  
	if vacuerdo > 0 then
   		let vimpgastos = 101.92;
	else
   		let vimpgastos = 0;
	end if;

	Let varok = 1;
	Let cuantos_folios = cuantos_folios + 1;
	Let vTot_apagar = vTot_apagar + vimp_apagar;
	Let vTotgastos = vTotgastos + vimpgastos;
	if cuantos_folios > 1 then
		Let vfecha_fin = vfecha;
	else
		Let vfecha_ini = vfecha;
	end if;

	end foreach;
else
	Let varok = 0;
end if;

if varok = 0 then
                return 'No existen folios para esta placa, Gracias por utilizar nuestro servicio';
else
	if cuantos_folios > 1 then
		return 'La placa tiene  ' || cuantos_folios || ' folios en el periodo del  '  ||  vfecha_ini  ||  '--'  ||  vfecha_fin  ||  
		' TOTAL A PAGAR ' ||  vTot_apagar + vTotgastos  || ' --SI PAGA HOY- ' || fecha_hoy || ' EN CUALQUIER RECAUDADORA';
	else
		return 'La placa tiene el folio ' || vfolio || '--'  ||  vaxo  ||  '  con la fecha del  '  ||  vfecha  ||  
		' TOTAL A PAGAR ' ||  vTot_apagar + vTotgastos  || ' --SI PAGA HOY- ' || fecha_hoy || ' EN CUALQUIER RECAUDADORA';
	end if;
end if;
end procedure
;

create procedure "informix".spd14_pgsbanorte (Per1 Date, Per2 Date, Remesa CHAR(20))
--   GENERA UN ARCHIVO DE FOLIOS EN DONDE YA CON ANTERIORIDAD SE HAYA ENVIADO EL ALTA Y NO EXISTA EL ENVIO DEL PAGO
--   RETORNA LA CANTIDAD DE REGISTROS PARA SU ENVIO AL ESTADO
	returning  int;

  DEFINE v_Mpio, vReg_Grabados		Integer;
  DEFINE v_TipoAct 			Char(2);
  DEFINE v_Folio, v_Folio1			CHAR(12);
  DEFINE v_Placa				CHAR(9);
  DEFINE v_Folioecmpio			CHAR(50);	
  DEFINE v_Fechapago, v_Fechaalta		Date;

  Let vReg_Grabados = 0;

    foreach
                      Select 113 Municipio, "PN" TipoAct, (a.Folio) Folio, (trunc((a.axo* 10000000) + a.folio)) || '' Folio1, a.Placa, (a.Fecha_movto) Fechapago, 
		(a.Fecha_folio) Fechaalta, 'Pagado en Banorte  ' || a.Fecha_movto Folioecmpio
                           into v_Mpio, v_TipoAct, v_Folio, v_Folio1, v_Placa, v_Fechapago, 
		v_Fechaalta, v_Folioecmpio
                      from ta14_folios_histo a, ta14_datos_mpio b
                      where a.fecha_movto between Per1 and Per2 and a.codigo_movto = 10 
                          and b.Placa = a.Placa
                          and b.Folio = (trunc((a.axo* 10000000) + a.folio)) || ''
	          and b.tipoact = 'A'

		if not exists ( Select Folio, Placa from ta14_datos_mpio Where Folio = v_Folio1 and Placa = v_Placa and tipoact = 'PN' ) then
			Let vReg_Grabados = vReg_Grabados + 1;
                       		insert into ta14_datos_mpio values
                               		( v_Mpio, v_TipoAct, v_Folio1, Null, v_Placa, Null, Null, v_Fechapago, Null, Null, Null, v_Fechaalta, Null, Null, v_Folioecmpio, Null, Remesa, Today );
		end if;
    end foreach;
    return vReg_Grabados;

end procedure
;

CREATE PROCEDURE "informix".sp_analit_folios (opc int)

returning

int as axo ,int as infraccion,  money(12,2) as tarifa  , int as folio,  money(12,2) as importe ;
--int ,int ,  money(12,2),int ,money(12,2) ;
define V_axo int ;

define  V_folio int ;

define V_tarifa int ;
define v_Tarif_imp money(12,2);
define v_importe money(12,2);

-- folios con adeudo

if opc = 1 then

   FOREACH

select a.axo ,a.infraccion  , b.tarifa ,  count(a.folio) totfol , sum( b.tarifa) totimp  

into V_axo, V_tarifa, v_Tarif_imp, V_folio,v_importe

from ta14_folios_adeudo a , ta14_tarifas b  where a.infraccion = b.num_clave 

and a.fecha_folio between b.fecha_inicial and b.fecha_fin  

group by a.axo, a.infraccion, b.tarifa order by a.axo, a.infraccion   

return V_axo, V_tarifa, v_Tarif_imp, V_folio, v_importe with resume;

 
 END FOREACH;

end if;

--  folios pagados

if opc = 2 then

   FOREACH

select a.axo ,a.infraccion  , b.tarifa ,  count(a.folio) totfol , sum( b.tarifa) totimp  

into V_axo, V_tarifa, v_Tarif_imp, V_folio,v_importe

from ta14_folios_histo a , ta14_tarifas b  where a.codigo_movto in(3,4,6,10,13) and 

 a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin   

group by a.axo, a.infraccion, b.tarifa order by a.axo, a.infraccion  

return V_axo, V_tarifa, v_Tarif_imp, V_folio, v_importe with resume;

 END FOREACH;

end if;

--  folios canceladas y condonadas

if opc = 3 then

   FOREACH

select a.axo ,a.infraccion  , b.tarifa ,  count(a.folio) totfol , sum( b.tarifa) totimp  

into V_axo, V_tarifa, v_Tarif_imp, V_folio,v_importe

from ta14_folios_histo a , ta14_tarifas b  where a.codigo_movto not in(3,4,6,10,13) and 

 a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin   

group by a.axo, a.infraccion, b.tarifa order by a.axo, a.infraccion    

 

return V_axo, V_tarifa, v_Tarif_imp, V_folio, v_importe with resume;

 END FOREACH;

end if;

if opc > 4 then

   return 0,0,0,0,0;

end if;

end procedure;

CREATE PROCEDURE "informix".cajero_park_del01(
		paraxo smallint,
                                parfolio  integer,
		parPlaca char(7),
		parconvenio  integer,
                                parfecha   date,
                                parreca      smallint,
                                parcaja      char(2),
                                paroperacion  integer,
                                parusuauto  integer,
		parOpcion  smallint
		)
		returning smallint,  char(200) ;

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
           let varok = 0;
          let varobs = '';          

--set debug file to "c:\ivan.log";
--trace on;

--opcion 1 consulta del disponible.

if (paropcion = 1) or (paropcion = 2)  or (paropcion = 5) or (paropcion = 15)  or (paropcion = 16) then
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio  from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'Condonaci�n de Folio o Error de captura';

end if;
-- pago por folio de recaudadora;
if (paropcion = 3)  then
      select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
  if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
    let varok = 1;
     let varobs = 'pago hecho correctamente';

end if;
-- pago por folio de recaudadora cajero;
if (paropcion = 13)  then
     select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
--- Cuando hay notificaciones del estado.


    if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
       let varok = 1; 
       let varobs = 'pago hecho correctamente';

end if;

if (paropcion = 4)  then

       foreach 
              select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio  from ta14_folios_adeudo  where placa = parplaca
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = vaxo and folio = vfolio;
   end foreach;
    let varok = 1;
     let varobs = 'pago hecho por placa correctamente';

end if;


if (paropcion = 6)  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
                          
                           
else
  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 6                
	 ) then
                 
        select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
    let varok = 1;
     let varobs = 'pago hecho correctamente';
   else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';
      
end if;
end if;

end if;

if (paropcion = 7 )  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
      else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';                     
                          
end if;

end if;

-- BANORTE

if (paropcion = 10)  then
   let varok = 10;
   if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio 
 	 ) then
        select placa into vplaca from ta14_folios_adeudo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
    if ban_placa = vplaca then

      insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
      delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 0 
     where axo = paraxo and folio = parfolio ;

     let varobs = 'pago hecho correctamente';
    let varok = 0;
  else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varok = 0;
  end if;

end if;
                      
                           

  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 10             
	 ) then

        select placa into vplaca from ta14_folios_histo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
      if ban_placa = vplaca then          
    
             select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
         insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 1 
     where axo = paraxo and folio = parfolio ;
    let varobs = 'pago hecho correctamente con pago doble de otro medio';
    let varok = 1;
    else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varobs = 'Folio no coincide la placa';
    let varok = 1;
    end if;
  
    
   else      
    if varok = 10 then

     -- no se insertaran los datos nuevos por que existen muchos errores de los archivos del Banco;
     --select  fecha_folio, placa, infraccion   into vfecha , vplaca , vinfra from ta14_fol_banorte  where axo = paraxo and folio = parfolio ; 
     --insert into ta14_folios_histo   values ( 0,today,    paraxo, parfolio, vfecha, vplaca, vinfra , 14, 999 , null, today, parusuauto, paropcion, parusuauto, 0 , 0);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;

        
          let varok = 0;
          let varobs = 'se inserta para estos datos lectura';
    end if; 
end if;

end if;




return varok, varobs;
--trace off;



end procedure
;

CREATE PROCEDURE "informix".spd_delesta01r(
		paraxo smallint,
                                parfolio  integer,
		parPlaca char(7),
		parconvenio  integer,
                                parfecha   date,
                                parreca      smallint,
                                parcaja      char(2),
                                paroperacion  integer,
                                parusuauto  integer,
                parautoriza char(20),
                parobs char(50),
		parOpcion  smallint
		)
		returning smallint as id,  char(200) as mensaje ;

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
           let varok = 0;
          let varobs = '';          

--set debug file to "c:\ivan.log";
--trace on;

--opcion 1 consulta del disponible.

if (paropcion = 1)  or (paropcion = 5)  then
   if exists(select * from ta14_folios_adeudo where  axo = paraxo and  folio = parfolio) then
      insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio  from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
     let varok = 0;
    if paropcion = 1 then
    let varobs = 'Baja por Error de captura, Aplicada Correctamente';
     end if;
   if paropcion = 5 then
    let varobs = 'Condonaci�n de Folio, Correcto';
     end if;
else
    let varok = -1;
    let varobs = 'El Folio no Existe';

end if;
     

end if;
-- pago por folio de recaudadora;
if (paropcion = 3)  then
      select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
  if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
    let varok = 0;
     let varobs = 'Pago aplicado correctamente';

end if;
-- Condonacion, prescripcion, sentencia de juzgado;
if  (paropcion = 17) or (paropcion = 15)  or (paropcion = 16) or (paropcion = 18)  or (paropcion = 19) then
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_condonado (control,   autoriza  ,  observacion) 
     values ( varcontrol , parautoriza, parobs);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

    let varok = 0;
     let varobs = 'Condonacion aplicada correctamente';

end if;


-- pago por folio de recaudadora cajero;
if (paropcion = 13)  then
     select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
--- Cuando hay notificaciones del estado.


    if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
       let varok = 0; 
       let varobs = 'Pago aplicado correctamente';

end if;

if (paropcion = 4)  then

       foreach 
              select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio  from ta14_folios_adeudo  where placa = parplaca
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = vaxo and folio = vfolio;
   end foreach;
    let varok = 0;
     let varobs = 'Pago aplicado por placa correctamente';

end if;


if (paropcion = 6)  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 0;
     let varobs = 'pago aplicado correctamente';
                          
                           
else
  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 6                
	 ) then
                 
        select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
    let varok = 0;
     let varobs = 'pago aplicado correctamente';
   else                
          let varok = 1;
          let varobs = 'No existe registo para estos datos lectura';
      
end if;
end if;

end if;

if (paropcion = 7 )  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 0;
     let varobs = 'Pago aplicado correctamente';
      else                
          let varok = 1;
          let varobs = 'No existe registo para estos datos lectura';                     
                          
end if;

end if;

-- BANORTE

if (paropcion = 10)  then
   let varok = 10;
   if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio 
 	 ) then
        select placa into vplaca from ta14_folios_adeudo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
    if ban_placa = vplaca then

      insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
      delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 0 
     where axo = paraxo and folio = parfolio ;

     let varobs = 'Pago aplicado correctamente';
    let varok = 0;
  else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varok = 0;
  end if;

end if;
                      
                           

  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 10             
	 ) then

        select placa into vplaca from ta14_folios_histo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
      if ban_placa = vplaca then          
    
             select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
         insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 1 
     where axo = paraxo and folio = parfolio ;
    let varobs = 'Pago aplicado correctamente con pago doble de otro medio';
    let varok = 0;
    else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varobs = 'Folio no coincide la placa';
    let varok = 1;
    end if;
  
    
   else      
    if varok = 10 then

     -- no se insertaran los datos nuevos por que existen muchos errores de los archivos del Banco;
     --select  fecha_folio, placa, infraccion   into vfecha , vplaca , vinfra from ta14_fol_banorte  where axo = paraxo and folio = parfolio ; 
     --insert into ta14_folios_histo   values ( 0,today,    paraxo, parfolio, vfecha, vplaca, vinfra , 14, 999 , null, today, parusuauto, paropcion, parusuauto, 0 , 0);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;

        
          let varok = 0;
          let varobs = 'Solo se actualiza Banco, Correctamente';
    end if; 
end if;

end if;




return varok, varobs;
--trace off;



end procedure
;

create procedure "informix".set_claveusuario(p_id_usuario int,p_usuario char(10),p_clavenva char(20))
returning
int as id, char(50) as mensaje;
define v_opc int ;
define v_descrip char(50);
 let v_opc =0;
 let v_descrip = 'Clave Cambiada Correctamente';
if exists(select * from conexion where id_usuario=p_id_usuario and usuario=p_usuario) then
   update conexion set clave=p_clavenva where id_usuario=p_id_usuario and usuario=p_usuario;
else
    let v_opc = -1;
    let v_descrip = 'El Usuario no Existe';
end if;

return v_opc , v_descrip ;
end procedure;

CREATE PROCEDURE "informix".spd_remesa_ind (p_Opc Int, p_Placa Char(7), p_Folios Char(200), p_Fec_Ini Date, p_Fec_Fin Date, p_NumRem Int, p_Remesa Char(20))
returning int as status , varchar(200) as obs;

DEFINE v_cuantos                          Integer;    
DEFINE obs                            VarChar(200);

DEFINE v_Folio, v_c_i, v_c_f, x Integer;
DEFINE x_1, x_2, xy                       Integer;
DEFINE separador                                          Char(1);

LET separador = ',';
LET obs = '';
LET v_Folio = 0;
LET x = 0;
LET v_c_i = 1;
LET v_c_f = 1;
LET x_1 = 1;
LET xy = length(p_Folios);

IF p_Opc = 0  THEN 
LET v_Folio = 0;
LET x = 0;
LET v_c_i = 1;
LET v_c_f = 1;
LET x_1 = 1;
LET xy = length(p_Folios) ;

  for x = 1 to xy 
    if x = 1 then
       if (Trim(substr(p_Folios, x_1, 1) )<> ',') then
          Let x_1 = x_1 + 1;
       end if;
    else
       if (substr(p_Folios,x_1,1) = ",") then
          LET v_Folio = substr(p_Folios,v_c_i, v_c_f);
                INSERT INTO ta14_datos_mpio                                                          
                SELECT 113 Municipio, "PN" tipoact,  (trunc((a.axo* 10000000) + a.folio)) Folio , "" fechagenreq, a.placa , 
                                   "" folionot , "" fechanot, b.fecha_recibo fechapago, "" fechacancelado, "" tarifa , "" claveinf, a.fecha_folio fechaalta, 
                                   "" fechavenci, "" folioec, ( reca || "-" || fecha_recibo || "-" || caja || "-" || operacion )  folioecmpio, "" gastos, 
                                   p_Remesa,   (today ) fecharem
                FROM ta14_folios_histo a  , ta14_refrecibo b 
                WHERE a.placa = p_Placa AND a.folio IN (v_Folio) 
                      AND a.num_acuerdo IS NULL AND a.control = b.control ;
          Let x_1 = x_1 + 1;
          LET v_c_i = x_1;
          LET v_c_f = 0;   
       else
          LET v_c_f = v_c_f + 1;
          Let x_1 = x_1 + 1;
       end if;
    end if;
  end for;
  if substr(p_Folios,v_c_i, v_c_f) <> '' then
     LET v_Folio = substr(p_Folios,v_c_i, v_c_f);
                INSERT INTO ta14_datos_mpio                                                          
                SELECT 113 Municipio, "PN" tipoact,  (trunc((a.axo* 10000000) + a.folio)) Folio , "" fechagenreq, a.placa , 
                                   "" folionot , "" fechanot, b.fecha_recibo fechapago, "" fechacancelado, "" tarifa , "" claveinf, a.fecha_folio fechaalta, 
                                   "" fechavenci, "" folioec, ( reca || "-" || fecha_recibo || "-" || caja || "-" || operacion )  folioecmpio, "" gastos, 
                                   p_Remesa,   (today ) fecharem
                FROM ta14_folios_histo a  , ta14_refrecibo b 
                WHERE a.placa = p_Placa AND a.folio IN (v_Folio) 
                      AND a.num_acuerdo IS NULL AND a.control = b.control ;
  end if;
END IF;

-- PAGO NORMAL EN BANORTE
IF p_Opc = 1 THEN                                                                                                                        
LET v_Folio = 0;
LET x = 0;
LET v_c_i = 1;
LET v_c_f = 1;
LET x_1 = 1;
LET xy = length(p_Folios) ;

  for x = 1 to xy 
    if x = 1 then
       if (Trim(substr(p_Folios, x_1, 1) )<> ',') then
          Let x_1 = x_1 + 1;
       end if;
    else
       if (substr(p_Folios,x_1,1) = ",") then
          LET v_Folio = substr(p_Folios,v_c_i, v_c_f);
                INSERT INTO ta14_datos_mpio                                                          
                SELECT 113 Municipio, "PN" tipoact,  (trunc((a.axo* 10000000) + a.folio)) Folio , "" fechagenreq, a.placa , 
                                    "" folionot , "" fechanot, b.fec_pago fechapago, "" fechacancelado, "" tarifa , "" claveinf, a.fecha_folio fechaalta, 
                                    "" fechavenci, "" folioec, "Pago en Banorte  " || a.Fecha_movto Folioecmpio, "" gastos, 
                                    p_Remesa,   (today ) fecharem
                FROM ta14_folios_histo a  , ta14_fol_banorte b 
                WHERE a.codigo_movto  IN (10) AND a.placa = p_Placa AND a.folio IN (v_Folio) 
                      AND b.axo = a.axo AND b.folio = a.folio ;
          Let x_1 = x_1 + 1;
          LET v_c_i = x_1;
          LET v_c_f = 0;   
       else
          LET v_c_f = v_c_f + 1;
          Let x_1 = x_1 + 1;
       end if;
    end if;
  end for;
  if substr(p_Folios,v_c_i, v_c_f) <> '' then
     LET v_Folio = substr(p_Folios,v_c_i, v_c_f);
                INSERT INTO ta14_datos_mpio                                                          
                SELECT 113 Municipio, "PN" tipoact,  (trunc((a.axo* 10000000) + a.folio)) Folio , "" fechagenreq, a.placa , 
                                    "" folionot , "" fechanot, b.fec_pago fechapago, "" fechacancelado, "" tarifa , "" claveinf, a.fecha_folio fechaalta, 
                                    "" fechavenci, "" folioec, "Pago en Banorte  " || a.Fecha_movto Folioecmpio, "" gastos, 
                                    p_Remesa,   (today ) fecharem
                FROM ta14_folios_histo a  , ta14_fol_banorte b 
                WHERE a.codigo_movto  IN (10) AND a.placa = p_Placa AND a.folio IN (v_Folio) 
                      AND b.axo = a.axo AND b.folio = a.folio ;
  end if;
END IF;

-- CANCELACIONES
IF p_Opc = 2 THEN                                       
LET v_Folio = 0;
LET x = 0;
LET v_c_i = 1;
LET v_c_f = 1;
LET x_1 = 1;
LET xy = length(p_Folios) ;

  for x = 1 to xy 
    if x = 1 then
       if (Trim(substr(p_Folios, x_1, 1) )<> ',') then
          Let x_1 = x_1 + 1;
       end if;
    else
       if (substr(p_Folios,x_1,1) = ",") then
          LET v_Folio = substr(p_Folios,v_c_i, v_c_f);
                INSERT INTO ta14_datos_mpio                                                          
                SELECT 113 Municipio, "C", (trunc((a.axo* 10000000) + a.folio)  ) || '' Folio , '' fechagenreq, a.placa, 
                                    '' folionot, '' fechanot, '' fechapago, fecha_movto fechacancelado, '' tarifa , 
                                    '' claveinf, a.fecha_folio fechaalta, '' fechavenci, '' folioec, '' folioecmpio, '' gastos, 
                                    p_Remesa, today fecharem
                FROM ta14_folios_histo a  
                WHERE a.placa = p_Placa AND a.folio IN (v_Folio) ;
          Let x_1 = x_1 + 1;
          LET v_c_i = x_1;
          LET v_c_f = 0;   
       else
          LET v_c_f = v_c_f + 1;
          Let x_1 = x_1 + 1;
       end if;
    end if;
  end for;
  if substr(p_Folios,v_c_i, v_c_f) <> '' then
     LET v_Folio = substr(p_Folios,v_c_i, v_c_f);
                INSERT INTO ta14_datos_mpio                                                          
                SELECT 113 Municipio, "C", (trunc((a.axo* 10000000) + a.folio)  ) || '' Folio , '' fechagenreq, a.placa, 
                                    '' folionot, '' fechanot, '' fechapago, fecha_movto fechacancelado, '' tarifa , 
                                    '' claveinf, a.fecha_folio fechaalta, '' fechavenci, '' folioec, '' folioecmpio, '' gastos, 
                                    p_Remesa, today fecharem
                FROM ta14_folios_histo a  
                WHERE a.placa = p_Placa AND a.folio IN (v_Folio) ;
  end if;
END IF;

       SELECT count(*) cuantos INTO v_cuantos FROM ta14_datos_mpio WHERE remesa = p_Remesa;
       INSERT INTO ta14_Bitacora values (0, 'C', p_Fec_Ini, p_Fec_Fin, today, p_NumRem, v_cuantos);
       if v_cuantos is null then
          return -1 , 'No genero registro para enviar al SECFIN';
       else
            if p_Opc = 0 THEN
               let obs = v_cuantos || '  Registros de Pagos Normales en Recaudadora para enviar al SECFIN';
            end if;
            if p_Opc = 1 THEN
               let obs = v_cuantos || '  Registros de Pagos Normales en Banorte para enviar al SECFIN';
            end if;
            if p_Opc = 2 THEN
               let obs = v_cuantos || '  Registros de Cancelaciones para enviar al SECFIN';
            end if;
        return 0, obs;
        end if; 

END PROCEDURE
;

create procedure "informix".x()
returning varchar(30);
define v_cvecatnva char(15);

select cvecatnva 
 into v_cvecatnva 
from catastro_gdl@catastro_shm:convcta where cvecuenta =  22;

return v_cvecatnva ;
end procedure;

create procedure "informix".sppubalta(p_pubcategoria_id int, p_numesta int, p_sector char(1),p_zona int, p_subzona int, 
  p_numlicencia  int, p_axolicencias int, p_cvecuenta int, p_nombre varchar(100) , p_calle varchar(100),
  p_numext varchar(6), p_telefono varchar(15) , p_cupo int, p_fecha_at date,
  p_fecha_inicial date, p_fecha_vencimiento date,    p_rfc varchar(13), 
  p_movtos_no int,    p_movto_cve char(1), p_movto_usr int, p_solicitud int , p_control int )

returning
int as result , varchar(100) as resultstr,  int as idnvo ;
define result int;
define resultstr varchar(10);
define  v_idnvo int;
define axo_1 int;
define mes_1 int;
define axo_2 int;
define rsopc int ; define messag char(50);
--set debug file to "pubesta.log";
--trace on;
if not exists (select numesta from pubmain where numesta = p_numesta) then

insert into pubmain( id ,    pubcategoria_id ,    numesta,    sector ,    zona,    subzona,    numlicencia ,
    axolicencias ,    cvecuenta,    nombre ,    calle ,    numext ,    telefono ,
    cupo,    fecha_at ,    fecha_inicial ,    fecha_vencimiento ,    rfc , solicitud , control,   movtos_no,    movto_cve ,    movto_usr )  
values(0, p_pubcategoria_id , p_numesta, p_sector ,p_zona, p_subzona,    p_numlicencia ,
  p_axolicencias , p_cvecuenta, p_nombre , p_calle , p_numext , p_telefono , p_cupo, p_fecha_at ,
  p_fecha_inicial , p_fecha_vencimiento ,    p_rfc ,  p_solicitud , p_control, p_movtos_no,    p_movto_cve , p_movto_usr );
let v_idnvo = dbinfo("sqlca.sqlerrd1");
let axo_1 = year(p_fecha_at);
let mes_1 = month(p_fecha_at);
let axo_2 = year(today);
  execute procedure sp_pub_genadeudo(2 , v_idnvo  ,axo_1 , mes_1 , axo_2, 12,p_movto_usr) into rsopc, messag ;




  let result = 0 ;
  let resultstr = 'Dado de alta correctamente';
 else
  let result = -1;
  let resultstr = 'Estacionamiento publico que ya exista Registrado, Verifique..';
  let v_idnvo =-1;
end if;
 return result,resultstr, v_idnvo;
--trace off;
end procedure;

create procedure "informix".sp_pubestadsector()
returning  
char(3) as categoria , char(25) as descripcion , 
int as cant_j , int as capac_j ,
int as cant_r , int as capac_r ,
int as cant_l , int as capac_l,
int as cant_h , int as capac_h ,
int as cant_t, int as capac_t ;

define v_categoria char(3) ;
define v_descripcion varchar(25);
define v_idcat int;
define v_cattot int;
define v_captot int;
define v_cat_j , v_cap_j ,v_cat_r , v_cap_r ,v_cat_l , v_cap_l, v_cat_h , v_cap_h  int;

FOREACH
select a.id ,a.categoria , a.descripcion , count(b.cupo), sum(b.cupo)
into v_idcat , v_categoria , v_descripcion , v_cattot , v_captot
 from pubcategoria a, pubmain b  where  b.pubcategoria_id = a.id
 and b.movto_cve <> 'C'
group by 1,2 ,3
order by a.categoria

select count(pubcategoria_id), sum(cupo) 
into v_cat_r , v_cap_r
from pubmain where pubcategoria_id = v_idcat and  sector = 'R' and movto_cve <> 'C';
if v_cat_r is null then
let v_cat_r = 0 ;
let v_cap_r = 0;
end if;
select count(pubcategoria_id), sum(cupo) 
into v_cat_l , v_cap_l
from pubmain where pubcategoria_id = v_idcat and sector = 'L'  and movto_cve <> 'C';
if v_cat_l is null then
let v_cat_l = 0 ;
let v_cap_l = 0;
end if;
select  count(pubcategoria_id), sum(cupo) 
into v_cat_h , v_cap_h
from pubmain where pubcategoria_id = v_idcat and sector = 'H'  and movto_cve <> 'C';
if v_cat_h is null then
let v_cat_h = 0 ;
let v_cap_h = 0;
end if;
select count(pubcategoria_id), sum(cupo) 
into v_cat_j , v_cap_j
from pubmain where pubcategoria_id = v_idcat and sector = 'J'  and movto_cve <> 'C';
if v_cat_j is null then
let v_cat_j = 0 ;
let v_cap_j = 0;
end if;
return v_categoria , v_descripcion , 
v_cat_j , v_cap_j ,v_cat_r , v_cap_r ,v_cat_l , v_cap_l, v_cat_h , v_cap_h,
v_cattot , v_captot  with resume;
 END FOREACH;
end procedure;

create procedure "informix".sppubmodi(p_id int,  p_sector char(1),p_zona int, p_subzona int, 
  p_numlicencia  int,  p_cvecuenta int,  p_calle varchar(100),
  p_numext varchar(6), p_telefono varchar(15) , p_fecha_at date,
  p_fecha_inicial date, p_fecha_vencimiento date,   
    p_movto_cve char(1), p_movto_usr int, p_solicitud int , p_control int )

returning
int as result , varchar(100) as resultstr ;
define result int;
define resultstr varchar(10);
define  v_idnvo int;
define axo_1 int;
define mes_1 int;
define axo_2 int;
define rsopc int ; define messag char(50);
--set debug file to "pubesta.log";
--trace on;
if  exists (select numesta from pubmain where id = p_id) then

update pubmain set     sector = p_sector ,
    zona = p_zona,
    subzona = p_subzona,   
   numlicencia = p_numlicencia,
      cvecuenta = p_cvecuenta,  
    
    calle = p_calle,   
    numext = p_numext,  
    telefono =p_telefono,
    fecha_at =p_fecha_at, 
    fecha_inicial =p_fecha_inicial,
     fecha_vencimiento = p_fecha_vencimiento, 
    solicitud =p_solicitud, 
     control =p_control,
     movtos_no =movtos_no +1,  
     movto_cve = 'M', 
      movto_usr =p_movto_usr 
 where id = p_id;

  let result = 0 ;
  let resultstr = 'Dado de alta correctamente';
 else
let result = -1 ;
  let resultstr = 'No existe el Registro';
end if;
 return result,resultstr ;
--trace off;
end procedure;

CREATE PROCEDURE "informix".redondeokiosco(nImporte money(15,2))
   RETURNING       money(15,2),money(5,2);
   DEFINE nImp     money(15,2);
   DEFINE nTmp     money(15,2);
   DEFINE nDif     money(5,2);
   DEFINE nDifresto     money(5,2);

   LET nTmp = TRUNC( nImporte );
   LET nDif = nImporte - nTmp;
   LET nDifresto = 0;
   LET nImp = 0;
   
   IF nDif > 0 THEN
      IF ((nDif > 0.00) AND (nDif <= 0.50)) THEN
         LET nImp = nTmp;
         LET nDifresto =  nDif * -1;
      END IF;
     
      IF ((nDif >= 0.51) AND (nDif < 1)) THEN
         LET nImp = nTmp + 1;
         LET nDifresto = 1 - nDif;
      END IF;
   ELSE
      LET nImp = nImporte;
   END IF;
   RETURN nImp,nDifresto;
END PROCEDURE;

create procedure "informix".sp_pub_genadeudo(p_opc int , p_pubid  int ,p_axo int ,p_mes int,p_axof int ,p_mesf int, p_userid int) 

returning
int as id,
char(50) as mensaje;
define v_opc int ;
 define v_descrip char(50);
 define v_adeudo money(12,2)     ;
 define v_importe money(12,2)     ;
  define  v_cupo  int; 
  define v_pubcategoria_id int;
  define v_axo int; define v_mes int;     define v_mes1 int;     define v_mes2 int;
  define v_res int ; define v_res1 char(50);
  define v_concepto varchar(40);
  define fecha_dato  date;
 
 let v_opc =0;

 let v_descrip = 'Folio Grabado Correctamente';
-- opc 1 para generar un solo adeudo.
if p_opc = 1 then
-- begin
--    on exception in (-239)
--    let v_opc = -1;
--    let v_descrip = 'No se Grabo el Folio';
--    end exception;
if exists(select id from pubadeudo where pubmain_id = p_pubid and axo = p_axo
     and mes = p_mes ) then 
    let v_opc = -1;
    let v_descrip = 'Ya existe este adeudo';
else

 select  pubcategoria_id , cupo into v_pubcategoria_id , v_cupo from pubmain where id = p_pubid;
 if p_axo > 2007 then
   let fecha_dato = mdy(p_mes,1,p_axo);
 select importe into v_importe from pubcatimporte 
       where pubcategoria_id =  v_pubcategoria_id 
      and fecha_dato between fecha_inicio and fecha_fin ;

 let  v_adeudo = v_importe * v_cupo ;
 let v_concepto = v_cupo ||' Cajones X ' ||  v_importe ;
 else
 select importe into v_importe from pubimporte2007 where axo = p_axo and 
   v_cupo between cajon1 and cajon2;
  let  v_adeudo = v_importe ;
  let v_concepto = 'Por los ' || v_cupo ||' Cajones es ' ||  v_importe;
  end if;
 insert into pubadeudo (id, fecha_at , pubmain_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,p_pubid, p_axo , p_mes, 10 , v_concepto , v_adeudo , 0,p_userid);
let v_opc =0;
 let v_descrip = 'Adeudo Generado correctamente';
end if;
end if;
 -- opc 1 para generar adeudos por periodo 
if p_opc = 2 then
  -- verificar datos del periodo;
     if p_axo > p_axof then
         let v_opc = -2;
         let v_descrip = 'A�o final es inferior al inicial';
     else
         if p_axo = p_axof then
            if p_mes > p_mesf then
             let v_opc = -2;
             let v_descrip = 'Mes final es inferior al inicial';
                      
            end if;
         end if;
   end if;
   if v_opc = 0 then
 --  let v_axo = p_axo ;
   let v_mes1 = p_mes;
    if p_axo = p_axof then
     let v_mes2 = p_mesf   ;
     else
     let v_mes2 = 12;
     end if;
   for v_axo in (p_axo to p_axof step 1)
       for v_mes in (v_mes1 to v_mes2 step 1)
       execute procedure sp_pub_genadeudo(1 , p_pubid ,v_axo,v_mes,0,0, p_userid) into v_res , v_res1;
       end for;
        let v_mes1 = 1;
         if v_axo = p_axof then
           let v_mes2 = p_mesf   ;
         else
           let v_mes2 = 12;
         end if;
   end for;
 end if;  
  end if; 

return v_opc , v_descrip ;

END PROCEDURE;

CREATE PROCEDURE "gmoreno".con14_f1folios ( p_Placa Char(7), p_Clave Integer)
	returning  varchar(250);    -- Concepto

  define v_Folio, v_contador, v_renglon	Integer;
  define v_Detalle			varchar(250);

                Let v_renglon = 0;
                Let v_contador = 0;
                Let v_Folio = 0;
   	Let v_Detalle = ' ';
                Foreach
                     Select folio
                       Into v_Folio
                      from ta14_folios_histo
                       where placa = p_Placa
                       and codigo_movto = p_Clave
                       ORDER BY AXO, FOLIO

		if v_contador > 0 then
		   Let v_Detalle = v_Detalle || ',' || v_Folio;
		else
		   Let v_Detalle = v_Detalle || v_Folio;
		end if;
		Let v_contador = v_contador + 1;
		         if v_contador = 25 then
			return v_Detalle  with resume;
			Let v_Detalle = ' ';
			Let v_contador = 0;
		         end if;			
                end foreach;
                       if ( v_contador > 0 )  and  ( v_contador < 25 ) then
		return v_Detalle  with resume;
                       end if;

end procedure
;

CREATE PROCEDURE "informix".econspubenca(p_numesta int)
returning int as codigo , int as idpublico , int as numesta,
varchar(80)  as propietario  , varchar(80) as calle , varchar(40) as categoria , int as capacidad , varchar(100) as mensaje ;
define v_codigo int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(80);
define  v_calle varchar(80); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define  v_movto_cve char(1); 
let v_codigo = -1;
let  v_id  = 0; 
let v_numesta = 0;
let v_nombre = '';
let  v_calle =''; 
let   v_descripcion = '' ;
let v_cupo =0;
let  v_movto_cve =''; 

select nvl(a.id,0) , a.numesta, a.nombre , trim(a.calle) ||' # ' || a.numext ,  b.descripcion , a.cupo , a.movto_cve 
into v_id , v_numesta, v_nombre , v_calle  ,  v_descripcion , v_cupo , v_movto_cve 
 from pubmain  a , pubcategoria b
where a.numesta = p_numesta and b.id = a.pubcategoria_id;
if v_id > 0 then
   if v_movto_cve = 'C' then
   return -2,v_id, v_numesta, v_nombre , v_calle  , v_descripcion , v_cupo , 'ESTACIONAMIENTO CANCELADO';
   else
   return 0, v_id,v_numesta, v_nombre , v_calle , v_descripcion , v_cupo , 'PROCEDE PARA PAGO';
   end if
 else 
return v_codigo, v_id,v_numesta, v_nombre , v_calle ,v_descripcion , v_cupo , 'NO EXISTE ESTE ESTACIONAMIENTO' ;
end if;
END PROCEDURE;

create procedure "informix".sp_pubadeudoanual(p_axo int)
returning char(150);
define obs char(150);
define p_pubid int;

define v_id int;
define v_mensaje char(50);

FOREACH
select a.id  into p_pubid
 from pubmain a where a.movto_cve <> 'C'


execute procedure sp_pub_genadeudo(2, p_pubid, p_axo ,1 ,p_axo  ,12 , 18)
 into v_id , v_mensaje; 
let obs = 'Registro procesado  '|| p_pubid ||' ' || v_id ||'  '|| v_mensaje ;
return obs with resume;

 END FOREACH;

end procedure;

CREATE PROCEDURE "informix".epub_cons_enca(p_numesta int)
returning int as codigo , int as idpublico , int as numesta,
varchar(80)  as propietario  , varchar(80) as calle , varchar(40) as categoria , int as capacidad , varchar(100) as mensaje ;
define v_codigo int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(80);
define  v_calle varchar(80); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define adeudo int;
define  v_movto_cve char(1); 
let v_codigo = -1;
let  v_id  = 0; 
let v_numesta = 0;
let v_nombre = '';
let  v_calle =''; 
let   v_descripcion = '' ;
let v_cupo =0;
let  v_movto_cve =''; 
let adeudo = 0;

select nvl(a.id,0) , a.numesta, a.nombre , trim(a.calle) ||' # ' || a.numext ,  b.descripcion , a.cupo , a.movto_cve 
into v_id , v_numesta, v_nombre , v_calle  ,  v_descripcion , v_cupo , v_movto_cve 
 from pubmain  a , pubcategoria b
where a.numesta = p_numesta and b.id = a.pubcategoria_id;
if v_id > 0 then
   if v_movto_cve = 'C' then
   return -2,v_id, v_numesta, v_nombre , v_calle  , v_descripcion , v_cupo , 'ESTACIONAMIENTO CANCELADO';
   else 
     select count(*) into adeudo from pubadeudo where pubmain_id = v_id;
      if  adeudo > 0 then
       return 0, v_id,v_numesta, v_nombre , v_calle , v_descripcion , v_cupo , 'PROCEDE PARA PAGO';
      else 
       return -3, v_id,v_numesta, v_nombre , v_calle , v_descripcion , v_cupo , 'ESTACIONAMIENTO SIN ADEUDO';
      end if;
   end if
 else 
return v_codigo, v_id,v_numesta, v_nombre , v_calle ,v_descripcion , v_cupo , 'NO EXISTE ESTE ESTACIONAMIENTO' ;
end if;
END PROCEDURE;

create procedure "informix".epub_cons_detalle(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning   varchar(50) as concepto , 
int as axo , int as mes, money(12,2) as adeudo , money(10,2) as recargos;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;
  FOREACH
  select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
   into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,2,3
   if v_tipo = 10 then
   select sum(porcentaje_mes) into v_porcentaje from db_ingresos:ta_12_recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_recargos is null then
       let v_recargos = 0;
    end if;
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
return v_concepto , v_axo , v_mes ,  v_adeudo , v_recargos with resume;
end foreach;
end procedure;

create procedure "informix".epub_liquidacion(parpubid int,  
paraxohasta int, parmeshasta int , parmedio int , ptipo_redon int)
--transaccion , nummensual ,periodo inicial , periodo final,  descrip  , idmedio, impactual, impanterior, imprecargos, impotros , impredondeo
returning  int as transaccion, int as mesualidades, char(7) as periodo_inicial, 
           char(7) as periodo_final, char(40) as referencia, int  as medio, 
           money(12,2) as imp_actuales,  money(12,2) as imp_anteriores,   money(12,2) as imp_recargos,
           money(12,2) as imp_otros, money(4,2) as  imp_redondeo ;

define v_idtrans int;
define v_nofol   int;
define v_descrip  char(50);

define v_impactual money(12,2);
define v_impanterior money(12,2);
define v_imprecargos money(12,2);
define v_impredondeo money(4,2);
define v_impotros money(12,2);
define v_axoactual int;
define v_mesinicial int;
define v_mesfinal int;
define contador int;
define vaxo smallint; 
define  vmes integer;  
define vfecha date;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define vinfra int;
define dias_cuantos integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define v_tot money(12,2);
define v_totpag money(12,2);
define v_folionot char(20);

define v_folioinicial int;

define v_foliofinal int;
define v_axotrans int;
define v_mestrans int;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ;
 define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2); define v_otros money(12,2);
define v_cuentaapl int; define v_tipochar char(1); define perioI int; define v_porcentaje decimal(5,2); 
define v_charidpub int; define paraxoini int; define parmesini int; define periodo1 char(7);define periodo2 char(7);
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
select min(axo) into paraxoini from pubadeudo where pubmain_id = parpubid ;
select min(mes) into parmesini from pubadeudo where pubmain_id = parpubid and axo = paraxoini;
let periodo1 = paraxoini || '-' || parmesini;
let periodo2 = paraxohasta || '-' || parmeshasta;
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

let v_charidpub = 24000000 + parpubid;
let v_folioinicial = ((paraxoini * 100)+parmesini) ;
let v_foliofinal = ((paraxohasta * 100)+parmeshasta) ;

 
let contador = 0;
let v_impactual = 0;
let v_impanterior = 0;
let v_otros = 0;

let v_descrip = v_charidpub || v_folioinicial || v_foliofinal;

 FOREACH
  select b.cuentaapl, b.tipo   ,  sum(ade_importe)
   into v_cuentaapl , v_tipochar , v_adeudo
  from pubadeudo a, pubtipoadeudo b
  where pubmain_id = parpubid  and  (axo * 100 + mes) <=  v_foliofinal
  and a.tipo <> 10 and a.tipo = b.tipo_id group by 1,2 

 let v_otros = v_otros + v_adeudo;
--return v_cuentaapl ,'S', v_tipochar , v_adeudo with resume;

end foreach;

  FOREACH
  select Axo, mes, (axo  * 100 )+ mes ,  ade_importe
   into v_axo , v_mes , perioI , v_adeudo
  from pubadeudo where pubmain_id = parpubid  and  (axo * 100 + mes) <= v_foliofinal
 and  tipo = 10
   select sum(porcentaje_mes) into v_porcentaje from db_ingresos:ta_12_recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     if v_porcentaje is null then
        let v_porcentaje = 0;
     end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;

   
--  totales
    if v_axo = year(today) then
    begin
    let v_cuota = v_cuota + v_adeudo;
    let v_rectot = v_rectot + v_recargos;
     end
    else
     begin
    let v_cuota_r = v_cuota_r + v_adeudo;
    let v_rectot_r = v_rectot_r + v_recargos;
     end
   end if;
   let contador = contador +1;
end foreach;
let v_imprecargos = v_rectot_r +v_rectot;
let v_tot = v_cuota +v_cuota_r+ v_imprecargos;
insert into pub_kio_trans (numtrans , fecha,
    pub_id  ,    descrip ,    axoini ,    mesini ,    axofin,    mesfin ,    numregistros ,
    idmedio ,    impactual,    impanterior ,    imprecargos , impotros) 
  values(0, current , parpubid , v_descrip,
 paraxoini  , parmesini  , paraxohasta , parmeshasta , contador , parmedio
, v_cuota , v_cuota_r ,v_imprecargos , v_otros);
LET v_idtrans = dbinfo("sqlca.sqlerrd1");

--execute procedure redondeokiosco(v_tot) into v_totpag, v_impredondeo;
let v_impredondeo = 0;
let v_imprecargos = v_rectot_r + v_rectot;
return  v_idtrans , contador, periodo1 , periodo2, v_descrip   ,parmedio, v_cuota , v_cuota_r,
 v_imprecargos , v_otros , v_impredondeo;

end procedure;

create procedure "informix".epub_pago(pnumtrans int ,   impcertificado money(10,2),
  idmedio int,
  parTarBanco   int,
  partarconfir  int,
  partartarjeta varchar(30),
  partartipo    int, pardatos_internet varchar(80) )

returning  int , char(2), int, char(240),  char(28);

define varreca  int;
define varcaja  char(2);
define varoperacion int;
define concepto  char(60);
define concep  char(60);
define vplaca char(7);
define vdescrip char(240);
define conc1   char(60);
 define v_axo int ;define v_mes int; define v_recargos money(10,2); define v_adeudo money(12,2) ;define v_descto money(12,2);
define v_tipo int ;define v_concepto1 varchar(40);
define varnumf int    ;
define vimpact money(10,2); 
define vimpante money(10,2); 
define vimpmulta money(10,2);
define ctaredon integer;
define v_descrip_gran  varchar(250);
define v_numesta int;
define vaxoini integer;
define vmesini integer;
define vaxofin integer;
define vmesfin integer;
define linea int;
define redon decimal(5,2);
define deci decimal(3,2);
define v_linea100 char(100) ;
define v_linea28 char(28);
define vfol_ini integer;
define vfol_fin integer; define perioI int;
define axovig int ; define v_cupo int; define v_adeudo_id int;  
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2); define per_recgos int; 
 define varcontrol int;  define dcontar int; define v_pub_id int; define  vimprecgos  money(10,2);   define vimpotros  money(10,2); 
define v_rfc char(13);
 define v_nombre char(60) ; define v_calle char(50) ; define v_descripcion char(30);
--set debug file to "epubpago.out";
--trace on;


--select * from pub_kio_trans

select   pub_id   ,descrip, axoini, mesini, axofin, mesfin , numregistros ,    impactual , impanterior , imprecargos , impotros
into  v_pub_id , vdescrip, vaxoini , vmesini , vaxofin , vmesfin, varnumf,   vimpact , vimpante , vimprecgos , vimpotros
from pub_kio_trans  where numtrans = pnumtrans;
  if v_pub_id is null then
     let varreca = 0;
     let varcaja = '';
     let varoperacion = 0;
     let vdescrip = 'No exite Transaccion';
     let v_linea28 = '';
   else
 

--select * from pub_kio_trans
select  a.numesta, a.nombre , trim(a.calle) ||' # ' || a.numext ,  b.descripcion , a.cupo , nvl(a.rfc,'NO')
into v_numesta, v_nombre , v_calle  ,  v_descripcion , v_cupo ,v_rfc
 from pubmain  a , pubcategoria b
where a.id = v_pub_id and b.id = a.pubcategoria_id;



  let vfol_ini = (vaxoini * 100) + vmesini;
  let vfol_fin = (vaxofin * 100) + vmesfin;
  let conc1 = 'Cuota por el periodo de '|| vfol_ini || ' al '|| vfol_fin;
  let redon = vimpact + vimpante + vimprecgos  + vimpotros - impcertificado;
  let deci = 0.49;
  let ctaredon = 550800000;
  if (redon < deci) then 
      let redon = redon * -1;
  end if;

 select id_rec , caja 
 into varreca , varcaja 
  from db_ingresos:ta12_operacKiosco where id_usuario =  idmedio; 

	select nvl(operacion,0) + 1
		into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;

--select * from db_ingresos:ta12_operacKiosco where  id_usuario = 115
let concepto = 'Perido de Pago: ' || vmesini ||'-' ||vaxoini ||' al ' || vmesfin ||'-'|| vaxofin  ;	
 let v_descrip_gran = 'Pago de Cuota de Estac. No: ' || v_numesta || '  con categoria :' || trim(v_descripcion) || ' y una capacidad de : ' || v_cupo || '  Cajones';
   insert into db_ingresos:ta_12_recibos (fecha ,  id_rec,  caja ,  operacion,  importe ,  cvepago ,  id_modulo,    nombre, domicilio ,    concepto ,  
                                                    id_usuario ,  fecha_act, descripcion, mesdesde , axodesde , meshasta , axohasta, rfcnumero , id_regmodulo ) 
                              values( today, varreca, varCaja, varOperacion, impcertificado, 'P' , 24, trim(v_nombre) ||' RFC:'|| trim(v_rfc) , v_calle, concepto  , idmedio, current, v_descrip_gran, vmesini ,vaxoini , vmesfin , vaxofin, pnumtrans ,v_numesta  );
--select * from  db_ingresos:ta_12_recibos where fecha = today and caja = 'I1'

	update	db_ingresos:ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;
	

execute PROCEDURE db_ingresos:linea_capturadiv(varoperacion, idmedio, impcertificado ,today ) into
 v_linea100, v_linea28;
 update db_ingresos:ta_12_recibos set descripcion = 'Linea: '|| v_linea28 || trim(descripcion)
where fecha = today and  id_rec = varreca and  caja =varcaja and  operacion = varOperacion ;
-- si es pago con tarjeta afectar
if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into db_ingresos:ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today ,varreca , varcaja, varoperacion , parTarBanco  ,
  partarconfir ,  partartarjeta, impcertificado,  partartipo, pardatos_internet);
  end if;
--select * from db_ingresos:ta_12_cheques where fecha = today-1 and caja = 'I1'
--select * from db_ingresos:ta_12_recibosdet where fecha=today and caja = 'I1'
let linea = 1;
if vimpact > 0 then

   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea , conc1  ,  370100000,  vimpact);
   let linea = linea +1;
end if;
if (vimpante > 0) and (vimpact > 0)  then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea , ''  ,   923700201,  vimpante);
   let linea = linea +1;
end if;
if (vimpante > 0) and (vimpact = 0)  then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea , conc1  ,   923700201,  vimpante);
   let linea = linea +1;
end if;

--else 
-- insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea , conc1  ,  923700201,  vimpante);
 --  let linea = linea +1;

if vimprecgos > 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea , 'Recargos'  ,   390600000,  vimprecgos);
   let linea = linea +1;
end if;
if vimpotros > 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea , ''  ,   390600001,  vimpotros);
   let linea = linea +1;
end if;

if redon <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        ''  , ctaredon ,  redon);
   let linea = linea +1;
end if;

--
--dar de baja folios pagados.
  

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;



  FOREACH
  select id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
   
 into v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
  from pubadeudo where pubmain_id = v_pub_id and  (axo * 100 + mes) <= vfol_fin 

   select sum(porcentaje_mes) 
 into v_porcentaje 
   from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
--where (axo * 100 + mes) between  201009 and 201109;

 select sum(porcentaje_mes) into v_porcentaje from recargos   where (axo * 100 + mes) between  perioI and per_recgos;
  
  let v_recargos = (v_porcentaje * v_adeudo ) / 100;

  insert into pubadeudo_histo ( id ,
   fecha_at, pubadeudo_id,  pubmain_id , axo , mes ,tipo, concepto, ade_importe , ade_descto ,
   ade_recgos, clave, motivo ,fecha_movto, pag_reca, pag_caja , pag_operacion ,
   pag_importe , bco_id,  bco_referencia , bco_importe , id_usuario)
  values  ( 0,today, v_adeudo_id , v_pub_id , v_axo , v_mes ,v_tipo, v_concepto1, v_adeudo , v_descto , v_recargos,   9 , 'Pago En Reca', 
 today ,varreca , varcaja, varoperacion ,impcertificado , null, null, null, 1);
  
 delete from pubadeudo where id = v_adeudo_id ;
   

  end foreach;
--
end if;
return 
varreca, varcaja, varoperacion,  vdescrip,       v_linea28;
--trace off;
end procedure;

create procedure "pgmoreno".upd14_actaxob ( p_Fecha Date, p_Axo Smallint )
       returning integer;	--numero de registros procesados

define vaxo, vfolio, conteo		Integer;
define vplaca		Char(7);

Let conteo = 0;

foreach
  select Axo, Folio, Placa
      into vaxo, vfolio, vplaca
    from ta14_folios_histo
          where  fecha_folio >= p_Fecha
             and  Axo = 0

		Let conteo = conteo + 1;

                        if exists(select b.Axo, b.Folio, b.Placa from ta14_folios_adeudo b
                           where b.Axo = 0 and b.Folio = vfolio and b.Placa = vplaca ) then
                           delete from ta14_folios_adeudo where Axo = 0 and Folio = vfolio and Placa = vplaca;
                        end if;

                        if exists(select b.Axo, b.Folio, b.Placa from ta14_folios_adeudo b
                           where b.Axo = p_Axo and b.Folio = vfolio and b.Placa = vplaca ) then
                           delete from ta14_folios_adeudo where Axo = p_Axo and Folio = vfolio and Placa = vplaca;
                        end if;

		update ta14_folios_histo set
			axo = p_Axo
			where axo = vaxo and folio = vfolio and placa = vplaca;

end foreach;
	return conteo;
--	Regresa el numero de registros procesados

end procedure
;

create procedure "informix".actualiza_pub_pago(p_opc int , p_pubid int, p_axof int , p_mesf int, p_tipo int,
 p_fecha_movto date ,p_reca smallint, p_caja char(2) , p_operacion int )
returning  int as id,  varchar(50) as mensaje; 
define r_id int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);
define v_certificado money(12,2);
--set debug file to 'publico.log';
--trace on;
let axovig = year(p_fecha_movto) ;
let mesvig = month(p_fecha_movto);
let diavig = day(p_fecha_movto);
let r_id = -1;
let  v_certificado = 0;
let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let perio = (p_axof *100 )+ p_mesf;
let per_recgos =  (axovig *100 )+mesvig;
-- obtener el valor del recibo.
 select nvl(importe,0) into v_certificado from db_ingresos:ta_12_recibos 
     where fecha = p_fecha_movto and id_rec = p_reca  and caja = p_caja and  operacion = p_operacion
        and cvepago = 'P';
if v_certificado > 0 then
  FOREACH
  select id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
   
   into v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio and tipo = p_tipo

   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;

  insert into pubadeudo_histo ( id ,
   fecha_at, pubadeudo_id,  pubmain_id , axo , mes ,tipo, concepto, ade_importe , ade_descto ,
   ade_recgos, clave, motivo ,fecha_movto, pag_reca, pag_caja , pag_operacion ,
   pag_importe , bco_id,  bco_referencia , bco_importe , id_usuario)
  values  ( 0,today, v_adeudo_id , p_pubid, v_axo , v_mes ,v_tipo, v_concepto1, v_adeudo , v_descto , v_recargos,   13 , 'Pago En Reca', 
 p_fecha_movto, p_reca , p_caja, p_operacion, v_certificado, null, null, null, 1);
  
delete from pubadeudo where id = v_adeudo_id ;
   

end foreach;
 let r_id = 0;
 let r_mensaje = 'Actualizacion del Pago realizado Correctamente';

else
 let r_id = -1;
 let r_mensaje = 'Los datos del Recibo no son correctos';
end if;
return r_id, r_mensaje ;
--trace off;
end procedure;

CREATE PROCEDURE "informix".mmeters_parkingcons(parPlaca char(7), parMedio int)
				
	 returning smallint , smallint,  char(7) ,      int , date ,  smallint , smallint , money(7,2), smallint ,                    money(7,2),        int ,            int ,                         char(100)  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  

if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then


foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if weekday(vfecha) = 6 then
   let dias_cuantos = 1;
 end if;
if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;



if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,0,0,0,0,0,0,'No existen folios para esta placa';
end if;
end procedure
;

CREATE PROCEDURE "informix".mmeters_parkingtot(parPlaca char(7), parMedio int)
				
	 returning smallint ,  money(7,2) ;
--         cuentos folio , total adeudo;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define  v_cuantos integer ;
define v_adeudo money(14,2);
let v_cuantos = 0;
let v_adeudo =0;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then

foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if weekday(vfecha) = 6 then
   let dias_cuantos = 1;
 end if;
if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  
  let v_cuantos = v_cuantos +1;
   let v_adeudo = v_adeudo + vimp_apagar;

end foreach;
     return v_cuantos , v_adeudo;
else
return
 0,0;
end if;
end procedure
;

create procedure "informix".movil_parking (parPlaca char(7))
				
	 returning char(150);

define varok   smallint;
define mensaje char(150);
define varcontrol integer;
define vaxo, vestado smallint; 
define  vfolio integer;  
define vfecha, vfecha_ini, vfecha_fin date;
define vinfra smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define dias_cuantos, cuantos_folios integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vtarifa, vTot_apagar, vimp_apagar money(7,2);
define  vctaapl integer;  
define vctagastos integer;
define vTotgastos, vimpgastos money(7,2);


if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then

Let varok = 0;
Let cuantos_folios = 0;
Let vTot_apagar = 0;
Let vTotgastos = 0;

	foreach 
	Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
	into 
		vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
	from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
		where a.placa = parplaca and a.infraccion = b.num_clave 
		and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
		a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
		order by 3 asc

	--- para obtener dias de vencimiento;

	let fecha_hoy = today;
	let x1 = vfecha;
	let x2 = vfecha;
	let dias_cuantos = 0;
	let dias_habil = 0;
     if weekday(vfecha) = 6 then
        let dias_cuantos = 1;
      end if;
	select count(*)  into dias_habil from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     	while x1 <= fecha_hoy 
        		IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          			let dias_cuantos =dias_cuantos+1;
         		end if;
     	let x1 = x1+1;
   	end while;

	let dias_cuantos =  dias_cuantos - dias_habil ;

	--para calcular el valor de la multa;
	if (vinfra <=4) and (dias_cuantos<=6) then
      		let vporc_cobro = 50 ;
   	else
     		let  vporc_cobro = 100;
	end if;
  	if vsqlporc_cobro <> 100 then
     		let vporc_cobro = vsqlporc_cobro;
  	end if;
     	let vimp_apagar = vporc_cobro / 100 * vtarifa;
  
	if vacuerdo > 0 then
   		let vimpgastos = 101.92;
	else
   		let vimpgastos = 0;
	end if;

	Let varok = 1;
	Let cuantos_folios = cuantos_folios + 1;
	Let vTot_apagar = vTot_apagar + vimp_apagar;
	Let vTotgastos = vTotgastos + vimpgastos;
	if cuantos_folios > 1 then
		Let vfecha_fin = vfecha;
	else
		Let vfecha_ini = vfecha;
	end if;

	end foreach;
else
	Let varok = 0;
end if;

if varok = 0 then
               let mensaje = 'No existen folios para esta placa, Gracias por utilizar nuestro servicio';
else
	if cuantos_folios > 1 then
		let mensaje =  'La placa tiene  ' || cuantos_folios || ' folios en el periodo del  '  ||  vfecha_ini  ||  '--'  ||  vfecha_fin  ||  
		' TOTAL A PAGAR ' ||  vTot_apagar + vTotgastos  || ' --SI PAGA HOY- ' || fecha_hoy || ' EN CUALQUIER RECAUDADORA';
	else
		let mensaje = 'La placa tiene el folio ' || vfolio || '--'  ||  vaxo  ||  '  con la fecha del  '  ||  vfecha  ||  
		' TOTAL A PAGAR ' ||  vTot_apagar + vTotgastos  || ' --SI PAGA HOY- ' || fecha_hoy || ' EN CUALQUIER RECAUDADORA';
	end if;
end if;
insert into consmovil values( parPlaca, current ,mensaje);
return mensaje;

end procedure
;

create procedure "informix".movil_parking1 (parPlaca char(7))
				
	 returning char(150);

define varok   smallint;
define mensaje char(150);
define varcontrol integer;
define vaxo, vestado smallint; 
define  vfolio integer;  
define vfecha, vfecha_ini, vfecha_fin date;
define vinfra smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define dias_cuantos, cuantos_folios integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vtarifa, vTot_apagar, vimp_apagar money(7,2);
define  vctaapl integer;  
define vctagastos integer;
define vTotgastos, vimpgastos money(7,2);


if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then

Let varok = 0;
Let cuantos_folios = 0;
Let vTot_apagar = 0;
Let vTotgastos = 0;

	foreach 
	Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
	into 
		vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
	from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
		where a.placa = parplaca and a.infraccion = b.num_clave 
		and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
		a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
		order by 3 asc

	--- para obtener dias de vencimiento;

	let fecha_hoy = today;
	let x1 = vfecha;
	let x2 = vfecha;
	let dias_cuantos = 0;
	let dias_habil = 0;
         if weekday(vfecha) = 6 then
             let dias_cuantos = 1;
          end if;
	select count(*)  into dias_habil from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     	while x1 <= fecha_hoy 
        		IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          			let dias_cuantos =dias_cuantos+1;
         		end if;
     	let x1 = x1+1;
   	end while;

	let dias_cuantos =  dias_cuantos - dias_habil ;

	--para calcular el valor de la multa;
	if (vinfra <=4) and (dias_cuantos<=6) then
      		let vporc_cobro = 50 ;
   	else
     		let  vporc_cobro = 100;
	end if;
  	if vsqlporc_cobro <> 100 then
     		let vporc_cobro = vsqlporc_cobro;
  	end if;
     	let vimp_apagar = vporc_cobro / 100 * vtarifa;
  
	if vacuerdo > 0 then
   		let vimpgastos = 101.92;
	else
   		let vimpgastos = 0;
	end if;

	Let varok = 1;
	Let cuantos_folios = cuantos_folios + 1;
	Let vTot_apagar = vTot_apagar + vimp_apagar;
	Let vTotgastos = vTotgastos + vimpgastos;
	if cuantos_folios > 1 then
		Let vfecha_fin = vfecha;
	else
		Let vfecha_ini = vfecha;
	end if;

	end foreach;
else
	Let varok = 0;
end if;

if varok = 0 then
               let mensaje = 'No existen folios para esta placa, Gracias por utilizar nuestro servicio';
else
	if cuantos_folios > 1 then
		let mensaje =  'La placa tiene  ' || cuantos_folios || ' folios en el periodo del  '  ||  vfecha_ini  ||  '--'  ||  vfecha_fin  ||  
		' TOTAL A PAGAR ' ||  vTot_apagar + vTotgastos  || ' --SI PAGA HOY- ' || fecha_hoy || ' EN CUALQUIER RECAUDADORA';
	else
		let mensaje = 'La placa tiene el folio ' || vfolio || '--'  ||  vaxo  ||  '  con la fecha del  '  ||  vfecha  ||  
		' TOTAL A PAGAR ' ||  vTot_apagar + vTotgastos  || ' --SI PAGA HOY- ' || fecha_hoy || ' EN CUALQUIER RECAUDADORA';
	end if;
end if;
insert into consmovil values( parPlaca, current ,mensaje);
return mensaje;

end procedure
;

create procedure "informix".sp_cons_folios(opc1 int , p_axo int , p_folio int , p_fecha date , p_placa char(7))
returning
int as axo, int as folio, varchar(7) as placa, date as fecha_folio,
 int as estado, int as infraccion, money(6,2) as tarifa, int as porc_cobro,
 varchar(20) as decripcion , varchar(20) as pago, varchar(20) as usuario,
 varchar(10) as notif, int as numacuerdo, money(6,2) as costofijo, 
varchar(1) as tipo , varchar(1) as infrac, money(6,2) as apagar;

-- axo,folio,placa, fecha_folio,
--estado, infraccion, tarifa,porc_cobro,descripcion ,Pago,usuario,notif
--numacuerdo, costofijo, tipo infrac , afec
 define V_axo int ;
define V_folio int;
define  V_placa varchar(7) ;
define V_fecha_folio date;
define V_estado int;
define V_infraccion int; 
define V_tarifa money(6,2); 
define V_porc_cobro int ; 
define V_descripcion varchar(20);
define V_Pago char(20) ;
define V_usu_inicial  varchar(20);
define V_folionot varchar(10);
define v_num_acuerdo int;
define v_costo_fijo01 money(6,2);
define  v_ord varchar(1); 
define v_afec varchar(1);
define dias_cuantos  integer;
define dia_fecha integer;
define v_fechaval date;
define v_imp_apagar money(6,2);
let dias_cuantos = 0;
let v_imp_apagar = 0;
-- por folio individual
if opc1 = 1 then 
   FOREACH
select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa,NVL(F.porc_cobro , 100), "Vigente" descripcion , " "  Pago, x.nombre, n.folionot notif 
 , nvl(a.num_acuerdo,0) num_acuerdo , b.costo_fijo01 , case a.infraccion  when 1 then "A" when 2 then "A"  when 3 then "A"   else "B" end  ord  ,"A" afec
into V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec
 from ta14_folios_adeudo a , TA14_tarifas  b, conexion x  , OUTER (TA14_FOLIOS_FREE F ), outer (ta14_notifica_edo n)  
  where a.axo = p_axo and a.folio = p_folio and a.usu_inicial =  x.id_usuario  and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin 
AND a.axo = f.aXo and a.folio = f.folio AND F.CLAVE = "A" and a.num_acuerdo = n.num_acuerdo and n.num_acuerdo is not null
  order by ord ,1,3,2 
let v_fechaval = v_fecha_folio;
--verificar dia inhabil
 if weekday(v_fecha_folio) = 6 then
   let dias_cuantos = 1;
 else
   let dias_cuantos = 0;
 end if;
-- menor de 30 dias entre la fecha de hoy y la del folio
  if (today - v_fecha_folio) < 30 then
    while v_fechaval <= today 
       select WEEKDAY(fecha)  into dia_fecha from ta_12_diasinhabil where fecha = v_fechaval;
      if  dia_fecha > 0 and dia_fecha < 6 then  -- no sea domingo o sabado
          let  dias_cuantos  = dias_cuantos + 1;
      end if;
      let v_fechaval = v_fechaval +1; 
    end while ;   
   else
    let  dias_cuantos  = 7;
end if;
 if V_porc_cobro = 100 then
   if ((((V_infraccion >= 11) and (V_infraccion <= 14) ) or
        (V_infraccion <= 4)) and (dias_cuantos <= 6))  then
         let V_porc_cobro = 50 ;
   end if;


 end if;
 let v_imp_apagar = V_tarifa * V_porc_cobro / 100;
--
 return  V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec  ,v_imp_apagar with resume;

  END FOREACH;
end if;
-- por fecha del  folio
if opc1 = 2 then
 FOREACH
select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa,NVL(F.porc_cobro , 100), "Vigente" descripcion , " "  Pago, x.nombre, n.folionot notif 
 , nvl(a.num_acuerdo,0) num_acuerdo , b.costo_fijo01 , case a.infraccion  when 1 then "A" when 2 then "A"  when 3 then "A"   else "B" end  ord  ,"A" afec 
 
into V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec
from ta14_folios_adeudo a , TA14_tarifas  b , conexion x , OUTER (TA14_FOLIOS_FREE F ), outer (ta14_notifica_edo n)
where a.fecha_folio = p_fecha 
  and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin AND a.axo = f.aXo and a.folio = f.folio AND F.CLAVE = "A" and a.num_acuerdo = n.num_acuerdo and n.num_acuerdo is not null
  and a.usu_inicial =  x.id_usuario  order by ord ,1,3,2 
let v_fechaval = v_fecha_folio;
--verificar dia inhabil
-- menor de 30 dias entre la fecha de hoy y la del folio
  if (today - v_fecha_folio) < 30 then
    while v_fechaval <= today 
       select WEEKDAY(fecha)  into dia_fecha from ta_12_diasinhabil where fecha = v_fechaval;
      if  dia_fecha > 0 and dia_fecha < 6 then  -- no sea domingo o sabado
          let  dias_cuantos  = dias_cuantos + 1;
      end if;
      let v_fechaval = v_fechaval +1; 
    end while ;   
   else
    let  dias_cuantos  = 7;
end if;
 if V_porc_cobro = 100 then
   if (((V_infraccion >= 11 and V_infraccion <= 14 ) or
        (V_infraccion <= 4)) and dias_cuantos <= 6)  then
         let V_porc_cobro = 50 ;
     end if;
 
 end if;
let v_imp_apagar = V_tarifa * V_porc_cobro /100;
return  V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec ,v_imp_apagar with resume;

 END FOREACH;
end if;
-- por placa
if opc1 = 3 then
 FOREACH
select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa,NVL(F.porc_cobro , 100), "Vigente" descripcion , " "  Pago, x.nombre, n.folionot notif 
 , nvl(a.num_acuerdo,0) num_acuerdo , b.costo_fijo01 , case a.infraccion  when 1 then "A" when 2 then "A"  when 3 then "A"   else "B" end  ord  ,"A" afec
into V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec 
from ta14_folios_adeudo a , TA14_tarifas  b ,conexion x , OUTER (TA14_FOLIOS_FREE F ), outer (ta14_notifica_edo n) 

where a.placa = p_placa
 and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin AND a.axo = f.aXo and a.folio = f.folio AND F.CLAVE = "A" and a.num_acuerdo = n.num_acuerdo and n.num_acuerdo is not null
and a.usu_inicial =  x.id_usuario  order by ord ,1,3,2
let v_fechaval = v_fecha_folio;
--verificar dia inhabil
-- menor de 30 dias entre la fecha de hoy y la del folio
  if (today - v_fecha_folio) < 30 then
    while v_fechaval <= today 
       select WEEKDAY(fecha)  into dia_fecha from ta_12_diasinhabil where fecha = v_fechaval;
      if  dia_fecha > 0 and dia_fecha < 6 then  -- no sea domingo o sabado
          let  dias_cuantos  = dias_cuantos + 1;
      end if;
      let v_fechaval = v_fechaval +1; 
    end while ;   
   else
    let  dias_cuantos  = 7;
end if;
 if V_porc_cobro = 100 then
   if (((V_infraccion >= 11 and V_infraccion <= 14 ) or
        (V_infraccion <= 4)) and dias_cuantos <= 6)  then
         let V_porc_cobro = 50 ;
  end if;
 end if;
 let v_imp_apagar = V_tarifa * V_porc_cobro / 100;

return  V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec ,v_imp_apagar with resume; 
 END FOREACH;
end if;
-- historico por folio individual
if opc1 = 4 then 
   FOREACH
 select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa,NVL(F.porc_cobro , 100) , d.descripcion , ( r.reca || "   " || r.fecha_recibo || "   " || r.caja|| "   " || r.operacion )
, x.nombre  ,  n.folionot , nvl(a.num_acuerdo,0) , b.costo_fijo01 , case a.infraccion  when 1 then "A" when 2 then "A"  when 3 then "A"   else "B" end  ord , "P" 
into V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec

   from ta14_folios_histo a , TA14_tarifas  b, ta14_codigomovtos d  , conexion x,
 OUTER (TA14_FOLIOS_FREE F), outer (ta14_refrecibo r ), outer( ta14_notifica_edo n)
where a.axo = p_axo and a.folio = p_folio
and a.codigo_movto in(3,13) and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin and a.codigo_movto = d.codigo_movto AND a.axo = F.aXo and a.folio = F.folio AND F.CLAVE = "A"  and a.control = r.control 
and a.num_acuerdo = n.num_acuerdo and  a.usu_bajaauto =  x.id_usuario
let v_fechaval = v_fecha_folio;
--verificar dia inhabil
-- menor de 30 dias entre la fecha de hoy y la del folio
  if (today - v_fecha_folio) < 30 then
    while v_fechaval <= today 
       select WEEKDAY(fecha)  into dia_fecha from ta_12_diasinhabil where fecha = v_fechaval;
      if  dia_fecha > 0 and dia_fecha < 6 then  -- no sea domingo o sabado
          let  dias_cuantos  = dias_cuantos + 1;
      end if;
      let v_fechaval = v_fechaval +1; 
    end while ;   
   else
    let  dias_cuantos  = 7;
end if;
 if V_porc_cobro = 100 then
   if (((V_infraccion >= 11 and V_infraccion <= 14 ) or
        (V_infraccion <= 4)) and dias_cuantos <= 6)  then
         let V_porc_cobro = 50 ;
     end if;
 
 end if;
let v_imp_apagar = V_tarifa * V_porc_cobro /100;
return  V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec,v_imp_apagar with resume;
 END FOREACH;
FOREACH
-- otras formas de pago
 select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa,NVL(F.porcentaje , 100) ,( trim( nvl(z.autoriza,"sin adeudo"))|| " " || trim(nvl(z.observacion,"")) ), d.descripcion , x.nombre
 , n.folionot , nvl(a.num_acuerdo,0)  ,  b.costo_fijo01 ,  case a.infraccion  when 1 then "A" when 2 then "A"  when 3 then "A"   else "B" end  , 
 case a.codigo_movto  when 10 then "P" when 6 then "P"  else "C" end afec 
into V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec
 from ta14_folios_histo a , TA14_tarifas  b, ta14_codigomovtos d  , conexion x,
 OUTER (ta14_porcen_histo F),outer(ta14_refrecibo r) ,outer(ta14_notifica_edo n) , outer(ta14_condonado z)
where a.axo = p_axo and a.folio = p_folio
and a.codigo_movto not in(1,3, 13) and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin and a.codigo_movto = d.codigo_movto AND a.control = F.control and a.control = r.control and a.control = Z.control  
and a.num_acuerdo = n.num_acuerdo and  a.usu_bajaauto =  x.id_usuario
--order by 16,3,1,2 
let v_fechaval = v_fecha_folio;
--verificar dia inhabil
-- menor de 30 dias entre la fecha de hoy y la del folio
  if (today - v_fecha_folio) < 30 then
    while v_fechaval <= today 
       select WEEKDAY(fecha)  into dia_fecha from ta_12_diasinhabil where fecha = v_fechaval;
      if  dia_fecha > 0 and dia_fecha < 6 then  -- no sea domingo o sabado
          let  dias_cuantos  = dias_cuantos + 1;
      end if;
      let v_fechaval = v_fechaval +1; 
    end while ;   
   else
    let  dias_cuantos  = 7;
end if;
 if V_porc_cobro = 100 then
   if (((V_infraccion >= 11 and V_infraccion <= 14 ) or
        (V_infraccion <= 4)) and dias_cuantos <= 6)  then
         let V_porc_cobro = 50 ;
     end if;
 
 end if;
let v_imp_apagar = V_tarifa * V_porc_cobro /100;
return  V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec,v_imp_apagar with resume;

  END FOREACH;
end if;


--historico  por placa
if opc1 = 5 then
 FOREACH
 select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa,
 NVL(F.porc_cobro , 100) , d.descripcion descripcion , ( r.reca || "   " || r.fecha_recibo || "   " || r.caja|| "   " || r.operacion )
  Pago, x.nombre ,  n.folionot notif , nvl(a.num_acuerdo,0) num_acuerdo, b.costo_fijo01 , case a.infraccion  when 1 then "A" when 2 then "A"  when 3 then "A"   else "B" end  ord , "P" afec
into V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec

   from ta14_folios_histo a , TA14_tarifas  b, ta14_codigomovtos d  , conexion x,
 OUTER (TA14_FOLIOS_FREE F), outer (ta14_refrecibo r ), outer( ta14_notifica_edo n)
where a.placa = p_placa
and a.codigo_movto in(3,13) and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin and a.codigo_movto = d.codigo_movto AND a.axo = F.aXo and a.folio = F.folio AND F.CLAVE = "A"  and a.control = r.control 
and a.num_acuerdo = n.num_acuerdo  and  a.usu_bajaauto =  x.id_usuario
order by 16,1,2 ,3
let v_fechaval = v_fecha_folio;
--verificar dia inhabil
-- menor de 30 dias entre la fecha de hoy y la del folio
  if (today - v_fecha_folio) < 30 then
    while v_fechaval <= today 
       select WEEKDAY(fecha)  into dia_fecha from ta_12_diasinhabil where fecha = v_fechaval;
      if  dia_fecha > 0 and dia_fecha < 6 then  -- no sea domingo o sabado
          let  dias_cuantos  = dias_cuantos + 1;
      end if;
      let v_fechaval = v_fechaval +1; 
    end while ;   
   else
    let  dias_cuantos  = 7;
end if;
 if V_porc_cobro = 100 then
   if (((V_infraccion >= 11 and V_infraccion <= 14 ) or
        (V_infraccion <= 4)) and dias_cuantos <= 6)  then
         let V_porc_cobro = 50 ;
     end if;
 
 end if;
let v_imp_apagar = V_tarifa * V_porc_cobro /100;
return  V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec,v_imp_apagar with resume;
 END FOREACH;
FOREACH
 select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa, NVL(F.porcentaje , 100) ,( trim( nvl(z.autoriza,"sin adeudo"))|| " " || trim(nvl(z.observacion,"")) ) , d.descripcion , x.nombre
 , n.folionot , nvl(a.num_acuerdo,0) num_acuerdo ,  b.costo_fijo01 ,  case a.infraccion  when 1 then "A" when 2 then "A"  when 3 then "A"   else "B" end   , 
 case a.codigo_movto  when 10 then "P" when 6 then "P"  else "C" end afec 
into V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec
 from ta14_folios_histo a , TA14_tarifas  b, ta14_codigomovtos d  , conexion x,
 OUTER (ta14_porcen_histo F),outer(ta14_refrecibo r) ,outer(ta14_notifica_edo n) , outer(ta14_condonado z)
where a.placa = p_placa
and a.codigo_movto not in(1,3, 13) and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin and a.codigo_movto = d.codigo_movto AND a.control = F.control and a.control = r.control and a.control = Z.control  
and a.num_acuerdo = n.num_acuerdo  and  a.usu_bajaauto =  x.id_usuario
order by 16,1,2 ,3
let v_fechaval = v_fecha_folio;
--verificar dia inhabil
-- menor de 30 dias entre la fecha de hoy y la del folio
  if (today - v_fecha_folio) < 30 then
    while v_fechaval <= today 
       select WEEKDAY(fecha)  into dia_fecha from ta_12_diasinhabil where fecha = v_fechaval;
      if  dia_fecha > 0 and dia_fecha < 6 then  -- no sea domingo o sabado
          let  dias_cuantos  = dias_cuantos + 1;
      end if;
      let v_fechaval = v_fechaval +1; 
    end while ;   
   else
    let  dias_cuantos  = 7;
end if;
 if V_porc_cobro = 100 then
   if (((V_infraccion >= 11 and V_infraccion <= 14 ) or
        (V_infraccion <= 4)) and dias_cuantos <= 6)  then
         let V_porc_cobro = 50 ;
     end if;
 
 end if;
let v_imp_apagar = V_tarifa * V_porc_cobro /100;
return  V_axo, V_folio, V_placa, V_fecha_folio, V_estado, V_infraccion, V_tarifa,V_porc_cobro, V_descripcion , V_Pago, V_usu_inicial,V_folionot ,
 v_num_acuerdo , v_costo_fijo01 , v_ord  , v_afec ,v_imp_apagar with resume;

 END FOREACH;
end if;

END PROCEDURE;

CREATE PROCEDURE "informix".spd14_barrido (p_fecha_ini Date, p_fecha_fin Date)
RETURNING CHAR(12),               -- FOLIO
                               INTEGER;            -- CODIGO

define vfolio_x                Char(12);
define v_placa_x                            Char(7);
define contador, vcodigo            Integer;

Let contador = 0;

foreach
  SELECT (trunc((axo* 10000000) + folio)) || '' Folio, placa, codigo_movto INTO vfolio_x, v_placa_x, vcodigo FROM ta14_folios_histo
       WHERE fecha_folio between p_fecha_ini and p_fecha_fin
                
                Let contador = contador + 1;                       
                if exists (SELECT * FROM ta14_datos_mpio WHERE folio = vfolio_x AND placa = v_placa_x AND tipoact <> 'A' ) then
                               RETURN 'Contador ', contador with resume;  -- falta de subir como remesa a SECFIN
                else
                               RETURN 'Codigo ', vcodigo with resume;  -- falta de subir como remesa a SECFIN
                end if;

end foreach;
end procedure
;

CREATE PROCEDURE "informix".cajero_park_del01(
		paraxo smallint,
                                parfolio  integer,
		parPlaca char(7),
		parconvenio  integer,
                                parfecha   date,
                                parreca      smallint,
                                parcaja      char(2),
                                paroperacion  integer,
                                parusuauto  integer,
		parOpcion  smallint,
                parPorcentaje  integer,
                parImporteFolio money(10,2)
		)
		returning smallint,  char(200) ;

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
define v_tarifa money(10,2);
           let varok = 0;
          let varobs = '';          

--set debug file to "c:\ivan.log";
--trace on;

--opcion 1 consulta del disponible.

if (paropcion = 1) or (paropcion = 2)  or (paropcion = 5) or (paropcion = 15)  or (paropcion = 16) then
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio  from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'Condonaci�n de Folio o Error de captura';

end if;
-- pago por folio de recaudadora;
if (paropcion = 3)  then
      select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
  if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
    let varok = 1;
     let varobs = 'pago hecho correctamente';

end if;
-- pago por folio de recaudadora cajero;
if (paropcion = 13)  then
     select nvl(num_acuerdo,0) , (b.tarifa + b.costo_fijo01) into v_acuerdo , v_tarifa from ta14_folios_adeudo a, ta14_tarifas b
     where a.axo = paraxo and a.folio = parfolio 
         and  a.infraccion = b.num_clave 
         and a.fecha_folio between b.fecha_inicial and b.fecha_fin;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
   insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   insert into  ta14_folios_hco (control ,  importe_infraccion ,    porcentaje ,    importe_cobrado)
                 values ( varcontrol, v_tarifa, parporcentaje , parImporteFolio);  
    delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
--- Cuando hay notificaciones del estado.

    if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
       let varok = 1; 
       let varobs = 'pago hecho correctamente';

end if;

if (paropcion = 4)  then

       foreach 
          select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
          into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio  from ta14_folios_adeudo  where placa = parplaca
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = vaxo and folio = vfolio;
   end foreach;
    let varok = 1;
     let varobs = 'pago hecho por placa correctamente';

end if;


if (paropcion = 6)  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
                          
                           
else
  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 6                
	 ) then
                 
        select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
    let varok = 1;
     let varobs = 'pago hecho correctamente';
   else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';
      
end if;
end if;

end if;

if (paropcion = 7 )  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
      else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';                     
                          
end if;

end if;

-- BANORTE

if (paropcion = 10)  then
   let varok = 10;
   if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio 
 	 ) then
        select placa into vplaca from ta14_folios_adeudo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
    if ban_placa = vplaca then

      insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
      delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 0 
     where axo = paraxo and folio = parfolio ;

     let varobs = 'pago hecho correctamente';
    let varok = 0;
  else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varok = 0;
  end if;

end if;
                      
                           

  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 10             
	 ) then

        select placa into vplaca from ta14_folios_histo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
      if ban_placa = vplaca then          
    
             select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
         insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 1 
     where axo = paraxo and folio = parfolio ;
    let varobs = 'pago hecho correctamente con pago doble de otro medio';
    let varok = 1;
    else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varobs = 'Folio no coincide la placa';
    let varok = 1;
    end if;
  
    
   else      
    if varok = 10 then

     -- no se insertaran los datos nuevos por que existen muchos errores de los archivos del Banco;
     --select  fecha_folio, placa, infraccion   into vfecha , vplaca , vinfra from ta14_fol_banorte  where axo = paraxo and folio = parfolio ; 
     --insert into ta14_folios_histo   values ( 0,today,    paraxo, parfolio, vfecha, vplaca, vinfra , 14, 999 , null, today, parusuauto, paropcion, parusuauto, 0 , 0);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;

        
          let varok = 0;
          let varobs = 'se inserta para estos datos lectura';
    end if; 
end if;

end if;




return varok, varobs;
--trace off;



end procedure
;

create procedure "informix".cajero_pub_total1(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning  
int as cta , char(1) as obligatorio , varchar(30) as concepto,  money(12,2) as importe;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
 FOREACH
  select b.cuentaapl, b.tipo   ,  sum(ade_importe)
   into v_cuentaapl , v_tipochar , v_adeudo
  from pubadeudo a, pubtipoadeudo b
  where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo <> 10 and a.tipo = b.tipo_id group by 1,2 

 let v_otros = v_otros + v_adeudo;
return v_cuentaapl ,'S', v_tipochar , v_adeudo with resume;

end foreach;

  FOREACH
  select Axo, mes, (axo  * 100 )+ mes ,  ade_importe
   into v_axo , v_mes , perioI , v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
 and  tipo = 10
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     if v_porcentaje is null then
        let v_porcentaje = 0;
     end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;

   
--  totales
    if v_axo = year(today) then
    begin
    let v_cuota = v_cuota + v_adeudo;
    let v_rectot = v_rectot + v_recargos;
     end
    else
     begin
    let v_cuota_r = v_cuota_r + v_adeudo;
    let v_rectot_r = v_rectot_r + v_recargos;
     end
   end if;
end foreach;
if v_cuota > 0 then
return  370100000,'S', 'Cuota:', v_cuota with resume; --42804
end if;
if v_rectot > 0 then
return 390600000 ,'S', 'Recargos:', v_rectot with resume; --46201
end if;
if v_cuota_r > 0 then
return  370130000,'S', 'Cuota Rezago:', v_cuota_r with resume; --42804
end if;
if v_rectot_r > 0 then
return 390600000 ,'S', 'Recargos Rezago:', v_rectot_r with resume; --46201
end if;
let total = v_cuota + v_otros + v_rectot + v_cuota_r + v_rectot_r ;
 execute procedure redondeocaja(total) into totals , r_Imp_Rdeo;
if r_Imp_Rdeo <> 0 then
return 550800000 ,'S', 'Ajuste Articulo 14 de la Ley de ingresos', r_Imp_Rdeo with resume; --46902
end if;
end procedure;

CREATE PROCEDURE "informix".getcomputer()
   returning char(45);
   
   define  v_computer  char(45);
   
    select sid||'#' || trim(username)|| '@' || trim(hostname) into v_computer 
    from sysmaster:syssessions where sid = DBINFO('sessionid');


    return    v_computer;
END PROCEDURE;

CREATE PROCEDURE "informix".diasbaja_estac(Vaxo integer , Vfolio integer)
   returning integer as dias;
   DEFINE V_DIAS INTEGER;
   select today - fecha_folio INTO V_DIAS from ta14_folios_adeudo WHERE AXO = VAXO and FOLIO = VFOLIO;
    return    V_DIAS;
END PROCEDURE;

create procedure "informix".sp_exc_genadeudo(p_opc int , p_pubid  int ,p_axo int ,p_mes int,p_axof int ,p_mesf int, p_userid int) 

returning
int as id,
char(50) as mensaje;
define v_opc int ;
 define v_descrip char(50);
 define v_adeudo money(12,2)     ;
 define v_adeudo_bat money(12,2)     ;
 define v_adeudo_cord money(12,2)     ;
 define v_importe money(12,2)     ;
 define v_importe_bat money(12,2)     ;
 define v_importe_cord money(12,2)     ;
  define  v_cupo  int; 
  define v_pubcategoria_id int;
  define v_axo int; define v_mes int;     define v_mes1 int;     define v_mes2 int;
  define v_res int ; define v_res1 char(50);
 define v_res2 int ; define v_res3 char(50);
  define v_concepto varchar(40);
  define fecha_dato  date;
  define v_bateria decimal(6,2);
 define v_cordon decimal(6,2);
 define v_factor decimal(6,2);
 let v_opc =0;

 let v_descrip = 'Folio Grabado Correctamente';
-- opc 1 para generar un solo adeudo.
select factor into v_factor from ex_contrato where id = p_pubid;
if p_opc = 1 then
-- begin
--    on exception in (-239)
--    let v_opc = -1;
--    let v_descrip = 'No se Grabo el Folio';
--    end exception;
if exists(select id from ex_adeudo where ex_contrato_id = p_pubid and axo = p_axo
     and mes = p_mes and tipo = 20 ) then 
    let v_opc = -1;
    let v_descrip = 'Ya existe este adeudo';
else
  -- Datos para Bateria
 select   total_bateria , total_cordon  into v_bateria , v_cordon 
 from ex_contrato where id = p_pubid;
 let fecha_dato = mdy(p_mes,1,p_axo);
 -- Valor de Bateria
 select importe  into v_importe_bat from pubcatimporte 
       where pubcategoria_id =  15 
      and fecha_dato between fecha_inicio and fecha_fin ;
     if v_importe_bat is null then
        let v_importe_bat = 0;
     end if;
 -- Valor de Cordon
    select importe into v_importe_cord from pubcatimporte 
       where pubcategoria_id =  16
      and fecha_dato between fecha_inicio and fecha_fin ;
    if v_importe_cord is null then
       let v_importe_cord = 0;
     end if;

 let  v_adeudo_bat = v_importe_bat * v_bateria ;
 let  v_adeudo_cord = v_importe_cord * v_cordon ;
 if v_bateria > 0 and v_cordon > 0 then
 let v_concepto = 'En Bateria :' ||  v_bateria ||' En Cordon: ' ||  v_cordon ;
 end if;
 if v_bateria = 0 and v_cordon > 0 then
 let v_concepto = 'En Cordon: ' ||  v_cordon ;
 end if;
 if v_bateria > 0 and v_cordon = 0 then
 let v_concepto = 'En Bateria :' ||  v_bateria  ;
 end if;
  if v_factor <> 100 then
     let v_adeudo_bat = v_adeudo_bat * v_factor;
     let v_adeudo_cord = v_adeudo_cord * v_factor;
   end if;
 let v_adeudo = v_adeudo_bat + v_adeudo_cord;
 if v_factor > 0 then
 insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,p_pubid, p_axo , p_mes, 20 , v_concepto , v_adeudo , 0,p_userid);
 end if;
let v_opc =0;
 let v_descrip = 'Adeudo Generado correctamente';
end if;
end if;
 -- opc 1 para generar adeudos por periodo 
if p_opc = 2 then
  -- verificar datos del periodo;
     if p_axo > p_axof then
         let v_opc = -2;
         let v_descrip = 'A�o final es inferior al inicial';
     else
         if p_axo = p_axof then
            if p_mes > p_mesf then
             let v_opc = -2;
             let v_descrip = 'Mes final es inferior al inicial';
                      
            end if;
         end if;
   end if;
   if v_opc = 0 then
 --  let v_axo = p_axo ;
   let v_mes1 = p_mes;
    if p_axo = p_axof then
     let v_mes2 = p_mesf   ;
     else
     let v_mes2 = 12;
     end if;
   for v_axo in (p_axo to p_axof step 1)
       for v_mes in (v_mes1 to v_mes2 step 1)
          if v_axo > p_axo and v_mes = 1 and v_factor > 0 then
             execute procedure sp_exc_refrendo(p_pubid  , v_axo ,  p_userid ) into v_res2 , v_res3;
            
          end if;
       execute procedure sp_exc_genadeudo(1 , p_pubid ,v_axo,v_mes,0,0, p_userid) into v_res , v_res1;
       end for;
        let v_mes1 = 1;
         if v_axo = p_axof then
           let v_mes2 = p_mesf   ;
         else
           let v_mes2 = 12;
         end if;
   end for;
 end if;  
  end if; 

return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".sp_exc_ubicacion_no( p_opc int , P_no_exclusivo INT,
p_cordo decimal(5,2) , p_bateria decimal(5,2) , p_calle VARCHAR(40)  ) 

returning
int as id,
char(50) as mensaje;
define vgencode int ;
define vgendesc varchar(40);
define v_opc int ;
define v_id_ubic int;
define v_contrato_id INT;
define v_tipo_est VARCHAR(1);
define v_calle VARCHAR(40);
define v_colonia VARCHAR(40);
define v_zona INT;
define v_subzona INT;
define v_extension_de decimal(5,2);
define v_acera CHAR(1);
define v_interseccion1 VARCHAR(40);
define v_interseccion2 VARCHAR(40);
define v_apartir_de INT;
define v_hacia_el CHAR(1);
--set debug file to 'ubicacion.log';
--trace on;
-- opc 1 alta de ubicaciones
if p_opc = 1 then

select id into v_contrato_id from ex_contrato where no_exclusivo = P_no_exclusivo ;
   if p_bateria > 0 then
     insert into ex_ubicacion (id , ex_contrato_id , tipo_est , calle , extension_de,
        estatus ,   fecha_in, usuario, pc) 
       values (0 , v_contrato_id , 'B' , p_calle , p_bateria , 'V' , current, 1, getcomputer() );
       let vgencode = 0;
        let vgendesc = 'Alta correctamente';
   end if;
   if p_cordo > 0 then
     insert into ex_ubicacion (id , ex_contrato_id , tipo_est , calle , extension_de,
        estatus ,   fecha_in, usuario, pc) 
       values (0 , v_contrato_id , 'C' , p_calle , p_cordo , 'V' , current, 1, getcomputer() );
       let vgencode = 0;
       let vgendesc = 'Alta correctamente';
  end if;
end if;
-- opc 2 cancelacion de ubicacion
-- solo de modifica el campo status y la fecha at
if p_opc = 2 then
   update ex_ubicacion set estatus = "C" , fecha_at = current where id = p_id_ubic and estatus = "V";
 let vgencode = 0;
    let vgendesc = 'Cancelacion correctamente';
end if;

return vgencode , vgendesc ;
--trace off;
END PROCEDURE;

create procedure "informix".sp_exc_genadeudono(p_opc int , p_pubid  int ,p_axo int ,p_mes int,p_axof int ,p_mesf int, p_userid int) 

returning
int as id,
char(50) as mensaje;
define v_opc int ;
 define v_descrip char(50);
 define v_adeudo money(12,2)     ;
 define v_adeudo_bat money(12,2)     ;
 define v_adeudo_cord money(12,2)     ;
 define v_importe money(12,2)     ;
 define v_importe_bat money(12,2)     ;
 define v_importe_cord money(12,2)     ;
  define  v_cupo  int; 
  define v_pubcategoria_id int;
  define v_axo int; define v_mes int;     define v_mes1 int;     define v_mes2 int;
  define v_res int ; define v_res1 char(50);
 define v_res2 int ; define v_res3 char(50);
  define v_concepto varchar(40);
  define fecha_dato  date;
  define v_bateria decimal(6,2);
 define v_cordon decimal(6,2);
 define v_factor decimal(6,2);
 define v_contrato_id integer ;
 let v_opc =0;

 let v_descrip = 'Folio Grabado Correctamente';
-- opc 1 para generar un solo adeudo.
 select id into v_contrato_id from ex_contrato where no_exclusivo = p_pubid ;
select factor into v_factor from ex_contrato where id = v_contrato_id;
if p_opc = 1 then
-- begin
--    on exception in (-239)
--    let v_opc = -1;
--    let v_descrip = 'No se Grabo el Folio';
--    end exception;
 
if exists(select id from ex_adeudo where ex_contrato_id = v_contrato_id and axo = p_axo
     and mes = p_mes and tipo = 20 ) then 
    let v_opc = -1;
    let v_descrip = 'Ya existe este adeudo';
else
  -- Datos para Bateria
 select   total_bateria , total_cordon  into v_bateria , v_cordon 
 from ex_contrato where id = v_contrato_id;
 let fecha_dato = mdy(p_mes,1,p_axo);
 -- Valor de Bateria
 select importe  into v_importe_bat from pubcatimporte 
       where pubcategoria_id =  15 
      and fecha_dato between fecha_inicio and fecha_fin ;
     if v_importe_bat is null then
        let v_importe_bat = 0;
     end if;
 -- Valor de Cordon
    select importe into v_importe_cord from pubcatimporte 
       where pubcategoria_id =  16
      and fecha_dato between fecha_inicio and fecha_fin ;
    if v_importe_cord is null then
       let v_importe_cord = 0;
     end if;

 let  v_adeudo_bat = v_importe_bat * v_bateria ;
 let  v_adeudo_cord = v_importe_cord * v_cordon ;
 if v_bateria > 0 and v_cordon > 0 then
 let v_concepto = 'En Bateria :' ||  v_bateria ||' En Cordon: ' ||  v_cordon ;
 end if;
 if v_bateria = 0 and v_cordon > 0 then
 let v_concepto = 'En Cordon: ' ||  v_cordon ;
 end if;
 if v_bateria > 0 and v_cordon = 0 then
 let v_concepto = 'En Bateria :' ||  v_bateria  ;
 end if;
  if v_factor <> 100 then
     let v_adeudo_bat = v_adeudo_bat * v_factor;
     let v_adeudo_cord = v_adeudo_cord * v_factor;
   end if;
 let v_adeudo = v_adeudo_bat + v_adeudo_cord;
 if v_factor > 0 then
 insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,v_contrato_id, p_axo , p_mes, 20 , v_concepto , v_adeudo , 0,p_userid);
 end if;
let v_opc =0;
 let v_descrip = 'Adeudo Generado correctamente';
end if;
end if;
 -- opc 1 para generar adeudos por periodo 
if p_opc = 2 then
  -- verificar datos del periodo;
     if p_axo > p_axof then
         let v_opc = -2;
         let v_descrip = 'A�o final es inferior al inicial';
     else
         if p_axo = p_axof then
            if p_mes > p_mesf then
             let v_opc = -2;
             let v_descrip = 'Mes final es inferior al inicial';
                      
            end if;
         end if;
   end if;
   if v_opc = 0 then
 --  let v_axo = p_axo ;
   let v_mes1 = p_mes;
    if p_axo = p_axof then
     let v_mes2 = p_mesf   ;
     else
     let v_mes2 = 12;
     end if;
   for v_axo in (p_axo to p_axof step 1)
       for v_mes in (v_mes1 to v_mes2 step 1)
          if v_axo > p_axo and v_mes = 1 and v_factor > 0 then
             execute procedure sp_exc_refrendo(v_contrato_id  , v_axo ,  p_userid ) into v_res2 , v_res3;
            
          end if;
       execute procedure sp_exc_genadeudo(1 , v_contrato_id ,v_axo,v_mes,0,0, p_userid) into v_res , v_res1;
       end for;
        let v_mes1 = 1;
         if v_axo = p_axof then
           let v_mes2 = p_mesf   ;
         else
           let v_mes2 = 12;
         end if;
   end for;
 end if;  
  end if; 

return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".fn_exc_ade_ant( p_contrato_id int ) 
returning  money(12,2) as adeudo ;
 define v_adeudo money(12,2)     ;
 select sum(ade_importe) into v_adeudo from ex_adeudo  where ex_contrato_id = p_contrato_id and axo < year(today);
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_exc_ade_act( p_contrato_id int ) 
returning  money(12,2) as adeudo_act ;
 define v_adeudo money(12,2)     ;
 select sum(ade_importe) into v_adeudo from ex_adeudo 
  where ex_contrato_id = p_contrato_id and axo = year(today) 
 and (axo * 100) + mes <= (year(today) * 100) + month(today) ;
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_exc_ade_fut( p_contrato_id int ) 
returning  money(12,2) as adeudo_fut ;
 define v_adeudo money(12,2)     ;
 select sum(ade_importe) into v_adeudo from ex_adeudo 
  where ex_contrato_id = p_contrato_id and axo = year(today) 
 and (axo * 100) + mes > (year(today) * 100) + month(today) ;
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_exc_axomin( p_contrato_id int ) 
returning  int as axomin ;
 define v_axomin int     ;
   select min(axo) into v_axomin from  ex_adeudo  where ex_contrato_id = p_contrato_id and tipo = 20; 
--if v_axomin is null then
--  let v_axomin = year(today) +1;
-- end if;
 return v_axomin ;
END PROCEDURE;

create procedure "informix".fn_exc_mesmin( p_contrato_id int ) 
returning  int as mesmin ;
 define v_mesmin int     ;

  select min(mes) into v_mesmin from ex_adeudo where ex_contrato_id = p_contrato_id and tipo = 20
     and axo = fn_exc_axomin(p_contrato_id);
 
-- if v_mesmin is null then
--    let v_mesmin = 1;
--end if;
 return v_mesmin ;
END PROCEDURE;

create procedure "informix".sp_exc_refrendo( p_excid  int, p_axo int ,  p_userid int) 

returning
int as id,
char(50) as mensaje;
define v_opc int ;
 define v_descrip char(50);
 define v_adeudo money(12,2)     ;
 define v_adeudo_bat money(12,2)     ;
 define v_adeudo_cord money(12,2)     ;
 define v_importe money(12,2)     ;
 define v_importe_bat money(12,2)     ;
 define v_importe_cord money(12,2)     ;
  define  v_cupo  int; 
  define v_pubcategoria_id int;
  define v_axo int; define v_mes int;     define v_mes1 int;     define v_mes2 int;
  define v_res int ; define v_res1 char(50);
  define v_concepto varchar(40);
  define fecha_dato  date;
  define v_bateria decimal(6,2);
  define v_cordon decimal(6,2);
  define v_factor decimal(6,2);
  define v_zona char(1);
  define v_tipo_adeudo int;
   define v_idcat int;
   define v_categoria char(2);

  let v_opc =0;

  let v_descrip = 'Folio Grabado Correctamente';
 if p_axo < year(today) then
   let v_tipo_adeudo = 27;
  else
    let v_tipo_adeudo = 26;
  end if;

if exists(select id from ex_adeudo where ex_contrato_id = p_excid and axo = p_axo
      and tipo = v_tipo_adeudo ) then 
    let v_opc = -1;
    let v_descrip = 'Ya existe este adeudo';
else
  -- obtener datos de calculo
 select   factor, zona into  v_factor , v_zona
            from ex_contrato where id = p_excid;
 let fecha_dato = mdy(1,1,p_axo);
 -- Valor de Bateria
  let v_categoria = 'R' || v_zona;
  select id into v_idcat from pubcategoria where tipo = 'E' and categoria = v_categoria;

 select importe  into v_importe_bat from pubcatimporte 
       where pubcategoria_id =  v_idcat
       and fecha_dato between fecha_inicio and fecha_fin ;
     if v_importe_bat is null then
        let v_importe_bat = 0;
     end if;

  if v_factor <> 100 then
   let  v_adeudo = v_importe_bat   * v_factor;
  else
   let  v_adeudo = v_importe_bat   ;
   end if;
let v_concepto = 'Refrendo por el A�o ' || p_axo;
 
if v_factor <> 0 then
   insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,p_excid, p_axo , 1, v_tipo_adeudo , v_concepto , v_adeudo , 0,p_userid);
   end if;
let v_opc =0;
 let v_descrip = 'Adeudo Generado correctamente';
end if;

 -- opc 1 para generar adeudos por periodo 


return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".cajero_exc_detalle1(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning   varchar(50) as concepto , 
int as axo , int as mes, money(12,2) as adeudo , money(10,2) as recargos, money(10,2) as descto_recgos 
, int as tipo , int as id_adeudo;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);

define v_id_adeudo int;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
  
  FOREACH
  select case when tipo <> 20 then axo || '00' else axo || lpad(mes,2,'0') end ,tipo , Axo, mes, (axo  * 100 )+ mes , 
    concepto, ade_importe , id 
   into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo , v_id_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,3,4
   select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
  
 if v_tipo = 20 then
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
          
      if v_calrec = 0 then
     let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
   if (v_tipo = 26) or (v_tipo = 27) then
     execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
     let v_recargos =   v_recargos + v_recgos_ref;
   end if;

return v_concepto , v_axo , v_mes ,  v_adeudo , v_recargos , v_descto_recgos , v_tipo , v_id_adeudo with resume;
end foreach;
end procedure;

create procedure "informix".sp_exc_consulta1(p_opc int ,p_numesta int, p_desc varchar(20)  )
returning
int as id , int as numesta, varchar(100) as nombre,
varchar(100) as domicilio, 
 char(1) as zona , decimal(6,2) as bateria , decimal(6,2) as cordon, int as axo_pago , int as mes_pago, int as idmsg , varchar(200) as msg 
, char(50) as colonia , char(15) as telefono , char(15) as RFC;

define v_idmain int ; define v_numesta int; define v_nombre varchar(100) ;
define v_domicilio varchar(100) ; 
define v_zona char(1) ; define v_bateria decimal(6,2) ; define v_cordon decimal(6,2);
define v_axopag int; define v_mespag int; define v_adeudoC int;
define v_idmsg int; define v_msg varchar(200);   
define v_peri int;
define v_colonia char(50);
define v_rfc char(15) ;
define v_telefono char(15);

   let v_idmsg = 0;
   let v_msg = 'No proceso nada';
-- por numero de estacionamiento individual
if p_opc = 1 then 
 
--select * from ex_propietario
select a.id , a.no_exclusivo, trim(b.propietario), trim(b.domicilio) , a.zona,  a.total_bateria , a.total_cordon ,
trim(b.colonia) , trim(b.rfc) , trim(b.telefono)
into  v_idmain ,v_numesta , v_nombre  ,v_domicilio, v_zona, v_bateria, v_cordon ,
 v_colonia , v_rfc , v_telefono
 from ex_contrato a, ex_propietario b
 where a.ex_propietario_id = b.id and a.no_exclusivo = p_numesta   and estatus = 'V'  ;

if v_idmain is null then
 let v_idmain =  0;  let v_numesta = 0; let v_nombre = ''; let  v_domicilio = '';
  let v_zona = "";  let v_colonia = ""; let v_rfc = ""; let v_telefono = "";
let v_bateria =0; let v_cordon = 0; let v_axopag = 0 ; let v_mespag = 0;
  let v_idmsg = -1 ; let v_msg = 'No existe registro de este Exclusivo';
end if;

if v_idmsg = 0 then
  -- verificar mes ultimo de pago.
   select max((axo * 100)+ mes) 
   into v_peri 
   from ex_adeudo_histo  
   where ex_contrato_id = v_idmain and clave = 13; 
   
   if v_peri is null then
        let v_idmsg = 1 ; let v_msg = 'No hay pagos';
        let v_axopag = 0; let v_mespag =0;
   else
       let v_axopag = trunc(v_peri / 100) ;
       let v_mespag = v_peri - (v_axopag *100) ;
       let v_idmsg = 2 ; let v_msg = 'Ultimo pago';
   end if;
   select count(axo) into v_adeudoC from ex_adeudo where ex_contrato_id = v_idmain ;
   if ((v_adeudoc is null) or (v_adeudoc = 0   ))   then
      let v_idmsg = 3 ; let v_msg = 'No hay Adeudos vigentes'; 
   else 
       let v_idmsg = 0 ; let v_msg = 'Tiene Adeudos a cobrar'; 
  end if;
 end if;
--
 return  
 v_idmain  ,v_numesta , v_nombre,  v_domicilio,   v_zona,  v_bateria , v_cordon ,v_axopag , v_mespag , v_idmsg , v_msg  ,
  v_colonia , v_telefono   , v_rfc ;



end if;


END PROCEDURE;

create procedure "informix".sp_exc_altacontrato( p_idprop int, p_noexclusivo int, p_zona char(1), 
p_solicitud int, p_control int , p_vialidad char(20), p_idclasif int , p_bateria decimal(5,2) ,
p_cordon decimal(5,2) , p_fecha_inicial date , p_usuario int  , p_placa char(1), p_baliza char(1) , p_forma char(1)  ) 

returning
int as id,
char(50) as mensaje;
define v_opc int ;
define v_idexclusiv int;
define v_descrip char(50);
define vgencode int;
define vgendesc char(50);

define     v_factor DECIMAL(6,2);
select factor  into v_factor from ex_clasificacion where id = p_idclasif;
--se crea el contrato.
insert into ex_contrato ( id ,ex_propietario_id ,
    no_exclusivo , zona ,total_bateria ,total_cordon , solicitud , control , estatus ,
    factor , id_clasificacion , vialidad , fecha_inicial, usuario, pc, fecha_in  )
    values (0, p_idprop ,p_noexclusivo ,  p_zona , p_bateria , p_cordon  ,p_solicitud , p_control ,'V', v_factor,
       p_idclasif ,p_vialidad , p_fecha_inicial, p_usuario, getcomputer(), current);
 LET v_idexclusiv = dbinfo("sqlca.sqlerrd1");
-- se genera adeudo
if p_forma = 'S' then
   execute procedure sp_exc_autorizacion( p_noexclusivo , year(p_fecha_inicial), month(p_fecha_inicial), p_placa , p_baliza , p_forma,  p_usuario) 
    into vgencode , vgendesc;
    execute procedure sp_exc_genadeudo(2 , v_idexclusiv , year(p_fecha_inicial) , month(p_fecha_inicial) , year(today) , 12 , p_usuario )
    into vgencode , vgendesc;
else
   execute procedure sp_exc_genadeudo(2 , v_idexclusiv , year(p_fecha_inicial) , month(p_fecha_inicial) , year(today) , 12 , p_usuario )
    into vgencode , vgendesc;
end if;

return v_idexclusiv , vgendesc ;

END PROCEDURE;

create procedure "informix".kiosco_parkingliq1(parplaca char(7), paraxoini int , parfolioini int , 
paraxohasta int, parfoliohasta int , parmedio int)
--transaccion , numfolios , axofinal,foliofinal, descrip , descripnot, idmedio, impactual, impanterior, impmulta, impredondeo
returning  int , int, char(250),char(200), int, money(12,2), money(12,2), money(12,2),money(4,2), int,int,int,int;

define v_idtrans int;
define v_nofol   int;
define v_descrip  char(250);
define v_descripnot char(200);
define v_impactual money(12,2);
define v_impanterior money(12,2);
define v_impMulta money(12,2);
define v_impredondeo money(4,2);
define v_axoactual int;
define v_folioinicial int;
define v_foliofinal int;
define contador int;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define vinfra int;
define dias_cuantos integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define v_tot money(12,2);
define v_totpag money(12,2);
define v_folionot char(20);
define v_axotrans int;
   define v_foliotrans int;


let v_folioinicial = ((paraxoini * 1000000)+parfolioini) ;
let v_foliofinal = ((paraxohasta * 1000000)+parfoliohasta) ;

 
let contador = 0;
let v_impactual = 0;
let v_impanterior = 0;
let v_impmulta = 0;
let v_descrip = 'Folios:';
let v_descripnot = '';

foreach 

Select a.axo, a.folio,  b.tarifa, a.infraccion, a.fecha_folio ,nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio,  vtarifa ,vinfra,vfecha  ,vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal)
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 5 asc
 
if length(v_descrip) >=245 then 
   exit foreach;
end if;
   let v_axotrans = vaxo ;
   let v_foliotrans = vfolio;
let contador = contador +1;

let v_descrip = trim(v_descrip)|| vaxo || '-' ||vfolio||';';
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if weekday(vfecha) = 6 then
   let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;



--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
if year(today) = year(vfecha) then
   let v_impactual = v_impactual + vimp_apagar;
else
   let v_impanterior = v_impanterior + vimp_apagar;
end if;

end foreach;
let v_foliofinal = ((v_axotrans * 1000000)+ v_foliotrans) ;
foreach 
select noti.folionot into v_folionot
 from ta14_notifica_edo noti where noti.num_acuerdo in 
(select distinct a.num_acuerdo
from ta14_folios_adeudo a where  a.placa = parplaca and a.num_acuerdo > 0
 and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal))
 and noti.fechapago is null and noti.fechacancelado is null

 let v_descripnot = trim(v_descripnot)||' ' || trim(v_folionot);
 let v_impMulta = v_impMulta + 23;
end foreach;
--Consulta si existe el mismo dia una transaccion realizada con los mismos folios.
 if exists (select numtrans from ta14_kio_trans 
         where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and fecha = today 
                and impactual = v_impactual and impanterior = v_impanterior )  then
    select numtrans into v_idtrans from ta14_kio_trans 
             where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and fecha = today
               and impactual = v_impactual and impanterior = v_impanterior;
  else
   insert into ta14_kio_trans (
    numtrans ,    placa ,    foliosdescrip ,    notifdescrip ,
    axoini ,    folioini ,    axofin ,    foliofin ,    numfolios ,
    idmedio ,    impactual ,    impanterior,    impmulta , fecha , hora) 
  values(0,parplaca , v_descrip, v_descripnot , 
  paraxoini  , parfolioini  , v_axotrans , v_foliotrans , contador , parmedio
 , v_impactual , v_impanterior, v_impMulta, today, current hour to second);
   LET v_idtrans = dbinfo("sqlca.sqlerrd1");
  end if;
let v_tot = v_impactual +v_impanterior+ v_impMulta;
execute procedure redondeokiosco(v_tot) into v_totpag, v_impredondeo;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.
return  v_idtrans , contador, v_descrip  , v_descripnot ,parmedio, v_impactual , v_impanterior,
 v_impMulta , v_impredondeo, 510900000, 925100001, 992100006 ,55080000;

end procedure;

create procedure "informix".cajero_exc_total1(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning  
int as cta , char(1) as obligatorio , varchar(30) as concepto,  money(12,2) as importe;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_rectotdesc money(12,2);
define v_descrectot_r money(12,2);
define v_recgos_ref money(12,2);
define v_calrec int;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
        let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;

 FOREACH
  select b.cuentaapl, b.tipo   ,  sum(ade_importe)
   into v_cuentaapl , v_tipochar , v_adeudo
  from ex_adeudo a, pubtipoadeudo b
  where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo in (21,23,24,25,26,27) and a.tipo = b.tipo_id group by 1,2 

 let v_otros = v_otros + v_adeudo;
return v_cuentaapl ,'S', v_tipochar , v_adeudo with resume;

end foreach;
 let v_descrectot_r = 0;
  let v_rectotdesc = 0;
  FOREACH
  select Axo, mes, (axo  * 100 )+ mes ,  ade_importe
   into v_axo , v_mes , perioI , v_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
 and  tipo = 20
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     if v_porcentaje is null then
        let v_porcentaje = 0;
     end if;
  select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
  let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
    -- ver si se calculan los recargos o no por se nuevo.
     if v_calrec = 0 then
     let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_porc_recgos > 0 and v_recargos > 0 then 
    -- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
     end if;
   
--  totales
    if v_axo = year(today) then
            let v_cuota = v_cuota + v_adeudo;
           let v_rectot = v_rectot + v_recargos;
           let v_rectotdesc =  v_rectotdesc + v_descto_recgos;
      else
          let v_cuota_r = v_cuota_r + v_adeudo;
         let v_rectot_r = v_rectot_r + v_recargos;
         let v_descrectot_r = v_descrectot_r + v_descto_recgos;
    end if;
end foreach;
-- calcula los recargos de refrendo.
 FOREACH
  select Axo, mes, (axo  * 100 )+ mes ,  ade_importe
   into v_axo , v_mes , perioI , v_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
  and  tipo in (26,27)

   execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
   if v_axo = year(today) then
           let v_rectot = v_rectot + v_recgos_ref;
           --let v_rectotdesc =  v_rectotdesc + v_descto_recgos;
      else
          let v_rectot_r = v_rectot_r + v_recgos_ref;
       --  let v_descrectot_r = v_descrectot_r + v_descto_recgos;
    end if;



   end foreach;
--
if v_cuota > 0 then
return  364100000,'S', 'Cuota:', v_cuota with resume; --42804
end if;
if v_rectot > 0 then
return 390600000 ,'S', 'Recargos:', v_rectot with resume; --46201
end if;
if v_rectotdesc > 0 then
   let v_rectotdesc = v_rectotdesc *-1;
return 390600000 ,'S', 'Descuento Recargos:', v_rectotdesc with resume; --46201
end if;
if v_cuota_r > 0 then
return  364130000,'S', 'Cuota Rezago:', v_cuota_r with resume; --42804
end if;
if v_rectot_r > 0 then
return 390630000 ,'S', 'Recargos Rezago:', v_rectot_r with resume; --46201
end if;
if v_descrectot_r > 0 then
   let v_descrectot_r = v_descrectot_r -1;
return 390600000 ,'S', 'Descuento Recargos Rezago:', v_descrectot_r with resume; --46201
end if;


let total = v_cuota + v_otros + v_rectot + v_cuota_r + v_rectot_r - v_descrectot_r - v_rectotdesc;
 execute procedure redondeocaja(total) into totals , r_Imp_Rdeo;
if r_Imp_Rdeo <> 0 then
return 550800000 ,'S', 'Ajuste Articulo 14 de la Ley de ingresos', r_Imp_Rdeo with resume; --46902
end if;
end procedure;

create procedure "informix".sp_exc_ubicacion( p_opc int ,p_id_ubic int, P_contrato_id INT,
p_tipo_est VARCHAR(1), p_calle VARCHAR(40), p_colonia VARCHAR(40),
p_zona INT, p_subzona INT, p_extension_de decimal(5,2), p_acera CHAR(1), p_interseccion1 VARCHAR(40),
p_interseccion2 VARCHAR(40), p_apartir_de INT, p_hacia_el CHAR(1) , p_usuario int  ) 

returning
int as id,
char(50) as mensaje;
define vgencode int ;
define vgendesc varchar(40);
define v_opc int ;
define v_id_ubic int;
define v_contrato_id INT;
define v_tipo_est VARCHAR(1);
define v_calle VARCHAR(40);
define v_colonia VARCHAR(40);
define v_zona INT;
define v_subzona INT;
define v_extension_de decimal(5,2);
define v_acera CHAR(1);
define v_interseccion1 VARCHAR(40);
define v_interseccion2 VARCHAR(40);
define v_apartir_de INT;
define v_hacia_el CHAR(1);
define v_axo int;
define v_mes int;
define v_periodo int;
define v_cordon int;
define v_bateria int;
-- opc 1 alta de ubicaciones sin calculo de metros y regeneracion de adeudos.
if p_opc = 1 then
insert into ex_ubicacion (id , ex_contrato_id , tipo_est , calle , colonia, zona, subzona , extension_de, acera , interseccion1 ,
    apartir_de , hacia_el ,  estatus ,   fecha_in, usuario, pc) 
    values (0 , P_contrato_id , p_tipo_est , p_calle , p_colonia, p_zona, p_subzona , p_extension_de, p_acera , p_interseccion1 ,
    p_apartir_de , p_hacia_el ,  "V" , current, p_usuario, getcomputer() );
    let vgencode = 0;
    let vgendesc = 'Alta correctamente';
end if;
-- opc 2 alta de ubicaciones con calculo de metros y regeneracion de adeudos.
if p_opc = 2 then
insert into ex_ubicacion (id , ex_contrato_id , tipo_est , calle , colonia, zona, subzona , extension_de, acera , interseccion1 ,
    apartir_de , hacia_el ,  estatus ,   fecha_in, usuario, pc) 
    values (0 , P_contrato_id , p_tipo_est , p_calle , p_colonia, p_zona, p_subzona , p_extension_de, p_acera , p_interseccion1 ,
    p_apartir_de , p_hacia_el ,  "V" , current, p_usuario, getcomputer() );
    let vgencode = 0;
    let vgendesc = 'Alta correctamente';
    select sum(extension_de) into v_cordon from ex_ubicacion where ex_contrato_id =  P_contrato_id and  tipo_est = 'C' and estatus = 'V';
    select sum(extension_de) into v_bateria from ex_ubicacion where ex_contrato_id =  P_contrato_id and  tipo_est = 'B' and estatus = 'V';
  if v_cordon is null then
     let v_cordon = 0;
  end if;
  if v_bateria is null then
      let v_bateria = 0;
  end if;
---select * from ex_contrato
     update ex_contrato set total_cordon = v_cordon , total_bateria = v_bateria
     where  id = P_contrato_id;
-- seleccionar el periodo minimo.
  select min((axo*100) + mes) into v_periodo  from ex_adeudo where ex_contrato_id = P_contrato_id; 
    if v_periodo is null then
       let v_axo = 0; let v_mes = 0;
      else
     let v_axo = trunc(v_periodo/100);
     let v_mes = v_periodo - ( v_axo * 100);
  end if;
   if v_axo > 2004 then
       delete ex_adeudo where ex_contrato_id = P_contrato_id;
       execute procedure sp_exc_genadeudo(2 , P_contrato_id , v_axo , v_mes , year(today) , 12 , p_usuario )
       into vgencode , vgendesc;
     let vgencode = 0;
     let vgendesc = 'Modificacion realizada con cambio de adeudos';
    
   end if;

end if;
-- opc 3 cancelacion de ubicacion
-- solo de modifica el campo status y la fecha at
if p_opc = 3 then
   update ex_ubicacion set estatus = "C" , fecha_at = current where id = p_id_ubic and estatus = "V";
 let vgencode = 0;
    let vgendesc = 'Cancelacion correctamente';
end if;

return vgencode , vgendesc ;

END PROCEDURE;

create procedure "informix".sp_exc_consulta(p_opc int ,p_numesta int, p_desc varchar(20)  )
returning
int as id , int as numesta, varchar(100) as nombre,
varchar(100) as domicilio, 
 char(1) as zona , decimal(6,2) as bateria , decimal(6,2) as cordon, int as axo_pago , int as mes_pago, int as idmsg , varchar(200) as msg 
, char(50) as colonia , char(15) as telefono , char(15) as RFC, varchar(60) as ubicacion;

define v_idmain int ; define v_numesta int; define v_nombre varchar(100) ;
define v_domicilio varchar(100) ; 
define v_zona char(1) ; define v_bateria decimal(6,2) ; define v_cordon decimal(6,2);
define v_axopag int; define v_mespag int; define v_adeudoC int;
define v_idmsg int; define v_msg varchar(200);   
define v_peri int;
define v_colonia char(50);
define v_rfc char(15) ;
define v_telefono char(15);
define v_ubicacion varchar(60);

   let v_idmsg = 0;
   let v_msg = 'No proceso nada';
-- por numero de estacionamiento individual
if p_opc = 1 then 
 
--select * from ex_propietario
select a.id , a.no_exclusivo, trim(b.propietario), trim(b.domicilio) , a.zona,  a.total_bateria , a.total_cordon ,
trim(b.colonia) , trim(b.rfc) , trim(b.telefono)
into  v_idmain ,v_numesta , v_nombre  ,v_domicilio, v_zona, v_bateria, v_cordon ,
 v_colonia , v_rfc , v_telefono 
 from ex_contrato a, ex_propietario b
 where a.ex_propietario_id = b.id and a.no_exclusivo = p_numesta   and estatus = 'V'  ;

if v_idmain is null then
 let v_idmain =  0;  let v_numesta = 0; let v_nombre = ''; let  v_domicilio = '';
  let v_zona = "";  let v_colonia = ""; let v_rfc = ""; let v_telefono = "";
let v_bateria =0; let v_cordon = 0; let v_axopag = 0 ; let v_mespag = 0;
  let v_idmsg = -1 ; let v_msg = 'No existe registro de este Exclusivo'; let  v_ubicacion = '';
end if;

 select    first 1  'Ubic: ' || trim(nvl(calle,'.')) || ' Col. ' || trim(nvl(colonia,'.')) 
    into v_ubicacion from ex_ubicacion where ex_contrato_id = v_idmain and estatus = 'V';

if v_idmsg = 0 then
  -- verificar mes ultimo de pago.
   select max((axo * 100)+ mes) 
   into v_peri 
   from ex_adeudo_histo  
   where ex_contrato_id = v_idmain and clave = 13; 
   
   if v_peri is null then
        let v_idmsg = 1 ; let v_msg = 'No hay pagos';
        let v_axopag = 0; let v_mespag =0;
   else
       let v_axopag = trunc(v_peri / 100) ;
       let v_mespag = v_peri - (v_axopag *100) ;
       let v_idmsg = 2 ; let v_msg = 'Ultimo pago';
   end if;
   select count(axo) into v_adeudoC from ex_adeudo where ex_contrato_id = v_idmain ;
   if ((v_adeudoc is null) or (v_adeudoc = 0   ))   then
      let v_idmsg = 3 ; let v_msg = 'No hay Adeudos vigentes'; 
   else 
       let v_idmsg = 0 ; let v_msg = 'Tiene Adeudos a cobrar'; 
  end if;
 end if;
--
 if trim(v_rfc) <> '' then
    let v_Nombre = trim(v_nombre) || '  RFC: ' || v_rfc;
 end if;
 if trim(v_colonia) <> '' then
    let v_domicilio = v_domicilio || '  COL: ' || v_colonia;
 end if;
 return  
 v_idmain  ,v_numesta , v_nombre,  v_domicilio,   v_zona,  v_bateria , v_cordon ,v_axopag , v_mespag , v_idmsg , v_msg  ,
  v_colonia , v_telefono   , v_rfc , v_ubicacion;



end if;


END PROCEDURE;

create function "informix".locate(p_instring varchar(255), p_lookfor varchar(1)) returning integer;

define w_work varchar(255);
define w_token char(1);
define w_location smallint;
define i smallint;

if (p_instring is NULL) then
-- or (p_lookfor = '')) then
let w_location = -1;
return w_location;
end if;

let w_work = trim(p_instring);
let w_token = p_lookfor;
let w_location = 0;

for i = 1 to length(w_work)
if ( substr(w_work,i,1) = w_token ) then
let w_location = i;
exit for ;
end if;
end for;

return w_location;
end function;

CREATE PROCEDURE "informix".spd_chg_conci( parcontrol int, paridbanco int,
		paraxo smallint,
                parfolio  integer,
		parPlaca char(7),
		parusuario  integer,
                parOpcion  smallint
		)
		returning smallint as clave;


define varcontrol integer;
define v_axo smallint; 
define  v_folio integer;  
define v_placa char(7);
define v_tipo char(1);
          
let v_tipo = 'E';
--set debug file to "c:\ivan.log";
--trace on;
if parOpcion = 1 then
   let v_tipo = 'P';



  select axo , folio , placa 
  into v_axo , v_folio , v_placa
  from ta14_folios_histo where control = parcontrol;

  update ta14_folios_histo set placa = parplaca , folio = parfolio , axo = paraxo where control = parcontrol;
  insert into ta14_fol_histo_chgconci(id_cambio , control_chg , old_axo , old_folio , old_placa ,
    new_axo ,  new_folio , new_placa , tipo, fecha_cambio , usuario ) 
    values ( 0, parcontrol ,v_axo , v_folio , v_placa , paraxo ,
                parfolio  , parPlaca ,v_tipo, current , parusuario);
    
  let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
  if varcontrol > 0 then
     return 0 ;
  else
     return 1;
  end if;

end if;

if (parOpcion = 2) or (parOpcion = 3)  then
   let v_tipo = 'F';
  select axo , folio , placa 
    into v_axo , v_folio , v_placa
    from ta14_folios_histo where control = parcontrol;
  
  delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
  
  update ta14_folios_histo set placa = parplaca , folio = parfolio , axo = paraxo where control = parcontrol;
  update ta14_fol_banorte  set axo = paraxo , folio = parfolio where rowid = paridbanco ;
  insert into ta14_fol_histo_chgconci(id_cambio , control_chg , old_axo , old_folio , old_placa ,
    new_axo ,  new_folio , new_placa , tipo, fecha_cambio , usuario ) 
    values ( 0, parcontrol ,v_axo , v_folio , v_placa , paraxo ,
                parfolio  , parPlaca ,v_tipo, current , parusuario);
 let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
  if varcontrol > 0 then
     return 0 ;
  else
     return 1;
  end if;
end if;


end procedure
;

CREATE PROCEDURE "informix".admin_adeudos_detalle_16te(parPlaca char(7), parref varchar(20))
				
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_12
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de licencias y anuncios en el sistema ADMIN
#
#  Parametros        p_tipo     = numero de placa
#  de entrada:      
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            13 Septiembre 2013   
#
#  Llamado por:      Procedimiento admin_adeudos_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int         as NoRubro,
int         as NoConcepto, 
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion, 
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
--
  begin
    on exception in (-958)
       delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
      placa  char(7) ,
      axo int,
      folio int, 
      fecha_folio date,
      estado smallint,
      infraccion smallint,
      tarifa  money(12,2), 
      porc_cobro int,
      num_acuerdo int,
      imp_pagar  money(12,2) 
     ) with no log;
  end;

if parref = '' then
   let par_axo = year(today);
   let par_folio = 99999999;
   let var_refer = (par_axo * 100000000 ) + par_folio;
else
   let par_axo = (parref[1,4]) *1;
   let par_folio = (parref[6,13]) *1;
   let var_refer = (par_axo * 100000000 ) + par_folio;
end if;
--

let v_Acumulado = 0;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then

foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca 
and (( a.axo * 100000000 ) +  a.folio) <= var_refer
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 3 asc
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(vfecha) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;

if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
  let vimp_apagar = vporc_cobro / 100 * vtarifa;
  let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;  
  let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra;
  let v_Acumulado = v_Acumulado + vimp_apagar;

  insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
      porc_cobro , num_acuerdo , imp_pagar )
   values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,
    vporc_cobro , vacuerdo , vimp_apagar);
  return 0,0,vctaapl,v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;
   end foreach;
else 
 return 0,0,0,'','',0,0;
end if;
end procedure
;

CREATE PROCEDURE  "informix".admin_datos_varios_23(p_numesta int)
 returning  varchar(150) as sdato_vario;

define v_codigo int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(100);
define  v_calle varchar(100); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define adeudo int;
define  v_movto_cve char(1); 
define v_numext char(6);
define v_zona char(1);
define v_telefono char(15);
define v_bateria decimal(6,2);
define v_cordon decimal(6,2);
define v_categoria char(25);
define v_ubicacion varchar(100);

let v_codigo = -1;
let  v_id  = 0; 
let v_numesta = 0;

let   v_descripcion = '' ;
let v_cupo =0;
let  v_movto_cve =''; 


--select a.* , b.* , c.concepto from ex_contrato a , ex_propietario b where a.ex_propietario_id = b.id;
select nvl(a.id,0) , a.no_exclusivo, a.zona , b.telefono , a.total_bateria , a.total_cordon  
, c.concepto 
into v_id , v_numesta, v_zona , v_telefono  , v_bateria , v_cordon,  v_categoria
 from ex_contrato a , ex_propietario b, ex_clasificacion c
 where a.no_exclusivo = p_numesta and a.ex_propietario_id = b.id and c.id = a.id_clasificacion ;

if v_id > 0 then
 select    first 1   trim(nvl(calle,'.')) || ' Col. ' || trim(nvl(colonia,'.')) 
    into v_ubicacion from ex_ubicacion where ex_contrato_id = v_id and estatus = 'V';
end if;


if v_id > 0 then
return v_zona with resume;   -- ZOna
return v_bateria with resume;  -- bateria
return v_cordon with resume;    -- cordon
return v_telefono with resume;  -- telefono
return v_ubicacion with resume;  -- ubicacion 1
return '' with resume; -- ubicacion 2
return v_categoria with resume;  -- categoria
else
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
end if;

END PROCEDURE;

create procedure "informix".cajero_exc_pago(p_opc int , p_pubid int, p_axof int , p_mesf int, 
 p_fecha_movto date ,p_reca smallint, p_caja char(2) , p_operacion int, p_certificado money(12,2) )
returning  int as id,  varchar(50) as mensaje; 
define r_id int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define v_res2 int ; define v_res3 varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);
define v_porc_recgos int; define x integer ;
define v_descto_recgos money(10,2); define v_placa char(1); define v_baliza char(1);
define v_no_exclusivo int;
define v_fecha_limite date;
--set debug file to 'publico.log';
---trace on;
 select no_exclusivo  into v_no_exclusivo from ex_contrato where id = p_pubid ;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let r_id = -1;

let r_mensaje = 'No proceso nada';
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
        let mesvig = mesvig -1;
   end if;
 
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc < 3 then
let perio = (axovig *100 )+ mesvig;
  FOREACH
  select id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
   
   into v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
   from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio

   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
   select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
    let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_porc_recgos > 0 and v_recargos > 0 then 
    -- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
     end if;
   
  insert into ex_adeudo_histo ( id ,
   fecha_at, ex_adeudo_id,  ex_contrato_id , axo , mes ,tipo, concepto, ade_importe , ade_descto ,
   ade_recgos, ade_recgos_descto, clave, motivo ,fecha_movto, pag_reca, pag_caja , pag_operacion ,
   pag_importe , bco_id,  bco_referencia , bco_importe , id_usuario)
  values  ( 0,today, v_adeudo_id , p_pubid, v_axo , v_mes ,v_tipo, v_concepto1, v_adeudo , v_descto , v_recargos,
 v_descto_recgos,   13 , 'Pago En Reca', 
 p_fecha_movto, p_reca , p_caja, p_operacion, p_certificado, null, null, null, 1);
 let x = dbinfo("sqlca.sqlerrd1");
  if x > 0 then
     delete from ex_adeudo where id = v_adeudo_id ;
  else 
     return 1, 'No correcta' ;
  end if;
   

end foreach;
 let r_id = 0;
 let r_mensaje = 'Pago realizado Correctamente';
end if;
if p_opc = 3 then
  let v_tipo = 20;

-- verificar si tiene forma , balizamiento, placa.

select 'S' into v_placa
 from ex_adeudo_histo where ex_contrato_id = p_pubid 
   and  fecha_movto = p_fecha_movto and pag_reca = p_reca and
   pag_caja = p_caja and  pag_operacion = p_operacion and tipo = 23;
  if v_placa is null then
   let v_placa = 'N';
   end if;
 
select 'S' into v_baliza
 from ex_adeudo_histo where ex_contrato_id = p_pubid 
   and  fecha_movto = p_fecha_movto and pag_reca = p_reca and
   pag_caja = p_caja and  pag_operacion = p_operacion and tipo = 24;
   if v_baliza is null then
   let v_baliza = 'N';
   end if;



  FOREACH
  select id , Axo, mes , tipo
  into v_adeudo_id,  v_axo , v_mes , v_tipo
  from ex_adeudo_histo where ex_contrato_id = p_pubid 
   and  fecha_movto = p_fecha_movto and pag_reca = p_reca and
   pag_caja = p_caja and  pag_operacion = p_operacion 
   order by 1,2
  if v_tipo = 20 then
   execute procedure sp_exc_genadeudo(1 , p_pubid ,v_axo,v_mes,0,0, 1) into v_res , v_res1;
  end if;
  if v_tipo = 21 then
   execute procedure sp_exc_autorizacion( v_no_exclusivo , v_axo , v_mes , v_placa , v_baliza , 'S', 1 ) 
          into v_res2 , v_res3;
  end if;
  if v_tipo = 26 then
    execute procedure sp_exc_refrendo(p_pubid  , v_axo , 1 ) into v_res2 , v_res3;
  end if;
 if v_tipo = 27 then
    execute procedure sp_exc_refrendo(p_pubid  , v_axo , 1 ) into v_res2 , v_res3;
  end if;
   
 update ex_adeudo_histo set clave =11 , motivo = 'RBO/Canc - ' || trim(motivo)  where id = v_adeudo_id ;
  

end foreach;

let r_id = 0;
let r_mensaje = 'Cancelacion realizado Correctamente';
end if;
return r_id, r_mensaje ;
--trace off;
end procedure;

create procedure "informix".cajero_exc_total(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning  
int as cta , char(1) as obligatorio , varchar(30) as concepto,  money(12,2) as importe;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_rectotdesc money(12,2);
define v_descrectot_r money(12,2);
define v_recgos_ref money(12,2);
define v_calrec int;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;

select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
        let mesvig = mesvig -1;
         
   end if;
let per_recgos =  (axovig *100 )+ mesvig;
--let per_recgos = 201312;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;

 FOREACH
  select b.cuentaapl, b.tipo   ,  sum(ade_importe)
   into v_cuentaapl , v_tipochar , v_adeudo
  from ex_adeudo a, pubtipoadeudo b
  where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo in (21,23,24,25,26,27) and a.tipo = b.tipo_id group by 1,2 

 let v_otros = v_otros + v_adeudo;
return v_cuentaapl ,'S', v_tipochar , v_adeudo with resume;

end foreach;
 let v_descrectot_r = 0;
  let v_rectotdesc = 0;
  FOREACH
  select Axo, mes, (axo  * 100 )+ mes ,  ade_importe
   into v_axo , v_mes , perioI , v_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
 and  tipo = 20
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     if v_porcentaje is null then
        let v_porcentaje = 0;
     end if;
    
  select porcentaje into v_porc_recgos from ex_descrec 
  where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes)  between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
  let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
    -- ver si se calculan los recargos o no por se nuevo.
     if v_calrec = 0 then
     let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_porc_recgos > 0 and v_recargos > 0 then 
    -- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
     end if;
   
--  totales
    if v_axo = year(today) then
            let v_cuota = v_cuota + v_adeudo;
           let v_rectot = v_rectot + v_recargos;
           let v_rectotdesc =  v_rectotdesc + v_descto_recgos;
      else
          let v_cuota_r = v_cuota_r + v_adeudo;
         let v_rectot_r = v_rectot_r + v_recargos;
         let v_descrectot_r = v_descrectot_r + v_descto_recgos;
    end if;
end foreach;
-- calcula los recargos de refrendo.
 FOREACH
  select Axo, mes, (axo  * 100 )+ mes ,  ade_importe
   into v_axo , v_mes , perioI , v_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
  and  tipo in (26,27)

   execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
   if v_axo = year(today) then
           let v_rectot = v_rectot + v_recgos_ref;
           --let v_rectotdesc =  v_rectotdesc + v_descto_recgos;
      else
          let v_rectot_r = v_rectot_r + v_recgos_ref;
       --  let v_descrectot_r = v_descrectot_r + v_descto_recgos;
    end if;



   end foreach;
--
if v_cuota > 0 then
return  364100000,'S', 'Cuota:', v_cuota with resume; --42804
end if;
if v_rectot > 0 then
return 390600000 ,'S', 'Recargos:', v_rectot with resume; --46201
end if;
if v_rectotdesc > 0 then
   let v_rectotdesc = v_rectotdesc *-1;
return 390600000 ,'S', 'Descuento Recargos:', v_rectotdesc with resume; --46201
end if;
if v_cuota_r > 0 then
return  364130000,'S', 'Cuota Rezago:', v_cuota_r with resume; --42804
end if;
if v_rectot_r > 0 then
return 390600000 ,'S', 'Recargos Rezago:', v_rectot_r with resume; --46201
end if;
if v_descrectot_r > 0 then
 let v_descrectot_r = v_descrectot_r *-1;
return 390600000 ,'S', 'Descuento Recargos Rezago:', v_descrectot_r with resume; --46201
end if;


let total = v_cuota + v_otros + v_rectot + v_cuota_r + v_rectot_r + v_descrectot_r + v_rectotdesc;
 execute procedure redondeocaja(total) into totals , r_Imp_Rdeo;
if r_Imp_Rdeo <> 0 then
return 550800000 ,'S', 'Ajuste Articulo 14 de la Ley de ingresos', r_Imp_Rdeo with resume; --46902
end if;
end procedure;

create procedure "informix".cajero_pub_pago(p_opc int , p_pubid int, p_axof int , p_mesf int, 
 p_fecha_movto date ,p_reca smallint, p_caja char(2) , p_operacion int, p_certificado money(12,2) )
returning  int as id,  varchar(50) as mensaje; 
define r_id int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);
--set debug file to 'publico.log';
---trace on;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let r_id = -1;

let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc < 3 then
let perio = (axovig *100 )+ mesvig;
  FOREACH
  select id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
   
   into v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio

   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;

  insert into pubadeudo_histo ( id ,
   fecha_at, pubadeudo_id,  pubmain_id , axo , mes ,tipo, concepto, ade_importe , ade_descto ,
   ade_recgos, clave, motivo ,fecha_movto, pag_reca, pag_caja , pag_operacion ,
   pag_importe , bco_id,  bco_referencia , bco_importe , id_usuario)
  values  ( 0,today, v_adeudo_id , p_pubid, v_axo , v_mes ,v_tipo, v_concepto1, v_adeudo , v_descto , v_recargos,   13 , 'Pago En Reca', 
 p_fecha_movto, p_reca , p_caja, p_operacion, p_certificado, null, null, null, 1);
  
delete from pubadeudo where id = v_adeudo_id ;
   

end foreach;
 let r_id = 0;
 let r_mensaje = 'Pago realizado Correctamente';
end if;
if p_opc = 3 then

  FOREACH
  select id , Axo, mes 
  into v_adeudo_id,  v_axo , v_mes 
  from pubadeudo_histo where pubmain_id = p_pubid 
   and  fecha_movto = p_fecha_movto and pag_reca = p_reca and
   pag_caja = p_caja and  pag_operacion = p_operacion 
   order by 1,2
   execute procedure sp_pub_genadeudo(1 , p_pubid ,v_axo,v_mes,0,0, 1) into v_res , v_res1;
   
   update pubadeudo_histo set clave =11 , motivo = 'RBO/Canc - ' || trim(motivo)  where id = v_adeudo_id ;
   

end foreach;
let r_id = 0;
let r_mensaje = 'Cancelacion realizado Correctamente';
end if;
return r_id, r_mensaje ;
--trace off;
end procedure;

create procedure "informix".cajero_pub_total(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning  
int as cta , char(1) as obligatorio , varchar(30) as concepto,  money(12,2) as importe;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
        let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
 FOREACH
  select b.cuentaapl, b.tipo   ,  sum(ade_importe)
   into v_cuentaapl , v_tipochar , v_adeudo
  from pubadeudo a, pubtipoadeudo b
  where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo <> 10 and a.tipo = b.tipo_id group by 1,2 

 let v_otros = v_otros + v_adeudo;
return v_cuentaapl ,'S', v_tipochar , v_adeudo with resume;

end foreach;

  FOREACH
  select Axo, mes, (axo  * 100 )+ mes ,  ade_importe
   into v_axo , v_mes , perioI , v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
 and  tipo = 10
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     if v_porcentaje is null then
        let v_porcentaje = 0;
     end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;

   
--  totales
    if v_axo = year(today) then
    begin
    let v_cuota = v_cuota + v_adeudo;
    let v_rectot = v_rectot + v_recargos;
     end
    else
     begin
    let v_cuota_r = v_cuota_r + v_adeudo;
    let v_rectot_r = v_rectot_r + v_recargos;
     end
   end if;
end foreach;
if v_cuota > 0 then
return  370100000,'S', 'Cuota:', v_cuota with resume; --42804
end if;
if v_rectot > 0 then
return 390600000 ,'S', 'Recargos:', v_rectot with resume; --46201
end if;
if v_cuota_r > 0 then
return  370130000,'S', 'Cuota Rezago:', v_cuota_r with resume; --42804
end if;
if v_rectot_r > 0 then
return 390600000 ,'S', 'Recargos Rezago:', v_rectot_r with resume; --46201
end if;
let total = v_cuota + v_otros + v_rectot + v_cuota_r + v_rectot_r ;
 execute procedure redondeocaja(total) into totals , r_Imp_Rdeo;
if r_Imp_Rdeo <> 0 then
return 550800000 ,'S', 'Ajuste Articulo 14 de la Ley de ingresos', r_Imp_Rdeo with resume; --46902
end if;
end procedure;

CREATE PROCEDURE "informix".spd_remesa (p_Opc Int, p_Axo Int, p_Fec_Ini Date, p_Fec_Fin Date, p_NumRem Int, p_Remesa Char(20))
  returning int as status , varchar(200) as obs; 
DEFINE v_tipo                                                                 Char(1);
DEFINE v_A, v_PN, v_C, v_PR,v_TC                       Integer;    
DEFINE obs                                                       VarChar(200);
DEFINE v_folio1                                              Char(12);
DEFINE v_mpio                                               Integer;
DEFINE v_tipoact                                            Char(2);
DEFINE v_placa                                               Char(9);
DEFINE v_fechapago, v_fechaalta          Date;
DEFINE v_folioecmpio                  Char(50);


LET obs = '';

-- ALTAS DEL PERIODO DESEADO
IF p_Opc = 0  THEN                                                                                                                       
     INSERT INTO ta14_datos_mpio                                                          -- Altas por periodo  
     SELECT 113 Municipio, 'A' ,(trunc((a.axo* 10000000) + a.folio)) || '' Folio, '' fechagenreq, a.placa, '' folionot, '' fechanot, '' fechapago, '' fechacancelado, 
                   b.tarifa tarifa, a.infraccion claveinf, a.fecha_folio  fechaalta , (a.fecha_folio + 90) fechavenci , '' folioec, '' folioecmpio , '' gastos, p_Remesa, (today ) fecharem
     FROM ta14_folios_adeudo a , ta14_tarifas b
     WHERE a.infraccion < 10 AND a.axo = p_Axo AND a.fecha_folio  BETWEEN p_Fec_Ini AND p_Fec_Fin 
           AND a.fecha_folio BETWEEN b.fecha_inicial AND b.fecha_fin AND a.infraccion = b.num_clave 
           AND a.placa NOT IN  ('','JBB3299', 'JHV3208', 'JDR8217', 'JHB4551', 'JHF5454', 'JFT1095', 'JCM9663', 'JHY3399','JHU9170');

      LET v_tipo = 'B';
END IF;

-- GENERACION DEL ARCHIVO DIARIO
IF p_Opc = 1 THEN                                                                                                                        
     INSERT INTO ta14_datos_mpio                                                          -- Pagos normales por periodo
     SELECT 113 Municipio, 'PN', (a.folio || '') folio, '' fechagenreq, a.placa, '' folionot, '' fechanot, b.fecha_recibo fechapago, '' fechacancelado, '' tarifa, '' claveinf, 
                   a.fecha_folio fechaalta, '' fechavenci, '' folioec, ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion )  folioecmpio , '' gastos, p_Remesa,   (today ) fecharem
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.infraccion < 10 AND a.fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin AND a.codigo_movto  IN (3,4, 13) 
           AND a.fecha_folio < '31/05/2005' AND a.num_acuerdo IS NULL AND a.control = b.control;
                               ---------------------------------------
     INSERT INTO ta14_datos_mpio 
     SELECT 113 Municipio, 'PN',  (trunc((a.axo* 10000000) + a.folio)) || '' Folio, '' fechagenreq, a.placa, '' folionot, '' fechanot,  b.fecha_recibo fechapago, '' fechacancelado, 
                   '' tarifa, '' claveinf, a.fecha_folio fechaalta, '' fechavenci, '' folioec, ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion )  folioecmpio, '' gastos, p_Remesa, (today ) fecharem
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.infraccion < 10 AND fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin AND codigo_movto  IN (3,4,13) 
           AND fecha_folio BETWEEN '31/05/2005' AND '31/01/2009' AND a.num_acuerdo IS NULL AND a.control = b.control;

     INSERT INTO ta14_datos_mpio                                                          -- Cancelaciones por periodo
     SELECT 113 Municipio, 'C', a.folio || '' folio, '' fechagenreq, a.placa, '' folionot, '' fechanot, '' fechapago, fecha_movto fechacancelado, '' tarifa , 
                    '' claveinf, a.fecha_folio fechaalta, '' fechavenci, '' folioec, '' folioecmpio, '' gastos, p_Remesa, today fecharem
     FROM ta14_folios_histo a  
     WHERE a.infraccion < 10 AND a.fecha_movto BETWEEN p_Fec_Ini and  p_Fec_Fin AND a.codigo_movto  in (2,5,15,16) AND a.fecha_folio < '31/05/2005' ;

     INSERT INTO ta14_datos_mpio 
     SELECT 113 Municipio, 'C' ,  (trunc((a.axo* 10000000) + a.folio)  ) || '' Folio ,  '' fechagenreq, a.placa , '' folionot , '' fechanot,  '' fechapago, 
                   fecha_movto fechacancelado, '' tarifa , '' claveinf, a.fecha_folio fechaalta   , '' fechavenci, '' folioec, ''  folioecmpio , '' gastos, p_Remesa, (today ) fecharem
      FROM ta14_folios_histo a 
      WHERE a.infraccion < 10 AND fecha_movto BETWEEN p_Fec_Ini and  p_Fec_Fin AND codigo_movto  in (1,2,5,15,16) 
            AND fecha_folio BETWEEN '31/05/2005' and '31/01/2009' ;

       INSERT INTO ta14_datos_mpio                                                        -- Pagos con requerimiento por periodo
       SELECT 113 Municipio, 'PR', (a.folio || '') folio, '' fechagenreq, a.placa, '' folionot, '' fechanot, b.fecha_recibo fechapago, '' fechacancelado, '' tarifa, '' claveinf, 
                     a.fecha_folio   fechaalta   , '' fechavenci, '' folioec, ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion )  folioecmpio , 49 gastos, p_Remesa, (today ) fecharem
       FROM ta14_folios_histo a  , ta14_refrecibo b
       WHERE a.infraccion < 10 AND a.fecha_movto BETWEEN p_Fec_Ini and  p_Fec_Fin AND a.codigo_movto  IN (3,4, 13) 
             AND a.fecha_folio < '30/08/2005' AND a.num_acuerdo IS NOT NULL AND a.control = b.control;

       INSERT INTO ta14_datos_mpio 
       SELECT 113 Municipio, 'PR' ,  (trunc((a.axo* 10000000) + a.folio)) || '' Folio ,  '' fechagenreq, a.placa , '' folionot , '' fechanot,  b.fecha_recibo  fechapago, 
                     '' fechacancelado, '' tarifa , '' claveinf, a.fecha_folio fechaalta   , '' fechavenci, '' folioec, ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion )  folioecmpio, 
                    49 gastos, p_Remesa, (today ) fecharem 
        FROM ta14_folios_histo a  , ta14_refrecibo b
        WHERE a.infraccion < 10 AND fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin AND codigo_movto  IN (3,4,13) 
              AND fecha_folio BETWEEN '30/08/2005' AND '31/01/2009' AND a.num_acuerdo IS NOT NULL AND a.control = b.control;

      LET v_tipo = 'C';
END IF;
-- GENERACION DEL ARCHIVO DE PAGADOS EN BANORTE
IF p_Opc = 2 THEN                                       
  FOREACH                                                                                 
      SELECT 113 Municipio, "PN" TipoAct, (trunc((a.axo* 10000000) + a.folio)) || "" Folio1, a.Placa, (b.fec_pago) Fechapago,
      (a.Fecha_folio) Fechaalta, "Pago en Banorte " || a.Fecha_movto Folioecmpio
          INTO v_mpio, v_tipoact, v_folio1, v_placa, v_fechapago, 
                    v_fechaalta, v_folioecmpio
      FROM ta14_folios_histo a, ta14_fol_banorte b
      WHERE a.codigo_movto = 10 AND a.fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin
      AND b.axo = a.axo AND b.folio = a.folio

                        IF EXISTS(SELECT folio FROM ta14_datos_mpio
                           WHERE folio = v_folio1
                                 AND TipoAct = 'A') then
                                               IF NOT EXISTS(SELECT folio FROM ta14_datos_mpio
                                                   WHERE folio = v_folio1
                                                         AND TipoAct <> 'A') then
                                                                insert into ta14_datos_mpio values(v_mpio, v_tipoact, v_folio1, Null, v_placa, Null, Null, v_fechapago, 
                                                                                                                       Null, Null, Null, v_fechaalta, Null, Null, v_folioecmpio, Null, p_Remesa, today);
                                               END IF;
                        END IF;
  END FOREACH;
END IF;


IF p_Opc = 0  THEN
       SELECT count(*) cuantos INTO v_A FROM ta14_datos_mpio WHERE remesa = p_Remesa;
       INSERT INTO ta14_Bitacora values (0, 'B', p_Fec_Ini, p_Fec_Fin, today, p_NumRem, v_A);
       if v_a is null then
          return -1 , 'No genero registro para enviar al SECFIN';
       else
       let obs = v_a || '  Registros de altas para enviar al SECFIN';
        return 0, obs;
        end if; 
       
END IF;
IF p_Opc = 1 THEN
       SELECT count(*) cuantos INTO v_PN FROM ta14_datos_mpio WHERE remesa = p_Remesa and tipoact = 'PN';
       SELECT count(*) cuantos INTO v_C FROM ta14_datos_mpio WHERE remesa = p_Remesa and tipoact = 'C';
       SELECT count(*) cuantos INTO v_PR FROM ta14_datos_mpio WHERE remesa = p_Remesa and tipoact = 'PR';
       LET v_TC = v_PN+v_C+v_PR;
       INSERT INTO ta14_Bitacora values (0, 'C', p_Fec_Ini, p_Fec_Fin, today, p_NumRem, v_TC);
              if v_tc is null then
          return -1 , 'No genero registro para enviar al SECFIN';
       else
       let obs = v_PN || '  Pagos Normales  ' || v_c || '  Cancelados  ' || v_pr || '  Pagos con Req.';
        return 0, obs;
        end if; 
END IF;
 IF p_Opc = 2  THEN
       SELECT count(*) cuantos INTO v_A FROM ta14_datos_mpio WHERE remesa = p_Remesa;
       INSERT INTO ta14_Bitacora values (0, 'D', p_Fec_Ini, p_Fec_Fin, today, p_NumRem, v_A);
       if v_a is null then
          return -1 , 'No genero registro para enviar al SECFIN';
       else
       let obs = v_a || '  Registros pagados en Banorte para enviar al SECFIN';
        return 0, obs;
        end if; 
END IF;

END PROCEDURE
;

create procedure "informix".sp_exc_modcontrato_tx(  p_noexclusivo int, p_zona char(1), 
p_solicitud int, p_control int , p_vialidad char(20), p_idclasif int , p_usuario int,
 P_noficio int , p_fecOficio date , p_descOfic varchar(255)  , P_opc char(1) ) 

returning
int as id,
char(100) as mensaje;
define v_opc int ;
define v_idexclusiv int;
define v_descrip char(50);
define vgencode int;
define vgendesc char(50);
define v_periodo int;
define act_id int;
define act_zona char(1) ;
define act_idclasif int;
define     v_factor DECIMAL(6,2);
define v_axo int;
define v_mes int;
define v_chg_aduedos int;
define v_descrip_cambio varchar(200);
let v_chg_aduedos = 0;
select factor  into v_factor from ex_clasificacion where id = p_idclasif;
select id, zona , id_clasificacion 
 into  act_id ,act_zona , act_idclasif from ex_contrato where no_exclusivo = p_noexclusivo ;
-- seleccionar el periodo minimo.
select min((axo*100) + mes) into v_periodo  from ex_adeudo where ex_contrato_id = act_id; 
  if v_periodo is null then
    let v_axo = 0; let v_mes = 0;
  else
     let v_axo = trunc(v_periodo/100);
     let v_mes = v_periodo - ( v_axo * 100);
  end if;
-- verificar si tiene cambio de adeudos.
if p_opc ='M' then
   if p_idclasif <> act_idclasif then
    let v_chg_aduedos = 1;
   end if;
  if p_zona <> act_zona then
    let v_chg_aduedos = 1;
  end if;
  if v_chg_aduedos = 1 then
      if v_axo = 0 then
         let v_chg_aduedos = 0;
      end if;
      if v_axo < year(today) then
      return -1 , 'No Puede realizar los cambios tiene adeudos anteriores';
      end if;
    if v_axo = year(today)  then
        if v_mes < month(today) then
           return -1 , 'No Puede realizar los cambios tiene adeudos anteriores';
        end if;
        if v_mes > month(today) then
           let v_chg_aduedos = 1;
        end if;
        if v_mes = month(today) and day(today) <= 6 then
             let v_chg_aduedos = 1;
        else
           return -1 , 'Este mes ya lo tiene que pagar, antes de realizar los cambios...';
        end if;
      end if;
end if;

-- registro de bitacora.
 if v_chg_aduedos = 0 then
    let  v_descrip_cambio = 'CAMBIO DE DATOS DEL CONTRATO SIN MODIFICACION DE ADEUDOS';
  else
 let  v_descrip_cambio = 'CAMBIO DE DATOS DEL CONTRATO CON MODIFICACION DE ADEUDOS';
  end if;
  insert into ex_bitacora_mov(id ,usuario_id ,ex_contrato_id  ,
  opcion_actualiza, numero_oficio , fecha_Oficio , Descripcion_oficio,pc)
  values (0, p_usuario, act_id , v_descrip_cambio , P_noficio , p_fecOficio , p_descOfic,getcomputer());


--se Modifica el contrato.
update ex_contrato   set
    zona = p_zona,
    solicitud = p_solicitud,
    control = p_control,
    factor = v_factor,
    id_clasificacion = p_idclasif,
    vialidad  = p_vialidad,
    usuario = p_usuario,  
    pc = getcomputer(), 
    fecha_in =  current
    where no_exclusivo = p_noexclusivo;
    let vgencode = 0;
    let vgendesc = 'Modificacion realizada';
-- se genera adeudo
   if v_chg_aduedos = 1 then
     if v_axo > 2004 then
      if (act_zona <> p_zona) or (p_idclasif <> act_idclasif)  then
--select * from ex_adeudo_histo    
 insert into ex_adeudo_histo (id , fecha_at , ex_adeudo_id , ex_contrato_id , axo, mes , tipo , concepto ,
    ade_importe , ade_descto ,  ade_recgos , ade_recgos_descto ,
    clave, motivo , fecha_movto, id_usuario)
    select 0 ,today , id , ex_contrato_id , axo, mes , tipo , concepto ,
    ade_importe , ade_descto ,  0 , 0 , 2 ,'CANC. POR CAMBIO DE VALORES', today, p_usuario
    from ex_adeudo where ex_contrato_id = act_id;

    delete ex_adeudo where ex_contrato_id = act_id;
         execute procedure sp_exc_genadeudo(2 , act_id , v_axo , v_mes , year(today) , 12 , p_usuario )
         into vgencode , vgendesc;
       let vgencode = 0;
       let vgendesc = 'Modificacion realizada con cambio de adeudos';
      end if;
      end if;
   end if;
 

return vgencode , vgendesc ;
end if;

if p_opc ='B' then
   if v_axo = 0 then
         let v_chg_aduedos = 0;
   end if;
   if v_axo < year(today) then
      return -1 , 'No Puede realizar la Baja, tiene adeudos anteriores';
   end if;
   if v_axo = year(today)  then
          if v_mes = month(today) then 
              if  day(today) <= 6 then
                  let v_chg_aduedos = 1;
              else
                  return -1 , 'Este mes ya lo tiene que pagar, antes de realizar la baja...';
              end if;
          end if;
         if v_mes < month(today) then
               return -1 , 'No Puede realizar la Baja, tiene adeudos anteriores';
           end if;
        if v_mes > month(today) then
             let v_chg_aduedos = 0;
        end if;
     
   end if;


-- registro de bitacora.

 let  v_descrip_cambio = 'BAJA DEL CONTRATO';

  insert into ex_bitacora_mov(id ,usuario_id ,ex_contrato_id  ,
  opcion_actualiza, numero_oficio , fecha_Oficio , Descripcion_oficio,pc)
  values (0, p_usuario, act_id , v_descrip_cambio , P_noficio , p_fecOficio , p_descOfic,getcomputer());


--se Modifica el contrato.
update ex_contrato   set
    usuario = p_usuario,  
    pc = getcomputer(), 
    estatus = 'C',
    fecha_at = current,
    folio_cancelacion = P_noficio
    where no_exclusivo = p_noexclusivo;
  -- se dan de baja los adeudos por cancelacion de contrato.    
 insert into ex_adeudo_histo (id , fecha_at , ex_adeudo_id , ex_contrato_id , axo, mes , tipo , concepto ,
    ade_importe , ade_descto ,  ade_recgos , ade_recgos_descto ,
    clave, motivo , fecha_movto, id_usuario)
    select 0 ,today , id , ex_contrato_id , axo, mes , tipo , concepto ,
    ade_importe , ade_descto ,  0 , 0 , 4 ,'CANCELACION DE CONTRATO', today, p_usuario
    from ex_adeudo where ex_contrato_id = act_id;

    delete ex_adeudo where ex_contrato_id = act_id;
       
       let vgencode = 0;
       let vgendesc = 'Baja realizada con cambio de adeudos';
  
return vgencode , vgendesc ;
end if;

if p_opc ='V' then
  
-- registro de bitacora.

 let  v_descrip_cambio = 'BAJA DEL CONTRATO CON ADEUDOS ANTERIORES';

  insert into ex_bitacora_mov(id ,usuario_id ,ex_contrato_id  ,
  opcion_actualiza, numero_oficio , fecha_Oficio , Descripcion_oficio,pc)
  values (0, p_usuario, act_id , v_descrip_cambio , P_noficio , p_fecOficio , p_descOfic,getcomputer());


--se Modifica el contrato.
update ex_contrato   set
    usuario = p_usuario,  
    pc = getcomputer(), 
    estatus = 'C',
    fecha_at = current,
    folio_cancelacion = P_noficio
    where no_exclusivo = p_noexclusivo;
  -- se dan de baja los adeudos por cancelacion de contrato.    
 insert into ex_adeudo_histo (id , fecha_at , ex_adeudo_id , ex_contrato_id , axo, mes , tipo , concepto ,
    ade_importe , ade_descto ,  ade_recgos , ade_recgos_descto ,
    clave, motivo , fecha_movto, id_usuario)
    select 0 ,today , id , ex_contrato_id , axo, mes , tipo , concepto ,
    ade_importe , ade_descto ,  0 , 0 , 4 ,'CANCELACION DE CONTRATO CON ADEUDOS', today, p_usuario
    from ex_adeudo where ex_contrato_id = act_id;

    delete ex_adeudo where ex_contrato_id = act_id;
       
       let vgencode = 0;
       let vgendesc = 'Baja realizada con cambio de adeudos';
  
return vgencode , vgendesc ;
end if;

END PROCEDURE;

create procedure "informix".sp_exc_verifica_adeudo(  p_noexclusivo int ) 
returning
int as id,
char(100) as mensaje;
define v_opc int ;
define v_idexclusiv int;
define v_descrip char(50);
define vgencode int;
define vgendesc char(50);
define v_periodo int;
define act_id int;
define act_zona char(1) ;
define act_idclasif int;
define     v_factor DECIMAL(6,2);
define v_axo int;
define v_mes int;
define v_chg_aduedos int;
define v_descrip_cambio varchar(200);
let v_chg_aduedos = 0;
select id, zona , id_clasificacion 
 into  act_id ,act_zona , act_idclasif from ex_contrato where no_exclusivo = p_noexclusivo ;
-- seleccionar el periodo minimo.
select min((axo*100) + mes) into v_periodo  from ex_adeudo where ex_contrato_id = act_id; 

       let vgencode = 0;
       let vgendesc = 'No tiene adeudos anteriores';
  if v_periodo is null then
    let v_axo = 0; let v_mes = 0;
  else
     let v_axo = trunc(v_periodo/100);
     let v_mes = v_periodo - ( v_axo * 100);
  end if;

   if v_axo = 0 then
         let v_chg_aduedos = 0; 
         return vgencode , vgendesc ;
   end if;
   if v_axo < year(today) then
      return -1 , 'No Puede realizar la Baja, tiene adeudos anteriores';
   end if;
   if v_axo = year(today)  then
          if v_mes = month(today) then 
              if  day(today) <= 6 then
                  let v_chg_aduedos = 1; 
                  return vgencode , vgendesc ;
              else
                  return -1 , 'Este mes ya lo tiene que pagar, antes de realizar la baja...';
              end if;
          end if;
         if v_mes < month(today) then
               return -1 , 'No Puede realizar la Baja, tiene adeudos anteriores';
           end if;
        if v_mes > month(today) then
             let v_chg_aduedos = 0;
             return vgencode , vgendesc ;
        end if;
     
  end if; 



END PROCEDURE;

create procedure "informix".sp_pub_consulta(p_opc int ,p_numesta int, p_desc varchar(20)  )
returning
int as id , int as numesta, varchar(100) as nombre,
varchar(100) as domicilio, int as pubcategoria_id, char(1) as tipo , char(2) as categoria,
varchar(20) as catdescrip, char(1) as sector , int as zona , int as subzona,
int as numlicencia, int as axolicencias, int as cupo , date as fecha_alta ,
date as fecha_inicial, date as fecha_vencimiento, int as axo_pago , int as mes_pago,
 int as idmsg , varchar(200) as msg , varchar(13) as rfc;

define v_idmain int ; define v_numesta int; define v_nombre varchar(100) ;
define v_domicilio varchar(100) ; define v_pubcategoria_id int; define v_tipo char(1);
define v_categoria char(2) ; define v_cat_descrip varchar(20);
define v_sector char(1); define v_rfc varchar(13);
define v_zona int ; define subzona int; define v_numlicencia int;
define v_axolicencias int; define v_cupo int;  define v_fecha_alta  date;
define v_fecha_inicial  date; define fecha_vencimiento date;
define v_axopag int; define v_mespag int; define v_adeudoC int;
define v_idmsg int; define v_msg varchar(200);       define v_peri int;


   let v_idmsg = 0;
   let v_msg = 'No proceso nada';
-- por numero de estacionamiento individual
if p_opc = 1 then 
 

select a.id ,a.numesta,trim(a.nombre), trim(a.calle) || ' # ' || trim(a.numext) ,  a.pubcategoria_id, b.tipo , b.categoria, trim(b.descripcion),
a.sector , a.zona , a.subzona, a.numlicencia, a.axolicencias,a.cupo , a.fecha_at , 
a.fecha_inicial, a.fecha_vencimiento , nvl(a.rfc,'.')
into  v_idmain  ,v_numesta , v_nombre  ,v_domicilio,  v_pubcategoria_id , v_tipo,
 v_categoria , v_cat_descrip ,v_sector , v_zona,  subzona , v_numlicencia ,
 v_axolicencias , v_cupo , v_fecha_alta  , v_fecha_inicial , fecha_vencimiento , v_rfc

 from pubmain a, pubcategoria b
 where a.pubcategoria_id = b.id and a.numesta = p_numesta     ;

if v_idmain is null then
 let v_idmain =  0;  let v_numesta = 0; let v_nombre = ''; let  v_domicilio = '';
 let v_pubcategoria_id = 0; let  v_tipo = 0;
 let v_categoria = 0; let v_cat_descrip=''; let v_sector =''; let v_zona =0;
 let subzona = 0; let v_numlicencia = 0;let v_axolicencias = 0;
let v_cupo = 0; let v_fecha_alta = null; let v_fecha_inicial = null; 
 let fecha_vencimiento = null ; let v_axopag = 0 ; let v_mespag = 0;
  let v_idmsg = -1 ; let v_msg = 'No existe registro de este estacionamiento';
end if;

if v_idmsg = 0 then
  -- verificar mes ultimo de pago.
   select max((axo * 100)+ mes) 
   into v_peri 
   from pubadeudo_histo  
   where pubmain_id = v_idmain and clave = 13; 
   
   if v_peri is null then
        let v_idmsg = 1 ; let v_msg = 'No hay pagos';
        let v_axopag = 0; let v_mespag =0;
   else
       let v_axopag = trunc(v_peri / 100) ; let v_mespag = v_peri - (v_axopag *100) ;
       let v_idmsg = 2 ; let v_msg = 'Ultimo pago';
   end if;
   select count(axo) into v_adeudoC from pubadeudo where pubmain_id = v_idmain ;
   if ((v_adeudoc is null) or (v_adeudoc = 0   ))   then
      let v_idmsg = 3 ; let v_msg = 'No hay Adeudos vigentes'; 
   else 
       let v_idmsg = 0 ; let v_msg = 'Tiene Adeudos a cobrar'; 
  end if;
 end if;
--
 return  
 v_idmain  ,v_numesta , v_nombre,  v_domicilio,  v_pubcategoria_id , v_tipo,
 v_categoria , v_cat_descrip ,v_sector , v_zona,  subzona , v_numlicencia ,
 v_axolicencias , v_cupo , v_fecha_alta  , v_fecha_inicial , fecha_vencimiento,
 v_axopag , v_mespag , v_idmsg , v_msg  ,v_rfc  ;



end if;


END PROCEDURE;

create procedure "informix".fn_exc_ade_act1( p_contrato_id int ) 
returning  money(12,2) as adeudo_act ;
 define v_adeudo money(12,2)     ;
 select sum(ade_importe) into v_adeudo from ex_adeudo 
  where ex_contrato_id = p_contrato_id and axo = year(today) 
 and (axo * 100) + mes <= (year(today) * 100) + (month(today)-1) ;
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_exc_recargos(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning    money(10,2) as recargos;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);
define v_totrecgos money(10,2);
define v_id_adeudo int;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

let v_totrecgos = 0;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
  
  FOREACH
  select case when tipo <> 20 then axo || '00' else axo || lpad(mes,2,'0') end ,tipo , Axo, mes, (axo  * 100 )+ mes , 
    concepto, ade_importe , id 
   into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo , v_id_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,3,4
   select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
  
 if v_tipo = 20 then
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
          
      if v_calrec = 0 then
     let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
   if (v_tipo = 26) or (v_tipo = 27) then
     execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
     let v_recargos =   v_recargos + v_recgos_ref;
   end if;

 let v_totrecgos =  v_totrecgos + v_recargos ;
end foreach;

return  v_totrecgos ;
end procedure;

CREATE PROCEDURE "informix".cons_predio( p_opc int,  p_dato char(11))
---	cvecuenta, recaud,tipo,cuenta,cvecatastral,subpredio,nombre,calle,numetoext,numeroint
returning int as cvecuenta ,int as recaud ,char(1) as tipo , int  as cuenta ,CHAR(11) as  cvecatastral ,
          int as subpredio ,  char(100) as  contribuyente ,char(100) as calle ,char(15) as numext,char(15) as numint,
          int  as zona, int as subzona , int as status, varchar(100) as mensaje;
   define  p_recaud int;
   define p_tipo char(1);
   define p_cuenta int;
   define p_cvecatnva char(11);
   define v_recaud int;
   define v_tipo char(1);
   define v_cuenta int;
   define v_cvecuenta int;
   define v_cvecatnva CHAR(11);
   define v_nombre char(100);
   define v_calle char(100);
   define v_exterior char(15);
   define v_interior char(15);
   define v_subpredio int;
   define v_zona    int;
   define v_subzona int;
   define v_status  int;
   define v_mensaje varchar(100);
--set debug file to "datos_cons.log";
--trace on;
 if p_opc = 1 then
   let p_recaud =  substr(p_dato,1,1);
   let p_tipo = substr(p_dato,2,1);
   let p_cuenta = substr(p_dato,3,6);
   let p_cvecatnva = '';
 end if;
 if p_opc = 2 then
   let p_recaud = 0;
   let p_tipo = '';
   let p_cuenta  = substr(p_dato,1,6);
   let p_cvecatnva = '';
 end if;
 if p_opc = 3 then
   let p_recaud = 0;
   let p_tipo = '';
   let p_cuenta = 0;
   let p_cvecatnva = p_dato;
 end if;


if (p_cuenta <> 0) then
   if (p_recaud <> 0 and p_tipo <> '' ) then
        if exists(select * from catastro_gdl:convcta where vigente = 'V' and
           recaud = p_recaud and urbrus=p_tipo and cuenta=p_cuenta ) then

    foreach
         select a.calle , a.noexterior , a.interior , b.recaud, b.urbrus, b.cuenta
           , b.cvecatnva, b.subpredio, d.nombre_completo,b.cvecuenta ,
            nvl(substr(v.cve_nva,2,1)   , 99)  , nvl(substr(v.cve_nva,2,3) ,99)
           into v_calle,v_exterior,v_interior,v_recaud,v_tipo,v_cuenta,v_cvecatnva,
               v_subpredio, v_nombre,v_cvecuenta , v_zona , v_subzona
           from catastro_gdl:ubicacion a , catastro_gdl:convcta b , catastro_gdl:regprop c , 
             catastro_gdl:contrib d , outer catastro_gdl:claves v
             where a.vigencia = 'V' and a.cvecuenta = b.cvecuenta and b.vigente = 'V' and
              c.cvecuenta = a.cvecuenta and c.vigencia = 'V'  and c.encabeza = 'S' and c.cvecont = d.cvecont
           and  b.recaud = p_recaud and b.urbrus=p_tipo and b.cuenta=p_cuenta and substr(b.cvecatnva,1,8)= v.cve_act
     return  v_cvecuenta  ,v_recaud,v_tipo,v_cuenta, v_cvecatnva,v_subpredio ,v_nombre,v_calle,v_exterior,v_interior , v_zona , v_subzona , 0, 'OK' with resume;
       end foreach;
     else
        return  0,p_recaud,v_tipo,v_cuenta,'',0,'','','','' , 0,0,9,'CUENTA INCORRECTA O CANCELADA' ;
     end if;


   else  ---recaud-tipo

        if exists(select * from catastro_gdl:convcta where vigente = 'V' and
          cvecuenta =p_cuenta ) then
        foreach
           select a.calle , a.noexterior , a.interior , b.recaud, b.urbrus, b.cuenta
	            , b.cvecatnva,b.subpredio, d.nombre_completo,b.cvecuenta,
            nvl(substr(v.cve_nva,2,1)   , 99)  , nvl(substr(v.cve_nva,2,3) ,99)
            into v_calle,v_exterior,v_interior,v_recaud,v_tipo,v_cuenta,v_cvecatnva,
              v_subpredio, v_nombre,v_cvecuenta , v_zona , v_subzona
              from  catastro_gdl:ubicacion a , catastro_gdl:convcta b , catastro_gdl:regprop c , catastro_gdl:contrib d  , 
              outer catastro_gdl:claves v
                where b.cvecuenta=p_cuenta and  a.vigencia = 'V' and a.cvecuenta = b.cvecuenta and b.vigente = 'V' and
                    c.cvecuenta = a.cvecuenta and c.vigencia = 'V' and c.encabeza = 'S' and c.cvecont = d.cvecont and substr(b.cvecatnva,1,8)= v.cve_act

         return  v_cvecuenta  ,v_recaud,v_tipo,v_cuenta, v_cvecatnva,v_subpredio ,v_nombre,v_calle,v_exterior,v_interior , v_zona , v_subzona , 0, 'OK' with resume;
        end foreach;
       else
        return  p_cuenta,0,'',0,'',0,'','','','' , 0,0,9,'CUENTA INCORRECTA O CANCELADA' ;
       end if;

   end if; --recaud-tipo
   return;
end if; --cuenta

--else --cuenta

if p_cvecatnva <> "" then
           --consulta por clave cat nva
        foreach
           select a.calle , a.noexterior , a.interior , b.recaud, b.urbrus, b.cuenta
	            , b.cvecatnva,b.subpredio, d.nombre_completo,b.cvecuenta ,
            nvl(substr(v.cve_nva,2,1)   , 99)  , nvl(substr(v.cve_nva,2,3) ,99)
            into v_calle,v_exterior,v_interior,v_recaud,v_tipo,v_cuenta,v_cvecatnva,
           v_subpredio, v_nombre,v_cvecuenta  , v_zona , v_subzona
             from catastro_gdl:ubicacion a , catastro_gdl:convcta b , catastro_gdl:regprop c , 
            catastro_gdl:contrib d  , outer catastro_gdl:claves v
                where a.vigencia = 'V' and a.cvecuenta = b.cvecuenta and b.vigente = 'V' and
                    c.cvecuenta = a.cvecuenta
                    and c.vigencia = 'V' and c.encabeza = 'S'
                    and c.cvecont = d.cvecont
                    and  b.cvecatnva = p_cvecatnva
                    and  substr(b.cvecatnva,1,8)= v.cve_act
          if v_calle is null then
        return  0,0,'',0,p_cvecatnva,0,'','','','' , 0,0,9,'CUENTA INCORRECTA O CANCELADA' ;
        else
         return  v_cvecuenta  ,v_recaud,v_tipo,v_cuenta, v_cvecatnva,v_subpredio ,v_nombre,v_calle,v_exterior,v_interior , v_zona , v_subzona , 0, 'OK' with resume;
        end if;
    end foreach;
    RETURN;
END IF; --CVECAT



--trace off;
end procedure
;

CREATE PROCEDURE "informix".admin_pago_16a(parPlaca char(7), parref varchar(20),
                parImpCertificado money(15,2),
                parimpredondeo   money(3,2),
                parimpcredito   money(15,2),
    		parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
	        ParFolioRecibo  char(10), --Folio del Recibo (ADMIN)
	        ParFechaRecibo  date ,   --Fecha del Recibo
	        ParReca         int, --No. de Recaudadora
	        ParCaja  char(2) ,--No. de Caja
	        ParCajero  char(10),	 --Clave usuario
                parCentro  integer)
				
{######################################################################
#  Procedimiento:    admin_pago_16
#  Descripcion:      Interfaz de pago de adeudo para el cobro de Folios de estacionamiento en el sistema ADMIN
#
#  Parametros        parPlaca     = numero de placa
#  de entrada:       Parref       = Referencia maxima a cobrar
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            24 Octubre 2013   
#
#  Llamado por:      Procedimiento sp_pago en dbingresosw
#  Llama a:          
#  
######################################################################}

returning smallint , varchar(50);
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define x_placa  char(7) ;
define x_axo int;
define x_folio int; 
define x_fecha_folio date;
define x_estado smallint;
define x_infraccion smallint;
define x_tarifa  money(12,2); 
define x_porc_cobro int;
define x_num_acuerdo int;
define x_imp_pagar  money(12,2);
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define daxo int;
define dfolio int;
define dplaca char(7);
define dacuerdo  int;
define v_id_usuario int;
define v_cta int;
define linea int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define v_r char(1);
define v_ca int;

   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -11, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE ESTACIONOMETROS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
  let v_r = 'N';
set debug file to "pagos16";
trace on;
select count(*) into v_ca from tmp_folios ;
 if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;

--OBTENER EL ID USUARIO CAJERO;
select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = ParCajero;

if  v_id_usuario    is null then
 let v_id_usuario   = 335;  -- usuario ADMIN
end if;


    BEGIN WORK;
   let v_r = 'S';
 -- select * from db_ingresos:ta_12_recibos where id_modulo = 14 and fecha > '1/1/2013'
   insert into db_ingresos:ta_12_recibos(fecha , id_rec , caja , operacion ,  importe , cvepago ,
    id_modulo ,  id_regmodulo,  id_rec_cta , regmunur ,
    mesdesde , axodesde, meshasta, axohasta ,
    nombre ,  domicilio , concepto , rfcini , rfcnumero ,
    rfccolonia,  obra ,  axofolio , id_usuario , fecha_act , descripcion ,
    lugar_pago , id_centro ,  foliorecibo) 
   values (ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN     , parImpCertificado, 'P' ,
    14, 0, 0, 'F' ,
    0, 0, 0, 0, 'Pago de multas de estacionometros de la placa: ' || parPlaca, '','Pago de multas de estacionometros de la placa: ' || parPlaca , '', 0,
    0,0,0, v_id_usuario ,current , '' , 0,parCentro, ParFolioRecibo ) ;
   let linea = 1;
   foreach 
   select cta_aplicacion , sum(imp_pagar) into  v_cta , v_importe
      from  tmp_folios where placa = parPlaca
      group by 1
 
   insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 'Suma del importe de folios'  , v_cta ,  v_importe);
   let linea = linea +1;

  end foreach;

if parimpredondeo <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 'REDONDEO' , 550800000,  parimpredondeo);
   let linea = linea +1;
end if;


   foreach 
       select  axo , folio,  placa, num_acuerdo
       into      daxo, dfolio,  dplaca, dacuerdo  
         from  tmp_folios where placa = parPlaca
      
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial,
        13, v_id_usuario , zona , espacio 
        from ta14_folios_adeudo 
     where axo = daxo and folio = dfolio;
     let varcontrol =  dbinfo("sqlca.sqlerrd1"); 

    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
       values ( varcontrol ,ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN);   
   delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
    if dacuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = today 
       where num_acuerdo = dacuerdo and fechapago is null;
      end if;
   end foreach;

  --- BORRAR TEMPORAL
       delete from tmp_folios;
   COMMIT WORK;	
   return 0,'Procedimiento Completo' ;  
trace off;
end procedure
;

create procedure "informix".admin_pago_23s(p_opc int , pnumesta int, p_axof int , p_mesf int,
                parImpCertificado money(15,2),
                parimpredondeo   money(3,2),
                parimpcredito   money(15,2),
    		parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
	        ParFolioRecibo  char(10), --Folio del Recibo (ADMIN)
	        ParFechaRecibo  date ,   --Fecha del Recibo
	        ParReca         int, --No. de Recaudadora
	        ParCaja  char(2) ,--No. de Caja
	        ParCajero  char(10),	 --Clave usuario
                parCentro  integer)
				
{######################################################################
#  Procedimiento:    admin_pago_23
#  Descripcion:      Interfaz de pago de adeudo para el cobro de Estacionamiento Exclusivo en el sistema ADMIN
#
#  Parametros        pnumesta     = numero de Exclusivo
#  de entrada:       Parref       = Referencia maxima a cobrar
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            24 Octubre 2013   
#
#  Llamado por:      Procedimiento sp_pago en dbingresosw
#  Llama a:          
#  
######################################################################}

returning smallint , varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_excid int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(80);
define  v_calle varchar(80); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define  v_movto_cve char(1); 
define v_numext char(5);
define v_rfc  char(15);
define v_colonia varchar(40);

define v_id_usuario int;

define v_cta int;
define linea int;
define v_orden int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define r_cve int;
define r_obser varchar(200);
define v_r char(1);
define v_ca int;
   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -11, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE EXCLUSIVOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
  let v_r = 'N';
set debug file to "pagos23";
trace on;
select count(*) into v_ca from tmp_exclusivos ;
 if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--OBTENER EL ID USUARIO CAJERO;
select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = ParCajero;

if  v_id_usuario    is null then
 let v_id_usuario   = 335;  -- usuario ADMIN
end if;

select id into p_excid from ex_contrato where no_exclusivo = pnumesta;

 select nvl(a.id,0) , a.no_exclusivo, trim(b.propietario), trim(b.domicilio) , trim(b.colonia) , b.rfc , a.estatus
 into v_id , v_numesta, v_nombre , v_calle  , v_colonia , v_rfc, v_movto_cve
 from ex_contrato a , ex_propietario b where a.no_exclusivo = pnumesta and a.ex_propietario_id = b.id;



  BEGIN WORK;
   let v_r = 'S';
 -- select * from db_ingresos:ta_12_recibos where id_modulo = 24 and fecha > '1/1/2013'
   insert into db_ingresos:ta_12_recibos(fecha , id_rec , caja , operacion ,  importe , cvepago ,
    id_modulo ,  id_regmodulo,  id_rec_cta , regmunur ,
    mesdesde , axodesde, meshasta, axohasta ,
    nombre ,  domicilio , concepto , rfcini , rfcnumero ,
    rfccolonia,  obra ,  axofolio , id_usuario , fecha_act , descripcion ,
    lugar_pago , id_centro ,  foliorecibo) 
   values (ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN     , parImpCertificado, 'P' ,
    28, v_id, 0, 'P' ,
    0, 0, 0, 0, v_nombre, v_calle  ,'PAGO DE ESTACIONAMIENTO EXCLUSIVO NUM.' || v_numesta , 'EX', 
    v_numesta,0,0,0, v_id_usuario ,current , '' , 0,parCentro, ParFolioRecibo ) ;
   let linea = 1;
-- INSERTA LOS REGISTROS DETALLE.
   foreach 
     select orden , cta_aplicacion , sum(imp_pagar) 
      into v_orden , v_cta , v_importe
     from tmp_exclusivos
     group by 1,2 order by 1,2
  
  insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    'Registro a cuenta del ingreso por exclusivos '  , v_cta ,  v_importe);
   let linea = linea +1;

   end foreach ;
--  redondeo

 if parimpredondeo <> 0 then 
  insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    'Ajuste admin',  550800000,  v_importe);
 end if;
--AFECTACION DEL ADEUDO DE EXCLUSIVOS
  

  execute procedure cajero_exc_pagoADMIN(2 , v_id, p_axof , p_mesf , ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , parImpCertificado )
    into r_cve , r_obser;
   if r_cve <> 0 then
          ROLLBACK WORK;
      RETURN -1,'Error, no se puede afectar los adeudos de publicos. Verificar';
   end if;

  COMMIT WORK;	
   delete from tmp_exclusivos;
   return 0,'Procedimiento Completo' ; 
trace off;
end procedure;

CREATE PROCEDURE "informix".spget_lic_grales(v_licencia int,v_anuncio int,v_id_rec int)
{######################################################################
#  Procedimiento:    spGET_lic_grales
#  Descripcion:      Regresa los datos Generales de La licencia o Anuncio (incluye los datos para la impresion de la licencia)
#
#  Parametros        v_licencia = Numero de licencia
#  de entrada:       v_anuncio  = Numero de Anuncio
#                    v_id_rec   = Id de Recaudadora donde se hace la consulta para pago.
#
#  Parametros        Definidos Abajo.
#  de salida:
#
#  Elaboro:          Marco A. Ortega
#  Fecha:            13 Octubre 2009
#
#  Llamado por:      Programa Cajero de Tesoreria
#  Llama a:
######################################################################}

    --       v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

returning
int as clave, varchar(100) as msg,   int as id, int as bloq, char(1) as vigente, int as id_giro,                         
CHAR(96) as desc_giro,   CHAR(130) as actividad, char(1) as reglamentada, CHAR(80) as propietario,                      
CHAR(50) as ubicacion, integer as numext, char(3) as letext,  char(5) as numint,                      
char(3) as letint,  char(25) as colonia , 
int as zona, int as subzona, char(100) as espubic, int as asiento, char(18)  as curp,  
DECIMAL(10,2) as sup_autorizada, int as num_cajones, int as aforo,  char(70) as rhorario, date as fecha_consejo,
char(11) as cvecatnva, int as subpredio, CHAR(85) as mensaje1,  CHAR(85) as v_mensaje2,    
CHAR(200) as mensaje3, varchar(250) as mensaje4,
varchar(250) as mensaje4_1, varchar(50) as  tipotramite, varchar(50) as desc_reglam ,  
CHAR(13) as rfc, int as licencia,  
varchar(250) as mensaje5, 
varchar(250) as mensaje6,
varchar(250) as mensaje7,
varchar(250) as mensaje8;
 --,varchar(250),varchar(250),varchar(250),varchar(250),varchar(250),varchar(250);

--Parametros de salida:
define v_clave 		    int;                -- 1
define v_texto        	varchar(100);       -- 2
define v_id    	      	int;                -- 3
define v_bloqueado      int;                -- 4
define v_vigente        char(1);            -- 5
define v_id_giro  		int;                -- 6
define v_desc_giro 		CHAR(96);           -- 7
define v_actividad 		CHAR(130);          -- 8
define v_reglamentada	char(1);            -- 9
define v_propietario 	CHAR(80);           -- 10
define v_ubicacion 		CHAR(50);           -- 11
define v_numext_ubic 	INTEGER;            -- 12
define v_letraext_ubic 	CHAR(3);            -- 13
define v_numint_ubic 	CHAR(5);            -- 14
define v_letraint_ubic 	CHAR(3);            -- 15
define v_colonia_ubic 	CHAR(25);           -- 16
define v_zona		int;                    -- 17
define v_subzona		int;                -- 18
define v_espubic		CHAR(100);          -- 19
define v_asiento		int;                -- 20
define v_curp		CHAR(18);               -- 21
define v_sup_autorizada	DECIMAL(10,2);      -- 22
define v_num_cajones	int;                -- 23
define v_aforo		int;                    -- 24
define v_rhorario		CHAR(70);           -- 25
define v_fecha_consejo 	DATE;               -- 26
define v_cvecatnva		CHAR(11);           -- 27
define v_subpredio		int;                -- 28
define v_mensaje1 		CHAR(85);           -- 29
define v_mensaje2 		CHAR(85);           -- 30
define v_mensaje3 		CHAR(200);          -- 31
define v_mensaje4 		varchar(250);       -- 32
define v_mensaje4_1	varchar(250);           -- 33
define v_tipotramite		varchar(50);    -- 34  --nueva,refrendo,etc
define v_desc_reglam	varchar(50);        -- 35  --Giro de control especial
define v_rfc 		CHAR(13);               -- 36  --rfc  para impresion
--v_licencia = parametro de entrada         -- 37
define v_mensaje5		varchar(250);       -- 38     --para condonadas
define v_mensaje6 		varchar(250);       -- 39 --para las de autoevaluacion
define v_mensaje7		varchar(250);       -- 40 --actividad o descripcion de anuncio, para impresion
define v_mensaje8 		varchar(250);       -- 41 --Cajones,aforo,superficie, fecha consejo, para impresion
-- fin Parametros de Salida

--define v_mensaje9		varchar(250); -- no asignado
--define v_mensaje10 		varchar(250); -- no asignado
--define v_mensaje11		varchar(250); -- no asignado
--define v_mensaje12 		varchar(250); -- no asignado
--define v_mensaje13		varchar(250); -- no asignado
--define v_mensaje14 		varchar(250); -- no asignado

-----------------------------------------------------------
define v_id_licencia       	int;
define v_id_anuncio       	int;
define v_axo          		int;
define v_anunciosv                  int;
define v_tipolic    		char(1);
define v_saldo    		MONEY(16,2);
define v_lic	       	int;
define v_concepto 		varchar(150);
define v_importe    		MONEY(16,2);
define v_ctaaplic		int;
define v_forma		MONEY(8,2);
define v_oficial_mayor	CHAR(50);
define v_recalic		int;
define v_msgbloq		char(10);
define v_clasificacion 	CHAR(1);
define v_tipo_tramite 	int;
define v_id_tramite		int;

let v_clave = 0;
let v_saldo = 0;
let v_concepto = '';
let v_importe = 0;
let v_texto='';
let v_rfc = '';
let v_cvecatnva = '';
let v_subpredio =0;
let v_fecha_consejo = null;
let v_tipotramite = '';
let v_mensaje1  = '';
let v_mensaje2  = '';
let v_mensaje3  = '';
let v_rhorario = '';
let v_aforo = 0;
let v_num_cajones = 0;
let v_sup_autorizada = 0;
let v_curp = '';
let v_asiento = 0;
let v_espubic = '';

let v_id    	      	= 0;
let v_bloqueado       = 0;
let v_vigente            = '';
let v_id_giro  	= 0;
let v_desc_giro 	= '';
let v_actividad 	= '';
let v_reglamentada	= '';
let v_propietario 	= '';
let v_ubicacion 	= '';
let v_numext_ubic= 0;
let v_letraext_ubic 	= '';
let v_numint_ubic 	= '';
let v_letraint_ubic 	= '';
let v_colonia_ubic 	= '';
let v_zona = 0;
let v_subzona = 0;

let v_mensaje4 = 'SR. CONTRIBUYENTE, Se le recuerda que debe tramitar su contrato de recolecci�n de basura, conforme a lo establecido en el Reglamento para la Prestaci�n del Servicio';
let v_mensaje4_1 = ' de Aseo P�blico y el Reglamento para la Protecci�n del Medio Ambiente y la Ecolog�a en el Municipio de Guadalajara.';

let v_desc_reglam = '';
let v_mensaje5 = '';
let v_mensaje6 = '';
let v_mensaje7 = '';
let v_mensaje8 = '';
--let v_mensaje9 = '';
--let v_mensaje10 = '';
--let v_mensaje11 = '';
--let v_mensaje12 = '';
--let v_mensaje13 = '';
--let v_mensaje14 = '';

--set debug file to 'marco.log';
--trace on;

if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia
   if exists (select *  from catastro_gdl:licencias l,outer catastro_gdl:convcta cc where licencia= v_licencia
                and cc.cvecuenta = l.cvecuenta) then
   select nvl(l.id_licencia,0),l.bloqueado,l.vigente,year(l.fecha_otorgamiento),l.id_giro,l.propietario,l.actividad,l.ubicacion,l.numext_ubic,l.letraext_ubic,
           l.numint_ubic,l.letraint_ubic,l.colonia_ubic,l.zona,l.subzona,l.espubic,l.asiento,l.curp,l.sup_autorizada,l.num_cajones,l.aforo,l.rhorario,l.fecha_consejo,
           cc.cvecatnva,cc.subpredio,l.rfc
           into v_id_licencia,v_bloqueado,v_vigente,v_axo,v_id_giro,v_propietario,v_actividad,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_rfc
   from catastro_gdl:licencias l,outer catastro_gdl:convcta cc
   where licencia= v_licencia
            and cc.cvecuenta = l.cvecuenta ;
   let v_id = v_id_licencia;
   let v_rhorario = "Horario: " || nvl(v_rhorario,'');
   let v_mensaje7 = "ACTIVIDAD: " || nvl(v_actividad,'');
   let v_mensaje8 = "Cajones de estacionameinto: " || nvl(v_num_cajones,0) || "    Aforo de personas: " || nvl(v_aforo,0) || "    Superficie autorizada: " || nvl(v_sup_autorizada,0) || "                " || nvl(v_fecha_consejo,'');
   if exists (select * from catastro_gdl:lic_autoev
       where id_licencia =v_id and year(fecresol) = year(today)) then
       let v_mensaje6 = "OTORGADA BAJO EL PROGRAMA DE SIMPLIFICACION PARA LA COMPETITIVIDAD.";
   end if;

  else
   let v_id = 0;
   let v_clave = 10;
   let v_texto = "NO EXISTE LA LICENCIA.";
   return v_clave,v_texto,v_id,nvl(v_bloqueado,0),nvl(v_vigente,''),nvl(v_id_giro,0),nvl(v_desc_giro,''),nvl(v_actividad,''),
	nvl(v_reglamentada,''),nvl(v_propietario,''),nvl(v_ubicacion,''),nvl(v_numext_ubic,0),nvl(v_letraext_ubic,''),
	nvl(v_numint_ubic,''),nvl(v_letraint_ubic,''),nvl(v_colonia_ubic,''),
	nvl(v_zona,0),nvl(v_subzona,0),nvl(v_espubic,''),nvl(v_asiento,0),nvl(v_curp,''),nvl(v_sup_autorizada,0.0),nvl(v_num_cajones,0),
	nvl(v_aforo,0),nvl(v_rhorario,''),nvl(v_fecha_consejo,today),
	nvl(v_cvecatnva,''),nvl(v_subpredio,0),nvl(v_mensaje1,''),nvl(v_mensaje2,''),nvl(v_mensaje3,''),nvl(v_mensaje4,''),nvl(v_mensaje4_1,''),
	nvl(v_tipotramite,''),nvl(v_desc_reglam,''),nvl(v_rfc,''),
    nvl(v_licencia,''),nvl(v_mensaje5,''),nvl(v_mensaje6,''),nvl(v_mensaje7,''),nvl(v_mensaje8,'');-- ,nvl(v_mensaje9,''),nvl(v_mensaje10,''),nvl(v_mensaje11,''),nvl(v_mensaje12,''),nvl(v_mensaje13,''),nvl(v_mensaje14,'');
  end if;
end if;

if (v_licencia = 0) and (v_anuncio > 0) then  --cuando es anuncio
   if exists (select * from catastro_gdl:anuncios a, catastro_gdl:licencias l 
      where a.anuncio=v_anuncio and l.id_licencia=a.id_licencia ) then
   select nvl(a.id_anuncio,0),a.bloqueado,a.vigente,year(a.fecha_otorgamiento),a.id_giro,l.propietario,
           'MEDIDAS ' || medidas1 || ' X ' || medidas2 || ' area: ' || area_anuncio || ' CARAS: ' || num_caras
           ,a.ubicacion,a.numext_ubic,a.letraext_ubic,
           a.numint_ubic,a.letraint_ubic,a.colonia_ubic,a.zona,a.subzona,a.espubic,a.asiento,l.curp,0,0,0,'','','',0,l.rfc
           into v_id_anuncio,v_bloqueado,v_vigente,v_axo,v_id_giro,v_propietario,v_actividad,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic ,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_rfc
   from catastro_gdl:anuncios a, catastro_gdl:licencias l where a.anuncio=v_anuncio and l.id_licencia=a.id_licencia;
   let v_id = v_id_anuncio;
   SELECT DESCRIPCION INTO v_mensaje7 FROM catastro_gdl:c_giros WHERE id_giro = v_id_giro;
   let v_mensaje7 = ' TIPO: ' || trim(nvl(v_mensaje7,''))|| '  ' || trim(nvl(v_actividad,''));
  else
   let v_id = 0;
   let v_clave = 10;
   let v_texto = "NO EXISTE EL ANUNCIO.";
   return v_clave,v_texto,v_id,nvl(v_bloqueado,0),nvl(v_vigente,''),nvl(v_id_giro,0),nvl(v_desc_giro,''),nvl(v_actividad,''),
	nvl(v_reglamentada,''),nvl(v_propietario,''),nvl(v_ubicacion,''),nvl(v_numext_ubic,0),nvl(v_letraext_ubic,''),
	nvl(v_numint_ubic,''),nvl(v_letraint_ubic,''),nvl(v_colonia_ubic,''),
	nvl(v_zona,0),nvl(v_subzona,0),nvl(v_espubic,''),nvl(v_asiento,0),nvl(v_curp,''),nvl(v_sup_autorizada,0.0),nvl(v_num_cajones,0),
	nvl(v_aforo,0),nvl(v_rhorario,''),nvl(v_fecha_consejo,today),
	nvl(v_cvecatnva,''),nvl(v_subpredio,0),nvl(v_mensaje1,''),nvl(v_mensaje2,''),nvl(v_mensaje3,''),nvl(v_mensaje4,''),nvl(v_mensaje4_1,''),
	nvl(v_tipotramite,''),nvl(v_desc_reglam,''),nvl(v_rfc,''),
    nvl(v_licencia,''),nvl(v_mensaje5,''),nvl(v_mensaje6,''),nvl(v_mensaje7,''),nvl(v_mensaje8,'');-- ,nvl(v_mensaje9,''),nvl(v_mensaje10,''),nvl(v_mensaje11,''),nvl(v_mensaje12,''),nvl(v_mensaje13,''),nvl(v_mensaje14,'');
  end if;
end if;

   select nvl(g.reglamentada,'N') ,g.descripcion,g.ctaaplic,m.mensaje1,m.mensaje2,g.clasificacion
          into v_reglamentada,v_desc_giro,v_ctaaplic,v_mensaje1,v_mensaje2,v_clasificacion
          from catastro_gdl:c_giros g,outer catastro_gdl:c_mensajes_lic m where g.id_giro= v_id_giro
          and m.id_mensaje=g.id_mensaje;

if (v_reglamentada = 'S')  then
   let v_desc_reglam = 'GIRO DE CONTROL ESPECIAL';
end if;

-- si es licencia condonada
if exists (select * from catastro_gdl:licencias l, catastro_gdl:lic_condonadas c where
		l.licencia = v_licencia and c.licencia = l.licencia) then
   let v_mensaje5 = 'Los Derechos de la presente Licencia Municipal han sido condonados en los t�rminos del decreto No. 22633/LV11/09 de fecha 30 de Abril 2009, emitido por el H. Congreso del Estado de Jalisco.';
end if;

if v_clasificacion in ('A','B') then
   let v_mensaje3 = '�Ahora es mas facil. No pierdas tiempo. Refrenda tu licencia via internet ingresando a la pagina www.guadalajara.gob.mx !';
else
   let v_mensaje3 = '';
end if;

   select forma,recalic,oficial_mayor into v_forma,v_recalic,v_oficial_mayor from catastro_gdl:parametros_lic;


if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia

	if v_bloqueado = 0 then let v_msgbloq=''	;	end if;
	if v_bloqueado = 1 then let v_msgbloq='BLOQUEADA';	end if;
	if v_bloqueado = 2 then let v_msgbloq='ESTADO 1';	end if;
	if v_bloqueado = 3 then let v_msgbloq='CABARETS';	end if;
	if v_bloqueado = 4 then let v_msgbloq='SUSPENDIDA';	end if;
	if v_bloqueado = 5 then let v_msgbloq='RESPONSIVA';	end if;
	if v_bloqueado = 6 then let v_msgbloq='CONVENIADA';	end if;
	if v_bloqueado = 7 then let v_msgbloq='DESGLOSAR ';	end if;

	-----------Verifica si esta bloqueda para las licencias con holograma mas de 1 maquinita

               if exists (select id_licencia from catastro_gdl:lic_maq where id_licencia = v_id) then
                  let v_bloqueado = 7;
  	  let v_msgbloq='DESGLOSAR ';
               end if;
	------------------------------------

	if v_axo = year(today) then
	   let v_tipo_tramite =  1;
	elif EXISTS(select id_tramite from catastro_gdl:tramites where id_licencia = v_id and
     		feccap between TO_DATE('01/01/' || year(today),'%d/%m/%Y') and TO_DATE('31/12/' || year(today),'%d/%m/%Y')
		and estatus='A' )	then

		foreach
   		select (trim(tipo_tramite) * 1) ,id_tramite
	                                into v_tipo_tramite , v_id_tramite
			from catastro_gdl:tramites
             			where id_licencia = v_id and
        		                feccap between TO_DATE('01/01/' || year(today),'%d/%m/%Y') and TO_DATE('31/12/' || year(today),'%d/%m/%Y')
			and estatus='A' order by id_tramite asc
		end foreach;
	else
	      let v_tipo_tramite =  0;
	end if;

	if v_tipo_tramite =  0  then let v_tipotramite = 'REFRENDO DE LICENCIA'; 		end if;
	if v_tipo_tramite =  1  then let v_tipotramite = 'LICENCIA NUEVA';			end if;
	if v_tipo_tramite =  2  then let v_tipotramite = 'MODIFICACION DE LICENCIA';		end if;
	if v_tipo_tramite =  5  then let v_tipotramite = 'TRASPASO DE LICENCIA';		end if;
	if v_tipo_tramite =  6  then let v_tipotramite = 'CAMBIO DE DOMICILIO DE LICENCIA';	end if;
	if v_tipo_tramite =  7  then let v_tipotramite = 'CAMBIO DE GIRO DE LICENCIA';		end if;
	if v_tipo_tramite =  8  then let v_tipotramite = 'ESTADO UNO DE LICENCIA';		end if;
    let v_tipotramite =  v_tipotramite || ' ' || v_licencia;

end if;


if (v_licencia = 0) and (v_anuncio > 0) then  --cuando es anuncio

	if v_bloqueado = 0 then let v_msgbloq=''	;	end if;
	if v_bloqueado = 1 then let v_msgbloq='BLOQUEADA';	end if;

	if v_axo = year(today) then
	   let v_tipo_tramite =  3;
	elif EXISTS(select id_tramite from catastro_gdl:tramites where id_anuncio = v_id and
     		feccap between TO_DATE('01/01/' || year(today),'%d/%m/%Y') and TO_DATE('31/12/' || year(today),'%d/%m/%Y')
		and estatus='A' )	then

		foreach
   		select (trim(tipo_tramite) * 1) ,id_tramite
	                                into v_tipo_tramite , v_id_tramite
			from catastro_gdl:tramites
             			where id_anuncio = v_id and
                   		feccap between TO_DATE('01/01/' || year(today),'%d/%m/%Y') and TO_DATE('31/12/' || year(today),'%d/%m/%Y')
			and estatus='A' order by id_tramite asc
		end foreach;
	else
	   let v_tipo_tramite =  0;
	end if;

	if v_tipo_tramite =  0  then let v_tipotramite = 'REFRENDO DE ANUNCIO';		end if;
	if v_tipo_tramite =  3  then let v_tipotramite = 'ANUNCIO NUEVO';			end if;
	if v_tipo_tramite =  4  then let v_tipotramite = 'MODIFICACION DE ANUNCIO';		end if;
	if v_tipo_tramite =  9  then let v_tipotramite = 'TRASPASO DE ANUNCIO';		end if;
	if v_tipo_tramite =  10 then let v_tipotramite = 'CAMBIO DE DOMICILIO DE ANUNCIO';	end if;
	if v_tipo_tramite =  11 then let v_tipotramite = 'CAMBIO DE TIPO DE ANUNCIO';		end if;
	if v_tipo_tramite =  12 then let v_tipotramite = 'ESTADO UNO DE ANUNCIO';		end if;
    let v_tipotramite =  v_tipotramite || ' ' || v_anuncio;
end if;


--select clasificacion into v_tipolic from catastro_gdl:c_giros where id_giro = v_id_giro;

if v_vigente <> 'V' then
   let v_clave = 1;
   let v_texto = 'CANCELADA';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8;-- ,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

end if;

if v_bloqueado > 0 then
   let v_clave = 2;
   if v_bloqueado = 7 then
      let v_texto = "LICENCIA BLOQUEADA, FAVOR DE PASAR A PADRON Y LICENCIAS A TRAMITAR LICENCIAS POR SEPARADO";
   else
     let v_texto = v_msgbloq;
   end if;
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8;-- ,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

end if;
---------------
if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia
   if not exists(select d.axo from catastro_gdl:detsal_lic d
            where d.id_licencia=v_id_licencia
            and d.cvepago=0
            and d.axo = year(today)) then
   let v_clave = 5;
   let v_texto = 'LA LICENCIA NO TIENE ADEUDOS';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8;-- ,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

   end if;
end if;

if (v_licencia = 0) and (v_anuncio > 0) then  --cuando es anuncio
   if not exists(select d.axo from detsal_lic d
            where d.id_anuncio=v_id_anuncio
            and d.cvepago=0
            and d.axo = year(today)) then
   let v_clave = 5;
   let v_texto = 'LA LICENCIA NO TIENE ADEUDOS';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; -- ,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

   end if;
end if;


--pagado por internet
if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia
   if exists(select * from catastro_gdl:lic_pago_alt where licencia = v_licencia
            and year(fecha_registro)=year(today) )  then
--      if   v_lugarpago = 'R' then --verifica que no se haya pagado por internet
           let v_clave = 6;
           let v_texto = 'LA LICENCIA YA FUE PAGADA POR INTERNET';
           return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; -- ,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

--       end if;
   end if;
end if;

--------------
if (v_reglamentada = 'S') and (v_id_rec <> 2) then
   let v_clave = 3;
   let v_texto = 'REGLAMENTADA, SOLO SE PUEDE PAGAR EN RECAUDADORA 2 REFORMA';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; -- ,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

end if;

--if (v_axo = year(today)) and (v_id_rec <> 2) then
--   let v_clave = 3;
--   let v_texto = 'NUEVA, SOLO SE PUEDE PAGAR EN RECAUDADORA 2 REFORMA';
--   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
--           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
--           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
--           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

--end if;

if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia
--    if EXISTS(select id_tramite from catastro_gdl:tramites where id_licencia = v_id and
--     		feccap between TO_DATE('01/01/' || year(today),'%d/%m/%Y') and TO_DATE('31/12/' || year(today),'%d/%m/%Y')
--		and estatus='A' )	then

--  	foreach
--	  select (case when tipo_tramite=1 then 'NUEVA, '
--                     when tipo_tramite=2 then 'MODIFICACION, '
--                     when tipo_tramite=5 then 'TRASPASO, '
--                     when tipo_tramite=6 then 'CAMBIO DE DOMICILIO, '
--                     when tipo_tramite=7 then 'CAMBIO DE GIRO, '
--	     else ''
--                end),id_tramite INTO v_tipotramite ,v_tipo_tramite
--                from catastro_gdl:tramites where feccap > TO_DATE('01/01/' || year(today),'%d/%m/%Y') and estatus = 'A'
--                and id_licencia = v_id
--	order by id_tramite asc
--  	end foreach;
--   else
--      let v_tipo_tramite =  0;
--      let v_tipotramite = 'REFRENDO DE LICENCIA';

--   end if;

   if (v_tipo_tramite > 0) and (v_id_rec <> 2) then
      let v_clave = 4;
      let v_texto = v_tipotramite || ' SOLO SE PUEDE PAGAR EN RECAUDADORA 2 REFORMA';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

   end if;
end if;

if (v_licencia = 0) and (v_anuncio > 0) then  --cuando es anuncio
--    if EXISTS(select id_tramite from tramites where id_licencia = v_id and
--     		feccap between TO_DATE('01/01/' || year(today),'%d/%m/%Y') and TO_DATE('31/12/' || year(today),'%d/%m/%Y')
--		and estatus='A' )	then

--	  foreach
--	  select (case when tipo_tramite=3 then 'NUEVA, '
--                     when tipo_tramite=4 then 'MODIFICACION, '
--                     when tipo_tramite=9 then 'TRASPASO, '
--                     when tipo_tramite=10 then 'CAMBIO DE DOMICILIO, '
--                     when tipo_tramite=11 then 'CAMBIO DE TIPO, '
--	     else ''
--             		end),id_tramite INTO v_tipotramite,v_tipo_tramite
--             	from tramites where feccap > TO_DATE('01/01/' || year(today),'%d/%m/%Y') and estatus = 'A'
--                and id_anuncio = v_id
--	order by id_tramite asc
--  	end foreach;
--   else
--      let v_tipo_tramite =  0;
--      let v_tipotramite = 'REFRENDO DE ANUNCIO';
--   end if;

   if (v_tipo_tramite > 0) and (v_id_rec <> 2) then
      let v_clave = 4;
      let v_texto = v_tipotramite || 'SOLO SE PUEDE PAGAR EN RECAUDADORA 2 REFORMA';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

   end if;
end if;

-------------
--no tiene adeudos , anterior
-------------

---consulta el saldo
if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia
select nvl(total,0) into v_saldo from catastro_gdl:saldos_lic where id_licencia=v_id_licencia;

--suma detalles
select  sum(d.saldo) into v_importe
     from catastro_gdl:detsal_lic d
     where d.id_licencia=v_id_licencia
       and d.cvepago = 0;

--verifica que el calculo este correcto
if v_saldo <> v_importe then
   let v_importe=0; --Se pone a cero el importe de detalle
   let v_clave = 7;
   let v_texto = 'LA SUMA DE ACCESORIOS NO CUADRAN CON EL SALDO DE LA LICENCIA';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

end if;

end if;--saldos

--let v_importe=0; --Se pone a cero el importe de detalle

--verifica si hay anuncios bloqueados
if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia

select count(*) into v_anunciosv  from catastro_gdl:anuncios where id_licencia = v_id_licencia
       and vigente='V' and  bloqueado > 0;

if v_anunciosv > 0 then
   let v_clave = 8;
   let v_texto = 'LA LICENCIA TIENE ANUNCIOS BLOQUEADOS';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;


end if;

end if;--anuncios bloqueados

--licencia con anuncios nuevos
if (v_licencia > 0) and (v_anuncio = 0) then   --cuando es licencia

   if exists(select * from catastro_gdl:anuncios where id_licencia = v_id_licencia
            and year(fecha_otorgamiento)=year(today) )  then

      if v_id_rec <> 2 then
         let v_clave = 9;
         let v_texto = 'LA LICENCIA TIENE ANUNCIO(S) NUEVO(S), SOLO SE PUEDE PAGAR EN RECAUDADORA 2 REFORMA';
   return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

      end if;

   end if;

end if;

--Pasa todo se puede cobrar

let v_clave=0 ;
let v_texto='LA LICENCIA SE PUEDE COBRAR';
-- si es licencia con holograma
if exists (select * from catastro_gdl:licencias l, catastro_gdl:c_giros_holog c where
		l.id_licencia = v_id and c.id_giro = l.id_giro and c.axo=year(today)) then
   let v_clave= -1 ;
   let v_texto='LA LICENCIA SE PUEDE COBRAR, LA IMPRESI�N DE LICENCIA REQUIERE FORMATO CON HOLOGRAMA';
end if;

return  v_clave,v_texto,v_id,v_bloqueado,v_vigente,v_id_giro,v_desc_giro,v_actividad,v_reglamentada,v_propietario,v_ubicacion,v_numext_ubic,v_letraext_ubic,
           v_numint_ubic,v_letraint_ubic,v_colonia_ubic,v_zona,v_subzona,v_espubic,v_asiento,v_curp,v_sup_autorizada,v_num_cajones,v_aforo,v_rhorario,v_fecha_consejo,
           v_cvecatnva,v_subpredio,v_mensaje1,v_mensaje2,v_mensaje3,v_mensaje4,v_mensaje4_1, v_tipotramite,v_desc_reglam,v_rfc,
           v_licencia,v_mensaje5,v_mensaje6,v_mensaje7,v_mensaje8; --,v_mensaje9,v_mensaje10,v_mensaje11,v_mensaje12,v_mensaje13,v_mensaje14;

--trace off;
END PROCEDURE
;

CREATE PROCEDURE "informix".spget_lic_detalles(v_id int,v_tipo char(1),v_ajuste char(1))
{######################################################################
#  Procedimiento:    spGET_lic_detalles
#  Descripcion:      Regresa los Totales de Lal icencia o Anuncio Para Impresion
#                    desglosa los anuncios con descripcion
#
#  Parametros        v_id          = id de licencia o Anuncio
#  de entrada:       v_tipo        = 'L' licencia, 'A' Anuncio
#
#
#  Parametros        Definidos Abajo.
#  de salida:
#
#  Elaboro:          Marco A. Ortega
#  Fecha:            20 Octubre 2009
#
#  Llamado por:      Programa Cajero de Tesoreria
#  Llama a:
#
######################################################################}

returning 
int as cuenta, 
char(1) as obliga ,
varchar(150) as concepto,
money(16,2) as importe,
int as licanun;
--Parametros de salida:
define v_cuenta 	int;                -- 1
define v_obliga     varchar(1);         -- 2
define v_concepto   varchar(150);        -- 3 Texto para Impresion de detalles
define v_derechos   money(16,2);        -- 4
define v_licanun    int;                -- 5 Numero de Licencias o anuncios
-- fin Parametros de Salida
define v_forma        money(10,2);
define v_sol        char(1);
define v_tot        money(10,2);
define v_totRedon   money(10,2);
define v_totDif     money(10,2);


let v_sol = "N";
let v_obliga = "S";
let v_tot = 0;
let v_licanun = 0;
if v_tipo = 'L' then
    select licencia into v_licanun from catastro_gdl:licencias where id_licencia = v_id;
--verifica que derechos sea mayor a cero
-- Inserta la licencia del axo actual
      select g.ctaaplic,"DERECHOS LICENCIA ACTUAL "||axo
             ,d.derechos
     into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:detsal_lic d, catastro_gdl:licencias l,outer catastro_gdl:c_giros g
     where d.id_licencia=v_id
       and l.id_licencia=d.id_licencia
       and d.axo=year(today)
       and d.id_anuncio = 0
       and d.cvepago = 0
       and d.derechos >= 0
       and g.id_giro = l.id_giro ;

if v_derechos > 0 then
   let v_sol = "S";
   let v_tot = v_tot + v_derechos;
   return v_cuenta,v_obliga, v_concepto, v_derechos,v_licanun with resume;
end if;


-- Inserta las formas
      select 421200002,"IMPRESOS "||min(axo)||"-"||max(axo)
             ,sum(d.forma)
     into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:licencias l, catastro_gdl:detsal_lic d
     where l.id_licencia=v_id
       and d.id_licencia=l.id_licencia
       and d.cvepago=0
       and d.forma >= 0
     group by 1;

if v_derechos > 0 then
   let v_sol = "S";
   let v_tot = v_tot + v_derechos;
   return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;
-- Inserta los anuncios del axo actual
FOREACH

     select g.ctaaplic,a.anuncio, "Medidas: "||a.medidas1||"X"||a.medidas2||
       " Caras: "||a.num_caras||
       " Tipo: "||trim(g.descripcion),
       sum(d.derechos)
     into v_cuenta, v_licanun, v_concepto, v_derechos
     from catastro_gdl:anuncios a, catastro_gdl:detsal_lic d, catastro_gdl:c_giros g
     where d.id_licencia=v_id
       and d.id_anuncio > 0
       and a.id_anuncio=d.id_anuncio
       and g.id_giro=a.id_giro and d.axo=year(today)
       and d.cvepago=0
       and d.derechos >= 0

     group by 1,2,3

if v_derechos > 0 then
   let v_sol = "S";
   let v_tot = v_tot + v_derechos;
   return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;

END FOREACH;

-- Inserta adeudos anteriores de licencias
select licencia into v_licanun from catastro_gdl:licencias where id_licencia = v_id;

      select 922100017,"ADEUDOS ANTERIORES DE LICENCIA "||
		min(axo)||"-"||max(axo),
             sum(d.derechos)
     into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:licencias l, catastro_gdl:detsal_lic d
     where l.id_licencia=v_id
       and d.id_licencia=l.id_licencia
       and d.axo<year(today)
       and d.cvepago=0
       and d.id_anuncio = 0
       and d.derechos >= 0
     group by 1;
if v_derechos > 0 then
   let v_sol = "S";
   let v_tot = v_tot + v_derechos;
   return v_cuenta, v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;

-- Inserta adeudos anteriores de anuncios
   let v_licanun = 0;

      select 922200012,"ADEUDOS ANTERIORES DE ANUNCIOS "
	||min(axo)||'-'||max(axo),
             sum(d.derechos)
     into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:anuncios a , catastro_gdl:detsal_lic d
     where d.id_licencia=v_id
       and d.id_anuncio > 0
       and a.id_anuncio=d.id_anuncio
       and d.axo<year(today)
       and d.cvepago=0
       and d.derechos >= 0
     group by 1;
if v_derechos > 0 then
   let v_sol = "S";
   let v_tot = v_tot + v_derechos;
   return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;
-- Inserta adeudo de recargos

    select 390100000,"RECARGOS",sum(d.recargos)
     into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:detsal_lic d
     where d.id_licencia=v_id
     and d.cvepago=0
     and d.recargos > 0
     group by 1;
if v_derechos > 0 then
   let v_sol = "S";
   let v_tot = v_tot + v_derechos;
   return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;

-- Inserta Descuento de recargos
    select 390100000,"DESCUENTO DE RECARGOS",sum(d.desc_recargos)
     into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:detsal_lic d
     where d.id_licencia=v_id
     and d.cvepago=0
     and d.desc_recargos > 0
     group by 1;
if v_derechos > 0 then
   let v_sol = "S";
   let v_derechos = v_derechos * -1;
   let v_tot = v_tot + v_derechos;
   return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;

-- si paga solicitud
if v_sol = "S" then
   if exists (select * from catastro_gdl:tramites t
	where t.id_licencia = v_id
	and year(t.feccap) = year(today) and estatus = "A") then

               if not exists (select * from catastro_gdl:tramites t,  catastro_gdl:lic_nopagsol ln
		where ln.id_tramite = t.id_tramite
		and t.id_licencia = v_id) then
           		select p.costo_solicitud
		           into v_derechos
		           from parametros_lic p;


                let v_tot = v_tot + v_derechos;
                return 421200002,v_obliga, "FORMA DE SOLICITUD", v_derechos, v_licanun with resume;
	end if;
   end if;
end if;

-- si es licencia con holograma
   if exists (select * from catastro_gdl:licencias l, catastro_gdl:c_giros_holog c where
		l.id_licencia = v_id and c.id_giro = l.id_giro and c.axo=year(today)) then

      select max(ctaaplic),"COSTO HOLOGRAMA "||min(d.axo)||'-'||max(d.axo),sum(c.costo)
             into v_cuenta, v_concepto, v_derechos
      from catastro_gdl:licencias l, catastro_gdl:detsal_lic d, catastro_gdl:c_giros_holog c
      where l.id_licencia=v_id
       and d.id_licencia=l.id_licencia
       and d.cvepago=0
       and d.id_anuncio = 0
       and d.derechos >= 0
       and c.id_giro = l.id_giro and c.axo=d.axo;

        let v_tot = v_tot + v_derechos;
	return v_cuenta,v_obliga,v_concepto,v_derechos, v_licanun  with resume;
   end if;

end if; ---Licencias

if v_tipo = 'A' then
   select NVL(d.forma,0),d.derechos into v_forma,v_derechos
         from catastro_gdl:detsal_lic  d
     where d.id_anuncio=v_id and
           cvepago=0
       and d.axo = year(today);

--DERECHOS ACTUALES DE ANUNCIO
         select g.ctaaplic,a.anuncio,
       "Medidas: "||a.medidas1||"X"||a.medidas2||
       " Caras: "||a.num_caras||
       " Tipo: "||trim(g.descripcion),sum(d.derechos)
     into v_cuenta,v_licanun, v_concepto, v_derechos
     from catastro_gdl:detsal_lic d,outer catastro_gdl:c_giros g, catastro_gdl:anuncios a
     where d.id_anuncio= v_id
       and a.id_anuncio=d.id_anuncio
       and g.id_giro=a.id_giro and d.axo=year(today)
       and cvepago=0
       and d.derechos > 0
     group by 1,2,3;
if v_derechos > 0 then
   let v_sol = "S";
   let v_tot = v_tot + v_derechos;
   return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;
--si la forma es cero se cobra el costo de la forma por ser cobrado el anuncio por separado
   if v_forma = 0 then
      select 421200002,"IMPRESO "||year(today),p.forma
         into v_cuenta, v_concepto, v_derechos
           from catastro_gdl:parametros_lic p;
      let v_sol = "S";
      let v_tot = v_tot + v_derechos;
      return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
   end if;

--si la forma es 0.01 es cobrado por convenio
   if v_forma = 0.01 then
      let v_sol = "S";
      let v_tot = v_tot + v_derechos;
      return 421200002,v_obliga, "IMPRESO CONVENIO", v_forma, v_licanun with resume;
   end if;

--si la forma es MAYOR A 1 Para valor de forma del a�o actual
   if v_forma > 1 then
     --- inserta la forma del axo actual
      select 421200002,"IMPRESO "||year(today),p.forma
         into v_cuenta, v_concepto, v_derechos
           from catastro_gdl:parametros_lic p;
      let v_sol = "S";
      let v_tot = v_tot + v_derechos;
      return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
   end if;

-- Inserta las formas de axos anteriores
      select 421200002,"IMPRESOS "||min(axo)||"-"||max(axo),sum(d.forma)
         into v_cuenta, v_concepto, v_derechos
     from  catastro_gdl:detsal_lic d
     where d.id_anuncio=v_id and
           cvepago=0
       and d.axo < year(today)
       and d.forma > 0
     group by 1;
if v_derechos > 0 then
     let v_sol = "S";
     let v_tot = v_tot + v_derechos;
     return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;
-- Inserta adeudos anteriores de anuncios
      select 922200012,"ADEUDOS ANTERIORES DE ANUNCIOS "
	||min(axo)||"-"||max(axo)
             ,sum(d.derechos)
         into v_cuenta, v_concepto, v_derechos
     from  catastro_gdl:detsal_lic d
     where d.id_anuncio=v_id
       and d.axo<year(today)
       and cvepago=0
       and d.derechos > 0
     group by 1;
if v_derechos > 0 then
      let v_sol = "S";
      let v_tot = v_tot + v_derechos;
      return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun with resume;
end if;

let v_licanun = 0;
-- Inserta adeudo de recargos
      select 390100000,"RECARGOS",sum(d.recargos)
         into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:detsal_lic d
     where d.id_anuncio=v_id and cvepago=0
     and d.recargos > 0
     group by 1;
if v_derechos > 0 then
      let v_sol = "S";
      let v_tot = v_tot + v_derechos;
      return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun  with resume;
end if;

-- Inserta DESCUENTO de recargos
      select 390100000,"DESCUENTO DE RECARGOS",sum(d.desc_recargos)
         into v_cuenta, v_concepto, v_derechos
     from catastro_gdl:detsal_lic d
     where d.id_anuncio=v_id and cvepago=0
     and d.desc_recargos > 0
     group by 1;
if v_derechos > 0 then
      let v_sol = "S";
      let v_derechos = v_derechos * -1;
      let v_tot = v_tot + v_derechos;
      return v_cuenta,v_obliga, v_concepto, v_derechos, v_licanun  with resume;
end if;

-- si paga  solicitud
if v_sol = "S" then
   if exists (select * from catastro_gdl:tramites t
	where t.id_anuncio = v_id
	and year(t.feccap) = year(today) and estatus = "A") then

    if not exists (select * from catastro_gdl:tramites t,  catastro_gdl:lic_nopagsol ln
		where ln.id_tramite = t.id_tramite
		and t.id_anuncio = v_id) then
           		select (p.costo_solicitud+p.costo_solicanun)
		           into v_derechos
		           from parametros_lic p;

               let v_tot = v_tot + v_derechos;
               return 421200002,v_obliga, "FORMA DE SOLICITUD", v_derechos, v_licanun  with resume;

               end if;

   end if;
end if;


end if; --Anuncios
--Redondeo
if (v_ajuste='S') then
execute PROCEDURE redondeocaja(v_tot) into v_totRedon,v_totDif;
   if v_totDif <> 0 then
      return 550800000,v_obliga, "AJUSTE ART.14 LEY INGRESOS", v_totDif, v_licanun;
   end if;
else --mensajeria
      select p.costo_envio
		into v_derechos
      from catastro_gdl:parametros_lic p;
      return 427000005,v_obliga, "COSTO MENSAJERIA", v_derechos, v_licanun;
end if;

END PROCEDURE
;

CREATE PROCEDURE "informix".spd_afecta_baja_auto()
returning smallint , varchar(100);		
define v_rowid  int; 
define v_folio_archivo int ;
define v_fecha_archivo varchar(10);
define v_fecha date;
define v_axo int;
define v_placa varchar(10);
define v_anomalia varchar(30);
define v_clave int;
define v_res int;
define v_res2 varchar(100);
define v_cuantas int;
 define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define v_r char(1);
                   
  ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
  
  if  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje with resume;
   ELIF
      v_lError = -1205   THEN
        update ta14_folios_baja_est set fecha_proceso = today , estatus = 10  where id = v_rowid;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje with resume;
  END if; 

END EXCEPTION; 
 begin
    on exception in (-958)
       delete from tmp_foliosbaja;
    end exception;
    create temp table tmp_foliosbaja(
      id int,
      folio int,
      fecha char(10),
      placa varchar(10),
      anomalia  varchar(30)
      
      ) with no log;
  end;
--set debug file to "baja_Esta";
--trace on;
let v_cuantas = 0;
foreach  
   select id , folio_archivo , trim(fecha_archivo) , trim(placa) , trim(anomalia)
   into v_rowid , v_folio_archivo , v_fecha_archivo , v_placa , v_anomalia
   from ta14_folios_baja_est where fecha_proceso is null order by placa , folio_archivo

   insert into tmp_foliosbaja values(  v_rowid , v_folio_archivo , v_fecha_archivo , v_placa , v_anomalia);
end  foreach;
   select count(*) into v_cuantas from tmp_foliosbaja;
   return v_cuantas , 'Folios a Procesar' with resume;
foreach  
   select id , folio , fecha , placa , anomalia
   into v_rowid , v_folio_archivo , v_fecha_archivo , v_placa , v_anomalia
   from tmp_foliosbaja where id between 1 and 3000

  let v_fecha = v_fecha_archivo;
  let v_axo = year(v_fecha);
 
   if v_anomalia = 'Error de vigilante' then
    let  v_clave = 22;
   else
    let v_clave = 23;
   end if;
   execute procedure spd_delesta01sr(v_axo,v_folio_archivo, v_placa ,550,v_clave)
    into v_res , v_res2;
     if v_res is null then
        let v_res = 99;
     end if;
   update ta14_folios_baja_est 
   set axo = v_axo  , fecha_folio = v_fecha , fecha_proceso = today , estatus = v_res 
   where id = v_rowid;
   RETURN 0,  'F ' || v_folio_archivo with resume ;

end foreach;
 RETURN 1,  'F ' || v_folio_archivo with resume ;
--trace off;
end procedure ;

create procedure "informix".fn_pub_ade_act1( p_contrato_id int ) 
returning  money(12,2) as adeudo_act ;
 define v_adeudo money(12,2)     ;
select sum(c.ade_importe) into v_adeudo from pubadeudo c 
 where c.pubmain_id = p_contrato_id and c.axo = year(today) and
 (c.axo * 100) + c.mes <= ((year(today) * 100) + month(today)-1) ;


 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_pub_ade_ant( p_contrato_id int ) 
returning  money(12,2) as adeudo ;
 define v_adeudo money(12,2)     ;

 select sum(c.ade_importe)  into v_adeudo  from pubadeudo c
 where c.pubmain_id = p_contrato_id and axo < year(today);

 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_pub_recargos(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning    money(10,2) as recargos;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define tot_recgos money(10,2);
let tot_recgos = 0;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;
  FOREACH
  select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
   into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,2,3
   if v_tipo = 10 then
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_recargos is null then
       let v_recargos = 0;
    end if;
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
 let tot_recgos = tot_recgos + v_recargos;

end foreach;

return  tot_recgos ;
end procedure;

create procedure "informix".sp_pub_ade_men(  ) 
returning   int as v_numesta , varchar(100) as nombre , char(2) as  categoria , varchar(80) as descripcion ,
   char(1) as sector , varchar(10) as  sectornom,  varchar(100) as calle ,
 varchar(10) as numext , int as Cajones , int as axo_adeudo , int as mes_ini_adeudo , 
 money(14,2)as adeudo_anterior , money(14,2) as adeudo_vencido , money(14,2) as adeudo_recargos ;  
 --money(12,2) as adeudo_act ;

define  v_id  int;
define  v_categoria_id int; 
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_numesta int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_nombre varchar(100);
 
define v_calle varchar(80);
define v_numext varchar(10);
define v_cupo int;
define v_axo_adeudo int;
define v_mes_ini_adeudo int; 
define  v_adeudo_anterior money(14,2);
 define v_adeudo_vencido money(14,2);
define v_adeudo_recargos money(14,2);

--set debug file to 'pub.log';
--trace on;

foreach 
  select  a.id, 
     a.pubcategoria_id ,
     b.categoria,
     b.descripcion,
     a.numesta ,
     a.sector, 
    case when sector = 'J' then 'JUAREZ'  when sector = 'H' then 'HIDALGO'
     when sector = 'L' then 'LIBERTAD'  when sector = 'R' then 'REFORMA' else 'S/N' end ,
    trim(a.nombre) ,
    trim(a.calle) ,
    trim(a.numext) ,
    a.cupo, 
    (select min(d.axo) from pubadeudo d where d.pubmain_id = a.id and tipo = 10) ,
    (select min(d.mes) from pubadeudo d where d.pubmain_id = a.id and tipo = 10
     and axo = (select min(d.axo) from pubadeudo d where d.pubmain_id = a.id and tipo = 10) ) ,
 
    fn_pub_ade_ant(a.id) ,
    fn_pub_ade_act1( a.id )  ,
    fn_pub_recargos(2 , a.id, year(today) , month(today) )
  into 
  v_id ,
  v_categoria_id ,
  v_categoria ,
  v_descripcion ,
  v_numesta ,
  v_sector , 
  v_sectornom,
  v_nombre ,
  v_calle ,
  v_numext ,
   v_cupo ,
  v_axo_adeudo ,
  v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos
   from dbestacion:pubmain a, dbestacion:pubcategoria b 
    where  b.id =  a.pubcategoria_id and a.movto_cve <> 'C'  and (fn_pub_ade_ant(a.id) + fn_pub_ade_act1( a.id ) ) > 0


return   v_numesta , v_nombre , v_categoria , v_descripcion ,  v_sector , v_sectornom ,
  v_calle , v_numext , v_cupo , v_axo_adeudo , v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos with resume;

end foreach;
--trace off;
end procedure;

create procedure "informix".sp_exc_ade_men( v int) 
returning   int as no_exclusivo , varchar(80) as propiestario ,
   varchar(100) as domicilio , varchar(30)  as colonia , char(2) as Zona , decimal(6,2) as Total_bateria , decimal(6,2) as Total_Cordon,
  decimal(5,2) as Factor , varchar(50) as Clasificacion , 
  int as axo_adeudo , int as mes_ini_adeudo , 
 money(14,2)as adeudo_anterior , money(14,2) as adeudo_vencido , money(14,2) as adeudo_recargos ;  


define  v_id  int;
define  v_categoria_id int; 
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_no_exclusivo int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_propietario varchar(100);
 
define v_domicilio varchar(80);
define v_colonia varchar(20);
define v_zona char(2) ;
define v_total_bateria decimal(6,2) ; 
define v_total_cordon decimal(6,2) ; 
define  v_factor  decimal(5,2) ; 
define  v_clasificacion varchar(50);
define v_cupo int;
define v_axo_adeudo int;
define v_mes_ini_adeudo int; 
define  v_adeudo_anterior money(14,2);
 define v_adeudo_vencido money(14,2);
define v_adeudo_recargos money(14,2);



foreach 
select a.no_exclusivo , b.propietario, b.domicilio , b.colonia , a.zona, a.total_bateria, a.total_cordon, a.factor 
, c.concepto ,
fn_exc_axomin(a.id) , fn_exc_mesmin(a.id)  , 
fn_exc_ade_ant(a.id) ,
fn_exc_ade_act1(a.id)  
,fn_exc_recargos(2 , a.id , year(today) , month(today)) 
into 
 v_no_exclusivo , v_propietario, v_domicilio , v_colonia , v_zona, v_total_bateria, v_total_cordon, v_factor 
, v_clasificacion ,v_axo_adeudo ,
  v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos
from ex_contrato a, ex_propietario b , ex_clasificacion c 
where  a.ex_propietario_id  = b.id
and a.estatus <> 'C' and a.id_clasificacion in ( 1,3 ) and c.id = a.id_clasificacion
and (fn_exc_ade_ant(a.id) + fn_exc_ade_act1(a.id)) > 0 



return    v_no_exclusivo , v_propietario, v_domicilio , v_colonia , v_zona, v_total_bateria, v_total_cordon, v_factor 
, v_clasificacion , v_axo_adeudo ,  v_mes_ini_adeudo , 
  v_adeudo_anterior , v_adeudo_vencido , v_adeudo_recargos with resume;

end foreach;
--return 0 , 'Fin archivo', '' , '' ,'', 0, 0, 0, '' , 0 ,  0 ,   0 , 0 , 0;
end procedure;

CREATE PROCEDURE  "informix".admin_datos_varios_19(p_numesta int)
 returning  varchar(150) as sdato_vario;

define v_codigo int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(100);
define  v_calle varchar(100); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define adeudo int;
define  v_movto_cve char(1); 
define v_numext char(6);
define v_zona int;
define v_subzona int;
define v_numlic int;
define v_tipo char(1);
define v_ubicacion varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);

   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
      RETURN  'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   END EXCEPTION; 
let v_codigo = -1;
let  v_id  = 0; 
let v_numesta = 0;

let   v_descripcion = '' ;
let v_cupo =0;
let  v_movto_cve =''; 


select nvl(a.id,0) , a.numesta, a.zona, a.subzona, a.numlicencia,   b.descripcion , b.tipo, a.cupo , a.movto_cve , trim(a.calle) || ' No. ' || trim(a.numext)
into v_id , v_numesta, v_zona , v_subzona  , v_numlic,  v_descripcion , v_tipo , v_cupo , v_movto_cve , v_ubicacion
 from pubmain  a , pubcategoria b
where a.numesta = p_numesta and b.id = a.pubcategoria_id;


if v_id > 0 then
return v_tipo with resume;
return v_descripcion with resume;
return v_cupo with resume;
return v_numlic with resume;
return v_zona with resume;
return v_subzona with resume;
return v_ubicacion with resume;
return 'Segun art. 56 Fracc. II de la ley de Ingresos Municipal 2014' with resume;
else
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
return '' with resume;
end if;

END PROCEDURE;

CREATE PROCEDURE "informix".spd_delesta01sr(
		paraxo smallint,
                parfolio  integer,
		parPlaca char(7),
		parusuauto  integer,
                parOpcion  smallint
		)
returning smallint , varchar(100);		

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define v_id_usuario   int;
define v_r char(1);
define v_canti int;

                   
  ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if  v_lError = -236   THEN
       RETURN -3, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 


--set debug file to "Adminpred08";
--trace on;
  let v_r = 'N';
--set debug file to "c:\ivan.log";
--trace on;
 let varok = 0;
 let varobs = ''; 

   select count(*) into v_canti from   ta14_folios_adeudo 
       where axo = paraxo and folio = parfolio;
  if v_canti = 0 then
     return 1,'NO EXISTE ADEUDO' ;
  end if;
--opcion 22 y 23 Error de vigilante o falla de aparato.

if (paropcion = 22)  or (paropcion = 23)  then
    BEGIN WORK;
    let v_r = 'S';
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio 
     from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
     COMMIT WORK;	
     return 0,'Procedimiento Completo' ;

  else

 return 2,'Procedimiento no realizado' ;
  end if;
end procedure
;

create procedure "informix".pago_kio_cta(placa char(7) , idmedio int, importe money(5,2) , pconcepto char(60))

returning  int , char(2), int;

define varreca  int;
define varcaja  char(2);
define varoperacion int;
define concepto  char(60);

insert into kio_estacion_bita(placa,fecha, estatus, medio) values(placa , current,4,idmedio);	


 select id_rec , caja  into varreca , varcaja from db_ingresos:ta12_operacKiosco where id_usuario = idmedio; 


	select nvl(operacion,0) + 1
		into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;


let concepto = 'Pago de la impresion del estado de cuenta de la Placa: ' || placa;	
 
   insert into db_ingresos:ta_12_recibos (fecha ,  id_rec,  caja ,  operacion,  importe ,  cvepago ,  id_modulo,    nombre ,    concepto ,  
                                                    id_usuario ,  fecha_act, kio_num_terceros) 
                              values( today, varreca, varCaja, varOperacion, Importe, 'P' , 12, concepto,  concepto , idmedio, current, placa );


	update	db_ingresos:ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;
	

   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 ,        'Pago de la impresion '  ,   44480,  importe);
 

return 
varreca, varcaja, varoperacion ;

end procedure
;

create procedure "informix".kiosco_parkingliq(parplaca char(7), paraxoini int , parfolioini int , 
paraxohasta int, parfoliohasta int , parmedio int)
--transaccion , numfolios , axofinal,foliofinal, descrip , descripnot, idmedio, impactual, impanterior, impmulta, impredondeo
returning  int , int, char(250),char(200), int, money(12,2), money(12,2), money(12,2),money(4,2), int,int,int,int;

define v_idtrans int;
define v_nofol   int;
define v_descrip  char(250);
define v_descripnot char(200);
define v_impactual money(12,2);
define v_impanterior money(12,2);
define v_impMulta money(12,2);
define v_impredondeo money(4,2);
define v_axoactual int;
define v_folioinicial int;
define v_foliofinal int;
define contador int;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define vinfra int;
define dias_cuantos integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define v_tot money(12,2);
define v_totpag money(12,2);
define v_folionot char(20);
define v_axotrans int;
   define v_foliotrans int;

let parplaca = upper(parplaca);
let v_folioinicial = ((paraxoini * 1000000)+parfolioini) ;
let v_foliofinal = ((paraxohasta * 1000000)+parfoliohasta) ;

 
let contador = 0;
let v_impactual = 0;
let v_impanterior = 0;
let v_impmulta = 0;
let v_descrip = 'Folios:';
let v_descripnot = '';

foreach 

Select a.axo, a.folio,  b.tarifa, a.infraccion, a.fecha_folio ,nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio,  vtarifa ,vinfra,vfecha  ,vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal)
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 5 asc
 
if length(v_descrip) >=245 then 
   exit foreach;
end if;
   let v_axotrans = vaxo ;
   let v_foliotrans = vfolio;
let contador = contador +1;

let v_descrip = trim(v_descrip)|| vaxo || '-' ||vfolio||';';
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if weekday(vfecha) = 6 then
   let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;



--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
if year(today) = year(vfecha) then
   let v_impactual = v_impactual + vimp_apagar;
else
   let v_impanterior = v_impanterior + vimp_apagar;
end if;

end foreach;
let v_foliofinal = ((v_axotrans * 1000000)+ v_foliotrans) ;
foreach 
select noti.folionot into v_folionot
 from ta14_notifica_edo noti where noti.num_acuerdo in 
(select distinct a.num_acuerdo
from ta14_folios_adeudo a where  a.placa = parplaca and a.num_acuerdo > 0
 and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal))
 and noti.fechapago is null and noti.fechacancelado is null

 let v_descripnot = trim(v_descripnot)||' ' || trim(v_folionot);
 let v_impMulta = v_impMulta + 23;
end foreach;
--Consulta si existe el mismo dia una transaccion realizada con los mismos folios.
 if exists (select numtrans from ta14_kio_trans 
         where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador and
         impactual = v_impactual and impanterior = v_impanterior)  then
    select numtrans into v_idtrans from ta14_kio_trans 
             where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador 
               and impactual = v_impactual and impanterior = v_impanterior;
  else
   insert into ta14_kio_trans (
    numtrans ,    placa ,    foliosdescrip ,    notifdescrip ,
    axoini ,    folioini ,    axofin ,    foliofin ,    numfolios ,
    idmedio ,    impactual ,    impanterior,    impmulta , fecha , hora) 
  values(0,parplaca , v_descrip, v_descripnot , 
  paraxoini  , parfolioini  , v_axotrans , v_foliotrans , contador , parmedio
 , v_impactual , v_impanterior, v_impMulta, today, current hour to second);
   LET v_idtrans = dbinfo("sqlca.sqlerrd1");
  end if;
let v_tot = v_impactual +v_impanterior+ v_impMulta;
execute procedure redondeokiosco(v_tot) into v_totpag, v_impredondeo;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.
return  v_idtrans , contador, v_descrip  , v_descripnot ,parmedio, v_impactual , v_impanterior,
-- v_impMulta , v_impredondeo, 510900000, 925100001, 992100006 ,55080000;
   v_impMulta , v_impredondeo, 510900000, 510930000, 992100006  , 550800000;
end procedure;

create procedure "informix".kiosco_parkingliqx(parplaca char(7), paraxoini int , parfolioini int , 
paraxohasta int, parfoliohasta int , parmedio int)
--transaccion , numfolios , axofinal,foliofinal, descrip , descripnot, idmedio, impactual, impanterior, impmulta, impredondeo
returning  int , int, char(250),char(200), int, money(12,2), money(12,2), money(12,2),money(4,2), int,int,int,int;

define v_idtrans int;
define v_nofol   int;
define v_descrip  char(250);
define v_descripnot char(200);
define v_impactual money(12,2);
define v_impanterior money(12,2);
define v_impMulta money(12,2);
define v_impredondeo money(4,2);
define v_axoactual int;
define v_folioinicial int;
define v_foliofinal int;
define contador int;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define vinfra int;
define dias_cuantos integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define v_tot money(12,2);
define v_totpag money(12,2);
define v_folionot char(20);
define v_axotrans int;
   define v_foliotrans int;
define v_procesar int;

let parplaca = upper(parplaca);
let v_folioinicial = ((paraxoini * 1000000)+parfolioini) ;
let v_foliofinal = ((paraxohasta * 1000000)+parfoliohasta) ;

 
let contador = 0;
let v_impactual = 0;
let v_impanterior = 0;
let v_impmulta = 0;
let v_descrip = 'Folios:';
let v_descripnot = '';
let v_procesar = 1;

foreach 

Select a.axo, a.folio,  b.tarifa, a.infraccion, a.fecha_folio ,nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio,  vtarifa ,vinfra,vfecha  ,vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca 
-- and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal)
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 5 asc

if (v_procesar = 0) then 
   exit foreach;
end if;

--ultimo folio a procesar
if (((vaxo * 1000000)+vfolio) = v_foliofinal) then 
   let v_procesar = 0;
end if;


if length(v_descrip) >=245 then 
   exit foreach;
end if;
   let v_axotrans = vaxo ;
   let v_foliotrans = vfolio;
let contador = contador +1;

let v_descrip = trim(v_descrip)|| vaxo || '-' ||vfolio||';';
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if weekday(vfecha) = 6 then
   let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;



--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
if year(today) = year(vfecha) then
   let v_impactual = v_impactual + vimp_apagar;
else
   let v_impanterior = v_impanterior + vimp_apagar;
end if;


end foreach;
let v_foliofinal = ((v_axotrans * 1000000)+ v_foliotrans) ;
foreach 
select noti.folionot into v_folionot
 from ta14_notifica_edo noti where noti.num_acuerdo in 
(select distinct a.num_acuerdo
from ta14_folios_adeudo a where  a.placa = parplaca and a.num_acuerdo > 0
 and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal))
 and noti.fechapago is null and noti.fechacancelado is null

 let v_descripnot = trim(v_descripnot)||' ' || trim(v_folionot);
 let v_impMulta = v_impMulta + 23;
end foreach;
--Consulta si existe el mismo dia una transaccion realizada con los mismos folios.
 if exists (select numtrans from ta14_kio_trans 
         where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador and
         impactual = v_impactual and impanterior = v_impanterior)  then
    select numtrans into v_idtrans from ta14_kio_trans 
             where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador 
               and impactual = v_impactual and impanterior = v_impanterior;
  else
   insert into ta14_kio_trans (
    numtrans ,    placa ,    foliosdescrip ,    notifdescrip ,
    axoini ,    folioini ,    axofin ,    foliofin ,    numfolios ,
    idmedio ,    impactual ,    impanterior,    impmulta , fecha , hora) 
  values(0,parplaca , v_descrip, v_descripnot , 
  paraxoini  , parfolioini  , v_axotrans , v_foliotrans , contador , parmedio
 , v_impactual , v_impanterior, v_impMulta, today, current hour to second);
   LET v_idtrans = dbinfo("sqlca.sqlerrd1");
  end if;
let v_tot = v_impactual +v_impanterior+ v_impMulta;
execute procedure redondeokiosco(v_tot) into v_totpag, v_impredondeo;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.
return  v_idtrans , contador, v_descrip  , v_descripnot ,parmedio, v_impactual , v_impanterior,
-- v_impMulta , v_impredondeo, 510900000, 925100001, 992100006 ,55080000;
   v_impMulta , v_impredondeo, 510900000, 510930000, 992100006  , 550800000;
end procedure;

CREATE PROCEDURE "informix".admin_verif_cancela_16(
p_id_admin_pag integer,
p_folio_pag varchar(10),
p_usuario_canc varchar(10)
)
{######################################################################
#  Procedimiento:    admin_verif_cancela_16
#  Descripcion:      Interfaz de cancelacion del pago de folios de estacionometro en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            10 Febrero 2015   
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_CVECUENTA   int;
define v_cvepagorbo       CHAR(1);
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Estacionometros ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,rfcnumero,id_modulo,cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_CVECUENTA,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 14 then
   let v_leyenda = 'EL RECIBO NO ES POR ESTACIONOMETROS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

   let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
   let v_estatus = 0;
 


return v_estatus,v_leyenda;
--trace off;
END PROCEDURE
;

CREATE PROCEDURE "informix".admin_verif_cancela_19(
p_id_admin_pag integer,
p_folio_pag varchar(10),
p_usuario_canc varchar(10)
)
{######################################################################
#  Procedimiento:    admin_verif_cancela_19
#  Descripcion:      Interfaz de verificaicon de cancelacion del pago de estacionamientos publicos en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            10 Febrero 2015 
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_pubid   int;
define v_cvepagorbo       CHAR(1);
define v_axo int;
define v_mes int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);
--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Estacionamientos Publicos' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_pubid,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 24 then
   let v_leyenda = 'EL RECIBO NO ES POR ESTACIONAMIENTOS PUBLICOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

     
  let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
   let v_estatus = 0;


return v_estatus,v_leyenda;
--trace off;
END PROCEDURE
;

CREATE PROCEDURE "informix".admin_verif_cancela_23( p_id_admin_pag integer,
p_folio_pag varchar(10),p_usuario_canc varchar(10) )
{######################################################################
#  Procedimiento:    admin_verif_cancela_23
#  Descripcion:      Interfaz de verificaicon de cancelacion del pago de estacionamientos exclusivo en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            10 Febrero 2015  
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_pubid   int;
define v_cvepagorbo       CHAR(1);
define v_axo int;
define v_mes int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);
define v_res2 int ; define v_res3 varchar(50);
define v_placa char(1); define v_baliza char(1);
define v_tipo int; define v_no_exclusivo int;
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
    -- ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Estacionamientos Exclusivos' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja, id_regmodulo, rfcnumero ,id_modulo, cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag , v_pubid, v_no_exclusivo ,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;
if v_fecha_pag <> today then
   let v_leyenda = 'EL RECIBO NO SE CANCELA POR SER DE OTRO DIA';
   let v_estatus = 4;
   RETURN v_estatus,v_leyenda;
end if;


if v_id_modulo <> 28 then
   let v_leyenda = 'EL RECIBO NO ES POR ESTACIONAMIENTOS EXCLUSIVOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

   let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
   let v_estatus = 0;


return v_estatus,v_leyenda;
--trace off;
END PROCEDURE
;

CREATE PROCEDURE "informix".admin_verif_cancela_26( p_id_admin_pag integer,
p_folio_pag varchar(10),p_usuario_canc varchar(10) )
{######################################################################
#  Procedimiento:    admin_verif_cancela_26
#  Descripcion:      Interfaz de cancelacion del pago de calcomanias en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            10 Febrero 2015
#
#  Llamado por:      Procedimiento sp_verif_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_pubid   int;
define v_cvepagorbo       CHAR(1);
define v_axo int;
define v_mes int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);
define v_res2 int ; define v_res3 varchar(50);
define v_placa char(1); define v_baliza char(1);
define v_tipo int; define v_no_exclusivo int;
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
   --  ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Pago de Calcomania' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where fecha = today and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'CANCELACION REALIZADA, no recibo';
   let v_estatus = 0;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja, id_regmodulo, rfcnumero ,id_modulo, cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag , v_pubid, v_no_exclusivo ,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where fecha = today and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;
if v_fecha_pag <> today then
   let v_leyenda = 'EL RECIBO NO SE CANCELA POR SER DE OTRO DIA';
   let v_estatus = 4;
   RETURN v_estatus,v_leyenda;
end if;


if v_id_modulo <> 14 then
   let v_leyenda = 'EL RECIBO NO ES POR PAGO DE CALCOMANIA';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

   let v_leyenda = 'PROCEDE CANCELACION DEL RECIBO';
   let v_estatus = 0;
 


return v_estatus,v_leyenda;
--trace off;
END PROCEDURE
;

create procedure "informix".kiosco_parkingliqy(parplaca char(7), paraxoini int , parfolioini int , 
paraxohasta int, parfoliohasta int , parmedio int)
--transaccion , numfolios , axofinal,foliofinal, descrip , descripnot, idmedio, impactual, impanterior, impmulta, impredondeo
returning  int , int, char(250),char(200), int, money(12,2), money(12,2), money(12,2),money(4,2), int,int,int,int;

define v_idtrans int;
define v_nofol   int;
define v_descrip  char(250);
define v_descripnot char(200);
define v_impactual money(12,2);
define v_impanterior money(12,2);
define v_impMulta money(12,2);
define v_impredondeo money(4,2);
define v_axoactual int;
define v_folioinicial int;
define v_foliofinal int;
define contador int;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define vinfra int;
define dias_cuantos integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define v_tot money(12,2);
define v_totpag money(12,2);
define v_folionot char(20);
define v_axotrans int;
   define v_foliotrans int;
define v_procesar int;
define v_dettrans int;

let parplaca = upper(parplaca);
let v_folioinicial = ((paraxoini * 1000000)+parfolioini) ;
let v_foliofinal = ((paraxohasta * 1000000)+parfoliohasta) ;

 
let contador = 0;
let v_impactual = 0;
let v_impanterior = 0;
let v_impmulta = 0;
let v_descrip = 'Folios:';
let v_descripnot = '';
let v_procesar = 1;

foreach 

Select a.axo, a.folio,  b.tarifa, a.infraccion, a.fecha_folio ,nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio,  vtarifa ,vinfra,vfecha  ,vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca 
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 5 asc

if (v_procesar = 0) then 
   exit foreach;
end if;

--ultimo folio a procesar
if (((vaxo * 1000000)+vfolio) = v_foliofinal) then 
   let v_procesar = 0;
end if;


if length(v_descrip) >=245 then 
   exit foreach;
end if;
   let v_axotrans = vaxo ;
   let v_foliotrans = vfolio;
let contador = contador +1;

let v_descrip = trim(v_descrip)|| vaxo || '-' ||vfolio||';';
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if weekday(vfecha) = 6 then
   let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;



--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
if year(today) = year(vfecha) then
   let v_impactual = v_impactual + vimp_apagar;
else
   let v_impanterior = v_impanterior + vimp_apagar;
end if;


end foreach;
let v_foliofinal = ((v_axotrans * 1000000)+ v_foliotrans) ;
foreach 
select noti.folionot into v_folionot
 from ta14_notifica_edo noti where noti.num_acuerdo in 
(select distinct a.num_acuerdo
from ta14_folios_adeudo a where  a.placa = parplaca and a.num_acuerdo > 0
 and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal))
 and noti.fechapago is null and noti.fechacancelado is null

 let v_descripnot = trim(v_descripnot)||' ' || trim(v_folionot);
 let v_impMulta = v_impMulta + 23;
end foreach;
--Consulta si existe el mismo dia una transaccion realizada con los mismos folios.
 if exists (select numtrans from ta14_kio_trans 
         where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador and
         impactual = v_impactual and impanterior = v_impanterior)  then
    select numtrans into v_idtrans from ta14_kio_trans 
             where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador 
               and impactual = v_impactual and impanterior = v_impanterior;
  else
   insert into ta14_kio_trans (
    numtrans ,    placa ,    foliosdescrip ,    notifdescrip ,
    axoini ,    folioini ,    axofin ,    foliofin ,    numfolios ,
    idmedio ,    impactual ,    impanterior,    impmulta , fecha , hora) 
  values(0,parplaca , v_descrip, v_descripnot , 
  paraxoini  , parfolioini  , v_axotrans , v_foliotrans , contador , parmedio
 , v_impactual , v_impanterior, v_impMulta, today, current hour to second);
   LET v_idtrans = dbinfo("sqlca.sqlerrd1");
  end if;
let v_tot = v_impactual +v_impanterior+ v_impMulta;

-- Graba los detalles
 let v_procesar = 1;
 select count(*) into v_dettrans from ta14_kio_transdet where id_kio_trans = v_idtrans;
  if v_dettrans = 0 then
   foreach 

Select a.axo, a.folio,  a.fecha_folio
into vaxo, vfolio,  vfecha
from ta14_folios_adeudo a
where a.placa = parplaca 
order by 3 asc

if (v_procesar = 0) then 
   exit foreach;
end if;

--ultimo folio a procesar
if (((vaxo * 1000000)+vfolio) = v_foliofinal) then 
   let v_procesar = 0;
end if;
   insert into ta14_kio_transdet values ( 0 , v_idtrans , vaxo, vfolio);
end foreach;
end if;
--


execute procedure redondeokiosco(v_tot) into v_totpag, v_impredondeo;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.
return  v_idtrans , contador, v_descrip  , v_descripnot ,parmedio, v_impactual , v_impanterior,
-- v_impMulta , v_impredondeo, 510900000, 925100001, 992100006 ,55080000;
   v_impMulta , v_impredondeo, 510900000, 510930000, 992100006  , 550800000;
end procedure;

create procedure "informix".spd14_placas_adeudo ( parrango01 int , parrango02 int)
   returning char(7) as placa , int as folios , money(16,2) as adeudo;
define vplaca char(7) ;
define vfolios int;
define vadeudo money(16,2);
foreach 
select f.placa , count(f.folio) , sum(t.tarifa + t.costo_fijo01) 
into vplaca , vfolios , vadeudo 
from ta14_folios_adeudo f , ta14_tarifas t
 where f.axo > 2009 and f.infraccion = t.num_clave and f.fecha_folio between t.fecha_inicial and t.fecha_fin
group by 1 having count(f.folio) between parrango01 and parrango02

return  vplaca , vfolios , vadeudo  with resume;
end foreach;
end procedure
;

create procedure "pgmoreno".cons14_detalle (pOrigen char(2), p_opc int, p_id int, p_axof int, p_mesf int  )
returning   varchar(50) as concepto, 
		int as axo, 
		int as mes, 
		money(12,2) as adeudo, 
		money(12,2) as descto_adeudo,
		money(10,2) as recargos, 
		money(10,2) as descto_recgos, 
		int as tipo, 
		int as id_adeudo;

define axovig,mesvig,diavig  int; 
define perio  int ; 
define v_porcentaje decimal(5,2);
define perioI int; 
define v_recargos money(10,2); 
define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_adeudo, v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);

define v_id_adeudo int;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

if p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

if p_opc = 3 then
	let axovig = year(today) ;
	let mesvig = 12;
end if;

let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;

let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_id and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
  
let v_adeudo = 0;
let v_descto_adeudo = 0;
let v_recargos = 0;
let v_descto_recgos = 0;

if pOrigen = 'PU' then  -- inicio estacionamientos publicos
	FOREACH
	select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe, id 
   	into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo, v_id_adeudo
  	from pubadeudo where pubmain_id = p_id  and  (axo * 100 + mes) <= perio 
  	order by 1,2,3

	LET v_porc_recgos = 0;
   	select porcentaje into v_porc_recgos from pub_descrec where pubmain_id = p_id and ((v_axo * 100)+v_mes) between 
    		((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
	
   		let v_descto_recgos = 0;
   		if v_porc_recgos is null then
     			let v_porc_recgos = 0;
   		end if;

   	if v_tipo = 10 then
   		select sum(porcentaje_mes) into v_porcentaje from recargos
     		where (axo * 100 + mes) between  perioI and per_recgos;

    		let v_recargos = (v_porcentaje * v_adeudo ) / 100;

    		if v_recargos is null then
       			let v_recargos = 0;
    		end if;

        	if v_porc_recgos > 0 and v_recargos > 0 then -- calcular descuento en recargos.
       			let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
    		end if;

   		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   	else
   		let v_recargos = 0;
   		let v_concepto = v_concepto1 || '  ' || v_adeudo;
    	end if;

	RETURN v_concepto, v_axo, v_mes,  v_adeudo, v_descto_adeudo, v_recargos, v_descto_recgos, v_tipo, v_id_adeudo with resume;
	END FOREACH
end if;

if pOrigen = 'EX' then  -- inicio estacionamientos exclusivos
  	FOREACH
  	select case when tipo <> 20 then axo || '00' else axo || lpad(mes,2,'0') end ,tipo , Axo, mes, (axo  * 100 )+ mes , 
    		concepto, ade_importe , id 
   	into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo , v_id_adeudo
  	from ex_adeudo where ex_contrato_id = p_id  and  (axo * 100 + mes) <= perio 
  	order by 1,3,4

   	select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_id and ((v_axo * 100)+v_mes) between 
    		((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';

   		let v_descto_recgos = 0;
   		if v_porc_recgos is null then
     			let v_porc_recgos = 0;
   		end if;

	if v_tipo = 20 then
   		select sum(porcentaje_mes) into v_porcentaje from recargos
     		where (axo * 100 + mes) between  perioI and per_recgos;
          
		if v_calrec = 0 then
     			let v_porcentaje = 0;
      		end if;

    		let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       		if v_recargos is null then
        		let v_recargos = 0;
       		end if;

        	if v_porc_recgos > 0 and v_recargos > 0 then -- calcular descuento en recargos.
       			let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       			--let v_recargos =   v_recargos - v_descto_recgos;
    		end if;
   
   		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
	else
		let v_recargos = 0;
   		let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
	end if;

	if (v_tipo = 26) or (v_tipo = 27) then
     		execute procedure fn_exc_calcrecgos_ref( p_id , v_axo , v_mes) into v_recgos_ref;
     		let v_recargos =   v_recargos + v_recgos_ref;
	end if;

	RETURN v_concepto, v_axo, v_mes,  v_adeudo, v_descto_adeudo, v_recargos, v_descto_recgos, v_tipo, v_id_adeudo with resume;

  	END FOREACH;
end if;

end procedure;

create procedure "informix".visor_publicos()
returning 
int as numesta, int as numlicencia, varchar(60) as calle,  varchar(15) as numext, varchar(15) as telefono , int as cajones 
 , date as fecha_inicial,  int as movtos_no , varchar(11) as cvecatnva;
define v_numesta int; define  v_numlicencia int ; define v_axolicencias int;
define v_calle varchar(60) ; define  v_numext varchar(15); define  v_telefono varchar(15); define v_cupo int;
define  v_fecha_inicial date ; define   v_movtos_no int ; define  v_cvecatnva varchar(11);

foreach
select   p.numesta,   p.numlicencia, p.axolicencias, p.calle, p.numext, p.telefono , p.cupo 
 , p.fecha_inicial,  p.movtos_no , c.cvecatnva
 into v_numesta,   v_numlicencia, v_axolicencias, v_calle, v_numext, v_telefono , v_cupo 
 , v_fecha_inicial,  v_movtos_no , v_cvecatnva
from pubmain p, catastro_gdl:convcta c where p.cvecuenta > 0 and p.movto_cve <> 'C' and p.cvecuenta = c.cvecuenta

return v_numesta,   v_numlicencia, v_calle, v_numext, v_telefono , v_cupo 
 , v_fecha_inicial,  v_movtos_no , v_cvecatnva with resume;


  end foreach;
end procedure;

create procedure "pgmoreno".cons14_foliosfisc ( par_placa char(7) )

		returning  varchar(7) as placa,
			int as Axo,
			int as Folio,
			Date as fechaFolio,
			int as Infraccion,
			Money(12,2) as importe;

define v_placa				varchar(7);
define v_Axo, v_Folio, v_Infraccion	int;
define v_fechaFolio			date; 
define v_importe			Money(12,2);

  FOREACH

	SELECT a.placa, a.axo, a.folio, a.fecha_folio, a.infraccion, (b.tarifa + b.costo_fijo01) importe
	INTO v_placa, v_axo, v_folio, v_fechaFolio, v_infraccion, v_importe
	FROM ta14_folios_adeudo a, ta14_tarifas b
	WHERE a.placa = par_placa 
	AND b.num_clave = a.infraccion AND b.fecha_fin = mdy(12,31,a.axo)
	ORDER BY a.axo, a.folio

	return v_placa, v_axo, v_folio, v_fechaFolio, v_infraccion, v_importe  with resume;

  END FOREACH

end procedure;

create procedure "pgmoreno".act_axo_folios ( p_fecini date, p_fecfin date )
returning  int as status,  
	varchar(50) as mensaje,
	int as axo,
	int as folio;
 
define v_status 			int; 
define v_mensaje 			varchar(255);
define v_axo_ant, v_axo_nvo, v_folio	int;
define v_fechafolio			Date;

Let v_status = 0;
Let v_mensaje = '';

	FOREACH
  	SELECT fecha_folio, axo, folio  into v_fechafolio, v_axo_ant, v_folio
	FROM ta14_folios_adeudo WHERE fecha_folio BETWEEN p_fecini and p_fecfin

		let v_axo_nvo = year(v_fechafolio);
		if v_axo_nvo <> v_axo_ant then
			if exists( SELECT * FROM ta14_folios_adeudo WHERE axo = v_axo_nvo and folio = v_folio ) then
				--DELETE FROM ta14_folios_adeudo WHERE axo = v_axo_ant and folio = v_folio;
				Let v_status = 0;
				Let v_mensaje = 'se eliminara el folio del control ';
				RETURN v_status, v_mensaje, v_axo_ant, v_folio with resume;
			else
				--update ta14_folios_adeudo set
				--	axo = v_axo_nvo   where axo = v_axo_ant and folio = v_folio;
				Let v_status = 0;
				Let v_mensaje = 'se actualiza el a�o del control ';
				RETURN v_status, v_mensaje, v_axo_ant, v_folio with resume;
			end if;
		else
			Let v_status = 0;
			Let v_mensaje = 'NO se actualiza el a�o del control ';
			RETURN v_status, v_mensaje, v_axo_ant, v_folio with resume;
		end if;

	END FOREACH

end procedure;

create procedure "informix".fn_pub_ade_ant( p_contrato_id int , p_axo int ) 
returning  money(12,2) as adeudo ;
 define v_adeudo money(12,2)     ;

 select sum(c.ade_importe)  into v_adeudo  from pubadeudo c
 where c.pubmain_id = p_contrato_id and axo = p_axo;

 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_pub_ade_axo( p_contrato_id int , p_axo int ) 
returning  money(12,2) as adeudo ;
 define v_adeudo money(12,2)     ;

 select sum(c.ade_importe)  into v_adeudo  from pubadeudo c
 where c.pubmain_id = p_contrato_id and axo = p_axo;

 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 return v_adeudo ;
END PROCEDURE;

create procedure "informix".fn_pub_recargos_axo( p_pubid int, p_axo_adeudo int   )
returning    money(10,2) as recargos;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define tot_recgos money(10,2);
let tot_recgos = 0;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;


let axovig = year(today) ;
let mesvig = 12;

let perio = (axovig *100 )+mesvig;
  FOREACH
  select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
   into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  axo = p_axo_adeudo and mes between 1 and 12
  order by 1,2,3
   if v_tipo = 10 then
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_recargos is null then
       let v_recargos = 0;
    end if;
  -- let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
 -- let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
 let tot_recgos = tot_recgos + v_recargos;

end foreach;
return  tot_recgos ;
end procedure;

create procedure "pgmoreno".sp14_pub_upd_actas ( par_Num integer, par_dep integer, par_axoacta integer, par_NumActa integer )

	Returning   int as estatus,
            varchar(255) as mensaje

define v_status                       	int;
define v_mensaje                      	varchar(255);

define v_id				int;
define v_resultado			int;
define v_id_multa			int;

Let v_status  = 0;
Let v_mensaje = 'ACTA GRABADA CORRECTAMENTE';

Let v_id = 0;
Let v_resultado = 0;
Let v_id_multa = 0;

if exists( SELECT * FROM pubmain WHERE numesta = par_Num ) then
    SELECT id  INTO v_id FROM pubmain WHERE numesta = par_Num;

	if exists( select * from catastro_gdl:multas
     		where id_dependencia = par_dep and axo_acta = par_AxoActa and num_acta = par_NumActa
		AND cvepago is Null AND fecha_cancelacion is Null AND id_prescri is Null ) then

		select id_multa INTO v_id_multa from catastro_gdl:multas
     		where id_dependencia = par_dep and axo_acta = par_AxoActa and num_acta = par_NumActa
		AND cvepago is Null AND fecha_cancelacion is Null AND id_prescri is Null;

		if not exists( select * from pub_rel_multas
     			where id_multa = v_id_multa AND id_dependencia = par_dep and axo_acta = par_AxoActa and num_acta = par_NumActa ) then
			
				INSERT INTO pub_rel_multas values ( v_id_multa, par_dep, par_AxoActa, par_NumActa, v_id, 'V' );
		else
			Let v_status = -1;
			Let v_mensaje = 'Ya existe el Acta en Relacion de Actas '||par_axoacta||'-'||par_NumActa;
		end if;

	else
		Let v_status = -1;
		Let v_mensaje = 'No Existe el Acta '||par_axoacta||'-'||par_NumActa;
	end if;

else
	Let v_status = -1;
	Let v_mensaje = 'No Existe el Exclusivo '||par_Num;
end if;

  return v_status,v_mensaje  with resume;

end procedure;

create procedure "pgmoreno".cons14_detalle2 ( pOrigen char(2), p_opc int, p_id int, p_axof int, p_mesf int )

	Returning   char(7) as Primer_Adeudo,
		char(20) as Anual_Adeudo,
		money(12,2) as Derechos,
		money(12,2) as Recargos;


define v_id, v_numesta, v_pubcategoria_id, v_cupo	int;
define V_nombre, V_calle				char(100);
define V_numext						char(6); 
define V_categoria					char(20);
define V_sector						char(1);
define agrupar char(6);
define v_concepto1 varchar(40);
define v_id_adeudo int;
define v_calrec int;
define v_recgos_ref  money(10,2);

define Axo_ciclo, contador, aso_proceso, aso_actual	int;

define axovig, mesvig, v_porc_recgos, v_porcentaje, v_tipo		int;
define v_descto_recgos, v_recargos, v_adeudo				money(12,2); 
define v_Tot_adeudo, v_Tot_recargos, v_Tot_descto_recgos		money(12,2);
define v_axo int ;define v_mes, v_mesp int;  define per_recgos int;    define v_concepto varchar(50) ;
define perioI, perio int;
define v_fecha_limite date;
define v_Derechos_anual, v_Recargos_anual, v_Refrendo_anual, v_RefrendoRcgo_anual	money(12,2);

Let v_Refrendo_anual = 0;
Let v_RefrendoRcgo_anual = 0;
Let v_Derechos_anual = 0;
Let v_Recargos_anual = 0;

Let agrupar = '';
Let v_concepto1 = '';
Let v_id_adeudo = 0;
Let v_calrec = 0;
Let v_recgos_ref = 0;

Let v_Tot_adeudo = 0;
Let v_Tot_recargos = 0;
Let v_Tot_descto_recgos = 0;

Let v_adeudo = 0;
Let v_recargos = 0;
Let v_porc_recgos = 0;
Let v_descto_recgos = 0;
Let v_porcentaje = 0;
Let contador = 0;

if p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

if p_opc = 3 then
	let axovig = year(today) ;
	let mesvig = 12;
end if;

let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;

let per_recgos =  (axovig *100 )+mesvig;
Let v_mesp = 0;

if pOrigen = 'PU' then
	FOREACH
	SELECT tipo , Axo, mes, (axo  * 100 )+ mes , ade_importe
   	INTO v_tipo,  v_axo , v_mes , perioI , v_adeudo
  	FROM pubadeudo where pubmain_id = p_id  and Axo = p_axof and (axo * 100 + mes) <= perio 
  	order by 1,2,3

	if v_mesp = 0 then
		Let v_mesp = v_mes;
	end if;
	Let v_porc_recgos = 0;
   	SELECT porcentaje INTO v_porc_recgos FROM pub_descrec 
	WHERE pubmain_id = p_id AND ((v_axo * 100)+v_mes) BETWEEN ((axoinicio * 100)+ mesinicio) AND ((axofin * 100)+mesfin) 
	AND vigencia = 'V';
	
	Let v_descto_recgos = 0;
   	if v_porc_recgos is null then
     		Let v_porc_recgos = 0;
   	end if;

	if v_tipo = 10 then
		Let v_recargos = 0;
		Let v_porcentaje = 0;
   		SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
     		WHERE (axo * 100 + mes) BETWEEN perioI AND per_recgos;

		Let v_recargos = (v_porcentaje * v_adeudo ) / 100;

		if v_recargos is null then
       			Let v_recargos = 0;
    		end if;

		if v_porc_recgos > 0 and v_recargos > 0 then -- calcular descuento en recargos.
       			Let  v_descto_recgos = ( v_recargos * v_porc_recgos ) / 100;
    		end if;
    	end if;

	Let v_Tot_adeudo = v_Tot_adeudo + v_adeudo;
	Let v_Tot_recargos = v_Tot_recargos + v_recargos;
	Let v_Tot_descto_recgos = v_Tot_descto_recgos + v_descto_recgos;

	Let v_adeudo = 0;
	Let v_recargos = 0;
	Let v_descto_recgos = 0;
	Let v_porcentaje = 0;
				
	END FOREACH;
				
	if (v_Tot_adeudo > 0) or (v_Tot_recargos > 0) then
		RETURN v_axo||'-'||v_mesp, 'Adeudo del '||p_axof, v_Tot_adeudo, ( v_Tot_recargos - v_Tot_descto_recgos ) with resume;	
	end if;
end if;

if pOrigen = 'EX' then  -- inicio estacionamientos exclusivos
  	FOREACH
  	select case when tipo <> 20 then axo || '00' else axo || lpad(mes,2,'0') end ,tipo , Axo, mes, (axo  * 100 )+ mes , 
    		concepto, ade_importe , id 
   	into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo , v_id_adeudo
  	from ex_adeudo where ex_contrato_id = p_id  and  (axo * 100 + mes) <= perio and tipo = 20
  	order by 1,3,4

	if v_mesp = 0 then
		Let v_mesp = v_mes;
	end if;

   	select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_id and ((v_axo * 100)+v_mes) between 
    		((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';

   		Let v_descto_recgos = 0;
   		if v_porc_recgos is null then
     			Let v_porc_recgos = 0;
   		end if;

	if (v_tipo = 20) then
   		select sum(porcentaje_mes) into v_porcentaje from recargos
     		where (axo * 100 + mes) between  perioI and per_recgos;
          
		--if v_calrec = 0 then
     		--	let v_porcentaje = 0;
      		--end if;

    		Let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       		if v_recargos is null then
        			Let v_recargos = 0;
       		end if;

        	if v_porc_recgos > 0 and v_recargos > 0 then -- calcular descuento en recargos.
       			let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       			--let v_recargos =   v_recargos - v_descto_recgos;
    		end if;
   
   		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
	else
		let v_recargos = 0;
   		let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
	end if;

	if (v_tipo = 26) or (v_tipo = 27) then
     		execute procedure fn_exc_calcrecgos_ref( p_id , v_axo , v_mes) into v_recgos_ref;
     		let v_recargos =   v_recargos + v_recgos_ref;
	end if;

		Let v_Tot_adeudo = v_Tot_adeudo + v_adeudo;
		Let v_Tot_recargos = v_Tot_recargos + v_recargos;
		Let v_Tot_descto_recgos = v_Tot_descto_recgos + v_descto_recgos;

	Let v_adeudo = 0;
	Let v_recargos = 0;
	Let v_descto_recgos = 0;
	Let v_porcentaje = 0;
				
	END FOREACH;
				
	if (v_Tot_adeudo > 0) or (v_Tot_recargos > 0) then
		RETURN v_axo||'-'||v_mesp, 'Adeudo del '||p_axof, 
		v_Tot_adeudo, ( v_Tot_recargos - v_Tot_descto_recgos ) with resume;	
	end if;
	
	Let v_Tot_adeudo = 0;
	Let v_Tot_recargos = 0;
	Let v_Tot_descto_recgos = 0;
	Let v_Refrendo_anual = 0;
	Let v_RefrendoRcgo_anual = 0;
end if;

end procedure;

create procedure "pgmoreno".cons14_detallepapa ( pOrigen char(2), p_opc int, p_axof int, p_mesf int )

	Returning   int as Numero_Esta,
		varchar(100) as Nombre_Esta,
		varchar(100) as Calle_Esta,
		char(5) as Zona,
		char(100) as Categoria_Esta,
		char(100) as Cupo_Esta,
		char(7) as Primer_Adeudo,
		char(20) as Anual_Adeudo,
		money(12,2) as Derechos,
		money(12,2) as Recargos;


define v_id, v_numesta, v_pubcategoria_id	int;
define V_nombre, V_calle				char(100);
define V_numext						char(6); 
define V_categoria, V_cupo					char(50);
define V_sector						char(1);
define V_zona						char(5);
define Axo_ciclo, contador, aso_proceso, aso_actual	int;

define axovig, mesvig, v_porc_recgos, v_porcentaje, v_tipo		int;
define v_descto_recgos, v_recargos, v_adeudo				money(12,2); 
define v_Tot_adeudo, v_Tot_recargos, v_Tot_descto_recgos		money(12,2);
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
define perioI, perio int;
define v_fecha_limite date;

DEFINE v_Primer_Adeudo	char(7);
define v_concepto_anual	char(20);
define v_Derechos_anual, v_Recargos_anual, v_Regrendo_anual, v_RefrendoRcgo_anual	money(12,2);
define v_trampa		char(2);

Let V_zona = '';
Let v_Primer_Adeudo = '';
Let v_concepto_anual = '';
Let v_Regrendo_anual = 0;
Let v_RefrendoRcgo_anual = 0;
Let v_Derechos_anual = 0;
Let v_Recargos_anual = 0;
Let v_trampa = 'No';

Let v_Tot_adeudo = 0;
Let v_Tot_recargos = 0;
Let v_Tot_descto_recgos = 0;

Let v_adeudo = 0;
Let v_recargos = 0;
Let v_descto_recgos = 0;
Let v_porcentaje = 0;
Let contador = 0;

if p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

if p_opc = 3 then
	let axovig = year(today) ;
	let mesvig = 12;
end if;

let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;

let per_recgos =  (axovig *100 )+mesvig;

if pOrigen = 'PU' then
FOREACH
	SELECT a.id,  a.numesta, a.nombre, a.calle, a.numext, b.descripcion, sector, cupo
	INTO V_id, V_numesta, V_nombre, V_calle, V_numext, V_categoria, V_sector, V_cupo    
	FROM pubmain a, pubcategoria b
	WHERE b.id = a.pubcategoria_id ORDER BY a.numesta

	RETURN V_numesta, Trim(V_nombre), Trim(V_calle) || ' ' || Trim(V_numext) || ' Sector  ' || V_sector, Null, Trim(V_categoria), Trim(V_cupo), 
		Null, Null, Null, Null with resume;
	
		SELECT Min(axo) INTO Axo_ciclo FROM pubadeudo WHERE pubmain_id = V_id;
		if Axo_ciclo is Null then
				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;
		else
			Let aso_proceso = 0;
  			Let aso_actual = p_axof;
			Let contador = 0;
			
  			FOR aso_proceso = Axo_ciclo to aso_actual
				
				FOREACH
				EXECUTE procedure cons14_detalle2 ( pOrigen, p_opc, V_id, aso_proceso, p_mesf )
						INTO v_Primer_Adeudo, v_concepto_anual, 
						v_Derechos_anual, v_Recargos_anual
				
				END FOREACH;				

				if ( v_Derechos_anual > 0) or ( v_Recargos_anual > 0) then
					RETURN Null, Null, Null, Null, Null, Null, 
						v_Primer_Adeudo, v_concepto_anual, 
						v_Derechos_anual, v_Recargos_anual with resume;
				end if;

				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

			END FOR;
		end if;
END FOREACH;
end if;

if pOrigen = 'EX' then
FOREACH
	SELECT a.id, a.no_exclusivo, Trim(b.propietario), Trim(b.domicilio), Trim(a.zona), 'Bateria '|| a.total_bateria || '  Cordon ' || a.total_cordon  
	INTO V_id, V_numesta, V_nombre, V_calle, V_zona, V_cupo    	
	FROM ex_contrato a, ex_propietario b
	WHERE b.id = a.ex_propietario_id and no_exclusivo > 1
	ORDER BY a.no_exclusivo

	RETURN V_numesta, Trim(V_nombre), Trim(V_calle), Trim(V_zona), Null, Trim(V_cupo), 
		Null, Null, Null, Null with resume;

		SELECT Min(axo) INTO Axo_ciclo FROM ex_adeudo WHERE ex_contrato_id = V_id;
		if Axo_ciclo is Null then
				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;
		else
			Let aso_proceso = 0;
  			Let aso_actual = p_axof;
			Let contador = 0;

			FOR aso_proceso = Axo_ciclo to aso_actual
				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;
				
				FOREACH
				EXECUTE procedure cons14_detalle2 ( pOrigen, p_opc, V_id, aso_proceso, p_mesf )
						INTO v_Primer_Adeudo, v_concepto_anual, 
						v_Derechos_anual, v_Recargos_anual
				
				END FOREACH;				

				if ( v_Derechos_anual > 0) or ( v_Recargos_anual > 0) then
					RETURN Null, Null, Null, Null, Null, Null, 
						v_Primer_Adeudo, v_concepto_anual, 
						v_Derechos_anual, v_Recargos_anual with resume;
				end if;

				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

			END FOR;
		end if;
END FOREACH;
end if;

end procedure;

create procedure "pgmoreno".cons14_detallepapa2 ( pOrigen char(2), p_opc int, p_axof int, p_mesf int )

	Returning   int as Numero_Esta,
		varchar(100) as Nombre_Esta,
		varchar(100) as Calle_Esta,
		char(5) as Zona,
		char(100) as Categoria_Esta,
		char(100) as Cupo_Esta,
		varchar(50) as Concepto,
		int as axo_adeudo,
		int as mes_adeudo,
		money(12,2) as Adeudo,
		money(12,2) as Recargo;

define vd_concepto 						varchar(50);
define vd_axo, vd_mes, vd_tipo, vd_id_adeudo				int;
define vd_adeudo, vd_dscto_adeudo, vd_rgs, vd_dscto_rcgs		money(12,2);
define vd20_adeudo, vd20_dscto_adeudo, vd20_rgs, vd20_dscto_rcgs	money(12,2);
define vd26_adeudo, vd26_dscto_adeudo, vd26_rgs, vd26_dscto_rcgs	money(12,2);
define contador							int;

define v_id, v_numesta, v_pubcategoria_id	int;
define V_nombre, V_calle				char(100);
define V_numext						char(6); 
define V_categoria, V_cupo					char(50);
define V_sector						char(1);
define V_zona						char(5);
define Axo_ciclo, aso_proceso, aso_actual	int;

define axovig, mesvig, v_porc_recgos, v_porcentaje, v_tipo		int;
define v_descto_recgos, v_recargos, v_adeudo				money(12,2); 
define v_Tot_adeudo, v_Tot_recargos, v_Tot_descto_recgos		money(12,2);
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
define perioI, perio int;
define v_fecha_limite date;

DEFINE v_Primer_Adeudo	char(7);
define v_concepto_anual	char(20);
define v_Derechos_anual, v_Recargos_anual, v_Regrendo_anual, v_RefrendoRcgo_anual	money(12,2);
define v_trampa		char(2);

Let V_zona = '';
Let v_Primer_Adeudo = '';
Let v_concepto_anual = '';
Let v_Regrendo_anual = 0;
Let v_RefrendoRcgo_anual = 0;
Let v_Derechos_anual = 0;
Let v_Recargos_anual = 0;
Let v_trampa = 'No';

Let v_Tot_adeudo = 0;
Let v_Tot_recargos = 0;
Let v_Tot_descto_recgos = 0;

Let v_adeudo = 0;
Let v_recargos = 0;
Let v_descto_recgos = 0;
Let v_porcentaje = 0;
Let contador = 0;

if p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

if p_opc = 3 then
	let axovig = year(today) ;
	let mesvig = 12;
end if;

let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;

let per_recgos =  (axovig *100 )+mesvig;

if pOrigen = 'EX' then
FOREACH
	SELECT a.id, a.no_exclusivo, Trim(b.propietario), Trim(b.domicilio), Trim(a.zona), 'Bateria '|| a.total_bateria || '  Cordon ' || a.total_cordon  
	INTO V_id, V_numesta, V_nombre, V_calle, V_zona, V_cupo    	
	FROM ex_contrato a, ex_propietario b
	WHERE b.id = a.ex_propietario_id and no_exclusivo > 1
	ORDER BY a.no_exclusivo

	RETURN V_numesta, Trim(V_nombre), Trim(V_calle), Trim(V_zona), Null, Trim(V_cupo), 
		Null, Null, Null, Null, Null with resume;

				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Regrendo_anual = 0;
				Let v_RefrendoRcgo_anual = 0;
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;
				Let contador = 0;
				
				FOREACH
				EXECUTE procedure cons14_detalle ( pOrigen, p_opc, V_id, axovig, mesvig )
						INTO vd_concepto, vd_axo, vd_mes, vd_adeudo, vd_dscto_adeudo, 
						vd_rgs, vd_dscto_rcgs, vd_tipo, vd_id_adeudo
				
				if ( vd_adeudo > 0) then
					RETURN Null, Null, Null, Null, Null, Null, 
					vd_concepto, vd_axo, vd_mes, (vd_adeudo - vd_dscto_adeudo), (vd_rgs - vd_dscto_rcgs)  with resume;
				end if;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;

				END FOREACH;				


				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Regrendo_anual = 0;
				Let v_RefrendoRcgo_anual = 0;
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;
				Let contador = 0;


END FOREACH;
end if;

end procedure;

create procedure "pgmoreno".cons14_detallepapa3 ( pOrigen char(2), p_opc int, p_axof int, p_mesf int )

	Returning   int as Numero_Esta,
		varchar(100) as Nombre_Esta,
		varchar(100) as Calle_Esta,
		char(5) as Zona,
		char(100) as Categoria_Esta,
		char(100) as Cupo_Esta,
		varchar(50) as Concepto,
		int as axo_adeudo,
		int as mes_adeudo,
		money(12,2) as Adeudo,
		money(12,2) as Recargo,
		money(12,2) as Adeudo_2008,
		money(12,2) as Recargo_2008,
		money(12,2) as Adeudo_2009,
		money(12,2) as Recargo_2009,
		money(12,2) as Adeudo_2010,
		money(12,2) as Recargo_2010,
		money(12,2) as Adeudo_2011,
		money(12,2) as Recargo_2011,
		money(12,2) as Adeudo_2012,
		money(12,2) as Recargo_2012,
		money(12,2) as Adeudo_2013,
		money(12,2) as Recargo_2013,
		money(12,2) as Adeudo_2014,
		money(12,2) as Recargo_2014,
		money(12,2) as Adeudo_2015,
		money(12,2) as Recargo_2015,
		money(12,2) as Adeudo_2016,
		money(12,2) as Recargo_2016;

define vd_concepto 						varchar(50);
define vd_axo, vd_mes, vd_tipo, vd_id_adeudo				int;
define vd_adeudo, vd_dscto_adeudo, vd_rgs, vd_dscto_rcgs		money(12,2);
define vd20_adeudo, vd20_dscto_adeudo, vd20_rgs, vd20_dscto_rcgs	money(12,2);
define vd26_adeudo, vd26_dscto_adeudo, vd26_rgs, vd26_dscto_rcgs	money(12,2);
define contador							int;
define vp_Axo, vp_Mes						int;

define vd2008_adeudo, vd2009_adeudo, vd2010_adeudo, vd2011_adeudo money(12,2);
define vd2012_adeudo, vd2013_adeudo, vd2014_adeudo, vd2015_adeudo, vd2016_adeudo money(12,2);

define vd2008_rcgs, vd2009_rcgs, vd2010_rcgs, vd2011_rcgs, vd2012_rcgs, vd2013_rcgs, vd2014_rcgs, vd2015_rcgs, vd2016_rcgs	money(12,2);


define v_id, v_numesta, v_pubcategoria_id	int;
define V_nombre, V_calle				char(100);
define V_numext						char(6); 
define V_categoria, V_cupo					char(50);
define V_sector						char(1);
define V_zona						char(5);
define Axo_ciclo, aso_proceso, aso_actual	int;

define axovig, mesvig, v_porc_recgos, v_porcentaje, v_tipo		int;
define v_descto_recgos, v_recargos, v_adeudo				money(12,2); 
define v_Tot_adeudo, v_Tot_recargos, v_Tot_descto_recgos		money(12,2);
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
define perioI, perio int;
define v_fecha_limite date;

DEFINE v_Primer_Adeudo	char(7);
define v_concepto_anual	char(20);
define v_Derechos_anual, v_Recargos_anual, v_Regrendo_anual, v_RefrendoRcgo_anual	money(12,2);
define v_trampa		char(2);

Let V_zona = '';
Let v_Primer_Adeudo = '';
Let v_concepto_anual = '';
Let v_Regrendo_anual = 0;
Let v_RefrendoRcgo_anual = 0;
Let v_Derechos_anual = 0;
Let v_Recargos_anual = 0;
Let v_trampa = 'No';

Let v_Tot_adeudo = 0;
Let v_Tot_recargos = 0;
Let v_Tot_descto_recgos = 0;

Let v_adeudo = 0;
Let v_recargos = 0;
Let v_descto_recgos = 0;
Let v_porcentaje = 0;
Let vp_Axo = 0;
Let vp_Mes = 0;
Let contador = 0;

Let vd2008_adeudo = 0;
Let vd2009_adeudo = 0;
Let vd2010_adeudo = 0;
Let vd2011_adeudo = 0;
Let vd2012_adeudo = 0;
Let vd2013_adeudo = 0;
Let vd2014_adeudo = 0;
Let vd2015_adeudo = 0;
Let vd2016_adeudo = 0;

Let vd2008_rcgs = 0;
Let vd2009_rcgs = 0;
Let vd2010_rcgs = 0;
Let vd2011_rcgs = 0;
Let vd2012_rcgs = 0;
Let vd2013_rcgs = 0;
Let vd2014_rcgs = 0;
Let vd2015_rcgs = 0;
Let vd2016_rcgs = 0;

if p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

if p_opc = 3 then
	let axovig = year(today) ;
	let mesvig = 12;
end if;

let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;

let per_recgos =  (axovig *100 )+mesvig;

if pOrigen = 'EX' then
FOREACH
	SELECT a.id, a.no_exclusivo, Trim(b.propietario), Trim(b.domicilio), Trim(a.zona), 'Bateria '|| a.total_bateria || '  Cordon ' || a.total_cordon  
	INTO V_id, V_numesta, V_nombre, V_calle, V_zona, V_cupo    	
	FROM ex_contrato a, ex_propietario b
	WHERE b.id = a.ex_propietario_id and no_exclusivo > 1
	ORDER BY a.no_exclusivo

	--RETURN V_numesta, Trim(V_nombre), Trim(V_calle), Trim(V_zona), Null, Trim(V_cupo), 
	--	Null, Null, Null, Null, Null with resume;

				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Regrendo_anual = 0;
				Let v_RefrendoRcgo_anual = 0;
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;
				Let contador = 0;
				
				FOREACH
				EXECUTE procedure cons14_detalle ( pOrigen, p_opc, V_id, axovig, mesvig )
						INTO vd_concepto, vd_axo, vd_mes, vd_adeudo, vd_dscto_adeudo, 
						vd_rgs, vd_dscto_rcgs, vd_tipo, vd_id_adeudo
				
				if ( vd_adeudo > 0) then
					--RETURN Null, Null, Null, Null, Null, Null, 
					--vd_concepto, vd_axo, vd_mes, (vd_adeudo - vd_dscto_adeudo), (vd_rgs - vd_dscto_rcgs)  with resume;
					if contador = 0 then
						Let vp_Axo = vd_axo;
						Let vp_Mes = vd_mes;
					end if;
					Let contador = 1;
	
					if vd_axo = 2008 then
						Let vd2008_adeudo = vd2008_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2008_rcgs = vd2008_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2009 then
						Let vd2009_adeudo = vd2009_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2009_rcgs = vd2009_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2010 then
						Let vd2010_adeudo = vd2010_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2010_rcgs = vd2010_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2011 then
						Let vd2011_adeudo = vd2011_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2011_rcgs = vd2011_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2012 then
						Let vd2012_adeudo = vd2012_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2012_rcgs = vd2012_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2013 then
						Let vd2013_adeudo = vd2013_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2013_rcgs = vd2013_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2014 then
						Let vd2014_adeudo = vd2014_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2014_rcgs = vd2014_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2015 then
						Let vd2015_adeudo = vd2015_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2015_rcgs = vd2015_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2016 then
						Let vd2016_adeudo = vd2016_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2016_rcgs = vd2016_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
				end if;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;

				END FOREACH;				

				RETURN V_numesta, Trim(V_nombre), Trim(V_calle), Trim(V_zona), Null, Trim(V_cupo), 
					Null, vp_Axo, vp_Mes, 0, 0,   
					vd2008_adeudo, vd2008_rcgs,
					vd2009_adeudo, vd2009_rcgs, 
 					vd2010_adeudo, vd2010_rcgs, 
					vd2011_adeudo, vd2011_rcgs, 
					vd2012_adeudo, vd2012_rcgs, 
					vd2013_adeudo, vd2013_rcgs, 
					vd2014_adeudo, vd2014_rcgs, 
					vd2015_adeudo, vd2015_rcgs, 
					vd2016_adeudo, vd2016_rcgs  with resume;

				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Regrendo_anual = 0;
				Let v_RefrendoRcgo_anual = 0;
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;

				Let vp_Axo = 0;
				Let vp_Mes = 0;
				Let contador = 0;

				Let vd2008_adeudo = 0;
				Let vd2009_adeudo = 0;
				Let vd2010_adeudo = 0;
				Let vd2011_adeudo = 0;
				Let vd2012_adeudo = 0;
				Let vd2013_adeudo = 0;
				Let vd2014_adeudo = 0;
				Let vd2015_adeudo = 0;
				Let vd2016_adeudo = 0;

				Let vd2008_rcgs = 0;
				Let vd2009_rcgs = 0;
				Let vd2010_rcgs = 0;
				Let vd2011_rcgs = 0;
				Let vd2012_rcgs = 0;
				Let vd2013_rcgs = 0;
				Let vd2014_rcgs = 0;
				Let vd2015_rcgs = 0;
				Let vd2016_rcgs = 0;


END FOREACH;
end if;

if pOrigen = 'PU' then
FOREACH
	SELECT a.id,  a.numesta, a.nombre, a.calle, a.numext, b.descripcion, sector, cupo
	INTO V_id, V_numesta, V_nombre, V_calle, V_numext, V_categoria, V_sector, V_cupo    
	FROM pubmain a, pubcategoria b
	WHERE b.id = a.pubcategoria_id ORDER BY a.numesta

				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Regrendo_anual = 0;
				Let v_RefrendoRcgo_anual = 0;
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;
				Let contador = 0;
				
				FOREACH
				EXECUTE procedure cons14_detalle ( pOrigen, p_opc, V_id, axovig, mesvig )
						INTO vd_concepto, vd_axo, vd_mes, vd_adeudo, vd_dscto_adeudo, 
						vd_rgs, vd_dscto_rcgs, vd_tipo, vd_id_adeudo
				
				if ( vd_adeudo > 0) then
					--RETURN Null, Null, Null, Null, Null, Null, 
					--vd_concepto, vd_axo, vd_mes, (vd_adeudo - vd_dscto_adeudo), (vd_rgs - vd_dscto_rcgs)  with resume;
					if contador = 0 then
						Let vp_Axo = vd_axo;
						Let vp_Mes = vd_mes;
					end if;
					Let contador = 1;
	
					if vd_axo = 2008 then
						Let vd2008_adeudo = vd2008_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2008_rcgs = vd2008_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2009 then
						Let vd2009_adeudo = vd2009_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2009_rcgs = vd2009_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2010 then
						Let vd2010_adeudo = vd2010_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2010_rcgs = vd2010_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2011 then
						Let vd2011_adeudo = vd2011_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2011_rcgs = vd2011_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2012 then
						Let vd2012_adeudo = vd2012_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2012_rcgs = vd2012_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2013 then
						Let vd2013_adeudo = vd2013_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2013_rcgs = vd2013_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2014 then
						Let vd2014_adeudo = vd2014_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2014_rcgs = vd2014_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2015 then
						Let vd2015_adeudo = vd2015_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2015_rcgs = vd2015_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
					if vd_axo = 2016 then
						Let vd2016_adeudo = vd2016_adeudo + (vd_adeudo - vd_dscto_adeudo);
						Let vd2016_rcgs = vd2016_rcgs + (vd_rgs - vd_dscto_rcgs);
					end if;
				end if;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;

				END FOREACH;				

				RETURN V_numesta, Trim(V_nombre), Trim(V_calle) || ' ' || Trim(V_numext) || ' Sector  ' || V_sector, Null, Trim(V_categoria), Trim(V_cupo), 
					Null, vp_Axo, vp_Mes, 0, 0,   
					vd2008_adeudo, vd2008_rcgs,
					vd2009_adeudo, vd2009_rcgs, 
 					vd2010_adeudo, vd2010_rcgs, 
					vd2011_adeudo, vd2011_rcgs, 
					vd2012_adeudo, vd2012_rcgs, 
					vd2013_adeudo, vd2013_rcgs, 
					vd2014_adeudo, vd2014_rcgs, 
					vd2015_adeudo, vd2015_rcgs, 
					vd2016_adeudo, vd2016_rcgs  with resume;

				Let v_Primer_Adeudo = '';
				Let v_concepto_anual = '';
				Let v_Regrendo_anual = 0;
				Let v_RefrendoRcgo_anual = 0;
				Let v_Derechos_anual = 0;
				Let v_Recargos_anual = 0;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rgs = 0;
				Let vd_dscto_rcgs = 0;
				Let vd20_adeudo = 0;
				Let vd20_dscto_adeudo = 0;
				Let vd20_rgs = 0;
				Let vd20_dscto_rcgs = 0;
				Let vd26_adeudo = 0;
				Let vd26_dscto_adeudo = 0;
				Let vd26_rgs = 0;
				Let vd26_dscto_rcgs = 0;

				Let vp_Axo = 0;
				Let vp_Mes = 0;
				Let contador = 0;

				Let vd2008_adeudo = 0;
				Let vd2009_adeudo = 0;
				Let vd2010_adeudo = 0;
				Let vd2011_adeudo = 0;
				Let vd2012_adeudo = 0;
				Let vd2013_adeudo = 0;
				Let vd2014_adeudo = 0;
				Let vd2015_adeudo = 0;
				Let vd2016_adeudo = 0;

				Let vd2008_rcgs = 0;
				Let vd2009_rcgs = 0;
				Let vd2010_rcgs = 0;
				Let vd2011_rcgs = 0;
				Let vd2012_rcgs = 0;
				Let vd2013_rcgs = 0;
				Let vd2014_rcgs = 0;
				Let vd2015_rcgs = 0;
				Let vd2016_rcgs = 0;


END FOREACH;
end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp24_convcancela ( par_Id_Cobro Integer, par_Folio_rcbo Char(10), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    sp24_ConvCancela
#  Descripcion:      Interfaz de Cancelacion del pago de CONVENIOS de ESTACIONAMIENTOS PUBLICOS
#
#  Parametros        	par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#  de entrada:        	par_Folio_rcbo = Folio del recibo
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            09 Agosto 2016   
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_id_usuario	int;

define v_id, v_pubadeudo_id, v_pubmain_id, v_axo, v_mes, v_tipo	int;
define v_concepto						varchar(40);
define v_ade_importe					money(12,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'Cancelacion del pago de CONVENIOS de ESTACIONAMIENTOS PUBLICOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda    	= 'CANCELACION DE RECIBO Y REACTIVACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************

if exists( SELECT *  FROM pubadeudo_histo WHERE pag_operacion = par_Id_Cobro  ) then

	--BEGIN WORK;
		FOREACH
		SELECT id, pubadeudo_id, pubmain_id, axo, mes, tipo, concepto, ade_importe
		INTO 	v_id, v_pubadeudo_id, v_pubmain_id, v_axo, v_mes, v_tipo, v_concepto, v_ade_importe
		FROM pubadeudo_histo WHERE pag_operacion = par_Id_Cobro

			INSERT INTO pubadeudo ( id, fecha_at, pubmain_id, axo, mes, tipo, concepto, ade_importe, ade_descto, id_usuario )
					VALUES  ( v_pubadeudo_id, today, v_pubmain_id, v_axo, v_mes, v_tipo, v_concepto, v_ade_importe, 0, v_id_usuario );
  
			DELETE FROM pubadeudo_histo WHERE id = v_id;

		END FOREACH;

		UPDATE db_ingresos:ta_15_apremios SET
			fecha_pago = Null, recaudadora = 0,  caja = ' ',  
			operacion = 0,  importe_pago = 0,  vigencia = '1'
                       		WHERE modulo = 24 AND operacion = par_Id_Cobro;

	--COMMIT WORK; 
else
         	let v_leyenda = 'NO EXISTE CONCESION';
         	let v_estatus  = 1;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".sp24_convpago ( parControl int, parAxo_ini int, parMes_ini int, parAxo_fin int, parMes_fin int, parOpcApremios char(1), 
				par_Operacion Int, parFolioConvenio Char(15), par_Fecha Date, par_Id_Rec Int, 
				par_Caja Char(2), par_Cve_Usuario Char(25), par_Opc char(1) )
{######################################################################
#  Procedimiento:    sp24_ConvPago
#  Descripcion:      Interfaz de PAGO para CONVENIOS de ESTACIONAMIENTOS PUBLICOS
#
#  Parametros        	parControl	= id del contrato
#  de entrada:        	parAxi_ini, parMes_ini, parAxo_fin parMes_fin	= periodo de inicio y fin de afectacion de periodos
#		     	parOpcApremios	= Opcion 'S' Si se afecta, 'N' No se afecta APREMIOS
#
#		     	parOperacion = numero de operacion
#                    		parFolioConvenio = Folio o Dato del Convenio � Folio del recibo
#                    		par_Fecha = Fecha del recibo
#                    		par_Id_Rec = recaudadora donde se realiza el pago
#                    		par_Caja = caja de pago
#                    		par_Cve_Usuario = usuario de cajero(a)
#                    		par_Opc = opcion de pago por cajero � diversos 'C'=cajero, 'D'=diversos
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            25 Julio 2016   
#
#  Llamado por:      Procedimiento control de convenios
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;

-----------Define las variables de retorno----------------
define v_leyenda, v1_leyenda    			varchar(255);
define v_estatus, v1_estatus 				int;
define v_Axo, v_Mes, v_Tipo				int;
define v_id_control, v_id_usuario, v_control_contrato	int;
define v_importe_gastos			money(12,2);
define v_registros					int;
define v_motivo					varchar(30);
define v_certificado					money(12,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'PAGO para CONVENIOS de ESTACIONAMIENTOS PUBLICOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

Let v_registros	= 0;
let v_leyenda    	= 'PAGO REALIZADO';
let v_estatus	= 0;
let v1_leyenda    	= 'PAGO REALIZADO';
let v1_estatus	= 0;

Let v_control_contrato = 0;
Let v_id_control = 0;
Let v_importe_gastos = 0;

Let v_certificado = 0;
Let v_motivo = '';

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************

-- obtener el valor del recibo.
SELECT nvl(importe,0) INTO v_certificado FROM db_ingresos:ta_12_recibos 
WHERE fecha = par_Fecha AND id_rec = par_Id_Rec  AND caja = par_Caja AND operacion = par_Operacion
AND cvepago = 'P';

if (par_Opc = 'C')  and  (v_certificado <= 0) then
	let v_leyenda = 'LOS DATOS DEL RECIBO NO SON CORRECTOS';
         	let v_estatus  = 1;
else
	if par_Opc = 'C' then
		Let v_motivo = 'Pago En Reca';
	else
		Let v_motivo = 'Pago En Reca Diversos';
	end if;

	if exists( SELECT *  FROM pubmain WHERE id = parControl  ) then
		SELECT id INTO v_control_contrato  FROM pubmain WHERE id = parControl;

		SELECT count(*) INTO v_registros FROM pubadeudo where pubmain_id = v_control_contrato
		AND (axo  * 100 )+ mes BETWEEN (parAxo_ini * 100)+ parMes_ini AND (parAxo_fin * 100)+ parMes_fin;

		if v_registros > 0 then
			--BEGIN WORK;
			FOREACH
			SELECT Axo, mes, Tipo INTO v_Axo, v_Mes, v_Tipo FROM pubadeudo where pubmain_id = v_control_contrato
			AND (axo  * 100 )+ mes BETWEEN (parAxo_ini * 100)+ parMes_ini AND (parAxo_fin * 100)+ parMes_fin
			ORDER BY Axo, mes, Tipo

				EXECUTE procedure actualiza_pub_pagoC ( v_control_contrato, v_Axo, v_Mes, v_Tipo, 
									par_Fecha, par_Id_Rec, par_Caja, par_Operacion, 
									v_certificado, v_motivo ) INTO v1_estatus, v1_leyenda;

			END FOREACH;

			if parOpcApremios = 'S' then
				FOREACH
				SELECT id_control, importe_gastos INTO V_id_control, v_importe_gastos FROM ta_15_apremios 
					WHERE modulo = 24 AND control_otr = v_control_contrato And vigencia = "1" and clave_practicado = "P"

				UPDATE ta_15_apremios SET 
					fecha_pago = par_Fecha,  recaudadora = par_Id_Rec, caja = par_Caja,  
					operacion = par_Operacion, vigencia='2', clave_mov = 'P', importe_pago = v_importe_gastos
					WHERE id_control = V_id_control;
				END FOREACH;
			end if;
			--COMMIT WORK; 			
		else
			let v_leyenda = 'NO HAY ADEUDOS CON ESTE PERIODO';
         			let v_estatus  = 1;
		end if;
	else
         		let v_leyenda = 'NO EXISTE CONCESION';
         		let v_estatus  = 1;
	end if;

end if;	

	RETURN v_estatus,v_leyenda;

END PROCEDURE;

CREATE PROCEDURE "pgmoreno".sp28_convcancela ( par_Id_Cobro Integer, par_Folio_rcbo Char(10), par_Cve_Usuario Char(25) )
{######################################################################
#  Procedimiento:    sp28_ConvCancela
#  Descripcion:      Interfaz de Cancelacion del pago de CONVENIOS de ESTACIONAMIENTOS EXCLUSIVOS
#
#  Parametros        	par_Id_Cobro = Id cobro de admin, similar al numero de operacion
#  de entrada:        	par_Folio_rcbo = Folio del recibo
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            09 Agosto 2016   
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
define v_id_usuario	int;

define v_id, v_pubadeudo_id, v_pubmain_id, v_axo, v_mes, v_tipo	int;
define v_concepto						varchar(40);
define v_ade_importe					money(12,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'Cancelacion del pago de CONVENIOS de ESTACIONAMIENTOS EXCLUSIVOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_leyenda    	= 'REACTIVACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************

if exists( SELECT *  FROM ex_adeudo_histo WHERE pag_operacion = par_Id_Cobro  ) then

	--BEGIN WORK;
		FOREACH
		SELECT id, ex_adeudo_id, ex_contrato_id, axo, mes, tipo, concepto, ade_importe
		INTO 	v_id, v_pubadeudo_id, v_pubmain_id, v_axo, v_mes, v_tipo, v_concepto, v_ade_importe
		FROM ex_adeudo_histo WHERE pag_operacion = par_Id_Cobro

			INSERT INTO ex_adeudo ( id, fecha_at, ex_contrato_id, axo, mes, tipo, concepto, ade_importe, ade_descto, id_usuario )
					VALUES  ( v_pubadeudo_id, today, v_pubmain_id, v_axo, v_mes, v_tipo, v_concepto, v_ade_importe, 0, v_id_usuario );
  
			DELETE FROM ex_adeudo_histo WHERE id = v_id;

		END FOREACH;

		UPDATE db_ingresos:ta_15_apremios SET
			fecha_pago = Null, recaudadora = 0,  caja = ' ',  
			operacion = 0,  importe_pago = 0,  vigencia = '1'
                       		WHERE modulo = 28 AND operacion = par_Id_Cobro;

	--COMMIT WORK; 
else
         	let v_leyenda = 'NO EXISTE CONCESION';
         	let v_estatus  = 1;
end if;
	RETURN v_estatus,v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".sp28_convpago ( parControl int, parAxo_ini int, parMes_ini int, parAxo_fin int, parMes_fin int, parOpcApremios char(1), 
				par_Operacion Int, parFolioConvenio Char(15), par_Fecha Date, par_Id_Rec Int, 
				par_Caja Char(2), par_Cve_Usuario Char(25), par_Opc char(1) )
{######################################################################
#  Procedimiento:    sp28_ConvPago
#  Descripcion:      Interfaz de PAGO para CONVENIOS de ESTACIONAMIENTOS EXCLUSIVOS
#
#  Parametros        	parControl	= id del contrato
#  de entrada:        	parAxi_ini, parMes_ini, parAxo_fin parMes_fin	= periodo de inicio y fin de afectacion de periodos
#		     	parOpcApremios	= Opcion 'S' Si se afecta, 'N' No se afecta APREMIOS
#
#		     	parOperacion = numero de operacion
#                    		parFolioConvenio = Folio o Dato del Convenio � Folio del recibo
#                    		par_Fecha = Fecha del recibo
#                    		par_Id_Rec = recaudadora donde se realiza el pago
#                    		par_Caja = caja de pago
#                    		par_Cve_Usuario = usuario de cajero(a)
#                    		par_Opc = opcion de pago por cajero � diversos 'C'=cajero, 'D'=diversos
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            27 Julio 2016   
#
#  Llamado por:      Procedimiento control de convenios
#  Llama a:          
#  
######################################################################}
                returning Integer as Status,
		VarChar(255) as Concepto_status;

-----------Define las variables de retorno----------------
define v_leyenda, v1_leyenda    			varchar(255);
define v_estatus, v1_estatus 				int;
define v_Axo, v_Mes, v_Tipo				int;
define v_id_control, v_id_usuario, v_control_contrato	int;
define v_importe_gastos			money(12,2);
define v_registros					int;
define v_motivo					varchar(30);
define v_certificado					money(12,2);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'PAGO para CONVENIOS de ESTACIONAMIENTOS EXCLUSIVOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

Let v_registros	= 0;
let v_leyenda    	= 'PAGO REALIZADO';
let v_estatus	= 0;
let v1_leyenda    	= 'PAGO REALIZADO';
let v1_estatus	= 0;

Let v_control_contrato = 0;
Let v_id_control = 0;
Let v_importe_gastos = 0;

Let v_certificado = 0;
Let v_motivo = '';

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(par_Cve_Usuario);
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************

-- obtener el valor del recibo.
SELECT nvl(importe,0) INTO v_certificado FROM db_ingresos:ta_12_recibos 
WHERE fecha = par_Fecha AND id_rec = par_Id_Rec  AND caja = par_Caja AND operacion = par_Operacion
AND cvepago = 'P';

if (par_Opc = 'C')  and  (v_certificado <= 0) then
	let v_leyenda = 'LOS DATOS DEL RECIBO NO SON CORRECTOS';
         	let v_estatus  = 1;
else
	if par_Opc = 'C' then
		Let v_motivo = 'Pago En Reca';
	else
		Let v_motivo = 'Pago En Reca Diversos';
	end if;

	if exists( SELECT * FROM ex_contrato WHERE id = parControl  ) then
		SELECT id INTO v_control_contrato  FROM ex_contrato WHERE id = parControl;

		SELECT count(*) INTO v_registros FROM ex_adeudo WHERE ex_contrato_id = v_control_contrato
		AND (axo  * 100 )+ mes BETWEEN (parAxo_ini * 100)+ parMes_ini AND (parAxo_fin * 100)+ parMes_fin;

		if v_registros > 0 then
			--BEGIN WORK;
			FOREACH
			SELECT Axo, mes, Tipo INTO v_Axo, v_Mes, v_Tipo FROM ex_adeudo WHERE ex_contrato_id = v_control_contrato
			AND (axo  * 100 )+ mes BETWEEN (parAxo_ini * 100)+ parMes_ini AND (parAxo_fin * 100)+ parMes_fin
			ORDER BY Axo, mes

				EXECUTE procedure actualiza_exc_pagoC ( v_control_contrato, v_Axo, v_Mes, v_Tipo, 
									par_Fecha, par_Id_Rec, par_Caja, par_Operacion, 
									v_certificado, v_motivo ) INTO v1_estatus, v1_leyenda;

			END FOREACH;

			if parOpcApremios = 'S' then
				FOREACH
				SELECT id_control, importe_gastos INTO V_id_control, v_importe_gastos FROM ta_15_apremios 
					WHERE modulo = 28 AND control_otr = v_control_contrato And vigencia = "1" and clave_practicado = "P"

				UPDATE ta_15_apremios SET 
					fecha_pago = par_Fecha,  recaudadora = par_Id_Rec, caja = par_Caja,  
					operacion = par_Operacion, vigencia='2', clave_mov = 'P', importe_pago = v_importe_gastos
					WHERE id_control = V_id_control;
				END FOREACH;
			end if;
			--COMMIT WORK; 
		else
			let v_leyenda = 'NO HAY ADEUDOS CON ESTE PERIODO';
         			let v_estatus  = 1;
		end if;
	else
         		let v_leyenda = 'NO EXISTE CONCESION';
         		let v_estatus  = 1;
	end if;

end if;	

	RETURN v_estatus,v_leyenda;

END PROCEDURE;

create procedure "informix".sp_pub_movtos ( p_opc int ,p_pubmain_id int, fecha date, cajones int, categoria int , oficio varchar(20) , p_user integer )
returning int as resultado ;
-- opcion 1  incrementos o decrementos, tomar cajones como el nuevo valor que tendra el estacionamiento
define v_cupo_act int;
define v_cupo_nuevo int;
define v_axoact int;
define v_mesact int;
define v_idmsg int;
define v_msg varchar(100);
define v_peri integer;
define v_idgen integer;
define v_msggen char(100);
define v_categoria_nuevo integer;
define v_categoria_act integer;

define v_dia int; define v_mes int; define v_aso int;  -- LINEAS ADICIONADA POR GILBERTO
let v_dia = Day(fecha);
let v_mes = Month(fecha);
let v_aso = Year(fecha);
if v_dia > 5 then
	if v_mes = 12 then
		let v_mes = 1;		
		let v_aso = v_aso + 1;
	else
		let v_mes = v_mes + 1;
	end if;
end if;							--

   let v_idmsg = 0;
   let v_msg = 'No proceso nada';

	let v_cupo_nuevo = cajones;
	let v_categoria_nuevo = categoria;

	select  a.pubcategoria_id, a.cupo into  v_categoria_act, v_cupo_act  from pubmain a  where  a.id = p_pubmain_id;

	select min((axo * 100)+ mes) into v_peri from pubadeudo where pubmain_id = p_pubmain_id and tipo = 10
		 and ((axo * 100)+ mes) >= ((v_aso * 100)+ v_mes); -- LINEA ADICIONADA POR GILBERTO
   
   	if v_peri is null then
        	let v_idmsg = 1 ; let v_msg = 'No hay pagos';
        	let v_axoact = 0; let v_mesact =0;
   	else
       		let v_axoact = trunc(v_peri / 100) ; let v_mesact = v_peri - (v_axoact *100) ;
       		let v_idmsg = 2 ; let v_msg = 'Ultimo pago';
   	end if;

	-- borrar los adeudos actuales.
   	delete from pubadeudo where pubmain_id = p_pubmain_id and tipo = 10
		and ((axo * 100)+ mes) >= ((v_aso * 100)+ v_mes);  -- LINEA ADICIONADA POR GILBERTO

	if p_opc = 1 then
		-- realiza el registro del cambio de CUPO.
		insert into pubmain_movtospres ( id, pubmain_id, pubcategoriaid_act, pubcategoriaid_nvo, cupo_act, cupo_nvo, 
				axo_ini, mes_ini, oficio, fecha_efectos, fecha_mov,  pc_mov )
    				values (0, p_pubmain_id, 0, 0, v_cupo_act, v_cupo_nuevo, 
				v_axoact, v_mesact, oficio, fecha, current year to second, getcomputer());

		-- realiza las modificaciones del principal.
   		update pubmain set cupo = v_cupo_nuevo , movtos_no =  movtos_no +1 ,movto_usr = p_user
   			where id = p_pubmain_id;
	end if;
	if p_opc = 2 then
		-- realiza el registro del cambio de CATEGORIA.
   		insert into pubmain_movtospres ( id, pubmain_id, pubcategoriaid_act, pubcategoriaid_nvo, cupo_act, cupo_nvo, 
				axo_ini, mes_ini,  oficio, fecha_efectos, fecha_mov,  pc_mov )
    				values ( 0, p_pubmain_id, v_categoria_act, v_categoria_nuevo, 0, 0, 
				v_axoact, v_mesact, oficio, fecha, current year to second, getcomputer());

		-- realiza las modificaciones del principal.
   		update pubmain set pubcategoria_id = v_categoria_nuevo , movtos_no =  movtos_no +1 ,movto_usr = p_user
   			where id = p_pubmain_id;
	end if;

	execute procedure sp_pub_genadeudo( 2, p_pubmain_id, v_axoact, v_mesact, yeaR(today), 12, p_user ) into v_idgen , v_msggen ;
  
--
 return  v_idgen ;

END PROCEDURE;

CREATE PROCEDURE "informix".spd_delesta01sra ( paraxo smallint, parfolio  integer, parPlaca char(7), parusuauto  integer, parOpcion  smallint )
	returning smallint , varchar(100);		

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define v_id_usuario   int;
define v_r char(1);
define v_canti int;

let v_r = 'N';
let varok = 0;
let varobs = ''; 

select count(*) into v_canti from   ta14_folios_adeudo where axo = paraxo and folio = parfolio;
if v_canti = 0 then
	return 1,'NO EXISTE ADEUDO' ;
end if;

if (paropcion = 22)  or (paropcion = 23)  then   --opcion 22 y 23 Error de vigilante o falla de aparato.
	let v_r = 'S';
     	insert into ta14_folios_histo       
     	select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio, 0 
     	from ta14_folios_adeudo  where axo = paraxo and folio = parfolio;

     	delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
	return 0,'Procedimiento Completo' ;
else
	return 2,'Procedimiento no realizado' ;
end if;

end procedure;

CREATE PROCEDURE "informix".spd_delesta01(
		paraxo smallint,
                                parfolio  integer,
		parPlaca char(7),
		parconvenio  integer,
                                parfecha   date,
                                parreca      smallint,
                                parcaja      char(2),
                                paroperacion  integer,
                                parusuauto  integer,
		parOpcion  smallint
		)
		returning smallint,  char(200) ;

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
           let varok = 0;
          let varobs = '';          

--set debug file to "c:\ivan.log";
--trace on;

--opcion 1 consulta del disponible.

if (paropcion = 1) or (paropcion = 2)  or (paropcion = 5) or (paropcion = 15)  or (paropcion = 16) then
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio ,0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'Condonaci�n de Folio o Error de captura';

end if;
-- pago por folio de recaudadora;
if (paropcion = 3)  then
      select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio , 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
  if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
    let varok = 1;
     let varobs = 'pago hecho correctamente';

end if;
-- pago por folio de recaudadora cajero;
if (paropcion = 13)  then
     select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
--- Cuando hay notificaciones del estado.


    if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
       let varok = 1; 
       let varobs = 'pago hecho correctamente';

end if;

if (paropcion = 4)  then

       foreach 
              select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio  from ta14_folios_adeudo  where placa = parplaca
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio, 0);
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = vaxo and folio = vfolio;
   end foreach;
    let varok = 1;
     let varobs = 'pago hecho por placa correctamente';

end if;


if (paropcion = 6)  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio , 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
                          
                           
else
  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 6                
	 ) then
                 
        select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio , 0);
    let varok = 1;
     let varobs = 'pago hecho correctamente';
   else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';
      
end if;
end if;

end if;

if (paropcion = 7 )  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio , 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
      else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';                     
                          
end if;

end if;

-- BANORTE

if (paropcion = 10)  then
   let varok = 10;
   if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio 
 	 ) then
        select placa into vplaca from ta14_folios_adeudo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
    if ban_placa = vplaca then

      insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
      delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 0 
     where axo = paraxo and folio = parfolio ;

     let varobs = 'pago hecho correctamente';
    let varok = 0;
  else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varok = 0;
  end if;

end if;
                      
                           

  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 10             
	 ) then

        select placa into vplaca from ta14_folios_histo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
      if ban_placa = vplaca then          
    
             select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
         insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio , 0);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 1 
     where axo = paraxo and folio = parfolio ;
    let varobs = 'pago hecho correctamente con pago doble de otro medio';
    let varok = 1;
    else
    update ta14_fol_Banorte set 
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;
     let varobs = 'Folio no coincide la placa';
    let varok = 1;
    end if;
  
    
   else      
    if varok = 10 then

     -- no se insertaran los datos nuevos por que existen muchos errores de los archivos del Banco;
     --select  fecha_folio, placa, infraccion   into vfecha , vplaca , vinfra from ta14_fol_banorte  where axo = paraxo and folio = parfolio ; 
     --insert into ta14_folios_histo   values ( 0,today,    paraxo, parfolio, vfecha, vplaca, vinfra , 14, 999 , null, today, parusuauto, paropcion, parusuauto, 0 , 0);
      update ta14_fol_Banorte set fecha_afectacion = today ,
      usu_carga = parusuauto , 
      status_mpio = 3 
     where axo = paraxo and folio = parfolio ;

        
          let varok = 0;
          let varobs = 'se inserta para estos datos lectura';
    end if; 
end if;

end if;




return varok, varobs;
--trace off;



end procedure
;

CREATE PROCEDURE "informix".mmeters_bajafolio(
		parfolio  integer,
                parfecha  char(10),		
                parPlaca char(7),
		parOpcion  smallint
                )
		returning smallint,  char(200) ;
define v_axo int;
define v_folio int;
define v_placa char(7);
define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
define v_fecha date;
           let varok = 0;
          let varobs = '';          
let v_fecha = mdy(parfecha[4,5], parfecha[1,2], parfecha[7,10]);

--set debug file to "c:\ivan.log";
--trace on;
   select nvl(axo,0) ,nvl(folio,0) , nvl(placa,'') 
    into v_axo , v_folio , v_placa 
    from ta14_folios_adeudo where folio =  parfolio and fecha_folio = v_fecha;
   
  if v_folio = parfolio then
      if v_placa = parplaca then
          insert into ta14_folios_histo       
          select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, 1673, zona , espacio , 0
          from ta14_folios_adeudo 
         where axo = v_axo and folio = parfolio;
         delete from ta14_folios_adeudo where axo = v_axo and folio = parfolio;
         let varok = 0;
         let varobs = 'Folio correctamente dado de baja';
       end if;
       if v_placa <> parplaca then
     let varok = -1;
     let varobs = 'Error la placa no corresponde al capturado';
     end if;
  else
     let varok = -2;
     let varobs = 'Folio No existe como adeudo';
  end if;
return varok, varobs;
--trace off;



end procedure;

create procedure "pgmoreno".actualiza_pub_pagob ( p_pubid int, p_axo int, p_mes int, p_tipo int,
 					p_fecha_movto date, p_reca smallint, p_caja char(2), p_operacion int, p_Total money(12,2) )
returning  int as id,  varchar(50) as mensaje;
 
define r_id int ; define r_mensaje, v_concepto1 varchar(50);
define axovig, mesvig, diavig  int; 
define v_adeudo_id, v_axo, v_mes, perioI, per_recgos, v_tipo, v_porcentaje int; 
define v_adeudo, v_recargos money(12,2);

define v_id_usuario int;

let r_id = -1;
let r_mensaje = 'No proceso nada';

Let v_adeudo_id = 0;
Let v_axo = 0;
Let v_mes = 0;
Let v_adeudo = 0;
Let v_tipo = 0;
Let v_concepto1 = '';

let axovig = year(p_fecha_movto) ;
let mesvig = month(p_fecha_movto);
let diavig = day(p_fecha_movto);
let r_id = -1;
let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = User;

if  v_id_usuario    is null then
 let v_id_usuario   = 1;
end if;

if p_tipo = 0 then 
  FOREACH
  SELECT id, Axo, mes, (axo  * 100 )+ mes, ade_importe, tipo, concepto
	INTO v_adeudo_id, v_axo, v_mes, perioI, v_adeudo, v_tipo, v_concepto1
  FROM pubadeudo where pubmain_id = p_pubid  and  axo = p_axo and mes = p_mes and tipo = 10

   	SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
		WHERE (axo * 100 + mes) BETWEEN  perioI AND per_recgos;

		LET v_recargos = (v_porcentaje * v_adeudo ) / 100;

  	INSERT INTO pubadeudo_histo ( id, fecha_at, pubadeudo_id,  pubmain_id, axo, mes, tipo, concepto, ade_importe, ade_descto, 
				ade_recgos, clave, motivo ,fecha_movto, pag_reca, pag_caja, pag_operacion, pag_importe, 
				bco_id,  bco_referencia, bco_importe , id_usuario)
  			VALUES  ( 0,today, v_adeudo_id, p_pubid, v_axo, v_mes, v_tipo, v_concepto1, v_adeudo, 0, 
				v_recargos, 24, 'Pagado  x DIVERSOS ADMIN', p_fecha_movto, p_reca , p_caja, p_operacion, p_Total, 
				null, null, null, v_id_usuario);
  
	delete from pubadeudo where id = v_adeudo_id ;
   

 	LET r_id = 0;
 	LET r_mensaje = 'Pagado  x DIVERSOS ADMIN';
  END FOREACH
else
  FOREACH
  SELECT id, Axo, mes, (axo  * 100 )+ mes, ade_importe, tipo, concepto
	INTO v_adeudo_id, v_axo, v_mes, perioI, v_adeudo, v_tipo, v_concepto1
  FROM pubadeudo where pubmain_id = p_pubid  and  axo = p_axo and mes = p_mes and tipo = p_tipo 

   	SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
		WHERE (axo * 100 + mes) BETWEEN  perioI AND per_recgos;

		LET v_recargos = (v_porcentaje * v_adeudo ) / 100;

  	INSERT INTO pubadeudo_histo ( id, fecha_at, pubadeudo_id,  pubmain_id, axo, mes, tipo, concepto, ade_importe, ade_descto, 
				ade_recgos, clave, motivo ,fecha_movto, pag_reca, pag_caja, pag_operacion, pag_importe, 
				bco_id,  bco_referencia, bco_importe , id_usuario)
  			VALUES  ( 0,today, v_adeudo_id, p_pubid, v_axo, v_mes, v_tipo, v_concepto1, v_adeudo, 0, 
				v_recargos, 24, 'Pagado  x DIVERSOS ADMIN', p_fecha_movto, p_reca , p_caja, p_operacion, p_Total, 
				null, null, null, v_id_usuario);
  
	delete from pubadeudo where id = v_adeudo_id ;
   

 	LET r_id = 0;
 	LET r_mensaje = 'Pagado  x DIVERSOS ADMIN';
  END FOREACH
end if;

  RETURN r_id, r_mensaje ;

end procedure;

create procedure "pgmoreno".actualiza_exc_pagob ( p_excid int, p_axo int, p_mes int, p_tipo int,
 					p_fecha_movto date, p_reca smallint, p_caja char(2), p_operacion int, p_Total money(12,2) )
returning  int as id,  varchar(50) as mensaje;
 
define r_id int ; define r_mensaje, v_concepto1 varchar(50);
define axovig, mesvig, diavig  int; 
define v_adeudo_id, v_axo, v_mes, perioI, per_recgos, v_tipo, v_porcentaje int; 
define v_adeudo, v_recargos money(12,2);

define v_id_usuario int;

let r_id = -1;
let r_mensaje = 'No proceso nada';

Let v_adeudo_id = 0;
Let v_axo = 0;
Let v_mes = 0;
Let v_adeudo = 0;
Let v_tipo = 0;
Let v_concepto1 = '';

let axovig = year(p_fecha_movto) ;
let mesvig = month(p_fecha_movto);
let diavig = day(p_fecha_movto);
let r_id = -1;
let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = User;

if  v_id_usuario    is null then
 let v_id_usuario   = 1;
end if;


  FOREACH
  select id, Axo, mes, (axo  * 100 )+ mes, ade_importe, tipo, concepto
   into v_adeudo_id, v_axo, v_mes, perioI, v_adeudo, v_tipo, v_concepto1
  from ex_adeudo where ex_contrato_id = p_excid  and  axo = p_axo and mes = p_mes and tipo = p_tipo 

   	SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
		WHERE (axo * 100 + mes) BETWEEN  perioI AND per_recgos;

		LET v_recargos = (v_porcentaje * v_adeudo ) / 100;

	insert into ex_adeudo_histo ( id, fecha_at, ex_adeudo_id, ex_contrato_id, axo, mes, tipo, concepto, ade_importe, ade_descto, 
				ade_recgos, clave, motivo, fecha_movto, pag_reca, pag_caja, pag_operacion, pag_importe, 
				bco_id,  bco_referencia , bco_importe , id_usuario)
  			values  ( 0, today, v_adeudo_id, p_excid, v_axo, v_mes, v_tipo, v_concepto1, v_adeudo, 0, 
				v_recargos, 24, 'Pagado  x DIVERSOS ADMIN', p_fecha_movto, p_reca , p_caja, p_operacion, p_Total, 
				null, null, null, v_id_usuario);
  
 	delete from ex_adeudo where id = v_adeudo_id ;
   
 	LET r_id = 0;
 	LET r_mensaje = 'Pagado  x DIVERSOS ADMIN';
  END FOREACH

  RETURN r_id, r_mensaje ;

end procedure;

create procedure "pgmoreno".actualiza_exc_pagoc ( p_excid int, p_axof int , p_mesf int, p_tipo int, 
				p_fecha_movto date, p_reca smallint, p_caja char(2), p_operacion int, p_certificado money(12,2), p_motivo char(30) )
returning  int as id,  varchar(50) as mensaje;
 
define r_id int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define axovig int ;  define v_id_usuario int;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);

--set debug file to 'exclusivo.log';
--trace on;
let axovig 	= year(today) ;
let mesvig 	= month(today);
let diavig 		= day(today);

let r_id = -1;
let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let perio = (p_axof *100 )+ p_mesf;
let per_recgos =  (axovig *100 )+mesvig;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************

Let v_recargos = 0;
Let v_porcentaje = 0;

	SELECT id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
	INTO v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
	FROM ex_adeudo WHERE ex_contrato_id = p_excid  AND  (axo * 100 + mes) = (p_axof * 100 + p_mesf) AND tipo = p_tipo;
	--and tipo = p_tipo

		SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
		WHERE (axo * 100 + mes) BETWEEN perioI AND per_recgos;

			Let v_recargos = (v_porcentaje * v_adeudo ) / 100;

			INSERT INTO ex_adeudo_histo ( id, fecha_at, ex_adeudo_id,  ex_contrato_id , axo , mes ,tipo, concepto, ade_importe , ade_descto , ade_recgos, 
					clave, motivo ,fecha_movto, pag_reca, pag_caja , pag_operacion , pag_importe , bco_id, bco_referencia , bco_importe , id_usuario)
  					VALUES  ( 0,today, v_adeudo_id , p_excid, v_axo , v_mes ,v_tipo, v_concepto1, v_adeudo , v_descto , v_recargos,   
					13 , p_motivo, p_fecha_movto, p_reca , p_caja, p_operacion, p_certificado, null, null, null, v_id_usuario);
  
 			DELETE FROM ex_adeudo WHERE id = v_adeudo_id ;
	 
			let r_id = 0;
	 		let r_mensaje = 'Actualizacion del Pago realizado Correctamente';

RETURN r_id, r_mensaje ;
--trace off;

end procedure;

create procedure "pgmoreno".actualiza_pub_pagoc ( p_pubid int, p_axof int , p_mesf int, p_tipo int, 
				p_fecha_movto date ,p_reca smallint, p_caja char(2) , p_operacion int, p_certificado money(12,2), p_motivo char(30) )
returning  int as id,  varchar(50) as mensaje; 

define r_id int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define axovig int ;  define v_id_usuario int;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);

--set debug file to 'publico.log';
--trace on;
let axovig 	= year(today) ;
let mesvig 	= month(today);
let diavig 		= day(today);

let r_id = -1;
let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let perio = (p_axof *100 )+ p_mesf;
let per_recgos =  (axovig *100 )+mesvig;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 335;
end if;
--******************************************************************************************************************************
Let v_recargos = 0;
Let v_porcentaje = 0;

  	SELECT id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
	INTO v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
  	FROM pubadeudo WHERE pubmain_id = p_pubid  AND  (axo * 100 + mes) = (p_axof * 100 + p_mesf) AND tipo = p_tipo;

		SELECT sum(porcentaje_mes) INTO v_porcentaje from recargos
		WHERE (axo * 100 + mes) BETWEEN  perioI AND per_recgos;

			Let v_recargos = (v_porcentaje * v_adeudo ) / 100;

			INSERT INTO pubadeudo_histo ( id , fecha_at, pubadeudo_id, pubmain_id, axo, mes, tipo, concepto, ade_importe, ade_descto, ade_recgos, 
					clave, motivo, fecha_movto, pag_reca, pag_caja, pag_operacion, pag_importe, bco_id, bco_referencia, bco_importe, id_usuario)
					VALUES  ( 0, today, v_adeudo_id, p_pubid, v_axo, v_mes, v_tipo, v_concepto1, v_adeudo, v_descto, v_recargos, 
					13, p_motivo, p_fecha_movto, p_reca, p_caja, p_operacion, p_certificado, null, null, null, v_id_usuario);
  
			DELETE FROM pubadeudo WHERE id = v_adeudo_id ;

	 		let r_id = 0;
	 		let r_mensaje = 'Actualizacion del Pago realizado Correctamente';

RETURN r_id, r_mensaje ;
--trace off;

end procedure;

create procedure "informix".sppubbaja ( p_id int, p_movto_cve char(1), p_movto_usr int, p_folio int, p_fechabaja date )
	returning  int as result, 
		varchar(100) as resultstr;

define result int;
define resultstr varchar(100);
define  v_idnvo int;
define axo_1 int;
define mes_1 int;
define axo_2 int;
define v_adeudo money(12,2);
define rsopc int ; define messag char(50);
--set debug file to "pubesta.log";
--trace on;
if  exists (select numesta from pubmain where id = p_id) then
	let v_adeudo = 0;
     	select nvl(sum(ade_importe),0) into v_adeudo from pubadeudo where pubmain_id = p_id;
   	if v_adeudo = 0 then 
     		update pubmain set    
     			movtos_no =movtos_no +1,  
     			movto_cve = 'C', 
      			movto_usr =  p_movto_usr, 
      			folio_baja = p_folio,
      			fecha_baja = p_fechabaja
      		where id = p_id;
      		let result = 0 ;
      		let resultstr = 'Dado de Baja correctamente';
   	else
      		let result = -2 ;
      		let resultstr = 'El Estacionamiento aun tiene Adeudo por  ' || v_adeudo;
   	end if;
else
  	let result = -1 ;
  	let resultstr = 'No existe el Registro';
end if;
	Return result, resultstr;
--trace off;
end procedure;

create procedure "pgmoreno".sp14_ex_upd_actas ( par_NumExc integer, par_dep integer, par_axoacta integer, par_NumActa integer )

	Returning   int as estatus,
            varchar(255) as mensaje

define v_status                       	int;
define v_mensaje                      	varchar(255);

define v_id				int;
define v_resultado			int;
define v_id_multa			int;

Let v_status  = 0;
Let v_mensaje = 'ACTA GRABADA CORRECTAMENTE';

Let v_id = 0;
Let v_resultado = 0;
Let v_id_multa = 0;

if exists( SELECT * FROM ex_contrato WHERE no_exclusivo = par_NumExc ) then
    SELECT id  INTO v_id FROM ex_contrato WHERE no_exclusivo = par_NumExc;

	if exists( select * from catastro_gdl:multas
     		where id_dependencia = par_dep and axo_acta = par_AxoActa and num_acta = par_NumActa
		AND cvepago is Null AND fecha_cancelacion is Null AND id_prescri is Null ) then
		select id_multa INTO v_id_multa from catastro_gdl:multas
     		where id_dependencia = par_dep and axo_acta = par_AxoActa and num_acta = par_NumActa
		AND cvepago is Null AND fecha_cancelacion is Null AND id_prescri is Null;

		if not exists( select * from ex_rel_multas
     			where id_multa = v_id_multa AND id_dependencia = par_dep and axo_acta = par_AxoActa and num_acta = par_NumActa ) then
			
				INSERT INTO ex_rel_multas values ( v_id_multa, par_dep, par_AxoActa, par_NumActa, v_id, 'V' );
		else
			Let v_status = -1;
			Let v_mensaje = 'Ya existe el Acta en Relacion de Actas '||par_AxoActa||'-'||par_NumActa;
		end if;

	else
		Let v_status = -1;
		Let v_mensaje = 'No Existe el Acta '||par_AxoActa||'-'||par_NumActa;
	end if;

else
	Let v_status = -1;
	Let v_mensaje = 'No Existe el Exclusivo '||par_NumExc;
end if;

  return v_status,v_mensaje  with resume;

end procedure;

CREATE PROCEDURE "informix".lista_placas_req( ) 
	 returning  varchar(10) as placa , date  as fecha ,   money(10,2) as importe ;
define p_placa varchar(10);
define p_cuantos int;
define p_importe money(10,2);
define p_fecha_folio date;
let p_placa = '';
let p_fecha_folio = mdy(1,1,199);
let p_importe = 0;
foreach 
select  a.placa , count(a.folio) , sum(c.tarifa) 
into p_placa ,  p_cuantos , p_importe 
from ta14_folios_adeudo a, ta_padron b , ta14_tarifas c

where a.fecha_folio between mdy(1,1,2012) and mdy(7,31,2017)
and a.placa = b.placa and b.actualizado is not null 
and a.fecha_folio between c.fecha_inicial and c.fecha_fin  and c.num_clave = a.infraccion
group by 1
having count(a.folio) = 1

 if p_cuantos = 1 then 
  select fecha_folio into p_fecha_folio from ta14_folios_adeudo where placa = p_placa  and fecha_folio between mdy(1,1,2012) and mdy(7,31,2017) 
 and infraccion = 1 ;
  return p_placa , p_fecha_folio , p_importe with resume;
 end if;


end foreach;

end procedure;

CREATE PROCEDURE "pgmoreno".spd_delesta01a_a ( parCodigo_in integer, parSub_in integer, 
				parCodigo_Movto integer, parSub_Codigo integer, 
				parAxo integer, parFolio integer, parUsuario integer, parPlaca char(7), 
				parautoriza char(20), parobs char(50),  parsol_rfc char(13), parsol_motivo char(200) )
		returning smallint,  char(200) ;

define varok   smallint;
define varobs char(200);
define varcontrol integer;
define v_contador integer;

Let varok = 0;
Let varobs = '';          

if  ( parCodigo_Movto = 15)  or ( parCodigo_Movto = 16) or ( parCodigo_Movto = 17) or ( parCodigo_Movto = 18)  or ( parCodigo_Movto = 19) then  -- Condonacion, prescripcion, sentencia de juzgado;

	Select count(*) into v_contador from ta14_folios_histo where placa = parPlaca and folio = parFolio and codigo_movto = parCodigo_Movto and sub_codigo = parSub_Codigo;
	if v_contador > 0 then
		Let varok = -1;
     		Let varobs = 'Ya existe la Condonacion';
	else
		insert into ta14_folios_histo       
     		select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, parCodigo_Movto, parUsuario, zona , espacio, parSub_Codigo 
		from ta14_folios_histo where placa = parPlaca and folio = parFolio and codigo_movto = parCodigo_in and sub_codigo = parSub_in;
      		Let varcontrol =  dbinfo("sqlca.sqlerrd1");
 
		insert into ta14_condonado (control, autoriza, observacion, solicitante_rfc, solicitante_motivo) 
     				values ( varcontrol, parautoriza, parobs, parsol_rfc, parsol_motivo);   
		Let varok = 1;
     		Let varobs = 'Condonacion, prescripcion, sentencia de juzgado; realizada correctamente';
	end if;
else
	Let varok = -1;
     	Let varobs = 'No se Aplica nada';
end if;

return varok, varobs;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_aplpgo_divadmin ( parAxo smallint, parFolio  integer, parFecha date, parReca smallint, parCaja char(2), parOper integer, parUsuario char(15)  )
	returning integer as status, 
		varchar(100) as leyenda;		

define v_status   	integer;
define v_obs 	char(100);
define v_control	integer;

define v_axo, v_infraccion, v_estado, v_zona, v_espacio		smallint;
define v_folio, v_num_acuerdo, v_vigilante, v_usu_inicial 		Integer;
define v_fecha_folio, v_fec_cap 				Date;
define v_placa  						char(7);
define v_id_usuario int;

Let v_axo = 0;
Let v_infraccion = 0;
Let v_estado = 0;
Let v_zona = 0;
Let v_espacio = 0;
Let v_folio = 0;
Let v_num_acuerdo = 0;
Let v_vigilante = 0;
Let v_usu_inicial = 0;
Let v_placa = '';

let v_status = 0;
let v_obs = ''; 
let v_control = 0;

Let  v_id_usuario = 0;
--****************************************************************************************************************************** USUARIO
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = parUsuario ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = parUsuario;
else
    Let v_id_usuario = 50;
end if;
--******************************************************************************************************************************

SELECT nvl(control,0) INTO v_control FROM ta14_folios_histo WHERE axo = parAxo AND folio = parFolio and codigo_movto = 24;

if v_control > 0 then
	Let v_status = -1;
	Let v_obs = 'Ya existe el Folio como HISTORICO PAGADO POR DIVERSOS ADMIN, verifica el dato,,,, intenta con otro';
else
	SELECT axo, folio, fecha_folio, placa, infraccion, estado, vigilante, num_acuerdo, fec_cap, usu_inicial, zona , espacio
	INTO	v_axo, v_folio, v_fecha_folio, v_placa, v_infraccion, v_estado, v_vigilante, v_num_acuerdo, v_fec_cap, v_usu_inicial, v_zona, v_espacio
	FROM ta14_folios_adeudo  WHERE axo = parAxo AND folio = parFolio;

	if v_folio > 0 then
		INSERT INTO ta14_folios_histo VALUES ( 0, today, v_axo, v_folio, v_fecha_folio, v_placa, v_infraccion, v_estado, v_vigilante, v_num_acuerdo, v_fec_cap, v_usu_inicial, 24, v_id_usuario, v_zona, v_espacio, 0 );
		Let v_control =  dbinfo("sqlca.sqlerrd1");

		if v_control <> 0 then
			DELETE FROM ta14_folios_adeudo  WHERE axo = parAxo AND folio = parFolio;
			INSERT INTO ta14_refrecibo VALUES ( v_control, parFecha, parReca, parCaja, parOper );
			Let v_status = 0;
			Let v_obs = 'Se Creo el Historico y la Referencia del Pago, ademas se Elimino el Adeudo';
		else
			Let v_status = -1;
			Let v_obs = 'NO Creo el Historico';
		end if;
	else
		Let v_status = -1;
		Let v_obs = 'NO HAY registro de ADEUDO';
	end if;

end if;

	RETURN v_status, v_obs ;

end procedure;

create procedure "pgmoreno".sp_gmg_1 ()
	returning  int as id,  
		varchar(255) as mensaje; 

define r_id, v_registro_recibosdet, v_contador integer;
define r_mensaje varchar(255);
define v_registro_recibosdet_todos varchar(40);

Let v_contador = 0;
Let r_id = 0;
Let v_registro_recibosdet = 0;
Let r_mensaje = '';
let v_registro_recibosdet_todos = '';

-- lectura del archivo con fecha actual
foreach
select rowid into v_registro_recibosdet from db_ingresos:ta_12_recibosdet where fecha = mdy(11,15,2017)  and caja = 'I1'  AND OPERACION = 2549
if v_contador > 0 then
	Let v_registro_recibosdet_todos = v_registro_recibosdet_todos ||','|| v_registro_recibosdet;	
else
	Let v_registro_recibosdet_todos = v_registro_recibosdet;	
Let v_contador = v_contador + 1;
end if;
Let r_id = 0;
let r_mensaje = v_registro_recibosdet_todos;
end foreach;

return r_id, r_mensaje;

end procedure;

create procedure "informix".mmeter_alta_folio(
V_Folio int, V_FechaS  char(10), V_Placa char(7), V_Infraccion int, V_Zona int, V_Estado int,
V_Direccion char(100), V_PosLong char(30), V_PosLat char(30), V_Marca char(30), V_Modelo char(30),
 V_LinkFoto1 char(150),V_LinkFoto2 char(150), V_Motiv varchar(250), V_Idmedio int)

returning
int as id,
char(50) as mensaje;

-- validar que no exista el folio
-- validar que sea a otra placa el folio capturado

define v_opc int ;
 define v_descrip char(50);
define p_placa char(7);
define p_numcalco int;
define p_turno char(1); 
define p_hora_ini datetime hour to minute; 
define p_hora_fin datetime hour to minute;
define v_fecha date;
define v_axo int;
define v_hora  datetime hour to minute;
define p_contarbajas int;

let v_fecha = mdy(v_fechas[4,5], v_fechas[1,2], v_fechas[7,10]);
let v_axo = year(v_fecha);
-- verificar si el folio ya fue pagado
select count(*)  into p_contarbajas from ta14_folios_histo where axo = v_axo and folio = v_folio;
if p_contarbajas = 0 then

select nvl(placa, '0')  into p_placa from ta14_folios_adeudo where axo = v_axo and folio = v_folio;
if p_placa is null then
   let v_opc =0;
   let v_descrip = 'Procede captura';
else
if p_placa = v_placa then
   let v_opc = -1;
   let v_descrip = 'Folio ya capturado a la placa ';
else
    let v_opc = -2;
   let v_descrip = 'Folio ya capturado a diferente placa ';
end if;
end if;

-- validar que calcomania verifica tipo y horario solo para infraccion 1

if v_opc = 0 and v_infraccion = 1 then
 select nvl(a.num_calco,0), nvl(a.turno,'0') , b.hora_ini , b.hora_fin ,  current hour to minute
 into p_numcalco , p_turno , p_hora_ini , p_hora_fin  , v_hora
 from ta14_calcomanias a , ta14_turnos b 
 where a.placa = v_placa  and v_fecha between a.fecha_inicial and a.fecha_fin  and
       a.turno = b.turno;

 if p_numcalco > 0 then
    if v_hora >= p_hora_ini and v_hora <= p_hora_fin then
        let v_opc = -3;
        let v_descrip = 'Tiene calcomania en Horario ';
    end if;
  end if;
end if;
 if v_opc = 0 then
    let V_LinkFoto1 = replace(V_LinkFoto1,' ' ,'');
    insert into ta14_folios_adeudo(axo, folio, fecha_folio, placa ,infraccion, estado ,vigilante ,
    num_acuerdo, fec_cap , usu_inicial , zona , espacio)  values(v_axo,v_folio,v_fecha, v_placa , v_infraccion, v_estado,1673,null,today,1673,v_zona,v_zona );
    insert into ta14_adicional_mmeters( axo, folio , Direccion , PosLong   , PosLat    ,
    Marca , Modelo, LinkFoto1, LinkFoto2 , Motivo, Idmedio )  values(v_axo, v_folio,V_Direccion , V_PosLong , V_PosLat,
   V_Marca , V_Modelo, V_LinkFoto1,V_LinkFoto2 , V_Motiv , V_Idmedio);
    let v_opc = 0;
    let v_descrip = 'Folio dado de alta';
 end if;   
else
    let v_opc =-6;
    let v_descrip = 'Folio en el historico, no procede el alta';
end if;
return v_opc , v_descrip ;

END PROCEDURE;

create procedure "informix".kioscopago_folios(pnumtrans int , impcertificado money(10,2), idmedio int)

returning  int , char(2), int, char(240), char(200) , char(28);
--Procedicimiento se utiliza en Kiosco
define varreca  int;
define varcaja  char(2);
define varoperacion int;
define concepto  char(60);
define concep  char(60);
define vplaca char(7);
define vdescrip char(240);
define conc1   char(60);
define conc2  char(60);
define conc3  char(60);
define conc4 char(60);
define conc1n   char(50);
define conc2n  char(50);
define conc3n  char(50);
define conc4n char(50);
define vnotif  char(200); 
define varnumf int    ;
define vimpact money(10,2); 
define vimpante money(10,2); 
define vimpmulta money(10,2);
define ctaredon integer;
define cta1 integer;
define cta2 integer;
define cta3 integer;
define lineanotif  int;
define vaxoini integer;
define vfolioini integer;
define vaxofin integer;
define vfoliofin integer;
define linea int;
define longconcep int;
define redon decimal(5,2);
define  v_linea100 char(100) ;
define v_linea28 char(28);
define vfol_ini integer;
define vfol_fin integer;
define daxo int;
define dfolio int;
define  dplaca char(7);
define  dacuerdo int;  
define varcontrol int;
define dcontar int;



select  placa,   foliosdescrip,  notifdescrip, axoini , folioini , axofin , foliofin, numfolios,   impactual, impanterior, impmulta 
into   vplaca , vdescrip,        vnotif, vaxoini , vfolioini , vaxofin , vfoliofin, varnumf,    vimpact, vimpante, vimpmulta

from ta14_kio_trans where numtrans = pnumtrans;
  let vfol_ini = (vaxoini * 1000000) + vfolioini;
  let vfol_fin = (vaxofin * 1000000) + vfoliofin;
 select  count(*)
       into      dcontar  
       from ta14_folios_adeudo  where placa = vplaca and 
       ((axo * 1000000) + folio) between vfol_ini and vfol_fin;
if dcontar > 0 then
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,5,idmedio);
	
let longconcep = length(vdescrip);
if longconcep >= 181 then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = vdescrip[181,240];
end if;
if (longconcep >= 121) and (longconcep <= 180) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = '';
end if;
if longconcep >= 61 and (longconcep <= 120) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = '';
let conc4 = '';
end if;
if longconcep <= 60  then
let conc1 = vdescrip[1,60];
let conc2 = '';
let conc3 = '';
let conc4 = '';
end if;
-- notificacion;
let longconcep = length(vnotif);
if longconcep >= 151 then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = vnotif[151,200];
let lineanotif  = 4;
end if;
if (longconcep >= 151) and (longconcep <= 150) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = '';
let lineanotif  = 3;
end if;
if (longconcep >= 51) and (longconcep <= 100) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = '';
let conc4n = '';
let lineanotif  = 2;
end if;
if longconcep <= 50  then
let conc1n = vnotif[1,50];
let conc2n = '';
let conc3n = '';
let conc4n = '';
let lineanotif  = 1;
end if;

let cta1 = 510900000;  -- 46305  A�o actual
let cta2 = 510930000;  -- 46320   a�os anteriores
let cta3 = 992100006;      -- 23315  gastos ejecucion sefin.
--- 46327  cuenta para inmovilizador.

let redon = vimpact + vimpante + vimpmulta - impcertificado;

if redon >= 0.51 then 
 let ctaredon = 550800000 ; -- 46902 redondeo
else
let ctaredon = 550800000;
let redon = redon * -1;
end if;

 select id_rec , caja  
 into varreca , varcaja 
  from db_ingresos:ta12_operacKiosco where id_usuario = idmedio; 


	select nvl(operacion,0) + 1
		into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;



insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,6, varoperacion);
let concepto = 'Pago de multas de estacionometros de la placa: ' || vplaca;	
 
   insert into db_ingresos:ta_12_recibos (fecha ,  id_rec,  caja ,  operacion,  importe ,  cvepago ,  id_modulo,    nombre ,    concepto ,  
                                                    id_usuario ,  fecha_act , id_rec_cta , fec_pagobco) 
                              values( today, varreca, varCaja, varOperacion, impcertificado, 'P' , 14, concepto,  concepto , idmedio, current , 1 , today);


	update	db_ingresos:ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;
	

execute PROCEDURE db_ingresos:linea_capturadiv(varoperacion, idmedio,impcertificado ,today ) into
 v_linea100, v_linea28;
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,7,idmedio);
let linea = 1;
if vimpact > 0 then

   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta1,  vimpact);
   let linea = linea +1;
end if;
if (vimpante > 0) and (vimpact > 0)  then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc2  ,   cta2,  vimpante);
   let linea = linea +1;
else 
 insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta2,  vimpante);
   let linea = linea +1;
end if;
if linea = 3 then  
  let  concep = conc3;
else 
let concep = conc2;
end if;

if vimpmulta > 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  ,   cta3,  vimpmulta);
   let linea = linea +1;
end if;
if linea = 4 then  
  let  concep = conc4;
else 
let concep = conc3;
end if;

if redon <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , ctaredon ,  redon);
   let linea = linea +1;
else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , 0 , 0);
   let linea = linea +1;
end if;

if linea = 4 then
    insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc4  , 0 ,  0); 
end if;

if  lineanotif  = 4 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 8 ,        conc4n  ,   0,  0);
end if;
if  lineanotif  = 3 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
end if;
if  lineanotif  = 2 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);

end if;
if  lineanotif  = 1 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  
end if;

--
--dar de baja folios pagados.
  

   foreach 
       select  axo , folio,  placa, num_acuerdo
       into      daxo, dfolio,  dplaca, dacuerdo  
       from ta14_folios_adeudo  where placa = vplaca and 
       ((axo * 1000000) + folio) between vfol_ini and vfol_fin
 
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, 3, 501 , zona , espacio ,0
        from ta14_folios_adeudo 
     where axo = daxo and folio = dfolio;
     let varcontrol =  dbinfo("sqlca.sqlerrd1"); 

    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
       values ( varcontrol , today, varreca , varcaja, varoperacion);   
   delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
    if dacuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = today 
     where num_acuerdo = dacuerdo and fechapago is null;
      end if;
   end foreach;
--



--
return 
varreca, varcaja, varoperacion,  vdescrip,        vnotif, v_linea28;
else
return
0,'',0,'','','';
end if;
end procedure;

create procedure "informix".admin_adeudos_detalle_19 ( p_opc int , pnumesta int, p_axof int , p_mesf int  )

  returning
   -- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
      int as rubro ,int as concepto ,int as cta  , varchar(30) as referencia,  varChar(120) as descripcion,
      decimal(12,2) as monto ,decimal(12,2) as acumulado ;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_pubid int;
 define v_porc_recgos int;
define v_descto_recgos money(15,2);
define v_fec_ini_cobra_rgos date;

define vv_status		int;		-- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda		varchar(50);	-- adicionado por Gil para generar registro de recargo 01/06/2018		

 begin
    on exception in (-958)
       delete from tmp_publicos;
    end exception;
    create temp table tmp_publicos(
      orden  smallint,
      id_pub  int ,
      axo int,
      mes int, 
      imp_pagar  money(12,2) ,
      cta_aplicacion int
     ) with no log;
  end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;

Let vv_status = 0;							-- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5';			-- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda;	-- adicionado por Gil para generar registro de recargo 01/06/2018

--select *  from pubmain where numesta = 1320;
select id , fecha_inicial + 6 into p_pubid , v_fec_ini_cobra_rgos from pubmain where numesta = pnumesta;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
        let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;

 FOREACH
  select b.cuentaapl, b.tipo , a.axo , a.mes , a.concepto ,  a.ade_importe
   into v_cuentaapl , v_tipochar, v_axo , v_mes , v_concepto , v_adeudo
  from pubadeudo a, pubtipoadeudo b
  where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo <> 10 and a.tipo = b.tipo_id  
  order by a.axo , a.mes

  
 

 let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
  let v_acumulado = v_acumulado + v_adeudo;
  insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(1, p_pubid, v_axo ,v_mes, v_adeudo,v_cuentaapl);
 return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
end foreach;

  FOREACH
  select Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe
   into v_axo , v_mes , perioI , v_concepto, v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
 and  tipo = 10  order by axo , mes
-- porcentaje de descuento en recargos 
  select porcentaje into v_porc_recgos from pub_descrec 
    where pubmain_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
    end if; 

 select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     if v_porcentaje is null then
        let v_porcentaje = 0;
     end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    let v_referencia =  v_axo || '-' || lpad(v_mes,2,'0');
    if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
   --    let v_recargos =   v_recargos - v_descto_recgos;
    end if;
--  verificar si es el primera mesualidad para quitar recargos o cobrarles
   if (today - v_fec_ini_cobra_rgos ) <= 6 then
       let  v_descto_recgos = 0;
       let v_recargos =  0;
   end if;



--  totales
    if v_axo = year(today) then
      let v_cuota = v_cuota + v_adeudo;
      let v_rectot = v_rectot + v_recargos;
      if v_adeudo > 0 then
           let v_acumulado = v_acumulado + v_adeudo;
        insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_adeudo, 370100000);
       return 0 ,0 , 370100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
      end if;
     if v_recargos > 0 then
         let v_acumulado = v_acumulado + v_recargos;
      let v_concepto1 = 'Recargos ' || v_concepto;
      insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
     return 0 ,0 , 390600000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
     end if;
        if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
       insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_descto_recgos, 390640000);
     return 0 ,0 , 390640000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
      
     end if;
    else
     let v_cuota_r = v_cuota_r + v_adeudo;
     let v_rectot_r = v_rectot_r + v_recargos;
    if v_adeudo > 0 then
          let v_acumulado = v_acumulado + v_adeudo;
        insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_adeudo, 370130000);
        return 0 ,0 , 370130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    end if;
    if v_recargos > 0 then
       let v_acumulado = v_acumulado + v_recargos; 
       let v_concepto1 = 'Recargos ' || v_concepto;
       insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
        return 0 ,0 , 390600000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
    end if;
   if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
        insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_descto_recgos, 390640000);
     return 0 ,0 , 390640000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
      
     end if;
 end if;



end foreach;
end procedure
;

create procedure "informix".admin_adeudos_detalle_19desrec ( p_opc int , pnumesta int, p_axof int , p_mesf int  )

  returning
   -- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
      int as rubro ,int as concepto ,int as cta  , varchar(30) as referencia,  varChar(120) as descripcion,
      decimal(12,2) as monto ,decimal(12,2) as acumulado ;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_pubid int;
 define v_porc_recgos int;
define v_descto_recgos money(15,2);

define vv_status		int;		-- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda		varchar(50);	-- adicionado por Gil para generar registro de recargo 01/06/2018		

 begin
    on exception in (-958)
       delete from tmp_publicos;
    end exception;
    create temp table tmp_publicos(
      orden  smallint,
      id_pub  int ,
      axo int,
      mes int, 
      imp_pagar  money(12,2) ,
      cta_aplicacion int
     ) with no log;
  end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;

Let vv_status = 0;							-- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5';			-- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda;	-- adicionado por Gil para generar registro de recargo 01/06/2018

select id into p_pubid from pubmain where numesta = pnumesta;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
        let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
 FOREACH
  select b.cuentaapl, b.tipo , a.axo , a.mes , a.concepto ,  a.ade_importe
   into v_cuentaapl , v_tipochar, v_axo , v_mes , v_concepto , v_adeudo
  from pubadeudo a, pubtipoadeudo b
  where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo <> 10 and a.tipo = b.tipo_id  
  order by a.axo , a.mes

  
 

 let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
  let v_acumulado = v_acumulado + v_adeudo;
  insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(1, p_pubid, v_axo ,v_mes, v_adeudo,v_cuentaapl);
 return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
end foreach;

  FOREACH
  select Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe
   into v_axo , v_mes , perioI , v_concepto, v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio
 and  tipo = 10  order by axo , mes
-- porcentaje de descuento en recargos 
  select porcentaje into v_porc_recgos from pub_descrec 
    where pubmain_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
    end if; 

 select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     if v_porcentaje is null then
        let v_porcentaje = 0;
     end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    let v_referencia =  v_axo || '-' || lpad(v_mes,2,'0');
    if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
   --    let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
--  totales
    if v_axo = year(today) then
      let v_cuota = v_cuota + v_adeudo;
      let v_rectot = v_rectot + v_recargos;
      if v_adeudo > 0 then
           let v_acumulado = v_acumulado + v_adeudo;
        insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_adeudo, 370100000);
       return 0 ,0 , 370100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
      end if;
     if v_recargos > 0 then
         let v_acumulado = v_acumulado + v_recargos;
      let v_concepto1 = 'Recargos ' || v_concepto;
      insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
     return 0 ,0 , 390600000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
     end if;
        if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
       insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_recargos, 390640000);
     return 0 ,0 , 390400000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
      
     end if;
    else
     let v_cuota_r = v_cuota_r + v_adeudo;
     let v_rectot_r = v_rectot_r + v_recargos;
    if v_adeudo > 0 then
          let v_acumulado = v_acumulado + v_adeudo;
        insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_adeudo, 370130000);
        return 0 ,0 , 370130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    end if;
    if v_recargos > 0 then
       let v_acumulado = v_acumulado + v_recargos; 
       let v_concepto1 = 'Recargos ' || v_concepto;
       insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
        return 0 ,0 , 390600000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
    end if;
   if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
        insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
              values(2, p_pubid, v_axo ,v_mes, v_recargos, 390640000);
     return 0 ,0 , 390400000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
      
     end if;
 end if;



end foreach;
end procedure;

create procedure "informix".admin_adeudos_detalle_23b ( p_opc int , pnumesta int, p_axof int , p_mesf int  )

  returning
   -- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
      int as rubro ,int as concepto ,int as cta  , varchar(30) as referencia,  varChar(120) as descripcion,
      decimal(12,2) as monto ,decimal(12,2) as acumulado ;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_pubid int;
define agrupar char(6);
define v_tipo int;
define no_recargos int;
define v_porc_recgos decimal(5,2);define v_descto_recgos money(15,2);

define vv_status		int;		-- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda		varchar(50);	-- adicionado por Gil para generar registro de recargo 01/06/2018		

 begin
    on exception in (-958)
       delete from tmp_exclusivos;
    end exception;
    create temp table tmp_exclusivos(
      orden  smallint,
      id_exc  int ,
      axo int,
      mes int, 
      imp_pagar  money(12,2) ,
      cta_aplicacion int,
      referencia varchar(30),
      concepto   varChar(120)
     ) with no log;
  end;


let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--set debug file to 'Exclusivo.log';
--trace on;

Let vv_status = 0;							-- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5';			-- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda;	-- adicionado por Gil para generar registro de recargo 01/06/2018

select id into p_pubid from ex_contrato where no_exclusivo = pnumesta;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
        let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+ mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
let no_recargos = 0;
--
 FOREACH
  select b.cuentaapl, b.tipo , a.axo , a.mes ,(axo  * 100 )+ mes ,  a.concepto ,  a.ade_importe
   into v_cuentaapl , v_tipochar, v_axo , v_mes , perioi , v_concepto , v_adeudo
  from ex_adeudo a, pubtipoadeudo b
  where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo <> 20 and a.tipo = b.tipo_id  
  order by a.axo , a.mes
   if v_cuentaapl = 370700001 then
      let no_recargos = 1;
   end if;
 let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
  let v_acumulado = v_acumulado + v_adeudo;
     insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto )
                       values(1, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl , v_referencia , v_concepto );
  --return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    if  v_cuentaapl = 370710002 then
       -- calcula recargos de refrendo
         execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes ) into v_recargos;
       -- porcentaje de descuento

         -- calcula recargos de refrendo
          select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
           ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
            let v_descto_recgos = 0;
           if v_porc_recgos is null then
              let v_porc_recgos = 0;
           end if;
          if v_porc_recgos > 0 and v_recargos > 0 then 
            -- calcular descuento en recargos.
                let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
             end if;
          if v_recargos > 0 then 
              let v_acumulado = v_acumulado + v_recargos;
              let v_concepto1 = 'Recargos ' || v_concepto; 
              insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                     values(1, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
  --   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
          end if;
         if v_descto_recgos <> 0 then
            let v_acumulado = v_acumulado + v_descto_recgos;
            let v_concepto1 = 'Descto Recgos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(1, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
   -- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
          end if; 
     end if;
end foreach;
--
FOREACH
  select  axo || lpad(mes,2,'0')  , tipo , Axo, mes, (axo  * 100 )+ mes , 
    concepto, ade_importe 
   into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid and  tipo = 20 and  (axo * 100 + mes) <= perio 
  order by 1,3,4
   select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
 let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');

 if v_tipo = 20 then
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
   --    let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
--  totales
    if v_axo = year(today) then
      let v_cuota = v_cuota + v_adeudo;
      let v_rectot = v_rectot + v_recargos;
      if v_adeudo > 0 then
           let v_acumulado = v_acumulado + v_adeudo;
           insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto )
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364100000, v_referencia , v_concepto);
 --      return 0 ,0 , 364100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
      end if;
       if no_recargos = 1 then
            let v_recargos = 0;
            let v_descto_recgos = 0;
        end if;
  
    if v_recargos > 0 then 
       let v_acumulado = v_acumulado + v_recargos;
       let v_concepto1 = 'Recargos ' || v_concepto; 
      
      insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(3, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
  --   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
     end if;
     if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
   -- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
     end if;
    else
     let v_cuota_r = v_cuota_r + v_adeudo;
     let v_rectot_r = v_rectot_r + v_recargos;
    if v_adeudo > 0 then
          let v_acumulado = v_acumulado + v_adeudo;
         insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364130000, v_referencia , v_concepto);
  --   return 0 ,0 , 364130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    end if;
      if no_recargos = 1 then
            let v_recargos = 0;
            let v_descto_recgos = 0;
      end if;
    if v_recargos > 0 then
       let v_acumulado = v_acumulado + v_recargos; 
       let v_concepto1 = 'Recargos ' || v_concepto;
       insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(3, p_pubid, v_axo ,v_mes, v_recargos, 390700000, v_referencia , v_concepto1);
  --    return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
    end if;
 if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1);
  --  return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
     end if;
 end if;



end foreach;
 let v_acumulado = 0 ;
 FOREACH select cta_aplicacion , referencia , concepto , imp_pagar 
 into v_cuentaapl, v_referencia , v_concepto , v_cuota 
 from tmp_exclusivos order by axo , mes, orden 
 let v_acumulado = v_acumulado + v_cuota;
   return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_cuota, v_acumulado  with resume;
 end foreach;
--trace off;
end procedure;

create procedure "informix".admin_adeudos_detalle_23a ( p_opc int , pnumesta int, p_axof int , p_mesf int  )

  returning
   -- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
      int as rubro ,int as concepto ,int as cta  , varchar(30) as referencia,  varChar(120) as descripcion,
      decimal(12,2) as monto ,decimal(12,2) as acumulado ;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_pubid int;
define agrupar char(6);
define v_tipo int;
define no_recargos int;
define v_porc_recgos decimal(5,2);define v_descto_recgos money(15,2);

define vv_status		int;		-- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda		varchar(50);	-- adicionado por Gil para generar registro de recargo 01/06/2018		

 begin
    on exception in (-958)
       delete from tmp_exclusivos;
    end exception;
    create temp table tmp_exclusivos(
      orden  smallint,
      id_exc  int ,
      axo int,
      mes int, 
      imp_pagar  money(12,2) ,
      cta_aplicacion int,
      referencia varchar(30),
      concepto   varChar(120)
     ) with no log;
  end;


let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--set debug file to 'Exclusivo.log';
--trace on;

Let vv_status = 0;							-- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5';			-- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda;	-- adicionado por Gil para generar registro de recargo 01/06/2018

select id into p_pubid from ex_contrato where no_exclusivo = pnumesta;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
        let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+ mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
let no_recargos = 0;
--
 FOREACH
  select b.cuentaapl, b.tipo , a.axo , a.mes ,(axo  * 100 )+ mes ,  a.concepto ,  a.ade_importe
   into v_cuentaapl , v_tipochar, v_axo , v_mes , perioi , v_concepto , v_adeudo
  from ex_adeudo a, pubtipoadeudo b
  where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
  and a.tipo <> 20 and a.tipo = b.tipo_id  
  order by a.axo , a.mes
   if v_cuentaapl = 370700001 then
      let no_recargos = 1;
   end if;
 let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
  let v_acumulado = v_acumulado + v_adeudo;
     insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto )
                       values(1, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl , v_referencia , v_concepto );
  --return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    if  v_cuentaapl = 370710002 then
       -- calcula recargos de refrendo
          select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
           ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
            let v_descto_recgos = 0;
           if v_porc_recgos is null then
              let v_porc_recgos = 0;
           end if;
        select sum(porcentaje_mes) into v_porcentaje from recargos
            where (axo * 100 + mes) between  perioI and per_recgos;
      
            let v_recargos = (v_porcentaje * v_adeudo ) / 100;
              if v_recargos is null then
              let v_recargos = 0;
             end if;
             if v_porc_recgos > 0 and v_recargos > 0 then 
            -- calcular descuento en recargos.
                let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
             end if;
          if v_recargos > 0 then 
       let v_acumulado = v_acumulado + v_recargos;
       let v_concepto1 = 'Recargos ' || v_concepto; 
      
      insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(1, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
  --   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
     end if;
     if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(1, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
   -- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
     end if; 
    end if;
end foreach;
--
FOREACH
  select  axo || lpad(mes,2,'0')  , tipo , Axo, mes, (axo  * 100 )+ mes , 
    concepto, ade_importe 
   into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid and  tipo = 20 and  (axo * 100 + mes) <= perio 
  order by 1,3,4
   select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
 let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');

 if v_tipo = 20 then
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;
     
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
   --    let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
--  totales
    if v_axo = year(today) then
      let v_cuota = v_cuota + v_adeudo;
      let v_rectot = v_rectot + v_recargos;
      if v_adeudo > 0 then
           let v_acumulado = v_acumulado + v_adeudo;
           insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto )
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364100000, v_referencia , v_concepto);
 --      return 0 ,0 , 364100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
      end if;
       if no_recargos = 1 then
            let v_recargos = 0;
            let v_descto_recgos = 0;
        end if;
  
    if v_recargos > 0 then 
       let v_acumulado = v_acumulado + v_recargos;
       let v_concepto1 = 'Recargos ' || v_concepto; 
      
      insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(3, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
  --   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
     end if;
     if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
   -- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
     end if;
    else
     let v_cuota_r = v_cuota_r + v_adeudo;
     let v_rectot_r = v_rectot_r + v_recargos;
    if v_adeudo > 0 then
          let v_acumulado = v_acumulado + v_adeudo;
         insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364130000, v_referencia , v_concepto);
  --   return 0 ,0 , 364130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    end if;
      if no_recargos = 1 then
            let v_recargos = 0;
            let v_descto_recgos = 0;
      end if;
    if v_recargos > 0 then
       let v_acumulado = v_acumulado + v_recargos; 
       let v_concepto1 = 'Recargos ' || v_concepto;
       insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(3, p_pubid, v_axo ,v_mes, v_recargos, 390700000, v_referencia , v_concepto1);
  --    return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
    end if;
 if v_descto_recgos <> 0 then
         let v_acumulado = v_acumulado + v_descto_recgos;
        let v_concepto1 = 'Descto Recgos ' || v_concepto;
        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1);
  --  return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
     end if;
 end if;



end foreach;
 let v_acumulado = 0 ;
 FOREACH select cta_aplicacion , referencia , concepto , imp_pagar 
 into v_cuentaapl, v_referencia , v_concepto , v_cuota 
 from tmp_exclusivos order by axo , mes, orden 
 let v_acumulado = v_acumulado + v_cuota;
   return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_cuota, v_acumulado  with resume;
 end foreach;
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".sp14_cons_apremio ( parPlaca Char(7) )
{######################################################################
#  Procedimiento:    sp14_cons_apremio
#  Descripcion:      Interfaz de consulta de APREMIOS por placa para ESTACIONAMIENTOS
#  Parametros de entrada: parPlaca : Placa a Consulta
#                    
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            Junio 2018   
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                  --returning 	Integer as folio,
	--		Date as Fecha_emision,
	--	Money(12,2) as Importe_gastos,
	--	Varchar(120) as Descripcion,
	--	Money(12,2) as Importe_acumulado;

                returning 	Varchar(120) as Descripcion,
		Money(12,2) as Importe_acumulado;

define vN_folio				Integer;
define vN_fecha_emision			Date;
define v_gastos, v_importe_acumulado		money(12,2); 
define v_FolReq				Integer;
define v_DetFolReq				varchar(120);

Let v_FolReq = 0;
Let v_DetFolReq = 'Docto(s) Requerido(s) : ';
Let vN_folio = 0;
Let v_gastos = 0;
Let v_importe_acumulado = 0;

FOREACH
SELECT   z.folio, z.fecha_emision, z.importe_gastos
INTO vN_folio , vN_fecha_emision , v_gastos 
FROM dbestacion:ta_padron w, db_ingresos:ta_15_apremios z
WHERE w.placa = parPlaca
AND z.modulo = 14 and z.control_otr = w.id 
AND z.clave_practicado = 'P' and z.fecha_practicado is not null and z.vigencia = 1
ORDER BY z.folio

if v_FolReq > 0 then
	Let v_DetFolReq = v_DetFolReq || ',' || vN_folio || '-' || vN_fecha_emision;
else
	Let v_DetFolReq = v_DetFolReq || vN_folio || '-' || vN_fecha_emision;
                  Let v_FolReq = v_FolReq + 1;
end if;

Let v_importe_acumulado = v_importe_acumulado + v_gastos;

--RETURN vN_folio, vN_fecha_emision, v_gastos, v_DetFolReq, v_importe_acumulado  with resume;
Let vN_folio = 0;
Let v_gastos = 0;

END FOREACH;

	RETURN v_DetFolReq, v_importe_acumulado;

end procedure;

CREATE PROCEDURE "informix".admin_adeudos_detalle_16n(parPlaca char(7), parref varchar(20))
				
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_16
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de Folios de estacionometros en el sistema ADMIN
#
#  Parametros        p_tipo     = numero de placa
#  de entrada:      
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            13 Septiembre 2013   
#  Modificado:       6/6/2018  para integrar el cobro de gastos por notificaciones.
#  Llamado por:      Procedimiento admin_adeudos_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int         as NoRubro,
int         as NoConcepto, 
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion, 
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
define  var_refers bigint;
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
--
  begin
    on exception in (-958)
       delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
      placa  char(7) ,
      axo int,
      folio int, 
      fecha_folio date,
      estado smallint,
      infraccion smallint,
      tarifa  money(12,2), 
      porc_cobro int,
      num_acuerdo int,
      imp_pagar  money(12,2) ,
      cta_aplicacion integer
     ) with no log;
  end;

if parref = '' then
   let par_axo = year(today);
   let par_folio = 99999999;
   let var_refer = (par_axo * 100000000 ) + par_folio;
else
   let par_axo = (parref[1,4]) *1;
   let par_folio = (parref[6,13]) *1;
   let var_refer = (par_axo * 100000000 ) + par_folio;
end if;
--
-- verificar si hay padron
 --foreach 

   
   select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;

--end foreach;

--select * from ta_padron

let v_Acumulado = 0;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
     -- verificar si tienen gastos para su cobro																								
    if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
            let v_Acumulado = v_Acumulado + v_gastos ;
           insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
           porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
          values ( parplaca , year(vN_fecha_emision), vN_folio, vN_fecha_emision, 0 , 0, v_gastos ,
           100 , 0 , v_gastos , 550620011);
           let  v_Referencia  = year(vN_fecha_emision) || '-' || lpad(vN_folio, 8 ,'0') ;  
           let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || vN_fecha_emision || ' Notificacion';
           return 0,0,550620011,v_Referencia,v_Descripcion,v_gastos,v_Acumulado with resume;
     end foreach;
    end if;
   end if;
     --
foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca 
and (( a.axo * 100000000 ) +  a.folio) <= var_refer
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 1, 2 asc
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;
-- select * from ta14_tarifas
let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(vfecha) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;

if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 510930000 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
  let vimp_apagar = vporc_cobro / 100 * vtarifa;
  let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;  
  let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra;
  let v_Acumulado = v_Acumulado + vimp_apagar;

  insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
      porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
   values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,
    vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
  return 0,0,vctaapl,v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;
   end foreach;
else 
 return 0,0,0,'','',0,0;
end if;
end procedure
;

CREATE PROCEDURE "informix".admin_pago_16n(parPlaca char(7), parref varchar(20),
                parImpCertificado money(15,2),
                parimpredondeo   money(8,2),
                parimpcredito   money(15,2),
    		parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
	        ParFolioRecibo  char(10), --Folio del Recibo (ADMIN)
	        ParFechaRecibo  date ,   --Fecha del Recibo
	        ParReca         int, --No. de Recaudadora
	        ParCaja  char(2) ,--No. de Caja
	        ParCajero  char(10),	 --Clave usuario
                parCentro  integer)
				
{######################################################################
#  Procedimiento:    admin_pago_16
#  Descripcion:      Interfaz de pago de adeudo para el cobro de Folios de estacionamiento en el sistema ADMIN
#
#  Parametros        parPlaca     = numero de placa
#  de entrada:       Parref       = Referencia maxima a cobrar
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            24 Octubre 2013   
#
#  Llamado por:      Procedimiento sp_pago en dbingresosw
#  Llama a:          
#  
######################################################################}

returning smallint , varchar(50);
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define x_placa  char(7) ;
define x_axo int;
define x_folio int; 
define x_fecha_folio date;
define x_estado smallint;
define x_infraccion smallint;
define x_tarifa  money(12,2); 
define x_porc_cobro int;
define x_num_acuerdo int;
define x_imp_pagar  money(12,2);
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define daxo int;
define dfolio int;
define dplaca char(7);
define dacuerdo  int;
define  dtarifa money(12,2);
define  dporc_cobro int;
define  dimp_pagar money(12,2); 
define v_id_usuario int;
define v_cta int;
define linea int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define v_r char(1);
define v_ca int;
define v_cta_aplic int;
define v_fecha_folio date;

   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -11, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE ESTACIONOMETROS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -1, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
set debug file to 'pagoFolio';
trace on;
  let v_r = 'N';

select count(*) into v_ca from tmp_folios ;
 if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;

--OBTENER EL ID USUARIO CAJERO;
select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = ParCajero;

if  v_id_usuario    is null then
 let v_id_usuario   = 335;  -- usuario ADMIN
end if;


    BEGIN WORK;
   let v_r = 'S';
 -- select * from db_ingresos:ta_12_recibos where id_modulo = 14 and fecha > '1/1/2013'
   insert into db_ingresos:ta_12_recibos(fecha , id_rec , caja , operacion ,  importe , cvepago ,
    id_modulo ,  id_regmodulo,  id_rec_cta , regmunur ,
    mesdesde , axodesde, meshasta, axohasta ,
    nombre ,  domicilio , concepto , rfcini , rfcnumero ,
    rfccolonia,  obra ,  axofolio , id_usuario , fecha_act , descripcion ,
    lugar_pago , id_centro ,  foliorecibo) 
   values (ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN     , parImpCertificado, 'P' ,
    14, 0, 0, 'F' ,
    0, 0, 0, 0, 'Pago de multas de estacionometros de la placa: ' || parPlaca, '','Pago de multas de estacionometros de la placa: ' || parPlaca , '', 0,
    0,0,0, v_id_usuario ,current , '' , 0,parCentro, ParFolioRecibo ) ;
   let linea = 1;
   foreach 
   select cta_aplicacion , sum(imp_pagar) into  v_cta , v_importe
      from  tmp_folios where placa = parPlaca
      group by 1
 
   insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 'Suma del importe de folios'  , v_cta ,  v_importe);
   let linea = linea +1;

  end foreach;

if parimpredondeo <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 'REDONDEO' , 550800000,  parimpredondeo);
   let linea = linea +1;
end if;


   foreach 
       select  axo , folio,  placa, num_acuerdo  ,
              tarifa ,  porc_cobro ,  imp_pagar  , cta_aplicacion , fecha_folio
       into      daxo, dfolio,  dplaca, dacuerdo  ,
           dtarifa ,  dporc_cobro ,  dimp_pagar  , v_cta_aplic , v_fecha_folio
         from  tmp_folios where placa = parPlaca
    if v_cta_aplic <> 550620011 then
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial,
        13, v_id_usuario , zona , espacio ,0
        from ta14_folios_adeudo 
     where axo = daxo and folio = dfolio;
     let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    
    insert into ta14_folios_hco (control , importe_infraccion , porcentaje , importe_cobrado)
     values(varcontrol ,  dtarifa ,  dporc_cobro ,  dimp_pagar );


    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
       values ( varcontrol ,ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN);   
   delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
    if dacuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = today 
       where num_acuerdo = dacuerdo and fechapago is null;
      end if;


   else
   ---  pagar las notificaciones
    -- select * from db_ingresos:ta_15_apremios
        update db_ingresos:ta_15_apremios set fecha_pago = ParFechaRecibo
       , recaudadora = ParReca , caja = ParCaja , operacion  = parID_ADMIN, importe_pago = importe_gastos ,
         vigencia = 2
         where modulo = 14 and folio = dfolio and fecha_emision = v_fecha_folio and  fecha_pago is null;
        
  end if;


   end foreach;

  --- BORRAR TEMPORAL
       delete from tmp_folios;
   COMMIT WORK;	
   return 0,'Procedimiento Completo' ;  
trace off;
end procedure
;

CREATE PROCEDURE "informix".kiosco_parkingcons_n(parPlaca char(7), parMedio int)
				
	 returning integer as id, smallint as clave , smallint as axo,  char(7) as placa , int as folio , date as fechaFolio ,  smallint as estado,
         smallint as infraccion , money(7,2) as tarifa, smallint as porcentaje , money(7,2) as a_pagar, int as acuerdo , int as cta_aplic , char(100) as observacion  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define v_rowid integer;

if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then


foreach 

Select a.rowid ,a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
v_rowid ,vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 3 asc
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(vfecha) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;
-- antes del 1 de julio 2014
--if year(today) = year(vfecha) then
--   let vctaapl = 510900000 ;
--else
--   let vctaapl = 925100001 ;
--end if;
if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 510930000 ;
end if;
-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
v_rowid,0,vaxo,parplaca, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

0,1,0,parplaca, 0,0,0,0,0,0,0,0,0,'No existen folios para esta placa';
end if;
end procedure
;

CREATE PROCEDURE "informix".e_parkingconsn(parPlaca char(7), parMedio int)
				
	 returning smallint , smallint,  char(7) ,      int , date ,  smallint , Char(40) , money(7,2), smallint ,  money(7,2),        int ,            int ,                         char(100)  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define infra_descrip char(40);
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
--set debug file to "parkivan.log";
--trace on;
 select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;


if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
   if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
     return 
       0,year(vN_fecha_emision),parplaca, vN_folio, vN_fecha_emision, 0 , 'Notificaci�n', v_gastos ,
       100 , v_gastos , 0 , 550620011 , 'Ok' with resume;

     end foreach;
    end if;
   end if;

foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
, infra.descripcion
into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b , ta14_infraccion infra, outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and infra.num_clave = a.infraccion and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A' 
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;

--select count(*) 
--       into dias_habil 
--       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha+1 and today;

--     while x1 <= fecha_hoy 
--        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
--          let dias_cuantos =dias_cuantos+1;
--         end if;
--     let x1 = x1+1;
--   end while;


  if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado , infra_descrip, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,'',0,0,0,0,0,'No existen folios para esta placa';
end if;

end procedure
;

CREATE PROCEDURE "informix".e_parkingconstest(parPlaca char(7), parMedio int)
				
	 returning smallint , smallint,  char(7) ,      int , date ,  smallint , Char(40) , money(7,2), smallint ,  money(7,2),        int ,            int ,                         char(100)  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define infra_descrip char(40);
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
--set debug file to "parkivan.log";
--trace on;

select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
  if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
     return 
       0,year(vN_fecha_emision),parplaca, vN_folio, vN_fecha_emision, 0 , 'Notificaci�n', v_gastos ,
       100 , v_gastos , 0 , 550620011 , 'Ok' with resume;
     end foreach;
    end if;
   end if;

foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
, infra.descripcion
into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b , ta14_infraccion infra, outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and infra.num_clave = a.infraccion and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A' 
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;

--select count(*) 
--       into dias_habil 
--       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha+1 and today;

--     while x1 <= fecha_hoy 
--        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
--          let dias_cuantos =dias_cuantos+1;
--         end if;
--     let x1 = x1+1;
--   end while;


  if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado , infra_descrip, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,'',0,0,0,0,0,'No existen folios para esta placa';
end if;
trace off;
end procedure
;

CREATE PROCEDURE "pgmoreno".sp14_ind_esta_publicos_01()
{######################################################################
#  Procedimiento:    sp14_ind_esta_publicos_01
#  Descripcion:      Interfaz de consulta de ESTACIONAMIENTOS PUBLICOS para INDICADORES
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento vencidos dentro de ESTACIONAMIENTOS PUBLICOS
#  Llama a:          
#  
######################################################################}
                returning char(50) as concepto,
                               integer as cant_contratos,
                               Money(12,2) as importe_derechos;
      
define v_id				int;
         

define v_contador				Integer;
define v_sum_importe			Money(12,2);
define v_tot_importe				Money(12,2);

define axovig, mesvig, perio 			Integer;
define v_fecha_limite 			date;

Let v_id			= 0;
  
Let v_contador 		= 0;
Let v_sum_importe 		= 0;
Let v_tot_importe		= 0;

Let axovig 		= 0;
Let mesvig 		= 0;
Let perio 			= 0;

Let axovig = year(today) ;
Let mesvig = month(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
	if v_fecha_limite > today then
		let mesvig = mesvig -1;
	end if;
	let perio = (axovig *100 )+mesvig;

foreach
SELECT id INTO v_id FROM pubmain  WHERE movto_cve <> 'C'

	SELECT sum(ade_importe) INTO v_sum_importe  FROM pubadeudo
	WHERE pubmain_id = v_id AND (axo * 100 + mes) <= perio and tipo = 10;
	if v_sum_importe > 0 then
		Let v_contador 	= v_contador + 1;
		Let v_tot_importe	= v_tot_importe + v_sum_importe;
	end if;

	Let v_id = 0;
	Let v_sum_importe = 0;

end foreach;

return 'ESTACIONAMIENTOS PUBLICOS' , v_contador, v_tot_importe   with resume;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_ind_esta_exclusivos_01()
{######################################################################
#  Procedimiento:    sp14_ind_esta_exclusivos_01
#  Descripcion:      Interfaz de consulta de ESTACIONAMIENTOS EXCLUSIVOS para INDICADORES
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento vencidos dentro de ESTACIONAMIENTOS EXCLUSIVOS
#  Llama a:          
#  
######################################################################}
                returning char(50) as concepto,
                               integer as cant_contratos,
                               Money(12,2) as importe_derechos;
               
define v_id				int;

define v_contador				Integer;
define v_sum_importe			Money(12,2);
define v_tot_importe				Money(12,2);
define axovig, mesvig, perio 			Integer;
define v_fecha_limite 			date;
  
Let v_id			= 0;

Let v_contador 		= 0;
Let v_sum_importe 		= 0;
Let v_tot_importe 		= 0;

Let axovig = 0;
Let mesvig = 0;
Let perio = 0;

Let axovig = year(today) ;
Let mesvig = month(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
	if v_fecha_limite > today then
		let mesvig = mesvig -1;
	end if;
	let perio = (axovig *100 )+mesvig;
	
foreach
SELECT id INTO v_id FROM ex_contrato WHERE estatus <> 'C'

	SELECT sum(ade_importe) INTO v_sum_importe FROM ex_adeudo
	WHERE ex_contrato_id = v_id AND (axo * 100 + mes) <= perio and tipo in (20,26,27);
	if v_sum_importe > 0 then
		Let v_contador 	= v_contador + 1;
		Let v_tot_importe	= v_tot_importe + v_sum_importe;
	end if;

	Let v_id = 0;
	Let v_sum_importe = 0;

end foreach;

return 'ESTACIONAMIENTOS EXCLUSIVOS' , v_contador, v_tot_importe   with resume;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_ind_esta_estacionometros_01()
{######################################################################
#  Procedimiento:    sp14_ind_esta_folios_01
#  Descripcion:      Interfaz de consulta de ESTACIONOMETROS para INDICADORES
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013   
#
#  Llamado por:      Procedimiento vencidos dentro de ESTACIONOMETROS
#  Llama a:          
#  
######################################################################}
                returning char(50) as concepto,
                               integer as cant_contratos,
                               Money(12,2) as importe_derechos;
               

define v_contador				Integer;
define v_sum_importe			Money(12,2);
  
Let v_contador = 0;
Let v_sum_importe = 0;

SELECT count(*) INTO v_contador FROM ta14_folios_adeudo;

SELECT sum(b.tarifa) INTO v_sum_importe FROM ta14_folios_adeudo a, ta14_tarifas b
WHERE b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo);

return 'FOLIOS ESTACIONOMETROS' , v_contador, v_sum_importe   with resume;

end procedure;

create PROCEDURE "pgmoreno".cons14_solicrep_c ( parFec_Inicio Date, parFec_Fin Date )

Returning  char(7) as Placa,
	int as Aso,
	int as Folio,
	int as Clave,
	date as Fecha_Folio,
	money(12,2) as Tarifa,
	decimal(5,2) as Porc,
	money(12,2) as aPagar,
	varchar(100) as AutoridadOtorga,
	varchar(50) as NombreOtorgo,
	date as Fecha_Otorga,
	date as Fecha_Pago;

define v_Contador					int;
define vif_clave					int;
define vif_descripcion				char(30);

define v_Codigo_Movto, v_Sub_Codigo			int;
define v_Descrip_Movto, v_Descrip_SubMovto		varchar(40);
define v_Descripcion					varchar(80);

define v_Axo, v_Folio				int;
define v_Cve					int;
define v_Fecha_Movto, v_Fecha_Folio, v_Fec_Cap	date;
define v_Placa					char(7);
define v_Tarifa, v_Dscto				money(12,2);
define v_Porc					decimal(5,2);
define v_nombre_aplico				char(50);
define v_fecha_otorga				date;
define v_AutoridadOtorga			varchar(100);
Let v_Contador = 0;

Let vif_clave = 0;
Let vif_descripcion = ' ';

Let v_Codigo_Movto = 0;
Let v_Sub_Codigo = 0;
Let v_Descrip_Movto = ' ';
Let v_Descrip_SubMovto = ' ';
Let v_Descripcion = ' ';
	
Let v_Axo = 0;
Let v_Folio = 0;
Let v_Cve = 0;
Let v_Fecha_Movto = today;
Let v_Fecha_Folio = today;
Let v_Fec_Cap = today;
Let v_Placa = ' ';
Let v_Tarifa = 0;
Let v_Porc = 0;
Let v_Dscto = 0;

Let v_nombre_aplico = '';
Let v_AutoridadOtorga = '';


		FOREACH
		SELECT a.placa, a.axo, a.folio, 
		a.infraccion, b.tarifa, (100 - c.porc_cobro), nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0), 
		a.fecha_movto, a.fecha_folio, (c.obs) autoridad_otorga, (d.nombre) aplico_dscto, c.fecha_otorga
		INTO  v_Placa, v_Axo, v_Folio, v_Cve, v_Tarifa, v_Porc, v_Dscto, v_Fecha_Movto, v_Fecha_Folio, v_AutoridadOtorga, v_nombre_aplico, v_fecha_otorga
		FROM ta14_folios_histo a, ta14_tarifas b, outer (ta14_folios_free c, db_ingresos:ta_12_passwords d)
		WHERE a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
			AND d.id_usuario = c.usu_inicial
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		IF v_Porc > 0 THEN
			RETURN v_Placa, v_Axo, v_Folio, v_Cve, v_Fecha_Folio, v_Tarifa, v_Porc, (v_Tarifa - v_Dscto), v_AutoridadOtorga, v_nombre_aplico, v_fecha_otorga, v_Fecha_Movto  with resume;
		END IF;
		END FOREACH;

end procedure;

create procedure "informix".spwb_consulta_folios ( p_placa varchar(7), p_fecha date )
returning  int as axo , int as folio , varchar(7) as placa , date as fecha , int as infraccion , 
        money(12,2) as tarifa , money(12,2) as costo_fijo , int as porcentaje, money(12,2) as apagar  ,
        varchar(15) as descripcion ,   varchar(30) as observacion, varchar(30) as captura ;
define v_axo int ;
define v_folio int;
define v_placa varchar(7);
define v_fecha_folio date;
define v_estado int;
define v_infraccion int;
define v_tarifa money(12,2) ;
define v_porcentaje int;
define v_descripcion varchar(15); 
define v_observacion varchar(30);
define v_captura varchar(20);
define v_costo_fijo money(12,2) ;
define v_apagar money(12,2) ;
define v_ord char(1) ;
define v_afec char(1);

define fecha_hoy date;
define x1 date;
define x2 date;
define dias_cuantos integer;
define dias_habil integer;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define v_numcapt  integer;

if p_placa <> "0" then

 FOREACH 
  SELECT Year(z.fecha_emision) , z.folio, w.placa, z.fecha_emision , 0 , 10 , z.importe_gastos, 0 , 100, "Notificacion" , 
  "A" , ''
  into
  v_axo , v_folio, v_placa , v_fecha_folio , v_estado ,v_infraccion, v_tarifa, v_costo_fijo , v_porcentaje ,
  v_descripcion , v_ord , v_captura
  FROM dbestacion:ta_padron w, db_ingresos:ta_15_apremios z 
  WHERE w.placa = p_placa
  AND z.modulo = 14 and z.control_otr = w.id 
  AND z.clave_practicado = "P" and z.fecha_practicado is not null and z.vigencia = 1 

  let v_apagar = (v_tarifa + v_costo_fijo ) ;
  let v_observacion = '';

  return  v_axo , v_folio, v_placa , v_fecha_folio , v_infraccion, v_tarifa, v_costo_fijo , v_porcentaje , v_apagar , 
  v_descripcion , v_observacion , v_captura with resume;

  end foreach ;
  FOREACH
 select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa , b.costo_fijo01  ,
 NVL(F.porc_cobro , 100), 'Vigente' ,  
  case a.infraccion  when 1 then "B" when 2 then "B"  when 3 then "B" when 10 then "A"  else "C" end  ,
  p.nombre 
  into
  v_axo , v_folio, v_placa , v_fecha_folio , v_estado ,v_infraccion, v_tarifa, v_costo_fijo , v_porcentaje ,
  v_descripcion , v_ord , v_captura

 from ta14_folios_adeudo a , TA14_tarifas  b  , OUTER (TA14_FOLIOS_FREE F ), outer (ta14_notifica_edo n) , outer(db_ingresos:ta_12_passwords p)
 where a.placa = p_placa 
 and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin AND
 a.axo = f.aXo and a.folio = f.folio AND F.CLAVE = "A" and a.num_acuerdo = n.num_acuerdo and n.num_acuerdo is not null and p.id_usuario = a.usu_inicial 

--select * from ta14_folios_adeudo
--select nombre from db_ingresos:ta_12_passwords where id_usuario in (214 , 693 , 31 ,223)


---descuentos
let fecha_hoy = today;
let x1 = v_fecha_folio;
let x2 = v_fecha_folio;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(v_fecha_folio) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between v_fecha_folio and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;
if (v_infraccion < 5) and (dias_cuantos < 7) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if v_porcentaje <> 100 then
     let vporc_cobro = v_porcentaje;
  end if;

---
 let v_apagar = (v_tarifa + v_costo_fijo ) * v_porcentaje / 100;
 let v_observacion = '';

  return  v_axo , v_folio, v_placa , v_fecha_folio , v_infraccion, v_tarifa, v_costo_fijo , v_porcentaje , v_apagar , 
  v_descripcion , v_observacion , v_captura with resume;

 end FOREACH;




else
 FOREACH
    select a.axo, a.folio, a.placa, a.fecha_folio, a.estado, a.infraccion, b.tarifa , b.costo_fijo01  ,
     NVL(F.porc_cobro , 100), 'Vigente' ,  
     case a.infraccion  when 1 then "B" when 2 then "B"  when 3 then "B" when 10 then "A"  else "C" end  ord ,
     p.nombre 
    into
     v_axo , v_folio, v_placa , v_fecha_folio , v_estado ,v_infraccion, v_tarifa, v_costo_fijo , v_porcentaje ,
     v_descripcion , v_ord , v_captura

  from ta14_folios_adeudo a , TA14_tarifas  b  , OUTER (TA14_FOLIOS_FREE F ), outer (ta14_notifica_edo n) , outer(db_ingresos:ta_12_passwords p)
 where  a.fecha_folio = p_fecha
 and a.infraccion = b.num_clave  and a.fecha_folio between b.fecha_inicial and b.fecha_fin AND
 a.axo = f.aXo and a.folio = f.folio AND F.CLAVE = "A" and a.num_acuerdo = n.num_acuerdo and n.num_acuerdo is not null and p.id_usuario = a.usu_inicial
  let v_apagar = (v_tarifa + v_costo_fijo ) * v_porcentaje;
 let v_observacion = '';


---descuentos
let fecha_hoy = today;
let x1 = v_fecha_folio;
let x2 = v_fecha_folio;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(v_fecha_folio) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between v_fecha_folio and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;
if (v_infraccion < 5) and (dias_cuantos < 7) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if v_porcentaje <> 100 then
     let vporc_cobro = v_porcentaje;
  end if;

---
 let v_apagar = (v_tarifa + v_costo_fijo ) * v_porcentaje / 100;



 return  v_axo , v_folio, v_placa , v_fecha_folio , v_infraccion, v_tarifa, v_costo_fijo , v_porcentaje , v_apagar , 
  v_descripcion , v_observacion , v_captura with resume;

 end FOREACH;
   
end if;

end procedure;

create procedure "informix".kioscopago_foliostc(pnumtrans int , 
  impcertificado money(10,2),  idmedio int,  parTarBanco   int,  partarconfir  int,
  partartarjeta varchar(30),  partartipo    int, pardatos_internet varchar(80))

returning  int , char(2), int, char(240), char(200) , char(28);

define varreca  int;
define varcaja  char(2);
define varoperacion int;
define concepto  char(60);
define concep  char(60);
define vplaca char(7);
define vdescrip char(240);
define conc1   char(60);
define conc2  char(60);
define conc3  char(60);
define conc4 char(60);
define conc1n   char(50);
define conc2n  char(50);
define conc3n  char(50);
define conc4n char(50);
define vnotif  char(200); 
define varnumf int    ;
define vimpact money(10,2); 
define vimpante money(10,2); 
define vimpmulta money(10,2);
define ctaredon integer;
define cta1 integer;
define cta2 integer;
define cta3 integer;
define lineanotif  int;
define vaxoini integer;
define vfolioini integer;
define vaxofin integer;
define vfoliofin integer;
define linea int;
define longconcep int;
define redon decimal(5,2);
define  v_linea100 char(100) ;
define v_linea28 char(28);
define vfol_ini integer;
define vfol_fin integer;
define daxo int;
define dfolio int;
define  dplaca char(7);
define  dacuerdo int;  
define varcontrol int;
define dcontar int;
define v_nombre char(60);
define v_codigomovtos int;
 let v_codigomovtos = 8;
if idmedio = 500 then
   let v_codigomovtos = 9;
end if;

select  placa,   foliosdescrip,  notifdescrip, axoini , folioini , axofin , foliofin, numfolios,   impactual, impanterior, impmulta 
into   vplaca , vdescrip,        vnotif, vaxoini , vfolioini , vaxofin , vfoliofin, varnumf,    vimpact, vimpante, vimpmulta

from ta14_kio_trans where numtrans = pnumtrans;
  let vfol_ini = (vaxoini * 1000000) + vfolioini;
  let vfol_fin = (vaxofin * 1000000) + vfoliofin;
let v_nombre = 'REFERENCIA BANCO:' ||  pnumtrans || vplaca|| vfol_ini || vfol_fin;
 select  count(*)
       into      dcontar  
       from ta14_folios_adeudo  where placa = vplaca and 
       ((axo * 1000000) + folio) between vfol_ini and vfol_fin;
if dcontar > 0 then
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,5,idmedio);
	
let longconcep = length(vdescrip);
if longconcep >= 181 then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = vdescrip[181,240];
end if;
if (longconcep >= 121) and (longconcep <= 180) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = '';
end if;
if longconcep >= 61 and (longconcep <= 120) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = '';
let conc4 = '';
end if;
if longconcep <= 60  then
let conc1 = vdescrip[1,60];
let conc2 = '';
let conc3 = '';
let conc4 = '';
end if;
-- notificacion;
let longconcep = length(vnotif);
if longconcep >= 151 then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = vnotif[151,200];
let lineanotif  = 4;
end if;
if (longconcep >= 151) and (longconcep <= 150) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = '';
let lineanotif  = 3;
end if;
if (longconcep >= 51) and (longconcep <= 100) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = '';
let conc4n = '';
let lineanotif  = 2;
end if;
if longconcep <= 50  then
let conc1n = vnotif[1,50];
let conc2n = '';
let conc3n = '';
let conc4n = '';
let lineanotif  = 1;
end if;

let cta1 = 510900000;  -- 46305  A�o actual
let cta2 = 510930000;  -- 46320   a�os anteriores
let cta3 = 992100006;      -- 23315  gastos ejecucion sefin.
--- 46327  cuenta para inmovilizador.

let redon = vimpact + vimpante + vimpmulta - impcertificado;

if redon >= 0.51 then 
 let ctaredon = 550800000 ; -- 46902 redondeo
else
let ctaredon = 550800000;
let redon = redon * -1;
end if;

 select id_rec , caja  
 into varreca , varcaja 
  from db_ingresos:ta12_operacKiosco where id_usuario = idmedio; 


	select nvl(operacion,0) + 1
		into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;



insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,6, varoperacion);

let concepto = 'Pago de multas de estacionometros de la placa: ' || vplaca;	
 
   insert into db_ingresos:ta_12_recibos (fecha ,  id_rec,  caja ,  operacion,  importe ,  cvepago ,  id_modulo,    nombre ,    concepto ,  
                                                    id_usuario ,  fecha_act , kio_num_terceros , id_rec_cta) 
                              values( today, varreca, varCaja, varOperacion, impcertificado, 'P' , 14, concepto,  v_nombre , idmedio, current, vplaca , 1 );


	update	db_ingresos:ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;
	

execute PROCEDURE db_ingresos:linea_capturadiv(varoperacion, idmedio,impcertificado ,today ) into
 v_linea100, v_linea28;
update db_ingresos:ta_12_recibos set domicilio = 'Linea: ' || v_linea28 
where fecha = today and  id_rec = varreca and  caja =varcaja and  operacion = varOperacion ;
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,7,idmedio);
-- si es pago con tarjeta afectar
if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into db_ingresos:ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today ,varreca , varcaja, varoperacion , parTarBanco  ,
  partarconfir ,  partartarjeta, impcertificado,  partartipo, pardatos_internet);
  end if;

--
let linea = 1;
if vimpact > 0 then

   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta1,  vimpact);
   let linea = linea +1;
end if;
if (vimpante > 0) then
    if (vimpact > 0)  then
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc2  ,   cta2,  vimpante);
      let linea = linea +1;
     else
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta2,  vimpante);
     let linea = linea +1;
    end if;
end if;
if linea = 3 then  
  let  concep = conc3;
else 
let concep = conc2;
end if;

if vimpmulta > 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  ,   cta3,  vimpmulta);
   let linea = linea +1;
end if;
if linea = 4 then  
  let  concep = conc4;
else 
let concep = conc3;
end if;

if redon <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , ctaredon ,  redon);
   let linea = linea +1;
else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , 0 , 0);
   let linea = linea +1;
end if;

if linea = 4 then
    insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc4  , 0 ,  0); 
end if;

if  lineanotif  = 4 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 8 ,        conc4n  ,   0,  0);
end if;
if  lineanotif  = 3 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
end if;
if  lineanotif  = 2 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);

end if;
if  lineanotif  = 1 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  
end if;

--
--dar de baja folios pagados.
  

   foreach 
       select  axo , folio,  placa, num_acuerdo
       into      daxo, dfolio,  dplaca, dacuerdo  
       from ta14_folios_adeudo  where placa = vplaca and 
       ((axo * 1000000) + folio) between vfol_ini and vfol_fin


     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, v_codigomovtos, idmedio , zona , espacio,0 
        from ta14_folios_adeudo 
     where axo = daxo and folio = dfolio;
     let varcontrol =  dbinfo("sqlca.sqlerrd1"); 

    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
       values ( varcontrol , today, varreca , varcaja, varoperacion);   
   delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
    if dacuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = today 
     where num_acuerdo = dacuerdo and fechapago is null;
      end if;
   end foreach;
--

   


--
return 
varreca, varcaja, varoperacion,  vdescrip,        vnotif, v_linea28;
else
return
0,'',0,'','','';
end if;
end procedure;

create procedure "informix".kioscopago_foliostca(pnumtrans int , 
  impcertificado money(10,2),  idmedio int,  parTarBanco   int,  partarconfir  int,
  partartarjeta varchar(30),  partartipo    int, pardatos_internet varchar(80))

returning  int , char(2), int, char(240), char(200) , char(28);

define varreca  int;
define varcaja  char(2);
define varoperacion int;
define concepto  char(60);
define concep  char(60);
define vplaca char(7);
define vdescrip char(240);
define conc1   char(60);
define conc2  char(60);
define conc3  char(60);
define conc4 char(60);
define conc1n   char(50);
define conc2n  char(50);
define conc3n  char(50);
define conc4n char(50);
define vnotif  char(200); 
define varnumf int    ;
define vimpact money(10,2); 
define vimpante money(10,2); 
define vimpmulta money(10,2);
define ctaredon integer;
define cta1 integer;
define cta2 integer;
define cta3 integer;
define lineanotif  int;
define vaxoini integer;
define vfolioini integer;
define vaxofin integer;
define vfoliofin integer;
define linea int;
define longconcep int;
define redon decimal(5,2);
define  v_linea100 char(100) ;
define v_linea28 char(28);
define vfol_ini int8;
define vfol_fin int8;
define daxo int;
define dfolio int;
define  dplaca char(7);
define  dacuerdo int;  
define varcontrol int;
define dcontar int;
define v_nombre char(60);
define v_codigomovtos int;
define v_lugarpago int;
 let v_codigomovtos = 8;
if idmedio = 500 then
   let v_codigomovtos = 9;
   let v_lugarpago = 112;
else
   let v_lugarpago = 0;
end if;

select  placa,   foliosdescrip,  notifdescrip, axoini , folioini , axofin , foliofin, numfolios,   impactual, impanterior, impmulta 
into   vplaca , vdescrip,        vnotif, vaxoini , vfolioini , vaxofin , vfoliofin, varnumf,    vimpact, vimpante, vimpmulta

from ta14_kio_trans where numtrans = pnumtrans;
  let vfol_ini = (vaxoini * 10000000) + vfolioini;
  let vfol_fin = (vaxofin * 10000000) + vfoliofin;
let v_nombre = 'REFERENCIA BANCO:' ||  pnumtrans || vplaca|| vfol_ini || vfol_fin;
 select  count(*)
       into      dcontar  
       from ta14_kio_transdet  where id_kio_trans = pnumtrans ;
if dcontar > 0 then
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,5,idmedio);
	
let longconcep = length(vdescrip);
if longconcep >= 181 then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = vdescrip[181,240];
end if;
if (longconcep >= 121) and (longconcep <= 180) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = '';
end if;
if longconcep >= 61 and (longconcep <= 120) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = '';
let conc4 = '';
end if;
if longconcep <= 60  then
let conc1 = vdescrip[1,60];
let conc2 = '';
let conc3 = '';
let conc4 = '';
end if;
-- notificacion;
let longconcep = length(vnotif);
if longconcep >= 151 then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = vnotif[151,200];
let lineanotif  = 4;
end if;
if (longconcep >= 151) and (longconcep <= 150) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = '';
let lineanotif  = 3;
end if;
if (longconcep >= 51) and (longconcep <= 100) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = '';
let conc4n = '';
let lineanotif  = 2;
end if;
if longconcep <= 50  then
let conc1n = vnotif[1,50];
let conc2n = '';
let conc3n = '';
let conc4n = '';
let lineanotif  = 1;
end if;

let cta1 = 510900000;  -- 46305  A�o actual
let cta2 = 510930000;  -- 46320   a�os anteriores
let cta3 = 992100006;      -- 23315  gastos ejecucion sefin.
--- 46327  cuenta para inmovilizador.

let redon = vimpact + vimpante + vimpmulta - impcertificado;

if redon >= 0.51 then 
 let ctaredon = 550800000 ; -- 46902 redondeo
else
let ctaredon = 550800000;
let redon = redon * -1;
end if;

 select id_rec , caja  
 into varreca , varcaja 
  from db_ingresos:ta12_operacKiosco where id_usuario = idmedio; 


	select nvl(operacion,0) + 1
		into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;



insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,6, varoperacion);

let concepto = 'Pago de multas de estacionometros de la placa: ' || vplaca;	
 
   insert into db_ingresos:ta_12_recibos (fecha ,  id_rec,  caja ,  operacion,  importe ,  cvepago ,  id_modulo,    nombre ,    concepto ,  
                                                    id_usuario ,  fecha_act , kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
                              values( today, varreca, varCaja, varOperacion, impcertificado, 'P' , 14, concepto,  v_nombre , idmedio, current, vplaca , 1, v_lugarpago, today );


	update	db_ingresos:ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;
	

execute PROCEDURE db_ingresos:linea_capturadiv(varoperacion, idmedio,impcertificado ,today ) into
 v_linea100, v_linea28;
update db_ingresos:ta_12_recibos set domicilio = 'Linea: ' || v_linea28 
where fecha = today and  id_rec = varreca and  caja =varcaja and  operacion = varOperacion ;
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,7,idmedio);
-- si es pago con tarjeta afectar
if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into db_ingresos:ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today ,varreca , varcaja, varoperacion , parTarBanco  ,
  partarconfir ,  partartarjeta, impcertificado,  partartipo, pardatos_internet);
  end if;

--
let linea = 1;
if vimpact > 0 then

   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta1,  vimpact);
   let linea = linea +1;
end if;
if (vimpante > 0) then
    if (vimpact > 0)  then
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc2  ,   cta2,  vimpante);
      let linea = linea +1;
     else
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta2,  vimpante);
     let linea = linea +1;
    end if;
end if;
if linea = 3 then  
  let  concep = conc3;
else 
let concep = conc2;
end if;

if vimpmulta > 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  ,   cta3,  vimpmulta);
   let linea = linea +1;
end if;
if linea = 4 then  
  let  concep = conc4;
else 
let concep = conc3;
end if;

if redon <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , ctaredon ,  redon);
   let linea = linea +1;
else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , 0 , 0);
   let linea = linea +1;
end if;

if linea = 4 then
    insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc4  , 0 ,  0); 
end if;

if  lineanotif  = 4 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 8 ,        conc4n  ,   0,  0);
end if;
if  lineanotif  = 3 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
end if;
if  lineanotif  = 2 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);

end if;
if  lineanotif  = 1 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  
end if;

--
--dar de baja folios pagados.
  
--select * from ta14_folios_histo
 foreach 
    select  a.axo , a.folio, a.placa, a.num_acuerdo
        into      daxo, dfolio,  dplaca, dacuerdo  
       from ta14_kio_transdet b , ta14_folios_adeudo  a 
       where b.id_kio_trans = pnumtrans and  a.axo =b.axo and a.folio = b.folio
   
  insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, v_codigomovtos, idmedio , zona , espacio , 0
        from ta14_folios_adeudo 
     where axo = daxo and folio = dfolio;
     let varcontrol =  dbinfo("sqlca.sqlerrd1"); 

    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
       values ( varcontrol , today, varreca , varcaja, varoperacion);   
   delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
    if dacuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = today 
     where num_acuerdo = dacuerdo and fechapago is null;
      end if;
   end foreach;
--

   


--
return 
varreca, varcaja, varoperacion,  vdescrip,        vnotif, v_linea28;
else
return
0,'',0,'','','';
end if;
end procedure;

CREATE PROCEDURE "pgmoreno".sp14_exc_multas_abc ( par_Opc Char(1), par_Dep_Multa integer, par_NumExc integer, par_AxoActa integer, par_NumActa integer )
{######################################################################
#  Procedimiento:    sp14_exc_multas_abc
#  Descripcion:      Interfaz de consulta de Estacionamientos
#
#  Parametros        	par_Opc			=	'A'= ALTA/REACTIVA, 'D'=ELIMINA/DESLIGA, 'C'=CANCELA, 'P'=PAGADA 
#  de entrada:	par_NumExc		=	Numero de Estacionamiento Exclusivo
#		par_AxoActa		= 	A�o de Acta
#		par_NumActa		= 	Numero de Acta
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            
#
#  Llamado por:      Procedimiento Modulo de ESTACIONAMIENTOS Mantenimiento de Multas Ligadas
#  
######################################################################}
                returning  int as status,
                                            varchar(255) as leyenda;
define v_leyenda                                                                        	varchar(255);
define v_status, v_id_usuario, v_numero, v_id, v_id_multa	Int;
define v_vigencia					char(1);
define v_id_alta					Int;

define v_cvepago, v_id_prescri			int;
define v_fecha_cancelacion				date;

Let v_id_alta = 0;
Let v_id_multa = 0;
Let v_id = 0;
Let v_numero = 0;
Let v_id_usuario = 0;
Let v_status = 0;
Let v_leyenda = 'NO TIENE ADEUDO';
Let v_vigencia = ' ';

if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 50;  -- Id Usuario de Gilberto Moreno
end if;

if exists( SELECT * FROM ex_contrato WHERE no_exclusivo = par_NumExc ) then
	SELECT id  INTO v_id FROM ex_contrato WHERE no_exclusivo = par_NumExc;

	if exists( SELECT * from catastro_gdl:multas
     		WHERE id_dependencia = par_Dep_Multa and axo_acta = par_AxoActa and num_acta = par_NumActa ) then

		SELECT id_multa  INTO v_id_multa  FROM catastro_gdl:multas
     		WHERE id_dependencia = par_Dep_Multa and axo_acta = par_AxoActa and num_acta = par_NumActa;
			
			if exists( SELECT * FROM ex_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and ex_contrato_id = v_id ) then

				SELECT count(*) INTO v_numero FROM ex_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and ex_contrato_id = v_id;

				SELECT vigente INTO v_vigencia FROM ex_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and ex_contrato_id = v_id;

				if v_numero = 1 then
					if par_Opc = 'D' then
						DELETE FROM ex_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
						AND axo_acta = par_AxoActa and num_acta = par_NumActa  and ex_contrato_id = v_id;
                  					Let v_status	= 1;
						Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO ELIMINADA/DESLIGADA ';
					end if;
					if par_Opc = 'C' then
						if v_vigencia <> 'C' then
							UPDATE ex_rel_multas  SET  vigente = 'C'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and ex_contrato_id = v_id;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO CANCELADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA CANCELADA';
						end if;
					end if;
					if par_Opc = 'P' then
						if v_vigencia <> 'P' then
							UPDATE ex_rel_multas  SET  vigente = 'P'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and ex_contrato_id = v_id;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO DADA COMO PAGADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA COMO PAGADA';
						end if;
					end if;
					if par_Opc = 'A' then
						if v_vigencia <> 'V' then
							UPDATE ex_rel_multas  SET  vigente = 'V'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and ex_contrato_id = v_id;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO REACTIVADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA  ACTIVA';
						end if;
					end if;
				else
					Let v_status	= -1;
					Let v_leyenda	= 'El Acta '||par_AxoActa||' - '||par_NumActa|| ' esta relacionada con mas de 1 Estacionamiento, avisar a DPD';
				end if;
			else
				if exists( SELECT * FROM ex_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
					AND axo_acta = par_AxoActa and num_acta = par_NumActa ) then
                  				Let v_status	= -1;
					Let v_leyenda	= 'LA MULTA EXISTE RELACIONADA  A OTRO ESTACIONAMIENTO';
				else
					if par_Opc = 'A' then			
						INSERT INTO ex_rel_multas values ( v_id_multa, par_Dep_Multa, par_AxoActa, par_NumActa, v_id, 'V' );
						Let v_status	= 1;
						Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO ACTIVADA';
					else
                  					Let v_status	= -1;
						Let v_leyenda	= 'EL MANNTO. A LA MULTA NO PUEDE SER, NO ESTA  ACTIVADA/REGISTRADA';
					end if;
				end if;
			end if;
	else
                  	Let v_status	= -1;
		Let v_leyenda	= 'NO EXISTE LA MULTA EN CATASTRO';
	end if;
else
                  Let v_status	= -1;
	Let v_leyenda	= 'NO EXISTE EL ESTACIONAMIENTO DIGITADO';
end if;
               RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_pub_multas_abc ( par_Opc Char(1), par_Dep_Multa integer, par_NumPub integer, par_AxoActa integer, par_NumActa integer )
{######################################################################
#  Procedimiento:    sp14_Pub_Multas_ABC
#  Descripcion:      Interfaz de consulta de Estacionamientos
#
#  Parametros        	par_Opc			=	'A'= ALTA/REACTIVA, 'D'=ELIMINA/DESLIGA, 'C'=CANCELA, 'P'=PAGADA 
#  de entrada:	par_NumExc		=	Numero de Estacionamiento Publico
#		par_AxoActa		= 	A�o de Acta
#		par_NumActa		= 	Numero de Acta
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            16 Mayo 2017   
#
#  Llamado por:      Procedimiento Modulo de ESTACIONAMIENTOS Mantenimiento de Multas Ligadas
#  
######################################################################}
                returning  int as status,
                                            varchar(255) as leyenda;
define v_leyenda                                                                        	varchar(255);
define v_status, v_id_usuario, v_numero, v_id, v_id_multa	Int;
define v_vigencia					char(1);
define v_id_alta					Int;

define v_cvepago, v_id_prescri			int;
define v_fecha_cancelacion				date;

Let v_id_alta = 0;
Let v_id_multa = 0;
Let v_id = 0;
Let v_numero = 0;
Let v_id_usuario = 0;
Let v_status = 0;
Let v_leyenda = 'NO TIENE ADEUDO';
Let v_vigencia = ' ';

if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 50;  -- Id Usuario de Gilberto Moreno
end if;

if exists( SELECT * FROM pubmain WHERE numesta = par_NumPub ) then
	SELECT id  INTO v_id FROM pubmain WHERE numesta = par_NumPub;

	if exists( SELECT * from catastro_gdl:multas
     		WHERE id_dependencia = par_Dep_Multa and axo_acta = par_AxoActa and num_acta = par_NumActa ) then

		SELECT id_multa  INTO v_id_multa  FROM catastro_gdl:multas
     		WHERE id_dependencia = par_Dep_Multa and axo_acta = par_AxoActa and num_acta = par_NumActa;

			if exists( SELECT * FROM pub_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and pubmain_id = v_id ) then

				SELECT count(*) INTO v_numero FROM pub_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and pubmain_id = v_id;

				SELECT vigente INTO v_vigencia FROM pub_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
				AND axo_acta = par_AxoActa and num_acta = par_NumActa  and pubmain_id = v_id;

				if v_numero = 1 then
					if par_Opc = 'D' then
						DELETE FROM pub_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
						AND axo_acta = par_AxoActa and num_acta = par_NumActa  and pubmain_id = v_id;
                  					Let v_status	= 1;
						Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO ELIMINADA/DESLIGADA ';
					end if;
					if par_Opc = 'C' then
						if v_vigencia <> 'C' then
							UPDATE pub_rel_multas  SET  vigente = 'C'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and pubmain_id = v_id;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO CANCELADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA CANCELADA';
						end if;
					end if;
					if par_Opc = 'P' then
						if v_vigencia <> 'P' then
							UPDATE pub_rel_multas  SET  vigente = 'P'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and pubmain_id = v_id;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO DADA COMO PAGADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA COMO PAGADA';
						end if;
					end if;
					if par_Opc = 'A' then
						if v_vigencia <> 'V' then
							UPDATE pub_rel_multas  SET  vigente = 'V'
							WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
							AND axo_acta = par_AxoActa and num_acta = par_NumActa  and pubmain_id = v_id;
                  						Let v_status	= 1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO REACTIVADA';
						else
                  						Let v_status	= -1;
							Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO YA SE ENCUENTRA  ACTIVA';
						end if;
					end if;
				else
					Let v_status	= -1;
					Let v_leyenda	= 'El Acta '||par_AxoActa||' - '||par_NumActa|| ' esta relacionada con mas de 1 Estacionamiento, avisar a DPD';
				end if;
			else
				if exists( SELECT * FROM pub_rel_multas  WHERE id_multa = v_id_multa AND id_dependencia = par_Dep_Multa 
					AND axo_acta = par_AxoActa and num_acta = par_NumActa ) then
                  				Let v_status	= -1;
					Let v_leyenda	= 'LA MULTA EXISTE RELACIONADA  A OTRO ESTACIONAMIENTO';
				else
					if par_Opc = 'A' then			
						INSERT INTO pub_rel_multas values ( v_id_multa, par_Dep_Multa, par_AxoActa, par_NumActa, v_id, 'V' );
						Let v_status	= 1;
						Let v_leyenda	= 'LA MULTA DEL ESTACIONAMIENTO HA SIDO ACTIVADA';
					else
                  					Let v_status	= -1;
						Let v_leyenda	= 'EL MANNTO. A LA MULTA NO PUEDE SER, NO ESTA  ACTIVADA/REGISTRADA';
					end if;
				end if;
			end if;
	else
                  	Let v_status	= -1;
		Let v_leyenda	= 'NO EXISTE LA MULTA EN CATASTRO';
	end if;
else
                  Let v_status	= -1;
	Let v_leyenda	= 'NO EXISTE EL ESTACIONAMIENTO DIGITADO';
end if;
               RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".admin_adeudos_detalle_16gil (parPlaca char(7), parref varchar(20))
				
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_16
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de Folios de estacionometros en el sistema ADMIN
#
#  Parametros        p_tipo     = numero de placa
#  de entrada:      
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            13 Septiembre 2013   
#  Modificado:       6/6/2018  para integrar el cobro de gastos por notificaciones.
#  Llamado por:      Procedimiento admin_adeudos_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int         as NoRubro,
int         as NoConcepto, 
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion, 
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
define  var_refers bigint;
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
--
  begin
    on exception in (-958)
       delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
      placa  char(7) ,
      axo int,
      folio int, 
      fecha_folio date,
      estado smallint,
      infraccion smallint,
      tarifa  money(12,2), 
      porc_cobro int,
      num_acuerdo int,
      imp_pagar  money(12,2) ,
      cta_aplicacion integer
     ) with no log;
  end;

if parref = '' then
   let par_axo = year(today);
   let par_folio = 99999999;
   let var_refer = (par_axo * 100000000 ) + par_folio;
else
   let par_axo = (parref[1,4]) *1;
   let par_folio = (parref[6,13]) *1;
   let var_refer = (par_axo * 100000000 ) + par_folio;
end if;
--
-- verificar si hay padron
 --foreach 

   
   select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;

--end foreach;

--select * from ta_padron

let v_Acumulado = 0;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
     -- verificar si tienen gastos para su cobro																								
    if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
            let v_Acumulado = v_Acumulado + v_gastos ;
           insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
           porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
          values ( parplaca , year(vN_fecha_emision), vN_folio, vN_fecha_emision, 0 , 0, v_gastos ,
           100 , 0 , v_gastos , 550620011);
           let  v_Referencia  = year(vN_fecha_emision) || '-' || lpad(vN_folio, 8 ,'0') ;  
           let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || vN_fecha_emision || ' Notificacion';
           return 0,0,550620011,v_Referencia,v_Descripcion,v_gastos,v_Acumulado with resume;
     end foreach;
    end if;
   end if;
     --
foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca 
and (( a.axo * 100000000 ) +  a.folio) <= var_refer
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 1, 2 asc
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;
-- select * from ta14_tarifas
let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(vfecha) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;

if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 510930000 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if vinfra <> 5 then
	let vporc_cobro = 50 ;
end if;
--if (vinfra < 5) and (dias_cuantos < 7) then
--      let vporc_cobro = 50 ;
--   else
--     let  vporc_cobro = 100;
--end if;

  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
  let vimp_apagar = vporc_cobro / 100 * vtarifa;
  let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;  
  let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra;
  let v_Acumulado = v_Acumulado + vimp_apagar;

  insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
      porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
   values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,
    vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
  return 0,0,vctaapl,v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;
   end foreach;
else 
 return 0,0,0,'','',0,0;
end if;
end procedure;

create procedure "informix".kioscopago_foliostca18(pnumtrans int , 
  impcertificado money(10,2),  idmedio int,  parTarBanco   int,  partarconfir  int,
  partartarjeta varchar(30),  partartipo    int, pardatos_internet varchar(80))

returning 
int as reca, 
char(2) as caja, 
int as operacion,
char(240) as descrip,
char(200) as notif, 
char(28) as linea28;

define varreca  int;
define varcaja  char(2);
define varoperacion int;
define concepto  char(60);
define concep  char(60);
define vplaca char(7);
define vdescrip char(240);
define conc1   char(60);
define conc2  char(60);
define conc3  char(60);
define conc4 char(60);
define conc1n   char(50);
define conc2n  char(50);
define conc3n  char(50);
define conc4n char(50);
define vnotif  char(200); 
define varnumf int    ;
define vimpact money(10,2); 
define vimpante money(10,2); 
define vimpmulta money(10,2);
define ctaredon integer;
define cta1 integer;
define cta2 integer;
define cta3 integer;
define lineanotif  int;
define vaxoini integer;
define vfolioini integer;
define vaxofin integer;
define vfoliofin integer;
define linea int;
define longconcep int;
define redon decimal(5,2);
define  v_linea100 char(100) ;
define v_linea28 char(28);
define vfol_ini int8;
define vfol_fin int8;
define daxo int;
define dfolio int;
define  dplaca char(7);
define  dacuerdo int;  
define varcontrol int;
define dcontar int;
define v_nombre char(60);
define v_codigomovtos int;
define v_lugarpago int;
 let v_codigomovtos = 8;
if idmedio = 500 then
   let v_codigomovtos = 9;
   let v_lugarpago = 112;
else
   let v_lugarpago = 0;
end if;

select  placa,   foliosdescrip,  notifdescrip, axoini , folioini , axofin , foliofin, numfolios,   impactual, impanterior, impmulta 
into   vplaca , vdescrip,        vnotif, vaxoini , vfolioini , vaxofin , vfoliofin, varnumf,    vimpact, vimpante, vimpmulta

from ta14_kio_trans where numtrans = pnumtrans;
  let vfol_ini = (vaxoini * 10000000) + vfolioini;
  let vfol_fin = (vaxofin * 10000000) + vfoliofin;
let v_nombre = 'REFERENCIA BANCO:' ||  pnumtrans || vplaca|| vfol_ini || vfol_fin;
 select  count(*)
       into      dcontar  
       from ta14_kio_transdet  where id_kio_trans = pnumtrans ;
if dcontar > 0 then
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,5,idmedio);
	
let longconcep = length(vdescrip);
if longconcep >= 181 then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = vdescrip[181,240];
end if;
if (longconcep >= 121) and (longconcep <= 180) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = '';
end if;
if longconcep >= 61 and (longconcep <= 120) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = '';
let conc4 = '';
end if;
if longconcep <= 60  then
let conc1 = vdescrip[1,60];
let conc2 = '';
let conc3 = '';
let conc4 = '';
end if;
-- notificacion;
let longconcep = length(vnotif);
if longconcep >= 151 then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = vnotif[151,200];
let lineanotif  = 4;
end if;
if (longconcep >= 151) and (longconcep <= 150) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = '';
let lineanotif  = 3;
end if;
if (longconcep >= 51) and (longconcep <= 100) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = '';
let conc4n = '';
let lineanotif  = 2;
end if;
if longconcep <= 50  then
let conc1n = vnotif[1,50];
let conc2n = '';
let conc3n = '';
let conc4n = '';
let lineanotif  = 1;
end if;

let cta1 = 510900000;  -- 46305  A�o actual
let cta2 = 510930000;  -- 46320   a�os anteriores
let cta3 = 992100006;      -- 23315  gastos ejecucion sefin.
--- 46327  cuenta para inmovilizador.

let redon = vimpact + vimpante + vimpmulta - impcertificado;

if redon >= 0.51 then 
 let ctaredon = 550800000 ; -- 46902 redondeo
else
let ctaredon = 550800000;
let redon = redon * -1;
end if;

 select id_rec , caja  
 into varreca , varcaja 
  from db_ingresos:ta12_operacKiosco where id_usuario = idmedio; 


	select nvl(operacion,0) + 1
		into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;



insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,6, varoperacion);

let concepto = 'Pago de multas de estacionometros de la placa: ' || vplaca;	
 
   insert into db_ingresos:ta_12_recibos (fecha ,  id_rec,  caja ,  operacion,  importe ,  cvepago ,  id_modulo,    nombre ,    concepto ,  
                                                    id_usuario ,  fecha_act , kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
                              values( today, varreca, varCaja, varOperacion, impcertificado, 'P' , 14, concepto,  v_nombre , idmedio, current, vplaca , 1, v_lugarpago, today );


	update	db_ingresos:ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;
	

execute PROCEDURE db_ingresos:linea_capturadiv(varoperacion, idmedio,impcertificado ,today ) into
 v_linea100, v_linea28;
update db_ingresos:ta_12_recibos set domicilio = 'Linea: ' || v_linea28 
where fecha = today and  id_rec = varreca and  caja =varcaja and  operacion = varOperacion ;
insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,7,idmedio);
-- si es pago con tarjeta afectar
if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into db_ingresos:ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today ,varreca , varcaja, varoperacion , parTarBanco  ,
  partarconfir ,  partartarjeta, impcertificado,  partartipo, pardatos_internet);
  end if;

--
let linea = 1;
if vimpact > 0 then

   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta1,  vimpact);
   let linea = linea +1;
end if;
if (vimpante > 0) then
    if (vimpact > 0)  then
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc2  ,   cta2,  vimpante);
      let linea = linea +1;
     else
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta2,  vimpante);
     let linea = linea +1;
    end if;
end if;
if linea = 3 then  
  let  concep = conc3;
else 
let concep = conc2;
end if;

if vimpmulta > 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  ,   cta3,  vimpmulta);
   let linea = linea +1;
end if;
if linea = 4 then  
  let  concep = conc4;
else 
let concep = conc3;
end if;

if redon <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , ctaredon ,  redon);
   let linea = linea +1;
else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , 0 , 0);
   let linea = linea +1;
end if;

if linea = 4 then
    insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc4  , 0 ,  0); 
end if;

if  lineanotif  = 4 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 8 ,        conc4n  ,   0,  0);
end if;
if  lineanotif  = 3 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
end if;
if  lineanotif  = 2 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);

end if;
if  lineanotif  = 1 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  
end if;

--
--dar de baja folios pagados.
  
--select * from ta14_folios_histo
 foreach 
    select  a.axo , a.folio, a.placa, a.num_acuerdo
        into      daxo, dfolio,  dplaca, dacuerdo  
       from ta14_kio_transdet b , ta14_folios_adeudo  a 
       where b.id_kio_trans = pnumtrans and  a.axo =b.axo and a.folio = b.folio
   
  insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, v_codigomovtos, idmedio , zona , espacio , 0
        from ta14_folios_adeudo 
     where axo = daxo and folio = dfolio;
     let varcontrol =  dbinfo("sqlca.sqlerrd1"); 

    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
       values ( varcontrol , today, varreca , varcaja, varoperacion);   
   delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
    if dacuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = today 
     where num_acuerdo = dacuerdo and fechapago is null;
      end if;
   end foreach;
--

   


--
return 
varreca, varcaja, varoperacion,  vdescrip,        vnotif, v_linea28;
else
return
0,'',0,'','','';
end if;
end procedure;

create procedure "pgmoreno".cons14_solicrep_edo ( p_fecini date, p_fecfin date )
returning  int as Clave,
date as Fecha_pago,
int as Axo,
int as Folio,
char(7) as Placa,
Money(12,2) as Importe;

DEFINE v_fechapago	date;
DEFINE v_num_clave, v1_axo, v1_folio	int;
DEFINE v_placa		char(7);
DEFINE v_importe		money(12,2);
define v_infracion		int;
DEFINE v_folio		VARCHAR(11);

DEFINE z_fechapago	date;
DEFINE z_num_clave, z_folio, z1_axo, z1_folio	int;
DEFINE z_placa	char(7);
DEFINE z_importe	money(12,2);

 begin
   on exception in (-958)
      delete from tmp_folios_edo;
   end exception;
   create temp table tmp_folios_edo (
	num_clave	int,
	fecha_pago	date,
     	axo 		int,
     	folio 		int,
     	placa  		char(7) ,
     	importe		money(12,2)
    ) with no log;
 end;

FOREACH
 	SELECT fechapago, folio, placa, importe  INTO  v_fechapago, v_folio, v_placa, v_importe
	FROM ta14_datos_edo  WHERE fechapago BETWEEN p_fecini and p_fecfin and tipoact = 'PN'

	if v_folio > 9999999 then
		--if exists ( select * from ta14_folios_histo where axo = substr(v_folio,1,4) and folio = substr(v_folio,5,8) ) then
		--	select infraccion into v_infracion from ta14_folios_histo where axo = substr(v_folio,1,4) and folio = substr(v_folio,5,8);

		if exists ( SELECT max(num_clave) FROM ta14_tarifas where fecha_inicial=mdy(01,01,substr(v_folio,1,4)) and fecha_fin=mdy(12,31,substr(v_folio,1,4))
			and tarifa = v_importe and costo_fijo01 = 0 and num_clave < 10 ) then
			SELECT max(num_clave)  INTO v_infracion FROM ta14_tarifas where fecha_inicial=mdy(01,01,substr(v_folio,1,4)) and fecha_fin=mdy(12,31,substr(v_folio,1,4)) 
			and tarifa = v_importe and costo_fijo01 = 0 and num_clave < 10;

          			Let v_num_clave = v_infracion;
			--Let v_num_clave = 0;
			Let v1_axo = substr(v_folio,1,4);
			Let v1_folio = substr(v_folio,5,8);
		else
			Let v_num_clave = 0;
			Let v1_axo = substr(v_folio,1,4);
			Let v1_folio = substr(v_folio,5,8);
                               	end if;
	else
		Let v_num_clave = 0;
		Let v1_axo = 0;
		Let v1_folio = v_folio;	
	end if;

	insert into tmp_folios_edo ( num_clave, fecha_pago, axo, folio, placa, importe )  values ( v_num_clave, v_fechapago, v1_axo, v1_folio, v_placa, v_importe );

END FOREACH;

FOREACH
	SELECT num_clave, fecha_pago, axo, folio, placa, importe 
	INTO z_num_clave, z_fechapago, z1_axo, v1_folio, z_placa, z_importe 
	FROM tmp_folios_edo  Order By num_clave, fecha_pago, axo, folio

	RETURN  z_num_clave, z_fechapago, z1_axo, v1_folio, z_placa, z_importe with resume;
END FOREACH;

end procedure;

CREATE PROCEDURE "informix".e_parkingcons(parPlaca char(7), parMedio int)
				
	 returning smallint , smallint,  char(7) ,      int , date ,  smallint , Char(40) , money(7,2), smallint ,  money(7,2),        int ,            int ,                         char(100)  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define infra_descrip char(40);
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
--set debug file to "parkivan.log";
--trace on;
 execute procedure sp_desto35_fol_jul2018( parplaca ,999998 );
 select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;


if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
   if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
     return 
       0,year(vN_fecha_emision),parplaca, vN_folio, vN_fecha_emision, 0 , 'Notificaci�n', v_gastos ,
       100 , v_gastos , 0 , 550620011 , 'Ok' with resume;

     end foreach;
    end if;
   end if;

  if today > mdy(11,14,2018) and today < mdy(12,22,2018) then
   execute procedure sp_descto_placa_bf( parplaca );
   end if; 


foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
, infra.descripcion
into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b , ta14_infraccion infra, outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and infra.num_clave = a.infraccion and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A' 
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;

--select count(*) 
--       into dias_habil 
--       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha+1 and today;

--     while x1 <= fecha_hoy 
--        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
--          let dias_cuantos =dias_cuantos+1;
--         end if;
--     let x1 = x1+1;
--   end while;


  if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado , infra_descrip, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,'',0,0,0,0,0,'No existen folios para esta placa';
end if;

end procedure
;

CREATE PROCEDURE "pgmoreno".sp14_cfolios ( parPlaca char(7) )
	returning char(2) as tipoact,
		char(7) as placa,
		integer as axo,
		integer as folio,
		date as fechaalta,
		date as fechapago,
		date as fechacancelado,
		money(12,2) as importe,
		varchar(50) as folioecmpio,
		varchar(20) as remesa,
		date as fecharemesa,
		varchar(120) as concepto,
		date as fecha_in,
		date as fecha_fin,
		date as fecha_aplic;

define v_orden		char(1);
define v_tipoact		char(2);
define v_placa		char(7);
define v_axo, v_folio, v_codigo_movto				integer;
define v_fechaalta, v_fechapago, v_fechacancelado, v_fecharemesa	date;
define v_fecha_movto, v_fecha_folio	date;
define v_importe		money(12,2);
define v_folioecmpio	varchar(50);
define v_remesa		varchar(20);
define vn_remesa		int;
define v_concepto		varchar(120);
define v_descripcion	varchar(40);
define v_folio_const		decimal(12,0);
define v_folio_const_b	char(12);

define vn_fecha_in, vn_fecha_fin, vn_fecha_aplic date;

 -- opc 'A' por Placa
 -- opc 'B' por Axo y Folio
 -- opc 'C' por Placa(s) y Folio(s)  hasta 3 placas y hasta 10 folios

Let v_folio_const = 0;
Let v_folio_const_b = '';
Let vn_remesa = 0;
          
	begin
    		on exception in (-958)
       			delete from tmp_placafolios;
    		end exception;
	create temp table tmp_placafolios(
	Orden		char(1),
	tipoact		char(2),
	placa		char(7),
	axo		integer,
	folio		integer,
	fechaalta	date,
	fechapago	date,
	fechacancelado	date,
	importe		money(12,2),
	folioecmpio	varchar(50),
	remesa		varchar(20),
	fecharemesa	date,
	concepto		varchar(120) ) with no log;
	end;

	FOREACH  -- Envio de la Alta al Estado
	SELECT 'A', tipoact, placa, substr(folio,1,4), substr(folio,5,7), fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Enviado al Edo. como Adeudo'  
	INTO	v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
	FROM ta14_datos_mpio   WHERE placa = parPlaca and tipoact = 'A'   ORDER BY placa, folio

	INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
				v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto );
	END FOREACH;

	FOREACH  -- -- Pagos/Cancelaciones enviados al estado
	SELECT tipoact, placa, substr(folio,1,4), substr(folio,5,7), fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Enviado al Edo. como Adeudo'  
	INTO	v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
	FROM ta14_datos_mpio   WHERE placa = parPlaca and tipoact <> 'A'   ORDER BY placa, folio

		if v_tipoact = 'PN' then
			INSERT INTO tmp_placafolios VALUES ( 'B', v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, Null, 
			v_importe, v_folioecmpio, v_remesa, v_fecharemesa, 
			--'Pagos Realizados Enviados al Edo. -- '|| Trim(v_descripcion) );
			'Pagos Realizados Enviados al Edo. ' );
		end if;
		if v_tipoact = 'C' then
			INSERT INTO tmp_placafolios VALUES ( 'B', v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, Null, v_fechacancelado, 
			v_importe, v_folioecmpio, v_remesa, v_fecharemesa, 
			'Cancelacion/Prescripcion Enviados al Edo. ' );
		end if;

	END FOREACH;

	FOREACH	  -- Pagos Recibidos del Estado
	SELECT 'C', b.tipoact, placa, substr(b.folio,1,4), substr(b.folio,5,7), b.fechaalta, b.fechapago, b.fechacancelado, b.importe, b.folioecmpio, b.remesa, b.fecharemesa
	INTO	v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa
	FROM ta14_datos_edo b   WHERE b.placa = parPlaca   ORDER BY b.tipoact, b.fecharemesa

	INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
				v_importe, v_folioecmpio, v_remesa, v_fecharemesa, 'Pago Recibido del Edo.' );
	END FOREACH;
	--
	FOREACH  -- Generacion de datos de salida
	SELECT 	Orden, tipoact, placa, axo, folio, fechaalta, fechapago, fechacancelado, 
		importe, folioecmpio, remesa, fecharemesa, concepto
	INTO  v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
	FROM tmp_placafolios
	ORDER BY placa, axo, folio, Orden 

		Let vn_fecha_in = Null;
		Let vn_fecha_fin = Null;
		Let vn_fecha_aplic = Null;


		RETURN v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
		v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto, 
		vn_fecha_in, vn_fecha_fin, vn_fecha_aplic    with resume;
	END FOREACH;

end procedure;

create procedure "informix".sp_ex_adeudoanual(p_axo int)
returning char(150);
define obs char(150);
define p_exid int;

define v_idx int;
define v_mensajex char(50);
define v_id int;
define v_mensaje char(50);
FOREACH
select a.id  into p_exid
 from ex_contrato a where a.estatus <> 'C'-- and a.id > 2
 execute procedure sp_exc_refrendo(p_exid  , p_axo ,  18 ) into v_idx , v_mensajex;
 execute procedure sp_exc_genadeudo(2 , p_exid , p_axo  ,1 , p_axo , 12, 18) 
 into v_id , v_mensaje; 
let obs = 'Registro procesado  '|| p_exid ||' ' || v_id ||'  '|| v_mensaje ;
return obs with resume;

 END FOREACH;

end procedure;

create procedure "informix".sp_procesar_datos_estacion()
	Returning int as axo , 
		int as folio , 
		varchar(100) as obs;

define r_fecha_folio date;
define r_axo integer;
define v_folio integer;
define v_placa varchar(7);
define v_id integer;
define v_anomalia varchar(40);
define v_opcion integer;
define r_result integer;
define r_obs varchar(80);

define v_id_usuario	int;

 begin
    on exception in (-958)
       delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
      id int,
      axo int,
      folio int,
      placa varchar(7),
      anomalia int
      ) with no log;
  end;
-- set debug file to "sp_procesar_datos_estacion";
 --trace on;

Let  v_id_usuario = 0;
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 1011;
end if;

insert into tmp_folios
select rowid , axo , folio_archivo  , placa ,  case when anomalia = "Error vigilante" then 22 else 23 end  
	from  ta14_folios_baja_esta where  fecha_proceso is null and estatus is null;

	FOREACH 
       	select id , axo , folio , placa ,  anomalia 
          	into v_id , r_axo, v_folio ,      v_placa , v_Opcion     
          		from tmp_folios
  
	execute PROCEDURE spd_delesta01sra( r_axo , v_folio , v_placa , v_id_usuario, v_Opcion ) into r_result , r_obs ;	  -- v_id_usuario sustituyo a usuario fijo 550

	update  ta14_folios_baja_esta set fecha_proceso = today , estatus = r_result
      		where axo = r_axo and folio_archivo = v_folio and fecha_proceso is null and estatus is null;
 
	return r_axo , v_folio , r_obs with resume;
         		CONTINUE FOREACH;
  	ENd FOREACH
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".spd_ignacio_12022019 ( paraxo smallint, parfolio  integer )
		returning	int as status,
			char(100) as leyenda;

define v_status	int;
define v_leyenda	char(100);

define varcontrol int;
define v_axo, v_folio, v_infraccion, v_estado, v_vigilante, v_num_acuerdo, v_usu_inicial int;
define v_fecha_folio, v_fec_cap date;
define v_placa char(7);
define v_zona, v_espacio smallint;

Let v_status = 0;
Let v_leyenda = ' ';

Let varcontrol = 0;

Let v_axo = 0;
Let v_folio = 0;
Let v_infraccion = 0;
Let v_estado = 0;
Let v_vigilante = 0;
Let v_num_acuerdo = 0;
Let v_usu_inicial = 0;
Let v_placa = ' ';
Let v_zona = 0;
Let v_espacio = 0;

if exists ( select * from ta14_folios_adeudo where axo = paraxo and folio = parfolio ) then
     	select axo, folio, fecha_folio, placa, infraccion, estado, vigilante, num_acuerdo, fec_cap, usu_inicial, zona , espacio 
	into v_axo, v_folio, v_fecha_folio, v_placa, v_infraccion, v_estado, v_vigilante, v_num_acuerdo, v_fec_cap, v_usu_inicial, v_zona, v_espacio 
	from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	insert into ta14_folios_histo values ( 0, mdy(09,30,2015), v_axo, v_folio, v_fecha_folio, v_placa, v_infraccion, v_estado, v_vigilante, v_num_acuerdo, v_fec_cap, v_usu_inicial, 17, 50, v_zona, v_espacio, 0 );
      	let varcontrol =  dbinfo("sqlca.sqlerrd1"); 

	if varcontrol > 0 then
		insert into ta14_condonado (control, autoriza, observacion, solicitante_rfc, solicitante_motivo) 
     				values ( varcontrol, 'AM/LIB/0030/2018', 'SEGUIMIENTO CGAIG/00056/2018', 'SIN DATO', 'ATENCION A OFICIOS DE CONDONACION'); 
		delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

		let v_status = 1;
		let v_leyenda = 'Condonacion Folio-Placa ' || paraxo || '-' || parfolio;
	else
		let v_status = -1;
		let v_leyenda = 'Cancelo pero no creo Condonaci�n de Folio-Placa ' || paraxo || '-' || parfolio;
	end if;
else
	let v_status = -1;
     	let v_leyenda = 'No Existe como Adeudo Folio-Placa ' || paraxo || '-' || parfolio;
end if;

return v_status, v_leyenda;
--trace off;

end procedure;

CREATE PROCEDURE "pgmoreno".spd_ignacio_12022019_b ( )
		returning	int as status,
			char(100) as leyenda;

define v_status	int;
define v_leyenda	char(100);

DEFINE v_Folio				Char(12);
DEFINE v_Placa                                                     	Char(9);
DEFINE v_FecPgo, v_FecCan, v_FecAlt		Date;

Let v_status = 0;
Let v_leyenda = ' ';

Let v_Folio = '';
Let v_Placa = '';

foreach
select (trunc((axo* 10000000) + folio)  ) || '' Folio, placa, fecha_movto, fecha_folio  INTO v_Folio, v_Placa, v_FecCan, v_FecAlt
from ta14_folios_histo
where fecha_movto = mdy(09,30,2015) and usu_bajaauto = 50 and codigo_movto = 17
Order by placa, Axo, Folio

        	insert into ta14_datos_mpio values ( 113, 'C', v_Folio, Null, v_Placa, Null, Null, Null, v_FecCan, Null, Null, v_FecAlt, Null, Null, ' ', Null, 'ayt_gdl_r2852', today);
	let v_status = 1;
	let v_leyenda = 'Genero Folio-Placa ' || v_Folio;

	return v_status, v_leyenda  with resume; 
end foreach;

end procedure;

CREATE PROCEDURE "informix".admin_adeudos_detalle_16pos(parPlaca char(7), parref varchar(20))
returning  int as NoRubro, int as NoConcepto, int as Cta_Aplic,
varchar(50) as Referencia, varchar(120) as Descripcion,   dec(14,2)   as Monto,
dec(14,2)   as Acumulado; define varok   smallint;
define varobs char(200); define varcontrol integer;
define vaxo smallint;  define  vfolio integer;  
define vfecha date; define vinfra smallint;
define vestado smallint; define vporc_cobro integer;
define vsqlporc_cobro integer; define vacuerdo integer;
define vtarifa smallint; define dias_cuantos integer;
define dias_habil integer ; define vusuini integer;
define vzona smallint; define vespacio smallint;
define fecha_hoy date; define x1 date;
define x2 date; define vimp_apagar decimal(7,2);
define  vctaapl integer;  define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60); define v_Referencia varchar(30);
define par_axo smallint; define par_folio int; define  var_refer bigint;
define  var_refers bigint; define v_id_padron integer; define v_gastos decimal(7,2);
define vN_folio integer ; define vN_fecha_emision  date;
  begin
    on exception in (-958)    delete from tmp_folios;  end exception;
    create temp table tmp_folios( placa  char(7) , axo int, folio int, fecha_folio date, estado smallint,
      infraccion smallint, tarifa  money(12,2), porc_cobro int, num_acuerdo int,  imp_pagar  money(12,2) ,
      cta_aplicacion integer   ) with no log;
  end;
if parref = '' then  let par_axo = year(today);  let par_folio = 99999999; let var_refer = (par_axo * 100000000 ) + par_folio;
else  let par_axo = (parref[1,4]) *1;   let par_folio = (parref[6,13]) *1;  let var_refer = (par_axo * 100000000 ) + par_folio;
end if;
   select   id   into  v_id_padron  from ta_padron where placa = parplaca  ;
  if v_id_padron is null  then let v_id_padron = 0; end if;
  let v_Acumulado = 0;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
    if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
      if v_gastos > 0 then 
        foreach 
        select  folio ,  fecha_emision ,  importe_gastos  into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
            let v_Acumulado = v_Acumulado + v_gastos ;
           insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
           porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
          values ( parplaca , year(vN_fecha_emision), vN_folio, vN_fecha_emision, 0 , 0, v_gastos ,
           100 , 0 , v_gastos , 550620011);
           let  v_Referencia  = year(vN_fecha_emision) || '-' || lpad(vN_folio, 8 ,'0') ;  
           let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || vN_fecha_emision || ' Notificacion';
           return 0,0,550620011,v_Referencia,v_Descripcion,v_gastos,v_Acumulado with resume;
     end foreach;  end if; end if;
    foreach 
    select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
   into vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
   from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
   where a.placa = parplaca  and (( a.axo * 100000000 ) +  a.folio) <= var_refer and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and a.axo = f.axo and a.folio = f.folio and f.clave = 'A' order by 1, 2 asc
let fecha_hoy = today; let x1 = vfecha; let x2 = vfecha;
let dias_cuantos = 0; let dias_habil = 0; 
 if Weekday(vfecha) = 6 then   let dias_cuantos = 1;  end if;
select count(*)  into dias_habil  from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;
     while x1 <= fecha_hoy 
        IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN let dias_cuantos =dias_cuantos+1; end if;
     let x1 = x1+1;
     end while;
let dias_cuantos =  dias_cuantos - dias_habil ;
if year(today) = year(vfecha) then let vctaapl = 510900000 ; else let vctaapl = 510930000 ; end if;
if (vinfra < 5) and (dias_cuantos < 7) then let vporc_cobro = 50 ; else let  vporc_cobro = 100; end if;
if vsqlporc_cobro <> 100 then  let vporc_cobro = vsqlporc_cobro; end if;
let vimp_apagar = vporc_cobro / 100 * vtarifa;
let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;  
let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra;
  let v_Acumulado = v_Acumulado + vimp_apagar;

  insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
      porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
   values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,
    vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
  return 0,0,vctaapl,v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;
   end foreach;
else 
 return 0,0,0,'','',0,0;
end if;
end procedure
;

CREATE PROCEDURE "pgmoreno".sp14_exc_descto_rcgos ( par_opc char(1), par_control int, par_axoini int, par_mesini int, par_axofin int, par_mesfin int, 
par_usuario_aplica char(10), par_porcentaje int, par_autoriza char(40), par_nota char(250) )

RETURNING int as descuento,
          varchar(255) as mensage;


define v_porcentaje  int;
define v_id_descuento int;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'sp14_exc_descto_rcgos ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

Let v_porcentaje=0;
Let v_id_descuento = 0;

if par_opc = 'A' then	-- alta de descuento
	if not exists ( SELECT * from ex_descrec WHERE ex_contrato_id = par_control and vigencia = 'V' ) then
		if ((par_axofin * 100)+par_mesfin) >= ((par_axoini * 100)+par_mesini) then
			INSERT INTO ex_descrec VALUES ( 0, par_control, par_axoini, par_mesini, par_axofin, par_mesfin, current, par_usuario_aplica, 
							null, null, null, null, null, null, 'V', par_porcentaje, par_autoriza, par_nota, 'pc' );
			Let v_id_descuento = dbinfo("sqlca.sqlerrd1");
			if v_id_descuento > 0 then
				return 1,'El Descuento se creo correctamente';
			else
				return -1,'Ocurrio error al crear el descuento, avisa al administrador';
			end if;
		else
			return -1,'El periodo final no es mayor o igual al periodo inicial, intenta de nuevo';
		end if;
	else
		return -1,'El Control ya tiene un Descuento Vigente, debes cancelarlo primero';
	end if;	
else
	return -1, 'Opcion Inexistente';
end if;

END PROCEDURE;

create procedure "informix".cajero_porc_rgos ( )
returning   int as status,
	varchar(50) as leyenda;

define v_status		int;
define v_leyenda		varchar(50);		
define contador_porcentaje	int;
--define v_fecha_limite	date;

Let v_status = 0;
Let v_leyenda = 'Aun el dia actual no es mayor de 5';

Let contador_porcentaje = 0;

--SELECT fecha_descuento INTO v_fecha_limite FROM db_ingresos:ta_11_fecha_desc
--WHERE Year(fecha_descuento) = year(today) and Month(fecha_descuento) = Month(today);

if Day(today) >= 6 then
	SELECT count(*) INTO contador_porcentaje FROM dbestacion:recargos
	WHERE axo = year(today) and mes = Month(today);
	if contador_porcentaje = 0 then
		insert into dbestacion:recargos values ( year(today), Month(today), 1.47 );
		Let v_status = 1;
		Let v_leyenda = 'Creo registro';
	else
		Let v_status = 0;
		Let v_leyenda = 'Existe registro';
	end if;
else
	Let v_status = 0;
	Let v_leyenda = 'Aun el dia actual no es mayor de 5';
end if;

	RETURN v_status, v_leyenda;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_remesa_001 ( parOpc char(1), parPlaca char(7), parFolio int, parAxo int, parCodigo int, parSub_Codigo int, 
parusuauto integer, parautoriza char(20), parobs char(50), parsol_rfc char(13), parsol_motivo char(200), parRemesa char(20) )
  	Returning 	int as status,
		varchar(200) as leyenda;

define v_status	int;
define v_leyenda	varchar(200);
define varcontrol	int;

DEFINE vv_status				int;
DEFINE vv_Folio				Char(12);
DEFINE vv_Mpio, v_NumRem			Integer;
DEFINE vv_TipoAct				Char(2);
DEFINE vv_Placa				Char(9);
DEFINE vv_FecPgo, vv_FecCan, vv_FecAlt	Date;
DEFINE vv_FolioEcMpio			Char(50);
DEFINE vv_Gastos				Decimal(18,2);

Let v_status = 1;
Let v_leyenda = 'Termino correcto';

Let varcontrol = 0;

if not exists( SELECT *  FROM dbestacion:ta14_folios_histo WHERE folio = parFolio and axo = parAxo and codigo_movto = parCodigo and sub_codigo = parSub_Codigo ) then

	if exists( SELECT *  FROM dbestacion:ta14_folios_adeudo WHERE placa = parPlaca and folio = parFolio and axo = parAxo ) then

		-- CREA EL HISTORICO
		insert into dbestacion:ta14_folios_histo 
		select 0, today, axo, folio, fecha_folio, placa, infraccion, estado, vigilante, num_acuerdo, fec_cap, usu_inicial, parCodigo, parusuauto, zona, espacio, parSub_Codigo 
		from dbestacion:ta14_folios_adeudo where axo = parAxo and folio = parFolio;

		let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
		if parOpc = 'S' then 
			insert into ta14_condonado (control, autoriza, observacion, solicitante_rfc, solicitante_motivo) 
     				values ( varcontrol, parautoriza, parobs, parsol_rfc, parsol_motivo); 
		end if; 

		delete from ta14_folios_adeudo where axo = parAxo and folio = parFolio; 

		foreach
		EXECUTE PROCEDURE sp14_remesa_ind ( parPlaca, parFolio, parCodigo, parSub_Codigo )  
		INTO  vv_status, vv_Mpio, vv_TipoAct, vv_Folio, vv_Placa, vv_FecPgo, vv_FecCan, vv_FecAlt, vv_FolioEcMpio, vv_Gastos

		EXECUTE PROCEDURE sp14_remesa_greg_ind ( vv_Mpio, vv_TipoAct, vv_Folio, vv_Placa, vv_FecPgo, vv_FecCan, vv_FecAlt, vv_FolioEcMpio, vv_Gastos, parRemesa );
		end foreach;

		Let v_status = 1; 
		Let v_leyenda = 'Se creo historico y se borro adeudo';
	else
		Let v_status = -1;
		Let v_leyenda = 'No Existe Adeudo';
	end if;
else
	Let v_status = -1;
	Let v_leyenda = 'ya existe';
end if;

Return v_status, v_leyenda  with resume;

END PROCEDURE;

create PROCEDURE "pgmoreno".cons14_solicrep_b ( parCveInf int, parOpc int, parFec_Inicio Date, parFec_Fin Date )

Returning   varchar(80) as Descrip,
	date as Fecha_movto,
	int as Aso,
	int as Folio,
	int as Clave,
	date as Fecha_Folio,
	char(7) as Placa,
	date as Fecha_Captura,
	decimal(5,2) as Porc,
	money(12,2) as Tarifa,
	money(12,2) as Dscto,
	money(12,2) as Pago,
	int as Contador;

define v_Contador					int;
define vif_clave					int;
define vif_descripcion				char(30);

define v_Codigo_Movto, v_Sub_Codigo			int;
define v_Descrip_Movto, v_Descrip_SubMovto		varchar(40);
define v_Descripcion					varchar(80);

define v_Axo, v_Folio				int;
define v_Cve					int;
define v_Fecha_Movto, v_Fecha_Folio, v_Fec_Cap	date;
define v_Placa					char(7);
define v_Tarifa, v_Dscto				money(12,2);
define v_Porc					decimal(5,2);

Let v_Contador = 0;

Let vif_clave = 0;
Let vif_descripcion = ' ';

Let v_Codigo_Movto = 0;
Let v_Sub_Codigo = 0;
Let v_Descrip_Movto = ' ';
Let v_Descrip_SubMovto = ' ';
Let v_Descripcion = ' ';
	
Let v_Axo = 0;
Let v_Folio = 0;
Let v_Cve = 0;
Let v_Fecha_Movto = today;
Let v_Fecha_Folio = today;
Let v_Fec_Cap = today;
Let v_Placa = ' ';
Let v_Tarifa = 0;
Let v_Porc = 0;
Let v_Dscto = 0;

	if parOpc = 1 then	-- Folios Adeudo
		FOREACH
		SELECT a.Axo, a.Folio, a.infraccion, a.Fecha_Folio, a.Placa, a.fec_cap, b.tarifa  
		INTO  v_Axo, v_Folio, v_Cve, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa
		FROM ta14_folios_adeudo a, ta14_tarifas b
		WHERE a.fecha_folio BETWEEN parFec_Inicio AND parFec_Fin						-- a.infraccion = parCveInf AND 
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.axo, a.folio

		Let v_Contador = v_Contador + 1;
		RETURN Null, Null, v_Axo, v_Folio, v_Cve, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, Null, v_Contador  with resume;
		END FOREACH;
	end if;
	if parOpc = 2 then	-- Folios Pagados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.infraccion, a.fecha_folio, a.placa, a.fec_cap, (100 - c.porc_cobro), b.tarifa, nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Cve, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c
		WHERE a.infraccion = 5 and a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		IF v_Porc > 0 THEN
			RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_Cve, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto), v_Contador  with resume;
		END IF;
		END FOREACH;
	end if;
	if parOpc = 3 then	-- Folios Cancelados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, b.tarifa, a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,5,7,11,22,23)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, 0, v_Fecha_Folio, v_Placa, v_Fec_Cap, 0, v_Tarifa, 0, 0, v_Contador  with resume;
		END FOREACH;
	end if;
	if parOpc = 4 then	-- Folios Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, b.tarifa, a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (2,15,16,17,18,19,20,21,25)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, 0, v_Fecha_Folio, v_Placa, v_Fec_Cap, 0, v_Tarifa, 0, 0, v_Contador  with resume;
		END FOREACH;
	end if;
	if parOpc = 5 then	-- Folios Cancelados y Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, b.tarifa, a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,2,5,7,11,15,16,17,18,19,20,21,22,23, 25)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, 0, v_Fecha_Folio, v_Placa, v_Fec_Cap, 0, v_Tarifa, 0,0, v_Contador  with resume;
		END FOREACH;
	end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_afolios ( parPlaca char(7) )
	returning char(2) as tipoact,
		char(7) as placa,
		integer as axo,
		integer as folio,
		date as fechaalta,
		date as fechapago,
		date as fechacancelado,
		money(12,2) as importe,
		varchar(50) as folioecmpio,
		varchar(20) as remesa,
		date as fecharemesa,
		varchar(120) as concepto;

define v_orden		char(1);
define v_tipoact		char(2);
define v_placa		char(7);
define v_axo, v_folio, v_codigo_movto				integer;
define v_fechaalta, v_fechapago, v_fechacancelado, v_fecharemesa	date;
define v_fecha_movto, v_fecha_folio	date;
define v_importe		money(12,2);
define v_folioecmpio	varchar(50);
define v_remesa		varchar(20);
define v_concepto		varchar(120);
define v_descripcion	varchar(40);
define v_folio_const		decimal(12,0);
define v_folio_const_b	char(12);

 -- opc 'A' por Placa
 -- opc 'B' por Axo y Folio
 -- opc 'C' por Placa(s) y Folio(s)  hasta 3 placas y hasta 10 folios

Let v_folio_const = 0;
Let v_folio_const_b = '';
          
	begin
    		on exception in (-958)
       			delete from tmp_placafolios;
    		end exception;
	create temp table tmp_placafolios(
	Orden		char(1),
	tipoact		char(2),
	placa		char(7),
	axo		integer,
	folio		integer,
	fechaalta	date,
	fechapago	date,
	fechacancelado	date,
	importe		money(12,2),
	folioecmpio	varchar(50),
	remesa		varchar(20),
	fecharemesa	date,
	concepto		varchar(120) ) with no log;
	end;

	FOREACH  -- Envio de la Alta al Estado
	SELECT 'A', tipoact, placa, substr(folio,1,4), substr(folio,5,7), fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Enviado al Edo. como Adeudo'  
	INTO	v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
	FROM ta14_datos_mpio   WHERE placa = parPlaca and tipoact = 'A'   ORDER BY placa, folio

	INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
				v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto );
	END FOREACH;

	FOREACH	  -- Pagos Recibidos del Estado
	SELECT 'C', b.tipoact, placa, substr(b.folio,1,4), substr(b.folio,5,7), b.fechaalta, b.fechapago, b.fechacancelado, b.importe, b.folioecmpio, b.remesa, b.fecharemesa
	INTO	v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa
	FROM ta14_datos_edo b   WHERE b.placa = parPlaca   ORDER BY b.tipoact, b.fecharemesa

	INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
				v_importe, v_folioecmpio, v_remesa, v_fecharemesa, 'Pago Recibido del Edo.' );
	END FOREACH;

	FOREACH  -- Pagos y/o Cancelaciones diferentes del Estado
	SELECT a.placa, a.axo, a.folio, a.codigo_movto, a.fecha_movto, a.fecha_folio, Trim(b.descripcion)    
	INTO	v_placa, v_axo, v_folio, v_codigo_movto, v_fecha_movto, v_fecha_folio, v_descripcion
	FROM ta14_folios_histo a, ta14_codigomovtos b 
	WHERE a.placa = parPlaca   and a.codigo_movto <> 6   and b.codigo_movto = a.codigo_movto  
	ORDER BY a.placa, a.axo, a.folio, a.codigo_movto

	if v_fecha_folio > MDY(05,31,2005) then

	if exists( SELECT * FROM ta14_datos_mpio WHERE placa = v_placa and folio = (( v_axo * 10000000) + v_folio ) and tipoact <> 'A' ) then
		FOREACH
		SELECT 'B', tipoact, fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Pago o Cancelacion enviado al Edo.'
		INTO	v_orden, v_tipoact, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
		FROM ta14_datos_mpio WHERE placa = v_placa and folio = (( v_axo * 10000000) + v_folio ) and tipoact <> 'A'
		ORDER BY tipoact, fecharemesa

		INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
						v_importe, v_folioecmpio, v_remesa, v_fecharemesa, Trim(v_concepto) ||'-- '|| Trim(v_descripcion) );
		END FOREACH;
	else
		if v_codigo_movto in (3,4,6,8,9,10,13,24) then
		--if (v_codigo_movto = 3) or (v_codigo_movto = 4) or (v_codigo_movto = 5) or (v_codigo_movto = 8) or (v_codigo_movto = 9) or (v_codigo_movto =10) or (v_codigo_movto =13) or (v_codigo_movto = 24) then
			INSERT INTO tmp_placafolios VALUES ( 'B', 'PN', v_placa, v_axo, v_folio, v_fecha_folio, v_fecha_movto, Null, Null, Null, Null, Null, 'Pagos Realizados sin env�o al Edo. -- '|| Trim(v_descripcion) );
		else
			INSERT INTO tmp_placafolios VALUES ( 'B', 'C', v_placa, v_axo, v_folio, v_fecha_folio, Null, v_fecha_movto, Null, Null, Null, Null, 'Cancelaciones Realizadas sin env�o al Edo. -- '|| Trim(v_descripcion) );
		end if;

	end if;

	else

	if exists( SELECT * FROM ta14_datos_mpio WHERE placa = v_placa and folio = v_folio and tipoact <> 'A' ) then
		FOREACH
		SELECT 'B', tipoact, fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Pago o Cancelacion enviado al Edo.'
		INTO	v_orden, v_tipoact, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
		FROM ta14_datos_mpio WHERE placa = v_placa and folio = v_folio and tipoact <> 'A'
		ORDER BY tipoact, fecharemesa

		INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
						v_importe, v_folioecmpio, v_remesa, v_fecharemesa, Trim(v_concepto) ||'-- '|| Trim(v_descripcion) );
		END FOREACH;
	else
		if v_codigo_movto in (3,4,6,8,9,10,13,24) then
		--if (v_codigo_movto = 3) or (v_codigo_movto = 4) or (v_codigo_movto = 5) or (v_codigo_movto = 8) or (v_codigo_movto = 9) or (v_codigo_movto =10) or (v_codigo_movto =13) or (v_codigo_movto = 24) then
			INSERT INTO tmp_placafolios VALUES ( 'B', 'PN', v_placa, v_axo, v_folio, v_fecha_folio, v_fecha_movto, Null, Null, Null, Null, Null, 
						'Pagos Realizados sin env�o al Edo. -- '|| Trim(v_descripcion) );
		else
			INSERT INTO tmp_placafolios VALUES ( 'B', 'C', v_placa, v_axo, v_folio, v_fecha_folio, Null, v_fecha_movto, Null, Null, Null, Null, 
						'Cancelaciones Realizadas sin env�o al Edo. -- '|| Trim(v_descripcion) );
		end if;
	end if;

	end if;
			
	END FOREACH;
	--
	FOREACH  -- Generacion de datos de salida
	SELECT 	Orden, tipoact, placa, axo, folio, 
		fechaalta, fechapago, fechacancelado, 
		importe, folioecmpio, remesa, fecharemesa, concepto
	INTO  v_orden, v_tipoact, v_placa, v_axo, v_folio, 
		v_fechaalta, v_fechapago, v_fechacancelado, 
		v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
	FROM tmp_placafolios
	ORDER BY placa, axo, folio, Orden 

	RETURN v_tipoact, v_placa, v_axo, v_folio, 
		v_fechaalta, v_fechapago, v_fechacancelado, 
		v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto    with resume;
	END FOREACH;

end procedure;

CREATE PROCEDURE "pgmoreno".admin_cancela_23x( p_id_admin_pag integer,
p_folio_pag varchar(10),p_usuario_canc varchar(10) )
{######################################################################
#  Procedimiento:    admin_pago_23
#  Descripcion:      Interfaz de cancelacion del pago de estacionamientos exclusivo en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            04 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_pubid   int;
define v_cvepagorbo       CHAR(1);
define v_axo int;
define v_mes int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);
define v_res2 int ; define v_res3 varchar(50);
define v_placa char(1); define v_baliza char(1);
define v_tipo int; define v_no_exclusivo int;
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Estacionamientos Exclusivos' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja, id_regmodulo, rfcnumero ,id_modulo, cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag , v_pubid, v_no_exclusivo ,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;
--if v_fecha_pag <> today then
--   let v_leyenda = 'EL RECIBO NO SE CANCELA POR SER DE OTRO DIA';
--   let v_estatus = 4;
--   RETURN v_estatus,v_leyenda;
--end if;


if v_id_modulo <> 28 then
   let v_leyenda = 'EL RECIBO NO ES POR ESTACIONAMIENTOS EXCLUSIVOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

      BEGIN WORK;
      let v_r = 'S';
      update db_ingresos: ta_12_recibos set cvepago='C', fecha_act=today
      where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);
-- verificar si tiene forma , balizamiento, placa.

select 'S' into v_placa
 from ex_adeudo_histo where ex_contrato_id = v_pubid 
   and  fecha_movto = v_fecha_pag and pag_reca = v_rec_pag and
   pag_caja = v_caja_pag and  pag_operacion = p_id_admin_pag and tipo = 23;
  if v_placa is null then
   let v_placa = 'N';
   end if;
 
select 'S' into v_baliza
 from ex_adeudo_histo where ex_contrato_id = v_pubid 
   and  fecha_movto = v_fecha_pag and pag_reca = v_rec_pag and
   pag_caja = v_caja_pag and  pag_operacion = p_id_admin_pag and tipo = 24;
   if v_baliza is null then
   let v_baliza = 'N';
   end if;
 
  FOREACH
  select id , Axo, mes , tipo
  into v_adeudo_id,  v_axo , v_mes , v_tipo 
  from  ex_adeudo_histo where ex_contrato_id  = v_pubid 
   and  fecha_movto = v_fecha_pag and pag_reca = v_rec_pag and
   pag_caja = v_caja_pag and  pag_operacion = p_id_admin_pag 
   order by 1,2
   if v_tipo = 20 then
    execute procedure sp_exc_genadeudo(1 , v_pubid ,v_axo,v_mes,0,0, 1) into v_res , v_res1;
   end if;
  if v_tipo = 21 then
   execute procedure sp_exc_autorizacion( v_no_exclusivo , v_axo , v_mes , v_placa , v_baliza , 'S', 1 ) 
          into v_res2 , v_res3;
   end if;
  if v_tipo = 26 then
    execute procedure sp_exc_refrendo(v_pubid  , v_axo , 1 ) into v_res2 , v_res3;
  end if;
 if v_tipo = 27 then
    execute procedure sp_exc_refrendo(v_pubid  , v_axo , 1 ) into v_res2 , v_res3;
  end if;
  
    update ex_adeudo_histo set clave =11 , motivo = 'RBO/Canc - ' || trim(motivo)  where id = v_adeudo_id ;

     end foreach;
   
      
      COMMIT WORK; 
 


return v_estatus,v_leyenda;
--trace off;
END PROCEDURE;

CREATE PROCEDURE "informix".nk_encabezados_14(parPlaca char(7) , parkiosco int)
 returning
 varchar(92) as Nombre_completo,
 varchar(80) as domicilio,
 varchar(40) as Marca,
 varchar(40) as Linea,
 int         as num_folios,
 dec(14,2)   as total, 
 varchar(250) as descripcion,
 varchar(100) as mensaje,
 int as estatus;

define varok   smallint;
define varobs char(200);
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define v_nombre varchar(80);
define  v_domicilio varchar(80); 
define v_marca varchar(50);
define v_linea varchar(50);
define v_cant_fol int;
define d_r smallint;
define d_c int;
define d_cta int;
define  d_ref varchar(50);
define d_conc varchar(80);
define d_ori dec(12,2) ;
define d_imp dec(14,2) ;
define d_acum dec(14,2);
define v_desc varchar(250);

Select sum(folio) 
    into   vfolio  
    from ta14_folios_adeudo where placa = parplaca ;

if (vfolio is null ) or (vfolio = 0) then
return ' ' , ' ' ,' ' ,' ', 0, 0,'', 'NO HAY FOLIOS PARA ESTA PLACA' ,   -1;
else
select nvl(nombre, 's/registro') , nvl(domicilio, 's/registro') || ' Ext. ' || nvl(num_ext,'') || ' Col. ' || nvl(colonia, '') || ' , ' || nvl(municipio, '')  ,
nvl(marca, '') , nvl(linea,'')
into v_nombre ,v_domicilio , v_marca , v_linea
from ta_padron where placa = parplaca;
-- select * from ta_padron where linea is not null
if v_nombre is null then
let v_nombre = '';
let v_domicilio =  '';
end if;


-- execute procedure sp_desto35_fol_jul2018( parplaca ,999999);
-- buen fin 2018
-- otorgamiento de descuento general a folios con 'OFICIO D.I. 3197/2019' realizado el 28/06/2019
if today > mdy(06,30,2019) and today < mdy(08,01,2019)  then   
execute procedure sp_descto_placa_bf( parplaca );
end if;

let v_cant_fol = 0;
let v_desc = '';
delete from ta_temp_folio where kiosco = parkiosco and fecha = today and placa = parplaca;  
foreach
execute PROCEDURE admin_adeudos_detalle_16kio( parPlaca , '') into 
d_r , d_c , d_cta ,  d_ref , d_conc ,d_ori , d_imp , d_acum
let v_cant_fol = v_cant_fol + 1;
if v_cant_fol = 1 then
let v_desc = trim(d_ref);
else
let v_desc = v_desc || ','|| trim(d_ref);
end if;
insert into ta_temp_folio ( kiosco, fecha, placa, axo, folio, descripcion,  cta_aplicacion , importe,  apagar )
     values( parkiosco , today , parplaca , d_r , d_c ,d_conc ,d_cta ,d_ori , d_imp);
end foreach;
 
return v_nombre , v_domicilio ,v_marca, v_linea ,v_cant_fol, d_acum , v_desc ,  'Existen folios para cobrar' ,   0;
END IF;

end procedure;

CREATE PROCEDURE "informix".nk_adeudos_detalle_14(parPlaca char(7) , parkiosco int)
 returning
 varchar(7) as placa,
 smallint   as axo , 
 int        as folio,
 varchar(50) as descripcion,
 int         as cta_aplicacion,
 dec(14,2)   as importe,
 dec(14,2)  as apagar;

 define v_placa varchar(7);
 define v_axo smallint ;
 define v_folio int;
 define v_descripcion varchar(50);
 define v_cta_aplicacion int;
 define v_importe dec(14,2);
 define v_apagar dec(14,2);
 define vfolio int;

Select sum(folio) into   vfolio  
    from ta_temp_folio where kiosco = parkiosco and fecha = today and placa = parplaca;

if (vfolio is null ) or (vfolio = 0) then
return '' , 0 ,0 , 'NO HAY FOLIOS PARA ESTA PLACA',0,0 , 0;
else
foreach
select  placa  , axo  , folio  , descripcion , cta_aplicacion  , importe ,  apagar 
into
      v_placa  , v_axo  , v_folio  , v_descripcion , v_cta_aplicacion  , v_importe ,  v_apagar 
 from ta_temp_folio where kiosco = parkiosco and fecha = today and placa = parplaca

  
return v_placa  , v_axo  , v_folio  , v_descripcion || 'imp: '|| v_importe , v_cta_aplicacion  , v_importe ,  v_apagar with resume;

end foreach;
 

END IF;

end procedure;

CREATE PROCEDURE "pgmoreno".sp_del_dsctos_buenfin ()
	returning VarChar(200) as Concepto_status;

define v_axo, v_folio	int;

Let v_axo = 0;
Let v_folio = 0;

foreach
SELECT axo, folio  INTO v_axo, v_folio 
FROM ta14_folios_free WHERE fecha_otorga < mdy(08,01,2019) and obs = '50% OFICIO D.I. 3197/2019'

	if exists ( select * from ta14_folios_histo where axo = v_axo and folio = v_folio ) then
		RETURN 'El folio '||v_axo||'-'||v_folio||' ya esta pagado'  with resume;
	else
		DELETE FROM ta14_folios_free WHERE AXO = v_axo AND FOLIO = v_folio;
		RETURN 'Borrado el descuento del folio '||v_axo||'-'||v_folio  with resume;
	end if;
end foreach;

end procedure;

create procedure "pgmoreno".sp_gmg_pagosxx ( par_auto_6 int, par_auto_8 int, par_s_transm_n int, par_referencia char(20), par_importe money(12,2), par_FechaPago Date )
	returning	int as id,
			varchar(255) as mensaje; 

define v_status_recep		int;
define v_leyenda_recep	varchar(255);

define v_reca int;
define v_caja char(2);
define v_oper int;
define v_descrip char(240);
define v_notif char(200);
define v_linea28 char(28);


define v_status		int;
define v_leyenda	varchar(255);
define v_existe		int;
define par_ref_placa	char(7);
define par_autorizacion char(28);
define par_auto_8_11	char(11);
define par_auto_6_17	char(17);
define par_s_transm 	char(20);
define v_rowid, v_rowid_2		int;

Let v_status_recep = 0;
Let v_leyenda_recep = 'No hizo recep';

Let v_reca = 0;
Let v_caja = '';
Let v_oper = 0;
Let v_descrip = '';
Let v_notif = '';
Let v_linea28 = '';

Let v_status = 0;
Let v_leyenda = 'No hizo nada';
Let v_rowid = 0;
Let v_rowid_2 = 0;

if trim(par_referencia)='' then
	let par_ref_placa = 'NADA';
else
	if length(par_referencia) = 18 then
   		let par_ref_placa = substr ( par_referencia,1,7);
	end if;
	if length(par_referencia) = 17 then
   		let par_ref_placa = substr ( par_referencia,1,6);
	end if;
	if length(par_referencia) = 16 then
   		let par_ref_placa = substr ( par_referencia,1,5);
	end if;
end if;

Let v_existe = 0;
--select count(*) INTO v_existe from db_ingresos:ta_12_recibos  
--where fec_pagobco = par_FechaPago and caja = 'I1' and cvepago = 'P' and kio_num_terceros = Trim(par_ref_placa) and importe = par_importe;

if v_existe = 0 then

	Let par_auto_8_11 = LPAD(par_auto_8,11,'0');
	Let par_auto_6_17 = LPAD(par_auto_6,17,'0');
	Let par_autorizacion = par_auto_8_11 || par_auto_6_17;

	Let par_s_transm = LPAD(par_s_transm_n,20,'0');

	execute procedure sp_multipagos_recep ( par_autorizacion, 3,1, par_s_transm, Trim(par_referencia), par_importe, '' ,0,1)
	into v_status_recep, v_leyenda_recep;

	execute procedure kioscopago_foliosTCa ( par_s_transm_n, par_importe, 500, 98, par_s_transm_n, '', 2, '')
	into v_reca, v_caja, v_oper, v_descrip, v_notif, v_linea28;

	foreach
	select rowid into v_rowid from db_ingresos:ta_12_recibos where fecha = today and caja = 'I1' and kio_num_terceros = Trim(par_ref_placa)
	if v_rowid > 0 then
		Let v_rowid_2 = v_rowid;
	end if;
	end foreach;
	update  db_ingresos:ta_12_recibos set fec_pagobco = par_FechaPago where rowid = v_rowid_2;

	Let v_status = 1;
	Let v_leyenda = 'Lo registro, revisa';
else
	Let v_status = -1;
	Let v_leyenda = 'Ya existe el registro';
end if;

return v_status, v_leyenda;

end procedure;

create PROCEDURE "pgmoreno".sp14_mpio_vs_edo ( parOpc int, parFec_Inicio Date, parFec_Fin Date )

Returning	date as Fecha_movto,
	decimal(12,0) as Folio,
	int as Clave,
	date as Fecha_Folio,
	char(7) as Placa,
	date as Fecha_Captura,
	decimal(5,2) as Porc_Apl,
	money(12,2) as Tarifa,
	money(12,2) as Dscto,
	money(12,2) as Pago_Mpio,
	money(12,2) as Pago_Edo,
	date as FechaPago_Edo,
	money(12,2) as Dif;



define v_Fecha_Movto, v_Fecha_Folio, v_Fec_Cap, v_FechaPago_Edo	date;
define v_Axo, v_Cve						int;
define v_folio decimal(12,0);
define v_Placa							char(7);
define v_Porc							decimal(5,2);
define v_Tarifa, v_Dscto, v_Pago_Mpio, v_Pago_Edo, v_Dif			money(12,2);

Let v_Axo = 0;
Let v_Folio = 0;
Let v_Cve = 0;						
Let v_Placa = '';
Let v_Porc = 0;
Let v_Tarifa = 0;
Let v_Dscto = 0;
Let v_Pago_Mpio = 0;
Let v_Pago_Edo = 0;
Let v_Dif = 0;

if parOpc = 1 then
FOREACH
SELECT a.fecha_movto, (( a.axo * 10000000) + a.folio ), a.infraccion, a.fecha_folio, a.placa, a.fec_cap,
(100 - c.porc_cobro) Porc_Aplic, b.tarifa + b.costo_fijo01, nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0),
(b.tarifa + b.costo_fijo01) - nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0),
d.importe, d.fechapago, ((b.tarifa + b.costo_fijo01) - nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0)) - d.importe

INTO  v_Fecha_Movto, v_Folio, v_Cve, v_Fecha_Folio, v_Placa, v_Fec_Cap,
v_Porc, v_Tarifa, v_Dscto, v_Pago_Mpio, v_Pago_Edo, v_FechaPago_Edo, v_Dif

FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c, outer ta14_datos_edo d
WHERE a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin  AND a.codigo_movto in (6)
AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
AND d.folio = (( a.axo * 10000000) + a.folio ) and d.placa = a.placa
ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

RETURN v_Fecha_Movto, v_Folio, v_Cve, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Pago_Mpio, v_Pago_Edo, v_FechaPago_Edo, v_Dif  with resume;
END FOREACH;
--else

end if;

end procedure;

create PROCEDURE "pgmoreno".cons14_solicrep_beny ( parPlaca char(7) )

Returning  int as Infraccion,
	int as Axo_Folio,
	int as Id_Placa,
	varchar(60) as Nombre,
	varchar(60) as Domicilio,
	money(12,2) as Adeudo;

define aso_proceso, v_axoinicio, aso_actual		int;
define v_nombre, v_domicilio				varchar(60);
define v_IdPlaca, v_Axo, v_Porc, v_num_clave		int;
define v_Tarifa, v_Dscto, v_Adeudo, v_Adeudo_tot		money(12,2);

Let aso_proceso = 0;
Let v_axoinicio = 0;
Let aso_actual = 0;
Let v_num_clave = 0;
Let v_nombre = '';
Let v_domicilio = '';
Let v_IdPlaca = 0;
Let v_Axo = 0;
Let v_Porc = 0;
Let v_Tarifa = 0;
Let v_Dscto = 0;
Let v_Adeudo = 0;
Let v_Adeudo_tot = 0;

SELECT min(axo) INTO v_axoinicio  FROM ta14_folios_adeudo WHERE placa = parPlaca;
select id, Trim(nombre), Trim(domicilio) INTO v_IdPlaca, v_nombre, v_domicilio  FROM ta_padron where placa = parPlaca;

  Let aso_proceso = 0;
  Let aso_actual = Year(Current);
  FOR aso_proceso = v_axoinicio to aso_actual
	FOREACH
	SELECT num_clave INTO v_num_clave FROM ta14_infraccion WHERE num_clave < 20 ORDER BY num_clave

		if exists (select * from ta14_folios_adeudo WHERE placa = parPlaca and axo = aso_proceso and infraccion = v_num_clave ) then
			FOREACH
			SELECT  b.tarifa, (100 - c.porc_cobro), trunc(nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2), trunc(b.tarifa - nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2) 
				INTO  v_Tarifa, v_Porc, v_Dscto, v_Adeudo
				FROM ta14_folios_adeudo a, ta14_tarifas b, outer ta14_folios_free c
				WHERE a.placa = parPlaca  and a.axo = aso_proceso  and a.infraccion = v_num_clave
				AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
				AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
				ORDER BY a.axo, a.folio

				Let v_Adeudo_tot = v_Adeudo_tot + v_Adeudo;
			END FOREACH;

			RETURN v_num_clave, aso_proceso, v_IdPlaca, v_nombre, v_domicilio, v_Adeudo_tot    with resume;
			Let v_Adeudo_tot = 0;

		end if;
		--if v_Adeudo_tot  > 0 then
		--	RETURN aso_proceso, v_num_clave, v_IdPlaca, v_nombre, v_domicilio, v_Adeudo_tot    with resume;
		--	Let v_Adeudo_tot = 0;
		--end if;

	END FOREACH;
  END FOR;

end procedure;

create PROCEDURE "pgmoreno".cons14_solicrep_beny2_det ( parPlaca char(7) )

Returning  
	int as Axo_Folio,
	int as Folio,
	char(7) as Placa,
	int as Infraccion,
	money(12,2) as Adeudo;

define v_Porc, v_Folio, v_Axo, v_infraccion		int;
define v_Tarifa, v_Dscto, v_Adeudo	money(12,2);
define v_fecha_folio, v_fecha_hoy	date;
define v_valido						int;

Let v_infraccion = 0;
Let v_Axo = 0;
Let v_Folio = 0;
Let v_Porc = 0;
Let v_Tarifa = 0;
Let v_Dscto = 0;
Let v_Adeudo = 0;
Let v_fecha_hoy = Current;
Let v_valido = 0;

FOREACH
SELECT  a.axo, a.folio, a.infraccion, a.fecha_folio, b.tarifa, 
	(100 - c.porc_cobro), trunc(nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2), trunc(b.tarifa - nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2)
	INTO  v_Axo, v_Folio, v_infraccion, v_fecha_folio, v_Tarifa, 
	v_Porc, v_Dscto, v_Adeudo
	FROM ta14_folios_adeudo a, ta14_tarifas b, outer ta14_folios_free c
	WHERE a.placa = parPlaca 
	AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
	AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
	ORDER BY a.infraccion, a.axo, a.folio

	select count(*) into v_valido from catastro_gdl:no_laborales where fecha between v_fecha_folio and v_fecha_hoy;
	if v_valido > 5 then
		RETURN v_Axo, v_Folio, parPlaca, v_infraccion, v_Adeudo   with resume;
		Let v_Adeudo = 0;
		Let v_valido = 0;
	end if;
				
END FOREACH;

end procedure;

create function "informix".get_odoo_cta(i_cta int , i_interface smallint) 
returning  int as cta_odoo;
define o_cta_odoo int;
select cta_odoo into o_cta_odoo from db_ingresos:ta_12_ctas_odoo where axo = year(today) and cta_aplic = i_cta and interface = i_interface;
return o_cta_odoo;
end function;

CREATE PROCEDURE  "informix".odoo_datos_varios_19 ( p_numesta int )
 returning  varchar(20) as campo, 
	varchar(150) as sdato_vario;

define v_codigo int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(100);
define  v_calle varchar(100); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define adeudo int;
define  v_movto_cve char(1); 
define v_numext char(6);
define v_zona int;
define v_subzona int;
define v_numlic int;
define v_tipo char(1);
define v_ubicacion varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);

   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
      RETURN  ' ', 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   END EXCEPTION; 
let v_codigo = -1;
let  v_id  = 0; 
let v_numesta = 0;

let   v_descripcion = '' ;
let v_cupo =0;
let  v_movto_cve =''; 


select nvl(a.id,0) , a.numesta, a.zona, a.subzona, a.numlicencia,   b.descripcion , b.tipo, a.cupo , a.movto_cve , trim(a.calle) || ' No. ' || trim(a.numext)
into v_id , v_numesta, v_zona , v_subzona  , v_numlic,  v_descripcion , v_tipo , v_cupo , v_movto_cve , v_ubicacion
 from pubmain  a , pubcategoria b
where a.numesta = p_numesta and b.id = a.pubcategoria_id;


if v_id > 0 then
return 'Tipo Estacionamiento', v_tipo with resume;
return 'Descripcion del Tipo', v_descripcion with resume;
return 'Cupo Cajones', v_cupo with resume;
return 'Licencia', v_numlic with resume;
return 'Zona', v_zona with resume;
return 'Sub-Zona', v_subzona with resume;
return 'Ubicacion', v_ubicacion with resume;
return 'Fundamento', 'Segun art. 56 Fracc. II de la ley de Ingresos Municipal 2014' with resume;
else
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
end if;

END PROCEDURE;

CREATE PROCEDURE  "informix".odoo_datos_varios_23 ( p_numesta int )
 returning  varchar(20) as campo, 
	varchar(150) as sdato_vario;

define v_codigo int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(100);
define  v_calle varchar(100); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define adeudo int;
define  v_movto_cve char(1); 
define v_numext char(6);
define v_zona char(1);
define v_telefono char(15);
define v_bateria decimal(6,2);
define v_cordon decimal(6,2);
define v_categoria char(25);
define v_ubicacion varchar(100);

let v_codigo = -1;
let  v_id  = 0; 
let v_numesta = 0;

let   v_descripcion = '' ;
let v_cupo =0;
let  v_movto_cve =''; 


--select a.* , b.* , c.concepto from ex_contrato a , ex_propietario b where a.ex_propietario_id = b.id;
select nvl(a.id,0) , a.no_exclusivo, a.zona , b.telefono , a.total_bateria , a.total_cordon  
, c.concepto 
into v_id , v_numesta, v_zona , v_telefono  , v_bateria , v_cordon,  v_categoria
 from ex_contrato a , ex_propietario b, ex_clasificacion c
 where a.no_exclusivo = p_numesta and a.ex_propietario_id = b.id and c.id = a.id_clasificacion ;

if v_id > 0 then
 select    first 1   trim(nvl(calle,'.')) || ' Col. ' || trim(nvl(colonia,'.')) 
    into v_ubicacion from ex_ubicacion where ex_contrato_id = v_id and estatus = 'V';
end if;


if v_id > 0 then
return 'Zona', v_zona with resume;   -- ZOna
return 'Mts. Bateria', v_bateria with resume;  -- bateria
return 'Mts. Cordon', v_cordon with resume;    -- cordon
return 'Telefono', v_telefono with resume;  -- telefono
return 'Ubicacion', v_ubicacion with resume;  -- ubicacion 1
return ' ', '' with resume; -- ubicacion 2
return 'Categoria', v_categoria with resume;  -- categoria
else
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
return '', '' with resume;
end if;

END PROCEDURE;

create FUNCTION "pgmoreno".cons14_solicrep_pf ( parPlaca char(7), parAxo int, parFolio int )

Returning   money(12,2) as Adeudo;

define v_Adeudo	money(12,2);

Let v_Adeudo = 0;

FOREACH
SELECT  trunc(b.tarifa - nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2)
	INTO  v_Adeudo
	FROM ta14_folios_adeudo a, ta14_tarifas b, outer ta14_folios_free c
	WHERE a.placa = parPlaca and a.axo = parAxo and a.folio = parFolio 
	AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
	AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
	ORDER BY a.infraccion, a.axo, a.folio

END FOREACH;
RETURN v_Adeudo;
end FUNCTION;

create PROCEDURE "pgmoreno".cons14_placa_rangos ( parPlaca char(7), parAxo1 int, parAxo2 int, parRango1 int, parRango2 int, parRango1_Imp money(12,2), parRango2_Imp money(12,2) )

Returning 
	char(7) as Placa,
	varchar(60) as Nombre,
	varchar(60) as Domicilio,
	int as Cant_Folios,
	money(12,2) as Adeudo;

define v_nombre, v_domicilio								varchar(60);

define v_Axo, v_Folio, v_infraccion, v_Porc, v_Cant_Folios	int;
define v_fecha_folio, v_fecha_hoy							date;
define v_Tarifa, v_Dscto, v_Adeudo, v_Adeudo_tot			money(12,2);
define v_valido												int;

Let v_nombre = '';
Let v_domicilio = '';

Let v_Axo = 0;
Let v_Folio = 0;
Let v_infraccion = 0;
Let v_Porc = 0;
Let v_Cant_Folios = 0;

Let v_Tarifa = 0;
Let v_Dscto = 0;
Let v_Adeudo = 0;
Let v_Adeudo_tot = 0;

Let v_fecha_hoy = Current;
Let v_valido = 0;

SELECT Trim(nombre), Trim(domicilio)  INTO v_nombre, v_domicilio  FROM ta_padron where placa = parPlaca;

FOREACH
SELECT  a.axo, a.folio, a.infraccion, a.fecha_folio, b.tarifa, 
	(100 - c.porc_cobro), trunc(nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2), trunc(b.tarifa - nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2)
	INTO  v_Axo, v_Folio, v_infraccion, v_fecha_folio, v_Tarifa, 
	v_Porc, v_Dscto, v_Adeudo
	FROM ta14_folios_adeudo a, ta14_tarifas b, outer ta14_folios_free c
	WHERE a.placa = parPlaca and a.axo between parAxo1 and parAxo2
	AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
	AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
	ORDER BY a.infraccion, a.axo, a.folio

	select count(*) into v_valido from catastro_gdl:no_laborales where fecha between v_fecha_folio and v_fecha_hoy;
	if v_valido > 5 then
		Let v_Cant_Folios = v_Cant_Folios + 1;
		Let v_Adeudo_tot = v_Adeudo_tot + v_Adeudo;
		Let v_Adeudo = 0;
		Let v_valido = 0;
	end if;
				
END FOREACH;

	if (v_Cant_Folios >= parRango1) and (v_Cant_Folios <= parRango2) then
		if (v_Adeudo_tot >= parRango1_Imp) and (v_Adeudo_tot <= parRango2_Imp) then
			RETURN parPlaca, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot   with resume;
		end if;
	end if;
	
end procedure;

CREATE PROCEDURE "pgmoreno".sp14_bfolios ( parPlaca char(7) )
	returning char(2) as tipoact,
		char(7) as placa,
		integer as axo,
		integer as folio,
		date as fechaalta,
		date as fechapago,
		date as fechacancelado,
		money(12,2) as importe,
		varchar(50) as folioecmpio,
		varchar(20) as remesa,
		date as fecharemesa,
		varchar(120) as concepto,
		date as fecha_in,
		date as fecha_fin,
		date as fecha_aplic;

define v_orden		char(1);
define v_tipoact		char(2);
define v_placa		char(7);
define v_axo, v_folio, v_codigo_movto				integer;
define v_fechaalta, v_fechapago, v_fechacancelado, v_fecharemesa	date;
define v_fecha_movto, v_fecha_folio	date;
define v_importe		money(12,2);
define v_folioecmpio	varchar(50);
define v_remesa		varchar(20);
define vn_remesa		int;
define v_concepto		varchar(120);
define v_descripcion	varchar(40);
define v_folio_const		decimal(12,0);
define v_folio_const_b	char(12);

define vn_fecha_in, vn_fecha_fin, vn_fecha_aplic date;

 -- opc 'A' por Placa
 -- opc 'B' por Axo y Folio
 -- opc 'C' por Placa(s) y Folio(s)  hasta 3 placas y hasta 10 folios

Let v_folio_const = 0;
Let v_folio_const_b = '';
Let vn_remesa = 0;
          
	begin
    		on exception in (-958)
       			delete from tmp_placafolios;
    		end exception;
	create temp table tmp_placafolios(
	Orden		char(1),
	tipoact		char(2),
	placa		char(7),
	axo		integer,
	folio		integer,
	fechaalta	date,
	fechapago	date,
	fechacancelado	date,
	importe		money(12,2),
	folioecmpio	varchar(50),
	remesa		varchar(20),
	fecharemesa	date,
	concepto		varchar(120) ) with no log;
	end;

	FOREACH  -- Envio de la Alta al Estado
	SELECT 'A', tipoact, placa, substr(folio,1,4), substr(folio,5,7), fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Enviado al Edo. como Adeudo'  
	INTO	v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
	FROM ta14_datos_mpio   WHERE placa = parPlaca and tipoact = 'A'   ORDER BY placa, folio

	INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
				v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto );
	END FOREACH;

	FOREACH  -- Pagos Recibidos del Estado
	SELECT 'C', b.tipoact, placa, substr(b.folio,1,4), substr(b.folio,5,7), b.fechaalta, b.fechapago, b.fechacancelado, b.importe, b.folioecmpio, b.remesa, b.fecharemesa
	INTO	v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa
	FROM ta14_datos_edo b   WHERE b.placa = parPlaca   ORDER BY b.tipoact, b.fecharemesa

	INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
				v_importe, v_folioecmpio, v_remesa, v_fecharemesa, 'Pago Recibido del Edo.' );
	END FOREACH;

	FOREACH  -- Pagos y/o Cancelaciones diferentes del Estado
	SELECT a.placa, a.axo, a.folio, a.codigo_movto, a.fecha_movto, a.fecha_folio, Trim(b.descripcion)    
	INTO	v_placa, v_axo, v_folio, v_codigo_movto, v_fecha_movto, v_fecha_folio, v_descripcion
	FROM ta14_folios_histo a, ta14_codigomovtos b 
	WHERE a.placa = parPlaca   and a.codigo_movto <> 6   and b.codigo_movto = a.codigo_movto  
	ORDER BY a.placa, a.axo, a.folio, a.codigo_movto

	if v_fecha_folio > MDY(05,31,2005) then

	if exists( SELECT * FROM ta14_datos_mpio WHERE placa = v_placa and folio = (( v_axo * 10000000) + v_folio ) and tipoact <> 'A' ) then
		FOREACH
		SELECT 'B', tipoact, fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Pago o Cancelacion enviado al Edo.'
		INTO	v_orden, v_tipoact, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
		FROM ta14_datos_mpio WHERE placa = v_placa and folio = (( v_axo * 10000000) + v_folio ) and tipoact <> 'A'
		ORDER BY tipoact, fecharemesa

		INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
						v_importe, v_folioecmpio, v_remesa, v_fecharemesa, Trim(v_concepto) ||'-- '|| Trim(v_descripcion) );
		END FOREACH;
	else
		if v_codigo_movto in (3,4,6,8,9,10,13,24) then
		--if (v_codigo_movto = 3) or (v_codigo_movto = 4) or (v_codigo_movto = 5) or (v_codigo_movto = 8) or (v_codigo_movto = 9) or (v_codigo_movto =10) or (v_codigo_movto =13) or (v_codigo_movto = 24) then
			INSERT INTO tmp_placafolios VALUES ( 'B', 'PN', v_placa, v_axo, v_folio, v_fecha_folio, v_fecha_movto, Null, Null, Null, Null, Null, 'Pagos Realizados sin env�o al Edo. -- '|| Trim(v_descripcion) );
		else
			INSERT INTO tmp_placafolios VALUES ( 'B', 'C', v_placa, v_axo, v_folio, v_fecha_folio, Null, v_fecha_movto, Null, Null, Null, Null, 'Cancelaciones Realizadas sin env�o al Edo. -- '|| Trim(v_descripcion) );
		end if;

	end if;

	else

	if exists( SELECT * FROM ta14_datos_mpio WHERE placa = v_placa and folio = v_folio and tipoact <> 'A' ) then
		FOREACH
		SELECT 'B', tipoact, fechaalta, fechapago, fechacancelado, importe, folioecmpio, remesa, fecharemesa, 'Pago o Cancelacion enviado al Edo.'
		INTO	v_orden, v_tipoact, v_fechaalta, v_fechapago, v_fechacancelado, v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
		FROM ta14_datos_mpio WHERE placa = v_placa and folio = v_folio and tipoact <> 'A'
		ORDER BY tipoact, fecharemesa

		INSERT INTO tmp_placafolios VALUES ( v_orden, v_tipoact, v_placa, v_axo, v_folio, v_fechaalta, v_fechapago, v_fechacancelado, 
						v_importe, v_folioecmpio, v_remesa, v_fecharemesa, Trim(v_concepto) ||'-- '|| Trim(v_descripcion) );
		END FOREACH;
	else
		if v_codigo_movto in (3,4,6,8,9,10,13,24) then
		--if (v_codigo_movto = 3) or (v_codigo_movto = 4) or (v_codigo_movto = 5) or (v_codigo_movto = 8) or (v_codigo_movto = 9) or (v_codigo_movto =10) or (v_codigo_movto =13) or (v_codigo_movto = 24) then
			INSERT INTO tmp_placafolios VALUES ( 'B', 'PN', v_placa, v_axo, v_folio, v_fecha_folio, v_fecha_movto, Null, Null, Null, Null, Null, 
						'Pagos Realizados sin env�o al Edo. -- '|| Trim(v_descripcion) );
		else
			INSERT INTO tmp_placafolios VALUES ( 'B', 'C', v_placa, v_axo, v_folio, v_fecha_folio, Null, v_fecha_movto, Null, Null, Null, Null, 
						'Cancelaciones Realizadas sin env�o al Edo. -- '|| Trim(v_descripcion) );
		end if;
	end if;

	end if;
			
	END FOREACH;
	--
	FOREACH  -- Generacion de datos de salida
	SELECT 	Orden, tipoact, placa, axo, folio, 
		fechaalta, fechapago, fechacancelado, 
		importe, folioecmpio, remesa, fecharemesa, concepto
	INTO  v_orden, v_tipoact, v_placa, v_axo, v_folio, 
		v_fechaalta, v_fechapago, v_fechacancelado, 
		v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto
	FROM tmp_placafolios
	ORDER BY placa, axo, folio, Orden 

	if v_fecharemesa > mdy(02,23,2009) then
		if trim(v_remesa)='' then
			Let vn_remesa = 0;
		else
			-- dti_est_r435
			-- ayt_gdl_r1050		
			Let vn_remesa=substr(v_remesa,10,5);
		end if;

		if vn_remesa = 0 then
			Let vn_fecha_in = Null;
			Let vn_fecha_fin = Null;
			Let vn_fecha_aplic = Null;
		else
			if v_orden = 'A' then  -- Envio de la Alta al Estado
				select fecha_inicio, fecha_fin, fecha_hoy  INTO vn_fecha_in, vn_fecha_fin, vn_fecha_aplic 
				from ta14_bitacora where num_remesa = vn_remesa and tipo = 'B';
			end if;

			if v_orden = 'C' then  -- Pagos Recibidos del Estado
				select fecha_inicio, fecha_fin, fecha_hoy  INTO vn_fecha_in, vn_fecha_fin, vn_fecha_aplic 
				from ta14_bitacora where num_remesa = vn_remesa and tipo = 'A';
			end if;

			if v_orden = 'B' then  -- Pagos y/o Cancelaciones diferentes del Estado
				select fecha_inicio, fecha_fin, fecha_hoy  INTO vn_fecha_in, vn_fecha_fin, vn_fecha_aplic 
				from ta14_bitacora where num_remesa = vn_remesa and fecha_hoy = v_fecharemesa;
			end if;
		end if;
	else
		Let vn_fecha_in = Null;
		Let vn_fecha_fin = Null;
		Let vn_fecha_aplic = Null;
	end if;

	RETURN v_tipoact, v_placa, v_axo, v_folio, 
		v_fechaalta, v_fechapago, v_fechacancelado, 
		v_importe, v_folioecmpio, v_remesa, v_fecharemesa, v_concepto, vn_fecha_in, vn_fecha_fin, vn_fecha_aplic    with resume;
	END FOREACH;

end procedure;

create procedure "informix".sp14_notificacion_pruebas(pprop varchar(100),pinfd int, pinfh int, paxod int, paxoh int, 
pimpd money(18,2), pimph money(18,2),pplaca varchar(10),popc char(1))
    returning   int as id,
                varchar(10) as placa,
                int as infraccion,
                varchar(100) as nombre,
                varchar(100) as domicilio,
                int as axo,
                varchar(250) as folios,
                money(18,2) as adeudo,
                money(18,2) as adeudoplaca,
                money(18,2) as total_gasto,
                varchar(100) as marca,
                varchar(100) as submarca,
                varchar(100) as modelo,
                varchar(100) as motor,
                varchar(100) as serie,
                varchar(100) as color;

define vid_placa, vfolios, vtotal_placas, vtotal_folios int;
define vnombre varchar(100);
define vplaca varchar(10);
define dinfraccion, daxo, did int;
define dplaca varchar(10);
define dfolios varchar(250);
define dadeudo, dadeudoplaca, vtotal_gasto money(18,2);
define dnombre, ddomicilio, dmarca, dsubmarca, dmodelo, dmotor, dserie, dcolor varchar(100);


let vtotal_placas=0;
let vtotal_folios=0;

foreach
   -- ejecuta procedimeinto para sacarlos propietarios
   execute procedure dbestacion:sp14_propietarios(pprop, pinfd, pinfh, paxod, paxoh, pimpd, pimph, pplaca, popc)
      into vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios
   let dadeudoplaca=0;

   -- verifica si ya existen notificaciones de la placa
   let vtotal_gasto=0;
   select nvl(sum(importe_gastos),0) into vtotal_gasto from db_ingresos:ta_15_apremios where modulo=14 and control_otr=vid_placa
     and clave_practicado='P' and vigencia='1';

   foreach
     -- ejecuta procedimiento para detallar por a�o cada placa de propietarios 
     execute PROCEDURE dbestacion:cons14_solicrep_beny2(vplaca) into dinfraccion, daxo, dfolios, dadeudo, did, dplaca,
        dnombre, ddomicilio, dmarca, dsubmarca, dmodelo, dmotor, dserie, dcolor
     let dadeudoplaca=dadeudoplaca+dadeudo;

     return did, dplaca, dinfraccion, dnombre, ddomicilio, daxo, dfolios, dadeudo, dadeudoplaca,
       vtotal_gasto, dmarca, dsubmarca, dmodelo, dmotor, dserie, dcolor with resume;

   end foreach;

end foreach;

end procedure;

create procedure "informix".sp14_notificacion_firme(prec int, pfold int, pfolh int, pdil char(1))
    returning   int as id,
                varchar(10) as placa,
                int as infraccion,
                varchar(100) as nombre,
                varchar(100) as domicilio,
                int as axo,
                varchar(250) as folios,
                money(18,2) as adeudo,
                money(18,2) as adeudoplaca,
                money(18,2) as total_gasto,
                varchar(100) as marca,
                varchar(100) as submarca,
                varchar(100) as modelo,
                varchar(100) as motor,
                varchar(100) as serie,
                varchar(100) as color;

define vid, vtipo, vayo, vfolio, vid_control, vperiodo int;
define vplaca varchar(10);
define vnombre, vdomicilio, vfirmante, vcargo, vvalidez_certi, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor varchar(100);
define vimporte_gasto, vimporte_ayo, vimporte_adeudo, vtotal_gasto money(18,2);
define vidfirmado, vhash varchar(60);
define vfecha_firma varchar(25);
define vfecha_emision date;
define vfoldet varchar(250);

   foreach
     select distinct a.id,a.placa,a.nombre,trim(a.domicilio),c.importe_gastos,d.tipo,d.ayo,sum(d.importe),
     (select (nvl(sum(importe),0)) from db_ingresos:ta_15_periodos where control_otr=c.id_control ),
     (select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=14 and control_otr=a.id 
     and clave_practicado="P" and vigencia="1"),fea.firmante,fea.cargo,
     (fea.secuencia||'-'||fea.digverificador) ,fea.validez_certi,fea.fecha_firma,fea.hash,c.fecha_emision,c.folio,c.id_control,  
     trim(a.marca), '', trim(a.modelo), trim(a.no_motor), trim(a.serie), trim(a.color)  
     into vid, vplaca, vnombre, vdomicilio, vimporte_gasto, vtipo, vayo, vimporte_ayo, vimporte_adeudo, vtotal_gasto, vfirmante, vcargo,
     vidfirmado, vvalidez_certi, vfecha_firma, vhash, vfecha_emision, vfolio, vid_control, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor
     from dbestacion:ta_padron a,db_ingresos:ta_15_apremios c,db_ingresos:ta_15_periodos d, outer db_ingresos:ta_15_apremios_fea fea
     where c.modulo=14 and c.zona=prec and (c.folio between pfold and pfolh)
     and c.control_otr=a.id and c.id_control=d.control_otr 
     and c.diligencia=pdil and fea.id_control_req=c.id_control
     group by 1,2,3,4,5,6,7,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25
     order by 1,6,7
    
     let vfoldet='';
     foreach
       select periodo into vperiodo from db_ingresos:ta_15_periodos where control_otr=vid_control and ayo=vayo and tipo=vtipo order by ayo,periodo
       let vfoldet=trim(vfoldet)||vperiodo||',';
     end foreach;   
     let vfoldet=substr(vfoldet,1,(length(vfoldet)-1));
     return vid, vplaca, vtipo, vnombre, vdomicilio, vayo, vfoldet, vimporte_ayo, vimporte_adeudo, vtotal_gasto,
       vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor with resume; 
   end foreach;

end procedure;

CREATE PROCEDURE "informix".spd_delesta01a ( paraxo smallint, parfolio  integer, parPlaca char(7), parconvenio  integer, 
				parfecha date, parreca smallint, parcaja char(2), paroperacion integer, parusuauto integer, 
				parautoriza char(20), parobs char(50), parOpcion smallint, parsol_rfc char(13), parsol_motivo char(200), parsub_codigo smallint )
		returning smallint,  char(200) ;

		-- parsol_rfc, parsol_motivo, parsub_codigo campos adicionados por Gilberto Moreno Gutierrez para el registro de motivo de cancelaci�n
define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
           let varok = 0;
          let varobs = '';          

--set debug file to "c:\ivan.log";
--trace on;

if (paropcion = 1)  or (paropcion = 5)  then    --opcion 1 consulta del disponible.
	insert into ta14_folios_histo       
     	select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio, parsub_codigo  
	from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
	if parsub_codigo = 2 then
    		insert into ta14_condonado (control, autoriza, observacion, solicitante_rfc, solicitante_motivo) 
     				values ( varcontrol, parautoriza, parobs, parsol_rfc, parsol_motivo);   
	end if;

   	delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    	let varok = 1;
     	let varobs = 'Error de captura o calcomania';
end if;

if (paropcion = 22)  or (paropcion = 23) or (paropcion = 25) then  --opcion 22 y 23 Error de vigilante, falla de aparato, 25 Condonado x Obra Tren Ligero L3
	insert into ta14_folios_histo       
     	select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio, parsub_codigo  
	from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    	let varok = 1;
     	let varobs = 'Error de vigilante o falla de aparato';
end if;

if (paropcion = 3)  then  -- pago por folio de recaudadora;
	select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     	where axo = paraxo and folio = parfolio;

	insert into ta14_folios_histo       
     	select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, parsub_codigo 
	from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    	insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   	delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	if v_acuerdo <> 0 then
              		update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
	end if;
    	let varok = 1;
     	let varobs = 'pago por folio de recaudadora, hecho correctamente';
end if;

-- Condonacion, prescripcion, sentencia de juzgado, suspension (a�adido por Gilberto Moreno Opc 26)
if  (paropcion = 15)  or (paropcion = 16) or (paropcion = 17) or (paropcion = 18)  or (paropcion = 19) or (paropcion = 26) then  
	insert into ta14_folios_histo       
	select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, parsub_codigo 
	from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	let varcontrol =  dbinfo("sqlca.sqlerrd1");
	if paropcion = 26 then
    	insert into ta14_folios_susp (control, axo, folio, placa, clave, fecha_alta, usu_alta, fecha_baja, usu_baja) 
							values ( varcontrol, paraxo, parfolio, parPlaca, 'A', current, parusuauto, Null, Null );
    	insert into ta14_condonado (control, autoriza, observacion, solicitante_rfc, solicitante_motivo) 
     			values ( varcontrol, parautoriza, parobs, parsol_rfc, parsol_motivo);
	else
    	insert into ta14_condonado (control, autoriza, observacion, solicitante_rfc, solicitante_motivo) 
     			values ( varcontrol, parautoriza, parobs, parsol_rfc, parsol_motivo);
	end if;
	delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
	let varok = 1;
     	let varobs = 'Condonacion, prescripcion, sentencia de juzgado, suspension; realizada correctamente';
end if;

if (paropcion = 13)  then  -- pago por folio de recaudadora cajero;
	select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     	where axo = paraxo and folio = parfolio;

     	insert into ta14_folios_histo       
     	select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, parsub_codigo  
	from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    	insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   	delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

	if v_acuerdo <> 0 then  --- Cuando hay notificaciones del estado.
              		update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   	end if;
       	let varok = 1; 
       	let varobs = 'pago por folio de recaudadora cajero, hecho correctamente';
end if;

if (paropcion = 4)  then  -- Pago x Placa Reca
	foreach
	select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
	into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio  from ta14_folios_adeudo  where placa = parplaca

	insert into ta14_folios_histo   values ( 0, today, vaxo, vfolio, vfecha, vplaca, vinfra, vestado, vvig, vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona, vespacio, parsub_codigo );
      	let varcontrol =  dbinfo("sqlca.sqlerrd1");
	insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   	delete from ta14_folios_adeudo where axo = vaxo and folio = vfolio;
   	end foreach;
    	let varok = 1;
     	let varobs = 'Pago x Placa Reca, hecho correctamente';
end if;

if (paropcion = 6)  then  -- Pagado  en el ESTADO
	if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio ) then
       		insert into ta14_folios_histo       
     		select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, parsub_codigo 
			from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
		delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    		let varok = 1;
     		let varobs = 'Pagado  en el ESTADO, hecho correctamente';
	else
  		if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 6 ) then
			select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
			into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio
			from ta14_folios_histo  where axo = paraxo and folio = parfolio ;

			insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio, parsub_codigo );
			let varok = 1;
     			let varobs = 'Pagado  en el ESTADO, hecho correctamente';
		else                
          			let varok = 0;
          			let varobs = 'No existe registo para estos datos lectura';
		end if;
	end if;
end if;

if (paropcion = 7 )  then  -- x baja hp3000 transf
	if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio ) then
		insert into ta14_folios_histo       
     		select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, parsub_codigo 
		from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

		delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    		let varok = 1;
     		let varobs = 'pago hecho correctamente';
	else                
          		let varok = 0;
          		let varobs = 'No existe registo para estos datos lectura';
	end if;
end if;

if (paropcion = 10)  then  -- pago x BANORTE
	let varok = 10;
   	if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio ) then
		select placa into vplaca from ta14_folios_adeudo     where axo = paraxo and folio = parfolio ;
        		select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
    		if ban_placa = vplaca then
			insert into ta14_folios_histo       
     			select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, parsub_codigo 
				from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
			delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;

			update ta14_fol_Banorte set fecha_afectacion = today ,
      				usu_carga = parusuauto, status_mpio = 0 
     				where axo = paraxo and folio = parfolio ;

			let varobs = 'pago x BANORTE, hecho correctamente';
    			let varok = 0;
  		else
    			update ta14_fol_Banorte set 
				usu_carga = parusuauto, status_mpio = 3 
     				where axo = paraxo and folio = parfolio ;
     			let varok = 0;
  		end if;
	end if;

	if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 10 ) then
		select placa into vplaca from ta14_folios_histo     where axo = paraxo and folio = parfolio ;
        		select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
      		if ban_placa = vplaca then          
			select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
			into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;

         			insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio, parsub_codigo );

      			update ta14_fol_Banorte set fecha_afectacion = today ,
      				usu_carga = parusuauto, status_mpio = 1 
     				where axo = paraxo and folio = parfolio ;

    			let varobs = 'pago x BANORTE, hecho correctamente con pago doble de otro medio';
    			let varok = 1;
    		else
    			update ta14_fol_Banorte set 
      				usu_carga = parusuauto, status_mpio = 3 
     				where axo = paraxo and folio = parfolio ;
     			let varobs = 'Folio no coincide la placa';
    			let varok = 1;
    		end if;
	else      
    		if varok = 10 then
			-- no se insertaran los datos nuevos por que existen muchos errores de los archivos del Banco;
     			--select  fecha_folio, placa, infraccion   into vfecha , vplaca , vinfra from ta14_fol_banorte  where axo = paraxo and folio = parfolio ; 
     			--insert into ta14_folios_histo   values ( 0,today,    paraxo, parfolio, vfecha, vplaca, vinfra , 14, 999 , null, today, parusuauto, paropcion, parusuauto, 0 , 0);
      			update ta14_fol_Banorte set fecha_afectacion = today ,
      				usu_carga = parusuauto, status_mpio = 3 
     				where axo = paraxo and folio = parfolio ;
			let varok = 0;
          			let varobs = 'se inserta para estos datos lectura';
    		end if; 
	end if;
end if;

return varok, varobs;
--trace off;

end procedure;

create procedure "informix".sp14_propietarios(pprop varchar(100),pinfd int, pinfh int, paxod int, paxoh int, 
pimpd money(18,2), pimph money(18,2), pplaca varchar(10), popc char(1))
returning   int as id_placa,
            varchar(100) as nombre,
            varchar(10) as placa,
            int as folios,
            int as total_placas,
            int as total_folios;

define vid_placa, vfolios, vtotal_placas, vtotal_folios, vdias, rcant_folio int;
define vnombre, rnombre, rdomicilio varchar(100);
define vplaca, rplaca varchar(10);
define radeudo money(18,2);

let vtotal_placas=0;
let vtotal_folios=0;

if popc='N'then -- PROPIETARIO
    -- para retornar datos
    foreach
    SELECT a.id, trim(a.NOMBRE), trim(a.placa)--, COUNT(b.folio) folios 
    into vid_placa, vnombre, vplaca--, vfolios
    FROM dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
    WHERE a.nombre LIKE '%'||pprop||'%' and a.id>0 and b.placa=a.placa 
    and trim(a.municipio)='GUADALAJARA' and (b.axo between paxod and paxoh)
    GROUP BY a.id, a.NOMBRE, a.placa ORDER BY a.NOMBRE, a.placa

    let vfolios=0;
    --  para validar a�os e importes 
    foreach
    execute  PROCEDURE dbestacion:cons14_Placa_Rangos ( vplaca, paxod, paxoh, 1, 9999, pimpd, pimph ) into rplaca, rnombre, rdomicilio, vfolios, radeudo
    end foreach;

    if vfolios >0 then
       -- verifica si tiene notificacion dentro de los 60 dias
       if exists(select * from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' and vigencia='1' and modulo=14) then
           foreach
            select (today-fecha_emision) into vdias from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' 
             and vigencia='1' and modulo=14 order by fecha_emision
           end foreach;
           if vdias>60 then
              let vtotal_folios = vtotal_folios + vfolios;
              let vtotal_placas = vtotal_placas + 1; 
              return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
           end if;
       else
           let vtotal_folios = vtotal_folios + vfolios;
           let vtotal_placas = vtotal_placas + 1;
           return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
       end if;
    end if;

    end foreach;
end if;

if popc='P' then  -- PLACA
    foreach
    SELECT a.id, trim(a.NOMBRE), trim(a.placa)--, COUNT(b.folio) folios 
    into vid_placa, vnombre, vplaca--, vfolios
    FROM dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
    WHERE a.placa=pplaca and b.placa=a.placa and a.id>0 and trim(a.municipio)='GUADALAJARA'
    and (b.axo between paxod and paxoh)
    GROUP BY a.id, a.NOMBRE, a.placa ORDER BY a.NOMBRE, a.placa

    let vfolios=0;
    --  para validar a�os e importes 
    foreach
    execute  PROCEDURE dbestacion:cons14_Placa_Rangos ( vplaca, paxod, paxoh, 1, 9999, pimpd, pimph ) into rplaca, rnombre, rdomicilio, vfolios, radeudo
    end foreach;

    if vfolios >0 then
       -- verifica si tiene notificacion dentro de los 60 dias
       if exists(select * from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' and vigencia='1' and modulo=14) then
           foreach
            select (today-fecha_emision) into vdias from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' 
            and vigencia='1' and modulo=14 order by fecha_emision
           end foreach;
           if vdias>60 then
              let vtotal_folios = vtotal_folios + vfolios;
              let vtotal_placas = vtotal_placas + 1;
              return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
           end if;
       else
           let vtotal_folios = vtotal_folios + vfolios;
           let vtotal_placas = vtotal_placas + 1;
           return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
       end if;
    end if;

    end foreach;
end if;

if popc='A' then  -- A�O DE INFRACCION
    foreach
    SELECT a.id, trim(a.NOMBRE), trim(a.placa)--, COUNT(b.folio) folios 
    into vid_placa, vnombre, vplaca--, vfolios
    FROM dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
    WHERE (b.axo between paxod and paxoh) and b.placa=a.placa and a.id>0 and trim(a.municipio)='GUADALAJARA'
    GROUP BY a.id, a.NOMBRE, a.placa ORDER BY a.NOMBRE, a.placa

    let vfolios=0;
    --  para validar a�os e importes 
    foreach
    execute  PROCEDURE dbestacion:cons14_Placa_Rangos ( vplaca, paxod, paxoh, 1, 9999, pimpd, pimph ) into rplaca, rnombre, rdomicilio, vfolios, radeudo
    end foreach;

    if vfolios >0 then
       -- verifica si tiene notificacion dentro de los 60 dias
       if exists(select * from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' and vigencia='1' and modulo=14) then
           foreach
            select (today-fecha_emision) into vdias from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' 
            and vigencia='1' and modulo=14 order by fecha_emision
           end foreach;
           if vdias>60 then
              let vtotal_folios = vtotal_folios + vfolios;
              let vtotal_placas = vtotal_placas + 1;
              return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
           end if;
       else
           let vtotal_folios = vtotal_folios + vfolios;
           let vtotal_placas = vtotal_placas + 1;
           return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
       end if;
    end if;

    end foreach;
end if;
if popc='C'then -- COLONIA
    -- para retornar datos
    foreach
    SELECT a.id, trim(a.NOMBRE), trim(a.placa)--, COUNT(b.folio) folios 
    into vid_placa, vnombre, vplaca--, vfolios
    FROM dbestacion:ta_padron a, dbestacion:ta14_folios_adeudo b
    WHERE a.colonia LIKE '%'||pprop||'%' and a.id>0 and b.placa=a.placa 
    and trim(a.municipio)='GUADALAJARA' and (b.axo between paxod and paxoh)
    GROUP BY a.id, a.NOMBRE, a.placa ORDER BY a.NOMBRE, a.placa

    let vfolios=0;
    --  para validar a�os e importes 
    foreach
    execute  PROCEDURE dbestacion:cons14_Placa_Rangos ( vplaca, paxod, paxoh, 1, 9999, pimpd, pimph ) into rplaca, rnombre, rdomicilio, vfolios, radeudo
    end foreach;

    if vfolios >0 then
       -- verifica si tiene notificacion dentro de los 60 dias
       if exists(select * from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' and vigencia='1' and modulo=14) then
           foreach
            select (today-fecha_emision) into vdias from db_ingresos:ta_15_apremios where control_otr=vid_placa and diligencia = 'N' 
             and vigencia='1' and modulo=14 order by fecha_emision
           end foreach;
           if vdias>60 then
              let vtotal_folios = vtotal_folios + vfolios;
              let vtotal_placas = vtotal_placas + 1; 
              return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
           end if;
       else
           let vtotal_folios = vtotal_folios + vfolios;
           let vtotal_placas = vtotal_placas + 1;
           return vid_placa, vnombre, vplaca, vfolios, vtotal_placas, vtotal_folios with resume;
       end if;
    end if;

    end foreach;
end if;
end procedure;

create PROCEDURE "pgmoreno".cons14_rangos ( parOpc int, parTexto varchar(30), parAxo1 int, parAxo2 int, parRango1 int, parRango2 int, parRango1_Imp money(12,2), parRango2_Imp money(12,2) )

Returning 
	char(7) as Placa,
	varchar(60) as Nombre,
	varchar(60) as Domicilio,
	int as Cant_Folios,
	money(12,2) as Adeudo;

define v_nombre, v_domicilio								varchar(60);

define v_Axo, v_Folio, v_infraccion, v_Porc, v_Cant_Folios	int;
define v_fecha_folio, v_fecha_hoy							date;
define v_Tarifa, v_Dscto, v_Adeudo, v_Adeudo_tot			money(12,2);
define v_valido												int;
define VP_PLACA, v_Placa									char(7);

Let v_nombre = '';
Let v_domicilio = '';

Let v_Axo = 0;
Let v_Folio = 0;
Let v_infraccion = 0;
Let v_Porc = 0;
Let v_Cant_Folios = 0;

Let v_Tarifa = 0;
Let v_Dscto = 0;
Let v_Adeudo = 0;
Let v_Adeudo_tot = 0;

Let v_fecha_hoy = Current;
Let v_valido = 0;

Let VP_PLACA = '';
Let v_Placa = '';

if parOpc = 1 then -- TODO EL PADRON
	FOREACH
	SELECT PLACA INTO VP_PLACA FROM ta_padron WHERE id > 0 and municipio = 'GUADALAJARA' 
	ORDER BY placa
		FOREACH
		EXECUTE PROCEDURE cons14_Placa_Rangos ( VP_PLACA, parAxo1, parAxo2, parRango1, parRango2, parRango1_Imp, parRango2_Imp ) 
		INTO v_Placa, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot
		
		END FOREACH;
	
	if v_Placa <> '' then
		RETURN VP_PLACA, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot   with resume;
	end if;
	END FOREACH;
end if;

if parOpc = 2 then -- Busqueda por Propietario
	FOREACH
	SELECT PLACA INTO VP_PLACA FROM ta_padron WHERE id > 0 and municipio = 'GUADALAJARA' 
	and nombre like '%'||Trim(parTexto)||'%'
	ORDER BY placa
		FOREACH
		EXECUTE PROCEDURE cons14_Placa_Rangos ( VP_PLACA, parAxo1, parAxo2, parRango1, parRango2, parRango1_Imp, parRango2_Imp ) 
		INTO v_Placa, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot

		END FOREACH;
	if v_Placa <> '' then
		RETURN VP_PLACA, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot   with resume;
	end if;
	END FOREACH;
end if;

if parOpc = 3 then -- Busqueda por Domicilio
	FOREACH
	SELECT PLACA INTO VP_PLACA FROM ta_padron WHERE id > 0 and municipio = 'GUADALAJARA' 
	and domicilio like '%'||Trim(parTexto)||'%'
	ORDER BY placa
		FOREACH
		EXECUTE PROCEDURE cons14_Placa_Rangos ( VP_PLACA, parAxo1, parAxo2, parRango1, parRango2, parRango1_Imp, parRango2_Imp ) 
		INTO v_Placa, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot
		
		END FOREACH;

	if v_Placa <> '' then
		RETURN VP_PLACA, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot   with resume;
	end if;
	END FOREACH;
end if;

if parOpc = 4 then -- Busqueda por Placa
	FOREACH
	SELECT PLACA INTO VP_PLACA FROM ta_padron WHERE id > 0 and municipio = 'GUADALAJARA'
	and placa = Trim(parTexto)
		FOREACH
		EXECUTE PROCEDURE cons14_Placa_Rangos ( VP_PLACA, parAxo1, parAxo2, parRango1, parRango2, parRango1_Imp, parRango2_Imp ) 
		INTO v_Placa, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot
		
		END FOREACH;

	if v_Placa <> '' then
		RETURN VP_PLACA, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot   with resume;
	end if;
	END FOREACH;
end if;

if parOpc = 5 then -- Busqueda por Colonia
	FOREACH
	SELECT PLACA INTO VP_PLACA FROM ta_padron WHERE id > 0 and municipio = 'GUADALAJARA' 
	and Colonia like '%'||Trim(parTexto)||'%'
	ORDER BY placa
		FOREACH
		EXECUTE PROCEDURE cons14_Placa_Rangos ( VP_PLACA, parAxo1, parAxo2, parRango1, parRango2, parRango1_Imp, parRango2_Imp ) 
		INTO v_Placa, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot
		
		END FOREACH;

	if v_Placa <> '' then
		RETURN VP_PLACA, v_nombre, v_domicilio, v_Cant_Folios, v_Adeudo_tot   with resume;
	end if;
	END FOREACH;
end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_remesagilgil (p_Opc Int, p_Axo Int, p_Fec_Ini Date, p_Fec_Fin Date, p_Fec_A_Fin Date)
  returning int as status , varchar(200) as obs, varchar(20) as Remesa;

DEFINE v_A, v_PN, v_C, v_PR,v_TC                   Integer;
DEFINE obs                                                            VarChar(200);

DEFINE v_Folio                                                                Char(12);
DEFINE v_Mpio, v_NumRem                                  Integer;
DEFINE v_TipoAct                                                  Char(2);
DEFINE v_Placa                                                     Char(9);
DEFINE v_FecPgo, v_FecCan, v_FecAlt                Date;
DEFINE v_FolioEcMpio                                           Char(50);
DEFINE v_Gastos                                                    Decimal(18,2);
DEFINE v_Remesa                                                          Char(20);


LET obs = '';

SELECT MAX(num_remesa) INTO v_NumRem FROM ta14_bitacora  WHERE tipo IN ('B','C','D','E');
LET v_NumRem = v_NumRem + 1;
LET v_Remesa = 'ayt_gdl_r' || v_NumRem;

-- ALTAS de notificaciones DEL PERIODO DESEADO
IF p_Opc = 4  THEN
	--FOREACH
     INSERT INTO ta14_datos_mpio
     SELECT 113 Municipio, 'A' ,(trunc((year(b.fecha_emision)* 10000000) + b.folio)) || '' Folio, '' fechagenreq, a.placa, '' folionot, '' fechanot, '' fechapago, '' fechacancelado,
                   b.importe_gastos tarifa, 10 claveinf, b.fecha_emision fechaalta, '' fechavenci , '' folioec, '' folioecmpio , '' gastos, v_Remesa, (today ) fecharem
				
		FROM db_ingresos:ta_15_apremios b, dbestacion:ta_padron a
		WHERE b.modulo = 14
		AND b.clave_practicado = 'P' and b.vigencia = '1'
		AND b.fecha_practicado between mdy(01,01,2019) and mdy(12,04,2019)  --BETWEEN p_Fec_Ini AND p_Fec_Fin
		AND b.control_otr = a.id
		AND a.placa NOT IN  ('', 'JBB3322','JBB3299','JHV3208','JDR8217','JHB4551','JHF5454','JFT1095','JCM9663','JHY3399','JHU9170','JLN5847','JLY5403','JGB7885','JPK1115');

	--END FOREACH;
END IF;

IF p_Opc = 4  THEN  -- opcion para generar remesa de NOTIFICACIONES
       SELECT NVL(count(*),0) cuantos INTO v_A FROM ta14_datos_mpio WHERE remesa = v_Remesa;
       INSERT INTO ta14_Bitacora values (0, 'E', p_Fec_Ini, p_Fec_Fin, today, v_NumRem, v_A);
       if v_a is null then
          return -1 , 'No genero registro para enviar al SECFIN', v_Remesa;
       else
       let obs = v_a || '  Registros de altas/Notificaciones para enviar al SECFIN';
        return 0, obs, v_Remesa;
        end if;
END IF;

END PROCEDURE;

CREATE PROCEDURE "informix".sp14_remesa (p_Opc Int, p_Axo Int, p_Fec_Ini Date, p_Fec_Fin Date, p_Fec_A_Fin Date)
  returning int as status , varchar(200) as obs, varchar(20) as Remesa;

DEFINE v_A, v_PN, v_C, v_PR,v_TC                   Integer;    
DEFINE obs                                                            VarChar(200);

DEFINE v_Folio                                                                Char(12);
DEFINE v_Mpio, v_NumRem                                  Integer;
DEFINE v_TipoAct                                                  Char(2);
DEFINE v_Placa                                                     Char(9);
DEFINE v_FecPgo, v_FecCan, v_FecAlt                Date;
DEFINE v_FolioEcMpio                                           Char(50);
DEFINE v_Gastos                                                    Decimal(18,2);
DEFINE v_Remesa                                                          Char(20);


LET obs = '';

SELECT MAX(num_remesa) INTO v_NumRem FROM ta14_bitacora  WHERE tipo IN ('B','C','D');
LET v_NumRem = v_NumRem + 1;
LET v_Remesa = 'ayt_gdl_r' || v_NumRem;

-- ALTAS DEL PERIODO DESEADO
IF p_Opc = 0  THEN                                                                                                                      
     INSERT INTO ta14_datos_mpio                                                          -- Altas por periodo  
     SELECT 113 Municipio, 'A' ,(trunc((a.axo* 10000000) + a.folio)) || '' Folio, '' fechagenreq, a.placa, '' folionot, '' fechanot, '' fechapago, '' fechacancelado,
                   b.tarifa tarifa, a.infraccion claveinf, a.fecha_folio  fechaalta , (a.fecha_folio + 90) fechavenci , '' folioec, '' folioecmpio , '' gastos, v_Remesa, (today ) fecharem
     FROM ta14_folios_adeudo a , ta14_tarifas b
     WHERE a.infraccion < 9 AND a.axo = p_Axo AND a.fecha_folio  BETWEEN p_Fec_Ini AND p_Fec_Fin
           AND a.fecha_folio BETWEEN b.fecha_inicial AND b.fecha_fin AND a.infraccion = b.num_clave
           AND a.placa NOT IN  ('', 'JBB3299', 'JHV3208', 'JDR8217', 'JHB4551', 'JHF5454', 'JFT1095', 'JCM9663', 'JHY3399','JHU9170', 'JLN5847', 'JLY5403','JGB7885','JPK1115');
END IF;

-- ALTAS de notificaciones DEL PERIODO DESEADO
IF p_Opc = 4  THEN
--FOREACH
     INSERT INTO ta14_datos_mpio
     SELECT 113 Municipio, 'A' ,(trunc((year(b.fecha_emision)* 10000000) + b.folio)) || '' Folio, '' fechagenreq, a.placa, '' folionot, '' fechanot, '' fechapago, '' fechacancelado,
                   b.importe_gastos tarifa, 10 claveinf, b.fecha_emision fechaalta, '' fechavenci , '' folioec, '' folioecmpio , '' gastos, v_Remesa, (today ) fecharem
 
FROM db_ingresos:ta_15_apremios b, dbestacion:ta_padron a
WHERE b.modulo = 14
AND b.clave_practicado = 'P' and b.vigencia = '1'
AND b.fecha_practicado between mdy(01,01,2019) and mdy(12,04,2019)  --BETWEEN p_Fec_Ini AND p_Fec_Fin
AND b.control_otr = a.id
AND a.placa NOT IN  ('', 'JBB3322','JBB3299','JHV3208','JDR8217','JHB4551','JHF5454','JFT1095','JCM9663','JHY3399','JHU9170','JLN5847','JLY5403','JGB7885','JPK1115');

--END FOREACH;
END IF;

-- GENERACION DEL ARCHIVO DIARIO
IF p_Opc = 1 THEN
     FOREACH       -- Pagos normales por periodo
     SELECT 113 Municipio, 'PN', (a.folio || '') folio, a.placa, b.fecha_recibo fechapago, today, a.fecha_folio fechaalta, ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion )  folioecmpio, 0
     INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.infraccion < 10 AND a.fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin AND a.codigo_movto  IN (3,4,8,9,13,24)
           AND a.fecha_folio < MDY(05,31,2005) AND a.num_acuerdo IS NULL AND a.control = b.control
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;

     FOREACH       -- Pagos normales por periodo
     SELECT 113 Municipio, 'PN',  (trunc((a.axo* 10000000) + a.folio)) || '' Folio, a.placa, b.fecha_recibo fechapago, today, a.fecha_folio fechaalta,
                ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion ) folioecmpio, 0   INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.infraccion < 10 AND fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin AND codigo_movto  IN (3,4,8,9,13,24)
           AND fecha_folio BETWEEN MDY(05,31,2005) AND p_Fec_A_Fin AND a.num_acuerdo IS NULL AND a.control = b.control
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;

     --FOREACH       -- Pagos de requerimientos  fecha,oficina,caja,operacion+importe pagado

     --END FOREACH;
     ---------------------------
     FOREACH       -- Cancelaciones por periodo
     SELECT 113 Municipio, 'C', a.folio || '' folio, a.placa, today, fecha_movto fechacancelado, a.fecha_folio fechaalta, '' folioecmpio, 0
     INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  
     WHERE a.infraccion < 10 AND a.fecha_movto BETWEEN p_Fec_Ini and  p_Fec_Fin AND a.codigo_movto  in (1,2,5,7,11,15,16,17,18,19,20,21,22,23,25) AND a.fecha_folio < MDY(05,31,2005)
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;

     FOREACH       -- Cancelaciones por periodo
     SELECT 113 Municipio, 'C' ,  (trunc((a.axo* 10000000) + a.folio)  ) || '' Folio, a.placa, today, fecha_movto fechacancelado, a.fecha_folio fechaalta, ''  folioecmpio, 0
     INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a
      WHERE a.infraccion < 10 AND fecha_movto BETWEEN p_Fec_Ini and  p_Fec_Fin AND codigo_movto  in (1,2,5,7,11,15,16,17,18,19,20,21,22,23,25)
            AND fecha_folio BETWEEN MDY(05,31,2005) and p_Fec_A_Fin
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;

     --FOREACH       -- Cancelacion de requerimientos

     --END FOREACH;
     ---------------------------
     FOREACH       -- Pagos con requerimiento por periodo
     SELECT 113 Municipio, 'PR', (a.folio || '') folio, a.placa, b.fecha_recibo fechapago, today, a.fecha_folio fechaalta, (reca || '-' || fecha_recibo || '-' || caja || '-' || operacion) folioecmpio, 49
     INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.infraccion < 10 AND a.fecha_movto BETWEEN p_Fec_Ini and  p_Fec_Fin AND a.codigo_movto  IN (3,4,8,9,13,24)
             AND a.fecha_folio < MDY(05,31,2005) AND a.num_acuerdo IS NOT NULL AND a.control = b.control
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;

     FOREACH       -- Pagos con requerimiento por periodo
     SELECT 113 Municipio, 'PR',  (trunc((a.axo* 10000000) + a.folio)) || '' Folio, a.placa, b.fecha_recibo  fechapago, today, a.fecha_folio fechaalta,
                ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion ) folioecmpio, 49   INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.infraccion < 10 AND fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin AND codigo_movto  IN (3,4,8,9,13,24)
              AND fecha_folio BETWEEN MDY(05,31,2005) AND p_Fec_A_Fin AND a.num_acuerdo IS NOT NULL AND a.control = b.control
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;

      FOREACH      -- Pagos normales por periodo BANORTE  -- a�adido aqui a partir del 24/09/2018
      SELECT 113 Municipio, "PN" TipoAct, (trunc((a.axo* 10000000) + a.folio)) || "" Folio, a.Placa, (b.fec_pago) Fechapago, today, (a.Fecha_folio) Fechaalta,
                "Pago en Banorte " || a.Fecha_movto Folioecmpio, 0     INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
      FROM ta14_folios_histo a, ta14_fol_banorte b
      WHERE a.codigo_movto = 10 AND a.fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin
      AND b.axo = a.axo AND b.folio = a.folio
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;

END IF;

-- GENERACION DEL ARCHIVO DE PAGADOS EN BANORTE
IF p_Opc = 2 THEN                                      
      FOREACH      -- Pagos normales por periodo BANORTE
      SELECT 113 Municipio, "PN" TipoAct, (trunc((a.axo* 10000000) + a.folio)) || "" Folio, a.Placa, (b.fec_pago) Fechapago, today, (a.Fecha_folio) Fechaalta,
                "Pago en Banorte " || a.Fecha_movto Folioecmpio, 0     INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
      FROM ta14_folios_histo a, ta14_fol_banorte b
      WHERE a.codigo_movto = 10 AND a.fecha_movto BETWEEN p_Fec_Ini AND p_Fec_Fin
      AND b.axo = a.axo AND b.folio = a.folio
                EXECUTE PROCEDURE sp14_Remesa_GReg (v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos, v_Remesa);
     END FOREACH;
END IF;


IF p_Opc = 0  THEN
       SELECT NVL(count(*),0) cuantos INTO v_A FROM ta14_datos_mpio WHERE remesa = v_Remesa;
       INSERT INTO ta14_Bitacora values (0, 'B', p_Fec_Ini, p_Fec_Fin, today, v_NumRem, v_A);
       if v_a is null then
          return -1 , 'No genero registro para enviar al SECFIN', v_Remesa;
       else
       let obs = v_a || '  Registros de altas para enviar al SECFIN';
        return 0, obs, v_Remesa;
        end if;
END IF;
IF p_Opc = 1 THEN
       SELECT NVL(count(*),0) cuantos INTO v_PN FROM ta14_datos_mpio WHERE remesa = v_Remesa and tipoact = 'PN';
       SELECT NVL(count(*),0) cuantos INTO v_C FROM ta14_datos_mpio WHERE remesa = v_Remesa and tipoact = 'C';
       SELECT NVL(count(*),0) cuantos INTO v_PR FROM ta14_datos_mpio WHERE remesa = v_Remesa and tipoact = 'PR';
       LET v_TC = v_PN+v_C+v_PR;
       INSERT INTO ta14_Bitacora values (0, 'C', p_Fec_Ini, p_Fec_Fin, today, v_NumRem, v_TC);
              if v_tc is null then
          return -1 , 'No genero registro para enviar al SECFIN', v_Remesa;
       else
       let obs = v_PN || '  Pagos Normales  ' || v_c || '  Cancelados  ' || v_pr || '  Pagos con Req.';
        return 0, obs, v_Remesa;
        end if;
END IF;
IF p_Opc = 2  THEN
       SELECT NVL(count(*),0) cuantos INTO v_A FROM ta14_datos_mpio WHERE remesa = v_Remesa;
       INSERT INTO ta14_Bitacora values (0, 'D', p_Fec_Ini, p_Fec_Fin, today, v_NumRem, v_A);
       if v_a is null then
          return -1 , 'No genero registro para enviar al SECFIN', v_Remesa;
       else
       let obs = v_a || '  Registros pagados en Banorte para enviar al SECFIN';
        return 0, obs, v_Remesa;
        end if;
END IF;
IF p_Opc = 4  THEN  -- opcion para generar remesa de NOTIFICACIONES
       SELECT NVL(count(*),0) cuantos INTO v_A FROM ta14_datos_mpio WHERE remesa = v_Remesa;
       INSERT INTO ta14_Bitacora values (0, 'E', p_Fec_Ini, p_Fec_Fin, today, v_NumRem, v_A);
       if v_a is null then
          return -1 , 'No genero registro para enviar al SECFIN', v_Remesa;
       else
       let obs = v_a || '  Registros de altas/Notificaciones para enviar al SECFIN';
        return 0, obs, v_Remesa;
        end if;  
END IF;

END PROCEDURE;

create procedure "informix".admin_adeudos_detalle_23 ( p_opc int , pnumesta int, p_axof int , p_mesf int  )
returning
-- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
int as rubro,
int as concepto,
int as cta,
varchar(30) as referencia,
varChar(120) as descripcion,
decimal(12,2) as monto,
decimal(12,2) as acumulado;

define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
define p_pubid int;
define agrupar char(6);
define v_tipo int;
define no_recargos int;
define v_porc_recgos decimal(5,2);define v_descto_recgos money(15,2);

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019
define v_total_bateria, v_total_cordon decimal(5,2); -- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
define v_cuentaapl_odoo int;
Let v_cuentaapl_odoo = 0;

begin
    on exception in (-958)
delete from tmp_exclusivos;
    end exception;
    create temp table tmp_exclusivos(
orden  smallint,
id_exc  int ,
axo int,
mes int,
imp_pagar  money(12,2) ,
cta_aplicacion int,
referencia varchar(30),
concepto   varChar(120)
    ) with no log;
end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--set debug file to 'Exclusivo.log';
--trace on;

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

-- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
select id, total_bateria, total_cordon into p_pubid, v_total_bateria, v_total_cordon from ex_contrato where no_exclusivo = pnumesta;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
if v_fecha_limite > today then
let mesvig = mesvig -1;
end if;
let per_recgos =  (axovig *100 )+ mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
let no_recargos = 0;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;
SELECT axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio  FROM ta_contratos_status WHERE modulo = 1 AND id = p_pubid AND estado = 'S'; -- 1=Exclusivo, 2=P�blico
if v_mes_inicio = 1 then
Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;
if perio_susp < perio then
Let perio = perio_susp;
end if;

FOREACH
select b.cuentaapl, b.tipo , a.axo , a.mes ,(axo  * 100 )+ mes ,  a.concepto ,  a.ade_importe
into v_cuentaapl , v_tipochar, v_axo , v_mes , perioi , v_concepto , v_adeudo
from ex_adeudo a, pubtipoadeudo b
where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
and a.tipo <> 20 and a.tipo = b.tipo_id  
order by a.axo , a.mes

if v_cuentaapl = 370700001 then
let no_recargos = 1;
end if;
let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
let v_acumulado = v_acumulado + v_adeudo;
    insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto )  
values(1, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl , v_referencia , v_concepto );
--return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
    if  v_cuentaapl = 370710002 then
-- calcula recargos de refrendo
        execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes ) into v_recargos;
-- porcentaje de descuento
        -- calcula recargos de refrendo
        select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between
        ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
        let v_descto_recgos = 0;
        if v_porc_recgos is null then
let v_porc_recgos = 0;
end if;
        if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
            let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
        end if;
        if v_recargos > 0 then
let v_acumulado = v_acumulado + v_recargos;
            let v_concepto1 = 'Recargos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)  
values(1, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
--   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
        end if;
        if v_descto_recgos <> 0 then
let v_acumulado = v_acumulado + v_descto_recgos;
            let v_concepto1 = 'Descto Recgos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
end if;
    end if;
END FOREACH;
--
FOREACH
select  axo || lpad(mes,2,'0'), tipo, Axo, mes, (axo  * 100 )+ mes, concepto, ade_importe
into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
from ex_adeudo where ex_contrato_id = p_pubid and  tipo = 20 and  (axo * 100 + mes) <= perio
order by 1,3,4

select porcentaje into v_porc_recgos from ex_descrec
where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
let v_descto_recgos = 0;
if v_porc_recgos is null then
let v_porc_recgos = 0;
end if;
let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');

if v_tipo = 20 then
select sum(porcentaje_mes) into v_porcentaje from recargos
where (axo * 100 + mes) between  perioI and per_recgos;
     
let v_recargos = (v_porcentaje * v_adeudo ) / 100;
if v_recargos is null then
let v_recargos = 0;
end if;
        if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
--    let v_recargos =   v_recargos - v_descto_recgos;
end if;
   
let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
else
let v_recargos = 0;
let v_concepto = v_concepto1 || '  ' || v_adeudo;
end if;

--  totales
    if v_axo = year(today) then
if (v_total_bateria > 0) and (v_total_cordon > 0) then
-- actual
Let v_cuentaapl_odoo = 230000001;
else
-- actual
if v_total_cordon > 0 then
-- cordon
Let v_cuentaapl_odoo = 230000001;
else
-- bateria
Let v_cuentaapl_odoo = 230000002;
end if;
end if;

let v_cuota = v_cuota + v_adeudo;
let v_rectot = v_rectot + v_recargos;
if v_adeudo > 0 then
let v_acumulado = v_acumulado + v_adeudo;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto )
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            --            values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364100000, v_referencia , v_concepto);
--      return 0 ,0 , 364100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
end if;
if no_recargos = 1 then
let v_recargos = 0;
            let v_descto_recgos = 0;
        end if;
 
if v_recargos > 0 then
let v_acumulado = v_acumulado + v_recargos;
let v_concepto1 = 'Recargos ' || v_concepto;

insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(3, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
--   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
end if;
if v_descto_recgos <> 0 then
let v_acumulado = v_acumulado + v_descto_recgos;
let v_concepto1 = 'Descto Recgos ' || v_concepto;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
end if;
    else
if (v_total_bateria > 0) and (v_total_cordon > 0) then
-- rezago
Let v_cuentaapl_odoo = 230000003;
else
-- rezago
if v_total_cordon > 0 then
-- cordon
Let v_cuentaapl_odoo = 230000003;
else
-- bateria
Let v_cuentaapl_odoo = 230000004;
end if;
end if;

let v_cuota_r = v_cuota_r + v_adeudo;
let v_rectot_r = v_rectot_r + v_recargos;
if v_adeudo > 0 then
let v_acumulado = v_acumulado + v_adeudo;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                          values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            --            values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364130000, v_referencia , v_concepto);
--   return 0 ,0 , 364130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
end if;
if no_recargos = 1 then
let v_recargos = 0;
            let v_descto_recgos = 0;
end if;
if v_recargos > 0 then
let v_acumulado = v_acumulado + v_recargos;
let v_concepto1 = 'Recargos ' || v_concepto;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(3, p_pubid, v_axo ,v_mes, v_recargos, 390700000, v_referencia , v_concepto1);
--    return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
end if;
if v_descto_recgos <> 0 then
let v_acumulado = v_acumulado + v_descto_recgos;
let v_concepto1 = 'Descto Recgos ' || v_concepto;
insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1);
--  return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
end if;
end if;

END FOREACH;

let v_acumulado = 0 ;
FOREACH
select cta_aplicacion , referencia , concepto , imp_pagar
into v_cuentaapl, v_referencia , v_concepto , v_cuota
from tmp_exclusivos order by axo , mes, orden

let v_acumulado = v_acumulado + v_cuota;
return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_cuota, v_acumulado  with resume;
END FOREACH;

--trace off;
end procedure;

CREATE FUNCTION "informix".admin_cancela_26( p_id_admin_pag integer,
p_folio_pag varchar(30),p_usuario_canc varchar(10) )
{######################################################################
#  Procedimiento:    admin_pago_26
#  Descripcion:      Interfaz de cancelacion del pago de calcomanias en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            04 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_pubid   int;
define v_cvepagorbo       CHAR(1);
define v_axo int;
define v_mes int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);
define v_res2 int ; define v_res3 varchar(50);
define v_placa char(1); define v_baliza char(1);
define v_tipo int; define v_no_exclusivo int;
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Pago de Calcomania' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where fecha = today and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'CANCELACION REALIZADA, no recibo';
   let v_estatus = 0;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja, id_regmodulo, rfcnumero ,id_modulo, cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag , v_pubid, v_no_exclusivo ,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where fecha = today and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;
if v_fecha_pag <> today then
   let v_leyenda = 'EL RECIBO NO SE CANCELA POR SER DE OTRO DIA';
   let v_estatus = 4;
   RETURN v_estatus,v_leyenda;
end if;


if v_id_modulo <> 14 then
   let v_leyenda = 'EL RECIBO NO ES POR PAGO DE CALCOMANIA';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

      BEGIN WORK;
     let v_r = 'S';
      update db_ingresos: ta_12_recibos set cvepago='C', fecha_act=today
      where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);
-- verificar si tiene forma , balizamiento, placa.
   
   insert into ta14_calcomanias_h (id, fecha_baja,placa ,
    num_calco, fecha_inicial ,fecha_fin, propietario ,status ,turno , fecha_pago ,
    reca , caja, operacion , importe_pago ,fec_cap , usu_inicial) select 0,today,placa ,
    num_calco, fecha_inicial ,fecha_fin, propietario ,status ,turno , fecha_pago ,
    reca , caja, operacion , importe_pago ,fec_cap , usu_inicial from ta14_calcomanias 
     where fecha_pago = v_fecha_pag and reca = v_rec_pag 
                    and caja = v_caja_pag and operacion = p_id_admin_pag ;
  
    delete from ta14_calcomanias where fecha_pago = v_fecha_pag and reca = v_rec_pag 
                    and caja = v_caja_pag and operacion = p_id_admin_pag ;

       
      COMMIT WORK; 
 


return v_estatus,v_leyenda;
--trace off;
END FUNCTION
;

CREATE PROCEDURE "pgmoreno".sp14_del_dsctobuenfin ( )
{######################################################################
#  Procedimiento:    sp14_del_DsctoBuenFin
#  Descripcion:      Interfaz de consulta de Estacionamientos
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento Modulo de ESTACIONAMIENTOS Mantenimiento
#  
######################################################################}
                returning  int as status,
                                            varchar(255) as leyenda;

define v_leyenda                                                                        	varchar(255);
define v_status					Int;
define v_axo, v_folio					Int;

Let v_status = 0;
Let v_leyenda = 'NO TIENE ADEUDO';
Let v_axo = 0;
Let v_folio = 0;

FOREACH
SELECT axo, folio  INTO v_axo, v_folio FROM ta14_folios_free WHERE fecha_otorga >= mdy(11,14,2018) and PORC_COBRO = 50 and obs = '50% OFICIO D.I. 5715/2019' and usu_inicial = 9999

	if exists ( select * from ta14_folios_histo where axo = v_axo and folio = v_folio and codigo_movto in (3,4,8,9,13,24) ) then
		Let v_status = 0;
		Let v_leyenda = 'Se utilizo el descuento al Folio '|| v_axo ||'-'||v_folio;
	else
		--delete from ta14_folios_free where axo = v_axo and folio = v_folio
		--and fecha_otorga >= mdy(11,14,2018) and PORC_COBRO = 50 and obs = '50% OFICIO D.I. 5715/2019' and usu_inicial = 9999;
		Let v_status = 0;
		Let v_leyenda = 'Elimino descuento, Folio '|| v_axo ||'-'||v_folio;
	end if;

	RETURN v_status, v_leyenda with resume;

END FOREACH;

end procedure;

CREATE PROCEDURE "informix".sp_multipagos_envio(
    p_s_transm VARCHAR(20),
    p_c_referencia VARCHAR(20),
    p_t_servicio INT,
    p_t_importe MONEY(12,2),
    p_s_desc VARCHAR(50),
    p_i_aport MONEY(12,2),
    p_s_ori INT,
    p_pago_dif INT,
    p_plazos_pago INT
)
{######################################################################
#  Procedimiento:    sp_multipagos_envio
#  Descripcion:      Interfaz de datos varios para el cobro de multas de estacionemetros desde web
#
#  Parametros        
#  de entrada:       Campos de tabla
#                    
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            13 Enero 2015   
#  Modificado:       19 Enero 2015
#  Modificado:        8 Enero 2020
#  Llamado por:      pagina estacionometros
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(50) as linea;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
define v_linea varchar(50);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en transaccion de multas ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

--set debug file to 'datvario12.log';
--trace on;
let v_estatus = 0;
let v_leyenda = 'Transaccion realizada';

BEGIN WORK;
	insert into multipagos_envio(
     		s_transm ,
     		c_referencia ,
     		t_servicio ,
     		t_importe ,
    		s_desc,
     		i_aport ,
     		s_ori ,
     		pago_dif ,
    		plazos_pago,
     		fecha_at
	) values (
    		p_s_transm,
    		p_c_referencia,
    		p_t_servicio,
    		p_t_importe,
    		p_s_desc,
    		p_i_aport,
    		p_s_ori,
    		p_pago_dif,
    		p_plazos_pago,
		current);

      let v_estatus=dbinfo("sqlca.sqlerrd1");

--calcular linea de captura
execute PROCEDURE "informix".linea_capturamultaest(p_s_transm, v_estatus, p_t_importe) into v_linea;

update multipagos_envio set linea = v_linea where id=v_estatus;

COMMIT WORK; 
--trace off;
return v_estatus,v_linea;
END PROCEDURE
;

CREATE PROCEDURE "informix".sp_multipagos_recep(
    p_n_autoriz	varchar(28),
    p_s_pago integer,
    p_t_pago integer,
    p_s_transm VARCHAR(20),
    p_c_referencia VARCHAR(20),
    p_t_importe MONEY(12,2),
    p_t_descripcion VARCHAR(50),
    p_i_aport MONEY(12,2),
    p_s_ori INT,
    p_linea VARCHAR(50)
)
{######################################################################
#  Procedimiento:    sp_multipagos_recep
#  Descripcion:      datos de transaccion del banco para el cobro de multas de estacionemetros desde web
#
#  Parametros        
#  de entrada:       Campos de tabla
#                    
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Marco A. Ortega
#  Fecha:            28 Enero 2015   
#  Modificado:       
#  Llamado por:      pagina estacionometros
#  Llama a:          
#  
#t_pago  = 01  // Identificador de tipo de pago, en este caso como el pago fue con tarjeta se regresa 01
#s_pago = 03  // Es el identificado del estatus del pago el cual indica que se realizo el pago
#t_descripcion  // Debe llegar en blanco porque el pago fue satisfactorio 
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);



ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
ROLLBACK WORK;
RETURN -1, 'Error en transaccion de multas ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

--set debug file to 'datvario12.log';
--trace on;
let v_estatus = 0;
let v_leyenda = 'Transaccion realizada';
BEGIN WORK;
insert into 'informix'.multipagos_recep(
     n_autoriz ,
     s_pago ,
     t_pago ,
     s_transm ,
     c_referencia ,
     t_importe ,
     t_descripcion ,
     i_aport ,
     s_ori ,
     fecha_at,
     linea
) values ( 
    p_n_autoriz,
    p_s_pago,
    p_t_pago,
    p_s_transm,
    p_c_referencia,
    p_t_importe,
    p_t_descripcion,
    p_i_aport,
    p_s_ori, 
    current,
    p_linea);

      let v_estatus=dbinfo("sqlca.sqlerrd1");
COMMIT WORK; 
--trace off;
return v_estatus,v_leyenda;
END PROCEDURE
;

create procedure "informix".kioscopago_foliostca18(pnumtrans int , 
  impcertificado money(10,2),  idmedio int,  parTarBanco   int,  partarconfir  int,
  partartarjeta varchar(30),  partartipo    int, pardatos_internet varchar(80) , parlinea varchar(28))

returning 
int as reca, 
char(2) as caja, 
int as operacion,
char(240) as descrip,
char(200) as notif, 
char(28) as linea28;

define varreca  int;
define varcaja  char(2);
define varoperacion int;
define concepto  char(60);
define concep  char(60);
define vplaca char(7);
define vdescrip char(240);
define conc1   char(60);
define conc2  char(60);
define conc3  char(60);
define conc4 char(60);
define conc1n   char(50);
define conc2n  char(50);
define conc3n  char(50);
define conc4n char(50);
define vnotif  char(200); 
define varnumf int    ;
define vimpact money(10,2); 
define vimpante money(10,2); 
define vimpmulta money(10,2);
define ctaredon integer;
define cta1 integer;
define cta2 integer;
define cta3 integer;
define lineanotif  int;
define vaxoini integer;
define vfolioini integer;
define vaxofin integer;
define vfoliofin integer;
define linea int;
define longconcep int;
define redon decimal(5,2);
define  v_linea100 char(100) ;
define v_linea28 char(28);
define vfol_ini int8;
define vfol_fin int8;
define daxo int;
define dfolio int;
define  dplaca char(7);
define  dacuerdo int;  
define varcontrol int;
define dcontar int;
define v_nombre char(60);
define v_codigomovtos int;
define v_lugarpago int;
 let v_codigomovtos = 8;
--set debug file to 'estacion.log';
--trace on;
if idmedio = 500 then
   let v_codigomovtos = 9;
  -- let v_lugarpago = 112;
else
   let v_lugarpago = 0;
end if;

select  placa,   foliosdescrip,  notifdescrip, axoini , folioini , axofin , foliofin, numfolios,   impactual, impanterior, impmulta 
into   vplaca , vdescrip,        vnotif, vaxoini , vfolioini , vaxofin , vfoliofin, varnumf,    vimpact, vimpante, vimpmulta

from ta14_kio_trans where numtrans = pnumtrans;
  let vfol_ini = (vaxoini * 10000000) + vfolioini;
  let vfol_fin = (vaxofin * 10000000) + vfoliofin;
let v_nombre = 'REFERENCIA BANCO:' ||  pnumtrans || vplaca|| vfol_ini || vfol_fin;
 select  count(*)
       into      dcontar  
       from ta14_kio_transdet  where id_kio_trans = pnumtrans ;
if dcontar > 0 then
--insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,5,idmedio);
	
let longconcep = length(vdescrip);
if longconcep >= 181 then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = vdescrip[181,240];
end if;
if (longconcep >= 121) and (longconcep <= 180) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = vdescrip[121,180];
let conc4 = '';
end if;
if longconcep >= 61 and (longconcep <= 120) then
let conc1 = vdescrip[1,60];
let conc2 = vdescrip[61,120];
let conc3 = '';
let conc4 = '';
end if;
if longconcep <= 60  then
let conc1 = vdescrip[1,60];
let conc2 = '';
let conc3 = '';
let conc4 = '';
end if;
-- notificacion;
let longconcep = length(vnotif);
if longconcep >= 151 then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = vnotif[151,200];
let lineanotif  = 4;
end if;
if (longconcep >= 151) and (longconcep <= 150) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = vnotif[101,150];
let conc4n = '';
let lineanotif  = 3;
end if;
if (longconcep >= 51) and (longconcep <= 100) then
let conc1n = vnotif[1,50];
let conc2n = vnotif[51,100];
let conc3n = '';
let conc4n = '';
let lineanotif  = 2;
end if;
if longconcep <= 50  then
let conc1n = vnotif[1,50];
let conc2n = '';
let conc3n = '';
let conc4n = '';
let lineanotif  = 1;
end if;

let cta1 = 510900000;  -- 46305  A�o actual
let cta2 = 510930000;  -- 46320   a�os anteriores
let cta3 = 992100006;      -- 23315  gastos ejecucion sefin.
--- 46327  cuenta para inmovilizador.

let redon = vimpact + vimpante + vimpmulta - impcertificado;

if redon >= 0.51 then 
 let ctaredon = 550800000 ; -- 46902 redondeo
else
let ctaredon = 550800000;
let redon = redon * -1;
end if;

 select id_rec , caja  , lugar_pago
 into varreca , varcaja , v_lugarpago
  from db_ingresos:ta12_operacKiosco where id_usuario = idmedio; 
-- select rowid , * from db_ingresos:ta12_operacKiosco
-- insert into db_ingresos:ta12_operacKiosco values(9,'I1',1 , 500 , 'L', 'BMX HOST PAID', 175 , '@BMXHPesta', 'BANAMEX H.P');
-- update db_ingresos:ta12_operacKiosco  set tip_impresora = 'C' , id_usuario = 1500 where rowid = 264

	select nvl(operacion,0) + 1
		into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio and tip_impresora = 'L';



--insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,6, varoperacion);

let concepto = 'Pago de multas de estacionometros de la placa: ' || vplaca;	
 
   insert into db_ingresos:ta_12_recibos (fecha ,  id_rec,  caja ,  operacion,  importe ,  cvepago ,  id_modulo,    nombre ,    concepto ,  
                                                    id_usuario ,  fecha_act , kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
                              values( today, varreca, varCaja, varOperacion, impcertificado, 'P' , 14, concepto,  v_nombre , idmedio, current, vplaca , 1, v_lugarpago, today );


	update	db_ingresos:ta12_operacKiosco set
    		operacion=varOperacion
		where
		id_rec=varreca and
			caja=varCaja and
			id_usuario=idmedio;
	

--execute PROCEDURE db_ingresos:linea_capturadiv(varoperacion, idmedio,impcertificado ,today ) into  v_linea100, v_linea28;
--  select * from multipagos_envio where linea is not null
-- select *  from multipagos_recep
update db_ingresos:ta_12_recibos set domicilio = 'Linea: ' || parlinea 
where fecha = today and  id_rec = varreca and  caja =varcaja and  operacion = varOperacion ;
--insert into kio_estacion_bita(placa,fecha, estatus, medio) values(vplaca , current,7,idmedio);
-- si es pago con tarjeta afectar
if partarconfir > 0 and  trim(partartarjeta) <> '' then
   insert into db_ingresos:ta_12_cheques (fecha ,id_rec , caja , operacion ,id_banco ,cheque , cuenta ,
    importe ,  tipo_pag , datos_internet )
    values(today ,varreca , varcaja, varoperacion , parTarBanco  ,
  partarconfir ,  partartarjeta, impcertificado,  partartipo, pardatos_internet);
  end if;

--
let linea = 1;
if vimpact > 0 then

   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta1,  vimpact);
   let linea = linea +1;
end if;
if (vimpante > 0) then
    if (vimpact > 0)  then
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc2  ,   cta2,  vimpante);
      let linea = linea +1;
     else
     insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc1  ,   cta2,  vimpante);
     let linea = linea +1;
    end if;
end if;
if linea = 3 then  
  let  concep = conc3;
else 
let concep = conc2;
end if;

if vimpmulta > 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  ,   cta3,  vimpmulta);
   let linea = linea +1;
end if;
if linea = 4 then  
  let  concep = conc4;
else 
let concep = conc3;
end if;

if redon <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , ctaredon ,  redon);
   let linea = linea +1;
else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        concep  , 0 , 0);
   let linea = linea +1;
end if;

if linea = 4 then
    insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , linea ,        conc4  , 0 ,  0); 
end if;

if  lineanotif  = 4 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 8 ,        conc4n  ,   0,  0);
end if;
if  lineanotif  = 3 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 7 ,        conc3n  ,   0,  0);
end if;
if  lineanotif  = 2 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 6 ,        conc2n  ,   0,  0);

end if;
if  lineanotif  = 1 then 
  insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 5 ,        conc1n  ,   0,  0);
  
end if;

--
--dar de baja folios pagados.
  
--select * from ta14_folios_histo
 foreach 
    select  a.axo , a.folio, a.placa, a.num_acuerdo
        into      daxo, dfolio,  dplaca, dacuerdo  
       from ta14_kio_transdet b , ta14_folios_adeudo  a 
       where b.id_kio_trans = pnumtrans and  a.axo =b.axo and a.folio = b.folio
   
  insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, v_codigomovtos, idmedio , zona , espacio , 0
        from ta14_folios_adeudo 
     where axo = daxo and folio = dfolio;
     let varcontrol =  dbinfo("sqlca.sqlerrd1"); 

    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
       values ( varcontrol , today, varreca , varcaja, varoperacion);   
   delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
    if dacuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = today 
     where num_acuerdo = dacuerdo and fechapago is null;
      end if;
   end foreach;
--

   


--
return 
varreca, varcaja, varoperacion,  vdescrip,        vnotif, parlinea;
else
return
0,'',0,'','','';
end if;
--trace off;
end procedure;

CREATE FUNCTION "informix".linea_capturamultaest(p_s_transm  VARCHAR(20), p_idenvio int, p_total money(16,2))
returning varchar(50) as linea;
-- Genera linea captura para multas de estacionometros

define linea1 varchar(110);
define resultado varchar(110);
define v_codigo1 varchar(20);
define v1_7 smallint;
define v1_3 smallint;
define v1_1 smallint;
define vt1    int;
define i int;
define fecha int;
define fecha_st char(5);
define fechax date;
define control int;
define v_id int;
define v2_11 smallint;
define v2_13 smallint;
define v2_17 smallint;
define v2_19 smallint;
define v2_23 smallint;
define vt2    int;
define v_idtransaccion int;
define v_cuentas_refer int;
define v_axoini smallint;
define v_bimini smallint ;
define v_axo smallint;
define v_bim  smallint;
--set debug file to "multasesta.log";
--   trace on;

let linea1 = substr((p_idenvio/10000000),4,6) || substr(p_s_transm,11,10);


let linea1 = linea1 || "0014"; --pago de predial

---- codifica fecha
-- let fechax = TO_DATE("26/02/2010", "%d/%m/%iY");
let fechax = today;

--let fecha = ((year(fechax) - 1988) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1);
let fecha = (((year(fechax) - 2013) * 372) + ((month(fechax)-1) * 31) + (day(fechax) - 1)) + 10000;  -- se modifica el a�o base a 2013
let fecha_st = '' || fecha;

let linea1 = linea1 || fecha_st[2,5];

------digito verificador de importe
let v_codigo1 = trunc(p_total*100) ;
let vt1 = 0;

for i =   length(v_codigo1) to 1 step -3
  let v1_7 = 0;
  let v1_3 = 0;
  let v1_1 = 0;

  if i >= 1 then
     let v1_7 = substr(v_codigo1,i , 1)  * 7;
  end if;
  if i >= 2 then
     let v1_3 = substr(v_codigo1,(i -1) , 1)  * 3;
  end if;
  if i >= 3 then
     let v1_1 = substr(v_codigo1,(i -2), 1)  * 1;
  end if;

  let  vt1 = vt1+ v1_7 + v1_3 + v1_1;

end for;
let vt1 = mod(vt1,10);
let linea1 = linea1 || vt1;

-----controles
let control = 2; ---valida fecha e importe
let linea1 = linea1 || control;

---control global
let vt2 = 0;

for i =   length(linea1) to 1 step -5
  let v2_11 = 0;
  let v2_13 = 0;
  let v2_17 = 0;
  let v2_19 = 0;
  let v2_23 = 0;

  if i >= 1 then
     let v2_11 = substr(linea1,i , 1)  * 11;
  end if;
  if i >= 2 then
     let v2_13 = substr(linea1,(i -1) , 1)  * 13;
  end if;
  if i >= 3 then
     let v2_17 = substr(linea1,(i -2), 1)  * 17;
  end if;
  if i >= 4 then
     let v2_19 = substr(linea1,(i -3), 1)  * 19;
  end if;  
  if i >= 5 then
     let v2_23 = substr(linea1,(i -4), 1)  * 23;
  end if;
  let  vt2 = vt2+ v2_11 + v2_13 + v2_17 + v2_19 + v2_23;

end for;
let vt2 = mod(vt2,97) +1;
if vt2 < 10 then
   let linea1 = linea1 || "0" || vt2;
else
   let linea1 = linea1 || vt2;
end if;
-----divide la linea en grupos de cuatro caracteres
let resultado = "";

for i = 1 to length(linea1) step 4
   let resultado = resultado || substr(linea1,i , 4) || "   ";
end for;

--trace off;
let resultado = resultado || "     " || p_total;

return linea1;

end FUNCTION;

CREATE PROCEDURE "pgmoreno".sp14_compulsa_pgoedo_vs_mpio ( )
{######################################################################
#  Procedimiento:    sp14_compulsa_PgoEdo_vs_Mpio
#  Descripcion:      Interfaz de consulta de Estacionamientos
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#
#  Llamado por:      Procedimiento Modulo de ESTACIONAMIENTOS Mantenimiento
#  
######################################################################}
returning  
int as status,
varchar(255) as leyenda;

define v_leyenda	varchar(255);
define v_status		Int;
define v_folio		decimal(12,0);
define v_placa		char(9);

define rec_importe		decimal(18,2);
define rec_fechapago	date;
define rec_remesa		char(20);
define rec_fecharemesa	date;

define env_importe		decimal(18,2);
define env_clave		int;
define env_remesa		char(20);
define env_fecharemesa	date;

Let v_status = 0;
Let v_leyenda = 'NO TIENE ADEUDO';
Let v_folio = 0;
Let v_placa = 0;

FOREACH
SELECT folio_pgoedo, placa_pgoedo INTO v_folio, v_placa FROM ta14_PgoEdo_vs_Mpio where fechapago_recedo is null
--where folio_pgoedo = 20080148513 

	--if exists ( select * from ta14_datos_edo where placa = v_placa and tipoact = 'PN' and folio = v_folio ) then
		foreach
		select importe, fechapago, remesa, fecharemesa into rec_importe,rec_fechapago,rec_remesa,rec_fecharemesa  
		from ta14_datos_edo where placa = v_placa and tipoact = 'PN' and folio = v_folio
		
		update ta14_PgoEdo_vs_Mpio set
		importe_recedo = rec_importe,
		fechapago_recedo = rec_fechapago,
		remesa_recedo = rec_remesa,
		fecharemesa_recedo = rec_fecharemesa
		where folio_pgoedo = v_folio and placa_pgoedo = v_placa;
		
		RETURN 1, 'Folio en recibidos '|| v_placa ||'-'||v_folio	with resume;
		end foreach;
	--else
	--	RETURN -1, 'Folio no encontrado '|| v_placa ||'-'||v_folio	with resume;
	--end if;

END FOREACH;

end procedure;

create PROCEDURE "pgmoreno".cons14_solicrep ( parCveInf int, parOpc int, parFec_Inicio Date, parFec_Fin Date )

Returning   varchar(80) as Descrip,
	date as Fecha_movto,
	int as Aso,
	int as Folio,
	date as Fecha_Folio,
	char(7) as Placa,
	date as Fecha_Captura,
	decimal(5,2) as Porc,
	money(12,2) as Tarifa,
	money(12,2) as Dscto,
	money(12,2) as Pago,
	int as Contador,
	int as Contador_Dcto;

define v_Contador, v_Contador_Dcto			int;
define vif_clave					int;
define vif_descripcion				char(30);

define v_Codigo_Movto, v_Sub_Codigo			int;
define v_Descrip_Movto, v_Descrip_SubMovto		varchar(40);
define v_Descripcion					varchar(80);

define v_Axo, v_Folio				int;
define v_Fecha_Movto, v_Fecha_Folio, v_Fec_Cap		date;
define v_Placa					char(7);
define v_Tarifa, v_Dscto				money(12,2);
define v_Porc					decimal(5,2);

Let v_Contador = 0;
Let v_Contador_Dcto = 0;

Let vif_clave = 0;
Let vif_descripcion = ' ';

Let v_Codigo_Movto = 0;
Let v_Sub_Codigo = 0;
Let v_Descrip_Movto = ' ';
Let v_Descrip_SubMovto = ' ';
Let v_Descripcion = ' ';
	
Let v_Axo = 0;
Let v_Folio = 0;
Let v_Fecha_Movto = today;
Let v_Fecha_Folio = today;
Let v_Fec_Cap = today;
Let v_Placa = ' ';
Let v_Tarifa = 0;
Let v_Porc = 0;
Let v_Dscto = 0;

	if parOpc = 1 then	-- Folios Adeudo
		FOREACH
		SELECT a.Axo, a.Folio, a.Fecha_Folio, a.Placa, a.fec_cap, (b.tarifa + b.costo_fijo01)  
		INTO  v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa
		FROM ta14_folios_adeudo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_folio BETWEEN parFec_Inicio AND parFec_Fin
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.axo, a.folio

		Let v_Contador = v_Contador + 1;
		RETURN Null, Null, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, Null, v_Contador, v_Contador_Dcto  with resume;
		END FOREACH;
	end if;
	if parOpc = 2 then	-- Folios Pagados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (100 - c.porc_cobro), (b.tarifa + b.costo_fijo01), 
		nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		IF v_Porc > 0 THEN
			Let v_Contador_Dcto = v_Contador_Dcto + 1;
			RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto), v_Contador, v_Contador_Dcto  with resume;
		ELSE
			RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto), v_Contador, null  with resume;
		END IF;
		END FOREACH;
	end if;
	if parOpc = 21 then	-- Folios Pagados solo con descuento
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (100 - c.porc_cobro), (b.tarifa + b.costo_fijo01), 
		nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c
		WHERE a.infraccion = parCveInf and a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		IF v_Porc > 0 THEN
			Let v_Contador_Dcto = v_Contador_Dcto + 1;
			RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto), null, v_Contador_Dcto  with resume;
		END IF;
		END FOREACH;
	end if;
	if parOpc = 3 then	-- Folios Cancelados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,11,22,23)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, 0, v_Tarifa, 0, 0, v_Contador, v_Contador_Dcto  with resume;
		END FOREACH;
	end if;
	if parOpc = 4 then	-- Folios Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (2,15,16,17,18,19,20,21,25)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, 0, v_Tarifa, 0, 0, v_Contador, v_Contador_Dcto  with resume;
		END FOREACH;
	end if;
	if parOpc = 5 then	-- Folios Cancelados y Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion < 11 AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,2,11,15,16,17,18,19,20,21,22,23, 25)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.codigo_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, 0, v_Tarifa, 0,0, v_Contador, v_Contador_Dcto  with resume;
		END FOREACH;
	end if;

end procedure;

create PROCEDURE "pgmoreno".cons14_solicrep22 ( parCveInf int, parOpc int, parFec_Inicio Date, parFec_Fin Date )

Returning   varchar(80) as Descrip,
	date as Fecha_movto,
	int as Aso,
	int as Folio,
	int as Infraccion, 
	date as Fecha_Folio,
	char(7) as Placa,
	date as Fecha_Captura,
	decimal(5,2) as Porc,
	money(12,2) as Tarifa,
	money(12,2) as Dscto,
	money(12,2) as Pago,
	int as Contador,
	int as Contador_Dcto;

define v_Contador, v_Contador_Dcto			int;
define vif_clave					int;
define vif_descripcion				char(30);

define v_Codigo_Movto, v_Sub_Codigo			int;
define v_Descrip_Movto, v_Descrip_SubMovto		varchar(40);
define v_Descripcion					varchar(80);

define v_Axo, v_Folio				int;
define v_Fecha_Movto, v_Fecha_Folio, v_Fec_Cap		date;
define v_Placa					char(7);
define v_Tarifa, v_Dscto				money(12,2);
define v_Porc					decimal(5,2);
define v_infraccion	int;

Let v_Contador = 0;
Let v_Contador_Dcto = 0;

Let vif_clave = 0;
Let vif_descripcion = ' ';

Let v_Codigo_Movto = 0;
Let v_Sub_Codigo = 0;
Let v_Descrip_Movto = ' ';
Let v_Descrip_SubMovto = ' ';
Let v_Descripcion = ' ';
	
Let v_Axo = 0;
Let v_Folio = 0;
Let v_Fecha_Movto = today;
Let v_Fecha_Folio = today;
Let v_Fec_Cap = today;
Let v_Placa = ' ';
Let v_Tarifa = 0;
Let v_Porc = 0;
Let v_Dscto = 0;
Let v_infraccion = 0;

	if parOpc = 5 then	-- Folios Cancelados y Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.infraccion, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_infraccion, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion < 11 AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,2,11,15,16,17,18,19,20,21,22,23, 25)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.codigo_movto, a.placa, a.axo, a.folio

					SELECT descripcion INTO v_Descrip_Movto FROM ta14_codigomovtos WHERE codigo_movto = v_Codigo_Movto;
					if v_Sub_Codigo > 0 then
						SELECT descripcion INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
						if v_Descrip_SubMovto is null then
              							let v_Descripcion = v_Descrip_Movto;
						else
              							let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           						end if;

					else
						let v_Descripcion = v_Descrip_Movto;
					end if;

		Let v_Contador = v_Contador + 1;
		RETURN Trim(v_Descripcion), v_Fecha_Movto, v_Axo, v_Folio, v_infraccion, v_Fecha_Folio, v_Placa, v_Fec_Cap, 0, v_Tarifa, 
		0,0, v_Contador, v_Contador_Dcto  with resume;
		END FOREACH;
	end if;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_folios_ins ( parAxo int, parFolio int, parFecha_folio date, parPlaca char(7), parInfraccion int, parEstado int, parVigilante int, parUsu_inicial int, parZona int, parEspacio int) 
{######################################################################
#  Procedimiento:   sp14_Folios_ins
#  Descripcion:     Interfaz de captura de Folio en Estacionometros
#
#  Parametros		arriba descritos
#  de entrada:
#             
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            23 Septiembre 2013  
#
#  Llamado por:      Procedimiento admin_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning  int as status,
char(150) as mensaje;

define v_status	int;
define v_mensaje char(150);
define v_status_grab	int;

Let v_status = 0;
Let v_mensaje = 'No entro';
Let v_status_grab = 0;

if exists( select * from ta14_folios_adeudo where axo = parAxo and folio = parFolio ) then
	Let v_status = 0;
	Let v_mensaje = 'El Folio existe como Adeudo';
else
	if exists( select * from ta14_folios_histo where axo = parAxo and folio = parFolio ) then
		Let v_status = 0;
		Let v_mensaje = 'El Folio existe como Hist�rico';
	else
		insert into ta14_folios_adeudo (axo, folio, fecha_folio, placa, infraccion, estado, vigilante, fec_cap, usu_inicial, zona, espacio) 
		values (parAxo, parFolio, parFecha_folio, parPlaca, parInfraccion, parEstado, parVigilante, today, parUsu_inicial, parZona, parEspacio); 

		if exists( select * from ta14_folios_adeudo where axo = parAxo and folio = parFolio ) then
			Let v_status = 1;
			Let v_mensaje = 'El Folio se grabo correctamente';
		else
			Let v_status = -1;
			Let v_mensaje = 'Ocurri� error al grabar el Folio';
		end if;
	end if;
end if;

return v_status, v_mensaje;

end procedure;

create PROCEDURE "pgmoreno".cons14_solicrep_resp ( parOpc int, parCveInf int, parFec_Inicio Date, parFec_Fin Date )
Returning
int as Infraccion,    
varchar(80) as Descrip,

int as Codigo,
int as Sub_Codigo,
varchar(80) as Descrip_Codigo,

date as Fecha_movto,
int as Aso,
int as Folio,
date as Fecha_Folio,
char(7) as Placa,
date as Fecha_Captura,
decimal(5,2) as Porc,
money(12,2) as Tarifa,
money(12,2) as Dscto,
money(12,2) as Pago;

define cve_num_clave	int;
define cve_descripcion	varchar(80);

define v_Codigo_Movto, v_Sub_Codigo	int;
define v_Descrip_Movto, v_Descrip_SubMovto	varchar(40);
define v_Descripcion	varchar(80);

define v_Axo, v_Folio	int;
define v_Fecha_Movto, v_Fecha_Folio, v_Fec_Cap	date;
define v_Placa	char(7);
define v_Tarifa	money(12,2);
define v_Dscto	money(12,2);
define v_Porc	decimal(5,2);

Let cve_num_clave = 0;
Let cve_descripcion = '';

Let v_Codigo_Movto = 0;
Let v_Sub_Codigo = 0;
Let v_Descrip_Movto = '';
Let v_Descrip_SubMovto = '';
Let v_Descripcion = '';

Let v_Axo = 0;
Let v_Folio = 0;
-- v_Fecha_Movto, v_Fecha_Folio, v_Fec_Cap
Let v_Placa = '';
Let v_Tarifa = 0;
Let v_Dscto = 0;
Let v_Porc = 0;

if parCveInf = 0 then -- Todas las Claves de Infraccion
	FOREACH
	SELECT num_clave, descripcion INTO cve_num_clave, cve_descripcion FROM ta14_infraccion ORDER BY num_clave
	RETURN cve_num_clave, cve_descripcion, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null  with resume;
	
	if parOpc = 1 then -- Adeudos
		FOREACH
		SELECT a.Axo, a.Folio, a.Fecha_Folio, a.Placa, a.fec_cap, (b.tarifa + b.costo_fijo01)  
		INTO  v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa
		FROM ta14_folios_adeudo a, ta14_tarifas b
		WHERE a.infraccion = cve_num_clave AND a.fecha_folio BETWEEN parFec_Inicio AND parFec_Fin
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		ORDER BY a.axo, a.folio
			RETURN Null, Null, 
			Null, Null, Null,
			Null, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, Null  with resume;
		END FOREACH;	
	end if;
	
	if parOpc = 2 then	-- Folios Pagados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (100 - c.porc_cobro), (b.tarifa + b.costo_fijo01), 
		nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c
		WHERE a.infraccion = cve_num_clave AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;

	if parOpc = 21 then	-- Folios Pagados solo con descuento
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (100 - c.porc_cobro), (b.tarifa + b.costo_fijo01), 
		nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c
		WHERE a.infraccion = cve_num_clave AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		if v_Porc > 0 THEN
			RETURN Null, Null, 
			v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
			v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto)  with resume;
		end if;
		END FOREACH;
	end if;
	
	if parOpc = 3 then	-- Folios Cancelados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = cve_num_clave AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,11,22,23)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;

	if parOpc = 4 then	-- Folios Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (2,15,16,17,18,19,20,21,25)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;
	
	if parOpc = 5 then	-- Folios Cancelados y Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion < 11 AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,2,11,15,16,17,18,19,20,21,22,23, 25)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;
	
	END FOREACH;
else
	FOREACH
	SELECT num_clave, descripcion INTO cve_num_clave, cve_descripcion FROM ta14_infraccion WHERE num_clave = parCveInf
	RETURN cve_num_clave, cve_descripcion, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null  with resume;

	if parOpc = 1 then -- Adeudos
		FOREACH
		SELECT a.Axo, a.Folio, a.Fecha_Folio, a.Placa, a.fec_cap, (b.tarifa + b.costo_fijo01)  
		INTO  v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa
		FROM ta14_folios_adeudo a, ta14_tarifas b
		WHERE a.infraccion = cve_num_clave AND a.fecha_folio BETWEEN parFec_Inicio AND parFec_Fin
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		ORDER BY a.axo, a.folio
			RETURN Null, Null, 
			Null, Null, Null,
			Null, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, Null  with resume;
		END FOREACH;	
	end if;
	
	if parOpc = 2 then	-- Folios Pagados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (100 - c.porc_cobro), (b.tarifa + b.costo_fijo01), 
		nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c
		WHERE a.infraccion = cve_num_clave AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;

	if parOpc = 21 then	-- Folios Pagados solo con descuento
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (100 - c.porc_cobro), (b.tarifa + b.costo_fijo01), 
		nvl(((b.tarifa + b.costo_fijo01) - (((b.tarifa + b.costo_fijo01) * c.porc_cobro) / 100)),0), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b, outer ta14_folios_free c
		WHERE a.infraccion = cve_num_clave AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (3,4,6,8,9,10,13,24)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		if v_Porc > 0 THEN
			RETURN Null, Null, 
			v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
			v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Porc, v_Tarifa, v_Dscto, (v_Tarifa - v_Dscto)  with resume;
		end if;
		END FOREACH;
	end if;
	
	if parOpc = 3 then	-- Folios Cancelados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = cve_num_clave AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,11,22,23)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;

	if parOpc = 4 then	-- Folios Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion = parCveInf AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (2,15,16,17,18,19,20,21,25)
		AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
		ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;
	
	if parOpc = 5 then	-- Folios Cancelados y Condonados
		FOREACH
		SELECT a.fecha_movto, a.axo, a.folio, a.fecha_folio, a.placa, a.fec_cap, (b.tarifa + b.costo_fijo01), a.codigo_movto, a.sub_codigo
		INTO  v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, v_Tarifa, v_Codigo_Movto, v_Sub_Codigo
		FROM ta14_folios_histo a, ta14_tarifas b
		WHERE a.infraccion < 11 AND a.fecha_movto BETWEEN parFec_Inicio AND parFec_Fin AND a.codigo_movto in (1,2,11,15,16,17,18,19,20,21,22,23, 25)
			AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
			ORDER BY a.fecha_movto, a.placa, a.axo, a.folio

		SELECT Trim(descripcion) INTO v_Descrip_Movto FROM ta14_codigomovtos  WHERE codigo_movto = v_Codigo_Movto;
		SELECT Trim(descripcion) INTO v_Descrip_SubMovto FROM ta14_codigomovtos_sub WHERE codigo_movtos = v_Codigo_Movto AND sub = v_Sub_Codigo;
		if v_Sub_Codigo > 0 then
			if v_Descrip_SubMovto is null then  
				let v_Descripcion = v_Descrip_Movto;
			else  
				let v_Descripcion = v_Descrip_Movto||' - '||v_Descrip_SubMovto;
           	end if;
		else
			let v_Descripcion = v_Descrip_Movto;
		end if;

		RETURN Null, Null, 
		v_Codigo_Movto, v_Sub_Codigo, v_Descripcion, 
		v_Fecha_Movto, v_Axo, v_Folio, v_Fecha_Folio, v_Placa, v_Fec_Cap, Null, v_Tarifa, Null, (v_Tarifa - v_Dscto)  with resume;
		END FOREACH;
	end if;
	
	END FOREACH;
end if;

end procedure;

create procedure "informix".sp_pub_ade_anual ( )
returning int as numesta, varchar(100) as nombre, char(2) as categoria, varchar(80) as descripcion,
char(1) as sector, varchar(10) as sectornom, varchar(100) as calle,
varchar(10) as numext, int as Cajones, int as axo_adeudo, int as mes_ini_adeudo,
money(14,2) as adeudo_2008, money(14,2) as recargos_2008,
money(14,2) as adeudo_2009, money(14,2) as recargos_2009,
money(14,2) as adeudo_2010, money(14,2) as recargos_2010,
money(14,2) as adeudo_2011, money(14,2) as recargos_2011,
money(14,2) as adeudo_2012, money(14,2) as recargos_2012,
money(14,2) as adeudo_2013, money(14,2) as recargos_2013,
money(14,2) as adeudo_2014, money(14,2) as recargos_2014,
money(14,2) as adeudo_2015, money(14,2) as recargos_2015,
money(14,2) as adeudo_2016, money(14,2) as recargos_2016,
money(14,2) as adeudo_2017, money(14,2) as recargos_2017,
money(14,2) as adeudo_2018, money(14,2) as recargos_2018,
    money(14,2) as adeudo_2019, money(14,2) as recargos_2019,
    money(14,2) as adeudo_2020, money(14,2) as recargos_2020,
money(14,2) as recargos;
  --money(12,2) as adeudo_act ;

define  v_id  int;
define  v_categoria_id int;
define  v_categoria char(2);
define v_descripcion varchar(100);
define v_numesta int;
define v_sector char(1);
define v_sectornom varchar(10);
define v_nombre varchar(100);

define v_calle varchar(80);
define v_numext varchar(10);
define v_cupo int;
define v_axo_adeudo int;
define v_mes_ini_adeudo int;

define v_adeudo_2008 money(14,2);
define v_adeudo_2009 money(14,2);
define v_adeudo_2010 money(14,2);
define v_adeudo_2011 money(14,2);
define v_adeudo_2012 money(14,2);
define v_adeudo_2013 money(14,2);
define v_adeudo_2014 money(14,2);
define v_adeudo_2015 money(14,2);
define v_adeudo_2016 money(14,2);
define v_adeudo_2017 money(14,2);
define v_adeudo_2018 money(14,2);
define v_adeudo_2019 money(14,2);
define v_adeudo_2020 money(14,2);

define v_recgos_2008 money(14,2);
define v_recgos_2009 money(14,2);
define v_recgos_2010 money(14,2);
define v_recgos_2011 money(14,2);
define v_recgos_2012 money(14,2);
define v_recgos_2013 money(14,2);
define v_recgos_2014 money(14,2);
define v_recgos_2015 money(14,2);
define v_recgos_2016 money(14,2);
define v_recgos_2017 money(14,2);
define v_recgos_2018 money(14,2);
define v_recgos_2019 money(14,2);
define v_recgos_2020 money(14,2);

define v_adeudo_recgos money(14,2);

--set debug file to 'pub.log';
--trace on;

foreach
select  a.id, a.pubcategoria_id, b.categoria, b.descripcion, a.numesta, a.sector,
    case when sector = 'J' then 'JUAREZ'  when sector = 'H' then 'HIDALGO'
    when sector = 'L' then 'LIBERTAD'  when sector = 'R' then 'REFORMA' else 'S/N' end ,
    trim(a.nombre), trim(a.calle), trim(a.numext), a.cupo,
    (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ,
    (select min(d.mes) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10  and
    axo = (select min(d.axo) from dbestacion:pubadeudo d where d.pubmain_id = a.id and tipo = 10) ) ,

    dbestacion:fn_pub_ade_axo(a.id ,2008) ,
    dbestacion:fn_pub_ade_axo(a.id ,2009) ,
    dbestacion:fn_pub_ade_axo(a.id ,2010) ,
    dbestacion:fn_pub_ade_axo(a.id ,2011) ,
    dbestacion:fn_pub_ade_axo(a.id ,2012) ,
    dbestacion:fn_pub_ade_axo(a.id ,2013) ,
    dbestacion:fn_pub_ade_axo(a.id ,2014) ,
    dbestacion:fn_pub_ade_axo(a.id ,2015) ,
    dbestacion:fn_pub_ade_axo(a.id ,2016) ,
    dbestacion:fn_pub_ade_axo(a.id ,2017) ,
    dbestacion:fn_pub_ade_axo(a.id ,2018) ,
dbestacion:fn_pub_ade_axo(a.id ,2019) ,
dbestacion:fn_pub_ade_axo(a.id ,2020) ,

    dbestacion:fn_pub_recargos_axo(a.id ,2008) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2009) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2010) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2011) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2012) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2013) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2014) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2015) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2016) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2017) ,
    dbestacion:fn_pub_recargos_axo(a.id ,2018) ,
dbestacion:fn_pub_recargos_axo(a.id ,2019) ,
dbestacion:fn_pub_recargos_axo(a.id ,2020) ,

    dbestacion:fn_pub_recargos(2 , a.id, year(today) , month(today) )

into v_id, v_categoria_id, v_categoria, v_descripcion, v_numesta, v_sector, v_sectornom, v_nombre, v_calle, v_numext, v_cupo, v_axo_adeudo, v_mes_ini_adeudo,
v_adeudo_2008, v_adeudo_2009, v_adeudo_2010, v_adeudo_2011,
v_adeudo_2012, v_adeudo_2013, v_adeudo_2014, v_adeudo_2015,
v_adeudo_2016, v_adeudo_2017, v_adeudo_2018, v_adeudo_2019,
v_adeudo_2020,

v_recgos_2008, v_recgos_2009, v_recgos_2010, v_recgos_2011,
v_recgos_2012, v_recgos_2013, v_recgos_2014, v_recgos_2015,
v_recgos_2016, v_recgos_2017, v_recgos_2018, v_recgos_2019,
v_recgos_2020,
v_adeudo_recgos
from dbestacion:pubmain a, dbestacion:pubcategoria b
    where  b.id =  a.pubcategoria_id and a.movto_cve <> 'C'
--  and (fn_pub_ade_ant(a.id) + fn_pub_ade_act1( a.id ) ) > 0
        order by a.numesta

return   v_numesta, v_nombre, v_categoria, v_descripcion, v_sector, v_sectornom, v_calle, v_numext, v_cupo, v_axo_adeudo, v_mes_ini_adeudo,
v_adeudo_2008, v_recgos_2008,
v_adeudo_2009, v_recgos_2009,
v_adeudo_2010, v_recgos_2010,
v_adeudo_2011, v_recgos_2011,
v_adeudo_2012, v_recgos_2012,
v_adeudo_2013, v_recgos_2013,
v_adeudo_2014, v_recgos_2014,
v_adeudo_2015, v_recgos_2015,
v_adeudo_2016, v_recgos_2016,
v_adeudo_2017, v_recgos_2017,
v_adeudo_2018, v_recgos_2018,
    v_adeudo_2019, v_recgos_2019,
    v_adeudo_2020, v_recgos_2020,
v_adeudo_recgos with resume;

end foreach;
--trace off;
end procedure;

CREATE FUNCTION "informix".admin_pago_26( parImpCertificado money(15,2),
  parimpredondeo   money(3,2),
  parimpcredito   money(15,2),
  parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
  ParFolioRecibo  char(30), --Folio del Recibo (ADMIN)
  ParFechaRecibo  date ,   --Fecha del Recibo
  ParReca         int, --No. de Recaudadora
  ParCaja  char(2) ,--No. de Caja
  ParCajero  char(10),	 --Clave usuario
  parCentro  integer, 
  parNoCalco integer,
  parTipoCalco char(15),
  parFechaIni  date,
  parFechaFin  date,
  parTurno     char(15),
  parPlaca     char(10),
  parNombre    varchar(92),
  parCalle     varchar(80),
  parNoExt     char(10),
  parNoInt     char(10),
  parColonia   varchar(50),
  parCP        char(10),
  parRFC       char(13)

)
				
{######################################################################
#  Procedimiento:    admin_pago_26
#  Descripcion:      Interfaz de pago de Calcomania en el sistema ADMIN
#
#  Parametros            
#  de entrada:      
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            04 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_pago en dbingresosw
#  Llama a:          
#  
######################################################################}

returning smallint , varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_excid int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(80);
define  v_calle varchar(80); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define  v_movto_cve char(1); 
define v_numext char(5);
define v_rfc  char(15);
define v_colonia varchar(40);

define v_id_usuario int;
define  v_id_persona int;
define v_cta int;
define linea int;
define v_orden int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define r_cve int;
define r_obser varchar(200);
define v_existe int;
--set debug file to "calcas.txt";
--trace on;
define v_r char(1);
define v_ca int;
   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -12, 'NO EXISTE TABLA ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
  let v_r = 'N';




--OBTENER EL ID USUARIO CAJERO;
select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = ParCajero;

if  v_id_usuario    is null then
 let v_id_usuario   = 335;  -- usuario ADMIN
end if;
-- datos del propietario
let v_id_persona = 0;
 foreach
  select first 1 id_esta_persona into v_id_persona from TA14_PERSONAS 
              where rfc = trim(parRFC) order by  id_esta_persona desc 
  end foreach;
 
if (v_id_persona is null ) or (v_id_persona = 0 )then
   -- crear propietario.
      insert into TA14_PERSONAS (id_esta_persona , fecha_inicial, nombre ,
    ap_pater,  ap_mater ,  num_unico_gdl , rfc ,    direccion , usu_inicial)
  values (0 , today, parNombre , '.','.' ,  0,  trim(parRFC) ,  (  trim(parCalle) || ' ' || trim(parnoext)) , v_id_usuario);
  let v_id_persona = dbinfo("sqlca.sqlerrd1"); 
  end if;
--Verificar si esiste esta calcomania.
 
select count(*) into v_existe from ta14_calcomanias where placa = parPlaca and num_calco = parNoCalco
and turno = parturno[1,1];
if v_existe <> 0 then 
    return -14,'CALCOMANIA YA EXISTE- VERIFICAR.... ' ; 
end if;

  BEGIN WORK;
 let v_r = 'S';

   insert into db_ingresos:ta_12_recibos(fecha , id_rec , caja , operacion ,  importe , cvepago ,
    id_modulo ,  id_regmodulo,  id_rec_cta , regmunur ,
    mesdesde , axodesde, meshasta, axohasta ,
    nombre ,  domicilio , concepto , rfcini , rfcnumero ,
    rfccolonia,  obra ,  axofolio , id_usuario , fecha_act , descripcion ,
    lugar_pago , id_centro ,  foliorecibo,kio_num_terceros) 
   values (ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN     , parImpCertificado, 'P' ,
    14, 0, 0, 'P' ,    0, 0, 0, 0, parNombre, (  trim(parCalle) || ' ' || trim(parnoext))  ,
   'Adquisici�n de Calcomania para estacionometros municipal GDL No.Calca' || parNoCalco , 'CL', 
    parNoCalco,0,0,0, v_id_usuario ,current , '' , 0,parCentro, ParFolioRecibo, parplaca ) ;
   let linea = 1;
-- registro en calcomania
   insert into ta14_calcomanias  (
    placa , num_calco , fecha_inicial , fecha_fin, propietario , status ,  turno ,
    fecha_pago ,  reca ,  caja ,  operacion ,  importe_pago,  fec_cap ,  usu_inicial )
   values(parPlaca, parNoCalco, parfechaini , parfechafin, v_id_persona , parTipoCalco[1,1] , parturno[1,1] ,
  ParFechaRecibo, ParReca , ParCaja ,parID_ADMIN , parImpCertificado , today ,  v_id_usuario ) ;


-- INSERTA LOS REGISTROS DETALLE.
   let v_concepto = 'PAGO DE CALCOMANIA # '|| parNoCalco  || ' PARA PLACA : ' || parplaca;
  
  insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    v_concepto  , 364300000 ,  parimpcredito);
   let linea = linea +1;

   
--  redondeo

 if parimpredondeo <> 0 then 
   let linea = linea + 1;
  insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    'Ajuste admin',  550800000,  v_importe);
 end if;

  

  COMMIT WORK;	
  
   return 0,'Procedimiento Completo' ; 
--trace off;
end FUNCTION;

create procedure "informix".sp14_recuperacion(prec int, pfold int, pfolh int, pdil char(1), pejec int)
        returning   int as id,
                    varchar(10) as placa,
                    varchar(100) as nombre,
                    varchar(100) as domicilio,
                    money(18,2) as importe_gasto,
                    int as tipo,
                    int as ayo,
                    money(18,2) as importe_ayo,
                    money(18,2) as importe_adeudo,
                    money(18,2) as total_gasto,
                    varchar(100) as firmante,
                    varchar(100) as cargo,
                    varchar(60) as idfirmado,
                    varchar(100) as validez_certi,
                    varchar(25) as fecha_firma,
                    varchar(60) as hash,
                    date as fecha_emision,
                    int as folio,
                    int as id_control,
                    varchar(100) as marca,
                    varchar(100) as submarca,
                    varchar(100) as modelo,
                    varchar(100) as motor,
                    varchar(100) as serie,
                    varchar(100) as color,
                    varchar(255) as folios;

define vid, vtipo, vayo, vfolio, vid_control, vperiodo int;
define vplaca varchar(10);
define vnombre, vdomicilio, vfirmante, vcargo, vvalidez_certi, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor varchar(100);
define vimporte_gasto, vimporte_ayo, vimporte_adeudo, vtotal_gasto money(18,2);
define vidfirmado, vhash varchar(60);
define vfecha_firma varchar(25);
define vfecha_emision date;
define vfoldet varchar(255);

   foreach
     select distinct a.id,a.placa,a.nombre,trim(a.domicilio),c.importe_gastos,d.tipo,d.ayo,sum(d.importe),
     (select (nvl(sum(importe),0)) from db_ingresos:ta_15_periodos where control_otr=c.id_control ),
     (select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=14 and control_otr=a.id 
     and clave_practicado="P" and vigencia="1"),fea.firmante,fea.cargo,
     (fea.secuencia||'-'||fea.digverificador),fea.validez_certi,fea.fecha_firma,fea.hash,c.fecha_emision,c.folio,c.id_control,  
     trim(a.marca), '', trim(a.modelo), trim(a.no_motor), trim(a.serie), trim(a.color)  
     into vid, vplaca, vnombre, vdomicilio, vimporte_gasto, vtipo, vayo, vimporte_ayo, vimporte_adeudo, vtotal_gasto, vfirmante, vcargo,
     vidfirmado, vvalidez_certi, vfecha_firma, vhash, vfecha_emision, vfolio, vid_control, vmarca, vsubmarca, vmodelo, vmotor, vserie, vcolor
     from dbestacion:ta_padron a,db_ingresos:ta_15_apremios c,db_ingresos:ta_15_periodos d, outer db_ingresos:ta_15_apremios_fea fea
     where c.modulo=14 and c.zona=prec and (c.folio between pfold and pfolh)
     and c.control_otr=a.id and c.id_control=d.control_otr 
     and c.diligencia=pdil and ejecutor=pejec  and fea.id_control_req=c.id_control
     group by 1,2,3,4,5,6,7,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25
     order by 18,6,7

     let vfoldet='';
     foreach
       select periodo into vperiodo from db_ingresos:ta_15_periodos where control_otr=vid_control and ayo=vayo and tipo=vtipo order by ayo,periodo
       let vfoldet=trim(vfoldet)||vperiodo||',';
     end foreach;   
     let vfoldet=substr(vfoldet,1,(length(vfoldet)-1));
     return vid, vplaca, vnombre, vdomicilio, vimporte_gasto, vtipo, vayo, vimporte_ayo, vimporte_adeudo, vtotal_gasto, vfirmante, 
       vcargo, vidfirmado, vvalidez_certi, vfecha_firma, vhash, vfecha_emision, vfolio, vid_control, vmarca, vsubmarca, vmodelo, 
       vmotor, vserie, vcolor, vfoldet with resume; 
   end foreach;

end procedure;

create procedure "pgmoreno".sp_gmg_pagos ( par_auto_6 int, par_auto_8 int, par_s_transm_n int, par_referencia char(20), par_importe money(12,2), par_FechaPago Date, parBandera char(1) )
	returning	int as id,
			varchar(255) as mensaje; 

define v_status_recep		int;
define v_leyenda_recep	varchar(255);

define v_reca int;
define v_caja char(2);
define v_oper int;
define v_descrip char(240);
define v_notif char(200);
define v_linea28 char(28);


define v_status		int;
define v_leyenda	varchar(255);
define v_existe		int;
define par_ref_placa	char(7);
define par_autorizacion char(28);
define par_auto_8_11	char(11);
define par_auto_6_17	char(17);
define par_s_transm 	char(20);
define v_rowid, v_rowid_2		int;

Let v_status_recep = 0;
Let v_leyenda_recep = 'No hizo recep';

Let v_reca = 0;
Let v_caja = '';
Let v_oper = 0;
Let v_descrip = '';
Let v_notif = '';
Let v_linea28 = '';

Let v_status = 0;
Let v_leyenda = 'No hizo nada';
Let v_rowid = 0;
Let v_rowid_2 = 0;

if trim(par_referencia)='' then
	let par_ref_placa = 'NADA';
else
	if parBandera = 'N' then  -- proviene de Norita
		if length(par_referencia) = 18 then
			let par_ref_placa = substr ( par_referencia,1,7);
		end if;
		if length(par_referencia) = 17 then
			let par_ref_placa = substr ( par_referencia,1,6);
		end if;
		if length(par_referencia) = 16 then
			let par_ref_placa = substr ( par_referencia,1,5);
		end if;
	else
		let par_ref_placa = Trim(par_referencia);  -- correccion 27/02/2020
	end if;
end if;

Let v_existe = 0;
select count(*) INTO v_existe from db_ingresos:ta_12_recibos  
where fec_pagobco = par_FechaPago and caja = 'I1' and cvepago = 'P' and kio_num_terceros = Trim(par_ref_placa) and importe = par_importe;

if v_existe = 0 then

	Let par_auto_8_11 = LPAD(par_auto_8,11,'0');
	Let par_auto_6_17 = LPAD(par_auto_6,17,'0');
	if parBandera = 'N' then  -- proviene de Norita
		Let par_autorizacion = par_auto_8_11 || par_auto_6_17;
	else
		Let par_autorizacion = par_auto_8_11;
	end if;

	if parBandera = 'N' then  -- proviene de Norita
	
		Let par_s_transm = LPAD(par_s_transm_n,20,'0');

		execute procedure sp_multipagos_recep ( par_autorizacion, 3,1, par_s_transm, Trim(par_referencia), par_importe, '' ,0,1)
		into v_status_recep, v_leyenda_recep;

		execute procedure kioscopago_foliosTCa ( par_s_transm_n, par_importe, 500, 98, par_s_transm_n, '', 0, '')
		into v_reca, v_caja, v_oper, v_descrip, v_notif, v_linea28;

		foreach
		select rowid into v_rowid from db_ingresos:ta_12_recibos where fecha = today and caja = 'I1' and kio_num_terceros = Trim(par_ref_placa)
		if v_rowid > 0 then
			Let v_rowid_2 = v_rowid;
		end if;
		end foreach;
		update  db_ingresos:ta_12_recibos set fec_pagobco = par_FechaPago where rowid = v_rowid_2;
		
	else
		
		execute procedure kioscopago_foliosTCa ( par_s_transm_n, par_importe, 500, par_autorizacion, par_s_transm_n, '', 0, '')
		into v_reca, v_caja, v_oper, v_descrip, v_notif, v_linea28;

		foreach
		select rowid into v_rowid from db_ingresos:ta_12_recibos where fecha = today and caja = 'I1' and kio_num_terceros = Trim(par_ref_placa)
		if v_rowid > 0 then
			Let v_rowid_2 = v_rowid;
		end if;
		end foreach;
		update  db_ingresos:ta_12_recibos set fec_pagobco = par_FechaPago where rowid = v_rowid_2;
		
	end if;

	Let v_status = 1;
	Let v_leyenda = 'Lo registro, revisa';
else
	Let v_status = -1;
	Let v_leyenda = 'Ya existe el registro';
end if;

return v_status, v_leyenda;

end procedure;

create PROCEDURE "pgmoreno".cons14_solicrep_beny2 ( parPlaca char(7) )

Returning  int as Infraccion,
	int as Axo_Folio,
	varchar(250) as Folios,
	money(12,2) as Adeudo,

	int as Id_Placa,
	char(7) as Placa,
	varchar(60) as Nombre,
	varchar(60) as Domicilio,
	varchar(60) as Marca,
	varchar(60) as Sub_Marca,
	int as Modelo,
	varchar(40) as Motor,
	char(20) as Serie,
	char(60) as Color;

define aso_proceso, v_axoinicio, aso_actual		int;

define v_nombre, v_domicilio, v_marca	varchar(60);
define v_no_motor						varchar(40);
define v_serie							char(20);
define v_color							char(60);
define v_modelo							int;
define v_Folios_txt						varchar(250);
define v_contador, v_encontro			int;

define v_IdPlaca, v_Axo, v_Porc, v_num_clave, v_Folio		int;
define v_Tarifa, v_Dscto, v_Adeudo, v_Adeudo_tot		money(12,2);
define v_fecha_folio, v_fecha_hoy							date;
define v_valido												int;

Let aso_proceso = 0;
Let v_axoinicio = 0;
Let aso_actual = 0;
Let v_num_clave = 0;
Let v_nombre = '';
Let v_domicilio = '';
Let v_IdPlaca = 0;
Let v_Folio = 0;
Let v_Axo = 0;
Let v_Porc = 0;
Let v_Tarifa = 0;
Let v_Dscto = 0;
Let v_Adeudo = 0;
Let v_Adeudo_tot = 0;
Let v_Folios_txt = '';
Let v_contador = 0;
Let v_fecha_hoy = Current;
Let v_valido = 0;
Let v_encontro = 0;

--begin
--	on exception in (-958)
--		delete from tmp_folios_txt;
--    end exception;
--		create temp table tmp_folios_txt(
--			clave		int,
--			axo			int,
--			folios_txt	varchar(250),
--			adeudo		money(12,2)
--		) with no log;
--end;

SELECT id, Trim(nombre), Trim(domicilio), Trim(marca), modelo, Trim(no_motor), Trim(serie), Trim(color)
INTO v_IdPlaca, v_nombre, v_domicilio, v_marca, v_modelo, v_no_motor, v_serie, v_color
FROM ta_padron where placa = parPlaca;

FOREACH
SELECT num_clave INTO v_num_clave FROM ta14_infraccion WHERE num_clave < 20 ORDER BY num_clave

	Let aso_proceso = 0;
	Let aso_actual = Year(Current);
	FOR aso_proceso = v_axoinicio to aso_actual

		--if exists (select * from ta14_folios_adeudo WHERE placa = parPlaca and axo = aso_proceso and infraccion = v_num_clave ) then
		--if exists (select * from ta14_folios_adeudo WHERE placa = parPlaca and axo = aso_proceso ) then
		select count(*) into v_encontro from ta14_folios_adeudo WHERE placa = parPlaca and axo = aso_proceso and infraccion = v_num_clave;
		if v_encontro > 0 then
			Let v_Folios_txt = '';
			Let v_contador = 0;
			FOREACH
			SELECT  a.folio, a.fecha_folio, 
				b.tarifa, (100 - c.porc_cobro), trunc(nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2), trunc(b.tarifa - nvl((b.tarifa - ((b.tarifa * c.porc_cobro) / 100)),0),2)
				INTO  v_Folio, v_fecha_folio, 
				v_Tarifa, v_Porc, v_Dscto, v_Adeudo
				FROM ta14_folios_adeudo a, ta14_tarifas b, outer ta14_folios_free c
				WHERE a.placa = parPlaca  and a.axo = aso_proceso  and a.infraccion = v_num_clave
				AND b.num_clave = a.infraccion and b.fecha_inicial = mdy(01,01,a.axo) and b.fecha_fin = mdy(12,31,a.axo)
				AND c.axo = a.axo and c.folio = a.folio and c.clave = 'A'
				ORDER BY a.axo, a.folio

				select count(*) into v_valido from catastro_gdl:no_laborales where fecha between v_fecha_folio and v_fecha_hoy;
				if v_valido > 5 then
					if v_contador = 0 then
						Let v_Folios_txt = v_Folio;
					else
						Let v_Folios_txt = v_Folios_txt||','||v_Folio;
					end if;
					
					Let v_contador = v_contador + 1;
					Let v_Adeudo_tot = v_Adeudo_tot + v_Adeudo;
					Let v_valido = 0;
				end if;
				
			END FOREACH;
			if v_Adeudo_tot > 0 then
				RETURN v_num_clave, aso_proceso, v_Folios_txt, v_Adeudo_tot,
				v_IdPlaca, parPlaca, v_nombre, v_domicilio, v_marca, Null, v_modelo, v_no_motor, v_serie, v_color		with resume;
			end if;
			Let v_Adeudo_tot = 0;
		end if;
		Let v_encontro = 0;
	END FOR;
END FOREACH;

end procedure;

CREATE PROCEDURE "pgmoreno".sp14_remesa_ind ( parPlaca char(7), parFolio int, parCodigo int, parSub_Codigo int )
  	Returning 	int as status , 
		int as Mpio, 
		char(2) as TipoAct, 
		char(12) as Folio,		--date as Null, 	FechaGenReq 
		char(9) as Placa,		--char(20) as Null, 	folioNot  --date as Null, 	FechaNot
		date as FecPgo, 
		date as FecCan,		--decimal (18,2) as Null, importe  --int as Null, Clave
		date as FecAlt,		--date as Null, fechavenc  --decimal(18,2) as Null, folioec
		char(50) as FolioEcMpio, 
		decimal(18,2) as Gastos;


define v_status	int;
define v_obs	varchar(200);

DEFINE v_id_usuario			Integer;
DEFINE v_Mpio				Integer;
DEFINE v_TipoAct                                                  	Char(2);
DEFINE v_Folio				Char(12);
DEFINE v_Placa                                                     	Char(9);
DEFINE v_FecPgo, v_FecCan, v_FecAlt		Date;
DEFINE v_FolioEcMpio			Char(50);
DEFINE v_Gastos				Decimal(18,2);
DEFINE v_Remesa				varchar(15);

Let v_status = 1;
Let v_obs = 'Termino correcto';

Let v_Mpio = 0;
Let v_TipoAct = '';
Let v_Folio = '';
Let v_Placa = '';

Let v_FolioEcMpio = '';
Let v_Gastos = 0;

Let v_Remesa = 'RemesaDePaso';

Let  v_id_usuario = 0;
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = User ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = User;
else
    Let v_id_usuario = 50;
end if;
     ---------------------------
     FOREACH       -- Pagos normales por periodo
     SELECT 113 Municipio, 'PN', (a.folio || '') folio, a.placa, b.fecha_recibo fechapago, today, a.fecha_folio fechaalta, ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion )  folioecmpio, 0
     	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND a.infraccion < 10 AND a.codigo_movto  IN (3,4,8,9,13,24)  AND a.fecha_folio <= MDY(05,31,2005)  AND a.num_acuerdo IS NULL AND a.control = b.control

	Return 1, v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos  with resume;
	--IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio  WHERE folio = v_Folio AND placa = v_Placa AND TipoAct = 'A') then
	--insert into ta14_datos_mpio values ( v_Mpio, v_TipoAct, v_Folio, Null, v_Placa, Null, Null, v_FecPgo, Null, Null, Null, v_FecAlt, Null, Null, v_FolioEcMpio, Null, v_Remesa||v_id_usuario, today );
	--END IF;
     END FOREACH;

     FOREACH       -- Pagos normales por periodo
     SELECT 113 Municipio, 'PN',  (trunc((a.axo* 10000000) + a.folio)) || '' Folio, a.placa, b.fecha_recibo fechapago, today, a.fecha_folio fechaalta, 
                ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion ) folioecmpio, 0   
	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND a.infraccion < 10 AND codigo_movto  IN (3,4,8,9,13,24)  AND fecha_folio > MDY(05,31,2005)  AND a.num_acuerdo IS NULL AND a.control = b.control

	Return 1, v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos  with resume;
	--IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio  WHERE folio = v_Folio AND placa = v_Placa AND TipoAct = 'A') then
	--insert into ta14_datos_mpio values ( v_Mpio, v_TipoAct, v_Folio, Null, v_Placa, Null, Null, v_FecPgo, Null, Null, Null, v_FecAlt, Null, Null, v_FolioEcMpio, Null, v_Remesa||v_id_usuario, today );
	--END IF;
     END FOREACH;
	 
	FOREACH       -- Pagos normales por Internet
	SELECT 113 Municipio, 'PN',  (trunc((a.axo* 10000000) + a.folio)) || '' Folio, a.placa, a.fecha_movto fechapago, today, a.fecha_folio fechaalta, 
	'Pago realizado por Internet' folioecmpio, 0
	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
	FROM ta14_folios_histo a
	WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND a.infraccion < 10 AND codigo_movto  IN (9)  AND fecha_folio > MDY(05,31,2005)  AND a.num_acuerdo IS NULL -- AND a.control = b.control
	END FOREACH;

     ---------------------------
      FOREACH      -- Pagos normales por periodo BANORTE
      SELECT 113 Municipio, "PN" TipoAct, (trunc((a.axo* 10000000) + a.folio)) || "" Folio, a.Placa, (b.fec_pago) Fechapago, today, (a.Fecha_folio) Fechaalta, 
                "Pago en Banorte " || a.Fecha_movto Folioecmpio, 0     
	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
      FROM ta14_folios_histo a, ta14_fol_banorte b
      WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND b.axo = a.axo AND b.folio = a.folio

	Return 1, v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos  with resume;
	--IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio  WHERE folio = v_Folio AND placa = v_Placa AND TipoAct = 'A') then
	--insert into ta14_datos_mpio values ( v_Mpio, v_TipoAct, v_Folio, Null, v_Placa, Null, Null, v_FecPgo, Null, Null, Null, v_FecAlt, Null, Null, v_FolioEcMpio, Null, v_Remesa||v_id_usuario, today );
	--END IF;
     END FOREACH;
     ---------------------------
     FOREACH       -- Cancelaciones por periodo
     SELECT 113 Municipio, 'C', a.folio || '' folio, a.placa, today, fecha_movto fechacancelado, a.fecha_folio fechaalta, '' folioecmpio, 0
     	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  
     WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND a.infraccion < 10 AND a.codigo_movto  in (2,5,15,16,17,18,19,21,22,23) AND a.fecha_folio <= MDY(05,31,2005)

	Return 1, v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos  with resume;
	--IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio  WHERE folio = v_Folio AND placa = v_Placa AND TipoAct = 'A') then
	--insert into ta14_datos_mpio values ( v_Mpio, v_TipoAct, v_Folio, Null, v_Placa, Null, Null, Null, v_FecCan, Null, Null, v_FecAlt, Null, Null, v_FolioEcMpio, Null, v_Remesa||v_id_usuario, today );
	--END IF;
     END FOREACH;

     FOREACH       -- Cancelaciones por periodo
     SELECT 113 Municipio, 'C' ,  (trunc((a.axo* 10000000) + a.folio)  ) || '' Folio, a.placa, today, fecha_movto fechacancelado, a.fecha_folio fechaalta, ''  folioecmpio, 0
     	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a 
      WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND a.infraccion < 10 AND codigo_movto  in (1,2,5,15,16,17,18,19,21,22,23)  AND fecha_folio > MDY(05,31,2005)
 
	Return 1, v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos  with resume;
	--IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio  WHERE folio = v_Folio AND placa = v_Placa AND TipoAct = 'A') then
	--insert into ta14_datos_mpio values ( v_Mpio, v_TipoAct, v_Folio, Null, v_Placa, Null, Null, Null, v_FecCan, Null, Null, v_FecAlt, Null, Null, v_FolioEcMpio, Null, v_Remesa||v_id_usuario, today );
	--END IF;
     END FOREACH;
     ---------------------------
     FOREACH       -- Pagos con requerimiento por periodo
     SELECT 113 Municipio, 'PR', (a.folio || '') folio, a.placa, b.fecha_recibo fechapago, today, a.fecha_folio fechaalta, (reca || '-' || fecha_recibo || '-' || caja || '-' || operacion) folioecmpio, 49
     	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND a.infraccion < 10 AND a.codigo_movto  IN (3,4,13)  AND a.fecha_folio <= MDY(05,31,2005)  AND a.num_acuerdo IS NOT NULL AND a.control = b.control

	Return 1, v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos  with resume;
	--IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio  WHERE folio = v_Folio AND placa = v_Placa AND TipoAct = 'A') then
	--insert into ta14_datos_mpio values ( v_Mpio, v_TipoAct, v_Folio, Null, v_Placa, Null, Null, v_FecPgo, Null, Null, Null, v_FecAlt, Null, Null, v_FolioEcMpio, v_Gastos, v_Remesa||v_id_usuario, today );
	--END IF;
     END FOREACH;

     FOREACH       -- Pagos con requerimiento por periodo
     SELECT 113 Municipio, 'PR',  (trunc((a.axo* 10000000) + a.folio)) || '' Folio, a.placa, b.fecha_recibo  fechapago, today, a.fecha_folio fechaalta, 
                ( reca || '-' || fecha_recibo || '-' || caja || '-' || operacion ) folioecmpio, 49   
	INTO  v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos
     FROM ta14_folios_histo a  , ta14_refrecibo b
     WHERE a.placa = parPlaca AND a.folio = parFolio AND a.codigo_movto = parCodigo AND a.sub_codigo = parSub_Codigo
	AND a.infraccion < 10 AND codigo_movto  IN (3,4,13)  AND fecha_folio > MDY(05,31,2005)  AND a.num_acuerdo IS NOT NULL AND a.control = b.control

	Return 1, v_Mpio, v_TipoAct, v_Folio, v_Placa, v_FecPgo, v_FecCan, v_FecAlt, v_FolioEcMpio, v_Gastos  with resume;
	--IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio  WHERE folio = v_Folio AND placa = v_Placa AND TipoAct = 'A') then
	--insert into ta14_datos_mpio values ( v_Mpio, v_TipoAct, v_Folio, Null, v_Placa, Null, Null, v_FecPgo, Null, Null, Null, v_FecAlt, Null, Null, v_FolioEcMpio, v_Gastos, v_Remesa||v_id_usuario, today );
	--END IF;
     END FOREACH;
     ---------------------------

END PROCEDURE;

CREATE PROCEDURE "informix".kiosco_parkingconsx(parPlaca char(7), parMedio int)
				
	 returning smallint , smallint,  char(7) ,      int , date ,  smallint , smallint , money(7,2), smallint ,                    money(7,2),        int ,            int ,                         char(100)  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define v_gastos money(15,2);
define v_id_padron int;

let parplaca = upper(parplaca); 

 -- execute procedure sp_desto35_fol_jul2018( parplaca ,999997); 
  if today > mdy(11,14,2018) and today < mdy(12,1,2018) then
   execute procedure sp_descto_placa_bf( parplaca );
   end if; 



if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then

-- verifica si existe gastos para que pase a recaudadora a pagar.
-- select * from ta_padron where placa = 'JBB3322' id = 6442265
-- select * from db_ingresos:ta_15_apremios where modulo = 14 and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
 -- select nvl(sum(importe_gastos),0)  from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = 1
 --         and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
   select   id   into  v_id_padron
   from ta_padron where placa = parplaca;
      if v_id_padron is null  then
         let v_id_padron = 0;
      end if;
if v_id_padron > 0 then  
   select nvl(sum(importe_gastos),0)  into v_gastos
          from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron
          and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
   if v_gastos > 0  then
      return 2,0,parplaca, 0,0,0,0,0,0,0,0,0,'Pasar a Recaudadora a realizar el pago';
   end if;
end if;


foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 1,2,3
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(vfecha) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;
-- antes del 1 de julio 2014
--if year(today) = year(vfecha) then
--   let vctaapl = 510900000 ;
--else
--   let vctaapl = 925100001 ;
--end if;
if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 510930000 ;
end if;
-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,0,0,0,0,0,0,'No existen folios para esta placa';
end if;
end procedure
;

CREATE PROCEDURE "informix".kiosco_parkingcons(parPlaca char(7), parMedio int)
				
	 returning smallint , smallint,  char(7) ,      int , date ,  smallint , smallint , money(7,2), smallint ,                    money(7,2),        int ,            int ,                         char(100)  ;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define v_gastos money(15,2);
define v_id_padron int;

let parplaca = upper(parplaca); 

 -- execute procedure sp_desto35_fol_jul2018( parplaca ,999997); 
  if today > mdy(11,14,2018) and today < mdy(12,1,2018) then
   execute procedure sp_descto_placa_bf( parplaca );
   end if; 



if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then

-- verifica si existe gastos para que pase a recaudadora a pagar.
-- select * from ta_padron where placa = 'JBB3322' id = 6442265
-- select * from db_ingresos:ta_15_apremios where modulo = 14 and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
 -- select nvl(sum(importe_gastos),0)  from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = 1
 --         and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
   select   id   into  v_id_padron
   from ta_padron where placa = parplaca;
      if v_id_padron is null  then
         let v_id_padron = 0;
      end if;
if v_id_padron > 0 then  
   select nvl(sum(importe_gastos),0)  into v_gastos
          from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron
          and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
   if v_gastos > 0  then
      return 2,0,parplaca, 0,0,0,0,0,0,0,0,0,'Pasar a Recaudadora a realizar el pago';
   end if;
end if;


foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 1,2,3
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(vfecha) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;
-- antes del 1 de julio 2014
--if year(today) = year(vfecha) then
--   let vctaapl = 510900000 ;
--else
--   let vctaapl = 925100001 ;
--end if;
if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 510930000 ;
end if;
-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,0,0,0,0,0,0,'No existen folios para esta placa';
end if;
end procedure
;

CREATE FUNCTION "informix".admin_encabezados_16_elect(parPlaca varchar(7), parref  varchar(28))
 returning
 varchar(92) as Nombre_completo,
 varchar(80) as calle,
 varchar(10) as No_ext,
 varchar(10) as No_int,
 varchar(50) as Colonia,
 varchar(10) as CP,
 varchar(13) as RFC,
 varchar(50) as Municipio,
 varchar(50) as Estado,
 varchar(18) as CURP,
 lvarchar(500) as descripcion,
 smallint as cartera,
 varchar(100) as mensaje,
 varchar(255) as piepagina,
 int as codigo_mensaje;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint;
define  vfolio integer;
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;
define v_nombre varchar(80);
define  v_calle varchar(80);
define  v_num_ext varchar(8);
define v_axo int;
define v_lon int;
define v_folio int;

-- PAGOS POR INTERNET
if length(trim(parref)) = 28 then
select count(placa)   into   vfolio   from  ta14_kio_trans where  placa = parplaca;

if (vfolio is null ) or (vfolio = 0) then
return ' ' , ' ' ,' ' ,' ', ' ', ' ', ' ' , ' ' ,' ' , ' ',  ' ', 0 ,'2343NO HAY TRANSACIONES ELECTRONICAS PARA ESTA PLACA  28' , ' ' ,  1;
else
select nombre , domicilio , num_ext
into v_nombre ,v_calle , v_num_ext
from ta_padron where placa = parplaca;

if v_nombre is null then
let v_nombre = 'PAGO POR INTERNET DE PLACA: ' || parplaca ;
let v_calle =  '';
let v_num_ext =  '';
end if;


return v_nombre , v_calle  , v_num_ext ,'', '','','' , ' ' ,' ' , '',  ' ', 1 , 'Existen folios para cobrar' , ' ' ,  0;
END IF;
end if;
if parref[1,2] = 'BN' then
   let v_axo  = TO_NUMBER(parref[4,7]);
   let v_lon = length( parref);
   let v_folio = TO_NUMBER(parref[ 9, 16]);

   select count(*)   into vfolio   from ta14_fol_Banorte where axo  = v_axo and folio = v_folio ;

  if vfolio = 0 then
  return ' ' , ' ' ,' ' ,' ', ' ', ' ', ' ' , ' ' ,' ' , ' ',  ' ', 0 ,'NO HAY PAGOS POR BANORTE PARA ESTA PLACA' , ' ' ,  1;
   end if;
  if vfolio > 1 then
   return ' ' , ' ' ,' ' ,' ', ' ', ' ', ' ' , ' ' ,' ' , ' ',  ' ', 1 ,'VARIOS PAGOS PARA ESTE FOLIO, VERIFICAR' , ' ' ,  0;
  end if;


select nombre , domicilio , num_ext
into v_nombre ,v_calle , v_num_ext
from ta_padron where placa = parplaca;

if v_nombre is null then
let v_nombre = 'PAGO POR BANORTE DE PLACA: ' || parplaca ;
let v_calle =  '';
let v_num_ext =  '';
end if;


return v_nombre , v_calle  , v_num_ext ,'', '','','' , ' ' ,' ' , '',  ' ', 1 , 'Existen folios para cobrar' , ' ' ,  0;

end if;


return ' ' , ' ' ,' ' ,' ', ' ', ' ', ' ' , ' ' ,' ' , ' ',  ' ', 0 ,'OPCION DE REFERNCIA ERRONEA' , ' ' ,  1;

end function;

CREATE PROCEDURE "informix".admin_encabezados_16_electnofunciona(parPlaca char(7))
 returning
 varchar(92) as Nombre_completo,
 varchar(80) as calle,
 varchar(10) as No_ext,
 varchar(10) as No_int,
 varchar(50) as Colonia,
 varchar(10) as CP,
 varchar(13) as RFC, 
 varchar(50) as Municipio,
 varchar(50) as Estado,
 varchar(18) as CURP,
 lvarchar(500) as descripcion,
 smallint as cartera,
 varchar(100) as mensaje,
 varchar(255) as piepagina,
 int as codigo_mensaje;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define v_nombre varchar(80);
define  v_calle varchar(80); 
define  v_num_ext varchar(8); 

--select * from  ta14_kio_trans where  placa = 'JRF4491'
select count(placa)   into   vfolio   from  ta14_kio_trans where  placa = parplaca;

if (vfolio is null ) or (vfolio = 0) then
return ' ' , ' ' ,' ' ,' ', ' ', ' ', ' ' , ' ' ,' ' , ' ',  ' ', 0 ,'NO HAY TRANSACIONES ELECTRONICAS PARA ESTA PLACA' , ' ' ,  1;
else
select nombre , domicilio , num_ext 
into v_nombre ,v_calle , v_num_ext
from ta_padron where placa = parplaca;

if v_nombre is null then
let v_nombre = 'PAGO POR INTERNET DE PLACA: ' || parplaca ;
let v_calle =  '';
let v_num_ext =  '';
end if;


return v_nombre , v_calle  , v_num_ext ,'', '','','' , ' ' ,' ' , '',  ' ', 1 , 'Existen folios para cobrar' , ' ' ,  0;
END IF;

end procedure;

CREATE FUNCTION "informix".admin_adeudos_detalle_16(parPlaca char(7), parref varchar(20))
				
{######################################################################
#  Procedimiento:    admin_adeudos_detalle_16
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de Folios de estacionometros en el sistema ADMIN
#
#  Parametros        p_tipo     = numero de placa
#  de entrada:      
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            13 Septiembre 2013   
#  Modificado:       6/6/2018  para integrar el cobro de gastos por notificaciones.
#  Llamado por:      Procedimiento admin_adeudos_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int         as NoRubro,
int         as NoConcepto, 
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion, 
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
define  var_refers bigint;
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define vFechaEmiIni date;
--
  begin
    on exception in (-958)
       delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
      placa  char(7) ,
      axo int,
      folio int, 
      fecha_folio date,
      estado smallint,
      infraccion smallint,
      tarifa  money(12,2), 
      porc_cobro int,
      num_acuerdo int,
      imp_pagar  money(12,2) ,
      cta_aplicacion integer
     ) with no log;
  end;

if parref = '' then
   let par_axo = year(today);
   let par_folio = 99999999;
   let var_refer = (par_axo * 100000000 ) + par_folio;
else
   let par_axo = (parref[1,4]) *1;
   let par_folio = (parref[6,13]) *1;
   let var_refer = (par_axo * 100000000 ) + par_folio;
end if;
--
-- verificar si hay padron
 --foreach 

   
   select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;

--end foreach;

--select * from ta_padron

let v_Acumulado = 0;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
     -- verificar si tienen gastos para su cobro																								
    if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
            let v_Acumulado = v_Acumulado + v_gastos ;
           insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
           porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
          values ( parplaca , year(vN_fecha_emision), vN_folio, vN_fecha_emision, 0 , 0, v_gastos ,
           100 , 0 , v_gastos , 550620011);
           let  v_Referencia  = year(vN_fecha_emision) || '-' || lpad(vN_folio, 8 ,'0') ;  
           let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || vN_fecha_emision || ' Notificacion';
           return 0,0,550620011,v_Referencia,v_Descripcion,v_gastos,v_Acumulado with resume;
     end foreach;
    end if;
   end if;
     --

-- Calculamos fecha inicial
if par_folio <> 99999999 then
    select  fecha_folio into vFechaEmiIni
    from ta14_folios_adeudo a
    where placa =  parplaca
        and  (( a.axo * 100000000 ) +  a.folio) = var_refer;
else
    let vFechaEmiIni = today;
end if;

foreach 
Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca 
and (( a.axo * 100000000 ) +  a.folio) <= var_refer
and a.fecha_folio <= vFechaEmiIni
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 1, 2 asc
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;
-- select * from ta14_tarifas
let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if Weekday(vfecha) = 6 then
    let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;

if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 510930000 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra < 5) and (dias_cuantos < 7) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
  let vimp_apagar = vporc_cobro / 100 * vtarifa;
  let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;  
  let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra;
  let v_Acumulado = v_Acumulado + vimp_apagar;

  insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa ,
      porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
   values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,
    vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
  return 0,0,vctaapl,v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;
   end foreach;
else 
 return 0,0,0,'','',0,0;
end if;
end function;

CREATE FUNCTION "informix".admin_cancela_16(
p_id_admin_pag integer,
p_folio_pag varchar(30),
p_usuario_canc varchar(10)
)
{######################################################################
#  Procedimiento:    admin_pago_09
#  Descripcion:      Interfaz de cancelacion del pago de folios de estacionometro en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            01 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_CVECUENTA   int;
define v_cvepagorbo       CHAR(1);
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Estacionometros ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja,rfcnumero,id_modulo,cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag ,v_CVECUENTA,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 14 then
   let v_leyenda = 'EL RECIBO NO ES POR ESTACIONOMETROS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

      BEGIN WORK;
     let v_r = 'S';
      update db_ingresos: ta_12_recibos set cvepago='C', fecha_act=today
      where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

      -- Verificamos si existen pagos de Cursos de Educaci�n Vial pagados en el pago
      update ta14_cursosmov set 
        estatus = 'V',
        cvepago = -1
      where cvepago = p_id_admin_pag;

      insert into dbestacion:ta14_folios_adeudo 
               select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio       
                from  ta14_refrecibo a , ta14_folios_histo b  
              where  a.fecha_recibo =v_fecha_pag and  a.reca = v_rec_pag and   a.caja = v_caja_pag
              and a.operacion = p_id_admin_pag and  a.control = b.control ;
        
      delete  from dbestacion:ta14_folios_histo 
              where  control in (select control from dbestacion:ta14_refrecibo where  fecha_recibo = v_fecha_pag and 
                reca = v_rec_pag and   caja = v_caja_pag and operacion = p_id_admin_pag );

       delete from dbestacion:ta14_refrecibo 
              where  fecha_recibo = v_fecha_pag and  reca = v_rec_pag and   caja = v_caja_pag
               and operacion = p_id_admin_pag ;
   

     update db_ingresos:ta_15_apremios set fecha_pago = null  , recaudadora = null ,
       caja = null , operacion  = null, importe_pago = null  , vigencia = 1
   where modulo = 14 and fecha_pago = v_fecha_pag and recaudadora = v_rec_pag and caja = v_caja_pag
               and operacion = p_id_admin_pag ;
      
      COMMIT WORK; 
 


return v_estatus,v_leyenda;
--trace off;
END FUNCTION
;

CREATE PROCEDURE "informix".e_parkingcons18x(parPlaca char(7), parMedio int)
				
returning 
smallint as estatus, 
smallint as axo,  
char(7) as placa,      
int as folio, 
date as fecha,  
smallint as estado, 
Char(40) as infraccion, 
money(7,2) as tarifa, 
smallint as porcentaje,  
money(7,2) as importe,        
int as acuerdo,            
int as ctaaplic,
char(100) as observacion;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define infra_descrip char(40);
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define vFechaCurso date;
define vCostoCurso decimal(7,2);
--set debug file to "parkivan.log";
--trace on;
 --execute procedure sp_desto35_fol_jul2018( parplaca ,999998 );
 execute procedure sp_descto_placa_bf ( parplaca );
select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;

if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
    if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
     return 
       0,year(vN_fecha_emision),parplaca, vN_folio, vN_fecha_emision, 0 , 'Notificaci�n', v_gastos ,
       100 , v_gastos , 0 , 550620011 , 'Ok' with resume;
     end foreach;
    end if;
   end if;
if today > mdy(11,14,2018) and today < mdy(12,22,2018) then
   execute procedure sp_descto_placa_bf( parplaca );
end if; 

-- Se inserta renglon en caso tenga un Curso de Movilidad pendiente de pago
        foreach
        select fecha_registro into vFechaCurso
        from ta14_cursosmov 
        where placa = parplaca and estatus = 'V'
            -- Obtenemos el costo del Curso del a�o que se otorg�
            select (t.tarifa + t.costo_fijo01) into  vCostoCurso
            from ta14_tarifas t
            where year(fecha_inicial) = year(vFechaCurso) 
                and num_clave = 99; 

            if vCostoCurso > 0 then
                -- Insertamos renglones de respuesta para los cursos...
                --let v_Acumulado = v_Acumulado + vCostoCurso ;

                --let  v_Referencia  = year(vFechaCurso) || '-' || lpad(0, 8 ,'0') ;  
                let infra_descrip = year(vFechaCurso) || '-0-' || year(vFechaCurso) ||'/'|| lpad(month(vFechaCurso),2,'0')||'/'||day(vFechaCurso) || ' CURSO TALLER DE EDUCACION VIAL';
                --insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                --    values ( parplaca , year(vFechaCurso), 0, vFechaCurso, 1 , 99, vCostoCurso , 100 , '' , vCostoCurso , '449137');
                

               -- return 0,449137, 449137,v_Referencia,v_Descripcion,vCostoCurso,v_Acumulado with resume;
		return 
		0,year(vFechaCurso),parplaca, 0, vFechaCurso, 14 ,infra_descrip, vCostoCurso , 100 , vCostoCurso , 0 , '449137' , 'Ok'
		with resume;
            end if;
        end foreach;

foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
, infra.descripcion
into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b , ta14_infraccion infra, outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and infra.num_clave = a.infraccion and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A' 
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;

--select count(*) 
--       into dias_habil 
--       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha+1 and today;

--     while x1 <= fecha_hoy 
--        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
--          let dias_cuantos =dias_cuantos+1;
--         end if;
--     let x1 = x1+1;
--   end while;


  if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado ,'Clave: '|| vinfra||' - '||infra_descrip, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,'',0,0,0,0,0,'No existen folios para esta placa';
end if;

end procedure
;

CREATE FUNCTION "dbduenas".admin_adeudos_detalle_16odoo ( parPlaca char(7), parref varchar(20))

{######################################################################
#  Procedimiento:    admin_adeudos_detalle_16odoo
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de Folios de estacionometros en el sistema ODOO
#
#  Parametros        p_tipo     = numero de placa
#  de entrada:      
#      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            11 Octubre 2019  
#  Modificado:       6/6/2018  para integrar el cobro de gastos por notificaciones.
#  Llamado por:      Procedimiento admin_adeudos_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning
int         as NoRubro,
int         as NoConcepto,
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion,
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint;
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define vimp_dscto decimal(7,2); -- para descuento clave 4
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
define  var_refers bigint;
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define infra_descrip char(40);
define vFechaEmiIni date;
--
begin
    on exception in (-958)
delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
placa  char(7) ,
axo int,
folio int,
fecha_folio date,
estado smallint,
infraccion smallint,
tarifa  money(12,2),
porc_cobro int,
num_acuerdo int,
imp_pagar  money(12,2) ,
cta_aplicacion integer
    ) with no log;
end;

if parref = '' then
   let par_axo = year(today);
   let par_folio = 99999999;
   let var_refer = (par_axo * 100000000 ) + par_folio;
else
   let par_axo = (parref[1,4]) *1;
   let par_folio = (parref[6,13]) *1;
   let var_refer = (par_axo * 100000000 ) + par_folio;
end if;
--


-- verificar si hay padron
--foreach
select   id   into  v_id_padron
from ta_padron where placa = parplaca;
    if v_id_padron is null  then
let v_id_padron = 0;
    end if;
--end foreach;
--select * from ta_padron

let v_Acumulado = 0;
if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
    -- verificar si tienen gastos para su cobro
    if v_id_padron > 0 then  
select nvl(sum(importe_gastos),0) into v_gastos
from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron
and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
   
if v_gastos > 0 then
foreach
            select  folio ,  fecha_emision ,  importe_gastos  
into vN_folio , vN_fecha_emision , v_gastos
from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron
and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1

            let v_Acumulado = v_Acumulado + v_gastos ;

insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
values ( parplaca , year(vN_fecha_emision), vN_folio, vN_fecha_emision, 0 , 0, v_gastos , 100 , 0 , v_gastos , 550620011);
let  v_Referencia  = year(vN_fecha_emision) || '-' || lpad(vN_folio, 8 ,'0') ;  
let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || vN_fecha_emision || ' Notificacion';
return 0,550620011, get_odoo_cta(  550620011  ,16 ),v_Referencia,v_Descripcion,v_gastos,v_Acumulado with resume;
end foreach;
end if;
end if;
    --

-- Calculamos fecha inicial
if par_folio <> 99999999 then
    select  fecha_folio into vFechaEmiIni
    from ta14_folios_adeudo a
    where placa =  parplaca
        and  (( a.axo * 100000000 ) +  a.folio) = var_refer;
else
    let vFechaEmiIni = today;
end if;



foreach
Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0), infra.descripcion
into  vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b  , ta14_infraccion infra , outer ta14_folios_free f
where a.placa = parplaca
and (( a.axo * 100000000 ) +  a.folio) <= var_refer
and a.fecha_folio <= vFechaEmiIni
and a.infraccion = b.num_clave
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and infra.num_clave = a.infraccion
and a.axo = f.axo and a.folio = f.folio and f.clave = 'A' and f.fecha_limite >= today
order by 3 asc, 1 asc, 2 asc
--select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
--select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
--group by fecha_folio
--- para obtener dias de vencimiento;
-- select * from ta14_tarifas

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
if Weekday(vfecha) = 6 then
let dias_cuantos = 1;
end if;
select count(*) into dias_habil
    from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

    while x1 <= fecha_hoy
IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
let dias_cuantos =dias_cuantos+1;
    end if;
let x1 = x1+1;
end while;

let dias_cuantos =  dias_cuantos - dias_habil ;

--if year(today) = year(vfecha) then
-- let vctaapl = 510900000 ;
--else
-- let vctaapl = 510930000 ;
--end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.

-- PARTE QUE SUSTITUYE LAS CUENTAS ANTERIORES
if vinfra = 1 then  -- Por no cubrir la tarifa vigente autorizada para hacer uso del espacio de estacionamiento-612086-CLAVE 1
let vctaapl = 160000001;
end if;
if vinfra = 2 then  -- Por estacionar veh�culo invadiendo dos cajones o m�s marcados-612087-CLAVE 2
let vctaapl = 160000002;
end if;
if vinfra = 3 then  -- Por obstruir cochera impidiendo o dificultando el ingreso o salida-612088-CLAVE 3
let vctaapl = 160000003;
end if;
if vinfra = 4 then  -- Por estacionarse en l�nea amarilla-612089-CLAVE 4
let vctaapl = 160000004;
end if;
if vinfra = 5 then  -- "Por estacionarse sin derecho en lugares prohibidos exclusivos areas para de bomberos, polic�a y servicios m�dicos rampas o cajones para discapacitados salidas de emergencia
--  doble fila ciclov�as banquetas camellones andadores peatonales ciclopuertos en sentido contrario lugares prohibidos"-612111-CLAVE 5
let vctaapl = 160000005;
end if;
if vinfra = 6 then  -- Por estacionarse en bater�a cuando �ste sea en cord�n o viceversa-612092-CLAVE 6
let vctaapl = 160000006;
end if;
if vinfra = 7 then  -- Por veh�culo infraccionado e inmovilizado-612094-CLAVE 7
let vctaapl = 160000007;
end if;
if vinfra = 8 then  -- Por impedir u obstaculizarse a recibir documentaci�n oficia o negarse a proporcionar los datos, informes, documentos o registros,
-- as� como insultar o amenazar a los mismos-612008-CLAVE 8
let vctaapl = 160000008;
end if;
if vinfra = 10 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
let vctaapl = 160000010;
end if;
if vinfra = 20 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
let vctaapl = 160000010;
end if;
--

--para calcular el valor de la multa;
if (vinfra <> 5) and (dias_cuantos < 7) then
    let vporc_cobro = 50 ;
-- vimp_dscto
else
    let  vporc_cobro = 100;
end if;

if vsqlporc_cobro <> 100 then
let vporc_cobro = vsqlporc_cobro;
end if;

let vimp_apagar = vporc_cobro / 100 * vtarifa;
let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;  
let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra || ' - ' || infra_descrip;
--let v_Acumulado = v_Acumulado + vimp_apagar;

--insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
-- values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
--return 0,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;

if vporc_cobro <> 100 then
let v_Acumulado = v_Acumulado + vtarifa;
insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;

let vctaapl = 160000104;
Let vimp_dscto = vtarifa - vimp_apagar;
Let vimp_dscto = vimp_dscto * -1;
let v_Acumulado = v_Acumulado + vimp_dscto;
insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, null , null, null, vimp_dscto , vctaapl);
return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vimp_dscto,v_Acumulado with resume;
else
let v_Acumulado = v_Acumulado + vtarifa;
insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;
end if;


Let vporc_cobro = 0;
Let vsqlporc_cobro = 0;
end foreach;
else
return 0,0,0,'','',0,0;
end if;

end function;

CREATE PROCEDURE "informix".e_parkingcons18(parPlaca char(7), parMedio int)
				
returning 
smallint as estatus, 
smallint as axo,  
char(7) as placa,      
int as folio, 
date as fecha,  
smallint as estado, 
Char(40) as infraccion, 
money(7,2) as tarifa, 
smallint as porcentaje,  
money(7,2) as importe,        
int as acuerdo,            
int as ctaaplic,
char(100) as observacion;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define infra_descrip char(40);
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define vFechaCurso date;
define vCostoCurso decimal(7,2);
--set debug file to "parkivan.log";
--trace on;
 --execute procedure sp_desto35_fol_jul2018( parplaca ,999998 );
 execute procedure sp_descto_placa_bf ( parplaca );
select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;

if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
    if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
     return 
       0,year(vN_fecha_emision),parplaca, vN_folio, vN_fecha_emision, 0 , 'Notificaci�n', v_gastos ,
       100 , v_gastos , 0 , 550620011 , 'Ok' with resume;
     end foreach;
    end if;
   end if;
if today > mdy(11,14,2018) and today < mdy(12,22,2018) then
   execute procedure sp_descto_placa_bf( parplaca );
end if; 

-- Se inserta renglon en caso tenga un Curso de Movilidad pendiente de pago
        foreach
        select fecha_registro into vFechaCurso
        from ta14_cursosmov 
        where placa = parplaca and estatus = 'V'
            -- Obtenemos el costo del Curso del a�o que se otorg�
            select (t.tarifa + t.costo_fijo01) into  vCostoCurso
            from ta14_tarifas t
            where year(fecha_inicial) = year(vFechaCurso) 
                and num_clave = 99; 

            if vCostoCurso > 0 then
                -- Insertamos renglones de respuesta para los cursos...
                --let v_Acumulado = v_Acumulado + vCostoCurso ;

                --let  v_Referencia  = year(vFechaCurso) || '-' || lpad(0, 8 ,'0') ;  
                let infra_descrip = year(vFechaCurso) || '-0-' || year(vFechaCurso) ||'/'|| lpad(month(vFechaCurso),2,'0')||'/'||day(vFechaCurso) || ' CURSO TALLER DE EDUCACION VIAL';
                --insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                --    values ( parplaca , year(vFechaCurso), 0, vFechaCurso, 1 , 99, vCostoCurso , 100 , '' , vCostoCurso , '449137');
                

               -- return 0,449137, 449137,v_Referencia,v_Descripcion,vCostoCurso,v_Acumulado with resume;
		return 
		--0,year(vFechaCurso),parplaca, 9999999, vFechaCurso, 14 ,infra_descrip, vCostoCurso , 100 , vCostoCurso , 0 , '449137' , 'Ok'
		0,0,parplaca, 0, vFechaCurso, 14 ,infra_descrip, vCostoCurso , 100 , vCostoCurso , 0 , '449137' , 'Ok'
		with resume;
            end if;
        end foreach;

foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
, infra.descripcion
into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b , ta14_infraccion infra, outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and infra.num_clave = a.infraccion and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A' 
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;

--select count(*) 
--       into dias_habil 
--       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha+1 and today;

--     while x1 <= fecha_hoy 
--        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
--          let dias_cuantos =dias_cuantos+1;
--         end if;
--     let x1 = x1+1;
--   end while;


  if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

return 
0,vaxo,parplaca, vfolio, vfecha, vestado ,'Clave: '|| vinfra||' - '||infra_descrip, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,'',0,0,0,0,0,'No existen folios para esta placa';
end if;

end procedure
;

create procedure "informix".kiosco_parkingliqy18(parplaca char(7), paraxoini int , parfolioini int , 
paraxohasta int, parfoliohasta int , parmedio int)
--transaccion , numfolios , axofinal,foliofinal, descrip , descripnot, idmedio, impactual, impanterior, impmulta, impredondeo
returning  
int as transaccion, 
int as numfolios, 
char(250) as descrip,
char(200) as descripnot, 
int as idmedio, 
money(12,2) as impactual, 
money(12,2) as impanterior, 
money(12,2) as impmulta,
money(4,2)  as impredondeo, 
int as ctaaplic,
int as ctaaplicrez,
int as ctaaplicmulta,
int as ctaaplicred;

define v_idtrans int;
define v_nofol   int;
define v_descrip  char(250);
define v_descripnot char(200);
define v_impactual money(12,2);
define v_impanterior money(12,2);
define v_impMulta money(12,2);
define v_impredondeo money(4,2);
define v_axoactual int;
define v_folioinicial int;
define v_foliofinal int;
define contador int;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define vinfra int;
define dias_cuantos integer;
define dias_habil integer;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define v_tot money(12,2);
define v_totpag money(12,2);
define v_folionot char(20);
define v_axotrans int;
   define v_foliotrans int;
define v_procesar int;
define v_dettrans int;
define vFechaCurso date;
define vCostoCurso decimal(7,2);

let parplaca = upper(parplaca);
let v_folioinicial = ((paraxoini * 1000000)+parfolioini) ;
let v_foliofinal = ((paraxohasta * 1000000)+parfoliohasta) ;

 
let contador = 0;
let v_impactual = 0;
let v_impanterior = 0;
let v_impmulta = 0;
let v_descrip = 'Folios:';
let v_descripnot = '';
let v_procesar = 1;

foreach 

Select a.axo, a.folio,  b.tarifa, a.infraccion, a.fecha_folio ,nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 

into 
vaxo, vfolio,  vtarifa ,vinfra,vfecha  ,vsqlporc_cobro , vacuerdo 
from ta14_folios_adeudo a, ta14_tarifas b , outer ta14_folios_free f
where a.placa = parplaca 
and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 5 asc

if (v_procesar = 0) then 
   exit foreach;
end if;

--ultimo folio a procesar
if (((vaxo * 1000000)+vfolio) = v_foliofinal) then 
   let v_procesar = 0;
end if;


if length(v_descrip) >=245 then 
   exit foreach;
end if;
   let v_axotrans = vaxo ;
   let v_foliotrans = vfolio;
let contador = contador +1;

let v_descrip = trim(v_descrip)|| vaxo || '-' ||vfolio||';';
--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
 if weekday(vfecha) = 6 then
   let dias_cuantos = 1;
 end if;
select count(*) 
       into dias_habil 
       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

     while x1 <= fecha_hoy 
        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
          let dias_cuantos =dias_cuantos+1;
         end if;
     let x1 = x1+1;
   end while;

let dias_cuantos =  dias_cuantos - dias_habil ;



--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
if year(today) = year(vfecha) then
   let v_impactual = v_impactual + vimp_apagar;
else
   let v_impanterior = v_impanterior + vimp_apagar;
end if;


end foreach;
let v_foliofinal = ((v_axotrans * 1000000)+ v_foliotrans) ;
foreach 
select noti.folionot into v_folionot
 from ta14_notifica_edo noti where noti.num_acuerdo in 
(select distinct a.num_acuerdo
from ta14_folios_adeudo a where  a.placa = parplaca and a.num_acuerdo > 0
 and (((a.axo * 1000000)+a.folio) between v_folioinicial and v_foliofinal))
 and noti.fechapago is null and noti.fechacancelado is null

 let v_descripnot = trim(v_descripnot)||' ' || trim(v_folionot);
 let v_impMulta = v_impMulta + 23;
end foreach;
--Consulta si existe el mismo dia una transaccion realizada con los mismos folios.
 if exists (select numtrans from ta14_kio_trans 
         where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador and
         impactual = v_impactual and impanterior = v_impanterior)  then
    select numtrans into v_idtrans from ta14_kio_trans 
             where  placa  = parplaca and axoini = paraxoini and 
                folioini = parfolioini and axofin = v_axotrans and  foliofin =  v_foliotrans and numfolios = contador 
               and impactual = v_impactual and impanterior = v_impanterior;
  else

      -- Se agrega el costo en caso tenga un Curso de Movilidad pendiente de pago
        foreach
        select fecha_registro into vFechaCurso
        from ta14_cursosmov 
        where placa = parplaca and estatus = 'V'
            -- Obtenemos el costo del Curso del a�o que se otorg�
            select (t.tarifa + t.costo_fijo01) into  vCostoCurso
            from ta14_tarifas t
            where year(fecha_inicial) = year(vFechaCurso) 
                and num_clave = 99; 

            if vCostoCurso > 0 then
                let v_impanterior = v_impanterior + vCostoCurso;
            end if;
        end foreach;

   insert into ta14_kio_trans (
    numtrans ,    placa ,    foliosdescrip ,    notifdescrip ,
    axoini ,    folioini ,    axofin ,    foliofin ,    numfolios ,
    idmedio ,    impactual ,    impanterior,    impmulta , fecha , hora) 
  values(0,parplaca , v_descrip, v_descripnot , 
  paraxoini  , parfolioini  , v_axotrans , v_foliotrans , contador , parmedio
 , v_impactual , v_impanterior, v_impMulta, today, current hour to second);
   LET v_idtrans = dbinfo("sqlca.sqlerrd1");
  end if;
let v_tot = v_impactual +v_impanterior+ v_impMulta;

-- Graba los detalles
 let v_procesar = 1;
 select count(*) into v_dettrans from ta14_kio_transdet where id_kio_trans = v_idtrans;
 if v_dettrans = 0 then
   foreach 

     Select a.axo, a.folio,  a.fecha_folio
       into vaxo, vfolio,  vfecha
       from ta14_folios_adeudo a
       where a.placa = parplaca 
       order by 3 asc

     if (v_procesar = 0) then 
        exit foreach;
     end if;

     --ultimo folio a procesar
     if (((vaxo * 1000000)+vfolio) = v_foliofinal) then 
        let v_procesar = 0;
     end if;
     insert into ta14_kio_transdet values ( 0 , v_idtrans , vaxo, vfolio);
   end foreach;


    -- Se inserta renglon en caso tenga un Curso de Movilidad pendiente de pago
   foreach
        select fecha_registro into vFechaCurso
        from ta14_cursosmov 
        where placa = parplaca and estatus = 'V'
          --  if vCostoCurso > 0 then
               insert into ta14_kio_transdet values ( 0 , v_idtrans ,  0, 0);
          --  end if;
   end foreach;

end if;
--


execute procedure redondeokiosco(v_tot) into v_totpag, v_impredondeo;

-- 510900000;  -- 46305  A�o actual
-- 925100001;  -- 46320   a�os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.
return  v_idtrans , contador, v_descrip  , v_descripnot ,parmedio, v_impactual , v_impanterior,
-- v_impMulta , v_impredondeo, 510900000, 925100001, 992100006 ,55080000;
   v_impMulta , v_impredondeo, 510900000, 510930000, 992100006  , 550800000;
end procedure;

create procedure "informix".sp14_coloniascarta(pcolonia varchar(100),  pftrab date)
returning   int as id_placa,
            varchar(100) as nombre,
            varchar(10) as placa,
            money(18,2) as impuesto,
            money(18,2) as recargos,
            money(18,2) as gastos,
            money(18,2) as multas,
            money(18,2) as actualizacion,
            money(18,2) as total;

define vid_placa, vfolios, vtotal_placas, vtotal_folios, vdias, rcant_folio,v_ru,v_conc,vctaapl int;
define vnombre, rnombre, rdomicilio varchar(100);
define v_Referencia varchar(30);
define v_Descripcion varchar(60);
define vplaca, rplaca varchar(10);
define v_importe,v_recargos,v_gastos,v_multa,v_actualizacion,v_total,vimp_apagar,v_Acumulado money(18,2);

let vtotal_placas=0;
let vtotal_folios=0;
let v_recargos=0;
let v_multa=0;
let v_actualizacion=0;

-- para retornar datos
foreach
  SELECT p.id, trim(a.colonia), trim(a.placa)
  into vid_placa, vnombre, vplaca
  FROM dbestacion:ta14_cartainvitacion a, dbestacion:ta_padron p
  WHERE a.colonia LIKE '%'||pcolonia||'%' and a.fecha_trabajo=pftrab
  and p.id>0 and p.placa=a.placa
  GROUP By p.id, a.colonia, a.placa ORDER BY a.colonia, a.placa

  let vfolios=0;
  --  ejecuta el adeudo de cajero 
  foreach
    execute FUNCTION admin_adeudos_detalle_16odoo ( vplaca, ' ') into v_ru,v_conc,vctaapl,v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado
  end foreach;

  -- acumula adeudo de gastos
  let v_gastos=0;
  select nvl(sum(imp_pagar),0) into v_gastos 
  from tmp_folios where cta_aplicacion=550620011 and imp_pagar>0;
  -- acumula adeudo de folios
  let v_importe=0;
  select nvl(sum(imp_pagar),0) into v_importe 
  from tmp_folios where cta_aplicacion<>550620011 and imp_pagar>0;

  let v_total=v_importe+v_recargos+v_gastos+v_multa+v_actualizacion;

  -- borrar tabla temporal
  delete from tmp_folios;

  if v_importe >0 then
     -- verifica si tiene notificacion dentro de los 60 dias
     if exists(select * from db_ingresos:ta_15_cartainvitacion where id_modulo=vid_placa  and vigencia<>'C' and modulo=14) then
        foreach
          select (today-fecemi) into vdias from db_ingresos:ta_15_cartainvitacion where id_modulo=vid_placa  
           and vigencia<>'C' and modulo=14 order by fecemi
        end foreach;
        if vdias>60 then
           return vid_placa, vnombre, vplaca,v_importe,v_recargos,v_gastos,v_multa,v_actualizacion,v_total with resume;
        end if;
     else
        return vid_placa, vnombre, vplaca, v_importe,v_recargos,v_gastos,v_multa,v_actualizacion,v_total with resume;
     end if;
    end if;

end foreach;

end procedure;

create procedure "informix".sp14_impresion(prec int,pfold int, pfolh int, peje int, pfec date)
returning int as folio,
         money(18,2) as total,
         char(7) as placa,
         varchar(100) as ejecutor,
         varchar(60) as nombre,
         varchar(60) as domicilio,
         varchar(60) as marca,
         varchar(4) as modelo,
         varchar(40) as motor,
         varchar(20) as serie,
         varchar(60) as color,
         varchar(60) as colonia;

define v_folio int;
define v_total money(18,2);
define v_eje varchar(100);
define v_placa char(7);
define v_nombre, v_domicilio, v_marca, v_color, v_colonia varchar(60);
define v_modelo varchar(4);
define v_motor varchar(40);
define v_serie varchar(20);

foreach       
  select a.foliocarta, a.total, b.placa
  ,(select nombre from db_ingresos:ta_15_ejecutores where cve_eje=a.cveejecutor and id_rec=a.recaud) ejecutor,
  Trim(b.nombre) nombre, Trim(b.domicilio) domicilio, Trim(b.marca) marca, b.modelo, Trim(b.no_motor) no_motor, Trim(b.serie) serie, 
  Trim(b.color) color, b.colonia
  into v_folio, v_total, v_placa, v_eje, v_nombre, v_domicilio, v_marca, v_modelo, v_motor, v_serie, v_color, v_colonia
  from db_ingresos:ta_15_cartainvitacion a, ta_padron b 
  where a.modulo=14 and a.recaud=prec and (a.foliocarta between pfold and pfolh) 
  and a.vigencia='V' and a.cveejecutor=peje and a.fecejec=pfec
  and b.id=a.id_modulo order by a.foliocarta

  return v_folio, v_total, v_placa, v_eje, v_nombre, v_domicilio, v_marca, v_modelo, v_motor, v_serie, v_color, v_colonia with resume;

end foreach;

end procedure;

CREATE FUNCTION "informix".admin_pago_16(parPlaca char(7), parref varchar(20),
                parImpCertificado money(15,2),
                parimpredondeo   money(8,2),
                parimpcredito   money(15,2),
    		parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
	        ParFolioRecibo  char(30), --Folio del Recibo (ADMIN)
	        ParFechaRecibo  date ,   --Fecha del Recibo
	        ParReca         int, --No. de Recaudadora
	        ParCaja  char(2) ,--No. de Caja
	        ParCajero  char(10),	 --Clave usuario
                parCentro  integer)
				
{######################################################################
#  Procedimiento:    admin_pago_16
#  Descripcion:      Interfaz de pago de adeudo para el cobro de Folios de estacionamiento en el sistema ADMIN
#
#  Parametros        parPlaca     = numero de placa
#  de entrada:       Parref       = Referencia maxima a cobrar
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            24 Octubre 2013   
#  Modif para Apremios (afectar carta invitacion)
#  fecha:			 26 agosto 2020
#
#  Llamado por:      Procedimiento sp_pago en dbingresosw
#  Llama a:          
#  
######################################################################}

returning smallint , varchar(50);
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define x_placa  char(7) ;
define x_axo int;
define x_folio int; 
define x_fecha_folio date;
define x_estado smallint;
define x_infraccion smallint;
define x_tarifa  money(12,2); 
define x_porc_cobro int;
define x_num_acuerdo int;
define x_imp_pagar  money(12,2);
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;
define v_ru int;
define v_conc int;
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define daxo int;
define dfolio int;
define dplaca char(7);
define dacuerdo  int;
define  dtarifa money(12,2);
define  dporc_cobro int;
define  dimp_pagar money(12,2); 
define v_id_usuario int;
define v_cta int;
define linea int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define v_r char(1);
define v_ca int;
define v_cta_aplic int;
define v_fecha_folio date;
define	li_id	integer;

   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -12, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE ESTACIONOMETROS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
--set debug file to 'pagoFolio';
--trace on;
  let v_r = 'N';

foreach
	execute procedure admin_adeudos_detalle_16(parPlaca , parref ) into 
	v_ru , v_conc , vctaapl,v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado
end foreach;

select count(*) into v_ca from tmp_folios ;
 if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;

--OBTENER EL ID USUARIO CAJERO;
select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = ParCajero;

if  v_id_usuario    is null then
 let v_id_usuario   = 335;  -- usuario ADMIN
end if;


    BEGIN WORK;
   let v_r = 'S';
 -- select * from db_ingresos:ta_12_recibos where id_modulo = 14 and fecha > '1/1/2013'
   insert into db_ingresos:ta_12_recibos(fecha , id_rec , caja , operacion ,  importe , cvepago ,
    id_modulo ,  id_regmodulo,  id_rec_cta , regmunur ,
    mesdesde , axodesde, meshasta, axohasta ,
    nombre ,  domicilio , concepto , rfcini , rfcnumero ,
    rfccolonia,  obra ,  axofolio , id_usuario , fecha_act , descripcion ,
    lugar_pago , id_centro ,  foliorecibo) 
   values (ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN     , parImpCertificado, 'P' ,
    14, 0, 0, 'F' ,
    0, 0, 0, 0, 'Pago de multas de estacionometros de la placa: ' || parPlaca, '','Pago de multas de estacionometros de la placa: ' || parPlaca , '', 0,
    0,0,0, v_id_usuario ,current , '' , 0,parCentro, ParFolioRecibo ) ;
   let linea = 1;

	-- Inserta Carta compromiso Pagada
	-- Busca si existe carga invitaci�n 
	Select  id
	Into 	li_id
	from    dbestacion:ta_padron 
	where   placa =  parPlaca ;
	if 	li_id > 0 THEN
		-- Actualiza Carta Invitaci�n
		update  db_ingresos:ta_15_cartainvitacion 
		set     vigencia	= 'P', 
				fecha_pago 	= ParFechaRecibo, 
				recaudadora	= ParReca, 
				caja		= ParCaja, 
				operacion	= parID_ADMIN
		where   modulo = 14 
		and     id_modulo = li_id 
		and     vigencia='V' ;
	End if
	-- Termina Carta compromiso Pagada


    foreach 
    select cta_aplicacion , sum(imp_pagar) into  v_cta , v_importe
    from  tmp_folios where placa = parPlaca
    group by 1
 
        insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 'Suma del importe de folios'  , v_cta ,  v_importe);
        let linea = linea +1;

        -- Verificamos si esta pagando Curso de Educaci�n Vial
        if v_cta = 449137 then
            update ta14_cursosmov set
                estatus = 'P',
                cvepago = parID_ADMIN
            where placa = parPlaca and estatus = 'V';
        end if;

    end foreach;

    -- Actualizamos pagos de movilidad
     update ta14_cursosmov set
                estatus = 'P',
                cvepago = parID_ADMIN
     where placa = parPlaca and estatus = 'V' and cvepago = -1;

if parimpredondeo <> 0 then
   insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 'REDONDEO' , 550800000,  parimpredondeo);
   let linea = linea +1;
end if;


   foreach 
       select  	axo , folio,  placa, num_acuerdo  ,
				tarifa ,  porc_cobro ,  imp_pagar  , cta_aplicacion , fecha_folio
       into     daxo, dfolio,  dplaca, dacuerdo  ,
				dtarifa ,  dporc_cobro ,  dimp_pagar  , v_cta_aplic , v_fecha_folio
	   from  	tmp_folios where placa = parPlaca
		if 	v_cta_aplic <> 550620011 then
			insert into ta14_folios_histo       
			select 	0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial,
					13, v_id_usuario , zona , espacio ,0
			from ta14_folios_adeudo 
			where axo = daxo and folio = dfolio;
		
			let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    
			insert into ta14_folios_hco (control , importe_infraccion , porcentaje , importe_cobrado)
			values(varcontrol ,  dtarifa ,  dporc_cobro ,  dimp_pagar );


			insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion)
			values ( varcontrol ,ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN);   
		
			delete from ta14_folios_adeudo where axo = daxo and folio = dfolio;
			if 		dacuerdo <> 0 then
					update ta14_notifica_edo set origen_pago = 1, fechapago = today 
					where num_acuerdo = dacuerdo and fechapago is null;
			end if;

		else
	---  pagar las notificaciones
    -- select * from db_ingresos:ta_15_apremios
			update db_ingresos:ta_15_apremios set fecha_pago = ParFechaRecibo
				, recaudadora = ParReca , caja = ParCaja , operacion  = parID_ADMIN, importe_pago = importe_gastos ,
				vigencia = 2
			where modulo = 14 and folio = dfolio and fecha_emision = v_fecha_folio and  fecha_pago is null;
		
  End if;


   end foreach;

  --- BORRAR TEMPORAL
       delete from tmp_folios;
   COMMIT WORK;	
   return 0,'Procedimiento Completo' ;  
--trace off;
end FUNCTION
;

create procedure "informix".spd_delesta02(
		paraxo smallint,
                                parfolio  integer,
		parPlaca char(7),
		parconvenio  integer,
                                parfecha   date,
                                parreca      smallint,
                                parcaja      char(2),
                                paroperacion  integer,
                                parusuauto  integer,
		parOpcion  smallint
		)
		returning smallint as id,  char(200) as mensaje ;

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
define v_fol_adeudo integer;
define v_fol_histo integer;
define v_controlhisto integer;
define v_importe_pagado  money(12,2);
define v_tarifa  money(12,2);
define v_porcentaje integer;
define varreca smallint ;
define varcaja char(2); 
define varOperacion integer;
define v_placa  varchar(7);
define concepto varchar(80);
define v_nombre varchar(80);
define conc1 varchar(30);
define fecha_pago_bco date;
define vlugar_pago smallint;
  let varok = 0;
  let varobs = '';          

--set debug file to "consiesta.log";
--trace on;

--opcion 1 consulta del disponible.

if (paropcion = 1) or (paropcion = 2)  or (paropcion = 5)  then
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto, zona , espacio ,0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'Condonaci�n de Folio o Error de captura';

end if;
-- pago por folio de recaudadora;
if (paropcion = 3)  then
      select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio ,0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
  if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
    let varok = 1;
     let varobs = 'pago hecho correctamente';

end if;
-- pago por folio de recaudadora cajero;
if (paropcion = 13)  then
     select nvl(num_acuerdo,0) into v_acuerdo from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
--- Cuando hay notificaciones del estado.


    if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
   end if;
       let varok = 1; 
       let varobs = 'pago hecho correctamente';

end if;

if (paropcion = 4)  then

       foreach 
              select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio  from ta14_folios_adeudo  where placa = parplaca
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio , 0);
      let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
    insert into Ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion) values ( varcontrol , parfecha, parreca , parcaja, paroperacion);   
   delete from ta14_folios_adeudo where axo = vaxo and folio = vfolio;
   end foreach;
    let varok = 1;
     let varobs = 'pago hecho por placa correctamente';

end if;


if (paropcion = 6)  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio , 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
                          
                           
else
  if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto <> 6                
	 ) then
                 
        select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
     insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio , 0);
    let varok = 1;
     let varobs = 'pago hecho correctamente';
   else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';
      
end if;
end if;

end if;

if (paropcion = 7 )  then

  if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio
                          
	 ) then
       insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio , 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
             
       delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
    let varok = 1;
     let varobs = 'pago hecho correctamente';
      else                
          let varok = 0;
          let varobs = 'No existe registo para estos datos lectura';                     
                          
end if;

end if;

-- BANORTE

if (paropcion = 10)  then
   let varok = 10;
--select * from ta14_fol_Banorte
Select  a.importe_neto, (b.tarifa + b.costo_fijo01) , ((a.importe_neto  *100 )/ (b.tarifa + b.costo_fijo01) )  , placa , fec_pago
into v_importe_pagado , v_tarifa , v_porcentaje , v_placa , fecha_pago_bco
from ta14_fol_Banorte a, ta14_tarifas b 
where a.axo = paraxo and a.folio = parfolio and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin; 

--se verifica que exista el folio
if v_importe_pagado is NULL then        --si no existe se busca en apremios
   SELECT  z.importe_gastos as tarifa,0.00,100,w.placa,a.fec_pago
      into v_importe_pagado , v_tarifa , v_porcentaje , v_placa , fecha_pago_bco
   FROM  dbestacion:ta_padron w, db_ingresos:ta_15_apremios Z, ta14_fol_Banorte a
   WHERE  
        z.modulo = 14
   AND  z.control_otr = w.id 
   AND  z.clave_practicado = 'P'
   AND  z.fecha_practicado is not null 
   AND  z.vigencia = 1
   AND  a.placa=w.placa and a.axo=year(z.fecha_emision) and a.folio=z.folio
   AND  a.axo = paraxo and a.folio = parfolio;
end if;


  --  Verificar si existe folio en adeudos o historicos 
     select count(folio) into v_fol_adeudo from ta14_folios_adeudo where axo = paraxo and folio = parfolio ;
     select count(folio) into v_fol_histo from ta14_folios_histo where axo = paraxo and folio = parfolio and codigo_movto <> 1 ;
   if  v_fol_adeudo = 0  and v_fol_histo = 0 then 
    
       -- insertar en recibos de ingresos
       select id_rec , caja ,lugar_pago into varreca , varcaja , vlugar_pago
       from db_ingresos:ta12_operacKiosco where id_usuario = 553; 


	select nvl(operacion,0) + 1 into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and caja=varCaja and id_usuario=553;


    let concepto = 'Folio AD/Banorte: ' || paraxo || ' - ' || parfolio || '  Placa: ' || v_placa ;	
    let v_nombre = 'Folio de estacionometros placa : ' || v_placa;	
   insert into db_ingresos:ta_12_recibos
  (fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, nombre, concepto, id_usuario, fecha_act,
        kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
 values( today, varreca, varCaja, varOperacion, v_importe_pagado, 'P' , 14, concepto,  v_nombre , 553, current, 
        v_placa , 1, vlugar_pago, fecha_pago_bco );


	update	db_ingresos:ta12_operacKiosco set operacion=varOperacion
		where id_rec=varreca and caja=varCaja and id_usuario=553;
	
   let conc1 = 'Folio '  || paraxo || ' - ' || parfolio;
 if paraxo < year(today) then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1 , 510930000,  v_importe_pagado);
 else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1 , 510900000,  v_importe_pagado);
 end if;
       --  fin recibos 
     insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,14,1929,'',fec_pago, 727, paropcion,
        parusuauto , 99 , 999 ,0
        from ta14_fol_Banorte 
       where axo = paraxo and folio = parfolio;
     LET v_controlhisto = dbinfo("sqlca.sqlerrd1");
 
     insert into  ta14_folios_hco (control ,  importe_infraccion ,    porcentaje ,    importe_cobrado)
                 values ( v_controlhisto, v_tarifa, 0 , v_importe_pagado);
     update ta14_fol_Banorte set fecha_afectacion = today ,
     fec_caja = today , operacion = varoperacion , caja_ingre = varcaja, reca = varreca,
       usu_carga = parusuauto , 
        status_mpio = 9 
       where axo = paraxo and folio = parfolio ;

      let varobs = 'pago hecho por alta de banorte';
      let varok = 0;
   end if;
  if v_fol_adeudo = 1 then 
   if exists(select folio from ta14_folios_adeudo  where axo = paraxo and folio = parfolio 
 	 ) then
        select placa into vplaca from ta14_folios_adeudo     where axo = paraxo and folio = parfolio ;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
    if ban_placa = vplaca then
         -- insertar en recibos de ingresos
       select id_rec , caja ,lugar_pago into varreca , varcaja , vlugar_pago
       from db_ingresos:ta12_operacKiosco where id_usuario = 553; 


	select nvl(operacion,0) + 1 into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and caja=varCaja and id_usuario=553;


    let concepto = 'Folio: ' || paraxo || ' - ' || parfolio || ' Placa : ' || v_placa;	
    let v_nombre = 'Folio de estacionometros placa : ' || v_placa;	
   insert into db_ingresos:ta_12_recibos
  (fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, nombre, concepto, id_usuario, fecha_act,
        kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
 values( today, varreca, varCaja, varOperacion, v_importe_pagado, 'P' , 14, concepto,  v_nombre , 553, current, 
        v_placa , 1, vlugar_pago, fecha_pago_bco );


	update	db_ingresos:ta12_operacKiosco set operacion=varOperacion
		where id_rec=varreca and caja=varCaja and id_usuario=553;
	
  let conc1 = 'Folio '  || paraxo || ' - ' || parfolio;
 if paraxo < year(today) then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510930000,  v_importe_pagado);
 else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510900000,  v_importe_pagado);
 end if;
       --  fin recibos 
      insert into ta14_folios_histo       
     select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio , 0 from ta14_folios_adeudo 
     where axo = paraxo and folio = parfolio;
     LET v_controlhisto = dbinfo("sqlca.sqlerrd1");
     insert into  ta14_folios_hco (control ,  importe_infraccion ,    porcentaje ,    importe_cobrado)
                 values ( v_controlhisto, v_tarifa, 0 , v_importe_pagado);      
      delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
      update ta14_fol_Banorte set fecha_afectacion = today ,
       fec_caja = today , operacion = varoperacion , caja_ingre = varcaja, reca = varreca,
      usu_carga = parusuauto , 
      status_mpio = 0 
     where axo = paraxo and folio = parfolio ;

     let varobs = 'pago hecho correctamente';
    let varok = 0;
  else
    
      -- insertar en recibos de ingresos
       select id_rec , caja ,lugar_pago into varreca , varcaja , vlugar_pago
       from db_ingresos:ta12_operacKiosco where id_usuario = 553; 


	select nvl(operacion,0) + 1 into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and caja=varCaja and id_usuario=553;


    let concepto = 'Folio: ' || paraxo || ' - ' || parfolio  || ' Placa : ' || v_placa;	
    let v_nombre = 'Folio de estacionometros placa : ' || v_placa;	
   insert into db_ingresos:ta_12_recibos
  (fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, nombre, concepto, id_usuario, fecha_act,
        kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
 values( today, varreca, varCaja, varOperacion, v_importe_pagado, 'P' , 14, concepto,  v_nombre , 553, current, 
        v_placa , 1, vlugar_pago, fecha_pago_bco );

	update	db_ingresos:ta12_operacKiosco set operacion=varOperacion
		where id_rec=varreca and caja=varCaja and id_usuario=553;
  let conc1 = 'Folio '  || paraxo || ' - ' || parfolio;	

 if paraxo < year(today) then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510930000,  v_importe_pagado);
 else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510900000,  v_importe_pagado);
 end if;
       --  fin recibos 

      insert into ta14_folios_histo       
       select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio ,0  from ta14_folios_adeudo 
       where axo = paraxo and folio = parfolio ;
       LET v_controlhisto = dbinfo("sqlca.sqlerrd1");
       insert into  ta14_folios_hco (control ,  importe_infraccion ,    porcentaje ,    importe_cobrado)
                            values ( v_controlhisto, v_tarifa, 0 , v_importe_pagado);      
      delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;  
      update ta14_fol_Banorte set fecha_afectacion = today ,
               placa_cambio = ban_placa,
               placa = vplaca,
               fec_caja = today , operacion = varoperacion , caja_ingre = varcaja, reca = varreca,
              usu_carga = parusuauto , 
              status_mpio = 4 
      where axo = paraxo and folio = parfolio ;
     let varok = 0;
   end if;

  end if;
 end if;
 if (v_fol_adeudo =  0 and v_fol_histo >= 1) then

   if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto = 10             
	 ) then

        select placa into vplaca from ta14_folios_histo     where axo = paraxo and folio = parfolio and codigo_movto = 10;
        select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
      if ban_placa = vplaca then          
         update ta14_fol_Banorte set fecha_afectacion = today ,
         usu_carga = parusuauto , 
         status_mpio = 10 
         where axo = paraxo and folio = parfolio ;
         let varobs = 'Pago cargado con anterioridad';
         let varok = 0;
      else
         update ta14_fol_Banorte set fecha_afectacion = today ,
               placa_cambio = ban_placa,
               placa = vplaca,
               usu_carga = parusuauto ,
               status_mpio = 6 
               where axo = paraxo and folio = parfolio ;
          let varobs = 'Folio no coincide la placa';
         let varok = 0;
      end if;                   
   end if;      
end if;                   
   if varok <> 1 then
    if exists(select folio from ta14_folios_histo   where axo = paraxo and folio = parfolio and codigo_movto not in ( 10,1)            
	 ) then
          select placa into vplaca from ta14_folios_histo     where axo = paraxo and folio = parfolio and codigo_movto not in ( 10,1) ;
          select placa into ban_placa from ta14_fol_banorte  where axo = paraxo and folio = parfolio ;
         if ban_placa = vplaca then          
             select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
              -- insertar en recibos de ingresos
       select id_rec , caja  ,lugar_pago into varreca , varcaja , vlugar_pago
       from db_ingresos:ta12_operacKiosco where id_usuario = 553; 


	select nvl(operacion,0) + 1 into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and caja=varCaja and id_usuario=553;


    let concepto = 'Folio PD: ' || paraxo || ' - ' || parfolio || ' Placa : ' || v_placa;	
    let v_nombre = 'Banorte Folio de estacionometros placa : ' || v_placa;	
   insert into db_ingresos:ta_12_recibos
  (fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, nombre, concepto, id_usuario, fecha_act,
        kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
     values( today, varreca, varCaja, varOperacion, v_importe_pagado, 'P' , 14, concepto,  v_nombre , 553, current, 
        vplaca , 1, vlugar_pago, fecha_pago_bco );

	update	db_ingresos:ta12_operacKiosco set operacion=varOperacion
		where id_rec=varreca and caja=varCaja and id_usuario=553;
	
  let conc1 = 'Folio '  || paraxo || ' - ' || parfolio;
 if paraxo < year(today) then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510930000,  v_importe_pagado);
 else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510900000,  v_importe_pagado);
 end if;
       --  fin recibos   
          insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio , 0);
             LET v_controlhisto = dbinfo("sqlca.sqlerrd1");
              insert into  ta14_folios_hco (control ,  importe_infraccion ,    porcentaje ,    importe_cobrado)
                 values ( v_controlhisto, v_tarifa, 0 , v_importe_pagado);    
              update ta14_fol_Banorte set fecha_afectacion = today ,
              fec_caja = parfecha , operacion = varoperacion , caja_ingre = varcaja, reca = varreca,
              usu_carga = parusuauto , 
              status_mpio = 1 
              where axo = paraxo and folio = parfolio ;
              let varobs = 'pago hecho correctamente con pago doble de otro medio';
              let varok = 1;
         else 
            select  axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial , zona , espacio
              into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio from ta14_folios_histo  where axo = paraxo and folio = parfolio ;
                       -- insertar en recibos de ingresos
       select id_rec , caja ,lugar_pago into varreca , varcaja , vlugar_pago
       from db_ingresos:ta12_operacKiosco where id_usuario = 553; 


	select nvl(operacion,0) + 1 into varOperacion 
		from db_ingresos:ta12_operacKiosco
		where 	id_rec=varreca and caja=varCaja and id_usuario=553;


    let concepto = 'Folio dif/placa: ' || paraxo || ' - ' || parfolio || ' Placa : ' || vplaca;	
    let v_nombre = 'Banorte Folio de estacionometros placa : ' || vplaca;	
   insert into db_ingresos:ta_12_recibos
  (fecha, id_rec, caja, operacion, importe, cvepago, id_modulo, nombre, concepto, id_usuario, fecha_act,
        kio_num_terceros , id_rec_cta , lugar_pago, fec_pagobco) 
     values( today, parreca, parCaja, parOperacion, v_importe_pagado, 'P' , 14, concepto,  v_nombre , 553, current, 
        vplaca , 1, vlugar_pago, fecha_pago_bco );

	update	db_ingresos:ta12_operacKiosco set operacion=varOperacion
		where id_rec=varreca and caja=varCaja and id_usuario=553;
	
  let conc1 = 'Folio '  || paraxo || ' - ' || parfolio;
 if paraxo < year(today) then
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510930000,  v_importe_pagado);
 else
   insert into db_ingresos:ta_12_recibosdet values(today ,varreca , varcaja ,  varoperacion , 1 , conc1, 510900000,  v_importe_pagado);
 end if;
       --  fin recibos   

           insert into ta14_folios_histo   values ( 0,today,    vaxo, vfolio, vfecha, vplaca, vinfra , vestado, vvig ,vacuerdo, vfeccap, vusuini, paropcion, parusuauto, vzona , vespacio ,0);
             LET v_controlhisto = dbinfo("sqlca.sqlerrd1");
              insert into  ta14_folios_hco (control ,  importe_infraccion ,    porcentaje ,    importe_cobrado)
                 values ( v_controlhisto, v_tarifa, 0 , v_importe_pagado);    
              update ta14_fol_Banorte set fecha_afectacion = today ,
               placa_cambio = ban_placa,
               placa = vplaca,
               usu_carga = parusuauto , 
               status_mpio = 5 
               where axo = paraxo and folio = parfolio ;
               let varobs = 'Folio no coincide la placa';
               let varok = 1;
          end if;
   end if;



end if;

end if;




return varok, varobs;
--trace off;



end procedure
;

create procedure "informix".sp14_listados(prec int, pfol1 int, pfol2 int)
returning int as foliocarta,
          char(7) as cuenta,
          date as fecemi,
          date as fecejec,
          date as fecprac,
          varchar(15) as estado,
          varchar(30) as datospago,
          money(18,2) as importe,
          int as dias,
          int as cveejecutor,
          varchar(100) as ejecutor,
          varchar(20) as trimestre,
          int as recaud,
          money(18,2) as adeudo,
          money(18,2) as recargos,
          money(18,2) as gastos,
          money(18,2) as multa,
          money(18,2) as actualizacion,
          money(18,2) as total,
          varchar(250) as obs,
          date as fecha_pago;

define v_folio, v_cveejecutor, v_recaud, v_dias int;
define v_cuenta char(7);
define v_fecemi, v_fecejec, v_fecprac, v_fecha_pago date;
define v_importe, v_adeudo, v_recargos, v_gastos, v_multa, v_actuallizacion, v_total money(18,2);
define v_obs varchar(250);
define v_estado varchar(15);
define v_ejecutor varchar(100);
define v_trimestre varchar(20);
define v_datospago varchar(30);

foreach
  select a.foliocarta, b.placa, a.fecemi, a.fecejec, a.fecprac, (a.fecha_pago||' - '||a.recaudadora||' - '||a.caja||' - '||a.operacion)
  ,(select importe from db_ingresos:ta_12_recibos where fecha=a.fecha_pago and id_rec=a.recaudadora and caja=a.caja and operacion=a.operacion)
  , (a.fecha_pago - a.fecprac), a.cveejecutor
  ,(select nombre from db_ingresos:ta_15_ejecutores where cve_eje=a.cveejecutor and id_rec=a.recaud),(' '),
   CASE
      WHEN a.vigencia = 'V' THEN "VIGENTE" 
      WHEN a.vigencia = 'P' THEN "PAGADO"
      ELSE "CANCELADO"
   END, a.recaud, a.impuesto, a.recargos, a.gastos, a.multas, a.actualizacion, a.total, a.obs, a.fecha_pago
  into v_folio, v_cuenta, v_fecemi, v_fecejec, v_fecprac, v_datospago, v_importe, v_dias, v_cveejecutor, v_ejecutor, v_trimestre, v_estado,
       v_recaud, v_adeudo, v_recargos, v_gastos, v_multa, v_actuallizacion, v_total, v_obs, v_fecha_pago
  from db_ingresos:ta_15_cartainvitacion a, ta_padron b 
  where a.modulo=14 and a.recaud=prec and (a.foliocarta between pfol1 and pfol2) 
  and b.id=a.id_modulo 
  order by a.cveejecutor,  a.foliocarta

  return v_folio, v_cuenta, v_fecemi, v_fecejec, v_fecprac, v_estado, v_datospago, v_importe, v_dias, v_cveejecutor, v_ejecutor, v_trimestre,
         v_recaud, v_adeudo, v_recargos, v_gastos, v_multa, v_actuallizacion, v_total, v_obs, v_fecha_pago with resume;

end foreach;

end procedure;

CREATE PROCEDURE "informix".sp_cons_estacio_all ( as_placa varchar(07) ) 

Returning  varchar(20), varchar(07), integer, integer, date, integer, integer, decimal(18,2), integer, varchar(20), integer, varchar(20), integer, integer, varchar(02), varchar(20), integer, integer, varchar(20) ;

Define	ls_tipo 		varchar(20);
Define	ls_placa 		varchar(07);
Define	li_axo 		integer;
Define	li_folio 		integer;
Define	ld_fecha_folio	date;
Define	li_estado		integer;
Define	li_infraccion	integer;
Define	ldec_tarifa 	decimal(18,2);
Define	li_porc_cobro	integer;
Define	ls_descripcion	varchar(20);
Define	li_usuario_inicial	integer;
Define	ls_folionot		varchar(20);
Define	li_num_acuerdo	integer;
Define	li_costo_fijo	integer;
Define	ls_tipo_infraccion	varchar(20);
Define	ls_afec		varchar(20);
Define	li_zona		integer;
Define	li_espacio		integer;
Define	ls_fecha_baja	varchar(20);


Create	temp table t_paso   ( tipo varchar(20), placa varchar(07), axo integer, folio integer, fecha_folio date, estado integer, infraccion integer, tarifa decimal(18,2), porc_cobro integer, descripcion varchar(20), 
			usuario_inicial integer, folionot varchar(20), num_acuerdo integer, costo_fijo integer, tipo_infraccion varchar(02), afec varchar(20), zona integer, espacio integer, fecha_baja  varchar(20) ) with no log;

-- Inserta Adeudos
Insert	Into  t_paso  
Select	'Adeudo' as tipo, a.placa, 
        	a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, 
        	NVL(f.porc_cobro, 100) as porcentaje, "Vigente" descripcion,
	a.usu_inicial, n.folionot as folionot, NVL(a.num_acuerdo,0) num_acuerdo, b.costo_fijo01, 
	CASE 
	       WHEN a.infraccion = 1 THEN 'B'
	       WHEN a.infraccion = 2 THEN 'B'
	       WHEN a.infraccion = 3 THEN 'B'
	       WHEN a.infraccion = 10 THEN 'A'
	ELSE   'C'
	END as tipo,
        	"" as afec, 0 as zona, 9 as espacio,
	"" as fechas_baja
From	dbestacion:ta14_folios_adeudo a,
	dbestacion:ta14_tarifas b,
	outer( dbestacion:ta14_folios_free f, dbestacion:ta14_notifica_edo n)
Where 	placa = as_placa
And	a.infraccion = b.num_clave 
And	a.fecha_folio between b.fecha_inicial and b.fecha_fin
And	a.axo = f.axo 
And	a.folio	= f.folio
And	f.clave = "A"
And	f.fecha_limite >= today 
And	a.num_acuerdo = n.num_acuerdo 
And	n.num_acuerdo is not NULL ;


-- Inserta Requerimientos 
-- Apremios
Insert	Into t_paso 
Select	'Apremios' as tipo, w.placa, 
        	year(z.fecha_emision) as axo, z.folio, z.fecha_emision as fecha_folio, 0 estado, 0 infraccion, z.importe_gastos as tarifa,
        	100 as porcentaje, "Notificaci�n" as descripcion, 
        	0 as usu_inicial, "" as folionot, 0 as num_acuerdo, 0 as costo_fijo01, 
        	"" as tipo, 
        	"" as afec, 0 as zona, 9 as espacio,
	"" as fechas_baja
From    	dbestacion:ta_padron w, db_ingresos:ta_15_apremios Z
Where	w.placa = as_placa
And	z.modulo = 14
And	z.control_otr = w.id 
And	z.clave_practicado = "P"
And     	z.fecha_practicado is not null 
And	z.vigencia = 1 ;



-- Inserta Curso Vial
Insert	Into t_paso 
Select  	'Curso' as tipo, cc.placa, 
        	year(cc.fecha_registro) as axo, cvecursomov as folio_Req, cc.fecha_registro, 0 as estado, 0 as infraccion, t.tarifa,
        	100 as porcentaje, "Curso de Educacion Vial",
        	99999, " " as folionot, 0 as num_acuerdo, t.costo_fijo01, 
        	' ' as tipo, 
        	"" as afec, 0 as zona, 0 as espacio,
        	"" as fechas_baja
From    	dbestacion:ta14_cursosmov cc inner join dbestacion:ta14_tarifas t on t.num_clave = 99 
And	year(t.fecha_inicial) = year(cc.fecha_registro)
Where   	cc.placa = as_placa
And	estatus = "V"
And	cvepago < 0  ;


-- Inserta Pagos
Insert	Into t_paso 
Select  	'Pagado' as tipo, h.placa, 
        	h.axo as axo, h.folio, r.fecha as fechapago, 
        	0 as estado, 0 as infraccion, 0 as tarifa,
        	0 as porcentaje, "Pago de Estacionometro",
        	0, " " as folionot, 0 as num_acuerdo, 0 as costo_fijo01, 
        	' ' as tipo, 
        	"" as afec, 0 as zona, 0 as espacio,
        	"" as fechas_baja
From    	db_ingresos:ta_12_recibos r, dbestacion:ta14_refrecibo re,
        	dbestacion:ta14_folios_histo h
Where   	h.placa = as_placa
And     	r.id_rec = re.reca
And     	r.caja = re.caja
And     	r.operacion = re.operacion
And     	r.fecha = re.fecha_recibo
And     	r.id_modulo = 14
And     	r.cvepago = "P"
And     	re.control = h.control ;


FOREACH

Select	tipo, placa, axo, folio, fecha_folio, estado, infraccion, tarifa, porc_cobro, descripcion, usuario_inicial, folionot, num_acuerdo, costo_fijo, tipo_infraccion, afec, zona, espacio, fecha_baja
Into	ls_tipo, ls_placa, li_axo, li_folio, ld_fecha_folio, li_estado, li_infraccion, ldec_tarifa, li_porc_cobro, ls_descripcion, li_usuario_inicial, ls_folionot, li_num_acuerdo, li_costo_fijo, ls_tipo_infraccion, ls_afec, li_zona, li_espacio, ls_fecha_baja
From 	t_paso

Return	ls_tipo, ls_placa, li_axo, li_folio, ld_fecha_folio, li_estado, li_infraccion, ldec_tarifa, li_porc_cobro, ls_descripcion, li_usuario_inicial, ls_folionot, li_num_acuerdo, li_costo_fijo, ls_tipo_infraccion, ls_afec, li_zona, li_espacio, ls_fecha_baja  With Resume;

END FOREACH

Drop table  t_paso ;

End procedure
;

CREATE PROCEDURE "informix".sp_14_mod_dscto_esp ( ai_axo integer, ai_folio integer, ai_porc_cobro integer, as_obs varchar(100) )

Returning  integer, varchar(50) ;

-- Procedimiento para Afectacion de Descuentos especiales en Estacionometros, Teniendo o No un descuento Previo 
-- Fecha 05-nov-2020
-- Recibe:  a�o, folio, porcentaje a de descuento del importe, observaciones 
-- Envia:    si estuvo correcto el movimiento (numerico), descripcion (varchar(50) )

Define	ls_tipo 		varchar(20);
Define	ls_placa 		varchar(07);
Define	li_axo 		integer;
Define	li_folio 		integer;
Define	ld_fecha_limite 	date;
Define	li_porc_cobro	integer;
Define	ls_obs 		varchar(100);
Define	li_usuario 		integer;
Define	ld_fechahoy	date;
Define	li_existe		integer;
Define	li_existef		integer;
Define	li_porc		integer;

Let	li_axo = ai_axo;
Let	li_folio = ai_folio ;
Let	li_porc_cobro = ai_porc_cobro ;
let	ls_obs = as_obs ;
Let	li_existef = 0 ;
Let	li_existe = 0 ;
Let	ld_fechahoy = Date(current);
Let	ld_fecha_limite = date("30/12/2020") ;  
Let	li_usuario = 9999 ;


IF	( li_porc_cobro > 9 and li_porc_cobro < 99 ) THEN
	-- Obtiene lo que se va  a cobrar
	Let	li_porc = 100 - li_porc_cobro ;
ELSE
	Return  -1, "El porcentaje no es Correcto" ;
END IF


-- Valida Adeudo 
Select	Count(*)
Into	li_existe
From	ta14_folios_adeudo 
Where	axo = li_axo
And	folio = li_folio 
And	infraccion <> 5 ;
IF	li_existe > 0 Then
	-- Existe el Adeudo
	
	Select	Count(*)
	Into	li_existef
	From	ta14_folios_free  
	Where	axo = li_axo
	And	folio = li_folio 
	And	clave = "A" ;
	IF	li_existef > 0  THEN
		-- Actualiza el Descuento
		Update	ta14_folios_free
		Set	porc_cobro = li_porc_cobro,
			obs = ls_obs,
			fecha_limite = ld_fecha_limite,
			fec_cap = ld_fechahoy
		Where 	axo = li_axo And folio = li_folio ;
	ELIF	li_existef = 0 THEN
		-- Inserta el Descuento Especial 	
		Insert  Into  ta14_folios_free  (axo, folio, fecha_otorga, fecha_limite, porc_cobro, clave, obs, fec_cap, usu_inicial ) 
		Values ( li_axo, li_folio, ld_fechahoy, ld_fecha_limite, li_porc, 'A', ls_obs, ld_fechahoy, li_usuario ) ;
	END IF
ELSE
	Return  -1, "No existe el A�o y Folio del Estacionometro" ;
END IF

RETURN 0, "Se afecto correctamente el descuento especial" ;

End procedure
;

CREATE FUNCTION "informix".fcn_inpc_x_mes ( ai_periodoinicial integer  )  

-- Funcion Recibe periodo inicial, periodo final.
-- Devuelve el porcentaje de INPC Calculado .
--24 nov 2020

Returning  decimal (15,11) ;
 
Define 	li_periodoinicial	integer; 
Define	li_axo		integer;
Define	li_mes		integer;
Define	ldec_indiceinicial	decimal(15,11);
Define	ldec_indicefinal	decimal(15,11);
Define	ldec_indicetot 	decimal(18,06);
--
Let	li_periodoinicial = ai_periodoinicial ;
Let	ldec_indiceinicial = 0;
Let	ldec_indicefinal = 0;
Let	ldec_indicetot = 0;
Let	li_axo	= 0;
Let	li_mes = 0;

-- obtiene indice del periodo 
--	se toma como base la tasa de 2019-01
If	(li_periodoinicial < 201901) Then
	Select  indice 
	Into	ldec_indiceinicial
	From    catastro_gdl:c_inpc 
	Where   (axo * 100) + mes = 201901 ;
	If	ldec_indiceinicial is Null THEN
		Let ldec_indiceinicial = 0;
	End If
Else	
	-- se toma el periodo mayor a 201901 
	Select  indice 
	Into	ldec_indiceinicial
	From    catastro_gdl:c_inpc 
	Where   (axo * 100) + mes = li_periodoinicial ;
	If	ldec_indiceinicial is Null  THEN
		Let ldec_indiceinicial = 0;
	End If
End If		 

-- se obtiene indice final 
Select  indice   
Into	ldec_indicefinal
From    catastro_gdl:c_inpc 
Where   (axo * 100) + mes  = year(today) || month(today)-1 ; 
If	ldec_indicefinal is Null  THEN
	Let ldec_indicefinal = 0;
End If


If	( ldec_indiceinicial > 0 and ldec_indicefinal > 0 ) Then
	let	ldec_indicetot = ldec_indiceinicial / ldec_indicefinal ;
Else

	If 	ldec_indicefinal = 0 Then	
		-- Si no se encontro el ultimo periodo correspondiente, toma el ultimo en el archivo 
		ForEach 
			Select  axo, mes, indice
			Into	li_axo, li_mes, ldec_indicefinal
			From    catastro_gdl:c_inpc 
			Order 	by 1, 2  
		End Foreach		
	End If
	
	If	ldec_indiceinicial = 0 Then
		Let 	ldec_indicetot = 0;
	Else
		Let	ldec_indicetot = ldec_indiceinicial /  ldec_indicefinal ;
	End If

End If
 
Return	ldec_indicetot ;

End function
;

CREATE PROCEDURE "informix".admin_adeudos_detalle_19odoo_beto ( p_opc int , pnumesta int, p_axof int , p_mesf int  )
returning
-- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
int as rubro,
int as concepto,
int as cta,
varchar(30) as referencia,
varChar(120) as descripcion,
decimal(12,2) as monto,
decimal(12,2) as acumulado;

define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
define p_pubid int;
define v_porc_recgos int;
define v_descto_recgos money(15,2);
define v_fec_ini_cobra_rgos date;
define v_pubcategoria_id int; -- adicionado por Gil para generar registro por categoria de estacionamiento
define v_actualizacion decimal(18,2);

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018

begin
    on exception in (-958)
delete from tmp_publicos;
    end exception;
    create temp table tmp_publicos( orden  smallint,id_pub  int ,axo int,mes int,imp_pagar  money(12,2) ,cta_aplicacion int ) with no log;
end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

--select *  from pubmain where numesta = 1320;
select 	pubcategoria_id 
into 	v_pubcategoria_id 
from 	pubmain 
where 	numesta = pnumesta;

select 	id , fecha_inicial + 6 
into 	p_pubid , v_fec_ini_cobra_rgos 
from 	pubmain 
where 	numesta = pnumesta;

select 	fecha_descuento 
into 	v_fecha_limite 
from 	db_ingresos:ta_11_fecha_desc 
where 	mes = mesvig;
if 	v_fecha_limite > today then
	let mesvig = mesvig -1;
end if;

let per_recgos =  (axovig *100 )+mesvig;

if 	p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

let 	perio = (axovig *100 )+mesvig;
let 	v_otros = 0;
let 	v_acumulado  = 0;

-- Inicia Foreach 
FOREACH
	select 	b.cuentaapl, b.tipo , a.axo , a.mes , a.concepto ,  a.ade_importe
	into 	v_cuentaapl , v_tipochar, v_axo , v_mes , v_concepto , v_adeudo
	from 	pubadeudo a, pubtipoadeudo b
	where 	pubmain_id = p_pubid  
	and  	(axo * 100 + mes) <= perio
	and 	a.tipo <> 10 
	and 	a.tipo = b.tipo_id  
	order 	by a.axo , a.mes

	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
	let v_acumulado = v_acumulado + v_adeudo;
	insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(1, p_pubid, v_axo ,v_mes, v_adeudo,v_cuentaapl);
	return 0 , v_cuentaapl, get_odoo_cta(  v_cuentaapl  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
END FOREACH;


-- Inicia Foreach 
FOREACH -- pubcategoria_id adicionado para saber la categoria
	select 	Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe
	into 	v_axo , v_mes , perioI , v_concepto, v_adeudo
	from 	pubadeudo 
	where 	pubmain_id = p_pubid  
	and  	(axo * 100 + mes) <= perio
	and  	tipo = 10  
	order 	by axo , mes

	-- porcentaje de descuento en recargos
	select 	porcentaje 
	into 	v_porc_recgos 
	from 	pub_descrec
	where 	pubmain_id = p_pubid 
	and 	((v_axo * 100)+v_mes) between
			((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
	let v_descto_recgos = 0;
	if 	v_porc_recgos is null then
		let v_porc_recgos = 0;
	end if;

	select 	sum(porcentaje_mes) 
	into 	v_porcentaje 
	from 	recargos
	where 	(axo * 100 + mes) between  perioI and per_recgos;
	if 	v_porcentaje is null then
		let v_porcentaje = 0;
	end if;

	let v_recargos = (v_porcentaje * v_adeudo ) / 100;
	let v_referencia =  v_axo || '-' || lpad(v_mes,2,'0');
	if 	v_porc_recgos > 0 and v_recargos > 0 then
	-- calcular descuento en recargos.
		let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
	--  let v_recargos =   v_recargos - v_descto_recgos;
	end if;

	--  verificar si es el primera mesualidad para quitar recargos o cobrarles
	if 	(today - v_fec_ini_cobra_rgos ) <= 6 then
		let  v_descto_recgos = 0;
		let  v_recargos =  0;
	end if;

	--  Totales
	if 	v_axo = year(today) then
		let v_cuota = v_cuota + v_adeudo;
		let v_rectot = v_rectot + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;

			-- cuentas 2020 inicio
			if 	v_pubcategoria_id = 1 then --De Primera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000001);
				return 0 , 190000001, get_odoo_cta(  190000001  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	v_pubcategoria_id = 2 then --De Segunda
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000003);
				return 0 , 190000003, get_odoo_cta(  190000003  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	v_pubcategoria_id = 3 then --De Tercera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000005);
				return 0 , 190000005, get_odoo_cta(  190000005  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	v_pubcategoria_id = 4 then --De Cuarta
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000007);
				return 0 , 190000007, get_odoo_cta(  190000007  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 5) or (v_pubcategoria_id = 10) then --Comercial Cerrado
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000009);
				return 0 , 190000009, get_odoo_cta(  190000009  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 6) or (v_pubcategoria_id = 9) then --Comercial Mixto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000011);
				return 0 , 190000011, get_odoo_cta(  190000011  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 7) or (v_pubcategoria_id = 8) then --Comercial Abierto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000013);
				return 0 , 190000013, get_odoo_cta(  190000013  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			--if (v_pubcategoria_id = 0) or (v_pubcategoria_id = 0) then --Moto Puerto
			-- insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000015);
			-- return 0 , 190000015, get_odoo_cta(  190000015  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			--end if;
		-- cuentas 2020 termina
		end if;
		
		if 	v_recargos > 0 then
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
			return 0 ,390600000, get_odoo_cta(  390600000  ,19 ), v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
			let v_acumulado = v_acumulado + v_actualizacion;
			let v_concepto1 = 'Actualizaci�n ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  
			values(2, p_pubid, v_axo ,v_mes, v_actualizacion, 459111);
			return 0 ,459111, 459111, v_referencia , v_concepto1, v_actualizacion, v_acumulado  with resume;
			-- termina codigo nuevo inpc
			
		end if;
		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  
			values(2, p_pubid, v_axo ,v_mes, v_descto_recgos, 390640000);
			return 0 , 390640000, get_odoo_cta(  390640000  ,19 ), v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
		
	else
		let v_cuota_r = v_cuota_r + v_adeudo;
		let v_rectot_r = v_rectot_r + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;

			-- cuentas 2020 inicio
			if 	v_pubcategoria_id = 1 then --De Primera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000002);
				return 0 , 190000002, get_odoo_cta(  190000002  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			if 	v_pubcategoria_id = 2 then --De Segunda
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000004);
				return 0 , 190000004, get_odoo_cta(  190000004  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			if 	v_pubcategoria_id = 3 then --De Tercera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000006);
				return 0 , 190000006, get_odoo_cta(  190000006  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			if 	v_pubcategoria_id = 4 then --De Cuarta
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000008);
				return 0 , 190000008, get_odoo_cta(  190000008  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 5) or (v_pubcategoria_id = 10) then --Comercial Cerrado
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000010);
				return 0 , 190000010, get_odoo_cta(  190000010  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 6) or (v_pubcategoria_id = 9) then --Comercial Mixto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000012);
				return 0 , 190000012, get_odoo_cta(  190000012  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 7) or (v_pubcategoria_id = 8) then --Comercial Abierto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000014);
				return 0 , 190000014, get_odoo_cta(  190000014  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			--if (v_pubcategoria_id = 0) or (v_pubcategoria_id = 0) then --Moto Puerto
			-- insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000016);
			-- return 0 , 190000016, get_odoo_cta(  190000016  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			--end if;
			-- cuentas 2020 termina
		end if;
		
		if 	v_recargos > 0 then
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
			return 0  , 390600000, get_odoo_cta(  390600000  ,19 ), v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
			let v_acumulado = v_acumulado + v_actualizacion;
			let v_concepto1 = 'Actualizaci�n ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  
			values(2, p_pubid, v_axo ,v_mes, v_actualizacion, 459111);
			return 0 ,459111, 459111, v_referencia , v_concepto1, v_actualizacion, v_acumulado  with resume;
			-- termina codigo nuevo inpc


		end if;

		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_descto_recgos, 390640000);
			return 0 , 390640000, get_odoo_cta(  390640000  ,19 ), v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
		
	End if;
	
END FOREACH;

end procedure
;

CREATE FUNCTION "informix".admin_adeudos_detalle_23odoo_beto  ( p_opc int , pnumesta int, p_axof int , p_mesf int  )
returning
-- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
int as rubro,
int as concepto,
int as cta,
varchar(30) as referencia,
varChar(120) as descripcion,
decimal(12,2) as monto,
decimal(12,2) as acumulado;
 
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
define p_pubid int;
define agrupar char(6);
define v_tipo int;
define no_recargos int;
define v_porc_recgos decimal(5,2);define v_descto_recgos money(15,2);
define v_actualizacion decimal(18,2);

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019
define v_total_bateria, v_total_cordon decimal(5,2); -- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
define v_cuentaapl_odoo int;
define v_diashabiles int;

Let v_cuentaapl_odoo = 0;
begin
    on exception in (-958)
delete from tmp_exclusivos;
    end exception;
    create temp table tmp_exclusivos(
orden  smallint,
id_exc  int ,
axo int,
mes int,
imp_pagar  money(12,2) ,
cta_aplicacion int,
referencia varchar(30),
concepto   varChar(120)
    ) with no log;
end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--set debug file to 'Exclusivo.log';
--trace on;

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

-- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
select id, total_bateria, total_cordon into p_pubid, v_total_bateria, v_total_cordon from ex_contrato where no_exclusivo = pnumesta;

select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
if 	v_fecha_limite > today then
    let mesvig = mesvig -1;
end if;


--execute procedure db_ingresos:get_diashabiles(MDY(month(today),1,year(today)),today) into v_diashabiles;
--if v_diashabiles <= 5 then
--    let mesvig = mesvig -1;
--end if;

let per_recgos =  (axovig *100 )+ mesvig;

if 	p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
let no_recargos = 0;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;

SELECT 	axo_inicio, mes_inicio 
INTO 	v_axo_inicio, v_mes_inicio  
FROM 	ta_contratos_status 
WHERE 	modulo = 1 
AND 	id = p_pubid; -- 1=Exclusivo, 2=P�blico

if 	v_mes_inicio = 1 then
	Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
	Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;

if 	perio_susp < perio then
	Let perio = perio_susp;
end if;

FOREACH
	select 	b.cuentaapl, b.tipo , a.axo , a.mes ,(axo  * 100 )+ mes ,  a.concepto ,  a.ade_importe
	into 	v_cuentaapl , v_tipochar, v_axo , v_mes , perioi , v_concepto , v_adeudo
	from 	ex_adeudo a, pubtipoadeudo b
	where 	ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
	and 	a.tipo <> 20 and a.tipo = b.tipo_id  
	order 	by a.axo , a.mes
 
	if 	v_cuentaapl = 370700001 then
		let no_recargos = 1;
	end if;
	
	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
	let v_acumulado = v_acumulado + v_adeudo;
    insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto )
    values(1, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl , v_referencia , v_concepto );
	--return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
	if  v_cuentaapl = 370710002 then
		-- calcula recargos de refrendo
        execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes ) into v_recargos;
		-- porcentaje de descuento
        -- calcula recargos de refrendo
        select 	porcentaje 
		into 	v_porc_recgos 
		from 	ex_descrec 
		where 	ex_contrato_id = p_pubid 
		and 	((v_axo * 100)+v_mes) between
        ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
        let v_descto_recgos = 0;
        if 	v_porc_recgos is null then
			let v_porc_recgos = 0;
		end if;
        if 	v_porc_recgos > 0 and v_recargos > 0 then
			-- calcular descuento en recargos.
            let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
		end if;
        if 	v_recargos > 0 then		-- + Actualizacion 
			let v_acumulado = v_acumulado + v_recargos;
            let v_concepto1 = 'Recargos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
			--   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
			let v_acumulado = v_acumulado + v_actualizacion;
            let v_concepto1 = 'Actualizaci�n ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
			
        end if;

		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
            let v_concepto1 = 'Descto Recgos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
			-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
        end if;
	end if;
	
END FOREACH;
--
FOREACH
	select  axo || lpad(mes,2,'0')  , tipo , Axo, mes, (axo  * 100 )+ mes ,concepto, ade_importe
	into 	agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
	from 	ex_adeudo 
	where 	ex_contrato_id = p_pubid 
	and  	tipo = 20 
	and  	(axo * 100 + mes) <= perio
	order 	by 1,3,4

	select 	porcentaje 
	into 	v_porc_recgos 
	from 	ex_descrec
	where 	ex_contrato_id = p_pubid 
	and 	((v_axo * 100)+v_mes) between ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
	let v_descto_recgos = 0;
	if 	v_porc_recgos is null then
		let v_porc_recgos = 0;
	end if;
	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');

	if 	v_tipo = 20 then
		select 	sum(porcentaje_mes) 
		into 	v_porcentaje from recargos
		where 	(axo * 100 + mes) between  perioI and per_recgos;
     
		let v_recargos = (v_porcentaje * v_adeudo ) / 100;
		if 	v_recargos is null then
			let v_recargos = 0;
		end if;
        if 	v_porc_recgos > 0 and v_recargos > 0 then
			-- calcular descuento en recargos.
			let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
			--    let v_recargos =   v_recargos - v_descto_recgos;
		end if;
   
		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
	else
		let v_recargos = 0;
		let v_concepto = v_concepto1 || '  ' || v_adeudo;
	end if;

	--  totales
    if 	v_axo = year(today) then
		if 	(v_total_bateria > 0) and (v_total_cordon > 0) then
			-- actual
			Let v_cuentaapl_odoo = 230000001;
		else
			-- actual
			if 	v_total_cordon > 0 then
				-- cordon
				Let v_cuentaapl_odoo = 230000001;
			else
				-- bateria
				Let v_cuentaapl_odoo = 230000002;
			end if;
		end if;

		let v_cuota = v_cuota + v_adeudo;
		let v_rectot = v_rectot + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto )
			values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            -- values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364100000, v_referencia , v_concepto);
			-- return 0 ,0 , 364100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
		end if;
		if 	no_recargos = 1 then
			let v_recargos = 0;
            let v_descto_recgos = 0;
        end if;
 
		if 	v_recargos > 0 then		-- + Actualizacion
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
     
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
			values(3, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);	
			-- return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
			let v_acumulado = v_acumulado + v_actualizacion;
            let v_concepto1 = 'Actualizaci�n ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(3, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
			
		end if;
		
		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
			-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
    else
		if 	(v_total_bateria > 0) and (v_total_cordon > 0) then
			-- rezago
			Let v_cuentaapl_odoo = 230000003;
		else
			-- rezago
			if 	v_total_cordon > 0 then
				-- cordon
				Let v_cuentaapl_odoo = 230000003;
			else
				-- bateria
				Let v_cuentaapl_odoo = 230000004;
			end if;
		end if;

		let v_cuota_r = v_cuota_r + v_adeudo;
		let v_rectot_r = v_rectot_r + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            -- values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364130000, v_referencia , v_concepto);
			-- return 0 ,0 , 364130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
		end if;
		if 	no_recargos = 1 then
			let v_recargos = 0;
            let v_descto_recgos = 0;
		end if;

		if 	v_recargos > 0 then		-- + Actualizacion
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(3, p_pubid, v_axo ,v_mes, v_recargos, 390700000, v_referencia , v_concepto1);
			-- return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
			let v_acumulado = v_acumulado + v_actualizacion;
            let v_concepto1 = 'Actualizaci�n ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(3, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
			
		end if;
		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1);
			--  return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
	end if;

END FOREACH;

let v_acumulado = 0 ;
FOREACH
	select 	cta_aplicacion , referencia , concepto , imp_pagar
	into 	v_cuentaapl, v_referencia , v_concepto , v_cuota
	from 	tmp_exclusivos 
	order 	by axo , mes, orden

	let v_acumulado = v_acumulado + v_cuota;
	return 0 , v_cuentaapl, get_odoo_cta(  v_cuentaapl  ,23), v_referencia , v_concepto, v_cuota, v_acumulado  with resume;
END FOREACH;

--trace off;
end function
;

CREATE PROCEDURE "informix".cons_pad_pub_19 ( ai_numestadesde integer, ai_numestahasta integer )

Returning
int 		 as ai_numesta,
int 		 as ai_cupo, 
varchar(20)  	 as as_descripcion, 
varchar(100) 	 as as_nombre, 
varchar(13)  	 as as_rfc, 
varchar(100) 	 as as_calle, 
varchar(10) 	 as as_numext, 
varchar(02) 	 as as_sector,
INT 		 as ai_zona, 
INT 		 as ai_subzona, 
INT 		 as ai_axolicencias, 
int 		 as ai_numlicencia, 
varchar(20)  	 as as_telefono, 
DATE		 as ad_fecha_inicial, 
date 		 as ad_fecha_vencimiento,
int		 as ai_concepto,
varchar(100)	as as_referencia,
varchar(100)	as as_descripcionc,
decimal(18,2)	as adec_importe,
decimal(18,2)	as adec_acumulado ;

define		li_numesta 		INTEGER;
define		li_cupo 			INTEGER;
define		ls_descripcion 		varchar(20);
define		ls_nombre 		varchar(100);
define		ls_rfc			varchar(13);
define		ls_calle 			varchar(100);
define		ls_numext 		varchar(10);
define		ls_sector 			varchar(02);
define		li_zona 			integer;
define		li_subzona 		integer;
define		li_axolicencias 		integer;
define		ls_numlicencia 		integer;
define		ls_telefono 		varchar(20);
define		ld_fecha_inicial 		date;
define		ld_fecha_vencimiento 	date;
----
define		li_rubro		integer;
define	 	li_concepto 	integer;
define		li_cta 		integer;
define		ls_referencia 	varchar(100);
define		ls_descripcionc 	varchar(100);
define		ldec_importe 	decimal(18,2);
define		ldec_acumulado 	decimal(18,2);


-- CREA TABLAS TEMPORALES
begin
    on exception in (-958)
delete from tmp_pub ;
    end exception;
    create temp table tmp_pub ( numesta integer, cupo integer, descripcion varchar(100), nombre varchar(100), rfc varchar(13), calle varchar(100), numext varchar(10), sector varchar(02), 
			zona integer, subzona integer, axolicencias integer, numlicencia integer, telefono varchar(20), fecha_inicial date, fecha_vencimiento date ) With no log;
end;

begin
    on exception in (-958)
delete from tmp_pub_det ;
    end exception;
	create temp table tmp_pub_det ( numesta integer, concepto integer, referencia varchar(100), descripcionc varchar(100), importe decimal(18,2), acumulado decimal(18,2) ) With no log;
end;


-- CONSULTA DE ESTACIONAMIENTOS PUBLICOS DIC-2020
FOREACH 

	Select  	p.numesta, p.cupo, ca.descripcion, p.nombre, p.rfc, p.calle, p.numext, p.sector, p.zona, p.subzona, p.axolicencias, p.numlicencia, 
		p.telefono, p.fecha_inicial, p.fecha_vencimiento 
	Into	li_numesta, li_cupo, ls_descripcion, ls_nombre, ls_rfc, ls_calle, ls_numext, ls_sector, li_zona, li_subzona, li_axolicencias, ls_numlicencia, ls_telefono, ld_fecha_inicial, ld_fecha_vencimiento
	From    	dbestacion:pubmain p,
		dbestacion:pubcategoria ca
	Where   	p.pubcategoria_id = ca.categoria 
	And     	ca.tipo = "N" 
	And  	p.numesta between ai_numestadesde and ai_numestahasta 
	Order   	by 1  

	INSERT 	into  tmp_pub ( numesta, cupo, descripcion, nombre, rfc, calle, numext, sector, zona, subzona, axolicencias, numlicencia, telefono, fecha_inicial, fecha_vencimiento ) 
	values ( li_numesta, li_cupo, ls_descripcion, ls_nombre, ls_rfc, ls_calle, ls_numext, ls_sector, li_zona, li_subzona, li_axolicencias, ls_numlicencia, ls_telefono, ld_fecha_inicial, ld_fecha_vencimiento ) ;

	FOREACH
	
		Execute Procedure informix.admin_adeudos_detalle_19odoo ( 2 , li_numesta, 2020, 01 ) Into li_rubro, li_concepto, li_cta, ls_referencia, ls_descripcionc, ldec_importe, ldec_acumulado  

		INSERT into  tmp_pub_det ( numesta, concepto, referencia, descripcionc, importe, acumulado ) 
		values ( li_numesta, li_concepto, ls_referencia, ls_descripcionc, ldec_importe, ldec_acumulado ) ;


	END FOREACH

END FOREACH
  

-- LLENADO DE TABLAS
FOREACH
	 
	SELECT	p.numesta, p.cupo, p.descripcion, p.nombre, p.rfc, p.calle, p.numext, p.sector, p.zona, p.subzona, p.axolicencias, p.numlicencia, p.telefono, p.fecha_inicial, p.fecha_vencimiento, 
		d.concepto, d.referencia, d.descripcionc, d.importe, d.acumulado
	Into	li_numesta, li_cupo, ls_descripcion, ls_nombre, ls_rfc, ls_calle, ls_numext, ls_sector, li_zona, li_subzona, li_axolicencias, ls_numlicencia, ls_telefono, ld_fecha_inicial, ld_fecha_vencimiento, 
		li_concepto, ls_referencia, ls_descripcionc, ldec_importe, ldec_acumulado 
	FROM	tmp_pub p, tmp_pub_det d
	WHERE	p.numesta = d.numesta
	AND	p.numesta BETWEEN ai_numestadesde and ai_numestahasta 
		
	Return	li_numesta, li_cupo, ls_descripcion, ls_nombre, ls_rfc, ls_calle, ls_numext, ls_sector, li_zona, li_subzona, li_axolicencias, ls_numlicencia, ls_telefono, ld_fecha_inicial, ld_fecha_vencimiento, 
		li_concepto, ls_referencia, ls_descripcionc, ldec_importe, ldec_acumulado With Resume ;

END FOREACH

END PROCEDURE
;

CREATE FUNCTION "informix".admin_adeudos_detalle_23odoox( p_opc int , pnumesta int, p_axof int , p_mesf int  )
returning
-- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
int as rubro,
int as concepto,
int as cta,
varchar(30) as referencia,
varChar(120) as descripcion,
decimal(12,2) as monto,
decimal(12,2) as acumulado;
 
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
define p_pubid int;
define agrupar char(6);
define v_tipo int;
define no_recargos int;
define v_porc_recgos decimal(5,2);define v_descto_recgos money(15,2);
define v_actualizacion decimal(18,2);

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019
define v_total_bateria, v_total_cordon decimal(5,2); -- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
define v_cuentaapl_odoo int;
define v_diashabiles int;

Let v_cuentaapl_odoo = 0;
begin
    on exception in (-958)
delete from tmp_exclusivos;
    end exception;
    create temp table tmp_exclusivos(
orden  smallint,
id_exc  int ,
axo int,
mes int,
imp_pagar  money(12,2) ,
cta_aplicacion int,
referencia varchar(30),
concepto   varChar(120)
    ) with no log;
end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--set debug file to 'Exclusivo.log';
--trace on;

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

-- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
select id, total_bateria, total_cordon into p_pubid, v_total_bateria, v_total_cordon from ex_contrato where no_exclusivo = pnumesta;

select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
if 	v_fecha_limite > today then
    let mesvig = mesvig -1;
end if;


--execute procedure db_ingresos:get_diashabiles(MDY(month(today),1,year(today)),today) into v_diashabiles;
--if v_diashabiles <= 5 then
--    let mesvig = mesvig -1;
--end if;

let per_recgos =  (axovig *100 )+ mesvig;

if 	p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
let no_recargos = 0;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;

SELECT 	axo_inicio, mes_inicio 
INTO 	v_axo_inicio, v_mes_inicio  
FROM 	ta_contratos_status 
WHERE 	modulo = 1 
AND 	id = p_pubid; -- 1=Exclusivo, 2=P�blico

if 	v_mes_inicio = 1 then
	Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
	Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;

if 	perio_susp < perio then
	Let perio = perio_susp;
end if;

FOREACH
	select 	b.cuentaapl, b.tipo , a.axo , a.mes ,(axo  * 100 )+ mes ,  a.concepto ,  a.ade_importe
	into 	v_cuentaapl , v_tipochar, v_axo , v_mes , perioi , v_concepto , v_adeudo
	from 	ex_adeudo a, pubtipoadeudo b
	where 	ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
	and 	a.tipo <> 20 and a.tipo = b.tipo_id  
	order 	by a.axo , a.mes
 
	if 	v_cuentaapl = 370700001 then
		let no_recargos = 1;
	end if;
	
	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
	let v_acumulado = v_acumulado + v_adeudo;
    insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto )
    values(1, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl , v_referencia , v_concepto );
	--return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
	if  v_cuentaapl = 370710002 then
		-- calcula recargos de refrendo
        execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes ) into v_recargos;
		-- porcentaje de descuento
        -- calcula recargos de refrendo
        select 	porcentaje 
		into 	v_porc_recgos 
		from 	ex_descrec 
		where 	ex_contrato_id = p_pubid 
		and 	((v_axo * 100)+v_mes) between
        ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
        let v_descto_recgos = 0;
        if 	v_porc_recgos is null then
			let v_porc_recgos = 0;
		end if;
        if 	v_porc_recgos > 0 and v_recargos > 0 then
			-- calcular descuento en recargos.
            let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
		end if;
        if 	v_recargos > 0 then		-- + Actualizacion 
			let v_acumulado = v_acumulado + v_recargos;
            let v_concepto1 = 'Recargos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
			--   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
            if v_actualizacion > 0 then
			let v_acumulado = v_acumulado + v_actualizacion;
            let v_concepto1 = 'Actualizaci�n ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
	    end if;	
        end if;

		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
            let v_concepto1 = 'Descto Recgos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
			-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
        end if;
	end if;
	
END FOREACH;
--
FOREACH
	select  axo || lpad(mes,2,'0')  , tipo , Axo, mes, (axo  * 100 )+ mes ,concepto, ade_importe
	into 	agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
	from 	ex_adeudo 
	where 	ex_contrato_id = p_pubid 
	and  	tipo = 20 
	and  	(axo * 100 + mes) <= perio
	order 	by 1,3,4

	select 	porcentaje 
	into 	v_porc_recgos 
	from 	ex_descrec
	where 	ex_contrato_id = p_pubid 
	and 	((v_axo * 100)+v_mes) between ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
	let v_descto_recgos = 0;
	if 	v_porc_recgos is null then
		let v_porc_recgos = 0;
	end if;
	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');

	if 	v_tipo = 20 then
   	        select 	sum(porcentaje_mes) 
		into 	v_porcentaje from recargos
		where 	(axo * 100 + mes) between  perioI and per_recgos; 
                

		let v_recargos = (v_porcentaje * v_adeudo ) / 100;
		if 	v_recargos is null then
			let v_recargos = 0;
		end if;
                if year(today) = p_axof then
                   if v_axo = year(today) and p_mesf = 12 then
                      let v_recargos = 0;
                   else
                      if today <= v_fecha_limite and v_mes = month(today) then
                         let v_recargos = 0;
                      end if;
                   end if;
                end if;
        if 	v_porc_recgos > 0 and v_recargos > 0 then
			-- calcular descuento en recargos.
			let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
			--    let v_recargos =   v_recargos - v_descto_recgos;
		end if;
   
		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
	else
		let v_recargos = 0;
		let v_concepto = v_concepto1 || '  ' || v_adeudo;
	end if;

	--  totales
    if 	v_axo = year(today) then
		if 	(v_total_bateria > 0) and (v_total_cordon > 0) then
			-- actual
			Let v_cuentaapl_odoo = 230000001;
		else
			-- actual
			if 	v_total_cordon > 0 then
				-- cordon
				Let v_cuentaapl_odoo = 230000001;
			else
				-- bateria
				Let v_cuentaapl_odoo = 230000002;
			end if;
		end if;

		let v_cuota = v_cuota + v_adeudo;
		let v_rectot = v_rectot + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto )
			values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            -- values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364100000, v_referencia , v_concepto);
			-- return 0 ,0 , 364100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
		end if;
		if 	no_recargos = 1 then
			let v_recargos = 0;
            let v_descto_recgos = 0;
        end if;
 
		if 	v_recargos > 0 then		-- + Actualizacion
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
     
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
			values(3, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);	
			-- return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
                 if v_actualizacion > 0 then
			let v_acumulado = v_acumulado + v_actualizacion;
                        let v_concepto1 = 'Actualizaci�n ' || v_concepto;
                        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                        values(3, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
		 end if;
			
		end if;
		
		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto);
			-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
    else
		if 	(v_total_bateria > 0) and (v_total_cordon > 0) then
			-- rezago
			Let v_cuentaapl_odoo = 230000003;
		else
			-- rezago
			if 	v_total_cordon > 0 then
				-- cordon
				Let v_cuentaapl_odoo = 230000003;
			else
				-- bateria
				Let v_cuentaapl_odoo = 230000004;
			end if;
		end if;

		let v_cuota_r = v_cuota_r + v_adeudo;
		let v_rectot_r = v_rectot_r + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            -- values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364130000, v_referencia , v_concepto);
			-- return 0 ,0 , 364130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
		end if;
		if 	no_recargos = 1 then
			let v_recargos = 0;
            let v_descto_recgos = 0;
		end if;

		if 	v_recargos > 0 then		-- + Actualizacion
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(3, p_pubid, v_axo ,v_mes, v_recargos, 390700000, v_referencia , v_concepto1);
			-- return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
                 if v_actualizacion > 0 then
			let v_acumulado = v_acumulado + v_actualizacion;
                        let v_concepto1 = 'Actualizaci�n ' || v_concepto;
                        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                        values(3, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
	         end if;
		end if;
		if 	v_descto_recgos <> 0 then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1);
			--  return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
	end if;

END FOREACH;

let v_acumulado = 0 ;
FOREACH
	select 	cta_aplicacion , referencia , concepto , imp_pagar
	into 	v_cuentaapl, v_referencia , v_concepto , v_cuota
	from 	tmp_exclusivos 
	order 	by axo , mes, orden

	let v_acumulado = v_acumulado + v_cuota;
	return 0 , v_cuentaapl, get_odoo_cta(  v_cuentaapl  ,23), v_referencia , v_concepto, v_cuota, v_acumulado  with resume;
END FOREACH;

--trace off;
end function
;

CREATE FUNCTION "informix".admin_encabezados_16(parPlaca char(7))
 returning
 varchar(92) as Nombre_completo,
 varchar(80) as calle,
 varchar(10) as No_ext,
 varchar(10) as No_int,
 varchar(50) as Colonia,
 varchar(10) as CP,
 varchar(13) as RFC, 
 varchar(50) as Municipio,
 varchar(50) as Estado,
 varchar(18) as CURP,
 lvarchar(500) as descripcion,
 smallint as cartera,
 varchar(100) as mensaje,
 varchar(255) as piepagina,
 int as codigo_mensaje;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define v_nombre varchar(80);
define  v_calle varchar(80); 
define  v_num_ext varchar(8); 



Select sum(folio) 
    into   vfolio  
    from ta14_folios_adeudo where placa = parplaca ;

if (vfolio is null ) or (vfolio = 0) then
return ' ' , ' ' ,' ' ,' ', ' ', ' ', ' ' , ' ' ,' ' , ' ',  ' ', 0 ,'NO HAY FOLIOS PARA ESTA PLACA' , ' ' ,  1;
else
select nombre , domicilio , num_ext 
into v_nombre ,v_calle , v_num_ext
from ta_padron where placa = parplaca;

if v_nombre is null then
    let v_nombre = '';
    let v_calle =  '';
    let v_num_ext =  '';
end if;

-- execute procedure sp_desto35_fol_jul2018( parplaca ,999999);
-- buen fin 2018
-- otorgamiento de descuento general a folios con 'OFICIO D.I. 3197/2019' realizado el 28/06/2019
execute procedure sp_descto_placa_bf( parplaca );
return v_nombre , v_calle  , v_num_ext ,'', '','','' , ' ' ,' ' , '',  ' ', 1 , 'Existen folios para cobrar' , ' ' ,  0;
END IF;

end FUNCTION;

CREATE FUNCTION "informix".odoo_adeudos_detalle_16_banorte ( parPlaca char(7), parref varchar(28))

{######################################################################
#  Procedimiento:    admin_adeudos_detalle_16odoo
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de Folios de estacionometros en el sistema ODOO
#                    con el proposito de afectar los folios pagados por Banorte afectados primero en informix y luego en ODOO
#  Parametros        p_tipo     = numero de placa
#  de entrada:
#
#
#  Parametros        Definidos Abajo.
#  de salida:
#
#  Elaboro:          ivan de la torre
#  Fecha:            27 Marzo 2020
#
#  Llamado por:      Procedimiento
#  Llama a:
#
######################################################################}
returning
int         as NoRubro,
int         as NoConcepto,
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion,
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint;
define  vfolio integer;
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro decimal(7,2);
define vsqlporc_cobro decimal(7,2);
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define vimp_dscto decimal(7,2); -- para descuento clave 4
define  vctaapl integer;
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
define  var_refers bigint;
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define infra_descrip char(40);
define v_contar int;
DEFINE V_AXOFIN INT;
DEFINE V_FOLIOFIN INT;
DEFINE v_trans INT;
DEFINE R_FECHAPAGO DATE ;
DEFINE R_RECA INT;
DEFINE R_CAJA CHAR(2);
DEFINE R_OPERACION INT;
define v_importe_bco money(12,2);
define v_axo int;
define v_lon int;
define v_folio int;
define v_diferencia decimal(7,2);
define vCtaDescuento int;

--
begin
    on exception in (-958)
delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
placa  char(7) ,
axo int,
folio int,
fecha_folio date,
estado smallint,
infraccion smallint,
tarifa  money(12,2),
porc_cobro int,
num_acuerdo int,
imp_pagar  money(12,2) ,
cta_aplicacion integer
    ) with no log;
end;
--set debug file to "detalle8BN.txt";
--trace on;

---la referencia tiene que ser de 28 caracteres de lo contrario no es correcta, pago por internet
   if parref[1,2] <> 'BN' then
    return 0,0,0,'Referencia Banorte Erronea','',0,0;
   end if;

 -- separa axo y folio
  let v_axo  = TO_NUMBER(parref[4,7]);
  let v_lon = length( parref);
  let v_folio = TO_NUMBER(parref[ 9, 16]);
 -- select *  from ta14_fol_Banorte where axo  = 2019 and folio = 4479205
   select count(*)
  into v_contar
   from ta14_fol_Banorte where axo  = v_axo and folio = v_folio and placa = parPlaca;

  if v_contar = 0 then
      return 0,0,0,'No Existe pago en Banorte'  || parref , '' ,0,0;
   end if;
  if v_contar > 1 then
      return 0,0,0,'Reporte a Pagos electronicos, varios pagos para este folio'  || parref , '' ,0,0;
   end if;

let v_Acumulado = 0;

 -- BUSCAR EL PAGO.
 --   SELECT * FROM ta14_refrecibo A , TA14_FOLIOS_HISTO B WHERE B.AXO = 2019 AND B.FOLIO = 4479205 AND A.CONTROL = B.CONTROL
   SELECT FEC_pago , importe_neto
          INTO  R_FECHAPAGO , v_importe_bco
   FROM  ta14_fol_Banorte where axo  = v_axo and folio = v_folio;


foreach
Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0), infra.descripcion
into  vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from  ta14_folios_HISTO a, ta14_tarifas b  ,OUTER ta14_infraccion infra , outer ta14_folios_free f
where a.axo = v_axo and a.folio = v_folio and a.codigo_movto = 10
and a.infraccion = b.num_clave
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and infra.num_clave = a.infraccion
and a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
union all
Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0), infra.descripcion
from  ta14_folios_adeudo a, ta14_tarifas b  ,OUTER ta14_infraccion infra , outer ta14_folios_free f
where a.axo = v_axo and a.folio = v_folio --and a.codigo_movto = 10
and a.infraccion = b.num_clave
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and infra.num_clave = a.infraccion
and a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 3 asc, 1 asc, 2 asc

/*
let fecha_hoy = R_FECHAPAGO;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
if Weekday(vfecha) = 6 then
let dias_cuantos = 1;
end if;
select count(*) into dias_habil
    from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and R_FECHAPAGO;

    while x1 <= fecha_hoy
IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
let dias_cuantos =dias_cuantos+1;
    end if;
let x1 = x1+1;
end while;

let dias_cuantos =  dias_cuantos - dias_habil ;
*/

-- PARTE QUE SUSTITUYE LAS CUENTAS ANTERIORES
if vinfra = 1 then  -- Por no cubrir la tarifa vigente autorizada para hacer uso del espacio de estacionamiento-612086-CLAVE 1
let vctaapl = 160000001;
end if;
if vinfra = 2 then  -- Por estacionar veh�culo invadiendo dos cajones o m�s marcados-612087-CLAVE 2
let vctaapl = 160000002;
end if;
if vinfra = 3 then  -- Por obstruir cochera impidiendo o dificultando el ingreso o salida-612088-CLAVE 3
let vctaapl = 160000003;
end if;
if vinfra = 4 then  -- Por estacionarse en l�nea amarilla-612089-CLAVE 4
let vctaapl = 160000004;
end if;
if vinfra = 5 then  -- "Por estacionarse sin derecho en lugares prohibidos exclusivos areas para de bomberos, polic�a y servicios m�dicos rampas o cajones para discapacitados salidas de emergencia
--  doble fila ciclov�as banquetas camellones andadores peatonales ciclopuertos en sentido contrario lugares prohibidos"-612111-CLAVE 5
let vctaapl = 160000005;
end if;
if vinfra = 6 then  -- Por estacionarse en bater�a cuando �ste sea en cord�n o viceversa-612092-CLAVE 6
let vctaapl = 160000006;
end if;
if vinfra = 7 then  -- Por veh�culo infraccionado e inmovilizado-612094-CLAVE 7
let vctaapl = 160000007;
end if;
if vinfra in (8,11) then  -- Por impedir u obstaculizarse a recibir documentaci�n oficia o negarse a proporcionar los datos, informes, documentos o registros,
-- as� como insultar o amenazar a los mismos-612008-CLAVE 8
let vctaapl = 160000008;
end if;
if vinfra = 10 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
let vctaapl = 160000010;
end if;
if vinfra = 20 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
let vctaapl = 160000010;
end if;
--

let v_diferencia = vtarifa / 2; -- Verificamos si el monto pagado es el 50%

--para calcular el valor de la multa;
--if (vinfra < 5) and (dias_cuantos < 7) then
if v_importe_bco = v_diferencia then
    let vporc_cobro = 50 ;
    let vCtaDescuento = 613901; -- Descuento autom�tico por pagar en los primeros 7 dias
    -- vimp_dscto
else
    let  vporc_cobro = 100;
end if;

if vsqlporc_cobro <> 100 then
    let vporc_cobro = vsqlporc_cobro;
    let vCtaDescuento = 613913; -- Descuento por funcionario p�blico
end if;

if vinfra = 5 then
    let vCtaDescuento = 613914; -- Descuento autom�tico por pagar en los primeros 7 dias
end if;

let vimp_apagar = vporc_cobro / 100 * vtarifa;
let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;
let v_Descripcion = vaxo || '-' || vfolio|| '-' || year(vfecha) ||'/'|| lpad(month(vfecha),2,'0')||'/'||day(vfecha) || ' Cve: ' || vinfra || ' - ' || infra_descrip;
--let v_Acumulado = v_Acumulado + vimp_apagar;

--insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
-- values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
--return 0,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;

if vporc_cobro <> 100 then
    let v_Acumulado = v_Acumulado + vtarifa;
    insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
    return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;

    let vctaapl = 160000104;
    Let vimp_dscto = vtarifa - vimp_apagar;
    Let vimp_dscto = vimp_dscto * -1;
    let v_Acumulado = v_Acumulado + vimp_dscto;
    
    insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, null , null, null, vimp_dscto , vctaapl);
    return 1,vCtaDescuento, vCtaDescuento,v_Referencia,v_Descripcion,vimp_dscto,v_Acumulado with resume;
else
    let v_Acumulado = v_Acumulado + vtarifa;
    
    insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
    return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;
end if;


Let vporc_cobro = 0;
Let vsqlporc_cobro = 0;
end foreach;

--trace off;
end function;

CREATE FUNCTION "pgcabrer".e_parkingcons18_redondeo(parPlaca char(7), parMedio int)
	
returning 
smallint as estatus, 
smallint as axo,  
char(7) as placa,      
int as folio, 
date as fecha,  
smallint as estado, 
Char(40) as infraccion, 
money(7,2) as tarifa, 
smallint as porcentaje,  
money(7,2) as importe,        
int as acuerdo,            
int as ctaaplic,
char(100) as observacion;
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;

define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint; 
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa money(7,2);
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar money(7,2);
define  vctaapl integer;  
define infra_descrip char(40);
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define vFechaCurso date;
define vCostoCurso decimal(7,2);

define v_imptot money(15,2);
define v_ctaaplr integer;
define v_ajuste money(15,2);
let v_imptot=0;

--set debug file to "parkivan.log";
--trace on;
 --execute procedure sp_desto35_fol_jul2018( parplaca ,999998 );
 execute procedure sp_descto_placa_bf ( parplaca );
select   id   into  v_id_padron 
   from ta_padron where placa = parplaca  ;
       if v_id_padron is null  then
              let v_id_padron = 0;
       end if;

if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
    if v_id_padron > 0 then   
       select nvl(sum(importe_gastos),0) into v_gastos 
       from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
            clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
    
       if v_gastos > 0 then 
           foreach 
                select  folio ,  fecha_emision ,  importe_gastos  
        into vN_folio , vN_fecha_emision , v_gastos 
        from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron and  
      clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1  
     return 
       0,year(vN_fecha_emision),parplaca, vN_folio, vN_fecha_emision, 0 , 'Notificaci�?³n', v_gastos ,
       100 , v_gastos , 0 , 550620011 , 'Ok' with resume;
     end foreach;
    end if;
   end if;
if today > mdy(11,14,2018) and today < mdy(12,22,2018) then
   execute procedure sp_descto_placa_bf( parplaca );
end if; 

-- Se inserta renglon en caso tenga un Curso de Movilidad pendiente de pago
        foreach
        select fecha_registro into vFechaCurso
        from ta14_cursosmov 
        where placa = parplaca and estatus = 'V'
            -- Obtenemos el costo del Curso del a�?±o que se otorg�?³
            select (t.tarifa + t.costo_fijo01) into  vCostoCurso
            from ta14_tarifas t
            where year(fecha_inicial) = year(vFechaCurso) 
                and num_clave = 99; 

            if vCostoCurso > 0 then
                -- Insertamos renglones de respuesta para los cursos...
                --let v_Acumulado = v_Acumulado + vCostoCurso ;

                --let  v_Referencia  = year(vFechaCurso) || '-' || lpad(0, 8 ,'0') ;  
                let infra_descrip = year(vFechaCurso) || '-0-' || year(vFechaCurso) ||'/'|| lpad(month(vFechaCurso),2,'0')||'/'||day(vFechaCurso) || ' CURSO TALLER DE EDUCACION VIAL';
                --insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                --    values ( parplaca , year(vFechaCurso), 0, vFechaCurso, 1 , 99, vCostoCurso , 100 , '' , vCostoCurso , '449137');
                

               -- return 0,449137, 449137,v_Referencia,v_Descripcion,vCostoCurso,v_Acumulado with resume;
		return 
		--0,year(vFechaCurso),parplaca, 9999999, vFechaCurso, 14 ,infra_descrip, vCostoCurso , 100 , vCostoCurso , 0 , '449137' , 'Ok'
		0,0,parplaca, 0, vFechaCurso, 14 ,infra_descrip, vCostoCurso , 100 , vCostoCurso , 0 , '449137' , 'Ok'
		with resume;
            end if;
        end foreach;

foreach 

Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, b.tarifa, nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0) 
, infra.descripcion
into 
vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_adeudo a, ta14_tarifas b , ta14_infraccion infra, outer ta14_folios_free f
where a.placa = parplaca and a.infraccion = b.num_clave 
and a.fecha_folio between b.fecha_inicial and b.fecha_fin and infra.num_clave = a.infraccion and
a.axo = f.axo and a.folio = f.folio and f.clave = 'A' 
order by 3 asc

--- para obtener dias de vencimiento;

let fecha_hoy = today;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;

--select count(*) 
--       into dias_habil 
--       from db_ingresos:ta_12_diasinhabil  where fecha between vfecha+1 and today;

--     while x1 <= fecha_hoy 
--        IF (Weekday(x1) > 1) AND (Weekday(x1)< 6) THEN
--          let dias_cuantos =dias_cuantos+1;
--         end if;
--     let x1 = x1+1;
--   end while;


  if fecha_hoy - x2 < 30 then

     while x1 <= fecha_hoy 
       if not exists(select dias_habil from  db_ingresos:ta_12_diasinhabil  where fecha = x1) then
         IF (Weekday(x1) > 0) AND (Weekday(x1)< 6) THEN
               let dias_cuantos =dias_cuantos + 1;
            end if;
         end if;
      let  x1 = x1+1;
    
   end while;
 end if;
    if fecha_hoy - x1 >= 30 then
    let dias_cuantos = 7 ;
    end if;





if year(today) = year(vfecha) then
   let vctaapl = 510900000 ;
else
   let vctaapl = 925100001 ;
end if;

-- 510900000;  -- 46305  A�?±o actual
-- 925100001;  -- 46320   a�?±os anteriores
-- 992100006;      -- 23315  gastos ejecucion sefin.


--para calcular el valor de la multa;
if (vinfra <=4) and (dias_cuantos<=6) then
      let vporc_cobro = 50 ;
   else
     let  vporc_cobro = 100;
end if;
  if vsqlporc_cobro <> 100 then
     let vporc_cobro = vsqlporc_cobro;
  end if;
     let vimp_apagar = vporc_cobro / 100 * vtarifa;
  

let v_imptot = v_imptot + vimp_apagar;

return 
0,vaxo,parplaca, vfolio, vfecha, vestado ,'Clave: '|| vinfra||' - '||infra_descrip, vtarifa , vporc_cobro , vimp_apagar , vacuerdo , vctaapl , 'Ok'
with resume;
end foreach;

execute procedure db_ingresos:spd_redondeokiosco(v_imptot) into v_ctaaplr, v_ajuste; 
	if v_ajuste <> 0 then    
		return 0, 0, parplaca, 0, mdy(01,01,2000)  , 0, 'AJUSTE ARTICULO 14 LEY DE INGRESOS', 0, 100, v_ajuste, 0, v_ctaaplr, 'Ok' with resume;
	--let v_imptot = v_imptot+v_ajuste; 
	end if;

else
--         ok (0= ok , 1.. error)  ,      axo ,    placa ,   folio , fecha, estado,     infra ,     tarifa,     porcentaje de cobro , importe a pagar , acuerdo , cuenta aplicacion , observacion;
return

1,0,parplaca, 0,0,0,'',0,0,0,0,0,'No existen folios para esta placa';
end if;

end FUNCTION;

CREATE FUNCTION "informix".odoo_adeudos_detalle_16_elect ( parPlaca char(7), parref varchar(28))

{######################################################################
#  Procedimiento:    admin_adeudos_detalle_16odoo
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de Folios de estacionometros en el sistema ODOO
#                    con el proposito de afectar los folios pagados por internert afectados primero en informix y luego en ODOO
#  Parametros        p_tipo     = numero de placa
#  de entrada:
#
#
#  Parametros        Definidos Abajo.
#  de salida:
#
#  Elaboro:          ivan de la torre
#  Fecha:            25 Marzo 2020
#
#  Llamado por:      Procedimiento
#  Llama a:
#
######################################################################}
returning
int         as NoRubro,
int         as NoConcepto,
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion,
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint;
define  vfolio integer;
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define vimp_dscto decimal(7,2); -- para descuento clave 4
define  vctaapl integer;
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
define  var_refers bigint;
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define infra_descrip char(40);
define v_contar int;
DEFINE V_AXOFIN INT;
DEFINE V_FOLIOFIN INT;
DEFINE v_trans INT;
DEFINE R_FECHAPAGO DATE ;
DEFINE R_RECA INT;
DEFINE R_CAJA CHAR(2);
DEFINE R_OPERACION INT;
DEFINE VCONTROL INT;
define vFechaCurso date;
define vCostoCurso decimal(7,2);
define vFechaPago date;
define vCtaDescuento int;

--
begin
    on exception in (-958)
delete from tmp_folios;
    end exception;
    create temp table tmp_folios(
placa  char(7) ,
axo int,
folio int,
fecha_folio date,
estado smallint,
infraccion smallint,
tarifa  money(12,2),
porc_cobro int,
num_acuerdo int,
imp_pagar  money(12,2) ,
cta_aplicacion integer
    ) with no log;
end;
set debug file to "detalle8ele.txt";
trace on;

---la referencia tiene que ser de 28 caracteres de lo contrario no es correcta, pago por internet
   if length(parref) <> 28 then
    return 0,0,0,'Linea de Captura Erronea','',0,0;
   end if;

--  VErificar los de tos de la linea de captura.
--   select count(*)  from db_ingresos:linea_capturadiv where linea = '0873540000072843001426128245';
 -- select count(*) into v_contar from db_ingresos:linea_capturadiv where linea = parref;
-- datos de la transaccion
   let v_trans = parref[9,16];
 --select * from  ta14_kio_trans where  placa = 'JRF4491'
 -- select * from  ta14_kio_trans where numtrans = 0072843
   select count(*), max(fecha) into v_contar, vFechaPago 
   from  ta14_kio_trans where numtrans = v_trans and placa = parPlaca;
  if v_contar = 0 then
      return 0,0,0,'Transacion No existe','trx' || v_trans ,0,0;
   end if;
--   Linea: 0873540000072843001426128245
-- datos de la transaccion
  -- let v_trans = parref[9,16];
 --select * from  ta14_kio_trans where  placa = 'JRF4491'
   select AXOFIN , FOLIOFIN INTO V_AXOFIN , V_FOLIOFIN
   from  ta14_kio_trans where numtrans = v_trans ;
let v_Acumulado = 0;
let R_OPERACION = 0;
let R_FECHAPAGO = today;
let R_RECA = 0;
let R_CAJA = 0;
let VCONTROL = -1;

 -- BUSCAR EL PAGO.
 --   SELECT * FROM ta14_refrecibo A , TA14_FOLIOS_HISTO B WHERE B.AXO = 2020 AND B.FOLIO = 4161673 AND A.CONTROL = B.CONTROL
   foreach SELECT FECHA_RECIBO, RECA , CAJA , OPERACION, A.CONTROL
          INTO  R_FECHAPAGO, R_RECA , R_CAJA , R_OPERACION, VCONTROL
    FROM ta14_refrecibo A , TA14_FOLIOS_HISTO B WHERE B.AXO = V_AXOFIN AND B.FOLIO = V_FOLIOFIN AND A.CONTROL = B.CONTROL
   end foreach;



--- oBTENER LO COBRADO EN gASTOS

 --  SELECT SUM(NVL(IMPORTE , 0)) FROM DB_INGRESOS:TA_12_RECIBOSDET WHERE FECHA = mDY(1,9,2020) AND ID_REC = 9 AND CAJA = 'I1' AND OPERACION = 2 AND CUENTA = 550620011;

   SELECT NVL(IMPORTE,0) INTO V_GASTOS
    FROM DB_INGRESOS:TA_12_RECIBOSDET
    WHERE FECHA = R_FECHAPAGO AND ID_REC = R_RECA AND CAJA = R_CAJA AND OPERACION = R_OPERACION AND CUENTA = 550620011;

IF V_GASTOS IS NULL THEN
  LET V_GASTOS = 0;
END IF;
if v_gastos > 0 then
            let v_Acumulado = v_Acumulado + v_gastos ;

SELECT FOLIO , FECHA_EMISION INTO vN_folio ,   vN_fecha_emision FROM db_ingresos:ta_15_apremios
         where modulo = 14 and FECHA_PAGO =  R_FECHAPAGO AND RECAUDADORA = R_RECA AND CAJA = R_CAJA AND OPERACION = R_OPERACION ;

insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
values ( parplaca , year(vN_fecha_emision), vN_folio, vN_fecha_emision, 0 , 0, v_gastos , 100 , 0 , v_gastos , 550620011);
let  v_Referencia  = year(vN_fecha_emision) || '-' || lpad(vN_folio, 8 ,'0') ;
--let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || vN_fecha_emision || ' Notificacion';
let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || year(vN_fecha_emision) ||'/'|| lpad(month(vN_fecha_emision),2,'0')||'/'||day(vN_fecha_emision) || ' Notificacion';

return 0,550620011, get_odoo_cta(  550620011  ,16 ),v_Referencia,v_Descripcion,v_gastos,v_Acumulado with resume;

end if;

    -- Curso Movilidad...
    foreach
        select fecha_registro into vFechaCurso
        from ta14_cursosmov 
        where placa = parplaca and estatus = 'V'
            -- Obtenemos el costo del Curso del a�o que se otorg�
            select (t.tarifa + t.costo_fijo01) into  vCostoCurso
            from ta14_tarifas t
            where year(fecha_inicial) = year(vFechaCurso) 
                and num_clave = 99; 

            if vCostoCurso > 0 then
                -- Insertamos renglones de respuesta para los cursos...
                let v_Acumulado = v_Acumulado + vCostoCurso ;

                let  v_Referencia  = year(vFechaCurso) || '-' || lpad(0, 8 ,'0') ;  
                let v_Descripcion = year(vFechaCurso) || '-0-' || year(vFechaCurso) ||'/'|| lpad(month(vFechaCurso),2,'0')||'/'||day(vFechaCurso) || ' CURSO TALLER DE EDUCACION VIAL';
                insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                    values ( parplaca , year(vFechaCurso), 0, vFechaCurso, 1 , 99, vCostoCurso , 100 , '' , vCostoCurso , '449137');
                

                return 0,449137, 449137,v_Referencia,v_Descripcion,vCostoCurso,v_Acumulado with resume;
            end if;
        end foreach;


foreach
Select distinct a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0), infra.descripcion
into  vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from ta14_folios_HISTO a, ta14_tarifas b, ta14_kio_transdet k  ,OUTER ta14_infraccion infra , outer ta14_folios_free f
--from ta14_refrecibo T, ta14_folios_HISTO a, ta14_tarifas b  ,OUTER ta14_infraccion infra , outer ta14_folios_free f
where  --T.FECHA_RECIBO = R_FECHAPAGO   AND T.RECA = R_RECA  AND CAJA = R_CAJA AND OPERACION = R_OPERACION --AND A.CONTROL = VCONTROL
--       AND A.CONTROL = t.CONTROL
       k.id_kio_trans = v_trans  and a.axo = k.axo and a.folio = k.folio
and a.infraccion = b.num_clave
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and infra.num_clave = a.infraccion
and a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
union all
Select distinct a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0), infra.descripcion
--into  vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
from  ta14_folios_adeudo a, ta14_tarifas b, ta14_kio_transdet k  ,OUTER ta14_infraccion infra , outer ta14_folios_free f
where  --T.RECA = 9  AND CAJA = 'I1' AND OPERACION = 1594 --AND A.CONTROL = 2881269 
       --AND  A.CONTROL = t.CONTROL
        k.id_kio_trans = v_trans  and a.axo = k.axo and a.folio = k.folio
and a.infraccion = b.num_clave
and a.fecha_folio between b.fecha_inicial and b.fecha_fin
and infra.num_clave = a.infraccion
and a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
order by 3 asc, 1 asc, 2 asc

/*
let fecha_hoy = R_FECHAPAGO;
let x1 = vfecha;
let x2 = vfecha;
let dias_cuantos = 0;
let dias_habil = 0;
if Weekday(vfecha) = 6 then
let dias_cuantos = 1;
end if;
select count(*) into dias_habil
    from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and R_FECHAPAGO;

    while x1 <= fecha_hoy
IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
let dias_cuantos =dias_cuantos+1;
    end if;
let x1 = x1+1;
end while;

let dias_cuantos =  dias_cuantos - dias_habil ;
*/

if year(vfecha) = year(vFechaPago) then
    execute procedure db_ingresos:get_diashabiles(vfecha, vFechaPago) into dias_cuantos;
else
    let dias_cuantos = 365;
end if;

-- PARTE QUE SUSTITUYE LAS CUENTAS ANTERIORES
if vinfra = 1 then  -- Por no cubrir la tarifa vigente autorizada para hacer uso del espacio de estacionamiento-612086-CLAVE 1
let vctaapl = 160000001;
end if;
if vinfra = 2 then  -- Por estacionar veh�culo invadiendo dos cajones o m�s marcados-612087-CLAVE 2
let vctaapl = 160000002;
end if;
if vinfra = 3 then  -- Por obstruir cochera impidiendo o dificultando el ingreso o salida-612088-CLAVE 3
let vctaapl = 160000003;
end if;
if vinfra = 4 then  -- Por estacionarse en l�nea amarilla-612089-CLAVE 4
let vctaapl = 160000004;
end if;
if vinfra = 5 then  -- "Por estacionarse sin derecho en lugares prohibidos exclusivos areas para de bomberos, polic�a y servicios m�dicos rampas o cajones para discapacitados salidas de emergencia
--  doble fila ciclov�as banquetas camellones andadores peatonales ciclopuertos en sentido contrario lugares prohibidos"-612111-CLAVE 5
let vctaapl = 160000005;
end if;
if vinfra = 6 then  -- Por estacionarse en bater�a cuando �ste sea en cord�n o viceversa-612092-CLAVE 6
let vctaapl = 160000006;
end if;
if vinfra = 7 then  -- Por veh�culo infraccionado e inmovilizado-612094-CLAVE 7
let vctaapl = 160000007;
end if;
if vinfra in (8,11) then  -- Por impedir u obstaculizarse a recibir documentaci�n oficia o negarse a proporcionar los datos, informes, documentos o registros,
-- as� como insultar o amenazar a los mismos-612008-CLAVE 8
let vctaapl = 160000008;
end if;
if vinfra = 10 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
let vctaapl = 160000010;
end if;
if vinfra = 20 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
let vctaapl = 160000010;
end if;
--

--para calcular el valor de la multa;
if (vinfra < 5) and (dias_cuantos < 7) then
    let vporc_cobro = 50 ;
    let vCtaDescuento = 613901; -- Descuento autom�tico por pagar en los primeros 7 dias
    -- vimp_dscto
else
    let  vporc_cobro = 100;
end if;


if vsqlporc_cobro <> 100 then
    let vporc_cobro = vsqlporc_cobro;
    let vCtaDescuento = 613913; -- Descuento por funcionario p�blico
end if;

if vinfra = 5 then
    let vCtaDescuento = 613914; -- Descuento autom�tico por pagar en los primeros 7 dias
end if;

let vimp_apagar = vporc_cobro / 100 * vtarifa;
let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;
--let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra || ' - ' || infra_descrip;
let v_Descripcion = vaxo || '-' || vfolio|| '-' || year(vfecha) ||'/'|| lpad(month(vfecha),2,'0')||'/'||day(vfecha) || ' Cve: ' || vinfra || ' - ' || infra_descrip;
--let v_Acumulado = v_Acumulado + vimp_apagar;

--insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
-- values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
--return 0,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;

if vporc_cobro <> 100 then
    let v_Acumulado = v_Acumulado + vtarifa;
    
    insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
    
    return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;

    let vctaapl = 160000104;
    Let vimp_dscto = vtarifa - vimp_apagar;
    Let vimp_dscto = vimp_dscto * -1;
    let v_Acumulado = v_Acumulado + vimp_dscto;

    insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, null , null, null, vimp_dscto , vctaapl);
    
    return 1,vCtaDescuento, vCtaDescuento,v_Referencia,v_Descripcion,vimp_dscto,v_Acumulado with resume;
else
    let v_Acumulado = v_Acumulado + vtarifa;
    insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
    
    return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;
end if;


    Let vporc_cobro = 0;
    Let vsqlporc_cobro = 0;
end foreach;

trace off;
end function;

CREATE FUNCTION "informix".admin_pago_16_elect(parPlaca char(7), parref varchar(28),
                parImpCertificado money(15,2),
                parimpredondeo   money(8,2),
                parimpcredito   money(15,2),
    		parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
	        ParFolioRecibo  char(30), --Folio del Recibo (ADMIN)
	        ParFechaRecibo  date ,   --Fecha del Recibo
	        ParReca         int, --No. de Recaudadora
	        ParCaja  char(2) ,--No. de Caja
	        ParCajero  char(10),	 --Clave usuario
                parCentro  integer)
				
--######################################################################
--#  Procedimiento:    admin_pago_16
--#  Descripcion:      Interfaz de pago de adeudo para el cobro de Folios de estacionamiento en el sistema ADMIN
--#
--#  Parametros        parPlaca     = numero de placa
--#  de entrada:       Parref       = Referencia maxima a cobrar
--#		
--#
--#  Parametros        Definidos Abajo.
--#  de salida:
--#
--#  Elaboro:          ivan de la torre
--#  Fecha:            24 Octubre 2013
--#
--#  Llamado por:      Procedimiento sp_pago en dbingresosw
--#  Llama a:
--#
--######################################################################

returning smallint , varchar(50);
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define x_placa  char(7) ;
define x_axo int;
define x_folio int;
define x_fecha_folio date;
define x_estado smallint;
define x_infraccion smallint;
define x_tarifa  money(12,2);
define x_porc_cobro int;
define x_num_acuerdo int;
define x_imp_pagar  money(12,2);
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define  vctaapl integer;
define v_ru int;
define v_conc int;
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define daxo int;
define dfolio int;
define dplaca char(7);
define dacuerdo  int;
define  dtarifa money(12,2);
define  dporc_cobro int;
define  dimp_pagar money(12,2);
define v_id_usuario int;
define v_cta int;
define linea int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define v_r char(1);
define v_ca int;
define v_cta_aplic int;
define v_fecha_folio date;
DEFINE V_AXOFIN INT;
DEFINE V_FOLIOFIN INT;
DEFINE v_trans INT;
DEFINE R_FECHAPAGO DATE ;
DEFINE R_RECA INT;
DEFINE R_CAJA CHAR(2);
DEFINE R_OPERACION INT;
define v_importe_bco money(12,2);
define v_axo int;
define v_lon int;
define v_folio int;
define v_rowid int;
define v_fecpago date;


set debug file to 'pagoBANOrte';
trace on;
  let v_r = 'N';

-- datos de la transaccion
-- ******************* INTERNET  ****************************
if length(trim(parref)) = 28 then
   let v_trans = parref[9,16];

   select AXOFIN , FOLIOFIN INTO V_AXOFIN , V_FOLIOFIN
   from  ta14_kio_trans where numtrans = v_trans ;
let v_Acumulado = 0;

 -- BUSCAR EL PAGO.

   SELECT FECHA_RECIBO, RECA , CAJA , OPERACION
          INTO  R_FECHAPAGO, R_RECA , R_CAJA , R_OPERACION
   FROM ta14_refrecibo A , TA14_FOLIOS_HISTO B WHERE B.AXO = V_AXOFIN AND B.FOLIO = V_FOLIOFIN AND A.CONTROL = B.CONTROL ;

  if R_FECHAPAGO is null   then
    -- Buacamos aplicar el pago del SP Normal
    execute procedure informix.admin_pago_16(parPlaca, parref, parImpCertificado,
                parimpredondeo, parimpcredito, parID_ADMIN, ParFolioRecibo, 
                ParFechaRecibo, ParReca, ParCaja, ParCajero, parCentro) 
        into varok, v_vcMensaje;

      return varok, v_vcMensaje;
  end if;
-- select * from db_ingresos:ta_12_recibos
 update db_ingresos:ta_12_recibos set foliorecibo = ParFolioRecibo , kio_trans = parID_ADMIN
 where fecha = R_FECHAPAGO and id_rec = r_reca and caja = r_caja and operacion = r_operacion and cvepago = 'P';

 update ta14_refrecibo set rec_odoo = ParFolioRecibo where fecha_recibo = R_FECHAPAGO and reca = r_reca and caja = r_caja and operacion = r_operacion and rec_odoo is null;

    -- Actualizamos pagos de movilidad
      update ta14_cursosmov set
                estatus = 'P',
                cvepago = parID_ADMIN
      where placa = parplaca and estatus = 'V' and cvepago = -1;

   return 0,'Procedimiento Completo' ;
end if;
--***********************BANORTE *************************
if parref[1,2] = 'BN'  then

 -- separa axo y folio
  let v_axo  = TO_NUMBER(parref[4,7]);
  let v_lon = length( parref);
  let v_folio = TO_NUMBER(parref[ 9, 16]);
 -- select *  from ta14_fol_Banorte where axo  = 2020 and folio = 4316402

    select fec_pago into v_fecpago   from ta14_fol_Banorte where axo  = v_axo and folio = v_folio ;
 -- select * from db_ingresos:ta_12_recibos where id_modulo = 14  and fec_pagobco = mdy(1,15,2020) and kio_num_terceros = 'JKZ1598'

    select rowid into v_rowid from db_ingresos:ta_12_recibos where id_modulo = 14 and kio_num_terceros = parplaca
          and fec_pagobco = v_fecpago and cvepago = 'P';

    if v_rowid > 0 then

      update  db_ingresos:ta_12_recibos  set foliorecibo = ParFolioRecibo , kio_trans = parID_ADMIN where rowid = v_rowid and cvepago = 'P';

      -- Actualizamos pagos de movilidad
      update ta14_cursosmov set
                estatus = 'P',
                cvepago = parID_ADMIN
      where placa = parplaca and estatus = 'V' and cvepago = -1;

      return 0,'Procedimiento Completo' ;
   else
      return -1,'SIN AFECTACION' ;
    end if;

end if;

   return -1,'Referencia Erronea' ;
trace off;
end function;

CREATE FUNCTION "informix".odoo_adeudos_detalle_16 ( parPlaca char(7), parref varchar(20))

{######################################################################
#  Procedimiento:    admin_adeudos_detalle_16odoo
#  Descripcion:      Interfaz de detalles de adeudo para el cobro de Folios de estacionometros en el sistema ODOO
#
#  Parametros        p_tipo     = numero de placa
#  de entrada:      
#      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            11 Octubre 2019  
#  Modificado:       04/11/2020  Se incluye diferenciado de descuento
#  Modifico:         Ignacio Marcial Duea�as
#  Llamado por:      Procedimiento admin_adeudos_detalle en dbingresosw
#  Llama a:          
#  
######################################################################}
returning
int         as NoRubro,
int         as NoConcepto,
int         as Cta_Aplic,
varchar(50) as Referencia,
varchar(120) as Descripcion,
dec(14,2)   as Monto,
dec(14,2)   as Acumulado;
define varok   smallint;
define varobs char(200);

define varcontrol integer;
define vaxo smallint;
define  vfolio integer;  
define vfecha date;
define vinfra smallint;
define vestado smallint;
define vporc_cobro integer;
define vsqlporc_cobro integer;
define vacuerdo integer;
define vtarifa smallint;
define dias_cuantos integer;
define dias_habil integer;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define fecha_hoy date;
define x1 date;
define x2 date;
define vimp_apagar decimal(7,2);
define vimp_dscto decimal(7,2); -- para descuento clave 4
define  vctaapl integer;  
define v_Acumulado decimal(12,2);
define v_Descripcion varchar(60);
define v_Referencia varchar(30);
define par_axo smallint;
define par_folio int;
define  var_refer bigint;
define  var_refers bigint;
define v_id_padron integer;
define v_gastos decimal(7,2);
define vN_folio integer ;
define vN_fecha_emision  date;
define vultimafecha date;
define infra_descrip char(40);
define vFechaEmiIni date;
define vFechaCurso date;
define vCostoCurso decimal(7,2);
define vCtaDescuento int;
--
begin
    on exception in (-958)
    delete from tmp_folios;
    end exception;

    create temp table tmp_folios(
        placa  char(7) ,
        axo int,
        folio int,
        fecha_folio date,
        estado smallint,
        infraccion smallint,
        tarifa  money(12,2),
        porc_cobro int,
        num_acuerdo int,
        imp_pagar  money(12,2) ,
        cta_aplicacion integer
            ) with no log;
    end;

    if parref = '' then
        let par_axo = year(today);
        let par_folio = 99999999;
        let var_refer = (par_axo * 100000000 ) + par_folio;
    else
        let par_axo = (parref[1,4]) *1;
        let par_folio = (parref[6,13]) *1;
        let var_refer = (par_axo * 100000000 ) + par_folio;
    end if;

    --select first 1 fecha_folio into vultimafecha
    --from ta14_folios_adeudo 
    --where (( axo * 100000000 ) +  folio) <= var_refer 
    --    and placa = parPlaca ;
    --
    -- verificar si hay padron
    --foreach
    select   id   into  v_id_padron
    from ta_padron where placa = parplaca;

    if v_id_padron is null  then
        let v_id_padron = 0;
    end if;
    --end foreach;
    --select * from ta_padron

    let v_Acumulado = 0;
    if exists ( select folio from ta14_folios_adeudo where placa = parplaca) then
        -- verificar si tienen gastos para su cobro
        if v_id_padron > 0 then  
            select nvl(sum(importe_gastos),0) into v_gastos
            from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron
            and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1 ;
   
            if v_gastos > 0 then
                foreach
                select  folio ,  fecha_emision ,  importe_gastos  
                into vN_folio , vN_fecha_emision , v_gastos
                from db_ingresos:ta_15_apremios where modulo = 14 and control_otr = v_id_padron
                and clave_practicado = 'P' and fecha_practicado is not null and vigencia = 1

                    let v_Acumulado = v_Acumulado + v_gastos ;

                    insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                        values ( parplaca , year(vN_fecha_emision), vN_folio, vN_fecha_emision, 0 , 0, v_gastos , 100 , 0 , v_gastos , 550620011);

                    let  v_Referencia  = year(vN_fecha_emision) || '-' || lpad(vN_folio, 8 ,'0') ;  
                    let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || year(vN_fecha_emision) ||'/'|| lpad(month(vN_fecha_emision),2,'0')||'/'||day(vN_fecha_emision) || ' Notificacion';
                    --let v_Descripcion = year(vN_fecha_emision) || '-' || vN_folio|| '-' || vN_fecha_emision || ' Notificacion';
                    return 0,550620011, get_odoo_cta(  550620011  ,16 ),v_Referencia,v_Descripcion,v_gastos,v_Acumulado with resume;
                end foreach;
            end if;
        end if;


        -- *********** Se inserta renglon en caso tenga un Curso de Movilidad pendiente de pago ******************************
        foreach
        select fecha_registro into vFechaCurso
        from ta14_cursosmov 
        where placa = parplaca and estatus = 'V'
            -- Obtenemos el costo del Curso del a�o que se otorg�
            select (t.tarifa + t.costo_fijo01) into  vCostoCurso
            from ta14_tarifas t
            where year(fecha_inicial) = year(vFechaCurso) 
                and num_clave = 99; 

            if vCostoCurso > 0 then
                -- Insertamos renglones de respuesta para los cursos...
                let v_Acumulado = v_Acumulado + vCostoCurso ;

                let  v_Referencia  = year(vFechaCurso) || '-' || lpad(0, 8 ,'0') ;  
                let v_Descripcion = year(vFechaCurso) || '-0-' || year(vFechaCurso) ||'/'|| lpad(month(vFechaCurso),2,'0')||'/'||day(vFechaCurso) || ' CURSO TALLER DE EDUCACION VIAL';
                insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                    values ( parplaca , year(vFechaCurso), 0, vFechaCurso, 1 , 99, vCostoCurso , 100 , '' , vCostoCurso , '449137');
                

                return 0,449137, 449137,v_Referencia,v_Descripcion,vCostoCurso,v_Acumulado with resume;
            end if;
        end foreach;
        
    
        -- Calculamos fecha inicial
        if par_folio <> 99999999 then
            select  fecha_folio into vFechaEmiIni
            from ta14_folios_adeudo a
            where placa =  parplaca
                and  (( a.axo * 100000000 ) +  a.folio) = var_refer;
        else
            let vFechaEmiIni = today + 60; -- Le aumentamos 60 dias porque se capturan ocacionalmente las fechas de folio mal
        end if;


        foreach
        Select a.axo, a.folio, a.fecha_folio, a.estado, a.infraccion, (b.tarifa + b.costo_fijo01), nvl(f.porc_cobro,100), nvl((a.num_acuerdo),0), infra.descripcion
        into  vaxo, vfolio, vfecha, vestado , vinfra, vtarifa ,  vsqlporc_cobro , vacuerdo , infra_descrip
        from ta14_folios_adeudo a, ta14_tarifas b  , ta14_infraccion infra , outer ta14_folios_free f
        where a.placa = parplaca
        --and (( a.axo * 100000000 ) +  a.folio) <= var_refer
        and a.fecha_folio <= vFechaEmiIni
        and a.infraccion = b.num_clave
        and a.fecha_folio between b.fecha_inicial and b.fecha_fin
        and infra.num_clave = a.infraccion
        and a.axo = f.axo and a.folio = f.folio and f.clave = 'A'
        order by 3 asc, 1 asc, 2 asc
            --select * from ta14_folios_adeudo where fecha_folio = '2/6/2012'  
            --select fecha_folio , count(*) from ta14_folios_adeudo where fecha_folio >= '2/6/2012'  
            --group by fecha_folio
            --- para obtener dias de vencimiento;
            -- select * from ta14_tarifas

            let fecha_hoy = today;
            let x1 = vfecha;
            let x2 = vfecha;
            let dias_cuantos = 0;
            let dias_habil = 0;

            if Weekday(vfecha) = 6 then
                let dias_cuantos = 1;
            end if;

            select count(*) into dias_habil
            from db_ingresos:ta_12_diasinhabil  where fecha between vfecha and today;

            while x1 <= fecha_hoy
                IF (Weekday(x1) >= 1) AND (Weekday(x1)< 6) THEN
                    let dias_cuantos =dias_cuantos+1;
                end if;

                let x1 = x1+1;
            end while;

            let dias_cuantos =  dias_cuantos - dias_habil ;

            --if year(today) = year(vfecha) then
            -- let vctaapl = 510900000 ;
            --else
            -- let vctaapl = 510930000 ;
            --end if;

            -- 510900000;  -- 46305  A�o actual
            -- 925100001;  -- 46320   a�os anteriores
            -- 992100006;      -- 23315  gastos ejecucion sefin.

            -- PARTE QUE SUSTITUYE LAS CUENTAS ANTERIORES
            if vinfra = 1 then  -- Por no cubrir la tarifa vigente autorizada para hacer uso del espacio de estacionamiento-612086-CLAVE 1
                let vctaapl = 160000001;
            end if;
            if vinfra = 2 then  -- Por estacionar veh�culo invadiendo dos cajones o m�s marcados-612087-CLAVE 2
                let vctaapl = 160000002;
            end if;
            if vinfra = 3 then  -- Por obstruir cochera impidiendo o dificultando el ingreso o salida-612088-CLAVE 3
                let vctaapl = 160000003;
            end if;
            if vinfra = 4 then  -- Por estacionarse en l�nea amarilla-612089-CLAVE 4
                let vctaapl = 160000004;
            end if;
            if vinfra = 5 then  -- "Por estacionarse sin derecho en lugares prohibidos exclusivos areas para de bomberos, polic�a y servicios m�dicos rampas o cajones para discapacitados salidas de emergencia
                --  doble fila ciclov�as banquetas camellones andadores peatonales ciclopuertos en sentido contrario lugares prohibidos"-612111-CLAVE 5
                let vctaapl = 160000005;
            end if;
            if vinfra = 6 then  -- Por estacionarse en bater�a cuando �ste sea en cord�n o viceversa-612092-CLAVE 6
                let vctaapl = 160000006;
            end if;
            if vinfra = 7 then  -- Por veh�culo infraccionado e inmovilizado-612094-CLAVE 7
                let vctaapl = 160000007;
            end if;
            if vinfra in (8,11) then  -- Por impedir u obstaculizarse a recibir documentaci�n oficia o negarse a proporcionar los datos, informes, documentos o registros,
                -- as� como insultar o amenazar a los mismos-612008-CLAVE 8
                let vctaapl = 160000008;
            end if;
            if vinfra = 10 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
                let vctaapl = 160000010;
            end if;
            if vinfra = 20 then -- POR EXCEDER EL TIEMPO MAXIMO PARA MANIOBRAS DE CARGA Y DESCARGA DENTRO DE UN CAJON EXCLUSIVO DE USO COMUN-612097-CLAVE 10
                let vctaapl = 160000010;
            end if;
            --

            --para calcular el valor de la multa;
            if (vinfra < 5) and (dias_cuantos < 7) then
                let vporc_cobro = 50 ;
                let vCtaDescuento = 613901; -- Descuento autom�tico por pagar en los primeros 7 dias
                -- vimp_dscto
            else
                let  vporc_cobro = 100;                
            end if;

            if vsqlporc_cobro <> 100 then
                let vporc_cobro = vsqlporc_cobro;
                let vCtaDescuento = 613913; -- Descuento por funcionario p�blico
            end if;

            if vinfra = 5 then
                let vCtaDescuento = 613914; -- Descuento autom�tico por pagar en los primeros 7 dias
            end if;

            let vimp_apagar = vporc_cobro / 100 * vtarifa;
            let  v_Referencia  = vaxo || '-' || lpad(vfolio, 8 ,'0') ;  
            let v_Descripcion = vaxo || '-' || vfolio|| '-' || year(vfecha) ||'/'|| lpad(month(vfecha),2,'0')||'/'||day(vfecha) || ' Cve: ' || vinfra || ' - ' || infra_descrip;
            --let v_Descripcion = vaxo || '-' || vfolio|| '-' || vfecha || ' Cve: ' || vinfra || ' - ' || infra_descrip;
            --let v_Acumulado = v_Acumulado + vimp_apagar;

            --insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
            -- values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vimp_apagar , vctaapl);
            --return 0,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vimp_apagar,v_Acumulado with resume;


            if vporc_cobro <> 100 then
                let v_Acumulado = v_Acumulado + vtarifa;
                insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
                return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;

                if vinfra = 5 then
                    let vctaapl = 613940;
                else
                    let vctaapl = 160000104;
                end if;

                if vsqlporc_cobro <> 100 then
                    let vctaapl = 613940;
                end if;

                -- Para ajustes por solicitud
                if vaxo = 2021 and vfolio = 4717207 then
                    -- NORMAL *************************************
                    Let vimp_dscto = -520.51;
                    let v_Acumulado = v_Acumulado + vimp_dscto;
                else
                    -- NORMAL *************************************
                    Let vimp_dscto = vtarifa - vimp_apagar;
                    Let vimp_dscto = vimp_dscto * -1;
                    let v_Acumulado = v_Acumulado + vimp_dscto;
                end if

                insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, null , null, null, vimp_dscto , vctaapl);
                return 1,vCtaDescuento, vCtaDescuento,v_Referencia,v_Descripcion,vimp_dscto,v_Acumulado with resume;
            else        
                let v_Acumulado = v_Acumulado + vtarifa;
                insert into tmp_folios (placa , axo , folio , fecha_folio, estado , infraccion , tarifa , porc_cobro , num_acuerdo , imp_pagar , cta_aplicacion)
                    values ( parplaca , vaxo, vfolio, vfecha, vestado , vinfra, vtarifa , vporc_cobro , vacuerdo , vtarifa , vctaapl);
                return 1,vctaapl, get_odoo_cta(vctaapl ,16 ),v_Referencia,v_Descripcion,vtarifa,v_Acumulado with resume;
            end if;


            Let vporc_cobro = 0;
            Let vsqlporc_cobro = 0;
        end foreach;
    else
        return 0,0,0,'','',0,0;
    end if;

end function;

CREATE PROCEDURE "informix".spd_del_fol_reca( paraxo smallint, parfolio integer, parfecha date, parreca smallint, parcaja char(2), paroperacion integer,
parusuauto integer, parimpor_pagado money(12,2), parOpcion  smallint, parRec_odoo char(30), parzn smallint, parplaca char(10)   )
returning smallint,  char(200) ;
{
# FECHA MODIFICACION: 2021-AGO-23
# MODIFICO : ESTEBAN CUITLAHUAC ARIAS GARAY
#  RAZON : SE AGREGO PARAMETRO PAROPCION 25 Y 26 PARA PAGOS APREMIOS Y MOVILIDAD
  }
  

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint;
define  vfolio integer;  
define vfecha date;
define vplaca char(7);
define ban_placa char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
define v_infraccion integer;
define v_fecha_folio date;
define v_tarifa  money(12,2);
define v_porc  int;

let varok = 0;
let varobs = '';          

--set debug file to "c:\ivan.log";
--trace on;

-- pago por folio de recaudadora;
-- select * from ta14_folios_adeudo
if (paropcion = 3) or (paropcion = 24)  then
select nvl(num_acuerdo,0) , infraccion ,fecha_folio into v_acuerdo ,v_infraccion , v_fecha_folio
    from ta14_folios_adeudo
    where axo = paraxo and folio = parfolio;
    

insert into ta14_folios_histo      
    select 0, today, axo, folio, fecha_folio, placa,infraccion,estado,vigilante,num_acuerdo,fec_cap, usu_inicial, paropcion, parusuauto , zona , espacio, 0
    from ta14_folios_adeudo  where axo = paraxo and folio = parfolio;

let varcontrol =  dbinfo("sqlca.sqlerrd1");

    -- ver tarifa
    select tarifa + costo_fijo01  into v_tarifa
    from  ta14_tarifas where num_clave = v_infraccion and v_fecha_folio between fecha_inicial and fecha_fin;
    let v_porc = 100 - (( parimpor_pagado * 100 ) / v_tarifa );
insert into ta14_folios_hco(control , importe_infraccion , porcentaje , importe_cobrado)
                  values(varcontrol , v_tarifa , v_porc , parimpor_pagado );
      insert into ta14_refrecibo (control, fecha_recibo ,  reca  ,  caja ,  operacion, rec_odoo )
              values ( varcontrol , parfecha, parreca , parcaja, paroperacion, Trim(parRec_odoo) );  
    delete from ta14_folios_adeudo where axo = paraxo and folio = parfolio;
  if v_acuerdo <> 0 then
              update ta14_notifica_edo set origen_pago = 1, fechapago = parfecha where num_acuerdo = v_acuerdo and fechapago is null;
    end if;
    let varok = 1;
      let varobs = 'pago hecho correctamente';
end if;


if (paropcion = 25)  then
  update db_ingresos:ta_15_apremios  
    set fecha_pago = parfecha,
        recaudadora = parzn,
        caja =  parcaja,
        operacion = paroperacion,
        importe_pago = parimpor_pagado,
        vigencia=2
        where modulo=14 and folio=parfolio and zona=parzn;
   let varobs = 'pago registrado correctamente en Apremios';
 end if; --par25

if (paropcion = 26)  then

  update dbestacion:ta14_cursosmov  
    set 
        estatus = 'P',
        cvepago = 999999
        where placa = parplaca and cvecursomov = parfolio  ;
   
   let varobs = 'pago registrado correctamente en Cursos Movilidad';
end if; --par26

return varok, varobs;
--trace off;

end procedure;

CREATE PROCEDURE "informix".actualiza_exc_pago(p_opc int , p_excid int, p_axof int , p_mesf int, p_tipo int,
 p_fecha_movto date ,p_reca smallint, p_caja char(2) , p_operacion int )
returning  int as id,  varchar(50) as mensaje; 
define r_id int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);
define v_certificado money(12,2);
--set debug file to 'publico.log';
--trace on;
let axovig = year(p_fecha_movto) ;
let mesvig = month(p_fecha_movto);
let diavig = day(p_fecha_movto);
let r_id = -1;
let  v_certificado = 0;
let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let perio = (p_axof *100 )+ p_mesf;
let per_recgos =  (axovig *100 )+mesvig;
-- obtener el valor del recibo.
 select nvl(importe,0) into v_certificado from db_ingresos:ta_12_recibos 
     where fecha = p_fecha_movto and id_rec = p_reca  and caja = p_caja and  operacion = p_operacion
        and cvepago = 'P';
--if v_certificado > 0 then
  FOREACH
  select id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
   
   into v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
  from ex_adeudo where ex_contrato_id = p_excid  and  (axo * 100 + mes) <= perio 
--and tipo = p_tipo

   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;

  insert into ex_adeudo_histo ( id ,
   fecha_at, ex_adeudo_id,  ex_contrato_id , axo , mes ,tipo, concepto, ade_importe , ade_descto ,
   ade_recgos, clave, motivo ,fecha_movto, pag_reca, pag_caja , pag_operacion ,
   pag_importe , bco_id,  bco_referencia , bco_importe , id_usuario)
  values  ( 0,today, v_adeudo_id , p_excid, v_axo , v_mes ,v_tipo, v_concepto1, v_adeudo , v_descto , v_recargos,   13 , 'Pago En Reca', 
  p_fecha_movto, p_reca , p_caja, p_operacion, v_certificado, null, null, null, 1);
  
 delete from ex_adeudo where id = v_adeudo_id ;
   

end foreach;
 let r_id = 0;
 let r_mensaje = 'Actualizacion del Pago realizado Correctamente';

--else
 --let r_id = -1;
 --let r_mensaje = 'Los datos del Recibo no son correctos';
--end if;
return r_id, r_mensaje ;
--trace off;
end procedure;

create procedure "pgcabrer".fn_exc_calcrecgos_ref( p_contrato_id int , p_axof int , p_mesf int ) 
returning  money(12,2) as recargo ;
 define v_adeudo money(12,2)     ;
define v_calcrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2);
 define per_recgos int;

define axovig int ;
define mesvig int ; define diavig  int;
define v_fecha_limite date;
--set debug file to 'exreca.log';
--trace on;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_calcrec = 1;
-- select fecha_descuento  from db_ingresos:ta_11_fecha_desc where mes = month(today);
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
 if mesvig < 3 then
   let axovig = axovig -1;
   let mesvig = 12;
 else
   if (v_fecha_limite ) > today then
      let mesvig = mesvig -1;
   end if;
 end if;
let per_recgos =  (axovig *100 )+mesvig;

 select  ade_importe into v_adeudo from ex_adeudo 
  where ex_contrato_id = p_contrato_id and axo  = p_axof and  mes = p_mesf and tipo in ( 26 , 27)  ;
 if v_adeudo is null then
  let v_adeudo = 0;
 end if;
 select porcentaje into v_porc_recgos from ex_descrec where ex_contrato_id = p_contrato_id
    and ((p_axof * 100)+p_mesf) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
  select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  ((p_axof * 100)+p_mesf) and per_recgos;
          
      if v_calcrec = 0 then
      let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
--       let  v_recargos =   v_recargos - v_descto_recgos; -- para regresar recargos con descuento

  end if;

 return v_recargos ;

--trace off;
END PROCEDURE;

create procedure "pgcabrer".calc_multa(pimp money(18,2),pven date)
returning   money(18,2) as multa;

define v_multa money(18,2);
define v_porc int;

--let v_porc=30;

select porc_multa_calc into v_porc from parametros;

let v_multa=0;

   if year(today)=year(pven) then
      if month(today)>month(pven) then
         let v_multa=trunc(pimp*v_porc)/100; 
      else
      if month(today)=month(pven) then
            if day(today)<day(pven) then
               let v_multa=0;
            else
               let v_multa=trunc(pimp*v_porc)/100;
            end if;
      else
      if month(today)<month(pven) then
            let v_multa=0;
          else
            let v_multa=trunc(pimp*v_porc)/100;
          end if; 
        end if;          
      end if;       
   else
      let v_multa=trunc(pimp*v_porc)/100;
   end if;

return v_multa;
end procedure;

CREATE PROCEDURE "pgcabrer".ex_desctomulta( par_id int, par_axo smallint, par_mes smallint, par_multa money(15,2))

RETURNING money as descuento,
          varchar(30) as mensage;

-- se modifica validacion del a�o actual 07/09/2021

define v_descto  money(16,2);
define v_porcentaje  int;
define v_porccovid19 decimal(5,2);
define v_id       int;
define v_axoi       int;
define v_mesi      int;
define v_axof      int;
define v_mesf      int;
define v_men      varchar(30);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'ex_desctomulta ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let    v_descto=0;
let    v_porcentaje=0;
let    v_axoi=0;
let    v_mesi=0;
let    v_axof=0;
let    v_mesf=0;
let    v_men='Ini';

select porcentaje, id_descto, axoinicio, mesinicio, axofin, mesfin
into v_porcentaje, v_id, v_axoi, v_mesi, v_axof, v_mesf
from ex_descmul where ex_contrato_id =par_id and vigencia='V';
if v_axoi=0 then
   let v_men=('sin calcular '||par_multa||' '||v_porcentaje);
else
   if v_axoi=par_axo then
      if par_axo<year(today) then
         let v_descto=(par_multa * v_porcentaje)/100;
      else
         if par_mes<=v_mesf then 
             let v_descto=(par_multa * v_porcentaje)/100;
         else
             let v_descto=0;
         end if;
      end if;
      let v_men=('entre 1 '||par_multa||' '||v_porcentaje);
   else
      if v_axof=par_axo then
         if v_mesf>=par_mes then
            let v_descto=(par_multa * v_porcentaje)/100;
         else
            let v_descto=0;
         end if;
         let v_men=('entre 2 '||par_multa||' '||v_porcentaje);
      else
         if v_axoi<par_axo then
            if v_axof>par_axo then
               let v_descto=(par_multa * v_porcentaje)/100;
            else
               let v_descto=0;
            end if;
            let v_men=('entre 3 '||par_multa||' '||v_porcentaje);
         else
            let v_descto=0;
            let v_men=('sin nada '||par_multa||' '||v_porcentaje); 
         end if;   
      end if;
   end if;
end if;
return v_descto,v_men;
  
END PROCEDURE;

CREATE FUNCTION "pgcabrer".admin_pago_23(p_opc int , pnumesta int, p_axof int , p_mesf int,
                parImpCertificado money(15,2),
                parimpredondeo   money(6,2),
                parimpcredito   money(15,2),
    		parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
	        ParFolioRecibo  char(30), --Folio del Recibo (ADMIN)
	        ParFechaRecibo  date ,   --Fecha del Recibo
	        ParReca         int, --No. de Recaudadora
	        ParCaja  char(2) ,--No. de Caja
	        ParCajero  char(10),	 --Clave usuario
                parCentro  integer)
				
{######################################################################
#  Procedimiento:    admin_pago_23
#  Descripcion:      Interfaz de pago de adeudo para el cobro de Estacionamiento Exclusivo en el sistema ADMIN
#
#  Parametros        pnumesta     = numero de Exclusivo
#  de entrada:       Parref       = Referencia maxima a cobrar
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            24 Octubre 2013   
#
#  Llamado por:      Procedimiento sp_pago en dbingresosw
#  Llama a:          
#  Modificaci�n:     se pone el adeudo detalle que utiliza odoo 01/02/2022 
######################################################################}

returning smallint , varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_excid int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(80);
define  v_calle varchar(80); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define  v_movto_cve char(1); 
define v_numext char(5);
define v_rfc  char(15);
define v_colonia varchar(40);

define v_id_usuario int;

define v_cta int;
define linea int;
define v_orden int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define r_cve int;
define r_obser varchar(200);
define v_r char(1);
define v_ca int;
define d_rubro,d_concepto,d_cuenta int;
define d_referencia varchar(30);
define d_descripcion  varchar(120);
define d_monto,d_acumulado decimal(14,2);

   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -12, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE EXCLUSIVOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
  let v_r = 'N';

  -- ejecuta el procedimiento adeudo detalle
    foreach 
     execute procedure admin_adeudos_detalle_23odoo ( p_opc , pnumesta, p_axof , p_mesf   )
     into  d_rubro,d_concepto,d_cuenta,d_referencia,d_descripcion,d_monto,d_acumulado

    end foreach;
select count(*) into v_ca from tmp_exclusivos ;
 if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--OBTENER EL ID USUARIO CAJERO;
select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = ParCajero;

if  v_id_usuario    is null then
 let v_id_usuario   = 335;  -- usuario ADMIN
end if;

select id into p_excid from ex_contrato where no_exclusivo = pnumesta;

 select nvl(a.id,0) , a.no_exclusivo, trim(b.propietario), trim(b.domicilio) , trim(b.colonia) , b.rfc , a.estatus
 into v_id , v_numesta, v_nombre , v_calle  , v_colonia , v_rfc, v_movto_cve
 from ex_contrato a , ex_propietario b where a.no_exclusivo = pnumesta and a.ex_propietario_id = b.id;



  BEGIN WORK;
   let v_r = 'S';
 -- select * from db_ingresos:ta_12_recibos where id_modulo = 24 and fecha > '1/1/2013'
   insert into db_ingresos:ta_12_recibos(fecha , id_rec , caja , operacion ,  importe , cvepago ,
    id_modulo ,  id_regmodulo,  id_rec_cta , regmunur ,
    mesdesde , axodesde, meshasta, axohasta ,
    nombre ,  domicilio , concepto , rfcini , rfcnumero ,
    rfccolonia,  obra ,  axofolio , id_usuario , fecha_act , descripcion ,
    lugar_pago , id_centro ,  foliorecibo) 
   values (ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN     , parImpCertificado, 'P' ,
    28, v_id, 0, 'P' ,
    0, 0, 0, 0, v_nombre, v_calle  ,'PAGO DE ESTACIONAMIENTO EXCLUSIVO NUM.' || v_numesta , 'EX', 
    v_numesta,0,0,0, v_id_usuario ,current , '' , 0,parCentro, ParFolioRecibo ) ;
   let linea = 1;
-- INSERTA LOS REGISTROS DETALLE.
   foreach 
     select orden , cta_aplicacion , sum(imp_pagar) 
      into v_orden , v_cta , v_importe
     from tmp_exclusivos
     group by 1,2 order by 1,2
  
  insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    'Registro a cuenta del ingreso por exclusivos '  , v_cta ,  v_importe);
   let linea = linea +1;

   end foreach ;
--  redondeo

 if parimpredondeo <> 0 then 
  insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    'Ajuste admin',  550800000,  parimpredondeo);
 end if;
--AFECTACION DEL ADEUDO DE EXCLUSIVOS
  

  execute procedure cajero_exc_pagoADMIN(2 , v_id, p_axof , p_mesf , ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , parImpCertificado )
    into r_cve , r_obser;
   if r_cve <> 0 then
          ROLLBACK WORK;
      RETURN -13,'ERROR, NO SE PUEDE AFECTAR LOS ADEUDOS DE PUBLICOS. VERIFICAR';
   end if;

  COMMIT WORK;	
   delete from tmp_exclusivos;
   return 0,'Procedimiento Completo' ; 
end function;

CREATE FUNCTION "pgcabrer".admin_cancela_23( p_id_admin_pag integer,
p_folio_pag varchar(30),p_usuario_canc varchar(10) )
{######################################################################
#  Procedimiento:    admin_pago_23
#  Descripcion:      Interfaz de cancelacion del pago de estacionamientos exclusivo en el sistema ADMIN
#
#  Parametros        p_id_admin_pag     = id de cobro de admin
#  de entrada:       p_folio_pag   = folio de recibo admin
#                    p_usuario_canc = usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            04 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  Modificaci�n:     se agrega la reactivaci�n de folios pagados de notificaciones 31/01/2022
######################################################################}
returning 
int as estatus,
varchar(255) as leyenda;
-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_pubid   int;
define v_cvepagorbo       CHAR(1);
define v_axo int;
define v_mes int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);
define v_res2 int ; define v_res3 varchar(50);
define v_placa char(1); define v_baliza char(1);
define v_tipo int; define v_no_exclusivo int;
------------PARA estatus

define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
 if v_r = 'S' then
     ROLLBACK WORK;
    end if;
RETURN -1, 'Error en cancelacion de Estacionamientos Exclusivos' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
 let v_r = 'N';
let v_leyenda   = 'CANCELACION REALIZADA';
let v_estatus	= 0;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
   let v_leyenda = 'RECIBO INEXISTENTE';
   let v_estatus = 1;
   RETURN v_estatus,v_leyenda;
end if;

select fecha ,id_rec ,caja, id_regmodulo, rfcnumero ,id_modulo, cvepago 
into v_fecha_pag,v_rec_pag,v_caja_pag , v_pubid, v_no_exclusivo ,v_id_modulo,v_cvepagorbo
from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
   let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   let v_estatus = 2;
   RETURN v_estatus,v_leyenda;
end if;
if v_fecha_pag <> today then
   let v_leyenda = 'EL RECIBO NO SE CANCELA POR SER DE OTRO DIA';
   let v_estatus = 4;
   RETURN v_estatus,v_leyenda;
end if;


if v_id_modulo <> 28 then
   let v_leyenda = 'EL RECIBO NO ES POR ESTACIONAMIENTOS EXCLUSIVOS';
   let v_estatus = 3;
   RETURN v_estatus,v_leyenda;
end if;

      BEGIN WORK;
      let v_r = 'S';
      update db_ingresos: ta_12_recibos set cvepago='C', fecha_act=today
      where fecha=v_fecha_pag and id_rec = v_rec_pag and caja=v_caja_pag and operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag);
-- verificar si tiene forma , balizamiento, placa.

select 'S' into v_placa
 from ex_adeudo_histo where ex_contrato_id = v_pubid 
   and  fecha_movto = v_fecha_pag and pag_reca = v_rec_pag and
   pag_caja = v_caja_pag and  pag_operacion = p_id_admin_pag and tipo = 23;
  if v_placa is null then
   let v_placa = 'N';
   end if;
 
select 'S' into v_baliza
 from ex_adeudo_histo where ex_contrato_id = v_pubid 
   and  fecha_movto = v_fecha_pag and pag_reca = v_rec_pag and
   pag_caja = v_caja_pag and  pag_operacion = p_id_admin_pag and tipo = 24;
   if v_baliza is null then
   let v_baliza = 'N';
   end if;
 
  FOREACH
  select id , Axo, mes , tipo
  into v_adeudo_id,  v_axo , v_mes , v_tipo 
  from  ex_adeudo_histo where ex_contrato_id  = v_pubid 
   and  fecha_movto = v_fecha_pag and pag_reca = v_rec_pag and
   pag_caja = v_caja_pag and  pag_operacion = p_id_admin_pag 
   order by 1,2
   if v_tipo = 20 then
    execute procedure sp_exc_genadeudo(1 , v_pubid ,v_axo,v_mes,0,0, 1) into v_res , v_res1;
   end if;
  if v_tipo = 21 then
   execute procedure sp_exc_autorizacion( v_no_exclusivo , v_axo , v_mes , v_placa , v_baliza , 'S', 1 ) 
          into v_res2 , v_res3;
   end if;
  if v_tipo = 26 then
    execute procedure sp_exc_refrendo(v_pubid  , v_axo , 1 ) into v_res2 , v_res3;
  end if;
 if v_tipo = 27 then
    execute procedure sp_exc_refrendo(v_pubid  , v_axo , 1 ) into v_res2 , v_res3;
  end if;
  
    update ex_adeudo_histo set clave =11 , motivo = 'RBO/Canc - ' || trim(motivo)  where id = v_adeudo_id ;

     end foreach;
 
   -- reactiva los folios pagados de notificaciones
   update db_ingresos:ta_15_apremios set fecha_pago =null,recaudadora=0,caja='',operacion=0,vigencia='1',importe_pago=0, clave_mov=1
    where  modulo=28 and control_otr=v_pubid and fecha_pago=v_fecha_pag and recaudadora=v_rec_pag and
    caja=v_caja_pag and operacion=p_id_admin_pag;  
      
      COMMIT WORK; 
 


return v_estatus,v_leyenda;
--trace off;
END FUNCTION
;

CREATE PROCEDURE "pgcabrer".sp28_convtotales ( parControl int, parAso int, parMes int )
{######################################################################
#  Procedimiento:    sp28_ConvTotales
#  Descripcion:      Interfaz de consulta de detalle para CONVENIOS de ESTACIONAMIENTOS EXCLUSIVOS
#
#  Parametros		parControl 	= Control del contrato de aseo
#  de entrada:		parAso		= A�o de corte
#                       		parMes		= Mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            22 Julio 2016
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning  Varchar(80) as Nom_Empresa,
				varchar(80) as Domicilio,
				int as Nun_Ext,
				int as Num_Int,
				int as Recaudadora,
				int as Zona,

				int as Aso_desde,
				int as Mes_desde,
				int as Aso_hasta,
				int as Mes_hasta,

				money(12,2) as Imp_Adeudo,
				money(12,2) as Imp_Refrendo,
				money(12,2) as Recargos,
				money(12,2) as Gastos,
				money(12,2) as Multa,
				money(12,2) as Actualizacion,
				money(12,2) as Total,

				int as Status,
				varchar(50) as Mensaje;

define v_control_contrato, v_Nom_Empresa, V_Domicilio				varchar(80);
define v_Nun_Ext, v_Num_Int, v_Recaudadora					int;
define v_Aso_desde, v_Mes_desde, v_Aso_hasta, v_Mes_hasta			int;
define v_Imp_Adeudo, v_ImpExced_Adeudo, v_Recargos, v_Gastos, v_multa, v_actualizacion, v_Imp_act money(12,2);     
define v_Status									int;
define v_Mensaje								varchar(50); 
define v_Zona								int;
               
define v_ctrol_operacion, v_id_control_req					Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas        Money(12,2);
define v_porcentaje_multa                                                                       Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           	Money(12,2);
define v_aso_mes_pago                                                                           Date;
define v_Axo, v_Mes                                                                             Integer;
define v_mensaje_proc                                                                           varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                              varchar(7);
define v_contador                                                                               Smallint;
define axovig, perioI int;
define v_opc int;
define vd_concepto 						varchar(50);
define vd_axo, vd_mes, vd_tipo, vd_id_adeudo				int;
define vd_adeudo, vd_dscto_adeudo, vd_rcgs, vd_dscto_rcgs,vd_actualizacion, vd_multa		money(12,2);

Let vd_concepto = '';
Let vd_axo = 0;
Let vd_mes = 0;
Let vd_tipo = 0;
Let vd_id_adeudo = 0;
Let vd_adeudo = 0;
Let vd_dscto_adeudo = 0;
Let vd_rcgs = 0;
let vd_multa=0;
Let vd_dscto_rcgs = 0;
let vd_actualizacion=0;

Let v_contador = 0;

Let axovig = year(today) ;
if axovig = parAso and parMes = 12 then
	Let v_opc = 3;
else
	Let v_opc = 2;
end if;


Let v_control_contrato = 0;
Let v_Nom_Empresa = '';
Let V_Domicilio = '';

Let v_Nun_Ext = 0;
Let v_Num_Int = 0;
Let v_Recaudadora = 0;
Let v_Zona = 0;

Let v_Aso_desde = 0;
Let v_Mes_desde = 0;
Let v_Aso_hasta = 0;
Let v_Mes_hasta = 0;

Let v_Imp_Adeudo = 0;
Let v_ImpExced_Adeudo = 0;
let v_Imp_act =0;
let v_actualizacion=0;
Let v_Recargos = 0;
Let v_Gastos = 0;
Let v_Multa = 0;
let perioI=0;
Let v_Status = -1;
Let v_Mensaje = 'NO EXISTE CONCESION';

if exists( SELECT *  FROM ex_contrato WHERE id = parControl ) then
	SELECT a.id, Trim(b.propietario), Trim(b.domicilio), 0, 0, 0, 0
	INTO v_control_contrato, v_Nom_Empresa, V_Domicilio, v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona 	
	FROM ex_contrato a, ex_propietario b
	WHERE a.id = parControl  AND b.id = a.ex_propietario_id;

                -- VARIABLES A 0
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               	Let v_tot_gastos = 0;


                -- APREMIOS
                Let v_id_control_req = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_Axo = 0;
                Let v_Mes = 0; 
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      FROM db_ingresos:ta_15_apremios
                       WHERE modulo = 28  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               
                               Let v_tot_multas = v_importe_multa;
                               if v_porcentaje_multa < 100 then
                                               Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                                               --Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                               else
                                               Let v_tot_dscto_multas = 0;
                               end if;
                               Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                end foreach;
                -- TERMINA APREMIOS

		-- INICIAN PERIODOS
                foreach
		EXECUTE procedure cajero_exc_detalle ( v_opc, v_control_contrato, parAso, parMes )
						INTO vd_concepto, vd_axo, vd_mes, vd_adeudo, vd_rcgs, vd_dscto_rcgs, vd_tipo, vd_id_adeudo,vd_actualizacion, vd_multa
		if ( vd_adeudo > 0) then

			if v_contador = 0 then
					Let v_Aso_desde = vd_axo;
					Let v_Mes_desde = vd_mes;
                                	end if;

			Let v_Aso_hasta = vd_axo;
			Let v_Mes_hasta = vd_mes;

 --           let perioI=(vd_axo  * 100 )+ vd_mes; -- nvo para calcular actualizacion
 --           let v_actualizacion=0;
 --           Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * vd_adeudo / 100 ;
 --           if v_actualizacion > 0 then
 --			   let v_Imp_act = v_Imp_act + v_actualizacion;
 --           end if;
 			let v_Imp_act = v_Imp_act + vd_actualizacion;
 			let v_multa = v_multa + vd_multa;

			if vd_tipo = 20 then
				Let v_Imp_Adeudo = v_Imp_Adeudo + vd_adeudo;
				--Let v_Recargos = v_Recargos + ( vd_rcgs - vd_dscto_rcgs ); -- anterior
                Let v_Recargos = v_Recargos + vd_rcgs;
			else
				Let v_ImpExced_Adeudo = v_ImpExced_Adeudo + vd_adeudo;
				--Let v_Recargos = v_Recargos + ( vd_rcgs - vd_dscto_rcgs ); -- anterior
                Let v_Recargos = v_Recargos + vd_rcgs;
			end if;

				Let vd_concepto = '';
 				Let vd_axo = 0;
				Let vd_mes = 0;
				Let vd_tipo = 0;
				Let vd_id_adeudo = 0;
				Let vd_adeudo = 0;
				Let vd_dscto_adeudo = 0;
				Let vd_rcgs = 0;
				Let vd_dscto_rcgs = 0;
                let vd_multa=0;

			Let v_contador = 1;
		end if;

                end foreach;
                	-- TERMINA PERIODOS
		if (v_Imp_Adeudo > 0) or (v_ImpExced_Adeudo > 0) then
			Let v_Status = 0;
			Let v_Mensaje = 'PROCEDE COBRO';
		else
			Let v_Status = -1;
			Let v_Mensaje = 'NO TIENE ADEUDO';
		end if;

end if;

	RETURN v_Nom_Empresa, V_Domicilio, v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona, v_Aso_desde, v_Mes_desde, v_Aso_hasta, v_Mes_hasta, 
	v_Imp_Adeudo, v_ImpExced_Adeudo, v_Recargos, v_tot_gastos, v_multa, v_Imp_act,
	v_Imp_Adeudo + v_ImpExced_Adeudo + v_Recargos + v_tot_gastos + v_multa + v_Imp_act, 
	v_Status, v_Mensaje;

end procedure;

CREATE PROCEDURE "pgcabrer".sp28_convdet ( parControl int, parAso int, parMes int )
{######################################################################
#  Procedimiento:    sp28_ConvDet
#  Descripcion:      Interfaz de consulta de detalle para CONVENIOS de ESTACIONAMIENTOS EXCLUSIVOS
#
#  Parametros		parControl 	= Control del contrato
#  de entrada:		parAso		= A�o de corte
#                       		parMes		= Mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            19 julio 2016
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning  Varchar(30) as Concepto,
				int as AsoAdeudo,
				int as MesAdeudo,
				int as CtaAplAdeudo,
				money(12,2) as ImpAplAdeudo,
				int as CtaAplRcgo,
				money(12,2) as ImpAplRcgo,
				int as CtaAplActualizacion,
				money(12,2) as ImpAplActualizacion,
				int as CtaAplMulta,
                money(12,2) as ImpMulta;
               
define v_control_contrato, v_ctrol_operacion, v_id_control_req					Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas        Money(12,2);
define v_porcentaje_multa                                                                       Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2, v_Importe_actualizacion           	Money(12,2);
define v_aso_mes_pago                                                                           Date;
define v_Axo, v_Mes                                                                             Integer;
define v_mensaje_proc                                                                           varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                              varchar(7);
define v_contador                                                                               Smallint;
define axovig int;
define v_opc int;
define vd_concepto 						varchar(50);
define vd_axo, vd_mes, vd_tipo, vd_id_adeudo				int;
define vd_adeudo, vd_dscto_adeudo, vd_rcgs, vd_dscto_rcgs		money(12,2);

Let vd_concepto = '';
Let vd_axo = 0;
Let vd_mes = 0;
Let vd_tipo = 0;
Let vd_id_adeudo = 0;
Let vd_adeudo = 0;
Let vd_dscto_adeudo = 0;
Let vd_rcgs = 0;
Let vd_dscto_rcgs = 0;

Let v_contador = 0;

Let axovig = year(today) ;
if axovig = parAso and parMes = 12 then
	Let v_opc = 3;
else
	Let v_opc = 2;
end if;

if exists( SELECT * FROM ex_contrato WHERE id = parControl ) then
             SELECT id  INTO  v_control_contrato   FROM ex_contrato  WHERE id = parControl;

                -- VARIABLES A 0
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;
                let v_Importe_actualizacion=0; 
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               Let v_tot_gastos = 0;

                	-- APREMIOS
                Let v_id_control_req = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_Axo = 0;
                Let v_Mes = 0; 
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      FROM db_ingresos:ta_15_apremios
                       WHERE modulo = 28  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               
                      Let v_tot_multas = v_importe_multa;
                      if v_porcentaje_multa < 100 then
                         Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                         --Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                      else
                         Let v_tot_dscto_multas = 0;
                      end if;
                      Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                end foreach;
                	-- TERMINA APREMIOS

		-- INICIAN PERIODOS
                foreach
		EXECUTE procedure cajero_exc_detalle ( v_opc, v_control_contrato, parAso, parMes )
						INTO vd_concepto, vd_axo, vd_mes, vd_adeudo, vd_rcgs, vd_dscto_rcgs, vd_tipo, vd_id_adeudo,v_Importe_actualizacion, v_tot_multas
		if ( vd_adeudo > 0) then

			if v_contador = 0 then
--               if v_tot_multas > 0 then
--				  RETURN 'Multas ', vd_axo, vd_mes, 0, v_tot_multas - v_tot_dscto_multas, 0, 0, 0, 0  with resume;
--			   end if;
               if v_tot_gastos > 0 then
				  RETURN 'Gastos ', vd_axo, vd_mes, 0, v_tot_gastos, 0, 0, 0, 0, 0, 0  with resume;
               end if;
            end if;
            -- calculo de actualizacion

        --    Let	v_Importe_actualizacion = fcn_inpc_x_mes ((vd_axo * 100 + vd_mes) ) * vd_adeudo / 100 ;

            if axovig > vd_axo then
			   if vd_tipo = 26 then
					--RETURN 'Rezago del Refrendo ', vd_axo, vd_mes, 370710002, vd_adeudo, 390700000, vd_rcgs - vd_dscto_rcgs  with resume;
					RETURN 'Rezago del Refrendo ', vd_axo, vd_mes, 370710002, vd_adeudo, 390700000, vd_rcgs, 459101, v_Importe_actualizacion, 452001, v_tot_multas with resume;
				else
					--RETURN 'Rezago del Adeudo ', vd_axo, vd_mes, 364130000, vd_adeudo, 390700000, vd_rcgs - vd_dscto_rcgs  with resume;
					--RETURN 'Rezago del Adeudo ', vd_axo, vd_mes, 364130000, vd_adeudo, 390700000, vd_rcgs + vd_dscto_rcgs  with resume;
					RETURN 'Rezago del Adeudo ', vd_axo, vd_mes, 230000003, vd_adeudo, 390700000, vd_rcgs, 459101, v_Importe_actualizacion, 452001, v_tot_multas  with resume;
				end if;
            else
				if vd_tipo = 26 then
					--RETURN 'Actual del Refrendo ', vd_axo, vd_mes, 370710002, vd_adeudo, 390700000, vd_rcgs - vd_dscto_rcgs  with resume;
					RETURN 'Actual del Refrendo ', vd_axo, vd_mes, 370710002, vd_adeudo, 390700000, vd_rcgs, 459101, v_Importe_actualizacion, 452001, v_tot_multas  with resume;
				else
					--RETURN 'Actual de Adeudo ', vd_axo, vd_mes, 364100000, vd_adeudo, 390700000, vd_rcgs - vd_dscto_rcgs  with resume;
					RETURN 'Actual de Adeudo ', vd_axo, vd_mes, 230000001, vd_adeudo, 390700000, vd_rcgs, 459101, v_Importe_actualizacion, 452001, v_tot_multas  with resume;
				end if;
            end if;

			Let vd_concepto = '';
 			Let vd_axo = 0;
			Let vd_mes = 0;
			Let vd_tipo = 0;
			Let vd_id_adeudo = 0;
			Let vd_adeudo = 0;
			Let vd_dscto_adeudo = 0;
			Let vd_rcgs = 0;
			Let vd_dscto_rcgs = 0;

			Let v_contador = 1;
		end if;

                end foreach;
                	-- TERMINA PERIODOS

end if;
end procedure;

CREATE PROCEDURE "pgcabrer".pub_desctomulta( par_id int, par_axo smallint, par_mes smallint, par_multa money(15,2))

RETURNING money as descuento,
          varchar(30) as mensage;

define v_descto  money(16,2);
define v_porcentaje  int;
define v_porccovid19 decimal(5,2);
define v_id       int;
define v_axoi       int;
define v_mesi      int;
define v_axof      int;
define v_mesf      int;
define v_men      varchar(30);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1, 'pub_desctomulta ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;

END EXCEPTION

let    v_descto=0;
let    v_porcentaje=0;
let    v_axoi=0;
let    v_mesi=0;
let    v_axof=0;
let    v_mesf=0;
let    v_men='Ini';

select porcentaje, id_descto, axoinicio, mesinicio, axofin, mesfin
into v_porcentaje, v_id, v_axoi, v_mesi, v_axof, v_mesf
from pub_descmul where pubmain_id =par_id and vigencia='V';
if v_axoi=0 then
   let v_men=('sin calcular '||par_multa||' '||v_porcentaje);
else
   if v_axoi=par_axo then
      if par_axo<year(today) then
         let v_descto=(par_multa * v_porcentaje)/100;
      else
         if par_mes<=v_mesf then 
             let v_descto=(par_multa * v_porcentaje)/100;
         else
             let v_descto=0;
         end if;
      end if;
      let v_men=('entre 1 '||par_multa||' '||v_porcentaje);
   else
      if v_axof=par_axo then
         if v_mesf>=par_mes then
            let v_descto=(par_multa * v_porcentaje)/100;
         else
            let v_descto=0;
         end if;
         let v_men=('entre 2 '||par_multa||' '||v_porcentaje);
      else
         if v_axoi<par_axo then
            if v_axof>par_axo then
               let v_descto=(par_multa * v_porcentaje)/100;
            else
               let v_descto=0;
            end if;
            let v_men=('entre 3 '||par_multa||' '||v_porcentaje);
         else
            let v_descto=0;
            let v_men=('sin nada '||par_multa||' '||v_porcentaje); 
         end if;   
      end if;
   end if;
end if;
return v_descto,v_men;
  
END PROCEDURE;

CREATE FUNCTION "pgcabrer".admin_pago_19(p_opc int , pnumesta int, p_axof int , p_mesf int,
                parImpCertificado money(15,2),
                parimpredondeo   money(6,2),
                parimpcredito   money(15,2),
    		parID_ADMIN     int,  --ID cobro ? uso interno de ADMIN
	        ParFolioRecibo  char(30), --Folio del Recibo (ADMIN)
	        ParFechaRecibo  date ,   --Fecha del Recibo
	        ParReca         int, --No. de Recaudadora
	        ParCaja  char(2) ,--No. de Caja
	        ParCajero  char(10),	 --Clave usuario
                parCentro  integer)
				
{######################################################################
#  Procedimiento:    admin_pago_19
#  Descripcion:      Interfaz de pago de adeudo para el cobro de Estacionamiento Publico en el sistema ADMIN
#
#  Parametros        parPlaca     = numero de placa
#  de entrada:       Parref       = Referencia maxima a cobrar
#		      
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          ivan de la torre
#  Fecha:            24 Octubre 2013   
#
#  Llamado por:      Procedimiento sp_pago en dbingresosw
#  Llama a:          
#  
######################################################################}

returning smallint , varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(7,2);
 define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
 define p_pubid int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(80);
define  v_calle varchar(80); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define  v_movto_cve char(1); 
define v_numext char(5);
define v_rfc  char(15);
define v_id_usuario int;
define v_cta int;
define linea int;
define v_orden int;
define v_importe money(12,2);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(100);
define r_cve int;
define r_obser varchar(200);
define v_r char(1);
define v_ca int;
define d_rubro,d_concepto,d_cuenta int;
define d_referencia varchar(30);
define d_descripcion  varchar(120);
define d_monto,d_acumulado decimal(14,2);
   ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
   if v_r = 'S' then
     ROLLBACK WORK;
    end if;
  if v_lError = -206   THEN 
       RETURN -12, 'FALTA LLAMAR EL PROCEDIMIENTO DE DETALLES DE PUBLICOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  ELIF  v_lError = -236   THEN
       RETURN -11, 'CAMPOS NO MACHADOS ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
   else
      RETURN -911, 'ERROR NO DEFINIDO, VERIFICARLO CON SOPORTE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  END if; 

END EXCEPTION; 
--set debug file to 'publicopago19';
--trace on;
  let v_r = 'N';
 -- ejecuta el procedimiento adeudo detalle
    foreach 
execute procedure admin_adeudos_detalle_19odoo ( p_opc , pnumesta, p_axof  , p_mesf  )
 into  d_rubro,d_concepto,d_cuenta,d_referencia,d_descripcion,d_monto,d_acumulado

end foreach;
select count(*) into v_ca from tmp_publicos ;
 if v_ca = 0 then
   RETURN -12, 'NO EXISTEN VALORES EN DETALLE ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
  end if;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
--OBTENER EL ID USUARIO CAJERO;
select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = ParCajero;

if  v_id_usuario    is null then
 let v_id_usuario   = 335;  -- usuario ADMIN
end if;

select id into p_pubid from pubmain where numesta = pnumesta;
select nvl(a.id,0) , a.numesta, a.nombre , trim(a.calle) , a.numext ,  b.descripcion , a.cupo , a.movto_cve , a.rfc
into v_id , v_numesta, v_nombre , v_calle  , v_numext,  v_descripcion , v_cupo , v_movto_cve , v_rfc
 from pubmain  a , pubcategoria b
where a.numesta = pnumesta and b.id = a.pubcategoria_id;

  BEGIN WORK;
 let v_r = 'S';
 -- select * from db_ingresos:ta_12_recibos where id_modulo = 24 and fecha > '1/1/2013'
   insert into db_ingresos:ta_12_recibos(fecha , id_rec , caja , operacion ,  importe , cvepago ,
    id_modulo ,  id_regmodulo,  id_rec_cta , regmunur ,
    mesdesde , axodesde, meshasta, axohasta ,
    nombre ,  domicilio , concepto , rfcini , rfcnumero ,
    rfccolonia,  obra ,  axofolio , id_usuario , fecha_act , descripcion ,
    lugar_pago , id_centro ,  foliorecibo) 
   values (ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN     , parImpCertificado, 'P' ,
    24, v_id, 0, 'P' ,
    0, 0, 0, 0, v_nombre, v_calle  ||' '|| v_numext,'PAGO DE ESTACIONAMIENTO PUBLICO NUM.' || v_numesta , 'EP', 
    v_numesta,0,0,0, v_id_usuario ,current , '' , 0,parCentro, ParFolioRecibo ) ;
   let linea = 1;
-- INSERTA LOS REGISTROS DETALLE.
   foreach 
     select orden , cta_aplicacion , sum(imp_pagar) 
      into v_orden , v_cta , v_importe
     from tmp_publicos
     group by 1,2 order by 1,2
  
  insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    'Registro a cuenta del ingreso por publicos '  , v_cta ,  v_importe);
   let linea = linea +1;

   end foreach ;
   if parimpredondeo <> 0 then
       insert into db_ingresos:ta_12_recibosdet values(ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , linea , 
    'Ajuste admin '  , 550800000 ,  v_importe);
    end if;

--AFECTACION DEL ADEUDO DE PUBLICOS
    execute procedure cajero_pub_pagoADMIN(2 , v_id, p_axof , p_mesf , ParFechaRecibo ,ParReca , ParCaja , parID_ADMIN , parImpCertificado )
    into r_cve , r_obser;
   if r_cve <> 0 then
          ROLLBACK WORK;
      RETURN -1,'Error, no se puede afectar los adeudos de publicos. Verificar';
   end if;

  COMMIT WORK;	
   delete from tmp_publicos;
   return 0,'Procedimiento Completo' ; 
--trace off;
end function;

CREATE FUNCTION "pgcabrer".admin_cancela_19 ( p_id_admin_pag integer, p_folio_pag varchar(30), p_usuario_canc varchar(10) )
{######################################################################
#  Procedimiento:    admin_pago_19
#  Descripcion:      Interfaz de cancelacion del pago de estacionamientos publicos en el sistema ADMIN
#
#  Parametros	p_id_admin_pag    	= id de cobro de admin
#  de entrada:	p_folio_pag   	= folio de recibo admin
#                    	p_usuario_canc 	= usuario que autoriza la cancelacion
#
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Ivan de la Torre
#  Fecha:            01 Noviembre 2013   
#
#  Llamado por:      Procedimiento sp_cancela en dbingresosw
#  Llama a:          
#  
######################################################################}
	returning int as estatus,
		varchar(255) as leyenda;

-----------Define las variables de retorno----------------
define v_leyenda    	varchar(255);
define v_estatus 	int;
-----------------------------------------------------------
define v_fecha_pag date; 
define v_rec_pag int;
define v_caja_pag char(2);
define v_cvepago        int;
define v_id_modulo      int;
define v_pubid   int;
define v_cvepagorbo       CHAR(1);
define v_axo int;
define v_mes int;
define v_tipo int;
define v_concepto varchar(40);
define v_ade_importe money(12,2);

define v_id_usuario int;
define v_adeudo_id int;
define v_res int; define v_res1 varchar(100);
------------PARA estatus
define v_statusdescto   dec(16,2);
define v_msjdescto      varchar(100);
------------PARA ejecucion del procedimiento
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);
DEFINE V_CONTAR_CVECUENTA INT;
define v_r char(1);

--set debug file to 'marco.log';
--trace on;
ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
if v_r = 'S' then
	ROLLBACK WORK;
end if;
RETURN -1, 'Error en cancelacion de Estacionamientos Publicos' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;
let v_r = 'N';
let v_leyenda = 'CANCELACION REALIZADA';
let v_estatus = 0;

Let  v_id_usuario = 0;
if exists( SELECT *  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(p_usuario_canc) ) then
    SELECT nvl(id_usuario,0)  INTO v_id_usuario  FROM db_ingresos:ta_12_passwords WHERE usuario = Trim(p_usuario_canc);
else
    Let v_id_usuario = 335;
end if;

--Verifica el tipo de pago (Estacionometros)
if NOT exists (select * from db_ingresos:ta_12_recibos where operacion = p_id_admin_pag and foliorecibo=trim(p_folio_pag)) then
	let v_leyenda = 'RECIBO INEXISTENTE';
   	let v_estatus = 1;
   	RETURN v_estatus,v_leyenda;
end if;

SELECT fecha ,id_rec ,caja,id_regmodulo,id_modulo,cvepago  INTO v_fecha_pag,v_rec_pag,v_caja_pag ,v_pubid,v_id_modulo,v_cvepagorbo
FROM db_ingresos:ta_12_recibos WHERE operacion = p_id_admin_pag AND foliorecibo=trim(p_folio_pag);

if v_cvepagorbo='C' then
	let v_leyenda = 'EL RECIBO YA ESTA CANCELADO';
   	let v_estatus = 2;
   	RETURN v_estatus,v_leyenda;
end if;

if v_id_modulo <> 24 then
	let v_leyenda = 'EL RECIBO NO ES POR ESTACIONAMIENTOS PUBLICOS';
   	let v_estatus = 3;
   	RETURN v_estatus,v_leyenda;
end if;

BEGIN WORK;
let v_r = 'S';
UPDATE db_ingresos:ta_12_recibos SET cvepago='C', fecha_act=today
WHERE fecha=v_fecha_pag AND id_rec = v_rec_pag AND caja=v_caja_pag AND operacion = p_id_admin_pag AND foliorecibo=trim(p_folio_pag);
 
	FOREACH
  	SELECT id , Axo, mes, tipo, concepto, ade_importe  INTO v_adeudo_id,  v_axo, v_mes, v_tipo, v_concepto, v_ade_importe 
  	FROM pubadeudo_histo where pubmain_id = v_pubid 
   		AND  fecha_movto = v_fecha_pag AND pag_reca = v_rec_pag 
		AND  pag_caja = v_caja_pag AND  pag_operacion = p_id_admin_pag 
   	ORDER BY 1,2

	if v_tipo = 10 then	
		execute PROCEDURE sp_pub_genadeudo ( 1, v_pubid, v_axo, v_mes, 0, 0, v_id_usuario ) into v_res , v_res1;
	else		
		insert into pubadeudo ( id, fecha_at, pubmain_id, axo, mes, tipo, concepto, ade_importe, ade_descto, id_usuario)	
             				values ( 0, today, v_pubid, v_axo, v_mes, v_tipo, v_concepto, v_ade_importe, 0, v_id_usuario );
	end if;
   	UPDATE pubadeudo_histo SET clave = 11 , motivo = 'RBO/Canc - ' || trim(motivo)  where id = v_adeudo_id ;
   	END FOREACH;

   -- reactiva los folios pagados de notificaciones
   update db_ingresos:ta_15_apremios set fecha_pago =null,recaudadora=0,caja='',operacion=0,vigencia='1',importe_pago=0, clave_mov=1
    where  modulo=24 and control_otr=v_pubid and fecha_pago=v_fecha_pag and recaudadora=v_rec_pag and
    caja=v_caja_pag and operacion=p_id_admin_pag; 
      
COMMIT WORK; 

RETURN v_estatus,v_leyenda;
--trace off;
END FUNCTION;

create procedure "pgcabrer".cajero_exc_detalle ( p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning   varchar(50) as concepto,
int as axo,
int as mes,
money(12,2) as adeudo,
money(10,2) as recargos,
money(10,2) as descto_recgos,
int as tipo,
int as id_adeudo,
money(12,2) as actualizacion,
money(12,2) as multa;

define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto, v_msgmulta varchar(50) ;
define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);
define v_id_adeudo int;
define v_actualizacion, v_multa, v_muldesc money(12,2);
define v_diavenc int;

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

select fecha_descuento, day(fecha_recargos) into v_fecha_limite, v_diavenc from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then
        let mesvig = mesvig -1;
       end if;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;

if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;
SELECT axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio  FROM ta_contratos_status WHERE modulo = 1 AND id = p_pubid AND estado = 'S'; -- 1=Exclusivo, 2=P�blico
if v_mes_inicio = 1 then
Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;
if perio_susp < perio then
Let perio = perio_susp;
end if;

--let perio_susp = (v_axo_inicio *100 )+v_mes_inicio;
--if perio_susp < perio then
-- Let perio = perio_susp-1; -- trampa para que al momento de leer los adeudos sea <=
--end if;

-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
 
FOREACH
  SELECT CASE WHEN tipo <> 20 THEN axo || '00' ELSE axo || lpad(mes,2,'0') END, tipo, Axo, mes, (axo  * 100 )+ mes, concepto, ade_importe , id
    INTO agrupar, v_tipo, v_axo, v_mes, perioI, v_concepto1, v_adeudo, v_id_adeudo
  FROM ex_adeudo WHERE ex_contrato_id = p_pubid  AND (axo * 100 + mes) <= perio
  ORDER BY 1,3,4

SELECT porcentaje INTO v_porc_recgos FROM ex_descrec WHERE ex_contrato_id = p_pubid
AND ((v_axo * 100)+v_mes) BETWEEN ((axoinicio * 100)+ mesinicio) AND ((axofin * 100)+mesfin) AND vigencia = 'V';

let v_descto_recgos = 0;
    if v_porc_recgos is null then
      let v_porc_recgos = 0;
    end if;
 
  if v_tipo = 20 then
    SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
      WHERE (axo * 100 + mes) BETWEEN  perioI AND per_recgos;
         
      if v_calrec = 0 then
      let v_porcentaje = 0;
      end if;

let v_recargos = (v_porcentaje * v_adeudo ) / 100;

        if v_recargos is null then
let v_recargos = 0;
        end if;

if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
        let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
        let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
    let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
    else
    let v_recargos = 0;
    let v_concepto = v_concepto1 || '  ' || v_adeudo;
  end if;

if (v_tipo = 26) or (v_tipo = 27) then
   execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
   let v_recargos =   v_recargos + v_recgos_ref;
   if v_porc_recgos > 0 and v_recargos > 0 then
      -- calcular descuento en recargos.
      let  v_descto_recgos = (v_recgos_ref * v_porc_recgos) / 100;
      let v_recargos =   v_recgos_ref - v_descto_recgos;
    end if;
end if;

let v_actualizacion=0;
--Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ; -- calculo anterior
execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;
if v_actualizacion < 0 then
   let v_actualizacion=0;
end if;
-- termina codigo nuevo inpc

-- calculo de multa
  let v_multa = 0;
  let v_muldesc=0;
  if exists (select * from parametros where exc_multa_adeven='S') then 
     if v_recargos > 0 then
        execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
        if v_multa >0 then
           -- calcula descuento multa
           let v_muldesc=0;
           execute PROCEDURE ex_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
        end if;
        let v_multa = v_multa - v_muldesc;
     end if;
  end if;
-- termina calculo de multa

RETURN v_concepto , v_axo , v_mes ,  v_adeudo , v_recargos , v_descto_recgos , v_tipo , v_id_adeudo, v_actualizacion, v_multa with resume;
END FOREACH;

end procedure;

CREATE PROCEDURE "pgcabrer".sp24_convdet ( parControl int, parAso int, parMes int )
{######################################################################
#  Procedimiento:    sp24_ConvDet
#  Descripcion:      Interfaz de consulta de detalle para CONVENIOS de ESTACIONAMIENTOS PUBLICOS
#
#  Parametros		parControl 	= Control del contrato
#  de entrada:		parAso		= A�o de corte
#                       		parMes		= Mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            18 julio 2016
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning  Varchar(30) as Concepto,
				int as AsoAdeudo,
				int as MesAdeudo,
				int as CtaAplAdeudo,
				money(12,2) as ImpAplAdeudo,
				int as CtaAplRcgo,
				money(12,2) as ImpAplRcgo,
				int as CtaAplActualizacion,
				money(12,2) as ImpAplActualizacion,
				int as CtaAplMulta,
                money(12,2) as ImpMulta;
               
define v_control_contrato, v_ctrol_operacion, v_id_control_req					Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas        Money(12,2);
define v_porcentaje_multa                                                                       Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2, v_Importe_actualizacion          	Money(12,2);
define v_aso_mes_pago                                                                           Date;
define v_Axo, v_Mes                                                                             Integer;
define v_mensaje_proc                                                                           varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                              varchar(7);
define v_contador                                                                               Smallint;
define axovig int;
define v_opc int;
define vd_concepto 						varchar(50);
define vd_axo, vd_mes, vd_tipo, vd_id_adeudo				int;
define vd_adeudo, vd_dscto_adeudo, vd_rcgs, vd_dscto_rcgs, vd_actualizacion		money(12,2);

Let vd_concepto = '';
Let vd_axo = 0;
Let vd_mes = 0;
Let vd_tipo = 0;
Let vd_id_adeudo = 0;
Let vd_adeudo = 0;
Let vd_dscto_adeudo = 0;
Let vd_rcgs = 0;
Let vd_dscto_rcgs = 0;

Let v_contador = 0;

Let axovig = year(today) ;
if axovig = parAso and parMes = 12 then
	Let v_opc = 3;
else
	Let v_opc = 2;
end if;

if exists( SELECT * FROM pubmain WHERE id = parControl ) then
             SELECT id  INTO  v_control_contrato   FROM pubmain  WHERE id = parControl;

                -- VARIABLES A 0
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               Let v_tot_gastos = 0;

                	-- APREMIOS
                Let v_id_control_req = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_Axo = 0;
                Let v_Mes = 0; 
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      FROM db_ingresos:ta_15_apremios
                       WHERE modulo = 24  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               
                      Let v_tot_multas = v_importe_multa;
                      if v_porcentaje_multa < 100 then
                         Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                         --Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                      else
                         Let v_tot_dscto_multas = 0;
                      end if;
                      Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                end foreach;
                	-- TERMINA APREMIOS

		-- INICIAN PERIODOS
                foreach
		EXECUTE procedure cajero_pub_detalle ( v_opc, v_control_contrato, parAso, parMes )
						INTO vd_concepto, vd_axo, vd_mes, vd_adeudo, vd_rcgs, v_Importe_actualizacion, v_tot_multas
		if ( vd_adeudo > 0) then

			if v_contador = 0 then
--               if v_tot_multas > 0 then
--					RETURN 'Multas ', vd_axo, vd_mes, 0, v_tot_multas - v_tot_dscto_multas, 0, 0, 0, 0  with resume;
--			   end if;
               if v_tot_gastos > 0 then
				  RETURN 'Gastos ', vd_axo, vd_mes, 0, v_tot_gastos, 0, 0, 0, 0, 0, 0  with resume;
               end if;
            end if;
            -- calculo de actualizacion
--            let v_Importe_actualizacion=0;
--            Let	v_Importe_actualizacion = fcn_inpc_x_mes ((vd_axo * 100 + vd_mes) ) * vd_adeudo / 100 ;
            
            if axovig > vd_axo then
			   RETURN 'Rezago del Adeudo ', vd_axo, vd_mes, 370130000, vd_adeudo, 390600000, vd_rcgs, 459101, v_Importe_actualizacion,452011, v_tot_multas  with resume;
            else
			   RETURN 'Actual de Adeudo ', vd_axo, vd_mes, 370100000, vd_adeudo, 390600000, vd_rcgs, 459101, v_Importe_actualizacion,452011, v_tot_multas  with resume;
            end if;


			Let vd_concepto = '';
 			Let vd_axo = 0;
			Let vd_mes = 0;
			Let vd_tipo = 0;
			Let vd_id_adeudo = 0;
			Let vd_adeudo = 0;
			Let vd_dscto_adeudo = 0;
			Let vd_rcgs = 0;
			Let vd_dscto_rcgs = 0;

			Let v_contador = 1;
		end if;

                end foreach;
                	-- TERMINA PERIODOS

end if;
end procedure;

CREATE PROCEDURE "pgcabrer".sp24_convtotales ( parControl int, parAso int, parMes int )
{######################################################################
#  Procedimiento:    sp24_ConvTotales
#  Descripcion:      Interfaz de consulta de detalle para CONVENIOS de ESTACIONAMIENTOS PUBLICOS
#
#  Parametros		parControl 	= Control del contrato de aseo
#  de entrada:		parAso		= A�o de corte
#                       		parMes		= Mes de corte
#  
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            19 Julio 2016
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
                returning  Varchar(80) as Nom_Empresa,
				varchar(80) as Domicilio,
				int as Nun_Ext,
				int as Num_Int,
				int as Recaudadora,
				int as Zona,

				int as Aso_desde,
				int as Mes_desde,
				int as Aso_hasta,
				int as Mes_hasta,

				money(12,2) as Imp_Adeudo,
				money(12,2) as Imp_Solicitud,
				money(12,2) as Recargos,
				money(12,2) as Gastos,
				money(12,2) as Multa,
				money(12,2) as Actualizacion,
				money(12,2) as Total,

				int as Status,
				varchar(50) as Mensaje;

define v_control_contrato, v_Nom_Empresa, V_Domicilio				varchar(80);
define v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona				int;
define v_Aso_desde, v_Mes_desde, v_Aso_hasta, v_Mes_hasta			int;
define v_Imp_Adeudo, v_ImpExced_Adeudo, v_Recargos, v_Gastos, v_Multa, v_actualizacion, v_Imp_act		money(12,2);     
define v_Status									int;
define v_Mensaje								varchar(50); 
 
               
define v_ctrol_operacion, v_id_control_req					Integer;
define v_importe_multa, v_importe_gastos, v_tot_gastos, v_tot_multas, v_tot_dscto_multas        Money(12,2);
define v_porcentaje_multa                                                                       Smallint;
define v_acumulado, v_importe, v_Importe_recargo, v_importe_rec1, v_importe_rec2           	Money(12,2);
define v_aso_mes_pago                                                                           Date;
define v_Axo, v_Mes                                                                             Integer;
define v_mensaje_proc                                                                           varchar(255);
define v_Periodo_CN, v_Periodo_EXE                                                              varchar(7);
define v_contador                                                                               Smallint;
define axovig, perioI int;
define v_opc int;
define vd_concepto 						varchar(50);
define vd_axo, vd_mes, vd_tipo, vd_id_adeudo				int;
define vd_adeudo, vd_dscto_adeudo, vd_rcgs, vd_dscto_rcgs, vd_actualizacion, vd_multa		money(12,2);

Let vd_concepto = '';
Let vd_axo = 0;
Let vd_mes = 0;
Let vd_tipo = 0;
Let vd_id_adeudo = 0;
Let vd_adeudo = 0;
let vd_multa = 0;
Let vd_dscto_adeudo = 0;
Let vd_rcgs = 0;
Let vd_dscto_rcgs = 0;


Let v_contador = 0;

Let axovig = year(today) ;
if axovig = parAso and parMes = 12 then
	Let v_opc = 3;
else
	Let v_opc = 2;
end if;


Let v_control_contrato = 0;
Let v_Nom_Empresa = '';
Let V_Domicilio = '';

Let v_Nun_Ext = 0;
Let v_Num_Int = 0;
Let v_Recaudadora = 0;
Let v_Zona = 0;

Let v_Aso_desde = 0;
Let v_Mes_desde = 0;
Let v_Aso_hasta = 0;
Let v_Mes_hasta = 0;

Let v_Imp_Adeudo = 0;
Let v_ImpExced_Adeudo = 0;
let v_actualizacion=0;
let v_Imp_act=0;
Let v_Recargos = 0;
Let v_Gastos = 0;
Let v_Multa = 0;
let perioI=0;

Let v_Status = -1;
Let v_Mensaje = 'NO EXISTE CONCESION';

if exists( SELECT *  FROM pubmain WHERE id = parControl ) then
		SELECT id, Trim(nombre), Trim(calle) || ' ' || Trim(numext), 0, 0, 0, zona  
		INTO v_control_contrato, v_Nom_Empresa, V_Domicilio, v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona 
		FROM pubmain WHERE id = parControl;

                -- VARIABLES A 0
                Let v_tot_multas = 0;
                Let v_porcentaje_multa = 0;
                Let v_tot_dscto_multas = 0;

                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
               	Let v_tot_gastos = 0;


                -- APREMIOS
                Let v_id_control_req = 0;
                Let v_importe_multa = 0;
                Let v_importe_gastos = 0;
                Let v_Axo = 0;
                Let v_Mes = 0; 
                foreach
                     SELECT id_control, importe_multa,     importe_gastos, Year(fecha_practicado), Month(fecha_practicado), porcentaje_multa  
                               INTO v_id_control_req, v_importe_multa, v_importe_gastos, v_Axo, v_Mes, v_porcentaje_multa
                      FROM db_ingresos:ta_15_apremios
                       WHERE modulo = 24  AND control_otr = v_control_contrato  AND vigencia = "1" AND clave_practicado = "P"
                      Order By id_control
                               
                      Let v_tot_multas = v_importe_multa;
                      if v_porcentaje_multa < 100 then
                         Let v_tot_dscto_multas = v_importe_multa * v_porcentaje_multa / 100;
                         --Let v_tot_dscto_multas = v_tot_dscto_multas * -1;  -- convertirlo a negativo
                      else
                         Let v_tot_dscto_multas = 0;
                      end if;
                      Let v_tot_gastos = v_tot_gastos + v_importe_gastos;

                end foreach;
                -- TERMINA APREMIOS

		-- INICIAN PERIODOS
                foreach
		EXECUTE procedure cajero_pub_detalle ( v_opc, v_control_contrato, parAso, parMes )
						INTO vd_concepto, vd_axo, vd_mes, vd_adeudo, vd_rcgs, vd_actualizacion, vd_multa

		if ( vd_adeudo > 0) then

			if v_contador = 0 then
			   Let v_Aso_desde = vd_axo;
			   Let v_Mes_desde = vd_mes;
            end if;
			Let v_Aso_hasta = vd_axo;
			Let v_Mes_hasta = vd_mes;
       --     let perioI=(vd_axo  * 100 )+ vd_mes; -- nvo para calcular actualizacion
       --     let v_actualizacion=0;
       --     Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * vd_adeudo / 100 ;
       --     if v_actualizacion > 0 then
	   --	   let v_Imp_act = v_Imp_act + v_actualizacion;
       --     end if; 
  
            let v_Imp_act = v_Imp_act + vd_actualizacion;
            let v_multa = v_multa + vd_multa;

			Let v_Imp_Adeudo = v_Imp_Adeudo + vd_adeudo;
			Let v_Recargos = v_Recargos + vd_rcgs;

			Let vd_concepto = '';
 			Let vd_axo = 0;
			Let vd_mes = 0;
			Let vd_tipo = 0;
			Let vd_id_adeudo = 0;
			Let vd_adeudo = 0;
			Let vd_dscto_adeudo = 0;
			Let vd_rcgs = 0;
			Let vd_dscto_rcgs = 0;

			Let v_contador = 1;
		end if;

                end foreach;
                	-- TERMINA PERIODOS
		if (v_Imp_Adeudo > 0) or (v_ImpExced_Adeudo > 0) then
			Let v_Status = 0;
			Let v_Mensaje = 'PROCEDE COBRO';
		else
			Let v_Status = -1;
			Let v_Mensaje = 'NO TIENE ADEUDO';
		end if;

end if;

	RETURN v_Nom_Empresa, V_Domicilio, v_Nun_Ext, v_Num_Int, v_Recaudadora, v_Zona, v_Aso_desde, v_Mes_desde, v_Aso_hasta, v_Mes_hasta, 
	v_Imp_Adeudo, v_ImpExced_Adeudo, v_Recargos, v_tot_gastos, v_multa, v_Imp_act,
	v_Imp_Adeudo + v_ImpExced_Adeudo + v_Recargos + v_tot_gastos + v_multa + v_Imp_act,
	v_Status, v_Mensaje;

end procedure;

create procedure "pgcabrer".notif_exc_detalle ( p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning   varchar(50) as concepto,
int as axo,
int as mes,
money(12,2) as adeudo,
money(10,2) as recargos,
decimal(7,2) as porc_recargos,
money(10,2) as descto_recgos,
int as tipo,
int as id_adeudo,
money(12,2) as actualizacion,
decimal(16,11) as porc_actualizacion,
decimal(23,16) as factor_aplicar,
money(12,2) as multa,
int as porc_multa;

define axovig int;
define mesvig int; 
define diavig int; 
define perio  int; 
define v_porcentaje decimal(5,2);
define perioI int; 
define v_recargos money(10,2); 
define v_adeudo money(12,2);
define v_multa money(12,2);
define v_axo int;
define v_mes int;  
define per_recgos int;    
define v_concepto varchar(50) ;
define v_tipo int; 
define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);
define v_id_adeudo int;
define v_actualizacion money(12,2);
define v_muladeven, v_mulnotif char(1);
define v_diavenc int;
define v_porc int;
define v_factor_aplicar decimal(23,16);
define v_porc_actualizacion, v_incp_viejo decimal(16,11);


define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019

let axovig = year(today);
let mesvig = month(today);
let diavig = day(today);

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

select fecha_descuento, day(fecha_recargos) into v_fecha_limite, v_diavenc from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then
        let mesvig = mesvig -1;
       end if;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF;
let mesvig = p_mesF;
end if;

if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;

SELECT axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio  FROM ta_contratos_status WHERE modulo = 1 AND id = p_pubid AND estado = 'S'; -- 1=Exclusivo, 2=P�blico

if v_mes_inicio = 1 then
   Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
   Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;

if perio_susp < perio then
   Let perio = perio_susp;
end if;

--let perio_susp = (v_axo_inicio *100 )+v_mes_inicio;
--if perio_susp < perio then
-- Let perio = perio_susp-1; -- trampa para que al momento de leer los adeudos sea <=
--end if;

-- ver si se calculan los recargos o no por se nuevo.
select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
if v_calrec is null then
   let v_calrec = 1;
end if;
 
FOREACH
  SELECT CASE WHEN tipo <> 20 THEN axo || '00' ELSE axo || lpad(mes,2,'0') END, tipo, Axo, mes, (axo  * 100 )+ mes, concepto, ade_importe , id
    INTO agrupar, v_tipo, v_axo, v_mes, perioI, v_concepto1, v_adeudo, v_id_adeudo
  FROM ex_adeudo WHERE ex_contrato_id = p_pubid  AND (axo * 100 + mes) <= perio
  ORDER BY 1,3,4

  SELECT porcentaje INTO v_porc_recgos FROM ex_descrec WHERE ex_contrato_id = p_pubid
  AND ((v_axo * 100)+v_mes) BETWEEN ((axoinicio * 100)+ mesinicio) AND ((axofin * 100)+mesfin) AND vigencia = 'V';

  let v_descto_recgos = 0;
  if v_porc_recgos is null then
     let v_porc_recgos = 0;
  end if;
 
  let v_porcentaje=0;
  if v_tipo = 20 then
     SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
      WHERE (axo * 100 + mes) BETWEEN  perioI AND per_recgos;
         
     if v_calrec = 0 then
        let v_porcentaje = 0;
     end if;

     let v_recargos = (v_porcentaje * v_adeudo ) / 100;

     if v_recargos is null then
        let v_recargos = 0;
     end if;
  
     let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
  else
     let v_recargos = 0;
     let v_concepto = v_concepto1 || '  ' || v_adeudo;
  end if;

  if (v_tipo = 26) or (v_tipo = 27) then
     execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
     let v_recargos =   v_recargos + v_recgos_ref;
  end if;

  -- inicia codigo nuevo inpc 
  let v_actualizacion=0;
--  Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;
  execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;
  if v_actualizacion < 0 then
     let v_actualizacion=0;
  end if;

  let v_factor_aplicar=0;
  let v_porc_actualizacion=0;
  execute FUNCTION catastro_gdl:fn_actualizacionfactor(v_axo, v_mes, v_adeudo) into v_factor_aplicar, v_porc_actualizacion, v_incp_viejo;
  -- termina codigo nuevo inpc

  -- calculo de multa
  let v_multa = 0;
  execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
  select porc_multa_calc into v_porc from parametros;
  -- termina calculo de multa

  RETURN v_concepto , v_axo , v_mes ,  v_adeudo , v_recargos, v_porcentaje , v_descto_recgos , v_tipo , v_id_adeudo, v_actualizacion, 
         v_porc_actualizacion, v_factor_aplicar, v_multa, v_porc with resume;
END FOREACH;

end procedure;

create procedure "pgcabrer".notif_pub_detalle ( p_opc int , p_pubid int, p_axof int , p_mesf int  )
	returning	varchar(50) as concepto , 
		int as axo, 
		int as mes, 
        int as tipo,
		money(12,2) as adeudo, 
		money(10,2) as recargos,
        decimal(7,2) as porc_recargos,
        money(10,2) as descto_recgos,
        money(10,2) as actualizacion,
        decimal(16,11) as porc_actualizacion,
        decimal(23,16) as factor_aplicar,
        money(10,2) as multa,
        int as porc_multa;

define axovig int;
define mesvig int; 
define diavig int; 
define perio  int;
define v_diavenc int;
define v_porcentaje decimal(5,2);
define perioI int; 
define v_recargos money(10,2); 
define v_adeudo money(12,2) ; 
define v_actualizacion money(12,2) ;
define v_muldesc money(10,2); 
define v_multa money(10,2);
define v_axo int ;
define v_mes int;  
define per_recgos int;    
define v_concepto varchar(50) ;
define v_tipo int; 
define v_concepto1, v_msgmulta varchar(40);
define v_fecha_limite date;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_porc int;
define v_factor_aplicar decimal(23,16);
define v_porc_actualizacion, v_incp_viejo decimal(16,11);

define vv_status		int;		-- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda		varchar(50);	-- adicionado por Gil para generar registro de recargo 01/06/2018	

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

Let vv_status = 0;							-- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5';			-- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda;  	-- adicionado por Gil para generar registro de recargo 01/06/2018

select fecha_descuento, day(fecha_recargos) into v_fecha_limite, v_diavenc from db_ingresos:ta_11_fecha_desc where mes = mesvig;
	if v_fecha_limite > today then
      		let mesvig = mesvig -1;
   	end if;
	let per_recgos =  (axovig *100 )+mesvig;
	--let per_recgos = 201312;

	if p_opc = 2 then
		let axovig = p_axoF ;
		let mesvig = p_mesF;
	end if;

	if p_opc = 3 then
		let axovig = year(today) ;
		let mesvig = 12;
	end if;
	let perio = (axovig *100 )+mesvig;

let v_descto_recgos=0;

FOREACH
select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio 
order by 1,2,3

if v_tipo = 10 then
	select sum(porcentaje_mes) into v_porcentaje from recargos
     	where (axo * 100 + mes) between  perioI and per_recgos;

	let v_recargos = (v_porcentaje * v_adeudo ) / 100;
	if v_recargos is null then
       		let v_recargos = 0;
	end if;
		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
else
	let v_recargos = 0;
	let v_concepto = v_concepto1 || '  ' || v_adeudo;
end if;

let v_actualizacion=0;
-- Let v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;  -- calculo anterior
execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;
if v_actualizacion < 0 then
   let v_actualizacion=0;
end if;

let v_factor_aplicar=0;
let v_porc_actualizacion=0;
execute FUNCTION catastro_gdl:fn_actualizacionfactor(v_axo, v_mes, v_adeudo) into v_factor_aplicar, v_porc_actualizacion, v_incp_viejo;
-- termina codigo nuevo inpc

-- calculo de multa
  let v_multa = 0;
  let v_muldesc=0;
  let v_porc=0;
  if exists (select * from parametros where pub_multa_adeven='S') then 
     if v_recargos > 0 then
        execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
        select porc_multa_calc into v_porc from parametros;
     end if;
  end if;
-- termina calculo de multa

return v_concepto, v_axo, v_mes, v_tipo, v_adeudo, v_recargos, v_porcentaje, v_descto_recgos, v_actualizacion, 
         v_porc_actualizacion, v_factor_aplicar, v_multa, v_porc with resume;

end foreach;
end procedure;

create procedure "pgcabrer".cajero_exc_pagoadmin ( p_opc int , p_pubid int, p_axof int , p_mesf int, p_fecha_movto date ,p_reca smallint, p_caja char(2) , p_operacion int, p_certificado money(12,2) )
	returning  int as id,  varchar(50) as mensaje; 

-- se agrega poner como pagados los folios de notificaciones y multas si tienen descuentos 31/01/2022

define r_id, v_idcontrol, v_folio int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define v_res2 int ; define v_res3 varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo, v_gastos money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);
define v_porc_recgos int;
define v_descto_recgos money(10,2);

--set debug file to 'publico.log';
---trace on;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let r_id = -1;

let r_mensaje = 'No proceso nada';
	if diavig <=5 then
		let mesvig = mesvig -1;
	end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

if p_opc < 3 then
	let perio = (axovig *100 )+ mesvig;
	FOREACH
	SELECT id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
	INTO v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
	FROM ex_adeudo WHERE ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio

		SELECT sum(porcentaje_mes)  INTO v_porcentaje 
		FROM recargos  WHERE (axo * 100 + mes) BETWEEN  perioI and per_recgos;
		let v_recargos = (v_porcentaje * v_adeudo ) / 100;

		SELECT porcentaje  INTO v_porc_recgos 
		FROM ex_descrec WHERE ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
		let v_descto_recgos = 0;
		if v_porc_recgos is null then
			let v_porc_recgos = 0;
		end if;
		let v_recargos = (v_porcentaje * v_adeudo ) / 100;
		if v_porc_recgos > 0 and v_recargos > 0 then 
			-- calcular descuento en recargos.
			let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
		end if;
   
		-- CREA EL HISTORICO
  		INSERT INTO ex_adeudo_histo ( id, fecha_at, ex_adeudo_id,  ex_contrato_id, axo, mes, tipo, concepto, ade_importe, ade_descto, ade_recgos, ade_recgos_descto, clave, 
					motivo, fecha_movto, pag_reca, pag_caja, pag_operacion, pag_importe, bco_id,  bco_referencia, bco_importe, id_usuario)
				VALUES  ( 0, today, v_adeudo_id, p_pubid, v_axo , v_mes, v_tipo, v_concepto1, v_adeudo, v_descto, v_recargos, v_descto_recgos, 13 , 
					'Pago En Reca', p_fecha_movto, p_reca , p_caja, p_operacion, p_certificado, null, null, null, 1);

		-- ELIMINA EL ADEUDO
		DELETE FROM ex_adeudo WHERE id = v_adeudo_id;

		-- PONE COMO PAGADO EL DESCUENTO AL RECARGO -- Parte adicionada por Gilberto 12/02/2019
		UPDATE ex_descrec SET
			fec_pag = p_fecha_movto, id_rec = p_reca, caja = p_caja, operac = p_operacion, vigencia = 'P'
			WHERE ex_contrato_id = p_pubid and vigencia = 'V';

		-- PONE COMO PAGADO EL DESCUENTO DE MULTA -- Parte adicionada por Benita 31/01/2022
		UPDATE ex_descmul SET
			fec_pag = p_fecha_movto, id_rec = p_reca, caja = p_caja, operac = p_operacion, vigencia = 'P'
			WHERE ex_contrato_id = p_pubid and vigencia = 'V';

	END FOREACH;

   -- seleccionar los folios vigentes y practicados  
   foreach
   select nvl(id_control,0),nvl(folio,0),importe_gastos 
   into v_idcontrol,v_folio,v_gastos
   from    db_ingresos:ta_15_apremios a  
   where modulo=28 and control_otr=p_pubid and vigencia='1' and clave_practicado='P'

   -- poner como pagados los folios vigentes y practicados
   update db_ingresos:ta_15_apremios set fecha_pago=p_fecha_movto, recaudadora=p_reca, caja=p_caja,
   operacion=p_operacion, vigencia='2', clave_mov='P', importe_pago=v_gastos
   where modulo=28 and Id_control=v_idcontrol;
   end foreach;

	let r_id = 0;
	let r_mensaje = 'Pago realizado Correctamente';
end if;

if p_opc = 3 then
	let v_tipo = 20;
	FOREACH

	SELECT id, Axo, mes, tipo  INTO v_adeudo_id, v_axo, v_mes, v_tipo  FROM ex_adeudo_histo WHERE ex_contrato_id = p_pubid 
	AND fecha_movto = p_fecha_movto and pag_reca = p_reca  AND pag_caja = p_caja and  pag_operacion = p_operacion 
	ORDER BY 1,2

	if v_tipo = 20 then
		execute procedure sp_exc_genadeudo ( 1 , p_pubid ,v_axo,v_mes,0,0, 1 ) INTO v_res , v_res1;
	end if;

	if v_tipo = 22 then
		execute procedure sp_exc_refrendo ( p_pubid  , v_axo , 1 ) INTO v_res2 , v_res3;
	end if;
  
	UPDATE ex_adeudo_histo SET clave =11, motivo = 'RBO/Canc - ' || trim(motivo)  WHERE id = v_adeudo_id ;

	END FOREACH;
	let r_id = 0;
	let r_mensaje = 'Cancelacion realizado Correctamente';
end if;

return r_id, r_mensaje ;
--trace off;

end procedure;

create procedure "pgcabrer".cajero_pub_pagoadmin(p_opc int , p_pubid int, p_axof int , p_mesf int, 
 p_fecha_movto date ,p_reca smallint, p_caja char(2) , p_operacion int, p_certificado money(12,2) )

returning  int as id,  varchar(50) as mensaje; 

define r_id, v_idcontrol, v_folio int ; define r_mensaje varchar(50);
define v_res int ; define v_res1 varchar(50);
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo, v_gastos money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);
define v_adeudo_id int;  define v_descto money(12,2); define v_usuario int; define v_tipo int ;define v_concepto1 varchar(40);
define v_porc_recgos int; define v_descto_recgos money(12,2);

--set debug file to 'publicoabr';
--trace on;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let r_id = -1;

let r_mensaje = 'No proceso nada';
   if diavig <=5 then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;

if p_opc < 3 then
let perio = (axovig *100 )+ mesvig;
  FOREACH
  select id, Axo, mes, (axo  * 100 )+ mes ,  ade_importe  , ade_descto , tipo, concepto
   
   into v_adeudo_id , v_axo , v_mes , perioI , v_adeudo , v_descto , v_tipo , v_concepto1
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio

 --   select porcentaje into v_porc_recgos from pub_descrec 
  --  where pubmain_id = p_pubid and ((v_axo * 100)+v_mes) between 
 --   ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
 --  let v_descto_recgos = 0;
 --  if v_porc_recgos is null then
  --   let v_porc_recgos = 0;
  --  end if; 
 
   select sum(porcentaje_mes) into v_porcentaje from recargos
     where (axo * 100 + mes) between  perioI and per_recgos;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
   --  if v_porc_recgos > 0 and v_recargos > 0 then 
    -- calcular descuento en recargos.
  --     let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
  --   end if;
  --   let v_recargos = v_recargos + v_descto_recgos; 
 --    if v_recargos is null then
  --     let v_recargos = 0;
  --   end if;
  insert into pubadeudo_histo ( id ,
   fecha_at, pubadeudo_id,  pubmain_id , axo , mes ,tipo, concepto, ade_importe , ade_descto ,
   ade_recgos, clave, motivo ,fecha_movto, pag_reca, pag_caja , pag_operacion ,
   pag_importe , bco_id,  bco_referencia , bco_importe , id_usuario)
  values  ( 0,today, v_adeudo_id , p_pubid, v_axo , v_mes ,v_tipo, v_concepto1, v_adeudo , v_descto , v_recargos,   13 , 'Pago En Reca', 
 p_fecha_movto, p_reca , p_caja, p_operacion, p_certificado, null, null, null, 1);
 
   -- Elimina el adeudo 
   delete from pubadeudo where id = v_adeudo_id ;
   
   -- PONE COMO PAGADO EL DESCUENTO AL RECARGO 
	UPDATE pub_descrec SET
		fec_pag = p_fecha_movto, id_rec = p_reca, caja = p_caja, operac = p_operacion, vigencia = 'P'
		WHERE pubmain_id = p_pubid and vigencia = 'V';

	-- PONE COMO PAGADO EL DESCUENTO DE MULTA 
	UPDATE pub_descmul SET
		fec_pag = p_fecha_movto, id_rec = p_reca, caja = p_caja, operac = p_operacion, vigencia = 'P'
		WHERE pubmain_id = p_pubid and vigencia = 'V';

end foreach;

   -- seleccionar los folios vigentes y practicados  
   foreach
   select nvl(id_control,0),nvl(folio,0),importe_gastos 
   into v_idcontrol,v_folio,v_gastos
   from    db_ingresos:ta_15_apremios a  
   where modulo=24 and control_otr=p_pubid and vigencia='1' and clave_practicado='P'

   -- poner como pagados los folios vigentes y practicados
   update db_ingresos:ta_15_apremios set fecha_pago=p_fecha_movto, recaudadora=p_reca, caja=p_caja,
   operacion=p_operacion, vigencia='2', clave_mov='P', importe_pago=v_gastos
   where modulo=24 and Id_control=v_idcontrol;
   end foreach;

 let r_id = 0;
 let r_mensaje = 'Pago realizado Correctamente';
end if;

if p_opc = 3 then

  FOREACH
  select id , Axo, mes 
  into v_adeudo_id,  v_axo , v_mes 
  from pubadeudo_histo where pubmain_id = p_pubid 
   and  fecha_movto = p_fecha_movto and pag_reca = p_reca and
   pag_caja = p_caja and  pag_operacion = p_operacion 
   order by 1,2
   execute procedure sp_pub_genadeudo(1 , p_pubid ,v_axo,v_mes,0,0, 1) into v_res , v_res1;
   
   update pubadeudo_histo set clave =11 , motivo = 'RBO/Canc - ' || trim(motivo)  where id = v_adeudo_id ;
   

end foreach;
let r_id = 0;
let r_mensaje = 'Cancelacion realizado Correctamente';
end if;
return r_id, r_mensaje ;
--trace off;
end procedure;

CREATE PROCEDURE "pgcabrer".sp14_upd_cor_bat ( pOrigen char(2), pCambio char(1), pNvaCat int, pId_Esta Int, pCupo_Bateria decimal(5,2), pCupo_Cordon decimal(5,2), 
				pAxo_desde int, pMes_desde int, pAxo_hasta int, pMes_hasta int, pNum_of int, pFec_of date, pDescrip_of varchar(250) )
{######################################################################
#  Procedimiento:    sp14_upd_cor_bat
#  Descripcion:      Interfaz de consulta de Documentacion tanto RECIBIDA como ENVIADA - GESTION DE DOCUMENTOS -
#
#  Parametros         
#  de entrada:        pOrigen		= Origen de modificacion
#                     		'PU' = Publicos
#                     		'EX' = Exclusivos
#                     pCambio		= Tipo de cambio		
#                     		'A' = Cambio ( en publicos es cambio de cupo - en exclusivo es en bateria y cordon )	
#                     		'B' = Cambio ( en publicos es cambio de categoria - en exclusivo es en cambio de factor )
#                     pNvaCat		= ( en publicos es cambio de categoria - en exclusivo es cambio de factor )
#                     pId_Esta		= Id de Estacionamiento ( publico o exclusivo )
#                     pCupo_Bateria	= Nuevo Cupo ( publicos = cupo, exlusivos = total bateria )
#                     pCupo_Cordon	= Nuevo Cupo ( publicos = 0, 	exclusivos = total cordon )
#                     pAxo_desde	= Axo desde donde inicia la aplicacion
#                     pMes_desde	= Mes desde donde inicia la aplicacion
#                     pAxo_hasta	= Axo hasta donde finaliza la aplicacion
#                     pMes_hasta	= Mes hasta donde finaliza la aplicacion
#                     		
#                     pNum_of	= Numero de Oficio
#                     pFec_of	= Fecha del Oficio
#                     pDescrip_of	= Descripcion del Movimiento segun Oficio
#                     		
#  Parametros        Definidos Abajo.
#  de salida:        
#                    
#  Elaboro:          Gilberto Moreno
#  Fecha:            2 Junio 2015   
#
#  Llamado por:      Procedimiento 
#  Llama a:          
#  
######################################################################}
Returning   int as estatus,
            varchar(255) as mensaje;

define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);

define v_factor, v_pubcategoria_id, v_cupo        int;
define v_importe, v_importe_bat, v_importe_cord, v_adeudo_bat, v_adeudo_cord, v_adeudo	Money(12,2);
define v_zona								char(1);
define v_concepto								varchar(40);

define v_leyenda								varchar(255);
define v_estatus								int;

define v_id_usuario								int;

define v_Axo, v_Mes							int;

ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
--ROLLBACK WORK;
RETURN -1, 'Error en transaccion de proc. sp14_upd_cor_bat ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION;

let v_factor = 0;
let v_pubcategoria_id = 0;
let v_importe = 0;
let v_importe_bat = 0;
let v_importe_cord = 0;
let v_adeudo_bat = 0;
let v_adeudo_cord = 0;
let v_adeudo = 0;
let v_zona = '';
let v_concepto = '';
let v_cupo = 0;

Let v_Axo = 0;
Let v_Mes = 0;

let v_leyenda   = 'ACTUALIZACION DE FOLIOS APLICADA CORRECTAMENTE';
let v_estatus	= 0;

select id_usuario into v_id_usuario   
from db_ingresos:ta_12_passwords where usuario = User;

if  v_id_usuario    is null then
 let v_id_usuario   = 683;  -- usuario pgmoreno
end if;


if pOrigen = 'EX' then  -- actualizacion para estacionamientos exclusivos
	if exists( SELECT *  FROM ex_contrato WHERE id = pId_Esta and estatus = 'V' ) then
    		SELECT zona, factor INTO v_zona, v_factor  FROM ex_contrato WHERE id = pId_Esta;

		if pCambio = 'A' then  
			-- Cambio de cupo en bateria y/o cordon
			UPDATE ex_contrato SET
				total_bateria = pCupo_Bateria,
				total_cordon = pCupo_Cordon,
				fecha_at = Current
				WHERE id = pId_Esta;

			FOREACH
			SELECT Axo, Mes INTO v_Axo, v_Mes FROM ex_adeudo WHERE ex_contrato_id = pId_Esta and tipo = 20 
				and ((axo * 100)+ mes) between ((pAxo_desde * 100)+ pMes_desde) and ((pAxo_hasta * 100)+ pMes_hasta)
				ORDER BY axo, mes

				-- Valor de Bateria
				SELECT importe  INTO v_importe_bat FROM pubcatimporte WHERE pubcategoria_id = 15 and fecha_fin = mdy(12,31,v_Axo);
				if v_importe_bat is null then  Let v_importe_bat = 0;	end if;

				-- Valor de Cordon
				SELECT importe  INTO v_importe_cord FROM pubcatimporte WHERE pubcategoria_id = 16 and fecha_fin = mdy(12,31,v_Axo);
				if v_importe_cord is null then Let v_importe_cord = 0;  end if;

				-- Obtencion de concepto e importes
				if pCupo_Bateria > 0 then	Let  v_adeudo_bat = v_importe_bat * pCupo_Bateria;  end if;
 				if pCupo_Cordon > 0 then	Let  v_adeudo_cord = v_importe_cord * pCupo_Cordon; end if;

 				if pCupo_Bateria > 0 and pCupo_Cordon > 0 then
 					let v_concepto = 'En Bateria :' ||  pCupo_Bateria ||' En Cordon: ' ||  pCupo_Cordon ;
 				end if;
 				if pCupo_Bateria > 0 and pCupo_Cordon = 0 then
 					let v_concepto = 'En Bateria :' ||  pCupo_Bateria  ;
 				end if;
 				if pCupo_Bateria = 0 and pCupo_Cordon > 0 then
 					let v_concepto = 'En Cordon: ' ||  pCupo_Cordon ;
 				end if;
 				let v_adeudo = v_adeudo_bat + v_adeudo_cord;

				UPDATE ex_adeudo SET
					fecha_at = Current,
					concepto = v_concepto,
					ade_importe = v_adeudo
					WHERE ex_contrato_id = pId_Esta and tipo = 20 and axo = v_Axo and mes = v_Mes;

			END FOREACH;
			insert into ex_bitacora_mov values ( 0, current, v_id_usuario, pId_Esta, 
						'CAMBIO DE DATOS DEL CONTRATO CON MODIFICACION DE ADEUDOS', 
						pNum_of, pFec_of, pDescrip_of, getcomputer() );

			let v_leyenda   = 'Termino la Actualizacion de Cupo';
			let v_estatus	= 0;

		else
			-- Cambio de factor
			UPDATE ex_contrato SET
				factor = pNvaCat,
				fecha_at = Current
				WHERE id = pId_Esta;

			UPDATE ex_adeudo SET
				fecha_at = Current,
				ade_importe = ade_importe * pNvaCat / 100
				WHERE ex_contrato_id = pId_Esta AND axo = pAxo AND mes between pMes_desde and pMes_hasta;

			insert into ex_bitacora_mov values ( 0, current, v_id_usuario, pId_Esta, 
						'CAMBIO DE DATOS DEL CONTRATO SIN MODIFICACION DE ADEUDOS', 
						pNum_of, pFec_of, pDescrip_of, getcomputer() );

			let v_leyenda   = 'Termino la Actualizacion por Cambio de Factor';
			let v_estatus	= 0;

		end if;
	else
		let v_leyenda   = 'No existe ese Estacionamiento Exclusivo';
		let v_estatus	= 1;
	end if;
end if;  -- termino actualizacion para estacionamientos exclusivos

RETURN v_estatus,v_leyenda;

end procedure;

create procedure "pgcabrer".sp_pub_adeudototaldom(paxo int, pmes int)
returning   int as id,
            int as no_Publico,
            int as cupo,
            varchar(100) as propietario,
            varchar(100) as calle,
            varchar(06) as exterior,
            varchar(10) as periodoinicio,
            varchar(10) as periodofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;

define v_id, no_publico, d_axo, d_mes, v_cupo, d_id_adeudo int;
define v_zona, v_estatus char(1);
define v_bateria, v_cordon, v_factor decimal(5,2);
define v_propietario, v_calle varchar(100);
define v_concepto, d_conc varchar(50);
define v_ade, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total money(18,2);
define d_adeudo, d_recargos, d_descto, d_actualizacion, d_multa money(18,2);
define v_per_inicio, v_per_final varchar(10);
define v_numext varchar(6);

            
foreach
  select a.id, a.numesta, a.cupo, a.nombre, a.calle, a.numext, nvl(sum(d.ade_importe),0),
   ((select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=24 and control_otr=a.id and clave_practicado='P' and vigencia='1')) 
   into v_id, no_publico, v_cupo, v_propietario,v_calle, v_numext, v_ade, v_gastos
   from pubmain a, pubadeudo d
   where  a.fecha_baja is null and a.movto_cve<>'C'
    and  d.pubmain_id=a.id and (d.axo<paxo  or (d.mes<=pmes and d.axo=paxo)) 
   group by a.id, a.numesta, a.cupo, a.nombre, a.calle, a.numext 
   order by a.numesta  

   let v_adeudo=0;
   let v_recargos=0; 
   let v_multa=0; 
   let v_actualizacion=0;
   let v_total=0;
   let v_per_inicio=''; 
   let v_per_final='';

   foreach
     execute procedure cajero_pub_detalle ( 2, v_id, paxo, pmes  ) into d_conc, d_axo, d_mes, d_adeudo, d_recargos, d_actualizacion, d_multa
     if v_per_inicio='' then
        let v_per_inicio=d_axo||' - '||d_mes;
     end if;
     let v_per_final=d_axo||' - '||d_mes;
     let v_adeudo = v_adeudo + d_adeudo;
     let v_recargos = v_recargos + d_recargos;
     let v_multa = v_multa + d_multa;
     let v_actualizacion = v_actualizacion + d_actualizacion;
   end foreach;

   let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
   if v_adeudo>0 then
      return v_id, no_publico, v_cupo, v_propietario, v_calle, v_numext, v_per_inicio, v_per_final, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
   end if;
end foreach;

end procedure;

CREATE PROCEDURE "pgcabrer".sp14_contratos_status_mannto ( parOpc int, parModulo int, parNumesta int, parAxo int , parMes int, parDescrip varchar(80), parUsuario char(20) )
-- parOpc ( 1 Suspensi�n, 2 Cancela la Suspensi�n, 3 Consulta ) 
returning
	integer as codigo_status,
	varchar(100) as mensaje,
	integer as Axo,
	integer as Mes,
	date as fecha_alta,
	date as fecha_mov;

define v_codigo_status		int;
define v_mensaje			varchar(100);
define v_estado_contrato	char(1);
define p_pubid				int;
define v_fecha_alta, v_fecha_mov	date;
define vid, vaxoini, vmesini		int;

let v_codigo_status = -1;
let v_mensaje = ''; 

let v_estado_contrato = '';
Let p_pubid = 0;

if parModulo = 1 then
	select id into p_pubid from ex_contrato where no_exclusivo = parNumesta;
end if;
if parModulo = 2 then
	select id into p_pubid from pubmain where numesta = parNumesta;
end if;

if parOpc = 1 then -- Suspension de Servicio
	if exists (SELECT * FROM ta_contratos_status WHERE modulo = parModulo AND id = p_pubid and estado = 'S') then
	   SELECT estado, fecha_alta, fecha_mov INTO v_estado_contrato, v_fecha_alta, v_fecha_mov  FROM ta_contratos_status WHERE modulo = parModulo AND id = p_pubid and estado = 'S';
	   RETURN 1, 'El Estacionamiento esta en Suspensi�n de Servicios desde '||v_fecha_alta, 0,0, Null, Null  with resume;
	else
		if parModulo = 1 then
			update ex_contrato set estatus = 'S'  where no_exclusivo = parNumesta;
		end if;
		if parModulo = 2 then
			update pubmain set movto_cve = 'S'  where numesta = parNumesta;
		end if;
		
		insert into ta_contratos_status values ( 0, parModulo, p_pubid, parAxo, parMes, 0, 0, parDescrip, 'S', parUsuario, current, Null, Null );
		LET vid = dbinfo("sqlca.sqlerrd1");
		if vid <> 0 then
			RETURN 1, 'El Estacionamiento ha sido puesto en Suspension de Servicios', 0,0, Null, Null  with resume;
		else
			RETURN -1, 'Ocurri� un error al momento de Suspender el Estacionamiento, avisa al administrador', 0,0, Null, Null with resume;
		end if;
	end if;
end if;

if parOpc = 2 then -- Cancela Suspension
	if exists (SELECT * FROM ta_contratos_status WHERE modulo = parModulo AND id = p_pubid and estado = 'S') then
		SELECT estado, fecha_alta, fecha_mov, axo_inicio, mes_inicio INTO v_estado_contrato, v_fecha_alta, v_fecha_mov, vaxoini, vmesini  
         FROM ta_contratos_status WHERE modulo = parModulo AND id = p_pubid and estado = 'S';

		if v_estado_contrato = 'C' then
			RETURN 1, 'El Estacionamiento tiene Cancelaci�n de la Suspensi�n de Servicios el '||v_fecha_mov, 0,0, Null, Null  with resume;
		else
			if v_estado_contrato = 'S' then
		
				update ta_contratos_status set axo_fin=parAxo, mes_fin=parMes, estado = 'C', fecha_mov = current, usuario_mov = parUsuario 
                         WHERE modulo = parModulo AND id = p_pubid and estado = 'S';

				if parModulo = 1 then
                    -- activa el contrato
					update ex_contrato set estatus = 'V'  where no_exclusivo = parNumesta;

                    -- suspende periodos
                    insert into ex_adeudo_histo
                    select 0,fecha_at,id,ex_contrato_id,axo,mes,tipo,concepto,ade_importe,ade_descto,0,0,26,'SUSPENCION DE ADEUDO ',today,0,'',0,0,0,0,0,id_usuario 
                    from ex_adeudo where ex_contrato_id=p_pubid and ( (axo>vaxoini  or (mes>=vmesini  and axo=vaxoini)) and (axo<parAxo  or (mes<=parMes and axo=parAxo))  ); 

                    -- elimina adeudos suspendidos
                    delete from ex_adeudo where ex_contrato_id=p_pubid and ( (axo>vaxoini  or (mes>=vmesini  and axo=vaxoini)) and (axo<parAxo  or (mes<=parMes and axo=parAxo)) );
				end if;

				if parModulo = 2 then
                    -- activa el contrato
					update pubmain set movto_cve = 'V'  where numesta = parNumesta;

                    -- suspende periodos
                    insert into pubadeudo_histo
                    select 0,fecha_at,id,pubmain_id,axo,mes,tipo,concepto,ade_importe,ade_descto,0,26,'SUSPENCION DE ADEUDO',today,0,'',0,0,0,0,0,id_usuario 
                    from pubadeudo where pubmain_id=p_pubid and ( (axo>vaxoini  or (mes>=vmesini  and axo=vaxoini)) and (axo<parAxo  or (mes<=parMes and axo=parAxo))  );
      
                    -- elimina adeudos suspendidos
                    delete from pubadeudo where pubmain_id=p_pubid and ( (axo>vaxoini  or (mes>=vmesini  and axo=vaxoini)) and (axo<parAxo  or (mes<=parMes and axo=parAxo))  );

				end if;
				
				RETURN 1, 'Se Cancel� la Suspensi�n de Servicios Satisfactoriamente', 0,0, Null, Null  with resume;
			else
				RETURN -1, 'El Estacionamiento tiene Estado desconocido, avisa al administrador', 0,0, Null, Null  with resume;
			end if;
		end if;
	else
		RETURN 1, 'El Estacionamiento NO tiene Suspensi�n de Servicios', 0,0, Null, v_fecha_mov  with resume;
	end if;
end if;	

END PROCEDURE;

create procedure "pgcabrer".sp_exc_adeudototal(paxo int, pmes int)
returning   int as id,
            int as no_esclusivo,
            char(1) as zona,
            decimal(5,2) as bateria,
            decimal(5,2) as cordon,
            char(1) as estatus,
            decimal(5,2) as factor,
            varchar(100) as propietario,
            varchar(100) as calle,
            varchar(50) as concepto,
            varchar(10) as periodoinicio,
            varchar(10) as periodofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;

define v_id, no_esclusivo, d_axo, d_mes, d_tipo, d_id_adeudo int;
define v_zona, v_estatus char(1);
define v_bateria, v_cordon, v_factor decimal(5,2);
define v_propietario, v_calle varchar(100);
define v_concepto, d_conc varchar(50);
define v_ade, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total money(18,2);
define d_adeudo, d_recargos, d_descto, d_actualizacion, d_multa money(18,2);
define v_per_inicio, v_per_final varchar(10);
            
foreach
  select a.id, a.no_exclusivo, a.zona, total_bateria, total_cordon, a.estatus, a.factor, b.propietario , c.concepto, nvl(sum(d.ade_importe),0),
   ((select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=28 and control_otr=a.id and clave_practicado='P' and vigencia='1')),u.calle  
   into v_id, no_esclusivo, v_zona, v_bateria, v_cordon, v_estatus, v_factor, v_propietario, v_concepto, v_ade, v_gastos, v_calle
   from ex_contrato a, ex_propietario b , ex_clasificacion c, ex_adeudo d, ex_ubicacion u
   where  a.ex_propietario_id  = b.id and a.estatus <> "C" and a.id_clasificacion in ( 1,3 ) 
   and u.ex_contrato_id=a.id and u.estatus='V'
   and c.id = a.id_clasificacion and  d.ex_contrato_id=a.id and (d.axo<paxo  or (d.mes<=pmes and d.axo=paxo)) 
   group by a.id, a.no_exclusivo, a.zona, total_bateria, total_cordon, estatus, a.factor, b.propietario , c.concepto, u.calle  
   order by c.concepto , a.no_exclusivo  

   let v_adeudo=0;
   let v_recargos=0; 
   let v_multa=0; 
   let v_actualizacion=0;
   let v_total=0;
   let v_per_inicio=''; 
   let v_per_final='';

   foreach
     execute procedure cajero_exc_detalle ( 2, v_id, paxo, pmes  ) into d_conc, d_axo, d_mes, d_adeudo, d_recargos, d_descto, d_tipo, d_id_adeudo, d_actualizacion, d_multa
     if v_per_inicio='' then
        let v_per_inicio=d_axo||' - '||d_mes;
     end if;
     let v_per_final=d_axo||' - '||d_mes;
     let v_adeudo = v_adeudo + d_adeudo;
     let v_recargos = v_recargos + d_recargos + d_descto;
     let v_multa = v_multa + d_multa;
     let v_actualizacion = v_actualizacion + d_actualizacion;
   end foreach;

   let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
   if v_adeudo>0 then
      return v_id, no_esclusivo, v_zona, v_bateria, v_cordon, v_estatus, v_factor, v_propietario, v_calle, v_concepto, v_per_inicio, v_per_final, 
                                        v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
   end if;
end foreach;

end procedure;

create procedure "pgcabrer".sp_pub_adeudototal(paxo int, pmes int)
returning   int as id,
            int as no_Publico,
            int as cupo,
            varchar(100) as propietario,
            varchar(100) as calle,
            varchar(06) as exterior,
            varchar(10) as periodoinicio,
            varchar(10) as periodofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;

define v_id, no_publico, d_axo, d_mes, v_cupo, d_id_adeudo int;
define v_zona, v_estatus char(1);
define v_bateria, v_cordon, v_factor decimal(5,2);
define v_propietario, v_calle varchar(100);
define v_concepto, d_conc varchar(50);
define v_ade, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total money(18,2);
define d_adeudo, d_recargos, d_descto, d_actualizacion, d_multa money(18,2);
define v_per_inicio, v_per_final varchar(10);
define v_numext varchar(6);

            
foreach
  select a.id, a.numesta, a.cupo, a.nombre, a.calle, a.numext, nvl(sum(d.ade_importe),0),
   ((select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=24 and control_otr=a.id and clave_practicado='P' and vigencia='1')) 
   into v_id, no_publico, v_cupo, v_propietario,v_calle, v_numext, v_ade, v_gastos
   from pubmain a, pubadeudo d
   where  a.fecha_baja is null and a.movto_cve<>'C'
    and  d.pubmain_id=a.id and (d.axo<paxo  or (d.mes<=pmes and d.axo=paxo)) 
   group by a.id, a.numesta, a.cupo, a.nombre, a.calle, a.numext 
   order by a.numesta  

   let v_adeudo=0;
   let v_recargos=0; 
   let v_multa=0; 
   let v_actualizacion=0;
   let v_total=0;
   let v_per_inicio=''; 
   let v_per_final='';

   foreach
     execute procedure cajero_pub_detalle ( 2, v_id, paxo, pmes  ) into d_conc, d_axo, d_mes, d_adeudo, d_recargos, d_actualizacion, d_multa
     if v_per_inicio='' then
        let v_per_inicio=d_axo||' - '||d_mes;
     end if;
     let v_per_final=d_axo||' - '||d_mes;
     let v_adeudo = v_adeudo + d_adeudo;
     let v_recargos = v_recargos + d_recargos;
     let v_multa = v_multa + d_multa;
     let v_actualizacion = v_actualizacion + d_actualizacion;
   end foreach;

   let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
   if v_adeudo>0 then
      return v_id, no_publico, v_cupo, v_propietario, v_calle, v_numext, v_per_inicio, v_per_final, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
   end if;
end foreach;

end procedure;

create procedure "pgcabrer".cajero_exc_detalle_rango ( p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning   varchar(50) as concepto,
int as axo,
int as mes,
money(12,2) as adeudo,
money(10,2) as recargos,
money(10,2) as descto_recgos,
int as tipo,
int as id_adeudo,
money(12,2) as actualizacion,
money(12,2) as multa;

define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto, v_msgmulta varchar(50) ;
define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);
define v_id_adeudo int;
define v_actualizacion, v_multa, v_muldesc money(12,2);
define v_diavenc int;

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

select fecha_descuento, day(fecha_recargos) into v_fecha_limite, v_diavenc from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then
        let mesvig = mesvig -1;
       end if;
   end if;
let per_recgos =  (axovig *100 )+mesvig;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;

if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;
SELECT axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio  FROM ta_contratos_status WHERE modulo = 1 AND id = p_pubid AND estado = 'S'; -- 1=Exclusivo, 2=P�blico
if v_mes_inicio = 1 then
Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;
if perio_susp < perio then
Let perio = perio_susp;
end if;

--let perio_susp = (v_axo_inicio *100 )+v_mes_inicio;
--if perio_susp < perio then
-- Let perio = perio_susp-1; -- trampa para que al momento de leer los adeudos sea <=
--end if;

-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
 
FOREACH
  SELECT CASE WHEN tipo <> 20 THEN axo || '00' ELSE axo || lpad(mes,2,'0') END, tipo, Axo, mes, (axo  * 100 )+ mes, concepto, ade_importe , id
    INTO agrupar, v_tipo, v_axo, v_mes, perioI, v_concepto1, v_adeudo, v_id_adeudo
  FROM ex_adeudo WHERE ex_contrato_id = p_pubid  AND (axo * 100 + mes) >= 202110 AND (axo * 100 + mes) <= perio
  ORDER BY 1,3,4

SELECT porcentaje INTO v_porc_recgos FROM ex_descrec WHERE ex_contrato_id = p_pubid
AND ((v_axo * 100)+v_mes) BETWEEN ((axoinicio * 100)+ mesinicio) AND ((axofin * 100)+mesfin) AND vigencia = 'V';

let v_descto_recgos = 0;
    if v_porc_recgos is null then
      let v_porc_recgos = 0;
    end if;
 
  if v_tipo = 20 then
    SELECT sum(porcentaje_mes) INTO v_porcentaje FROM recargos
      WHERE (axo * 100 + mes) BETWEEN  perioI AND per_recgos;
         
      if v_calrec = 0 then
      let v_porcentaje = 0;
      end if;

let v_recargos = (v_porcentaje * v_adeudo ) / 100;

        if v_recargos is null then
let v_recargos = 0;
        end if;

if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
        let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
        let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
    let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
    else
    let v_recargos = 0;
    let v_concepto = v_concepto1 || '  ' || v_adeudo;
  end if;

if (v_tipo = 26) or (v_tipo = 27) then
   execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
   let v_recargos =   v_recargos + v_recgos_ref;
   if v_porc_recgos > 0 and v_recargos > 0 then
      -- calcular descuento en recargos.
      let  v_descto_recgos = (v_recgos_ref * v_porc_recgos) / 100;
      let v_recargos =   v_recgos_ref - v_descto_recgos;
    end if;
end if;

let v_actualizacion=0;
--Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ; -- calculo anterior
execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;
if v_actualizacion < 0 then
   let v_actualizacion=0;
end if;
-- termina codigo nuevo inpc

-- calculo de multa
  let v_multa = 0;
  let v_muldesc=0;
  if exists (select * from parametros where exc_multa_adeven='S') then 
     if v_recargos > 0 then
        execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
        if v_multa >0 then
           -- calcula descuento multa
           let v_muldesc=0;
           execute PROCEDURE ex_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
        end if;
        let v_multa = v_multa - v_muldesc;
     end if;
  end if;
-- termina calculo de multa

RETURN v_concepto , v_axo , v_mes ,  v_adeudo , v_recargos , v_descto_recgos , v_tipo , v_id_adeudo, v_actualizacion, v_multa with resume;
END FOREACH;

end procedure;

create procedure "pgcabrer".sp_exc_adeudototal_rango(paxo int, pmes int)
returning   int as id,
            int as no_esclusivo,
            char(1) as zona,
            decimal(5,2) as bateria,
            decimal(5,2) as cordon,
            char(1) as estatus,
            decimal(5,2) as factor,
            varchar(100) as propietario,
            varchar(100) as calle,
            varchar(50) as concepto,
            varchar(10) as periodoinicio,
            varchar(10) as periodofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;

define v_id, no_esclusivo, d_axo, d_mes, d_tipo, d_id_adeudo int;
define v_zona, v_estatus char(1);
define v_bateria, v_cordon, v_factor decimal(5,2);
define v_propietario, v_calle varchar(100);
define v_concepto, d_conc varchar(50);
define v_ade, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total money(18,2);
define d_adeudo, d_recargos, d_descto, d_actualizacion, d_multa money(18,2);
define v_per_inicio, v_per_final varchar(10);
            
foreach
  select a.id, a.no_exclusivo, a.zona, total_bateria, total_cordon, a.estatus, a.factor, b.propietario , c.concepto, nvl(sum(d.ade_importe),0),
   ((select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=28 and control_otr=a.id and clave_practicado='P' and vigencia='1')),u.calle  
   into v_id, no_esclusivo, v_zona, v_bateria, v_cordon, v_estatus, v_factor, v_propietario, v_concepto, v_ade, v_gastos, v_calle
   from ex_contrato a, ex_propietario b , ex_clasificacion c, ex_adeudo d, ex_ubicacion u
   where  a.ex_propietario_id  = b.id and a.estatus <> "C" and a.id_clasificacion in ( 1,3 ) 
   and u.ex_contrato_id=a.id and u.estatus='V'
   and c.id = a.id_clasificacion and  d.ex_contrato_id=a.id 
   and ( d.axo>2021  or (d.mes>=10  and d.axo=2021)) 
   and (d.axo<paxo  or (d.mes<=pmes and d.axo=paxo)) 
   group by a.id, a.no_exclusivo, a.zona, total_bateria, total_cordon, estatus, a.factor, b.propietario , c.concepto, u.calle  
   order by c.concepto , a.no_exclusivo  

   let v_adeudo=0;
   let v_recargos=0; 
   let v_multa=0; 
   let v_actualizacion=0;
   let v_total=0;
   let v_per_inicio=''; 
   let v_per_final='';

   foreach
     execute procedure cajero_exc_detalle_rango ( 2, v_id, paxo, pmes  ) into d_conc, d_axo, d_mes, d_adeudo, d_recargos, d_descto, d_tipo, d_id_adeudo, d_actualizacion, d_multa
     if v_per_inicio='' then
        let v_per_inicio=d_axo||' - '||d_mes;
     end if;
     let v_per_final=d_axo||' - '||d_mes;
     let v_adeudo = v_adeudo + d_adeudo;
     let v_recargos = v_recargos + d_recargos + d_descto;
     let v_multa = v_multa + d_multa;
     let v_actualizacion = v_actualizacion + d_actualizacion;
   end foreach;

   let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
   if v_adeudo>0 then
      return v_id, no_esclusivo, v_zona, v_bateria, v_cordon, v_estatus, v_factor, v_propietario, v_calle, v_concepto, v_per_inicio, v_per_final, 
                                        v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
   end if;
end foreach;

end procedure;

create procedure "pgcabrer".sp_pub_adeudototal_rango(paxo int, pmes int)
returning   int as id,
            int as no_Publico,
            int as cupo,
            varchar(100) as propietario,
            varchar(100) as calle,
            varchar(06) as exterior,
            varchar(10) as periodoinicio,
            varchar(10) as periodofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;

define v_id, no_publico, d_axo, d_mes, v_cupo, d_id_adeudo int;
define v_zona, v_estatus char(1);
define v_bateria, v_cordon, v_factor decimal(5,2);
define v_propietario, v_calle varchar(100);
define v_concepto, d_conc varchar(50);
define v_ade, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total money(18,2);
define d_adeudo, d_recargos, d_descto, d_actualizacion, d_multa money(18,2);
define v_per_inicio, v_per_final varchar(10);
define v_numext varchar(6);

            
foreach
  select a.id, a.numesta, a.cupo, a.nombre, a.calle, a.numext, nvl(sum(d.ade_importe),0),
   ((select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=24 and control_otr=a.id and clave_practicado='P' and vigencia='1')) 
   into v_id, no_publico, v_cupo, v_propietario,v_calle, v_numext, v_ade, v_gastos
   from pubmain a, pubadeudo d
   where  a.fecha_baja is null and a.movto_cve<>'C'
    and  d.pubmain_id=a.id 
    and ( d.axo>2021  or (d.mes>=10  and d.axo=2021)) 
    and (d.axo<paxo  or (d.mes<=pmes and d.axo=paxo)) 
   group by a.id, a.numesta, a.cupo, a.nombre, a.calle, a.numext 
   order by a.numesta  

   let v_adeudo=0;
   let v_recargos=0; 
   let v_multa=0; 
   let v_actualizacion=0;
   let v_total=0;
   let v_per_inicio=''; 
   let v_per_final='';

   foreach
     execute procedure cajero_pub_detalle_rango ( 2, v_id, paxo, pmes  ) into d_conc, d_axo, d_mes, d_adeudo, d_recargos, d_actualizacion, d_multa
     if v_per_inicio='' then
        let v_per_inicio=d_axo||' - '||d_mes;
     end if;
     let v_per_final=d_axo||' - '||d_mes;
     let v_adeudo = v_adeudo + d_adeudo;
     let v_recargos = v_recargos + d_recargos;
     let v_multa = v_multa + d_multa;
     let v_actualizacion = v_actualizacion + d_actualizacion;
   end foreach;

   let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
   if v_adeudo>0 then
      return v_id, no_publico, v_cupo, v_propietario, v_calle, v_numext, v_per_inicio, v_per_final, v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
   end if;
end foreach;

end procedure;

create procedure "pgcabrer".cajero_pub_detalle_rango ( p_opc int , p_pubid int, p_axof int , p_mesf int  )
	returning	varchar(50) as concepto , 
		int as axo, 
		int as mes, 
		money(12,2) as adeudo, 
		money(10,2) as recargos,
        money(10,2) as actualizacion,
        money(10,2) as multa;

define axovig, v_diavenc int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ; define v_actualizacion money(12,2) ;
define v_muldesc, v_multa money(10,2);
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
define v_tipo int; define v_concepto1, v_msgmulta varchar(40);
define v_fecha_limite date;
define v_axo_inicio, v_mes_inicio, perio_susp int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;

define vv_status		int;		-- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda		varchar(50);	-- adicionado por Gil para generar registro de recargo 01/06/2018	

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

Let vv_status = 0;							-- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5';			-- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda;  	-- adicionado por Gil para generar registro de recargo 01/06/2018

select fecha_descuento, day(fecha_recargos) into v_fecha_limite, v_diavenc from db_ingresos:ta_11_fecha_desc where mes = mesvig;
	if v_fecha_limite > today then
      		let mesvig = mesvig -1;
   	end if;
	let per_recgos =  (axovig *100 )+mesvig;
	--let per_recgos = 201312;

	if p_opc = 2 then
		let axovig = p_axoF ;
		let mesvig = p_mesF;
	end if;

	if p_opc = 3 then
		let axovig = year(today) ;
		let mesvig = 12;
	end if;
	let perio = (axovig *100 )+mesvig;

-- adicionado para contratos en suspension 28/06/2022
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;
SELECT axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio  FROM ta_contratos_status WHERE modulo = 2 AND id = p_pubid AND estado = 'S'; -- 1=Exclusivo, 2=P�blico
if v_mes_inicio = 1 then
Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;
if perio_susp < perio then
Let perio = perio_susp;
end if;

FOREACH
select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
from pubadeudo where pubmain_id = p_pubid   and  (axo * 100 + mes) >= 202110  and  (axo * 100 + mes) <= perio 
order by 1,2,3

SELECT porcentaje INTO v_porc_recgos FROM pub_descrec WHERE pubmain_id = p_pubid
AND ((v_axo * 100)+v_mes) BETWEEN ((axoinicio * 100)+ mesinicio) AND ((axofin * 100)+mesfin) AND vigencia = 'V';

let v_descto_recgos = 0;
    if v_porc_recgos is null then
      let v_porc_recgos = 0;
    end if;

if v_tipo = 10 then
	select sum(porcentaje_mes) into v_porcentaje from recargos
     	where (axo * 100 + mes) between  perioI and per_recgos;

	let v_recargos = (v_porcentaje * v_adeudo ) / 100;
	if v_recargos is null then
       		let v_recargos = 0;
	end if;

if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
        let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
        let v_recargos =   v_recargos - v_descto_recgos;
    end if;

		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
else
	let v_recargos = 0;
	let v_concepto = v_concepto1 || '  ' || v_adeudo;
end if;

let v_actualizacion=0;
-- Let v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;  -- calculo anterior
execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;
if v_actualizacion < 0 then
   let v_actualizacion=0;
end if;
-- termina codigo nuevo inpc

-- calculo de multa
  let v_multa = 0;
  let v_muldesc=0;
  if exists (select * from parametros where pub_multa_adeven='S') then 
     if v_recargos > 0 then
        execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
        if v_multa >0 then
           -- calcula descuento multa
           let v_muldesc=0;
           execute PROCEDURE pub_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
        end if;
        let v_multa = v_multa - v_muldesc;
     end if;
  end if;
-- termina calculo de multa

return v_concepto , v_axo , v_mes ,  v_adeudo , v_recargos , v_actualizacion, v_multa with resume;

end foreach;
end procedure;

create function "pgcabrer".pub_generanotificacion(ppubd int, ppubh int, paxo int, pmes int, pmeses int, pimpd int, pimph int, p60 char(1))
returning   int as id,
            int as publico,
            int as zona,
            int as subzona,
            varchar(100) as propietario,
            varchar(100) as domicilio,
            varchar(6) as num_exterior,
            int as cupo,
            varchar(100) as categoria,
            varchar(10) as periodoinicio,
            varchar(10) as periodofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;  

define v_id, v_publico, v_zona, v_subzona, v_cupo, d_axo, d_mes, d_tipo, d_porc_multa int;
define v_next varchar(6);
define v_propietario, v_domicilio, v_categoria varchar(100);
define v_adeudo, v_adeudogrl, v_refrendo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total money(18,2); 
define d_adeudo, d_recargos, d_descto, d_id_adeudo, d_actualizacion, d_multa money(18,2);
define v_axo int;
DEFINE cust_qry LVARCHAR(2000);
DEFINE l_cust_num INTEGER;
define d_conc varchar(50);
define d_factor decimal(23,16);
define d_porc_act decimal(16,11);
define d_porc_rec decimal(5,2);
define v_per_inicio, v_per_final varchar(10);


let v_axo=0;
let v_adeudo=0; 
let v_adeudogrl=0;
let v_refrendo=0; 
let v_recargos=0; 
let v_multa=0; 
let v_actualizacion=0; 
let v_gastos=0; 
let v_total=0;

LET cust_qry = " select distinct a.id, a.numesta, a.zona, a.subzona, a.nombre, a.calle, a.numext, a.cupo, d.descripcion, nvl(sum(b.ade_importe),0), " 
   ||" ((select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=24 and control_otr=a.id and clave_practicado='P' and vigencia='1')) " 
   ||" from pubmain a, pubadeudo b, pubtipoadeudo c, pubcategoria d " 
   ||" where (a.numesta between "||ppubd||" and "||ppubh||") and a.fecha_baja is null and b.pubmain_id=a.id and c.tipo_id=b.tipo "
   ||" and d.id=a.pubcategoria_id and ((b.axo<"||paxo||") or (b.axo="||paxo||" and b.mes<="||pmes||")) "; 

LET cust_qry = cust_qry||" and a.id not in (select control_otr from db_ingresos:ta_15_apremios where diligencia = 'N' " 
   ||" and vigencia='1' and modulo=24 and (today-fecha_emision)<61) ";

--   //Cambio 5 Junio 2014 para que no salga notif durante los primeros 60 dias de ya practicado
--   //cambio 11/11/2014 donde valide si fec.prac es nula emita notificacion por correo
   if p60='S' then
      LET cust_qry = cust_qry||"   and ((a.id in (select unique r.control_otr from db_ingresos:ta_15_apremios r "
      ||"  where r.modulo = 24  and r.vigencia = '1' and (nvl((today-fecha_practicado),0)>60 or nvl((today-fecha_practicado),0)=0))) "
      ||"   or (a.id not in (select control_otr from db_ingresos:ta_15_apremios where modulo=24 and control_otr=a.id and vigencia='1'))) ";
   end if;

   LET cust_qry = cust_qry||" group by 1,2,3,4,5,6,7,8,9 " 
   ||" having ( (select (nvl(sum(ade_importe),0)) from pubadeudo where pubmain_id=a.id and ((axo<"||paxo||") or (axo="||paxo||" and mes<="||pmes||"))) between "||pimpd||" and "||pimph||") "
   ||" order by 2 ";

   PREPARE stmt_id FROM cust_qry;
   DECLARE cust_cur cursor FOR stmt_id;
   OPEN cust_cur ;

     WHILE (1 = 1)
        FETCH cust_cur into v_id, v_publico, v_zona, v_subzona, v_propietario, v_domicilio, v_next, v_cupo, v_categoria, v_adeudogrl, v_gastos;

        IF (SQLCODE != 100) THEN

       --    if (v_adeudo >= pimpd) and (v_adeudo <= pimph) then 
               
              let v_adeudo=0;
              let v_recargos=0; 
              let v_multa=0; 
              let v_actualizacion=0; 
              let v_total=0;
              let v_per_inicio=''; 
              let v_per_final='';  
              foreach
                 execute procedure notif_pub_detalle ( 2, v_id, paxo, pmes ) into d_conc, d_axo, d_mes, d_tipo, d_adeudo, d_recargos, d_porc_rec, d_descto, 
                                   d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa
                 if v_per_inicio='' then
                    let v_per_inicio=d_axo||' - '||d_mes;
                 end if;
                 let v_per_final=d_axo||' - '||d_mes;
                 let v_adeudo= v_adeudo + d_adeudo;
                 let v_recargos = v_recargos + d_recargos + d_descto;
                 let v_multa = v_multa + d_multa;
                 let v_actualizacion = v_actualizacion + d_actualizacion;
              end foreach;
              let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
              return v_id, v_publico, v_zona, v_subzona, v_propietario, v_domicilio, v_next, v_cupo, v_categoria, v_per_inicio, v_per_final, 
                                        v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
       --    end if;
        ELSE
           EXIT;
        END IF

     END WHILE
   CLOSE cust_cur;

   FREE cust_cur;
 
   FREE stmt_id;


end function;

create function "pgcabrer".ex_generanotificacion(pexcd int, pexch int, paxo int, pmes int, pmeses int, pimpd int, pimph int, p60 char(1))
returning   int as id,
            int as exclusivo,
            char(1) as zona,
            varchar(100) as propietario,
            varchar(100) as domicilio,
            varchar(100) as colonia,
            int as cordon,
            int as bateria,
            varchar(10) as periodoinicio,
            varchar(10) as periodofinal,
            money(18,2) as adeudo,
            money(18,2) as recargos,
            money(18,2) as multa,
            money(18,2) as actualizacion,
            money(18,2) as gastos,
            money(18,2) as total;  

define v_id, v_exclusivo, v_axo, d_axo, d_mes, d_tipo, d_porc_multa int;
define v_cordon, v_bateria decimal(5,2);
define v_propietario, v_domicilio, v_colonia varchar(100);
define v_adeudo, v_adeudogrl, v_refrendo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total money(18,2); 
define d_adeudo, d_recargos, d_descto, d_id_adeudo, d_actualizacion, d_multa money(18,2);
DEFINE cust_qry LVARCHAR(2000);
DEFINE l_cust_num INTEGER;
define v_zona char(1);
define d_conc varchar(50);
define d_factor decimal(23,16);
define d_porc_act decimal(16,11);
define d_porc_rec decimal(5,2);
define v_per_inicio, v_per_final varchar(10);


let v_axo=0;
let v_adeudo=0; 
let v_adeudogrl=0;
let v_refrendo=0; 
let v_recargos=0; 
let v_multa=0; 
let v_actualizacion=0; 
let v_gastos=0; 
let v_total=0;

LET cust_qry = " select distinct a.id, a.no_exclusivo, a.zona, d.propietario, e.calle, d.colonia, a.total_cordon, a.total_bateria, nvl(sum(b.ade_importe),0), " 
   ||" ((select (nvl(sum(importe_gastos),0)) from db_ingresos:ta_15_apremios where modulo=28 and control_otr=a.id and clave_practicado='P' and vigencia='1')) " 
   ||" from ex_contrato a, ex_adeudo b, ex_propietario d, ex_ubicacion e " 
   ||" where (a.no_exclusivo between "||pexcd||" and "||pexch||") and a.estatus in ('V','S') and b.ex_contrato_id=a.id "
   ||" and e.id=(select max(id) from ex_ubicacion where ex_contrato_id=a.id and estatus='V') " 
   ||" and d.id=a.ex_propietario_id and ((b.axo<"||paxo||") or (b.axo="||paxo||" and b.mes<="||pmes||")) "; 

LET cust_qry = cust_qry||" and e.ex_contrato_id=a.id and a.id not in (select control_otr from db_ingresos:ta_15_apremios where diligencia = 'N' " 
   ||" and vigencia='1' and modulo=28 and (today-fecha_emision)<61) ";

--   //Cambio 5 Junio 2014 para que no salga notif durante los primeros 60 dias de ya practicado
--   //cambio 11/11/2014 donde valide si fec.prac es nula emita notificacion por correo
   if p60='S' then
      LET cust_qry = cust_qry||"   and ((a.id in (select unique r.control_otr from db_ingresos:ta_15_apremios r "
      ||"   where r.modulo = 28  and r.vigencia = '1' and (nvl((today-fecha_practicado),0)>60 or nvl((today-fecha_practicado),0)=0) )) "
      ||"   or (a.id not in (select control_otr from db_ingresos:ta_15_apremios where modulo=28 and control_otr=a.id and vigencia='1'))) ";
   end if;

   LET cust_qry = cust_qry||" group by 1,2,3,4,5,6,7,8,10 " 
   ||" having ( (select (nvl(sum(ade_importe),0)) from ex_adeudo where ex_contrato_id=a.id and ((axo<"||paxo||") or (axo="||paxo||" and mes<="||pmes||"))) between "||pimpd||" and "||pimph||") "
   ||" order by 2 ";

   PREPARE stmt_id FROM cust_qry;
   DECLARE cust_cur cursor FOR stmt_id;
   OPEN cust_cur ;

     WHILE (1 = 1)
        FETCH cust_cur into v_id, v_exclusivo, v_zona, v_propietario, v_domicilio, v_colonia, v_cordon, v_bateria, v_adeudogrl, v_gastos;

        IF (SQLCODE != 100) THEN

       --    if (v_adeudo >= pimpd) and (v_adeudo <= pimph) then 
               
              let v_adeudo=0;
              let v_recargos=0; 
              let v_multa=0; 
              let v_actualizacion=0; 
              let v_total=0;
              let v_per_inicio=''; 
              let v_per_final='';  
              foreach
                 execute procedure notif_exc_detalle ( 2, v_id, paxo, pmes ) into d_conc, d_axo, d_mes, d_adeudo, d_recargos, d_porc_rec, d_descto, d_tipo, 
                                   d_id_adeudo, d_actualizacion, d_porc_act, d_factor, d_multa, d_porc_multa
                 if v_per_inicio='' then
                    let v_per_inicio=d_axo||' - '||d_mes;
                 end if;
                 let v_per_final=d_axo||' - '||d_mes;
                 let v_adeudo = v_adeudo + d_adeudo;
                 let v_recargos = v_recargos + d_recargos + d_descto;
                 let v_multa = v_multa + d_multa;
                 let v_actualizacion = v_actualizacion + d_actualizacion;
              end foreach;
              let v_total = v_adeudo + v_recargos + v_multa + v_actualizacion + v_gastos; 
              if v_adeudo >0 then
                 return v_id, v_exclusivo, v_zona, v_propietario, v_domicilio, v_colonia, v_cordon, v_bateria, v_per_inicio, v_per_final, 
                                        v_adeudo, v_recargos, v_multa, v_actualizacion, v_gastos, v_total with resume;
              end if;
       --    end if;
        ELSE
           EXIT;
        END IF

     END WHILE
   CLOSE cust_cur;

   FREE cust_cur ;
 
   FREE stmt_id ;


end function;

create procedure "pgcabrer".sp_exc_prescripcion(pid int, paxod int, pmesd int, paxoh int, pmesh int, pobs varchar(200), puser int, popc char(1) )
    returning   int as status,
                varchar(100) as msg;

define v_status, v_tipo int;
define v_msg varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1,'sp_exc_prescripcion ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION


if popc='P' then
   let v_tipo=15;
end if;

if (popc='C') or (popc='E') then
   let v_tipo=4;
end if;

if (popc='P') or (popc='C') or (popc='E') then
    -- prescribe los adeudos seleccionados
    insert into ex_adeudo_histo
    select 0,fecha_at,id,ex_contrato_id,axo,mes,tipo,concepto,ade_importe,ade_descto,0,0, v_tipo, pobs, today, 0, '', 0, 0, 0, 0, 0, puser
    from ex_adeudo where ex_contrato_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh))  ) 
    order by axo, mes;

    -- elimina los adeudos seleccionados 
    delete from  ex_adeudo where ex_contrato_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh)) ); 

return 0,'SE REALIZO CORRECTAMENTE EL MOVIMIENTO';
end if;

if popc='R' then
   -- genera adeudos seleccionados
   insert into ex_adeudo
   select 0,fecha_at,ex_contrato_id,axo,mes,tipo,concepto,ade_importe,ade_descto,id_usuario 
   from ex_adeudo_histo where ex_contrato_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh))  ); 

   -- elimina adeudos de historico
   delete from ex_adeudo_histo where ex_contrato_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh))  );

return 0,'SE GENERARON CORRECTAMENTE LOS ADEUDOS';
end if;
end procedure;

create procedure "pgcabrer".sp_pub_prescripcion(pid int, paxod int, pmesd int, paxoh int, pmesh int, pobs varchar(200), puser int, popc char(1) )
    returning   int as status,
                varchar(100) as msg;

define v_status, v_tipo int;
define v_msg varchar(100);
define v_lError     int;
define v_lISAMError int;
define v_vcMensaje  varchar(255);


ON EXCEPTION SET v_lError, v_lISAMError, v_vcMensaje
RETURN -1,'sp_pub_prescripcion ' || v_lError || ' ISAM: ' || v_lISAMError || ' ' || v_vcMensaje;
END EXCEPTION

if popc='P' then
   let v_tipo=15;
end if;

if (popc='C') or (popc='E') then
   let v_tipo=4;
end if;   

if (popc='P') or (popc='C') or (popc='E') then
    -- prescribe los adeudos seleccionados
    insert into pubadeudo_histo
    select 0, fecha_at, id, pubmain_id, axo, mes, tipo, concepto, ade_importe, ade_descto, 0, v_tipo, pobs, today, 0, '', 0, 0, 0, 0, 0, puser
    from pubadeudo where pubmain_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh))  ) 
    order by axo, mes;

    -- elimina los adeudos seleccionados 
    delete from pubadeudo where pubmain_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh))  ); 

return 0,'SE REALIZO CORRECTAMENTE EL MOVIMIENTO';
end if;

if popc='R' then
   -- genera adeudos seleccionados
   insert into pubadeudo
   select 0,fecha_at,pubmain_id,axo,mes,tipo,concepto,ade_importe,ade_descto,id_usuario 
   from pubadeudo_histo where pubmain_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh))  ); 

   -- elimina adeudos de historico
   delete from pubadeudo_histo where pubmain_id=pid
        and  ( (axo>paxod or (mes>=pmesd  and axo=paxod)) and
             ( axo<paxoh or (mes<=pmesh  and axo=paxoh))  );

return 0,'SE GENERARON CORRECTAMENTE LOS ADEUDOS';
end if;
end procedure;

create procedure "pgcabrer".fn_exc_multas(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning    money(10,2) as multa;
define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
 define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define agrupar char(6);
define v_calrec int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;
define v_recgos_ref  money(10,2);
define v_totrecgos money(10,2);
define v_id_adeudo int;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

let v_totrecgos = 0;
if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;
if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;
let perio = (axovig *100 )+mesvig;
select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if (v_fecha_limite ) > today then
     if mesvig > 1 then 
        let mesvig = mesvig -1;
       end if;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;
-- ver si se calculan los recargos o no por se nuevo.
   select 0 into v_calrec from ex_adeudo where ex_contrato_id = p_pubid and tipo = 21;
   if v_calrec is null then
      let v_calrec = 1;
   end if;
  
  FOREACH
  select case when tipo <> 20 then axo || '00' else axo || lpad(mes,2,'0') end ,tipo , Axo, mes, (axo  * 100 )+ mes , 
    concepto, ade_importe , id 
   into agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo , v_id_adeudo
  from ex_adeudo where ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,3,4

   select porcentaje into v_porc_recgos from ex_descmul where ex_contrato_id = p_pubid and ((v_axo * 100)+v_mes) between 
    ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
   let v_descto_recgos = 0;
   if v_porc_recgos is null then
     let v_porc_recgos = 0;
   end if;
  
 if v_tipo = 20 then
   select porc_multa_calc into v_porcentaje from parametros;
   if perioI>per_recgos then
      let v_porcentaje = 0;
   end if;
 
      if v_calrec = 0 then
     let v_porcentaje = 0;
      end if;
    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
       if v_recargos is null then
          let v_recargos = 0;
       end if;
        if v_porc_recgos > 0 and v_recargos > 0 then 
-- calcular descuento en recargos.
       let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
       let v_recargos =   v_recargos - v_descto_recgos;
    end if;
   
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
   if (v_tipo = 26) or (v_tipo = 27) then
     execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes) into v_recgos_ref;
     let v_recargos =   v_recargos + v_recgos_ref;
   end if;

 let v_totrecgos =  v_totrecgos + v_recargos ;
end foreach;

return  v_totrecgos ;
end procedure;

create procedure "pgcabrer".fn_pub_multas(p_opc int , p_pubid int, p_axof int , p_mesf int  )
returning    money(10,2) as multa;

define axovig int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
define v_tipo int; define v_concepto1 varchar(40);
define v_fecha_limite date;
define tot_recgos money(10,2);

let tot_recgos = 0;
let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

select fecha_descuento into v_fecha_limite from db_ingresos:ta_11_fecha_desc where mes = mesvig;
   if v_fecha_limite > today then
      let mesvig = mesvig -1;
   end if;
let per_recgos =  (axovig *100 )+mesvig;
--let per_recgos = 201312;

if p_opc = 2 then
let axovig = p_axoF ;
let mesvig = p_mesF;
end if;

if p_opc = 3 then
let axovig = year(today) ;
let mesvig = 12;
end if;

let perio = (axovig *100 )+mesvig;
  FOREACH
  select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
   into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
  from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio 
  order by 1,2,3
   if v_tipo = 10 then
   select porc_multa_calc into v_porcentaje from parametros;
   if perioI>per_recgos then
      let v_porcentaje = 0;
   end if;

    let v_recargos = (v_porcentaje * v_adeudo ) / 100;
    if v_recargos is null then
       let v_recargos = 0;
    end if;
   let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
   else
   let v_recargos = 0;
   let v_concepto = v_concepto1 || '  ' || v_adeudo;
 
   end if;
 let tot_recgos = tot_recgos + v_recargos;

end foreach;

return  tot_recgos ;
end procedure;

CREATE FUNCTION "informix".admin_encabezados_23(p_numesta int)

 returning
 varchar(92) as Nombre_completo,
 varchar(80) as calle,
 varchar(10) as No_ext,
 varchar(10) as No_int,
 varchar(50) as Colonia,
 varchar(10) as CP,
 varchar(13) as RFC,
 varchar(50) as Municipio,
 varchar(50) as Estado,
 varchar(18) as CURP,
 lvarchar(500) as descripcion,
 smallint as cartera,
 varchar(100) as mensaje,
 varchar(255) as piepagina,
 int as codigo_mensaje;

--returning int as codigo , int as idpublico , int as numesta,
--varchar(80)  as propietario  , varchar(80) as calle , varchar(40) as categoria , int as capacidad , varchar(100) as mensaje ;
define v_codigo int;
define v_id int;
define v_numesta int;
define v_nombre varchar(80);
define v_calle varchar(80);
define v_colonia varchar(80);
define v_descripcion varchar(40) ;
define v_cupo int;
define adeudo int;
define v_movto_cve char(1);
define v_numext char(5);
define v_rfc  char(15);
define v_multas, v_porcentaje, v_porc_rec int;
define v_imp_multa, v_descuento, v_desc_rec, v_desc_mul, v_imp_recargos money(18,2);
define v_estado_contrato varchar(100);  -- adicionado por Gil para contratos suspendidos 09/10/2019

let v_codigo = -1;
let v_id  = 0;
let v_numesta = 0;
let v_nombre = '';
let v_calle ='';
let v_descripcion = '' ;
let v_cupo =0;
let v_movto_cve ='';
let adeudo = 0;
let v_estado_contrato = '';

--select a.* , b.* from ex_contrato a , ex_propietario b where a.ex_propietario_id = b.id;
select nvl(a.id,0) , a.no_exclusivo, trim(b.propietario), trim(b.domicilio) , trim(b.colonia) , b.rfc , a.estatus
into v_id , v_numesta, v_nombre , v_calle  , v_colonia , v_rfc, v_movto_cve
from ex_contrato a , ex_propietario b where a.no_exclusivo = p_numesta and a.ex_propietario_id = b.id;

select count(*) into v_multas from ex_rel_multas where  ex_contrato_id = v_id and vigente = 'V';

if v_movto_cve = 'C' then
   Let v_estado_contrato = 'ESTACIONAMIENTO CANCELADO';
end if;
if v_movto_cve = 'N' then
   Let v_estado_contrato = 'ESTACIONAMIENTO CONVENIADO';
end if;
if v_movto_cve = 'S' then
   Let v_estado_contrato = 'ESTACIONAMIENTO SUSPENDIDO';
end if;
if v_movto_cve = 'V' then
   Let v_estado_contrato = 'ESTACIONAMIENTO VIGENTE';
end if;
if (v_movto_cve <> 'V') and (v_movto_cve <> 'C') and (v_movto_cve <> 'S') and (v_movto_cve <> 'N') then
   Let v_estado_contrato = 'ESTACIONAMIENTO CON ESTATUS DESCONOCIDO';
end if;

if v_id > 0 then
   if (v_movto_cve = 'C') OR (v_movto_cve = 'N') then
      return '' , '' , '' ,'', '' , '', '' , ' ' ,' ' , '',  ' ', 0 , v_estado_contrato , ' ' ,  -2;
   else
      select count(*) into adeudo from ex_adeudo where ex_contrato_id = v_id;
      if  adeudo > 0 then
          if v_multas = 0 then -- multas municipales
             let v_imp_multa=0; 
             let v_descuento=0;
             let v_porcentaje=0;
             let v_porc_rec=0;
             let v_desc_rec=0;
             let v_desc_mul=0; 
             if not exists( select * from ex_descmul where ex_contrato_id=v_id and vigencia='V') then
                if (today>=mdy(11,13,2023)) and (today<=mdy(11,24,2023)) then
                   let v_porcentaje=80;
                else
                   let v_porcentaje=0;
                end if;
             else
                select porcentaje into v_porcentaje from ex_descmul where ex_contrato_id=v_id and vigencia='V';
             end if;

             if not exists( select * from ex_descrec where ex_contrato_id=v_id and vigencia='V') then
                if (today>=mdy(11,13,2023)) and (today<=mdy(11,24,2023)) then
                   let v_porc_rec=75;
                else
                   let v_porc_rec=0;
                end if;
             else
                select porcentaje into v_porc_rec from ex_descrec where ex_contrato_id=v_id and vigencia='V';
             end if;
             execute procedure fn_exc_recargos(2 , v_id, year(today), month(today) ) into v_imp_recargos;
             execute procedure fn_exc_multas(2 , v_id, year(today), month(today) ) into v_imp_multa;
             let v_desc_mul = (v_imp_multa * v_porcentaje) / 100;
             let v_desc_rec = (v_imp_recargos * v_porcentaje) / 100;
             let v_descuento = v_desc_mul + v_desc_rec;

             if v_descuento>200000 then
                return '' , '' , '' ,'', '' , '', '' , ' ' ,' ' , '',  ' ', 0 , 'EL DESCUENTO EXCEDE DE 200 MIL' , ' ' ,  -2;
             else
                return v_nombre , v_calle , '' ,'', v_colonia , '', v_rfc , ' ' ,' ' , '',  ' ',1 , v_estado_contrato||' PROCEDE PARA PAGO' , ' ' ,  0;
             end if;
          else
             return v_nombre , v_calle , '' ,'', v_colonia , '', v_rfc , ' ' ,' ' , '',  ' ',1 , 
                    v_estado_contrato||' TIENE MULTAS MUNICIPALES, FAVOR DE SOLICITAR EL PAGO O ACLARACION' , ' ' ,  1;
          end if;
      else
          return v_nombre , v_calle ,'' ,'', v_colonia , '', '' , ' ' ,' ' , '',  ' ', 0 , v_estado_contrato||' SIN ADEUDO' , ' ' ,  -3;
      end if;
   end if
else
   return '' , '' ,'' ,'', '' , '', '' , ' ' ,' ' , '',  ' ', 0 , 'NO EXISTE ESTE ESTACIONAMIENTO' , ' ' ,  -1;
end if;

END function;

create procedure "informix".sp_exc_autorizacion( p_no_exclusivo  int, p_axo int, p_mes_inicial int, p_placa char(1), p_baliza char(1) , p_forma char(1) ,  p_userid int) 

returning
int as id,
char(50) as mensaje;
define v_opc int ;
 define v_descrip char(50);
 define v_adeudo money(12,2)     ;
 define v_adeudo_bat money(12,2)     ;
 define v_adeudo_cord money(12,2)     ;
 define v_importe money(12,2)     ;
 define v_importe_placa money(12,2)     ;
 define v_importe_baliza money(12,2)     ;
 define v_importe_forma money(6,2)     ;
  define  v_cupo  int; 
  define v_pubcategoria_id int;
  define v_axo int; define v_mes int;     define v_mes1 int;     define v_mes2 int;
  define v_res int ; define v_res1 char(50);
  define v_concepto varchar(40);
  define fecha_dato  date;
  define v_bateria decimal(6,2);
  define v_cordon decimal(6,2);
  define v_factor decimal(6,2);
  define v_metros decimal(6,2);
  define v_zona char(1);
  define v_tipo_adeudo int;
   define v_idcat int;
   define v_categoria char(2);
   define v_cant_meses  int;
define v_contrato_id int;

  select id into v_contrato_id from ex_contrato where no_exclusivo = p_no_exclusivo ;
  let v_opc =0;

  let v_descrip = 'Folio Grabado Correctamente';
 
   let v_tipo_adeudo = 21;
   let v_cant_meses = 13 - p_mes_inicial;

if exists(select id from ex_adeudo where ex_contrato_id = v_contrato_id and axo = p_axo
      and tipo = v_tipo_adeudo ) then 
    let v_opc = -1;
    let v_descrip = 'Ya existe este adeudo';
else
  -- obtener datos de calculo
 --select * from ex_contrato
 select   factor, zona , total_bateria + total_cordon  into  v_factor , v_zona , v_metros
            from ex_contrato where id = v_contrato_id;
 let fecha_dato = mdy(p_mes_inicial,1,p_axo);
 -- Valor de Bateria
  let v_categoria = 'A' || v_zona;
  select id into v_idcat from pubcategoria where tipo = 'E' and categoria = v_categoria;

  select importe  into v_importe from pubcatimporte   where pubcategoria_id =  v_idcat
       and fecha_dato between fecha_inicio and fecha_fin ;
     if v_importe is null then
        let v_importe = 0;
     end if;

-- importe de costo de placa
select importe  into v_importe_placa from pubcatimporte   where pubcategoria_id =  23
       and fecha_dato between fecha_inicio and fecha_fin ;
     if v_importe_placa is null then
        let v_importe_placa = 0;
     end if;
-- importe de costo de balizamiento
select importe  into v_importe_baliza from pubcatimporte   where pubcategoria_id =  24
       and fecha_dato between fecha_inicio and fecha_fin ;
     if v_importe_baliza is null then
        let v_importe_baliza = 0;
     else
        let v_importe_baliza = v_importe_baliza * v_metros;
     end if;
-- importe de costo de forma
select importe  into v_importe_forma from pubcatimporte   where pubcategoria_id =  25
       and fecha_dato between fecha_inicio and fecha_fin ;
     if v_importe_forma is null then
        let v_importe_forma = 0;
     end if;

  if v_factor <> 100 then
   let  v_adeudo = (v_importe/12) * v_cant_meses  * v_factor;
   let v_importe_baliza =  v_importe_baliza * v_factor;
  else
   let  v_adeudo = (v_importe/12) * v_cant_meses  ;
   end if;
let v_concepto = 'Autorizacion por el A�o .' || p_axo;
 


if v_factor <> 0 then
 -- Autorizacion
   insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,v_contrato_id, p_axo , p_mes_inicial, v_tipo_adeudo , v_concepto , v_adeudo , 0,p_userid);
-- Placa
   if p_placa ='S' then
   insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,v_contrato_id, p_axo , p_mes_inicial, 23 , 'Costo de emplacamiento ' , v_importe_placa , 0,p_userid);
   end if;
-- Balizamiento
  if p_baliza = 'S' then
   insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,v_contrato_id, p_axo , p_mes_inicial, 24 , 'Cobro Balizamiento '|| v_metros || ' mts' , v_importe_baliza , 0,p_userid);
  end if;
 if p_forma ='S' then
   insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,v_contrato_id, p_axo , p_mes_inicial, 25 , 'Forma de Incio ' , v_importe_forma , 0,p_userid);
  end if;
   end if;
if v_factor = 0 then
 -- Placa
   if p_placa ='S' then
   insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,v_contrato_id, p_axo , p_mes_inicial, 23 , 'Costo de emplacamiento ' , v_importe_placa , 0,p_userid);
   end if;

 if p_forma ='S' then
   insert into ex_adeudo (id, fecha_at , ex_contrato_id , axo , mes ,tipo, concepto, ade_importe, ade_descto, id_usuario)
             values (0,today,v_contrato_id, p_axo , p_mes_inicial, 25 , 'Forma de Incio ' , v_importe_forma , 0,p_userid);
   end if;
 end if;


let v_opc =0;
 let v_descrip = 'Adeudo Generado correctamente';
end if;

 -- opc 1 para generar adeudos por periodo 


return v_opc , v_descrip ;

END PROCEDURE;

CREATE FUNCTION "pgcabrer".admin_adeudos_detalle_23odoo( p_opc int , pnumesta int, p_axof int , p_mesf int  )
returning
-- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
int as rubro,
int as concepto,
int as cta,
varchar(30) as referencia,
varChar(120) as descripcion,
decimal(12,2) as monto,
decimal(12,2) as acumulado;
 
-- se agrega procedimeinto para descuentos automaticos 11/11/2021 Benita Cabrera Toscano.
-- se agrega calculo de multa 31/01/2022 Benita Cabrera Toscano.

define axovig, v_porcmul, v_axog, v_mesg, v_folreq int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto, v_msgmulta varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
define v_cuentaapl int ; define v_tipochar varchar(40); define v_otros money(15,2);
define v_fecha_limite date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
define p_pubid int;
define agrupar char(6);
define v_tipo, v_diavenc int;
define no_recargos int;
define v_porc_recgos decimal(5,2);define v_descto_recgos money(15,2);
define v_actualizacion decimal(18,2);
define v_gastost, v_gastos, v_multa, v_muldesc money(18,2);
define v_fecemi date;

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018
define v_axo_inicio, v_mes_inicio, perio_susp int; -- adicionado por Gil para contratos en suspension 09/10/2019
define v_total_bateria, v_total_cordon decimal(5,2); -- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
define v_cuentaapl_odoo int;
define v_diashabiles int;

Let v_cuentaapl_odoo = 0;
begin
    on exception in (-958)
delete from tmp_exclusivos;
    end exception;
    create temp table tmp_exclusivos(
orden  smallint,
id_exc  int ,
axo int,
mes int,
imp_pagar  money(12,2) ,
cta_aplicacion int,
referencia varchar(30),
concepto   varChar(120)
    ) with no log;
end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
let v_gastost=0;
let v_muldesc=0;
let v_diavenc=0;
let v_msgmulta='';
let v_multa=0;
let v_porcmul=0;
--set debug file to 'Exclusivo.log';
--trace on;

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

-- v_total_bateria, v_total_cordon variables adicionadas para saber la cuenta de aplicacion correspondiente
select id, total_bateria, total_cordon into p_pubid, v_total_bateria, v_total_cordon from ex_contrato where no_exclusivo = pnumesta;

select fecha_descuento, day(fecha_recargos) into v_fecha_limite, v_diavenc from db_ingresos:ta_11_fecha_desc where mes = mesvig;
if 	v_fecha_limite > today then
    let mesvig = mesvig -1;
end if;


--execute procedure db_ingresos:get_diashabiles(MDY(month(today),1,year(today)),today) into v_diashabiles;
--if v_diashabiles <= 5 then
--    let mesvig = mesvig -1;
--end if;

let per_recgos =  (axovig *100 )+ mesvig;

if 	p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

let perio = (axovig *100 )+mesvig;
let v_otros = 0;
let v_acumulado  = 0;
let no_recargos = 0;

if (p_axof=year(today)) and (p_mesf=12) then
    execute procedure ex_descautomaticos(p_pubid, p_axof, p_mesf,'A'); -- procedimiento actual para multa calculada
else
    execute procedure ex_descautomaticos(p_pubid, p_axof, p_mesf,'B'); -- procedimiento actual para multa calculada
end if;

-- adicionado por Gil para contratos en suspension 09/10/2019
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;

SELECT 	axo_inicio, mes_inicio 
INTO 	v_axo_inicio, v_mes_inicio  
FROM 	ta_contratos_status 
WHERE 	modulo = 1 
AND 	id = p_pubid and estado='S'; -- 1=Exclusivo, 2=P�blico

if 	v_mes_inicio = 1 then
	Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
	Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;

if 	perio_susp < perio then
	Let perio = perio_susp;
end if;

-- ********** empieza gastos nuevo para notificaciones 28/01/2022
foreach
  select b.fecha_emision, nvl(b.folio,0), nvl(b.importe_multa,0), nvl(importe_gastos,0), nvl(b.porcentaje_multa,0)
  into v_fecemi, v_folreq, v_multa, v_gastos, v_porcmul
  from db_ingresos:ta_15_apremios b
  where b.modulo=28 and b.control_otr=p_pubid and b.vigencia='1' and b.clave_practicado='P'
  order by  1,2
  let v_gastost=v_gastost+v_gastos;
end foreach;

-- para sacar el a�o minimo
select  min(axo) into v_axog from ex_adeudo where ex_contrato_id=p_pubid;
-- para sacar el mes minimo      
select min(mes) into v_mesg  from ex_adeudo where ex_contrato_id=p_pubid and axo=v_axog;

if v_gastost>0 then
   let v_acumulado = v_acumulado + v_gastost;
   insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto ) 
    values(0, p_pubid, v_axog, v_mesg, v_gastost, 454001, v_axog||'-'||lpad(v_mesg,2,'0'), 'GASTOS '||v_folreq);
end if;

if exists (select * from parametros where exc_multa_adeven='N') then
   if v_multa>0 then
      let v_acumulado = v_acumulado + v_multa;
      insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto ) 
       values(0, p_pubid, v_axog, v_mesg, v_multa, 452001, v_axog||'-'||lpad(v_mesg,2,'0'), 'MULTA 1'||v_folreq);
   end if;
   if v_porcmul <>100 then
      let v_muldesc=(v_multa*v_porcmul)/100;
      if v_muldesc >0 then
         let v_muldesc=v_muldesc*-1;
         let v_acumulado = v_acumulado + v_muldesc;
         insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto ) 
          values(0, p_pubid, v_axog, v_mesg, v_muldesc, 452901, v_axog||'-'||lpad(v_mesg,2,'0'), 'DESCUENTO MULTA '||v_folreq);
      end if; 
   end if;
else
   let v_multa=0;
   let v_muldesc=0;
end if;
-- ********** termina rutina para gastos y multas si son por notificacion

FOREACH
	select 	b.cuentaapl, b.tipo , a.axo , a.mes ,(axo  * 100 )+ mes ,  a.concepto ,  a.ade_importe
	into 	v_cuentaapl , v_tipochar, v_axo , v_mes , perioi , v_concepto , v_adeudo
	from 	ex_adeudo a, pubtipoadeudo b
	where 	ex_contrato_id = p_pubid  and  (axo * 100 + mes) <= perio
	and 	a.tipo <> 20 and a.tipo = b.tipo_id  
	order 	by a.axo , a.mes
 
	if 	v_cuentaapl = 370700001 then
		let no_recargos = 1;
	end if;

    if  p_pubid =1914 then
        let no_recargos = 0;
    end if;
    	
	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
	let v_acumulado = v_acumulado + v_adeudo;
    insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion,referencia ,concepto )
    values(1, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl , v_referencia , v_concepto );
	--return 0 ,0 , v_cuentaapl, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
	if  v_cuentaapl = 370710002 then
		-- calcula recargos de refrendo
        execute procedure fn_exc_calcrecgos_ref( p_pubid , v_axo , v_mes ) into v_recargos;
		-- porcentaje de descuento
        -- calcula recargos de refrendo
        select 	porcentaje 
		into 	v_porc_recgos 
		from 	ex_descrec 
		where 	ex_contrato_id = p_pubid 
		and 	((v_axo * 100)+v_mes) between
        ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
        let v_descto_recgos = 0;
        if 	v_porc_recgos is null then
			let v_porc_recgos = 0;
		end if;
        if 	v_porc_recgos > 0 and v_recargos > 0 then
			-- calcular descuento en recargos.
            let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
		end if;
        if p_pubid in (1838) and ( (v_axo = 2023 and v_mes >= 7) or (v_axo = 2024 and v_mes <= 7) )  then
                    let v_recargos = 0;
                end if;

        if 	v_recargos > 0 then		-- + Actualizacion 
			let v_acumulado = v_acumulado + v_recargos;
            let v_concepto1 = 'Recargos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);
			--   return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			--Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ; -- calculo anterior
            execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion; 
            if v_actualizacion > 0 then
			   let v_acumulado = v_acumulado + v_actualizacion;
               let v_concepto1 = 'Actualizaci�n ' || v_concepto;
               insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                values(1, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
	        end if;	

            if exists (select * from parametros where exc_multa_adeven='S') then
               -- calcula multa
               let v_multa = 0;
               execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
               if v_multa >0 then
                  let v_acumulado = v_acumulado + v_multa;
                  let v_concepto1 = 'Multa 2' || v_concepto;
                  insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                   values(1, p_pubid, v_axo ,v_mes,  v_multa, 452001, v_referencia , v_concepto1); 
               end if;
               -- calcula descuento multa
               let v_muldesc=0;
               execute PROCEDURE ex_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
               if v_muldesc>0 then
                  let v_muldesc = v_muldesc*-1;
                  let v_acumulado = v_acumulado + v_muldesc;
                  let v_concepto1 = 'Descto Multa ' || v_concepto;
                  insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                   values(1, p_pubid, v_axo ,v_mes,  v_muldesc, 452901, v_referencia , v_concepto1);
               end if;
            end if;

        end if;

		if 	(v_recargos > 0) and (v_descto_recgos <> 0) then
			let v_acumulado = v_acumulado + v_descto_recgos;
            let v_concepto1 = 'Descto Recgos ' || v_concepto;
            insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(1, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1); -- para leyenda
			-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
        end if;

	end if;
	
END FOREACH;
--
FOREACH
	select  axo || lpad(mes,2,'0')  , tipo , Axo, mes, (axo  * 100 )+ mes ,concepto, ade_importe
	into 	agrupar , v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
	from 	ex_adeudo 
	where 	ex_contrato_id = p_pubid 
	and  	tipo = 20 
	and  	(axo * 100 + mes) <= perio
	order 	by 1,3,4

	select 	porcentaje 
	into 	v_porc_recgos 
	from 	ex_descrec
	where 	ex_contrato_id = p_pubid 
	and 	((v_axo * 100)+v_mes) between ((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
	let v_descto_recgos = 0;
	if 	v_porc_recgos is null then
		let v_porc_recgos = 0;
	end if;
	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');

	if 	v_tipo = 20 then
   	        select 	sum(porcentaje_mes) 
		into 	v_porcentaje from recargos
		where 	(axo * 100 + mes) between  perioI and per_recgos; 
                

		let v_recargos = (v_porcentaje * v_adeudo ) / 100;
		if 	v_recargos is null then
			let v_recargos = 0;
		end if;
                if year(today) = p_axof then
                   if v_axo = year(today) and p_mesf = 12 and month(today)<=2 then
                      let v_recargos = 0;
                   else
                      if v_axo = year(today) and today <= v_fecha_limite and v_mes = month(today) then
                         let v_recargos = 0;
                      end if;
                   end if;
                end if;
        if 	v_porc_recgos > 0 and v_recargos > 0 then
			-- calcular descuento en recargos.
			let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
			--    let v_recargos =   v_recargos - v_descto_recgos;
		end if;
   
		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
	else
		let v_recargos = 0;
		let v_concepto = v_concepto1 || '  ' || v_adeudo;
	end if;

	--  totales
    if 	v_axo = year(today) then
		if 	(v_total_bateria > 0) and (v_total_cordon > 0) then
			-- actual
			Let v_cuentaapl_odoo = 230000001;
		else
			-- actual
			if 	v_total_cordon > 0 then
				-- cordon
				Let v_cuentaapl_odoo = 230000001;
			else
				-- bateria
				Let v_cuentaapl_odoo = 230000002;
			end if;
		end if;

		let v_cuota = v_cuota + v_adeudo;
		let v_rectot = v_rectot + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto )
			values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            -- values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364100000, v_referencia , v_concepto);
			-- return 0 ,0 , 364100000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
		end if;
        -- quietar la validaci�n al despues de cobrar
        if  p_pubid =1914 then
            let no_recargos = 0;
        end if;

		if 	no_recargos = 1  then
			let v_recargos = 0;
            let v_descto_recgos = 0;
        end if;

                if p_pubid in (1838) and ( (v_axo = 2023 and v_mes >= 7) or (v_axo = 2024 and v_mes <= 7) )  then
                    let v_recargos = 0;
                end if;
------ ELIMINAR DESPUES DEL PAGO AGREGADO 02/09/2024---------------------------------------------------------------------
        if  p_pubid in (1838)and ((v_axo = 2024 and v_mes = 8) or (v_axo = 2024 and v_mes = 9)) then
          let v_recargos = 0;
        end if;
-----------------------------------------------------------------------------------------------------------------------
 


		if 	v_recargos > 0 then		-- + Actualizacion
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
     
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
			values(3, p_pubid, v_axo ,v_mes,  v_recargos, 390700000, v_referencia , v_concepto1);	
			-- return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			--Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ; -- calculo anterior
            execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;

------ ELIMINAR DESPUES DEL PAGO AGREGADO 02/09/2024---------------------------------------------------------------------
        if  p_pubid in (1838)and ((v_axo = 2024 and v_mes = 8) or (v_axo = 2024 and v_mes = 9)) then
          let v_actualizacion = 0;
        end if;
-----------------------------------------------------------------------------------------------------------------------

                 if v_actualizacion > 0 then
			let v_acumulado = v_acumulado + v_actualizacion;
                        let v_concepto1 = 'Actualizaci�n ' || v_concepto;
                        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                        values(3, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
		    end if;

            if exists (select * from parametros where exc_multa_adeven='S') then
               -- calcula multa
               let v_multa = 0;
               execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;


------ ELIMINAR DESPUES DEL PAGO AGREGADO 02/09/2024---------------------------------------------------------------------
        if  p_pubid in (1838)and ((v_axo = 2024 and v_mes = 8) or (v_axo = 2024 and v_mes = 9)) then
          let v_multa = 0;
        end if;
-----------------------------------------------------------------------------------------------------------------------



               if v_multa >0 then
                  let v_acumulado = v_acumulado + v_multa;
                  let v_concepto1 = 'Multa 3' || v_concepto;
                  insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                   values(3, p_pubid, v_axo ,v_mes,  v_multa, 452001, v_referencia , v_concepto1); 
               end if;
               -- calcula descuento multa
               let v_muldesc=0;
               execute PROCEDURE ex_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
               if v_muldesc>0 then
                  let v_muldesc = v_muldesc*-1;
                  let v_acumulado = v_acumulado + v_muldesc;
                  let v_concepto1 = 'Descto Multa ' || v_concepto;
                  insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                   values(4, p_pubid, v_axo ,v_mes,  v_muldesc, 452901, v_referencia , v_concepto1);
               end if;
            end if;
			
		end if;
		
		if 	(v_recargos > 0) and (v_descto_recgos <> 0) then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1); -- para leyenda 
			-- return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
    else
		if 	(v_total_bateria > 0) and (v_total_cordon > 0) then
			-- rezago
			Let v_cuentaapl_odoo = 230000003;
		else
			-- rezago
			if 	v_total_cordon > 0 then
				-- cordon
				Let v_cuentaapl_odoo = 230000003;
			else
				-- bateria
				Let v_cuentaapl_odoo = 230000004;
			end if;
		end if;

		let v_cuota_r = v_cuota_r + v_adeudo;
		let v_rectot_r = v_rectot_r + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(2, p_pubid, v_axo ,v_mes,  v_adeudo, v_cuentaapl_odoo, v_referencia , v_concepto);
            -- values(2, p_pubid, v_axo ,v_mes,  v_adeudo, 364130000, v_referencia , v_concepto);
			-- return 0 ,0 , 364130000, v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
		end if;
		if 	no_recargos = 1 then
			let v_recargos = 0;
            let v_descto_recgos = 0;
		end if;

            if p_pubid in (1838) and ( (v_axo = 2023 and v_mes >= 7) or (v_axo = 2024 and v_mes <= 7) )  then
                    let v_recargos = 0;
                end if;

		if 	v_recargos > 0 then		-- + Actualizacion
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(3, p_pubid, v_axo ,v_mes, v_recargos, 390700000, v_referencia , v_concepto1);
			-- return 0 ,0 , 390700000, v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc Actualizacion 	
			--Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ; -- calculo anterior
            execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;

                 if v_actualizacion > 0 then
			let v_acumulado = v_acumulado + v_actualizacion;
                        let v_concepto1 = 'Actualizaci�n ' || v_concepto;
                        insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                        values(3, p_pubid, v_axo ,v_mes,  v_actualizacion, 459101, v_referencia , v_concepto1);
			-- Termina codigo nuevo inpc Actualizacion
	         end if;

            if exists (select * from parametros where exc_multa_adeven='S') then
               -- calcula multa
               let v_multa = 0;
               execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;

               if v_multa >0 then
                  let v_acumulado = v_acumulado + v_multa;
                  let v_concepto1 = 'Multa 4 ' || p_pubid || ' ' || v_concepto;
                  insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                   values(3, p_pubid, v_axo ,v_mes,  v_multa, 452001, v_referencia , v_concepto1); 
               end if;
               -- calcula descuento multa
               let v_muldesc=0;
               execute PROCEDURE ex_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
               if v_muldesc>0 then
                  let v_muldesc = v_muldesc*-1;
                  let v_acumulado = v_acumulado + v_muldesc;
                  let v_concepto1 = 'Descto Multa ' || v_concepto;
                  insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
                   values(4, p_pubid, v_axo ,v_mes,  v_muldesc, 452901, v_referencia , v_concepto1);
               end if;
            end if;

		end if;

		if 	(v_recargos > 0) and (v_descto_recgos <> 0) then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_exclusivos (orden, id_exc , axo , mes , imp_pagar , cta_aplicacion ,referencia ,concepto)
            values(4, p_pubid, v_axo ,v_mes,  v_descto_recgos, 390650000, v_referencia , v_concepto1);
			--  return 0 ,0 , 390650000, v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;

	end if;

END FOREACH;

let v_acumulado = 0 ;
FOREACH
	select 	cta_aplicacion , referencia , concepto , imp_pagar
	into 	v_cuentaapl, v_referencia , v_concepto , v_cuota
	from 	tmp_exclusivos 
	order 	by axo , mes, orden

	let v_acumulado = v_acumulado + v_cuota;
	return 0 , v_cuentaapl, get_odoo_cta(  v_cuentaapl  ,23), v_referencia , v_concepto, v_cuota, v_acumulado  with resume;
END FOREACH;

--trace off;
end function
;

CREATE FUNCTION "informix".admin_adeudos_detalle_19odoo ( p_opc int , pnumesta int, p_axof int , p_mesf int  )
returning
-- Rubro, Concepto ,  cta aplicacion  - referencia -   descripcion  -       importe , acumulado;
int as rubro,
int as concepto,
int as cta,
varchar(30) as referencia,
varChar(120) as descripcion,
decimal(12,2) as monto,
decimal(12,2) as acumulado;

-- se agrega procedimeinto para descuentos automaticos 11/11/2021 Benita Cabrera Toscano.

define axovig, v_diavenc, v_axog, v_mesg, v_folreq, v_porcmul int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ;
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50);  define v_concepto1 varchar(50);
define v_cuota money(12,2); define v_rectot money(12,2);
define v_cuota_r money(12,2); define v_rectot_r money(12,2);
define total money(15,2); define totals money(15,2); define r_Imp_Rdeo money(5,2);
define v_cuentaapl int ; define v_tipochar, v_msgmulta varchar(40); define v_otros money(15,2);
define v_fecha_limite, v_fecemi date;
define v_referencia char(30);
define v_acumulado decimal(12,2);
define p_pubid, v_axo_inicio, v_mes_inicio, perio_susp int;
define v_porc_recgos int;
define v_descto_recgos money(15,2);
define v_fec_ini_cobra_rgos date;
define v_pubcategoria_id int; -- adicionado por Gil para generar registro por categoria de estacionamiento
define v_actualizacion, v_multa, v_gastos, v_gastost, v_muldesc decimal(18,2);

define vv_status int; -- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda varchar(50); -- adicionado por Gil para generar registro de recargo 01/06/2018

begin
    on exception in (-958)
delete from tmp_publicos;
    end exception;
    create temp table tmp_publicos( orden  smallint,id_pub  int ,axo int,mes int,imp_pagar  money(12,2) ,cta_aplicacion int ) with no log;
end;

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);
let v_cuota = 0;
let v_rectot =0;
let v_cuota_r = 0;
let v_rectot_r =0;
let v_gastost=0;
let v_muldesc=0;
let v_diavenc=0;
let v_msgmulta='';
let v_multa=0;
let v_porcmul=0;

Let vv_status = 0; -- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5'; -- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda; -- adicionado por Gil para generar registro de recargo 01/06/2018

--select *  from pubmain where numesta = 1320;
select 	pubcategoria_id 
into 	v_pubcategoria_id 
from 	pubmain 
where 	numesta = pnumesta;

select 	id , fecha_inicial + 6 
into 	p_pubid , v_fec_ini_cobra_rgos 
from 	pubmain 
where 	numesta = pnumesta;

select 	fecha_descuento, day(fecha_recargos) 
into 	v_fecha_limite, v_diavenc 
from 	db_ingresos:ta_11_fecha_desc 
where 	mes = mesvig;
if 	v_fecha_limite > today then
	let mesvig = mesvig -1;
end if;

let per_recgos =  (axovig *100 )+mesvig;

if 	p_opc = 2 then
	let axovig = p_axoF ;
	let mesvig = p_mesF;
end if;

let 	perio = (axovig *100 )+mesvig;
let 	v_otros = 0;
let 	v_acumulado  = 0;

if ((p_axof=year(today)) and (p_mesf=12)) then
    execute procedure pub_descautomaticos(p_pubid, p_axof, p_mesf,'A'); -- procedimiento actual para multa calculada
else
    execute procedure pub_descautomaticos(p_pubid, p_axof, p_mesf,'B'); -- procedimiento actual para multa calculada
end if;

-- adicionado para contratos en suspension 29/06/2022
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;

SELECT 	axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio FROM ta_contratos_status 
WHERE 	modulo = 2 AND 	id = p_pubid and estado='S'; -- 1=Exclusivo, 2=P�blico

if 	v_mes_inicio = 1 then
	Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
	Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;

if 	perio_susp < perio then
	Let perio = perio_susp;
end if;

-- ********** empieza gastos nuevo para notificaciones 7/03/2022
foreach
  select b.fecha_emision, nvl(b.folio,0), nvl(b.importe_multa,0), nvl(importe_gastos,0), nvl(b.porcentaje_multa,0)
  into v_fecemi, v_folreq, v_multa, v_gastos, v_porcmul
  from db_ingresos:ta_15_apremios b
  where b.modulo=24 and b.control_otr=p_pubid and b.vigencia='1' and b.clave_practicado='P'
  order by  1,2
  let v_gastost=v_gastost+v_gastos;
end foreach;

-- para sacar el a�o minimo
select  min(axo) into v_axog from pubadeudo where pubmain_id=p_pubid;
-- para sacar el mes minimo      
select min(mes) into v_mesg  from pubadeudo where pubmain_id=p_pubid and axo=v_axog;

if v_gastost>0 then
   let v_acumulado = v_acumulado + v_gastost;
   insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion ) 
    values(0, p_pubid, v_axog, v_mesg, v_gastost, 454011);
   return 0 ,454011, 454011, v_axog||'-'||lpad(v_mesg,2,'0') , 'GASTOS '||v_folreq, v_gastost, v_acumulado  with resume;
end if;

if exists (select * from parametros where pub_multa_adeven='N') then
   if v_multa>0  then
      let v_acumulado = v_acumulado + v_multa;
      insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion ) 
       values(0, p_pubid, v_axog, v_mesg, v_multa, 452011 );
      return 0 ,452011, 452011, v_axog||'-'||lpad(v_mesg,2,'0') , 'MULTA '||v_folreq  , v_multa, v_acumulado  with resume;
   end if;
   if v_porcmul <>100 then
      let v_muldesc=(v_multa*v_porcmul)/100;
      if v_muldesc >0 then
         let v_muldesc=v_muldesc*-1;
         let v_acumulado = v_acumulado + v_muldesc;
         insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion ) 
          values(0, p_pubid, v_axog, v_mesg, v_muldesc, 452911 );
         return 0 ,452911, 452911, v_axog||'-'||lpad(v_mesg,2,'0') , 'DESCUENTO MULTA '||v_folreq, v_muldesc, v_acumulado  with resume;
      end if; 
   end if;
else
   let v_multa=0;
   let v_muldesc=0;
end if;
-- ********** termina rutina para gastos y multas si son por notificacion


-- Inicia Foreach 
FOREACH
	select 	b.cuentaapl, b.tipo , a.axo , a.mes , a.concepto ,  a.ade_importe
	into 	v_cuentaapl , v_tipochar, v_axo , v_mes , v_concepto , v_adeudo
	from 	pubadeudo a, pubtipoadeudo b
	where 	pubmain_id = p_pubid  
	and  	(axo * 100 + mes) <= perio
	and 	a.tipo <> 10 
	and 	a.tipo = b.tipo_id  
	order 	by a.axo , a.mes

	let v_referencia = v_axo || '-' || lpad(v_mes,2,'0');
	let v_acumulado = v_acumulado + v_adeudo;
	insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(1, p_pubid, v_axo ,v_mes, v_adeudo,v_cuentaapl);
	return 0 , v_cuentaapl, get_odoo_cta(  v_cuentaapl  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
END FOREACH;


-- Inicia Foreach 
FOREACH -- pubcategoria_id adicionado para saber la categoria
	select 	Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe
	into 	v_axo , v_mes , perioI , v_concepto, v_adeudo
	from 	pubadeudo 
	where 	pubmain_id = p_pubid  
	and  	(axo * 100 + mes) <= perio
	and  	tipo = 10  
	order 	by axo , mes

	-- porcentaje de descuento en recargos
	select 	porcentaje 
	into 	v_porc_recgos 
	from 	pub_descrec
	where 	pubmain_id = p_pubid 
	and 	((v_axo * 100)+v_mes) between
			((axoinicio * 100)+ mesinicio) and ((axofin * 100)+mesfin) and vigencia = 'V';
	let v_descto_recgos = 0;
	if 	v_porc_recgos is null then
		let v_porc_recgos = 0;
	end if;

	select 	sum(porcentaje_mes) 
	into 	v_porcentaje 
	from 	recargos
	where 	(axo * 100 + mes) between  perioI and per_recgos;
	if 	v_porcentaje is null then
		let v_porcentaje = 0;
	end if;

	let v_recargos = (v_porcentaje * v_adeudo ) / 100;
	let v_referencia =  v_axo || '-' || lpad(v_mes,2,'0');
	if 	v_porc_recgos > 0 and v_recargos > 0 then
	-- calcular descuento en recargos.
		let  v_descto_recgos = ((v_recargos * v_porc_recgos) / 100) * -1;
	--  let v_recargos =   v_recargos - v_descto_recgos;
	end if;
        --verificar calculo de recargos mortega
                if year(today) = p_axof then
                   if v_axo = year(today) and p_mesf = 12 and month(today)<=2 then
                      let v_recargos = 0;
                   else
                      if today <= v_fecha_limite and  v_axo=year(today) and v_mes >= month(today)  then
                         let v_recargos = 0;
                      end if;
                   end if;
                end if;
         -----------------------
	--  verificar si es el primera mesualidad para quitar recargos o cobrarles
	if 	(today - v_fec_ini_cobra_rgos ) <= 6 then
		let  v_descto_recgos = 0;
		let  v_recargos =  0;
	end if;

	--  Totales
	if 	v_axo = year(today) then
		let v_cuota = v_cuota + v_adeudo;
		let v_rectot = v_rectot + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;

			-- cuentas 2020 inicio
			if 	v_pubcategoria_id = 1 then --De Primera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000001);
				return 0 , 190000001, get_odoo_cta(  190000001  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	v_pubcategoria_id = 2 then --De Segunda
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000003);
				return 0 , 190000003, get_odoo_cta(  190000003  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	v_pubcategoria_id = 3 then --De Tercera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000005);
				return 0 , 190000005, get_odoo_cta(  190000005  ,19 ), v_referencia, v_concepto || ' - '|| mesvig, v_adeudo, v_acumulado  with resume;
			end if;

			if 	v_pubcategoria_id = 4 then --De Cuarta
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000007);
				return 0 , 190000007, get_odoo_cta(  190000007  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 5) or (v_pubcategoria_id = 10) then --Comercial Cerrado
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000009);
				return 0 , 190000009, get_odoo_cta(  190000009  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 6) or (v_pubcategoria_id = 9) then --Comercial Mixto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000011);
				return 0 , 190000011, get_odoo_cta(  190000011  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 7) or (v_pubcategoria_id = 8) then --Comercial Abierto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000013);
				return 0 , 190000013, get_odoo_cta(  190000013  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			--if (v_pubcategoria_id = 0) or (v_pubcategoria_id = 0) then --Moto Puerto
			-- insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000015);
			-- return 0 , 190000015, get_odoo_cta(  190000015  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			--end if;
		-- cuentas 2020 termina
		end if;
		
		if 	(v_recargos > 0) and (p_pubid not in (74,607)) then
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos P' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
			return 0 ,390600000, get_odoo_cta(  390600000  ,19 ), v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc
			--Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;  --- calculo anterior
            execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;           
            if v_actualizacion > 0 then
			   let v_acumulado = v_acumulado + v_actualizacion;
			   let v_concepto1 = 'Actualizaci�n ' || v_concepto;
			   insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  
			   values(2, p_pubid, v_axo ,v_mes, v_actualizacion, 459111);
			   return 0 ,459111, 459111, v_referencia , v_concepto1, v_actualizacion, v_acumulado  with resume;
            -- termina codigo nuevo inpc
			end if;

            if exists (select * from parametros where pub_multa_adeven='S') then
               -- calcula multa
               let v_multa = 0;
               execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
               if v_multa >0 and (p_pubid not in (74,607)) then
                  let v_acumulado = v_acumulado + v_multa;
                  let v_concepto1 = 'Multa ' || v_concepto || ' - ' || 1147;
                  insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
                   values(3, p_pubid, v_axo ,v_mes,  v_multa, 452011 );
                  return 0 ,452011, 452011, v_referencia , v_concepto1, v_multa, v_acumulado  with resume; 
               end if;
               -- calcula descuento multa
               let v_muldesc=0;
               execute PROCEDURE pub_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
               if v_muldesc>0 then
                  let v_muldesc = v_muldesc*-1;
                  let v_acumulado = v_acumulado + v_muldesc;
                  let v_concepto1 = 'Descto Multa ' || v_concepto;
                  insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
                   values(4, p_pubid, v_axo ,v_mes,  v_muldesc, 452911 );
                  return 0 ,452911, 452911, v_referencia , v_concepto1, v_muldesc, v_acumulado  with resume;
               end if;
            end if;
			
		end if;
		if 	(v_recargos > 0) and (v_descto_recgos <> 0) then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  
			values(2, p_pubid, v_axo ,v_mes, v_descto_recgos, 390640000);
			return 0 , 390640000, get_odoo_cta(  390640000  ,19 ), v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
		
	else
		let v_cuota_r = v_cuota_r + v_adeudo;
		let v_rectot_r = v_rectot_r + v_recargos;
		if 	v_adeudo > 0 then
			let v_acumulado = v_acumulado + v_adeudo;

			-- cuentas 2020 inicio
			if 	v_pubcategoria_id = 1 then --De Primera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000002);
				return 0 , 190000002, get_odoo_cta(  190000002  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			if 	v_pubcategoria_id = 2 then --De Segunda
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000004);
				return 0 , 190000004, get_odoo_cta(  190000004  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			if 	v_pubcategoria_id = 3 then --De Tercera
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000006);
				return 0 , 190000006, get_odoo_cta(  190000006  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			if 	v_pubcategoria_id = 4 then --De Cuarta
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000008);
				return 0 , 190000008, get_odoo_cta(  190000008  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 5) or (v_pubcategoria_id = 10) then --Comercial Cerrado
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000010);
				return 0 , 190000010, get_odoo_cta(  190000010  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 6) or (v_pubcategoria_id = 9) then --Comercial Mixto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000012);
				return 0 , 190000012, get_odoo_cta(  190000012  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;

			if 	(v_pubcategoria_id = 7) or (v_pubcategoria_id = 8) then --Comercial Abierto
				insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000014);
				return 0 , 190000014, get_odoo_cta(  190000014  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			end if;
			--if (v_pubcategoria_id = 0) or (v_pubcategoria_id = 0) then --Moto Puerto
			-- insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_adeudo, 190000016);
			-- return 0 , 190000016, get_odoo_cta(  190000016  ,19 ), v_referencia , v_concepto, v_adeudo, v_acumulado  with resume;
			--end if;
			-- cuentas 2020 termina
		end if;
		
		if 	v_recargos > 0 and (p_pubid <>603) then
			let v_acumulado = v_acumulado + v_recargos;
			let v_concepto1 = 'Recargos C - ' ||perio_susp || ' -' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_recargos, 390600000);
			return 0  , 390600000, get_odoo_cta(  390600000  ,19 ), v_referencia , v_concepto1, v_recargos, v_acumulado  with resume;
			
			-- inicia codigo nuevo inpc
			--Let	v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ; -- calculo anterior
            execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;
            if v_actualizacion > 0 then
			   let v_acumulado = v_acumulado + v_actualizacion;
			   let v_concepto1 = 'Actualizaci�n ' || v_concepto;
			   insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  
			   values(2, p_pubid, v_axo ,v_mes, v_actualizacion, 459111);
			   return 0 ,459111, 459111, v_referencia , v_concepto1, v_actualizacion, v_acumulado  with resume;
			-- termina codigo nuevo inpc
            end if;

            if exists (select * from parametros where pub_multa_adeven='S') then
               -- calcula multa
               let v_multa = 0;
               execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
               if v_multa >0 then
                  let v_acumulado = v_acumulado + v_multa;
                  let v_concepto1 = 'Multa ' || v_concepto;
                  insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
                   values(3, p_pubid, v_axo ,v_mes,  v_multa, 452011 );
                  return 0 ,452011, 452011, v_referencia , v_concepto1, v_multa, v_acumulado  with resume; 
               end if;
               -- calcula descuento multa
               let v_muldesc=0;
               execute PROCEDURE pub_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
               if v_muldesc>0 then
                  let v_muldesc = v_muldesc*-1;
                  let v_acumulado = v_acumulado + v_muldesc;
                  let v_concepto1 = 'Descto Multa ' || v_concepto;
                  insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )
                   values(4, p_pubid, v_axo ,v_mes,  v_muldesc, 452911 );
                  return 0 ,452911, 452911, v_referencia , v_concepto1, v_muldesc, v_acumulado  with resume;
               end if;
            end if;


		end if;

		if  (v_recargos > 0) and (v_descto_recgos <> 0) then
			let v_acumulado = v_acumulado + v_descto_recgos;
			let v_concepto1 = 'Descto Recgos ' || v_concepto;
			insert into tmp_publicos (orden, id_pub , axo , mes , imp_pagar , cta_aplicacion )  values(2, p_pubid, v_axo ,v_mes, v_descto_recgos, 390640000);
			return 0 , 390640000, get_odoo_cta(  390640000  ,19 ), v_referencia , v_concepto1, v_descto_recgos, v_acumulado  with resume;
		end if;
		
	End if;
	
END FOREACH;

end function;

CREATE FUNCTION "informix".admin_encabezados_19 ( p_numesta int )

 returning
 varchar(92) as Nombre_completo,
 varchar(80) as calle,
 varchar(10) as No_ext,
 varchar(10) as No_int,
 varchar(50) as Colonia,
 varchar(10) as CP,
 varchar(13) as RFC, 
 varchar(50) as Municipio,
 varchar(50) as Estado,
 varchar(18) as CURP,
 lvarchar(500) as descripcion,
 smallint as cartera,
 varchar(100) as mensaje,
 varchar(255) as piepagina,
 int as codigo_mensaje;

--returning int as codigo , int as idpublico , int as numesta,
--varchar(80)  as propietario  , varchar(80) as calle , varchar(40) as categoria , int as capacidad , varchar(100) as mensaje ;
define v_codigo int;
define  v_id int; 
define v_numesta int;
define v_nombre varchar(80);
define  v_calle varchar(80); 
define   v_descripcion varchar(40) ;
define v_cupo int;
define adeudo int;
define  v_movto_cve char(1); 
define v_numext char(5);
define v_rfc  char(15);
define v_dir_fis varchar(80);
define v_cont int;
define v_numextf varchar(8);
define v_multas, v_porcentaje, v_porc_rec int;
define v_imp_multa, v_descuento, v_desc_rec, v_desc_mul, v_imp_recargos money(18,2);

let v_codigo = -1;
let  v_id  = 0; 
let v_numesta = 0;
let v_nombre = '';
let  v_calle =''; 
let   v_descripcion = '' ;
let v_cupo =0;
let  v_movto_cve =''; 
let adeudo = 0;

select nvl(a.id,0) , a.numesta, a.nombre , trim(a.calle) , a.numext ,  b.descripcion , a.cupo , a.movto_cve , a.rfc
into v_id , v_numesta, v_nombre , v_calle  , v_numext,  v_descripcion , v_cupo , v_movto_cve , v_rfc
 from pubmain  a , pubcategoria b
where a.numesta = p_numesta and b.id = a.pubcategoria_id;

-- Se agrega la opcion S = Suspendido par que no permita hacer cobros en Caja JIRA 180424
if v_movto_cve in ('B') then
   return v_nombre , v_calle ,v_numext ,'', '' , '', '' , ' ' ,' ' , '',  ' ',0 , 'ESTACIONAMIENTO BLOQUEADO' , ' ' ,  -2;
end if;

select count(*) into v_cont from  ta14_personas  where rfc = trim(v_rfc);
   if v_cont = 1 then 
      select direccion , no_ext into v_dir_fis , v_numextf from ta14_personas where rfc = trim(v_rfc);
      let  v_calle = v_dir_fis;
      let  v_numext = v_numextf;
   end if;
  select count(*) into v_multas from pub_rel_multas where  pubmain_id = v_id and vigente = 'V';


if v_id > 0 then
   if v_movto_cve = 'C' then
      return v_nombre , v_calle ,v_numext ,'', '' , '', '' , ' ' ,' ' , '',  ' ',0 , 'ESTACIONAMIENTO CANCELADO' , ' ' ,  -2;
   else 
     select count(*) into adeudo from pubadeudo where pubmain_id = v_id;
      if  adeudo > 0 then
          if v_multas = 0 then 
             let v_imp_multa=0; 
             let v_descuento=0;
             let v_porcentaje=0;
             let v_porc_rec=0;
             let v_desc_rec=0;
             let v_desc_mul=0; 
             if not exists( select * from pub_descmul where pubmain_id=v_id and vigencia='V') then
                if (today>=mdy(11,13,2023)) and (today<=mdy(11,24,2023)) then
                   let v_porcentaje=80;
                else
                   let v_porcentaje=0;
                end if;
             else
                select porcentaje into v_porcentaje from pub_descmul where pubmain_id=v_id and vigencia='V';
             end if;

             if not exists( select * from pub_descrec where pubmain_id=v_id and vigencia='V') then
                if (today>=mdy(11,13,2023)) and (today<=mdy(11,24,2023)) then
                   let v_porc_rec=75;
                else
                   let v_porc_rec=0;
                end if;
             else
                select porcentaje into v_porc_rec from pub_descrec where pubmain_id=v_id and vigencia='V';
             end if;

             execute procedure fn_pub_recargos(2 , v_id, year(today), month(today) ) into v_imp_recargos;
             execute procedure fn_pub_multas(2 , v_id, year(today), month(today) ) into v_imp_multa;
             let v_desc_mul = (v_imp_multa * v_porcentaje) / 100;
             let v_desc_rec = (v_imp_recargos * v_porc_rec) / 100;
             let v_descuento = v_desc_mul + v_desc_rec;

             if v_descuento>200000 then
                return '' , '' , '' ,'', '' , '', '' , ' ' ,' ' , '',  ' ', 0 , 'EL DESCUENTO EXCEDE DE 200 MIL' , ' ' ,  -2;
             else
                if v_movto_cve in ('S') then
                   return v_nombre , v_calle ,v_numext ,'', '' , '', 'v_rfc' , ' ' ,' ' , '',  ' ',1 , 'ESTACIONAMIENTO SUSPENDIDO' , ' ' ,  -2;
                else
                   return v_nombre , v_calle , '' ,'', '' , '', v_rfc , ' ' ,' ' , '',  ' ',1 , 'PROCEDE PARA PAGO' , ' ' ,  0;
                end if;
             end if;
          else
             return v_nombre , v_calle , '' ,'', '' , '', v_rfc , ' ' ,' ' , '',  ' ',
                    1 , 'TIENE MULTAS MUNICIPALES, FAVOR DE SOLICITAR EL PAGO O ACLARACION' , ' ' ,  1;
          end if;
      else 
          return v_nombre , v_calle ,v_numext ,'', '' , '', '' , ' ' ,' ' , '',  ' ',0 , 'ESTACIONAMIENTO SIN ADEUDO' , ' ' ,  -3;
      end if;
   end if
 else 
 return '' , '' ,'' ,'', '' , '', '' , ' ' ,' ' , '',  ' ',
             0 , 'NO EXISTE ESTE ESTACIONAMIENTO' , ' ' ,  -1;

end if;
END function;

create procedure "pgcabrer".cajero_pub_detalle ( p_opc int , p_pubid int, p_axof int , p_mesf int  )
	returning	varchar(50) as concepto , 
		int as axo, 
		int as mes, 
		money(12,2) as adeudo, 
		money(10,2) as recargos,
        money(10,2) as actualizacion,
        money(10,2) as multa;

define axovig, v_diavenc int ;
define mesvig int ; define diavig  int; define perio  int ; define v_porcentaje decimal(5,2);
define perioI int; define v_recargos money(10,2); define v_adeudo money(12,2) ; define v_actualizacion money(12,2) ;
define v_muldesc, v_multa money(10,2);
define v_axo int ;define v_mes int;  define per_recgos int;    define v_concepto varchar(50) ;
define v_tipo int; define v_concepto1, v_msgmulta varchar(40);
define v_fecha_limite date;
define v_axo_inicio, v_mes_inicio, perio_susp int;
define v_descto_recgos money(10,2);
define v_porc_recgos int;

define vv_status		int;		-- adicionado por Gil para generar registro de recargo 01/06/2018
define vv_leyenda		varchar(50);	-- adicionado por Gil para generar registro de recargo 01/06/2018	

let axovig = year(today) ;
let mesvig = month(today);
let diavig = day(today);

Let vv_status = 0;							-- adicionado por Gil para generar registro de recargo 01/06/2018
Let vv_leyenda = 'Aun el dia actual no es mayor de 5';			-- adicionado por Gil para generar registro de recargo 01/06/2018
EXECUTE PROCEDURE cajero_porc_rgos () INTO vv_status, vv_leyenda;  	-- adicionado por Gil para generar registro de recargo 01/06/2018

select fecha_descuento, day(fecha_recargos) into v_fecha_limite, v_diavenc from db_ingresos:ta_11_fecha_desc where mes = mesvig;
	if v_fecha_limite > today then
      		let mesvig = mesvig -1;
   	end if;
	let per_recgos =  (axovig *100 )+mesvig;
	--let per_recgos = 201312;

	if p_opc = 2 then
		let axovig = p_axoF ;
		let mesvig = p_mesF;
	end if;

	if p_opc = 3 then
		let axovig = year(today) ;
		let mesvig = 12;
	end if;
	let perio = (axovig *100 )+mesvig;

-- adicionado para contratos en suspension 28/06/2022
Let v_axo_inicio = 0;
Let v_mes_inicio = 0;
Let perio_susp = 0;
SELECT axo_inicio, mes_inicio INTO v_axo_inicio, v_mes_inicio  FROM ta_contratos_status WHERE modulo = 2 AND id = p_pubid AND estado = 'S'; -- 1=Exclusivo, 2=P�blico
if v_mes_inicio = 1 then
Let perio_susp = ((v_axo_inicio - 1) * 100) + 12;
else
Let perio_susp = (v_axo_inicio *100 )+ (v_mes_inicio - 1);
end if;
if perio_susp < perio then
Let perio = perio_susp;
end if;

if exists (select * from pubadeudo where pubmain_id = p_pubid and tipo=2 and axo=2025 ) then 
   delete from pubadeudo where pubmain_id = p_pubid and tipo=2 and axo=2025;
end if;

FOREACH
select tipo , Axo, mes, (axo  * 100 )+ mes , concepto, ade_importe 
into v_tipo,  v_axo , v_mes , perioI , v_concepto1 , v_adeudo
from pubadeudo where pubmain_id = p_pubid  and  (axo * 100 + mes) <= perio 
order by 1,2,3

SELECT porcentaje INTO v_porc_recgos FROM pub_descrec WHERE pubmain_id = p_pubid
AND ((v_axo * 100)+v_mes) BETWEEN ((axoinicio * 100)+ mesinicio) AND ((axofin * 100)+mesfin) AND vigencia = 'V';

let v_descto_recgos = 0;
    if v_porc_recgos is null then
      let v_porc_recgos = 0;
    end if;

if v_tipo = 10 then
	select sum(porcentaje_mes) into v_porcentaje from recargos
     	where (axo * 100 + mes) between  perioI and per_recgos;

	let v_recargos = (v_porcentaje * v_adeudo ) / 100;
	if v_recargos is null then
       		let v_recargos = 0;
	end if;

if v_porc_recgos > 0 and v_recargos > 0 then
-- calcular descuento en recargos.
        let  v_descto_recgos = (v_recargos * v_porc_recgos) / 100;
        let v_recargos =   v_recargos - v_descto_recgos;
    end if;

		let v_concepto = trim(v_concepto1) ||" Periodo:" || v_mes ||"/" || v_axo ;
else
	let v_recargos = 0;
	let v_concepto = v_concepto1 || '  ' || v_adeudo;
end if;

let v_actualizacion=0;
-- Let v_actualizacion = fcn_inpc_x_mes ( perioI ) * v_adeudo / 100 ;  -- calculo anterior
execute function db_ingresos:spd_11_calc_actualizacion(v_axo, v_mes, v_adeudo) into v_actualizacion;
if v_actualizacion < 0 then
   let v_actualizacion=0;
end if;
-- termina codigo nuevo inpc

-- calculo de multa
  let v_multa = 0;
  let v_muldesc=0;
  if exists (select * from parametros where pub_multa_adeven='S') then 
     if v_recargos > 0 then
        execute procedure calc_multa( v_adeudo, mdy(v_mes, v_diavenc, v_axo)) into v_multa;
        if v_multa >0 then
           -- calcula descuento multa
           let v_muldesc=0;
           execute PROCEDURE pub_desctomulta( p_pubid, v_axo, v_mes, v_multa) into v_muldesc, v_msgmulta;
        end if;
        let v_multa = v_multa - v_muldesc;
     end if;
  end if;
-- termina calculo de multa

return v_concepto , v_axo , v_mes ,  v_adeudo , v_recargos , v_actualizacion, v_multa with resume;

end foreach;
end procedure;


create procedure "informix".spd_afec_50porc (p_Ejer Int)

define vaxo, vfolio, vInfraccion, vControl  int;
define vplaca Char(7);
define vImporte, vTarifa Money(10,2);
define vfecha_folio, vfecha_pago, vfecha_inicial, vfecha_fin Date;

foreach
  select a.axo, a.folio, a.placa, a.importe_neto, a.infraccion, a.fecha_folio, a.fec_pago, b.control
      into vaxo, vfolio, vplaca, vImporte, vInfraccion, vfecha_folio, vfecha_pago, vControl
   from ta14_fol_banorte a, ta14_folios_histo b
             where a.axo = p_Ejer
	and b.axo = a.axo and b.folio = a.folio

                        select tarifa, fecha_inicial, fecha_fin 
                           into  vTarifa, vfecha_inicial, vfecha_fin
                        from ta14_tarifas
                           where num_clave = vInfraccion and vfecha_folio between fecha_inicial and fecha_fin;

                        if vImporte = (vTarifa)/2 then
                           insert into ta14_porcen_histo values (vControl, vfecha_pago, 50);
                        end if;

end foreach;

end procedure
;

create procedure "informix".spd_afec_banorte (p_Ejer Int)

define vaxo, vfolio  int;
define vfecha_movto Date;

foreach
  select a.axo, a.folio, a.fecha_movto
      into vaxo, vfolio, vfecha_movto
    from ta14_folios_histo a
          where  a.axo = p_Ejer and a.codigo_movto = 10

                        if exists(select fecha_afectacion, status_mpio from ta14_fol_banorte
                           where axo = vaxo and folio = vfolio) then
                           update ta14_fol_banorte set 
                              fecha_afectacion = vfecha_movto,
                              status_mpio = 1
                           where axo = vaxo and folio = vfolio;
                        end if;

end foreach;

end procedure
;

create procedure "gmoreno".upd14_actaxo ( p_Fecha_ini Date, p_Fecha_fin Date, p_Axo Integer, p_Axo_A Integer )

define vaxo, vfolio		Integer;

foreach
  select Axo, Folio
      into vaxo, vfolio
    from ta14_folios_adeudo
          where  fecha_folio between p_Fecha_ini and p_Fecha_fin 
             and  Axo = p_Axo

                        if not exists(select b.Axo, b.Folio from ta14_folios_adeudo b
                           where b.Axo = p_Axo_A and b.Folio = vfolio) then
                           update ta14_folios_adeudo set 
                              axo = p_Axo_A
                           where axo = vaxo and folio = vfolio;
                        end if;

end foreach;

end procedure
;

CREATE PROCEDURE "informix".spd_afec_gil01 (p_fecha_ini Date, p_fecha_fin Date)

define vaxo, vfolio                         Integer;
define v_fecha_movto                Date;

foreach
  SELECT axo, folio INTO vaxo, vfolio FROM ta14_fol_banorte 
       WHERE fec_pago between p_fecha_ini and p_fecha_fin
                       
                if exists (SELECT fecha_movto FROM ta14_folios_histo WHERE axo= vaxo AND folio = vfolio AND codigo_movto = 10 ) then
                               SELECT fecha_movto INTO v_fecha_movto FROM ta14_folios_histo WHERE axo= vaxo AND folio = vfolio AND codigo_movto = 10;
                               update ta14_fol_banorte set 
                                               fecha_afectacion = v_fecha_movto,
                                               status_mpio = 1
                               where axo= vaxo and folio = vfolio ;
                end if;

end foreach;
end procedure
;

create procedure "informix".spd_afec_banorte_st3 (p_axo integer)

define vaxo, vfolio  int;
define vplaca1, vplaca2 Char(7);
define v_id smallint ;
define v_msg varchar(100);
foreach
  select a.axo, a.folio, a.placa
      into vaxo, vfolio, vplaca1
   from ta14_fol_banorte a
             where status_mpio = 3 and axo = p_axo
       order by 2
      execute procedure  spd_delesta02(vaxo, vfolio, vplaca1 ,'', today, 5,'L',0,31,10) into v_id , v_msg;
 
end foreach;

end procedure
;

create procedure "informix".sp_actualiza_padron( )
 define   v_placa CHAR(7);
 define   v_marca CHAR(60);
 define   v_linea CHAR(60);
 define   v_version CHAR(60);
 define   v_tipo CHAR(50);
 define   v_color CHAR(60);
 define v_contar integer;
 Foreach
     select placa, marca, linea , version , tipo , color 
           into v_placa, v_marca, v_linea , v_version , v_tipo , v_color 
           from ta_padron_2013 

    select count(placa) into v_contar from ta_padron1 where placa = v_placa;
   if v_contar = 1 then
      update ta_padron1 set marca = v_marca , linea = v_linea , version = v_version , tipo = v_tipo , color = v_color
      ,pagados = 0
      where placa = v_placa and pagados not in (0,1);
   end if;
   if v_contar = 0 then
       insert into ta_padron1 ( id , placa, marca, linea , version , tipo , color , pagados )
       values (0, v_placa, v_marca, v_linea , v_version , v_tipo , v_color, 1);
   end if;
  end foreach;
end procedure;

CREATE PROCEDURE "informix".sp14_remesa_greg (p_Mpio Int, p_TipoAct Char(2), p_Folio Char(12), p_Placa Char(9), p_FecPgo Date, p_FecCan Date, p_FecAlt Date, 
                                                                              p_FolioEcMpio Char(50), p_Gastos Decimal(18,2), p_Remesa Char(20))


IF EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio
    WHERE folio = p_Folio AND placa = p_Placa AND TipoAct = 'A') then
                  IF NOT EXISTS(SELECT folio, placa, TipoAct FROM ta14_datos_mpio
                               WHERE folio = p_Folio AND placa = p_Placa
                                     AND TipoAct <> 'A') then
                                               if p_TipoAct = 'PN' then
                                                                insert into ta14_datos_mpio values(p_Mpio, p_TipoAct, p_Folio, Null, p_Placa, Null, Null, p_FecPgo, 
                                                                                                                       Null, Null, Null, p_FecAlt, Null, Null, p_FolioEcMpio, Null, p_Remesa, today);
                                               end if;
                                               if p_TipoAct = 'C' then
                                                                insert into ta14_datos_mpio values(p_Mpio, p_TipoAct, p_Folio, Null, p_Placa, Null, Null, Null, 
                                                                                                                       p_FecCan, Null, Null, p_FecAlt, Null, Null, p_FolioEcMpio, Null, p_Remesa, today);
                                               end if;
                                               if p_TipoAct = 'PR' then
                                                                insert into ta14_datos_mpio values(p_Mpio, p_TipoAct, p_Folio, Null, p_Placa, Null, Null, p_FecPgo, 
                                                                                                                       Null, Null, Null, p_FecAlt, Null, Null, p_FolioEcMpio, p_Gastos, p_Remesa, today);
                                               end if;
                  END IF;
END IF;

END PROCEDURE
;

CREATE PROCEDURE "informix".sp_llenar_datos_estacion()

define r_fecha_folio date;
define r_axo integer;
define v_folio integer;
define v_placa varchar(7);
define v_id integer;
define v_existe integer;

Let v_existe = 0;

foreach 
     select rowid , folio_archivo , placa  into v_id ,  v_folio , v_placa 
     from  ta14_folios_baja_esta where  fecha_folio is null and estatus is null

                select axo , fecha_folio  into r_axo , r_fecha_folio 
                from ta14_folios_adeudo where placa = v_placa and folio = v_folio;

                if r_axo is null then  -- buscar en historico de lo contrario actualiza con estatus 9
                               select count(*) into v_existe from ta14_folios_histo where folio = v_folio and placa = v_placa and codigo_movto not in (22,23);
                               if v_existe > 0 then
                                               update ta14_folios_baja_esta set axo = r_axo , fecha_folio = r_fecha_folio where rowid = v_id;
                               else
                                               update  ta14_folios_baja_esta set fecha_proceso = today , estatus = 9 where rowid = v_id;
                               end if;
                else
                               update ta14_folios_baja_esta set axo = r_axo , fecha_folio = r_fecha_folio where rowid = v_id;

                end if;
end foreach;

end procedure;

CREATE PROCEDURE "informix".sp_actuliza01 (p_1 int , p_2 int  )


define V_axo int ;
define v_codigo int;
define  V_folio int ;
define v_dias int;
define v_control int;
define V_tarifa int ;
define v_Tarif_imp money(12,2);
define v_cobrado money(12,2);
define v_porcentaje smallint;
define v_contador  integer;

-- folios con adeudo

   FOREACH select a.control, a.axo, a.folio ,a.infraccion  , b.tarifa , (a.fecha_movto - a.fecha_folio), a.codigo_movto
   into v_control , V_axo, v_folio ,  V_tarifa, v_Tarif_imp , v_dias , v_codigo 
   from ta14_folios_histo a , ta14_tarifas b 
  -- where a.control between p_1 and p_2 and a.codigo_movto in (13) and
    where a.fecha_movto between mdy(11,20,2015) and mdy(11,20,2015) and a.codigo_movto in (13) and
   a.infraccion = b.num_clave 
   and a.fecha_folio between b.fecha_inicial and b.fecha_fin 

    select  porc_cobro into v_porcentaje from ta14_folios_free where axo = v_axo and folio = v_folio;

     select count(*) into v_contador from ta14_folios_hco where control = v_control ;
  if v_contador = 0 then
     if    v_porcentaje is null then
      let v_porcentaje = 0;
     end if;


 let v_cobrado = 0; 
  if v_porcentaje = 0 then
     if v_dias > 6 then
       let v_porcentaje = 100;
       let v_cobrado = v_Tarif_imp;
      end if;
   if v_dias <= 6  then
    if  V_tarifa >= 1 and V_tarifa <= 4 then
        let v_porcentaje = 50;
        let v_cobrado = v_Tarif_imp /2;
     else
        let v_porcentaje = 100;
        let v_cobrado = v_Tarif_imp;
  
     end if;
   end if;

   if v_codigo = 6 then
      let v_porcentaje = 100;
      let v_cobrado = v_Tarif_imp;
   end if;
   
 
   insert into ta14_folios_hco (control , importe_infraccion , porcentaje, importe_cobrado )
  values ( v_control, v_Tarif_imp, v_porcentaje , v_cobrado);

  else
 
      let v_cobrado = trunc((v_Tarif_imp * v_porcentaje /100 ),2);
      insert into ta14_folios_hco (control , importe_infraccion , porcentaje, importe_cobrado )
      values ( v_control, v_Tarif_imp, v_porcentaje , v_cobrado);
  end if;


 end if;
 
 END FOREACH;



end procedure;

create procedure "informix".spd_afec_esta01 ( parfecha date )

define varok   smallint;
define varobs char(200);
define varcompro  integer;
define varcontrol integer;
define vaxo smallint; 
define vfolioedo decimal(12,0);
define vfolioec decimal(18,2);
define  vfolio integer;  
define vfecha date;
define vfecgen datetime year to second;
define vfechanot datetime year to second;
define vfechacancela date;
define vfechapago date;
define vfolionot char(20);
define vplaca char(7);
define vinfra smallint;
define vestado smallint;
define vvig integer;
define vacuerdo integer;
define vfeccap date;
define vusuini integer;
define vzona smallint;
define vespacio smallint;
define v_acuerdo integer;
           let varok = 0;
          let varobs = '';          

set debug file to "estamul.log";
trace on;

foreach  -- Altas de Notificaciones.
	Select folio, fechagenreq, placa, folionot, fechanot, fechaalta, year(fechaalta) 
	into vfolioedo, vfecgen, vplaca, vfolionot, vfechanot, vfecha, vaxo
	from ta14_datos_edo where tipoact = 'N' and fecharemesa = parfecha and teso_cve is null
                       
	if vfolioedo > 9999999 then 
   		let vfolio = trunc(vfolioedo - (vaxo * 10000000 ));
	else 
   		let vfolio = trunc(vfolioedo * (1));
	end if;

	if exists (select folio from ta14_folios_adeudo where axo= vaxo and folio = vfolio and num_acuerdo is null) then
  
		--- Preguntar si exite ya la Notificaci�n
		if exists ( select num_acuerdo   from ta14_notifica_edo where folionot = vfolionot ) then
                	select num_acuerdo   into vacuerdo  from ta14_notifica_edo where folionot = vfolionot ;
     		else
           		insert into ta14_notifica_edo (num_acuerdo , folionot, fechagenreq, fechanot)  values (0,vfolionot , vfecgen , vfechanot);
           		let vacuerdo =  dbinfo("sqlca.sqlerrd1");  
     		end if;

     		update ta14_folios_adeudo set num_acuerdo = vacuerdo where axo = vaxo and folio = vfolio;
     		update ta14_datos_edo set fecha_aplica_teso = today , teso_cve = 1 where folio = vfolioedo  and folionot = vfolionot ;
	else 
     		update ta14_datos_edo set fecha_aplica_teso = today , teso_cve = 2 , observacion = 'Folio sin adeudo' where folio = vfolioedo  and folionot = vfolionot ;
	end if;
end foreach;


foreach  -- Cancelacion de Notificaciones.
	Select folio, placa, fechaalta, year(fechaalta), fechacancelado 
	into vfolioedo, vplaca, vfecha, vaxo, vfechacancela
	from ta14_datos_edo where tipoact = 'C' and fecharemesa = parfecha and teso_cve is null
                       
	if vfolioedo > 9999999 then 
   		let vfolio = trunc(vfolioedo - (vaxo * 10000000 ));
	else 
   		let vfolio = trunc(vfolioedo * (1));
	end if;

	if exists (select folio from ta14_folios_adeudo where axo= vaxo and folio = vfolio and num_acuerdo is not null) then
  
		--- Afectar la notificacion y los folios de adeudo 
		select num_acuerdo   into vacuerdo  from ta14_folios_adeudo notifica_edo where axo= vaxo and folio = vfolio and num_acuerdo is not null;

                update ta14_notifica_edo set fechacancelado = vfechacancela  where num_acuerdo = vacuerdo;
                update ta14_folios_adeudo set num_acuerdo = null where axo= vaxo and folio = vfolio;
                update ta14_datos_edo set fecha_aplica_teso = today, teso_cve = 1 where folio = vfolioedo  and placa = vplaca ;
	else 
		update ta14_datos_edo set fecha_aplica_teso = today, teso_cve = 2, observacion = 'Folio sin Notificacion' where folio = vfolioedo  and placa = vplaca;
	end if;
end foreach;


foreach  -- Pago por el Estado.
	Select folio, placa, fechaalta, year(fechaalta), fechapago, folioec 
	into vfolioedo, vplaca, vfecha, vaxo, vfechapago, vfolioec 
	from ta14_datos_edo where tipoact = 'PN' and fecharemesa = parfecha and teso_cve is null
                       
	if vfolioedo > 9999999 then 
   		let vfolio = trunc(vfolioedo - (vaxo * 10000000 ));
	else 
   		let vfolio = trunc(vfolioedo * (1));
	end if;

	if exists( select folio from ta14_folios_adeudo  where axo = vaxo and folio = vfolio and placa = vplaca ) then

       		insert into ta14_folios_histo       
     		select 0, today, axo, folio, fecha_folio, placa, infraccion, estado, vigilante, num_acuerdo, fec_cap, usu_inicial, 6, 259, zona, espacio, 0 
		from ta14_folios_adeudo where axo = vaxo and folio = vfolio and placa = vplaca;

		let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
		select nvl(num_acuerdo,0) into v_acuerdo  from ta14_folios_adeudo where axo = vaxo and folio = vfolio and placa = vplaca;

			insert into ta14_pagos_edo ( control, folioec, fecha_pago ) values ( varcontrol, vfolioec, vfechapago );  
       			delete from ta14_folios_adeudo where axo = vaxo and folio = vfolio and placa = vplaca;
       			update ta14_datos_edo set fecha_aplica_teso = today, teso_cve = 1 where folio = vfolioedo  and placa = vplaca;
		
			if v_acuerdo <> 0 then
              			update ta14_notifica_edo set origen_pago = 6, fechapago = vfechapago where num_acuerdo = v_acuerdo and fechapago is null;
   			end if;
	else
  		if exists( select folio from ta14_folios_histo   where axo = vaxo and folio = vfolio and codigo_movto  <> 6   and placa = vplaca ) then
                 
			select first 1 axo, folio, fecha_folio, placa, infraccion, estado, vigilante, num_acuerdo, fec_cap, usu_inicial, zona, espacio
              		into      vaxo, vfolio, vfecha, vplaca, vinfra, vestado , vvig, vacuerdo , vfeccap, vusuini , vzona , vespacio 
        		from ta14_folios_histo where axo = vaxo and folio = vfolio and codigo_movto  <> 6 and placa = vplaca;

				insert into ta14_folios_histo   values ( 0, today, vaxo, vfolio, vfecha, vplaca, vinfra, vestado, vvig, vacuerdo, vfeccap, vusuini, 6, 259, vzona, vespacio, 0);
     				let varcontrol =  dbinfo("sqlca.sqlerrd1"); 
			
				insert into ta14_pagos_edo    (control , folioec , fecha_pago) values (varcontrol,   vfolioec , vfechapago);  
      				update ta14_datos_edo set fecha_aplica_teso = today , teso_cve = 1 where folio = vfolioedo  and placa = vplaca ;
    		else
   			update ta14_datos_edo set fecha_aplica_teso = today , teso_cve = 2 , observacion = 'Folio para verificar' where folio = vfolioedo  and placa = vplaca ;
		end if;
	end if;
end foreach;



trace off;

end procedure;

create procedure "informix".sp14_ejecuta_sp ()

define v_axo integer;
define v_folio integer;
define v_obs varchar(80);

define v_status	int;
let v_status = 0;

     		EXECUTE procedure sp_llenar_datos_estacion ();

  	FOREACH
     		EXECUTE procedure sp_procesar_datos_estacion () into v_axo, v_folio, v_obs
  	END FOREACH;


end procedure;

create procedure "informix".sp_actualiza_padronnvo(
p_PLACA char(7) , p_SERIE CHAR(20), p_MODELO CHAR(4), P_PROPIETARIO varchar(60) ,
p_DOMICILIO  varchar(60), p_EXT  varchar(10), p_INT  varchar(10),  p_INT2  varchar(10), P_ENTRECALLES  varchar(60),
P_COLONIA  varchar(60)   )
 define v_contar integer;
  

    select count(placa) into v_contar from ta_padron where placa = p_placa;
    
   if v_contar = 1 then
      update ta_padron set 
      nombre = p_propietario , 
      serie  = p_SERIE , 
      modelo = p_MODELO,
      domicilio = p_DOMICILIO , 
      num_ext = p_EXT  ,
      num_INT1 = p_int  , 
      num_INT2 = p_int2 , 
      EntreCalles = P_ENTRECALLES  ,
      colonia = P_COLONIA, 
      actualizado = 'A' , 
      FecActualizado = today
      where placa = p_placa and ( FecActualizado is null);
   end if;
   if v_contar = 0 then
       insert into ta_padron ( id , placa, nombre, serie , modelo , domicilio , num_ext , num_INT1 , num_INT2  , colonia  ,  EntreCalles , actualizado ,FecActualizado )
       values (0, p_placa, p_propietario, p_SERIE , p_MODELO , p_DOMICILIO , p_EXT, p_int  , p_int2 ,  P_COLONIA , P_ENTRECALLES , 'N' , today);
   end if;
      
end procedure;

create procedure "informix".sp_actualiza_padronnvodir(
   )

 define v_contar integer;
define p_id int;
define p_PLACA char(7) ;
define p_marca VARCHAR(60);
define p_cvevehicular VARCHAR(10);
define p_MODELO int;
define p_color varchar(30);
define p_SERIE CHAR(20);
define P_PROPIETARIO varchar(60) ;
define p_DOMICILIO  varchar(60);
define p_EXT  varchar(10); 
define p_INT  varchar(10); 
define p_INT2  varchar(10);
define P_COLONIA  varchar(60);
define P_ENTRECALLES  varchar(60);
define P_municipio VARCHAR(60);
define P_estatus varchar(30);
define p_fecha_act varchar(10);
--  set debug file to "padron18";
--trace on;
  foreach 
  select id , trim(placa) ,trim(marca), cvevehicular, modelo , trim(color) , trim(serie) ,
    trim(propietario) , trim(domicilio) , trim(num_ext) ,trim(inc_ext), trim(num_int)  , trim(colonia), trim(entrecalles) ,
    trim(municipio)
     into 
    p_id , p_PLACA , p_marca, p_cvevehicular, p_modelo , p_color , p_SERIE , P_PROPIETARIO, p_DOMICILIO ,
    p_EXT , p_INT  , p_INT2 ,P_COLONIA , P_ENTRECALLES , p_municipio
    from ta_pasopad  order by id

    select count(placa) into v_contar from ta_padron where placa = p_placa;
    if v_contar > 1 then
       delete from ta_padron where  placa = p_placa;
       let v_contar = 0;
    end if;  
   if v_contar = 1 then
      
      update ta_padron set 
      id = p_id, marca =  p_marca, claveveh = p_cvevehicular, color = p_color ,
      nombre = p_propietario , 
      serie  = p_SERIE , 
      modelo = p_MODELO,
      domicilio = p_DOMICILIO , 
      num_ext = p_EXT  ,
      num_INT1 = p_int  , 
      num_INT2 = p_int2 , 
      EntreCalles = P_ENTRECALLES  ,
      colonia = P_COLONIA, 
      municipio = p_municipio,
      actualizado = 'Y' , 
      FecActualizado = today
      where placa = p_placa ;
   end if;
   if v_contar = 0 then
       insert into ta_padron ( id , placa ,claveveh , nombre ,
    municipio , marca , modelo , color , serie , domicilio , num_ext , num_int1 , num_int2 ,
    colonia , entrecalles , actualizado ,  fecactualizado )
       values (p_id, p_placa, p_cvevehicular , p_propietario, p_municipio , p_marca , p_modelo , p_color ,  p_SERIE ,
       p_DOMICILIO , p_EXT, p_int  , p_int2 ,  P_COLONIA , P_ENTRECALLES , 'N' , today);
   end if;
  update ta_pasopad set procesado = 'S' where id = p_id;
end foreach;   
--trace off;
end procedure;

CREATE PROCEDURE "pgmoreno".sp14_remesa_greg_ind (p_Mpio Int, p_TipoAct Char(2), p_Folio Char(12), p_Placa Char(9), p_FecPgo Date, p_FecCan Date, p_FecAlt Date, 
p_FolioEcMpio Char(50), p_Gastos Decimal(18,2), p_Remesa Char(20))

	if p_TipoAct = 'PN' then
        	insert into ta14_datos_mpio values(p_Mpio, p_TipoAct, p_Folio, Null, p_Placa, Null, Null, p_FecPgo, 
							Null, Null, Null, p_FecAlt, Null, Null, p_FolioEcMpio, Null, p_Remesa, today);
	end if;
	if p_TipoAct = 'C' then
        	insert into ta14_datos_mpio values(p_Mpio, p_TipoAct, p_Folio, Null, p_Placa, Null, Null, Null, 
							p_FecCan, Null, Null, p_FecAlt, Null, Null, p_FolioEcMpio, Null, p_Remesa, today);
        	end if;
        	if p_TipoAct = 'PR' then
		insert into ta14_datos_mpio values(p_Mpio, p_TipoAct, p_Folio, Null, p_Placa, Null, Null, p_FecPgo, 
							Null, Null, Null, p_FecAlt, Null, Null, p_FolioEcMpio, p_Gastos, p_Remesa, today);
        	end if;

END PROCEDURE;

create procedure "informix".sp_desto35_fol_jul2018(v_placa varchar(7) , v_usuario int )
 --v_fecha_otorga date,  V_fecha_limite date , v_porc_cobro int ,
 -- v_clave char(1) ,  v_obs char(100) ,  v_usu_inicial  int, v_opc1 int )

-- para la opcion de 2 solo requieres axo y folio. 
--   para la opcion 1 se requieren todos los parametros.
define v_axo int;
define v_folio int;
define v_contar int ;
 define v_descrip char(50);

 let v_descrip = 'Descuento aplicado Correctamente';
 
-- foreach  select axo , folio  into v_axo , v_folio 
 --    from  ta14_folios_adeudo where placa = v_placa 

--    delete from ta14_folios_free where axo = v_axo and folio = v_folio and usu_inicial in (  999999 , 999998 , 999997)
 --   and fecha_otorga >= mdy(7,12,2018);

 -- end foreach;

--  select count(*) into v_contar from   ta14_folios_adeudo a , ta14_folios_free b where a.placa = v_placa and 
 -- b.axo = a.axo and b.folio = a.folio and b.usu_inicial not in ( 999999 , 999998 , 999997);
 -- if v_contar = 0 then
--  insert into ta14_folios_free (
--  axo ,  folio,  fecha_otorga ,  fecha_limite ,  porc_cobro, 
--  clave ,  obs ,  fec_cap ,  usu_inicial ) 
--  select axo , folio , today , mdy(8,31,2018) , 65 , 'A' , 'promocion julio 2018'   , today , v_usuario
--  from ta14_folios_adeudo where placa = v_placa and fecha_folio <= today - 8 ;

--  insert into ta14_folios_free (
  --axo ,  folio,  fecha_otorga ,  fecha_limite ,  porc_cobro, 
 -- clave ,  obs ,  fec_cap ,  usu_inicial ) 
--  select axo , folio , today , mdy(8,31,2018) , 65 , 'A' , 'promocion julio 2018'   , today , v_usuario
--  from ta14_folios_adeudo where placa = v_placa and fecha_folio >= today - 7 and infraccion > 4 ;



-- end if;
--end if;
END PROCEDURE;

create procedure "informix".sp_actualiza_padron_folios( )
 define   v_placa CHAR(7);
 define   v_marca CHAR(60);
 define   v_linea CHAR(60);
 define   v_version CHAR(60);
 define   v_tipo CHAR(50);
 define   v_color CHAR(60);
 define v_contar integer;
 define v_folios integer;
 Foreach
     select placa, count(*) into v_placa , v_folios 
           from ta14_folios_adeudo where year(fecha_folio) between 2014 and 2019 group by 1 

    select count(placa) into v_contar from ta_padron where placa = v_placa;
   if v_contar = 1 then
      update ta_padron set vigentes = v_folios
      where placa = v_placa ;
   end if;
   if v_contar = 0 then
       insert into ta14_folios_sinpadron (  placa, folios )
       values ( v_placa, v_folios);
   end if;
  end foreach;
end procedure;

create procedure "pgmoreno".sp_actualiza_padron_x( )

define v_nombre_prop varchar(100);
define v_calle, v_colonia, v_poblacion, v_marca, v_linea, v_version varchar(60);
define v_num_ext, v_num_int varchar(10);
define v_placa varchar(7);
define v_color1 varchar(25);
define v_modelo varchar(4);
define v_no_motor, v_no_serie varchar(40);

define v_contar integer;

Foreach
	select nombre_prop, calle, num_ext, num_int, colonia, poblacion, placa, marca, linea, version, color1, modelo, no_motor, no_serie
	into v_nombre_prop, v_calle, v_num_ext, v_num_int, v_colonia, v_poblacion, v_placa, v_marca, v_linea, v_version, v_color1, v_modelo, v_no_motor, v_no_serie
	from ta_padron2019

		select count(placa) into v_contar from ta_padron where placa = v_placa;
		
		if v_contar = 1 then
			update ta_padron set 
				nombre = v_nombre_prop, 
				domicilio = v_calle, 
				num_ext = v_num_ext, 
				num_int1 = v_num_int, 
				colonia = v_colonia, 
				municipio = v_poblacion, 
				marca = v_marca, 
				linea = v_linea, 
				version = v_version, 
				color = v_color1, 
				modelo = v_modelo, 
				no_motor = v_no_motor, 
				serie = v_no_serie,
				actualizado = 'S',
				fecactualizado = current
			where placa = v_placa;
		end if;

		if v_contar = 0 then
			insert into ta_padron ( id, placa, nombre, municipio, marca, modelo, color, serie, domicilio, num_ext, num_int1, 
					colonia, actualizado, fecactualizado, linea, version, no_motor ) 
				values ( 0, v_placa, v_nombre_prop, v_poblacion, v_marca, v_modelo, v_color1, v_no_serie, v_calle, v_num_ext, v_num_int, 
					v_colonia, 'S', current, v_linea, v_version, v_no_motor );
		end if;
end foreach;

end procedure;

create procedure "pgmoreno".sp_actualiza_padron_gil ( parAso int, parFolio int, parClave int, parFecha_Folio Date, parPlaca char(7), parFecha_Captura Date, parImporte money(12,2),
parNombre varchar(60), parDomicilio varchar(60), parCP int, parColonia varchar(60), parMunicipio varchar(60), parPlaca_otra char(7), parMarca varchar(60), parVersion varchar(60),
parColor varchar(60), parModelo char(4), parNo_Motor varchar(40), parNo_Serie char(20) )

define v_contar integer;

		select count(placa) into v_contar from ta_padron where placa = parPlaca;
		
		if v_contar = 1 then
			update ta_padron set
				nombre = parNombre,
				domicilio = parDomicilio,
				--num_ext = ' ',
				--num_int1 = ' ',
				colonia = parColonia,
				municipio = parMunicipio,
				marca = parMarca,
				--linea = v_linea,
				version = parVersion,
				color = parColor,
				modelo = parModelo,
				no_motor = parNo_Motor,
				serie = parNo_Serie,
				actualizado = 'S',
				fecactualizado = current
			where placa = parPlaca;
		end if;

		if v_contar = 0 then
			insert into ta_padron ( id, placa, placaant, nombre, municipio, marca, modelo, color, serie, domicilio, num_ext, num_int1,
					colonia, actualizado, fecactualizado, linea, version, no_motor )
				values ( 0, parPlaca, parPlaca_otra, parNombre, parMunicipio, parMarca, parModelo, parColor, parNo_Serie, parDomicilio, ' ', ' ',
					parColonia, 'S', current, ' ', parVersion, parNo_Motor );
		end if;

end procedure;

create procedure "informix".sp_actualiza_padron_folios( p_fecha date )
 define   v_placa CHAR(7);
 define   v_marca CHAR(60);
 define   v_linea CHAR(60);
 define   v_version CHAR(60);
 define   v_tipo CHAR(50);
 define   v_color CHAR(60);
 define v_contar integer;
 define v_folios integer;
 Foreach
     select placa, count(*) into v_placa , v_folios 
           from ta14_folios_adeudo where fecha_folio  >= p_fecha  group by 1 

    select count(placa) into v_contar from ta_padron where placa = v_placa;
   if v_contar = 1 then
      update ta_padron set vigentes = v_folios
      where placa = v_placa ;
   end if;
   if v_contar = 0 then
     
       if (select count(*) from ta14_folios_sinpadron where placa = v_placa ) = 0 then

      insert into ta14_folios_sinpadron (  placa, folios ,procesado , fecha_alta)
       values ( v_placa, v_folios ,'N' , today );
      end if;
   end if;
  end foreach;
end procedure;

create procedure "informix".sp_actualiza_padronnvows(p_consecutivo int,
p_PLACA char(7) ,  P_PROPIETARIO varchar(60) ,
p_DOMICILIO  varchar(60), p_municipio varchar(60), P_COLONIA  varchar(60), p_SERIE varCHAR(20), p_marca varchar(50) , p_MODELO CHAR(4),  p_claveveh varchar(40)
, p_color varchar(20) , p_linea varchar(40), p_version varchar(60) ,p_motor varchar(30) , p_estatus varchar(50) , p_opc char(1)  )
 define v_contar integer;
  
 
    select count(placa) into v_contar from ta_padron where placa = p_placa;
    
   if v_contar = 1 then
      update ta_padron set
      id = p_consecutivo, 
      nombre = p_propietario , 
      domicilio = p_DOMICILIO , 
      municipio = p_municipio ,
      colonia = P_COLONIA, 
      serie  = p_SERIE , 
      marca = p_marca ,
      modelo = p_MODELO,
      claveveh  = p_claveveh ,    
      color = P_color ,
      linea = p_linea ,
      version = p_version ,
      no_motor = p_motor ,
      actualizado = 'A' , 
      FecActualizado = today , 
      entrecalles = p_estatus
      where placa = p_placa ;
     update ta14_folios_sinpadron set procesado = 'U' where placa = p_placa;
   end if;

   if v_contar = 0 then
       if p_opc = 'S' then
       insert into ta_padron ( id , placa , claveveh , nombre, municipio , marca , modelo, color ,  serie ,
       domicilio , colonia , entrecalles , actualizado ,  fecactualizado ,  linea ,  version , no_motor)
       values(p_consecutivo , p_placa, p_claveveh , p_propietario,p_municipio , p_marca , p_modelo ,p_color ,  p_SERIE 
       , p_DOMICILIO ,  P_COLONIA , p_estatus, 'N' , today , p_linea , p_version , p_motor);
       update ta14_folios_sinpadron set procesado = 'S' where placa = p_placa;
      else
      insert into ta_padron ( placa , nombre,  actualizado ,  fecactualizado )
       values(  p_placa,  p_propietario , 'E' , today );
      --  update ta14_folios_sinpadron set procesado = 'E' where placa = p_placa;
     end if;
   end if;
     
end procedure;

CREATE PROCEDURE "informix".ta14_cancela_freeauto(id_auto int)
	define vfecha_fin date;
    define vporc int;
    define vobs varchar(255);
    define vvigencia varchar(1);
    define vrowid int;
    

    select fecha_fin, porc_auto, doc_soporte, vigencia
        into vfecha_fin, vporc, vobs, vvigencia
    from ta14_dscto_auto where id = 2 and fecha_fin < today;

    foreach
    select d.rowid into vrowid from ta14_folios_free d
        inner join ta14_folios_adeudo a on a.axo = d.axo and a.folio = d.folio 
    where d.porc_cobro = vporc and d.usu_inicial = 9999
        and d.clave = 'A' and d.obs = vobs
        and d.fecha_limite = vfecha_fin and d.fecha_limite < today

    -- Inicia Foreach --> Cancelamos recibos

        delete ta14_folios_free where rowid = vrowid;

    end foreach;
	
END PROCEDURE
;

CREATE PROCEDURE "informix".ta14_cancela_freevencidos
()
    define vrowid int;

    foreach 
    select d.rowid into vrowid from ta14_folios_free d
        inner join ta14_folios_adeudo a on a.axo = d.axo and a.folio = d.folio 
    where d.clave = 'A' and d.fecha_limite < today
        -- Cancelamos descuentos
        delete ta14_folios_free where rowid = vrowid;
       
    end foreach;
    
END PROCEDURE
;

CREATE PROCEDURE "dbherrer".sp_descto_placa_bf ( v_placa varchar(7) )

-- Modificacion para descuentos del 1 de noviembre al 30 de diciembre del 2020.
-- Modificacion para operar para el siguiente a�o por parametros de descuentos 
-- para la opcion de 2 solo requieres axo y folio.
-- para la opcion 1 se requieren todos los parametros.

define v_fecha_inicio, v_fecha_fin date;
define v_porc_auto int;
define v_doc_soporte char(50);
--
define v_axo int;
define v_folio int;
define v_clave int;
define v_contar int;
define v_porc_cobro int;

-- set debug file to "placaBF.txt";
-- trace on;
-- otorgamiento de descuento general a folios con 'OFICIO D.I. 3197/2019' realizado el 28/06/2019

SELECT 	count(*) INTO v_contar FROM ta14_dscto_auto WHERE vigencia = 'V';
if 	v_contar = 1 then
	SELECT fecha_inicio, fecha_fin, porc_auto, doc_soporte INTO v_fecha_inicio, v_fecha_fin, v_porc_auto, v_doc_soporte  FROM ta14_dscto_auto WHERE vigencia = 'V';
	if 	today >= v_fecha_inicio and today <= v_fecha_fin  then

		FOREACH
		SELECT 	axo , folio , infraccion INTO v_axo , v_folio , v_clave
		FROM 	ta14_folios_adeudo WHERE placa = v_placa

		-- inicio nuevo descuento solo para clave 5
		--if 	exists (SELECT * FROM ta14_folios_free where axo = v_axo and folio = v_folio) then
		--	SELECT porc_cobro INTO v_porc_cobro FROM ta14_folios_free WHERE axo = v_axo and folio = v_folio;
		--	if v_clave = 5 then
		--		if 	v_porc_cobro > v_porc_auto then
		--			delete from ta14_folios_free where axo = v_axo and folio = v_folio;
		--			insert into ta14_folios_free ( axo ,  folio,  fecha_otorga ,  fecha_limite ,  porc_cobro, clave ,  obs ,  fec_cap ,  usu_inicial )
		--			values ( v_axo,  v_folio,  today ,  v_fecha_fin,  v_porc_auto, 'A' ,  v_doc_soporte ,  today,  9999 );
		--		end if;
		--	end if;
		--else
		--	if 	v_clave = 5 then
		--		insert into ta14_folios_free ( axo ,  folio,  fecha_otorga ,  fecha_limite ,  porc_cobro, clave ,  obs ,  fec_cap ,  usu_inicial )
		--		values ( v_axo,  v_folio,  today ,  v_fecha_fin,  v_porc_auto, 'A' ,  v_doc_soporte ,  today,  9999 );
		--	end if;
		--end if;
		-- fin nuevo descuento solo para clave 5
		-- 1 de sept 2020

		-- inicio del anterior descuento
		if 	exists (SELECT * FROM ta14_folios_free where axo = v_axo and folio = v_folio) then
			SELECT porc_cobro INTO v_porc_cobro FROM ta14_folios_free WHERE axo = v_axo and folio = v_folio;
			if 	((v_clave = 1) or (v_clave = 2) or (v_clave = 3) or (v_clave = 4) or (v_clave = 6)) then
				if 	v_porc_cobro > v_porc_auto then
					delete from ta14_folios_free where axo = v_axo and folio = v_folio;
					insert into ta14_folios_free ( axo ,  folio,  fecha_otorga ,  fecha_limite ,  porc_cobro, clave ,  obs ,  fec_cap ,  usu_inicial )
					values ( v_axo,  v_folio,  today ,  v_fecha_fin,  v_porc_auto, 'A' ,  v_doc_soporte ,  today,  9999 );
				end if;
			end if;
		else
			if 	((v_clave = 1) or (v_clave = 2) or (v_clave = 3) or (v_clave = 4) or (v_clave = 6)) then -- v_clave <> 5 then
				insert into ta14_folios_free ( axo ,  folio,  fecha_otorga ,  fecha_limite ,  porc_cobro, clave ,  obs ,  fec_cap ,  usu_inicial )
				values ( v_axo,  v_folio,  today ,  v_fecha_fin,  v_porc_auto, 'A' ,  v_doc_soporte ,  today,  9999 );
			end if;
		end if;
		---- fin del descuento del 1 de noviembre al 28 de diciembre 2020

		END FOREACH;
	end if;
end if;

 -- trace off;
END PROCEDURE
;

CREATE PROCEDURE "informix".sp14_cursomov
(par_placa varchar(15), par_fecha date)
/******************************************************************************
- DESCRIPCI�N:
    Aplica descuento a las infracciones clave 5 vigentes de la placa PAR_PLACA
- CREACI�N: imarcial
- FECHA ACTUALIZACION: 01/06/2020
******************************************************************************/
	define v_axo integer;
    define v_folio integer;
    define v_fecha2 date;

    let v_fecha2 = par_fecha + 30; -- 30 dias naturales dura el descuento por asistir a curso

    foreach select fa.axo, fa.folio into v_axo, v_folio
    from ta14_folios_adeudo fa
        inner join ta14_tarifas t on t.num_clave = fa.infraccion and year(t.fecha_inicial) = fa.axo
    where placa = par_placa and infraccion = 5
        -- Insertamos descuento...

        delete from ta14_folios_free where axo = v_axo and folio = v_folio;
        
        insert into ta14_folios_free values (v_axo,v_folio, par_fecha , v_fecha2,50,'A','CURSO TALLER DE EDUCACION VIAL',today,999999);
    end foreach;

END PROCEDURE
;

CREATE PROCEDURE "informix".sp14_cursomov
(par_placa varchar(15), par_fecha date, par_porcentaje int)
/******************************************************************************
- DESCRIPCI�N:
    Aplica descuento a las infracciones clave 5 vigentes de la placa PAR_PLACA
    se agrega la funcionalidad del descuento
- CREACI�N: imarcial
- FECHA ACTUALIZACION: 01/06/2020
******************************************************************************/
	define v_axo integer;
    define v_folio integer;
    define v_fecha2 date;
    define v_desc integer;

    let v_desc = 100 - par_porcentaje;
    let v_fecha2 = par_fecha + 30; -- 30 dias naturales dura el descuento por asistir a curso

    foreach select fa.axo, fa.folio into v_axo, v_folio
    from ta14_folios_adeudo fa
        inner join ta14_tarifas t on t.num_clave = fa.infraccion and year(t.fecha_inicial) = fa.axo
    where placa = par_placa and infraccion = 5
        -- Insertamos descuento...

        delete from ta14_folios_free where axo = v_axo and folio = v_folio;
        
        insert into ta14_folios_free values (v_axo,v_folio, par_fecha , v_fecha2,v_desc,'A','CURSO TALLER DE EDUCACION VIAL',today,999999);
    end foreach;

END PROCEDURE
;

create procedure "informix".ex_descautomaticos(pid int, paxofin int, pmesfin int, popc char(1))

define v_descvig, v_folreq, v_cvereq, v_axomin, v_mesmin, v_axofin, v_mesfin, v_id int;
define v_porc_descto_multa, v_porc_descto_rcgos, v_porc_descto_renta, v_cc1, v_cc2, v_cc3 int;
define v_fecha, v_fec_ini, v_fec_fin date;
define v_usuario varchar(8);
define v_recargos, v_multa, v_renta money(16,2);

let v_usuario = null;
LET v_fec_ini = NULL;
LET v_fec_fin = NULL;

-- verifica periodo de descuento automatico
foreach
  select fec_ini , fec_fin , usu_aplica , porc_descto_rcgos , porc_descto_multa 
   into v_fec_ini , v_fec_fin , v_usuario , v_porc_descto_rcgos , v_porc_descto_multa
  from ex_parmetros_descuentos where vigente = 'V'
end foreach;

if popc='A' then

-- obtiene los recargos, multa 
execute procedure fn_exc_recargos(2, pid, paxofin, pmesfin) into v_recargos;
execute procedure fn_exc_multas(2, pid, paxofin, pmesfin) into v_multa;

if v_usuario is not null then

   IF v_fec_ini IS NOT NULL AND v_fec_fin IS NOT NULL THEN
      if today >= v_fec_ini  and today <= v_fec_fin then

         -- verifica si existen descuentos vigentes de recargos
         if exists(select * from ex_descrec where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos ) then 
         
            -- si tiene descuento vigente de recargos lo cancela
            update ex_descrec set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
              where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos;
         end if;   

         -- verifica si existen descuentos vigentes de multas
         if exists(select * from ex_descmul where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa ) then 
         
            -- si tiene descuento vigente de recargos lo cancela
            update ex_descmul set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
              where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa;
         end if; 

         -- para sacar el a�o minimo
         select  min(axo) into v_axomin from ex_adeudo where ex_contrato_id=pid;

         -- para sacar el mes minimo       
         select min(mes) into v_mesmin  from ex_adeudo where ex_contrato_id=pid and axo=v_axomin;

         -- selecciona fecha de vencimiento
         select fecha_recargos into v_fecha from db_ingresos:ta_11_fecha_desc where mes=month(today);

         -- verifica si el mes actual ya esta vencido
         if paxofin=year(today) then
            if day(today)<day(v_fecha) then
               if month(today)=1 then      
                  let v_mesfin=12;
                  let v_axofin=year(today)-1;
               else
                  let v_mesfin=month(today)-1;
                  let v_axofin=year(today);
               end if;
            else
               let v_mesfin=month(today);
               let v_axofin=year(today);
            end if;
         else
            let v_mesfin=pmesfin;
            let v_axofin=paxofin;   
         end if;

         -- vericar si tiene descuentos en recargos vigentes 
         select count(*) into v_cc1 from ex_descrec where ex_contrato_id=pid and vigencia = 'V';

         -- vericar si tiene descuentos en recargos vigentes 
         select count(*) into v_cc2 from ex_descmul where ex_contrato_id=pid and vigencia = 'V';

         -- insertar los descuento  recargos
         if  v_cc1 = 0   then
             if  (v_recargos > 0  and v_porc_descto_rcgos > 0 )  then
                 insert into ex_descrec (id_descto, ex_contrato_id, axoinicio, mesinicio, axofin, mesfin, fecha_alta, usuario_alta, fecha_baja,
                 usuario_baja, fec_pag, id_rec, caja, operac, vigencia, porcentaje, autoriza, nota, pc) 
                 values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, current, v_usuario, null, null, null, null, null, null,'V',v_porc_descto_rcgos,
                        'DIRECCION DE INGRESOS','','' );
             end if;
         end if;
         if  v_cc2 = 0   then
             if  (v_multa > 0  and v_porc_descto_multa > 0 )  then
                 insert into ex_descmul (id_descto, ex_contrato_id, axoinicio, mesinicio, axofin, mesfin, fecha_alta, usuario_alta, fecha_baja,
                 usuario_baja, fec_pag, id_rec, caja, operac, vigencia, porcentaje, autoriza, nota, pc) 
                 values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, current, v_usuario, null, null, null, null, null, null,'V',v_porc_descto_multa,
                        3,'','' );
             end if;
         end if;
      end if;
   END IF;
end if;
end if; --- cierre de la A

if popc='B' then
   IF v_fec_ini IS NOT NULL AND v_fec_fin IS NOT NULL THEN
      if today >= v_fec_ini  and today <= v_fec_fin then
         -- verifica si existen descuentos vigentes de recargos
         if exists(select * from ex_descrec where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos 
                   and usuario_alta=v_usuario) then 
         
         -- si tiene descuento vigente de recargos lo cancela
            update ex_descrec set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
            where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos and usuario_alta=v_usuario;
         end if;  
         -- verifica si existen descuentos vigentes de multas
         if exists(select * from ex_descmul where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa 
                   and usuario_alta=v_usuario) then 
         
         -- si tiene descuento vigente de multas lo cancela
            update ex_descmul set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
            where ex_contrato_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa and usuario_alta=v_usuario;
         end if;
      end if;
   END IF;
end if; -- cierre de la opcion B

end procedure;

CREATE PROCEDURE "informix".pub_descautomaticos(pid int, paxofin int, pmesfin int, popc char(1))

define v_descvig, v_folreq, v_cvereq, v_axomin, v_mesmin, v_axofin, v_mesfin, v_id int;
define v_porc_descto_multa, v_porc_descto_rcgos, v_porc_descto_renta, v_cc1, v_cc2, v_cc3 int;
define v_fecha, v_fec_ini, v_fec_fin date;
define v_usuario varchar(8);
define v_recargos, v_multa, v_renta money(16,2);

let v_usuario = null;
LET v_fec_ini = NULL;
LET v_fec_fin = NULL;

if popc='A' then
-- verifica periodo de descuento automatico
foreach
select fec_ini , fec_fin , usu_aplica , porc_descto_rcgos , porc_descto_multa 
    into v_fec_ini , v_fec_fin , v_usuario , v_porc_descto_rcgos , v_porc_descto_multa
from pub_parmetros_descuentos where vigente = 'V'
end foreach;

-- obtiene los recargos, multa 
execute procedure fn_pub_recargos(2, pid, paxofin, pmesfin) into v_recargos;
execute procedure fn_pub_multas(2, pid, paxofin, pmesfin) into v_multa;

if v_usuario is not null then

   IF v_fec_ini IS NOT NULL AND v_fec_fin IS NOT NULL THEN
        if today >= v_fec_ini  and today <= v_fec_fin then

           -- verifica si existen descuentos vigentes de recargos
           if exists(select * from pub_descrec where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos ) then 

              -- si tiene descuento vigente de recargos lo cancela
              update pub_descrec set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
                where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos;
           end if;   

           -- verifica si existen descuentos vigentes de multa
           if exists(select * from pub_descmul where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa ) then 

              -- si tiene descuento vigente de multa lo cancela
              update pub_descmul set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
                where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa;
           end if; 

           -- para sacar el a�o minimo
           select  min(axo) into v_axomin from pubadeudo where pubmain_id=pid;

           -- para sacar el mes minimo       
           select min(mes) into v_mesmin  from pubadeudo where pubmain_id=pid and axo=v_axomin;

           -- selecciona fecha de vencimiento
           select fecha_recargos into v_fecha from db_ingresos:ta_11_fecha_desc where mes=month(today);

           -- verifica si el mes actual ya esta vencido
           if paxofin=year(today) then
              if day(today)<day(v_fecha) then
                 if month(today)=1 then      
                    let v_mesfin=12;
                    let v_axofin=year(today)-1;
                 else
                    let v_mesfin=month(today)-1;
                    let v_axofin=year(today);
                 end if;
              else
                 let v_mesfin=month(today);
                 let v_axofin=year(today);
              end if;
           else
              let v_mesfin=pmesfin;
              let v_axofin=paxofin;   
           end if;

           -- vericar si tiene descuentos en recargos vigentes 
           select count(*) into v_cc1 from pub_descrec where pubmain_id=pid and vigencia = 'V';

           -- vericar si tiene descuentos en multa vigentes 
           select count(*) into v_cc2 from pub_descmul where pubmain_id=pid and vigencia = 'V';

           -- insertar los descuento  recargos
           if  v_cc1 = 0   then
               if  (v_recargos > 0  and v_porc_descto_rcgos > 0 )  then
                   insert into pub_descrec (id_descto, pubmain_id, axoinicio, mesinicio, axofin, mesfin, fecha_alta, usuario_alta, fecha_baja,
                   usuario_baja, fec_pag, id_rec, caja, operac, vigencia, porcentaje, autoriza, nota, pc) 
                   values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, current, v_usuario, null, null, null, null, null, null,'V',v_porc_descto_rcgos,
                          'DIRECCION DE INGRESOS','','' );
               end if;
           end if;

           -- insertar los descuento  muluas
           if  v_cc2 = 0   then
               if  (v_multa > 0  and v_porc_descto_multa > 0 )  then
                   insert into pub_descmul (id_descto, pubmain_id, axoinicio, mesinicio, axofin, mesfin, fecha_alta, usuario_alta, fecha_baja,
                   usuario_baja, fec_pag, id_rec, caja, operac, vigencia, porcentaje, autoriza, nota, pc) 
                   values(0, pid, v_axomin, v_mesmin, v_axofin, v_mesfin, current, v_usuario, null, null, null, null, null, null,'V',v_porc_descto_rcgos,
                          3,'','' );
               end if;
           end if;
        end if;
   END IF;
end if;
end if; --- cierre de la A

/*if popc='B' then

   IF v_fec_ini IS NOT NULL AND v_fec_fin IS NOT NULL THEN
        if today >= v_fec_ini  and today <= v_fec_fin then
           -- verifica si existen descuentos vigentes de recargos
           if exists(select * from pub_descrec where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos 
                     and usuario_alta=v_usuario) then 

           -- si tiene descuento vigente de recargos lo cancela
              update pub_descrec set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
              where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos and usuario_alta=v_usuario;
           end if;   
        end if;
   END IF;
end if; -- cierre de la opcion B*/
if popc='B' then
   foreach
     select fec_ini , fec_fin , usu_aplica , porc_descto_rcgos , porc_descto_multa 
     into v_fec_ini , v_fec_fin , v_usuario , v_porc_descto_rcgos , v_porc_descto_multa
     from pub_parmetros_descuentos where vigente = 'V'
   end foreach;

   if today >= v_fec_ini  and today <= v_fec_fin then
      -- verifica si existen descuentos vigentes de recargos
      if exists(select * from pub_descrec where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos 
                and usuario_alta=v_usuario) then 
      
      -- si tiene descuento vigente de recargos lo cancela
         update pub_descrec set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
         where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_rcgos and usuario_alta=v_usuario;
      end if;   
--
  if exists(select * from pub_descmul where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa  
                and usuario_alta=v_usuario) then 
      
      -- si tiene descuento vigente de multa lo cancela
         update pub_descmul  set vigencia='C', fecha_baja=today, usuario_baja=v_usuario 
         where pubmain_id=pid and fecha_baja is null and usuario_baja is null and vigencia='V' and porcentaje<=v_porc_descto_multa  and usuario_alta=v_usuario;
      end if; 
---  
   end if;
end if; -- cierre de la opcion B


end procedure;


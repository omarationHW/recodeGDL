<template>
    <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="cog" />
      </div>
      <div class="module-view-info">
        <h1>Adeudo Global de Locales</h1>
        <p>Módulo de Mercados</p>
      </div>
    </div>

    <div class="module-view-content">

    <div class="municipal-card">
      <div class="municipal-card-header"><i class="fas fa-filter"></i> Filtros de Búsqueda</div>
      <div class="municipal-card-body">
        <form @submit.prevent="buscarAdeudos" class="row g-3">
          <div class="form-group">
            <label class="municipal-form-label">Oficina *</label>
            <select v-model.number="filtros.oficina" class="municipal-form-control" required @change="cargarMercadosPorOficina">
              <option v-for="rec in recaudadoras" :key="rec.id_rec" :value="rec.id_rec">
                {{ rec.id_rec }} - {{ rec.recaudadora }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="municipal-form-label">Mercado *</label>
            <select v-model.number="filtros.mercado" class="municipal-form-control" required :disabled="!filtros.oficina">
              <option v-for="m in mercadosFiltrados" :key="m.num_mercado_nvo" :value="m.num_mercado_nvo">
                {{ m.num_mercado_nvo }} - {{ m.descripcion }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="municipal-form-label">Año *</label>
            <input v-model.number="filtros.year" type="number" class="municipal-form-control" :min="2003" :max="currentYear" required />
          </div>
          <div class="form-group">
            <label class="municipal-form-label">Mes *</label>
            <select v-model.number="filtros.month" class="municipal-form-control" required>
              <option v-for="m in 12" :key="m" :value="m">{{ m }}</option>
            </select>
          </div>
          <div class="form-group">
            <button type="submit" class="btn-municipal-primary w-100"><i class="fas fa-search"></i> Buscar</button>
          </div>
        </form>
      </div>
    </div>

    <div v-if="localesConAdeudo.length > 0" class="municipal-card">
      <div class="municipal-card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-exclamation-circle text-danger"></i> Locales con Adeudo</span>
        <button class="btn-action btn-success" @click="exportarExcel">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </button>
      </div>
      <div class="municipal-card-body">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table-header">
              <tr>
                <th>Oficina</th>
                <th>Mercado</th>
                <th>Cat</th>
                <th>Sección</th>
                <th>Local</th>
                <th>Letra</th>
                <th>Nombre</th>
                <th class="text-end">Adeudo</th>
                <th class="text-end">Recargos</th>
                <th class="text-end">Multa</th>
                <th class="text-end">Gastos</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="loc in localesConAdeudo" :key="loc.id_local">
                <td>{{ loc.oficina }}</td>
                <td>{{ loc.num_mercado }}</td>
                <td>{{ loc.categoria }}</td>
                <td>{{ loc.seccion }}</td>
                <td>{{ loc.local }}</td>
                <td>{{ loc.letra_local }}</td>
                <td>{{ loc.nombre }}</td>
                <td class="text-end">{{ formatCurrency(loc.adeudo) }}</td>
                <td class="text-end">{{ formatCurrency(loc.recargos) }}</td>
                <td class="text-end">{{ formatCurrency(loc.multa) }}</td>
                <td class="text-end">{{ formatCurrency(loc.gastos) }}</td>
                <td class="text-right font-weight-bold">{{ formatCurrency(calcularTotal(loc)) }}</td>
              </tr>
            </tbody>
            <tfoot class="bg-light font-weight-bold">
              <tr>
                <td colspan="7" class="text-end">TOTALES:</td>
                <td class="text-end">{{ formatCurrency(totales.adeudo) }}</td>
                <td class="text-end">{{ formatCurrency(totales.recargos) }}</td>
                <td class="text-end">{{ formatCurrency(totales.multa) }}</td>
                <td class="text-end">{{ formatCurrency(totales.gastos) }}</td>
                <td class="text-end">{{ formatCurrency(totales.total) }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <div v-if="localesSinAdeudo.length > 0" class="municipal-card">
      <div class="municipal-card-header bg-success text-white"><i class="fas fa-check-circle"></i> Locales Sin Adeudo</div>
      <div class="municipal-card-body">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table-header">
              <tr>
                <th>Oficina</th>
                <th>Mercado</th>
                <th>Cat</th>
                <th>Sección</th>
                <th>Local</th>
                <th>Letra</th>
                <th>Nombre</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="loc in localesSinAdeudo" :key="loc.id_local">
                <td>{{ loc.oficina }}</td>
                <td>{{ loc.num_mercado }}</td>
                <td>{{ loc.categoria }}</td>
                <td>{{ loc.seccion }}</td>
                <td>{{ loc.local }}</td>
                <td>{{ loc.letra_local }}</td>
                <td>{{ loc.nombre }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div v-if="!loading && localesConAdeudo.length === 0 && localesSinAdeudo.length === 0 && searched" class="alert alert-info mt-3">
      No se encontraron resultados para los filtros seleccionados
    </div>

    <div v-if="loading" class="text-center p-5">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Cargando información...</p>
    </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, computed, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'
import * as XLSX from 'xlsx'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const currentYear = new Date().getFullYear()

const filtros = ref({
  oficina: '',
  mercado: '',
  year: currentYear,
  month: new Date().getMonth() + 1
})

const recaudadoras = ref([])
const mercados = ref([])
const localesConAdeudo = ref([])
const localesSinAdeudo = ref([])
const loading = ref(false)
const searched = ref(false)

const mercadosFiltrados = computed(() => {
  if (!filtros.value.oficina) return []
  return mercados.value.filter(m => m.oficina === filtros.value.oficina)
})

const totales = computed(() => {
  const sum = {
    adeudo: 0,
    recargos: 0,
    multa: 0,
    gastos: 0,
    total: 0
  }

  localesConAdeudo.value.forEach(loc => {
    sum.adeudo += loc.adeudo || 0
    sum.recargos += loc.recargos || 0
    sum.multa += loc.multa || 0
    sum.gastos += loc.gastos || 0
    sum.total += calcularTotal(loc)
  })

  return sum
})

const cargarRecaudadoras = async () => {
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_RECAUDADORAS', [])
    recaudadoras.value = result || []
  } catch (error) {
    handleError(error)
  }
}

const cargarMercados = async () => {
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_MERCADOS_ALL', [])
    mercados.value = result || []
  } catch (error) {
    handleError(error)
  }
}

const cargarMercadosPorOficina = () => {
  filtros.value.mercado = ''
}

const buscarAdeudos = async () => {
  loading.value = true
  searched.value = true
  localesConAdeudo.value = []
  localesSinAdeudo.value = []

  try {
    const resultConAdeudo = await executeStoredProcedure('SP_MERCADOS_GET_ADE_GLOBAL_LOCALES', [
      filtros.value.oficina,
      filtros.value.mercado,
      filtros.value.year,
      filtros.value.month
    ])
    localesConAdeudo.value = resultConAdeudo || []

    const resultSinAdeudo = await executeStoredProcedure('SP_MERCADOS_GET_LOCALES_SIN_ADEUDO', [
      filtros.value.mercado,
      filtros.value.year,
      filtros.value.month
    ])
    localesSinAdeudo.value = resultSinAdeudo || []

    if (localesConAdeudo.value.length === 0 && localesSinAdeudo.value.length === 0) {
      toast.info('No se encontraron resultados')
    } else {
      toast.success(`Se encontraron ${localesConAdeudo.value.length} locales con adeudo y ${localesSinAdeudo.value.length} sin adeudo`)
    }
  } catch (error) {
    handleError(error)
    toast.error('Error al buscar adeudos')
  } finally {
    loading.value = false
  }
}

const calcularTotal = (local) => {
  return (local.adeudo || 0) + (local.recargos || 0) + (local.multa || 0) + (local.gastos || 0)
}

const formatCurrency = (value) => {
  if (value == null) return ''
  return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value)
}

const exportarExcel = () => {
  try {
    const data = localesConAdeudo.value.map(loc => ({
      'Oficina': loc.oficina,
      'Mercado': loc.num_mercado,
      'Categoría': loc.categoria,
      'Sección': loc.seccion,
      'Local': loc.local,
      'Letra': loc.letra_local,
      'Nombre': loc.nombre,
      'Adeudo': loc.adeudo,
      'Recargos': loc.recargos,
      'Multa': loc.multa,
      'Gastos': loc.gastos,
      'Total': calcularTotal(loc)
    }))

    const ws = XLSX.utils.json_to_sheet(data)
    const wb = XLSX.utils.book_new()
    XLSX.utils.book_append_sheet(wb, ws, 'Adeudos')
    XLSX.writeFile(wb, `adeudos_${filtros.value.oficina}_${filtros.value.mercado}_${filtros.value.year}_${filtros.value.month}.xlsx`)
    toast.success('Archivo Excel generado correctamente')
  } catch (error) {
    toast.error('Error al generar Excel')
  }
}

onMounted(() => {
  cargarRecaudadoras()
  cargarMercados()
})
</script>



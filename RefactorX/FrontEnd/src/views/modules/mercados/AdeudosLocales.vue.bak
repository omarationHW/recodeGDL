<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="exclamation-triangle" />
      </div>
      <div class="module-view-info">
        <h1>Adeudos de Locales</h1>
        <p>Módulo de Mercados - Consulta y gestión de adeudos de locales</p>
      </div>
    </div>

    <div class="module-view-content">
      <!-- Card de Búsqueda -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h4 class="mb-0">
            <i class="fas fa-search me-2"></i>
            Búsqueda de Adeudos
          </h4>
        </div>
        <div class="municipal-card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="municipal-form-label">Oficina</label>
              <select v-model="filtros.oficina" class="municipal-form-control" @change="onOficinaChange">
                <option value="">Seleccione...</option>
                <option v-for="ofi in oficinas" :key="ofi.oficina" :value="ofi.oficina">
                  {{ ofi.oficina }} - {{ ofi.descripcion }}
                </option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="municipal-form-label">Mercado</label>
              <select v-model="filtros.num_mercado" class="municipal-form-control" @change="onMercadoChange">
                <option value="">Seleccione...</option>
                <option v-for="merc in mercados" :key="merc.num_mercado" :value="merc.num_mercado">
                  {{ merc.num_mercado }} - {{ merc.descripcion }}
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="municipal-form-label">Categoría</label>
              <input
                v-model.number="filtros.categoria"
                type="number"
                class="municipal-form-control"
                min="1"
                max="12"
                placeholder="1-12"
              />
            </div>
            <div class="col-md-2">
              <label class="municipal-form-label">Sección</label>
              <select v-model="filtros.seccion" class="municipal-form-control">
                <option value="">Todas</option>
                <option v-for="sec in secciones" :key="sec.seccion" :value="sec.seccion">
                  {{ sec.seccion }} - {{ sec.descripcion }}
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="municipal-form-label">Local</label>
              <input
                v-model.number="filtros.local"
                type="number"
                class="municipal-form-control"
                placeholder="Local"
              />
            </div>
            <div class="col-12">
              <button @click="buscarAdeudos" class="btn-municipal-primary" :disabled="loading">
                <span v-if="loading">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Buscando...
                </span>
                <span v-else>
                  <i class="fas fa-search me-2"></i>
                  Buscar
                </span>
              </button>
              <button @click="limpiar" class="btn-municipal-secondary ms-2">
                <i class="fas fa-eraser me-2"></i>
                Limpiar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div v-if="adeudos.length > 0" class="municipal-card mt-3">
        <div class="municipal-card-header bg-warning text-dark">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-list me-2"></i>
              Resultados: {{ adeudos.length }} adeudo(s) encontrado(s)
            </h5>
            <h5 class="mb-0">
              <i class="fas fa-dollar-sign me-2"></i>
              Total: {{ formatCurrency(totalAdeudo) }}
            </h5>
          </div>
        </div>
        <div class="municipal-card-body p-0">
          <div class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th>ID Local</th>
                  <th>Oficina</th>
                  <th>Mercado</th>
                  <th>Cat</th>
                  <th>Sec</th>
                  <th>Local</th>
                  <th>Letra</th>
                  <th>Bloque</th>
                  <th>Año</th>
                  <th>Periodo</th>
                  <th class="text-end">Importe</th>
                  <th>Fecha Desde</th>
                  <th>Fecha Hasta</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="adeudo in adeudos" :key="`${adeudo.id_local}-${adeudo.anio}-${adeudo.periodo}`">
                  <td class="fw-bold">{{ adeudo.id_local }}</td>
                  <td>{{ adeudo.oficina }}</td>
                  <td>{{ adeudo.num_mercado }}</td>
                  <td>{{ adeudo.categoria }}</td>
                  <td>{{ adeudo.seccion }}</td>
                  <td>{{ adeudo.local }}</td>
                  <td>{{ adeudo.letra_local || '-' }}</td>
                  <td>{{ adeudo.bloque || '-' }}</td>
                  <td>{{ adeudo.anio }}</td>
                  <td>{{ adeudo.periodo }}</td>
                  <td class="text-end fw-bold text-danger">{{ formatCurrency(adeudo.importe) }}</td>
                  <td>{{ formatDate(adeudo.fecha_desde) }}</td>
                  <td>{{ formatDate(adeudo.fecha_hasta) }}</td>
                  <td>
                    <span :class="`badge-${adeudo.estado === 'PENDIENTE' ? 'warning' : 'danger'}`">
                      {{ adeudo.estado }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div v-else-if="searchPerformed && !loading" class="municipal-card mt-3">
        <div class="municipal-card-body text-center py-5">
          <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
          <h5 class="text-muted">No se encontraron adeudos</h5>
          <p class="text-muted mb-0">El local está al corriente en sus pagos</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

// State
const loading = ref(false)
const searchPerformed = ref(false)
const oficinas = ref([])
const mercados = ref([])
const secciones = ref([])
const adeudos = ref([])

const filtros = ref({
  oficina: '',
  num_mercado: '',
  categoria: null,
  seccion: '',
  local: null
})

// Computed
const totalAdeudo = computed(() => {
  return adeudos.value.reduce((sum, adeudo) => sum + (parseFloat(adeudo.importe) || 0), 0)
})

// Methods
const loadCatalogos = async () => {
  try {
    const [oficinasResp, seccionesResp] = await Promise.all([
      executeStoredProcedure('SP_MERCADOS_GET_OFICINAS', {}),
      executeStoredProcedure('SP_MERCADOS_GET_SECCIONES', {})
    ])

    if (oficinasResp.success && oficinasResp.data) {
      oficinas.value = oficinasResp.data
    }

    if (seccionesResp.success && seccionesResp.data) {
      secciones.value = seccionesResp.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar catálogos')
  }
}

const onOficinaChange = async () => {
  mercados.value = []
  filtros.value.num_mercado = ''
  filtros.value.categoria = null

  if (!filtros.value.oficina) return

  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_MERCADOS_BY_OFICINA', {
      p_oficina: filtros.value.oficina
    })
    if (response.success && response.data) {
      mercados.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar mercados')
  }
}

const onMercadoChange = () => {
  const selected = mercados.value.find(m => m.num_mercado === filtros.value.num_mercado)
  if (selected) {
    filtros.value.categoria = selected.categoria
  }
}

const buscarAdeudos = async () => {
  if (!filtros.value.oficina || !filtros.value.num_mercado) {
    toast.error('Seleccione oficina y mercado')
    return
  }

  loading.value = true
  searchPerformed.value = true
  adeudos.value = []

  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_ADEUDOS_LOCALES', {
      p_oficina: filtros.value.oficina,
      p_num_mercado: filtros.value.num_mercado,
      p_categoria: filtros.value.categoria || null,
      p_seccion: filtros.value.seccion || null,
      p_local: filtros.value.local || null
    })

    if (response.success && response.data) {
      adeudos.value = response.data
      if (adeudos.value.length === 0) {
        toast.info('No se encontraron adeudos')
      } else {
        toast.success(`${adeudos.value.length} adeudo(s) encontrado(s)`)
      }
    }
  } catch (error) {
    handleError(error, 'Error al buscar adeudos')
  } finally {
    loading.value = false
  }
}

const limpiar = () => {
  adeudos.value = []
  searchPerformed.value = false
  filtros.value = {
    oficina: '',
    num_mercado: '',
    categoria: null,
    seccion: '',
    local: null
  }
  mercados.value = []
  toast.info('Formulario limpiado')
}

const formatCurrency = (value) => {
  if (!value) return '$0.00'
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value)
}

const formatDate = (dateString) => {
  if (!dateString) return ''
  const date = new Date(dateString)
  return date.toLocaleDateString('es-MX')
}

// Lifecycle
onMounted(() => {
  loadCatalogos()
})
</script>

<template>
  <div class="module-view">
    <!-- Header -->
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="cash-register" />
      </div>
      <div class="module-view-info">
        <h1>Alta de Pagos de Locales</h1>
        <p>Mercados - Registro de pagos de renta de locales comerciales</p>
      </div>
      <div class="module-view-actions">
        <button class="btn-help-icon" @click="mostrarAyuda = true" title="Ayuda">
          <font-awesome-icon icon="question-circle" />
          Ayuda
        </button>
      </div>
    </div>

    <!-- B�squeda de Local -->
    <div class="municipal-card">
      <h5 class="municipal-card-header">
        <font-awesome-icon icon="search" /> B�squeda de Local
      </h5>
      <form @submit.prevent="buscarLocal" class="municipal-form">
        <div class="form-row">
          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">Oficina</label>
              <select v-model.number="busqueda.oficina" class="municipal-form-control" required :disabled="localEncontrado">
                <option value="">Seleccione</option>
                <option
                  v-for="rec in recaudadoras"
                  :key="rec.id_rec"
                  :value="rec.id_rec"
                >
                  {{ rec.id_rec }} - {{ rec.recaudadora }}
                </option>
              </select>
            </div>
        </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">Mercado</label>
              <select v-model.number="busqueda.num_mercado" class="municipal-form-control" required :disabled="localEncontrado">
                <option value="">Seleccione</option>
                <option
                  v-for="mercado in mercados"
                  :key="mercado.num_mercado_nvo"
                  :value="mercado.num_mercado_nvo"
                >
                  {{ mercado.num_mercado_nvo }} - {{ mercado.descripcion }}
                </option>
              </select>
            </div>
        </div>

          <div class="col-md-1">
            <div class="form-group">
              <label class="municipal-form-label required">Cat</label>
              <input
                type="number"
                v-model.number="busqueda.categoria"
                class="municipal-form-control"
                required
                :disabled="localEncontrado"
              />
            </div>
        </div>

          <div class="col-md-1">
            <div class="form-group">
              <label class="municipal-form-label required">Secc</label>
              <select v-model="busqueda.seccion" class="municipal-form-control" required :disabled="localEncontrado">
                <option value="">-</option>
                <option
                  v-for="sec in secciones"
                  :key="sec.seccion"
                  :value="sec.seccion"
                >
                  {{ sec.seccion }}
                </option>
              </select>
            </div>
        </div>

          <div class="col-md-1">
            <div class="form-group">
              <label class="municipal-form-label required">Local</label>
              <input
                type="number"
                v-model.number="busqueda.local"
                class="municipal-form-control"
                required
                :disabled="localEncontrado"
              />
            </div>
        </div>

          <div class="col-md-1">
            <div class="form-group">
              <label class="municipal-form-label">Letra</label>
              <input
                type="text"
                v-model="busqueda.letra_local"
                class="municipal-form-control"
                maxlength="1"
                :disabled="localEncontrado"
              />
            </div>
        </div>

          <div class="col-md-1">
            <div class="form-group">
              <label class="municipal-form-label">Bloque</label>
              <input
                type="text"
                v-model="busqueda.bloque"
                class="municipal-form-control"
                maxlength="1"
                :disabled="localEncontrado"
              />
            </div>
        </div>

          <div class="col-md-3">
            <div class="form-group">
              <label class="municipal-form-label">&nbsp;</label>
              <div class="d-flex gap-2">
                <button
                  v-if="!localEncontrado"
                  type="submit"
                  class="btn-municipal-primary flex-grow-1"
                  :disabled="cargandoBusqueda"
                >
                  <font-awesome-icon :icon="cargandoBusqueda ? 'spinner' : 'search'" :spin="cargandoBusqueda" />
                  Buscar
                </button>
                <button
                  v-else
                  type="button"
                  class="btn-municipal-warning flex-grow-1"
                  @click="limpiarBusqueda"
                >
                  <font-awesome-icon icon="redo" />
                  Nuevo
                </button>
              </div>
        </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Informaci�n del Local Encontrado -->
    <div v-if="localEncontrado" class="municipal-card">
      <h5 class="municipal-card-header">
        <font-awesome-icon icon="store" /> Informaci�n del Local
      </h5>
      <div class="row">
        <div class="col-md-6">
          <p><strong>Ubicaci�n:</strong> {{ formatUbicacion(localActual) }}</p>
          <p><strong>Nombre:</strong> {{ localActual.nombre }}</p>
          <p><strong>Arrendatario:</strong> {{ localActual.arrendatario }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Superficie:</strong> {{ localActual.superficie }} m�</p>
          <p><strong>Clave Cuota:</strong> {{ localActual.clave_cuota }}</p>
          <p>
            <strong>Estado:</strong>
            <span :class="localActual.bloqueo > 0 ? 'badge bg-warning' : 'badge bg-success'">
              {{ localActual.bloqueo > 0 ? 'Con Bloqueo' : 'Activo' }}
            </span>
          </p>
        </div>
        </div>
    </div>

    <!-- Formulario de Pago -->
    <div v-if="localEncontrado" class="municipal-card">
      <h5 class="municipal-card-header">
        <font-awesome-icon icon="money-bill-wave" /> Datos del Pago
      </h5>
      <form @submit.prevent="guardarPago" class="municipal-form">
        <div class="form-row">
          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">A�o</label>
              <input
                type="number"
                v-model.number="formPago.axo"
                class="municipal-form-control"
                required
                min="2000"
                :max="new Date().getFullYear()"
                @change="verificarPagoExistente"
              />
            </div>
        </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">Periodo (Mes)</label>
              <select v-model.number="formPago.periodo" class="municipal-form-control" required @change="verificarPagoExistente">
                <option v-for="mes in meses" :key="mes.value" :value="mes.value">
                  {{ mes.label }}
                </option>
              </select>
            </div>
        </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">Fecha Pago</label>
              <input
                type="date"
                v-model="formPago.fecha_pago"
                class="municipal-form-control"
                required
              />
            </div>
        </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">Oficina Pago</label>
              <select v-model.number="formPago.oficina_pago" class="municipal-form-control" required>
                <option value="">Seleccione</option>
                <option
                  v-for="rec in recaudadoras"
                  :key="rec.id_rec"
                  :value="rec.id_rec"
                >
                  {{ rec.recaudadora }}
                </option>
              </select>
            </div>
        </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label">Caja</label>
              <input
                type="text"
                v-model="formPago.caja_pago"
                class="municipal-form-control"
                maxlength="10"
              />
            </div>
        </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label">Operaci�n</label>
              <input
                type="number"
                v-model.number="formPago.operacion_pago"
                class="municipal-form-control"
              />
            </div>
        </div>
        </div>

        <div class="form-row">
          <div class="col-md-3">
            <div class="form-group">
              <label class="municipal-form-label required">Importe</label>
              <input
                type="number"
                v-model.number="formPago.importe_pago"
                class="municipal-form-control"
                required
                min="0"
                step="0.01"
              />
            </div>
        </div>

          <div class="col-md-3">
            <div class="form-group">
              <label class="municipal-form-label">Folio</label>
              <input
                type="text"
                v-model="formPago.folio"
                class="municipal-form-control"
                maxlength="20"
              />
            </div>
        </div>

          <div class="col-md-6">
            <div class="form-group">
              <label class="municipal-form-label">&nbsp;</label>
              <div class="d-flex gap-2">
                <button type="submit" class="btn-municipal-primary" :disabled="guardando">
                  <font-awesome-icon :icon="guardando ? 'spinner' : 'save'" :spin="guardando" />
                  {{ modoEdicion ? 'Actualizar Pago' : 'Registrar Pago' }}
                </button>
                <button
                  v-if="modoEdicion"
                  type="button"
                  class="btn-municipal-danger"
                  @click="eliminarPago"
                  :disabled="guardando"
                >
                  <font-awesome-icon icon="trash" />
                  Eliminar Pago
                </button>
                <button
                  type="button"
                  class="btn-municipal-secondary"
                  @click="limpiarFormulario"
                >
                  <font-awesome-icon icon="times" />
                  Cancelar
                </button>
              </div>
        </div>
          </div>
        </div>

        <!-- Estado del Pago/Adeudo -->
        <div v-if="estadoPago" class="alert" :class="estadoPago.tipo === 'pago' ? 'alert-success' : 'alert-warning'">
          <font-awesome-icon :icon="estadoPago.tipo === 'pago' ? 'check-circle' : 'exclamation-triangle'" />
          <strong>{{ estadoPago.mensaje }}</strong>
          <span v-if="estadoPago.importe">
            - Importe: ${{ formatCurrency(estadoPago.importe) }}
          </span>
        </div>
      </form>
    </div>

    <!-- Modal: Ayuda -->
    <DocumentationModal
      :show="mostrarAyuda"
      @close="mostrarAyuda = false"
      title="Ayuda - Alta de Pagos de Locales"
    >
      <h5>Descripci�n del M�dulo</h5>
      <p>
        Este m�dulo permite registrar, modificar y eliminar pagos de renta de locales comerciales
        en los mercados municipales. Gestiona la relaci�n entre pagos y adeudos autom�ticamente.
      </p>

      <h5>Proceso de Registro de Pagos</h5>
      <ol>
        <li><strong>Buscar Local:</strong> Ingrese la ubicaci�n completa del local (oficina, mercado, categor�a, secci�n, local, letra y bloque)</li>
        <li><strong>Verificar Informaci�n:</strong> Revise que la informaci�n del local sea correcta</li>
        <li><strong>Ingresar Datos del Pago:</strong> Complete todos los campos requeridos del formulario</li>
        <li><strong>Guardar:</strong> El sistema registrar� el pago y eliminar� autom�ticamente el adeudo si existe</li>
      </ol>

      <h5>Campos del Formulario</h5>
      <ul>
        <li><strong>A�o:</strong> Ejercicio fiscal del pago (requerido)</li>
        <li><strong>Periodo:</strong> Mes al que corresponde el pago (requerido)</li>
        <li><strong>Fecha Pago:</strong> Fecha en que se realiz� el pago (requerido)</li>
        <li><strong>Oficina Pago:</strong> Recaudadora donde se realiz� el pago (requerido)</li>
        <li><strong>Caja:</strong> Identificador de la caja receptora (opcional)</li>
        <li><strong>Operaci�n:</strong> N�mero de operaci�n del sistema de pagos (opcional)</li>
        <li><strong>Importe:</strong> Monto del pago en pesos (requerido)</li>
        <li><strong>Folio:</strong> N�mero de folio o recibo (opcional)</li>
      </ul>

      <h5>Funciones Principales</h5>
      <ul>
        <li><strong>Registrar Pago:</strong> Si no existe pago para el a�o/periodo, se crea uno nuevo</li>
        <li><strong>Modificar Pago:</strong> Si ya existe pago, se actualizan los datos</li>
        <li><strong>Eliminar Pago:</strong> Borra el pago y regenera el adeudo autom�ticamente</li>
        <li><strong>Buscar Nuevo Local:</strong> Click en "Nuevo" para buscar otro local</li>
      </ul>

      <h5>Validaciones</h5>
      <ul>
        <li>El local debe estar activo (vigencia = 'A')</li>
        <li>El local no debe tener bloqueo nivel 4 o superior</li>
        <li>Todos los campos marcados como requeridos deben completarse</li>
        <li>El importe debe ser mayor a cero</li>
      </ul>

      <h5>Relaci�n Pagos-Adeudos</h5>
      <p>
        <strong>Al registrar un pago:</strong> Si existe un adeudo para el mismo local, a�o y periodo,
        se elimina autom�ticamente.
      </p>
      <p>
        <strong>Al eliminar un pago:</strong> Si no existe adeudo para el local, a�o y periodo,
        se regenera autom�ticamente con el importe del pago eliminado.
      </p>

      <h5>Notas Importantes</h5>
      <ul>
        <li>Verifique que el periodo (mes) corresponda al pago que desea registrar</li>
        <li>Al eliminar un pago, se mostrar� una confirmaci�n antes de proceder</li>
        <li>Los pagos existentes se pueden modificar seleccionando un a�o/periodo ya registrado</li>
        <li>Use el bot�n "Nuevo" para limpiar la b�squeda y buscar otro local</li>
      </ul>
    </DocumentationModal>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from '@/composables/useToast'
import Swal from 'sweetalert2'
import DocumentationModal from '@/components/common/DocumentationModal.vue'

const { execute } = useApi()
const { handleApiError } = useLicenciasErrorHandler()
const { showToast } = useToast()

// Estado
const cargandoBusqueda = ref(false)
const guardando = ref(false)
const localEncontrado = ref(false)
const modoEdicion = ref(false)
const mostrarAyuda = ref(false)

// Datos
const recaudadoras = ref([])
const mercados = ref([])
const secciones = ref([])
const localActual = ref(null)
const estadoPago = ref(null)

// Formularios
const busqueda = ref({
  oficina: '',
  num_mercado: '',
  categoria: '',
  seccion: '',
  local: '',
  letra_local: '',
  bloque: ''
})

const formPago = ref({
  axo: new Date().getFullYear(),
  periodo: new Date().getMonth() + 1,
  fecha_pago: new Date().toISOString().split('T')[0],
  oficina_pago: '',
  caja_pago: '',
  operacion_pago: null,
  importe_pago: 0,
  folio: ''
})

// Cat�logos
const meses = [
  { value: 1, label: 'Enero' },
  { value: 2, label: 'Febrero' },
  { value: 3, label: 'Marzo' },
  { value: 4, label: 'Abril' },
  { value: 5, label: 'Mayo' },
  { value: 6, label: 'Junio' },
  { value: 7, label: 'Julio' },
  { value: 8, label: 'Agosto' },
  { value: 9, label: 'Septiembre' },
  { value: 10, label: 'Octubre' },
  { value: 11, label: 'Noviembre' },
  { value: 12, label: 'Diciembre' }
]

// Watchers
watch(() => busqueda.value.oficina, () => {
  if (busqueda.value.oficina) {
    cargarMercados()
  } else {
    mercados.value = []
  }
})

// M�todos
const cargarRecaudadoras = async () => {
  try {
    const response = await execute('SP_MERCADOS_RECAUDADORAS_LIST', 'mercados', {})
    recaudadoras.value = response || []
  } catch (error) {
    handleApiError(error, 'Error al cargar recaudadoras')
  }
}

const cargarMercados = async () => {
  if (!busqueda.value.oficina) return

  try {
    const response = await execute('SP_MERCADOS_MERCADOS_LIST', 'mercados', {
      p_oficina: parseInt(busqueda.value.oficina)
    })
    mercados.value = response || []
  } catch (error) {
    handleApiError(error, 'Error al cargar mercados')
  }
}

const cargarSecciones = async () => {
  try {
    const response = await execute('SP_MERCADOS_SECCIONES_LIST', 'mercados', {})
    secciones.value = response || []
  } catch (error) {
    handleApiError(error, 'Error al cargar secciones')
  }
}

const buscarLocal = async () => {
  cargandoBusqueda.value = true
  estadoPago.value = null

  try {
    const response = await execute('SP_MERCADOS_BUSCAR_LOCAL', 'mercados', {
      p_oficina: parseInt(busqueda.value.oficina),
      p_num_mercado: parseInt(busqueda.value.num_mercado),
      p_categoria: parseInt(busqueda.value.categoria),
      p_seccion: busqueda.value.seccion,
      p_local: parseInt(busqueda.value.local),
      p_letra_local: busqueda.value.letra_local || null,
      p_bloque: busqueda.value.bloque || null
    })

    if (response && response.length > 0) {
      localActual.value = response[0]
      localEncontrado.value = true
      formPago.value.oficina_pago = localActual.value.oficina
      showToast('Local encontrado correctamente', 'success')

      // Verificar si hay pago para el periodo actual
      await verificarPagoExistente()
    } else {
      showToast('No se encontr� el local o est� bloqueado', 'error')
      localEncontrado.value = false
      localActual.value = null
    }
  } catch (error) {
    handleApiError(error, 'Error al buscar local')
    localEncontrado.value = false
  } finally {
    cargandoBusqueda.value = false
  }
}

const verificarPagoExistente = async () => {
  if (!localActual.value || !formPago.value.axo || !formPago.value.periodo) return

  estadoPago.value = null
  modoEdicion.value = false

  try {
    // Verificar pago
    const responsePago = await execute('SP_MERCADOS_CONSULTAR_PAGO', 'mercados', {
      p_id_local: localActual.value.id_local,
      p_axo: formPago.value.axo,
      p_periodo: formPago.value.periodo
    })

    if (responsePago && responsePago.length > 0) {
      const pago = responsePago[0]
      modoEdicion.value = true

      // Llenar formulario con datos del pago
      formPago.value.fecha_pago = pago.fecha_pago
      formPago.value.oficina_pago = pago.oficina_pago
      formPago.value.caja_pago = pago.caja_pago || ''
      formPago.value.operacion_pago = pago.operacion_pago
      formPago.value.importe_pago = parseFloat(pago.importe_pago)
      formPago.value.folio = pago.folio || ''

      estadoPago.value = {
        tipo: 'pago',
        mensaje: 'Ya existe un pago registrado para este periodo',
        importe: pago.importe_pago
      }
    } else {
      // Verificar adeudo
      const responseAdeudo = await execute('SP_MERCADOS_CONSULTAR_ADEUDO', 'mercados', {
        p_id_local: localActual.value.id_local,
        p_axo: formPago.value.axo,
        p_periodo: formPago.value.periodo
      })

      if (responseAdeudo && responseAdeudo.length > 0) {
        const adeudo = responseAdeudo[0]
        formPago.value.importe_pago = parseFloat(adeudo.importe)

        estadoPago.value = {
          tipo: 'adeudo',
          mensaje: 'Existe un adeudo pendiente para este periodo',
          importe: adeudo.importe
        }
      }
    }
  } catch (error) {
    console.error('Error al verificar pago/adeudo:', error)
  }
}

const guardarPago = async () => {
  if (!localActual.value) return

  guardando.value = true

  try {
    const params = {
      p_id_local: localActual.value.id_local,
      p_axo: formPago.value.axo,
      p_periodo: formPago.value.periodo,
      p_fecha_pago: formPago.value.fecha_pago,
      p_oficina_pago: parseInt(formPago.value.oficina_pago),
      p_caja_pago: formPago.value.caja_pago || '',
      p_operacion_pago: formPago.value.operacion_pago || 0,
      p_importe_pago: parseFloat(formPago.value.importe_pago),
      p_folio: formPago.value.folio || '',
      p_id_usuario: 1 // TODO: Obtener del contexto de usuario
    }

    let response
    if (modoEdicion.value) {
      response = await execute('SP_MERCADOS_MODIFICAR_PAGO', 'mercados', params)
    } else {
      response = await execute('SP_MERCADOS_AGREGAR_PAGO', 'mercados', params)
    }

    if (response && response.length > 0) {
      const resultado = response[0]
      if (resultado.success === 1 || resultado.success === true) {
        showToast(resultado.message, 'success')
        await verificarPagoExistente()
      } else {
        showToast(resultado.message, 'error')
      }
    }
  } catch (error) {
    handleApiError(error, 'Error al guardar pago')
  } finally {
    guardando.value = false
  }
}

const eliminarPago = async () => {
  if (!localActual.value) return

  const result = await Swal.fire({
    title: '�Eliminar pago?',
    text: 'Se regenerar� el adeudo autom�ticamente. Esta acci�n no se puede deshacer.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S�, eliminar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#d33',
    cancelButtonColor: '#6c757d'
  })

  if (result.isConfirmed) {
    guardando.value = true

    try {
      const response = await execute('SP_MERCADOS_BORRAR_PAGO', 'mercados', {
        p_id_local: localActual.value.id_local,
        p_axo: formPago.value.axo,
        p_periodo: formPago.value.periodo,
        p_id_usuario: 1 // TODO: Obtener del contexto de usuario
      })

      if (response && response.length > 0) {
        const resultado = response[0]
        if (resultado.success === 1 || resultado.success === true) {
          showToast(resultado.message, 'success')
          limpiarFormulario()
        } else {
          showToast(resultado.message, 'error')
        }
      }
    } catch (error) {
      handleApiError(error, 'Error al eliminar pago')
    } finally {
      guardando.value = false
    }
  }
}

const limpiarBusqueda = () => {
  busqueda.value = {
    oficina: '',
    num_mercado: '',
    categoria: '',
    seccion: '',
    local: '',
    letra_local: '',
    bloque: ''
  }
  localEncontrado.value = false
  localActual.value = null
  mercados.value = []
  limpiarFormulario()
}

const limpiarFormulario = () => {
  formPago.value = {
    axo: new Date().getFullYear(),
    periodo: new Date().getMonth() + 1,
    fecha_pago: new Date().toISOString().split('T')[0],
    oficina_pago: localActual.value ? localActual.value.oficina : '',
    caja_pago: '',
    operacion_pago: null,
    importe_pago: 0,
    folio: ''
  }
  estadoPago.value = null
  modoEdicion.value = false

  if (localActual.value) {
    verificarPagoExistente()
  }
}

const formatUbicacion = (local) => {
  let ubicacion = `${local.oficina}-${local.num_mercado}-${local.categoria}-${local.seccion}-${local.num_local}`
  if (local.letra_local) {
    ubicacion += `-${local.letra_local}`
  }
  if (local.bloque) {
    ubicacion += `-${local.bloque}`
  }
  return ubicacion
}

const formatCurrency = (value) => {
  if (!value) return '0.00'
  return parseFloat(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
}

// Lifecycle
onMounted(() => {
  cargarRecaudadoras()
  cargarSecciones()
})
</script>



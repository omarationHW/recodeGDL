<template>
    <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="upload" />
      </div>
      <div class="module-view-info">
        <h1>Carga Especial de Pagos Diversos</h1>
        <p>Módulo de Mercados</p>
      </div>
        </div>

    <div class="module-view-content">

    <div class="municipal-card">
      <div class="municipal-card-header"><i class="fas fa-calendar"></i> Seleccionar Fecha de Pago</div>
      <div class="municipal-card-body">
        <div class="row g-3">
          <div class="form-group">
            <label class="municipal-form-label">Fecha de Pago *</label>
            <input type="date" v-model="fechaPago" class="municipal-form-control" />
          </div>
          <div class="form-group">
            <button class="btn-municipal-primary" @click="buscarAdeudos" :disabled="!fechaPago || loading">
              <i class="fas fa-search"></i> Buscar
            </button>
            <button class="btn-municipal-success" @click="cargarPagos" :disabled="!hayPagosValidos || loading">
              <i class="fas fa-save"></i> Grabar Pagos
            </button>
            <button class="btn-municipal-secondary" @click="$router.push('/mercados')">
              <i class="fas fa-arrow-left"></i> Salir
            </button>
          </div>
        </div>
      </div>
        </div>

    <div v-if="loading" class="text-center p-5">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Procesando...</p>
    </div>

    <div v-if="error" class="alert alert-danger alert-dismissible fade show">
      <i class="fas fa-exclamation-triangle"></i> {{ error }}
      <button type="button" class="btn-close" @click="error = ''"></button>
    </div>

    <div v-if="adeudos.length > 0" class="municipal-card">
      <div class="municipal-card-header bg-warning">
        <i class="fas fa-table"></i> Pagos Diversos Pendientes de Carga ({{ adeudos.length }})
      </div>
      <div class="municipal-card-body">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table-header">
              <tr>
                <th>FECHA</th>
                <th>REC</th>
                <th>CAJA</th>
                <th>OPER</th>
                <th>AÑO</th>
                <th>MES</th>
                <th class="text-end">RENTA</th>
                <th>OFN</th>
                <th>MER</th>
                <th>CAT</th>
                <th>SEC</th>
                <th>LOCAL</th>
                <th>LET</th>
                <th>PARTIDA *</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(row, idx) in adeudos" :key="idx">
                <td>{{ formatDate(row.fecha) }}</td>
                <td>{{ row.rec }}</td>
                <td>{{ row.caja }}</td>
                <td>{{ row.oper }}</td>
                <td>{{ row.anio }}</td>
                <td>{{ row.mes }}</td>
                <td class="text-end">{{ formatCurrency(row.renta) }}</td>
                <td>{{ row.ofn }}</td>
                <td>{{ row.mer }}</td>
                <td>{{ row.cat }}</td>
                <td>{{ row.sec }}</td>
                <td>{{ row.local_num }}</td>
                <td>{{ row.let }}</td>
                <td>
                  <input
                    type="text"
                    v-model="pagos[idx].partida"
                    class="municipal-form-control form-control-sm"
                    maxlength="20"
                    placeholder="Número de partida"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="alert alert-info mt-3 mb-0">
          <i class="fas fa-info-circle"></i>
          <strong>Nota:</strong> Solo se grabarán los pagos con número de partida distinto de vacío o cero.
          Se han encontrado {{ adeudos.length }} pagos pendientes.
        </div>
        </div>
    </div>

    <div v-if="successMsg" class="alert alert-success mt-3">
      <i class="fas fa-check-circle"></i> {{ successMsg }}
    </div>

    <div v-if="!loading && adeudos.length === 0 && searched" class="alert alert-info">
      <i class="fas fa-info-circle"></i> No se encontraron pagos diversos pendientes para la fecha seleccionada
    </div>
        </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, computed } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'
import Swal from 'sweetalert2'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const fechaPago = ref('')
const adeudos = ref([])
const pagos = ref([])
const loading = ref(false)
const searched = ref(false)
const error = ref('')
const successMsg = ref('')

const hayPagosValidos = computed(() => {
  return pagos.value.some(p => p.partida && p.partida !== '0')
})

const buscarAdeudos = async () => {
  if (!fechaPago.value) {
    toast.warning('Debe seleccionar una fecha de pago')
    return
  }

  loading.value = true
  searched.value = true
  error.value = ''
  successMsg.value = ''
  adeudos.value = []
  pagos.value = []

  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_ADEUDOS_DIVERSOS_ESP', [fechaPago.value])

    if (result && result.length > 0) {
      adeudos.value = result
      pagos.value = result.map(() => ({ partida: '' }))
      toast.success(`Se encontraron ${result.length} pagos diversos pendientes`)
    } else {
      toast.info('No se encontraron pagos diversos para la fecha seleccionada')
    }
  } catch (err) {
    handleError(err)
    error.value = 'Error al buscar adeudos diversos'
    toast.error(error.value)
  } finally {
    loading.value = false
  }
}

const cargarPagos = async () => {
  // Filtrar pagos válidos
  const pagosValidos = []
  adeudos.value.forEach((row, idx) => {
    const partida = pagos.value[idx].partida
    if (partida && partida !== '0') {
      pagosValidos.push({
        id_pago_diversos: row.id_pago_diversos,
        partida: partida
      })
    }
  })

  if (pagosValidos.length === 0) {
    error.value = 'No hay pagos válidos para grabar. Debe ingresar al menos un número de partida.'
    toast.warning(error.value)
    return
  }

  const result = await Swal.fire({
    title: '¿Confirmar Carga?',
    text: `Se cargarán ${pagosValidos.length} pagos. Esta acción afectará los adeudos del sistema.`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sí, cargar',
    cancelButtonText: 'Cancelar'
  })

  if (!result.isConfirmed) return

  loading.value = true
  error.value = ''
  successMsg.value = ''

  try {
    let cargadosOk = 0
    let errores = 0

    for (const pago of pagosValidos) {
      try {
        const resultado = await executeStoredProcedure('SP_MERCADOS_CARGAR_PAGOS_DIVERSOS', [
          pago.id_pago_diversos,
          pago.partida,
          1, // id_usuario - debería venir del contexto del usuario
          fechaPago.value
        ])

        if (resultado && resultado[0] && resultado[0].resultado === 1) {
          cargadosOk++
        } else {
          errores++
        }
      } catch (err) {
        errores++
      }
    }

    if (errores === 0) {
      successMsg.value = `Todos los pagos (${cargadosOk}) se cargaron correctamente.`
      toast.success(successMsg.value)
      // Recargar adeudos
      await buscarAdeudos()
    } else {
      error.value = `Se cargaron ${cargadosOk} pagos correctamente, pero ${errores} tuvieron errores.`
      toast.warning(error.value)
      await buscarAdeudos()
    }
  } catch (err) {
    handleError(err)
    error.value = 'Error al cargar pagos diversos'
    toast.error(error.value)
  } finally {
    loading.value = false
  }
}

const formatDate = (dateStr) => {
  if (!dateStr) return ''
  const d = new Date(dateStr)
  return d.toLocaleDateString('es-MX')
}

const formatCurrency = (value) => {
  if (value == null) return ''
  return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value)
}
</script>



<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="calendar-alt" />
      </div>
      <div class="module-view-info">
        <h1>Consulta de Captura por Fecha</h1>
        <p>MÃ³dulo de Mercados - Consulta de pagos capturados por fecha</p>
      </div>
        </div>

    <div class="module-view-content">
      <!-- Card de Filtros -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h5 class="mb-0">
          <i class="fas fa-filter me-2"></i>
          Filtros de Búsqueda
        </h5>
        </div>
        <div class="municipal-card-body">
        <div class="row g-3">
          <!-- Oficina -->
          <div class="form-group">
            <label class="municipal-form-label">Oficina</label>
            <select v-model="filtros.oficina" class="municipal-form-control" @change="onOficinaChange">
              <option value="">Todas</option>
              <option v-for="o in oficinas" :key="o.oficina" :value="o.oficina">
                {{ o.oficina }}
              </option>
            </select>
          </div>

          <!-- Caja -->
          <div class="form-group">
            <label class="municipal-form-label">Caja</label>
            <select v-model="filtros.caja" class="municipal-form-control">
              <option value="">Todas</option>
              <option v-for="c in cajas" :key="c.caja" :value="c.caja">
                {{ c.caja }}
              </option>
            </select>
          </div>

          <!-- Operación -->
          <div class="form-group">
            <label class="municipal-form-label">Operación</label>
            <input
              v-model="filtros.operacion"
              type="text"
              class="municipal-form-control"
              placeholder="Operación"
            />
          </div>

          <!-- Fecha Desde -->
          <div class="form-group">
            <label class="municipal-form-label">Fecha Desde</label>
            <input
              v-model="filtros.fecha_desde"
              type="date"
              class="municipal-form-control"
            />
          </div>

          <!-- Fecha Hasta -->
          <div class="form-group">
            <label class="municipal-form-label">Fecha Hasta</label>
            <input
              v-model="filtros.fecha_hasta"
              type="date"
              class="municipal-form-control"
            />
          </div>

          <!-- Botones -->
          <div class="form-group">
            <button
              class="btn-municipal-primary"
              @click="buscarPagos"
              :disabled="loading"
            >
              <i class="fas fa-search me-2"></i>
              Buscar
            </button>
            <button
              class="btn-municipal-secondary"
              @click="limpiarFiltros"
            >
              <i class="fas fa-eraser me-2"></i>
              Limpiar
            </button>
            <button
              v-if="pagosSeleccionados.length > 0"
              class="btn-municipal-danger ms-auto"
              @click="deleteSeleccionados"
            >
              <i class="fas fa-trash me-2"></i>
              Eliminar Seleccionados ({{ pagosSeleccionados.length }})
            </button>
          </div>
        </div>
      </div>
        </div>

    <!-- Card de Resultados -->
      <div class="municipal-card">
        <div class="municipal-card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="fas fa-calendar-check me-2"></i>
            Pagos de Locales Capturados
          </h4>
          <span class="badge bg-primary fs-6">
            {{ pagos.length }} registros
          </span>
        </div>
        </div>

      <div class="municipal-card-body">
        <!-- Loading State -->
        <div v-if="loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-3 text-muted">Buscando pagos...</p>
        </div>

        <!-- Tabla de Pagos -->
        <div v-else class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table">
              <tr>
                <th style="width: 50px;">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    @change="toggleSelectAll"
                    :checked="selectAll"
                  />
                </th>
                <th>ID Pago</th>
                <th>Mercado</th>
                <th>Local</th>
                <th>Año</th>
                <th>Periodo</th>
                <th class="text-end">Importe</th>
                <th>Partida</th>
                <th>Caja</th>
                <th>Operación</th>
                <th>Fecha Pago</th>
                <th>Fecha Captura</th>
                <th>Usuario</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr v-if="pagos.length === 0 && !loading">
                <td colspan="14" class="text-center text-muted py-4">
                  <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                  No se encontraron pagos con los filtros especificados
                </td>
              </tr>
              <tr
                v-for="pago in pagos"
                :key="pago.id_pago_local"
                :class="{ 'table-active': pago.selected }"
              >
                <td>
                  <input
                    type="checkbox"
                    class="form-check-input"
                    v-model="pago.selected"
                  />
                </td>
                <td>{{ pago.id_pago_local }}</td>
                <td>
                  <div class="fw-bold">{{ pago.nombre_mercado }}</div>
                  <small class="text-muted">{{ pago.mercado }}</small>
                </td>
                <td>
                  <div>{{ pago.local }}</div>
                  <small class="text-muted">
                    Cat: {{ pago.categoria }} | Sec: {{ pago.seccion }}
                  </small>
                </td>
                <td>{{ pago.anio }}</td>
                <td>{{ pago.periodo }}</td>
                <td class="text-end fw-bold">{{ formatCurrency(pago.importe) }}</td>
                <td>{{ pago.partida }}</td>
                <td>{{ pago.caja }}</td>
                <td>{{ pago.operacion }}</td>
                <td>{{ formatDate(pago.fecha_pago) }}</td>
                <td>{{ formatDate(pago.fecha_captura) }}</td>
                <td>
                  <small>{{ pago.usuario_captura }}</small>
                </td>
                <td class="text-center">
                  <button
                    class="btn-action btn-delete"
                    @click="deletePago(pago)"
                    title="Eliminar pago"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
            <tfoot v-if="pagos.length > 0" class="municipal-table">
              <tr>
                <th colspan="6" class="text-end">TOTAL:</th>
                <th class="text-end fw-bold">{{ formatCurrency(totalImporte) }}</th>
                <th colspan="7"></th>
              </tr>
            </tfoot>
          </table>
        </div>
        </div>
    </div>
        </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'
import Swal from 'sweetalert2'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

// State
const pagos = ref([])
const oficinas = ref([])
const cajas = ref([])
const loading = ref(false)

const filtros = ref({
  oficina: '',
  caja: '',
  operacion: '',
  fecha_desde: '',
  fecha_hasta: ''
})

// Computed
const totalImporte = computed(() => {
  return pagos.value.reduce((sum, pago) => sum + parseFloat(pago.importe || 0), 0)
})

const pagosSeleccionados = computed(() => {
  return pagos.value.filter(p => p.selected)
})

const selectAll = computed(() => {
  return pagos.value.length > 0 && pagos.value.every(p => p.selected)
})

// Cargar catálogos
const loadCatalogos = async () => {
  try {
    // Oficinas
    const oficinasResponse = await executeStoredProcedure('SP_MERCADOS_GET_RECAUDADORAS', {})
    if (oficinasResponse.success && oficinasResponse.data) {
      oficinas.value = oficinasResponse.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar catálogos')
  }
}

// Cambio de oficina
const onOficinaChange = async () => {
  if (filtros.value.oficina) {
    try {
      const response = await executeStoredProcedure('SP_MERCADOS_GET_CAJAS_BY_OFICINA', {
        p_oficina: filtros.value.oficina
      })
      if (response.success && response.data) {
        cajas.value = response.data
      }
    } catch (error) {
      handleError(error, 'Error al cargar cajas')
    }
  } else {
    cajas.value = []
  }
  filtros.value.caja = ''
}

// Buscar pagos
const buscarPagos = async () => {
  loading.value = true
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_PAGOS_LOCALES_CAPTURADOS', {
      p_oficina: filtros.value.oficina || null,
      p_caja: filtros.value.caja || null,
      p_operacion: filtros.value.operacion || null,
      p_fecha_desde: filtros.value.fecha_desde || null,
      p_fecha_hasta: filtros.value.fecha_hasta || null
    })

    if (response.success && response.data) {
      pagos.value = response.data.map(p => ({ ...p, selected: false }))
      toast.success(`${response.data.length} pagos encontrados`)
    }
  } catch (error) {
    handleError(error, 'Error al buscar pagos')
  } finally {
    loading.value = false
  }
}

// Toggle select all
const toggleSelectAll = () => {
  const newValue = !selectAll.value
  pagos.value.forEach(p => p.selected = newValue)
}

// Eliminar pago individual
const deletePago = async (pago) => {
  const result = await Swal.fire({
    icon: 'warning',
    title: '¿Eliminar Pago?',
    html: `
      <p>Se eliminará el pago:</p>
      <p><strong>Local: ${pago.local}</strong></p>
      <p><strong>Año: ${pago.anio} | Periodo: ${pago.periodo}</strong></p>
      <p><strong>Importe: ${formatCurrency(pago.importe)}</strong></p>
      <p class="text-warning mb-0">El adeudo será restaurado</p>
    `,
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  })

  if (result.isConfirmed) {
    try {
      const response = await executeStoredProcedure('SP_MERCADOS_DELETE_PAGOS_LOCALES_BATCH', {
        p_id_pago_local: pago.id_pago_local
      })

      if (response.success && response.data && response.data.length > 0) {
        const deleteResult = response.data[0]

        if (deleteResult.resultado === 1) {
          toast.success(deleteResult.mensaje)
          await buscarPagos()
        } else {
          toast.error(deleteResult.mensaje)
        }
      }
    } catch (error) {
      handleError(error, 'Error al eliminar pago')
    }
  }
}

// Eliminar seleccionados
const deleteSeleccionados = async () => {
  const result = await Swal.fire({
    icon: 'warning',
    title: '¿Eliminar Pagos Seleccionados?',
    html: `
      <p>Se eliminarán <strong>${pagosSeleccionados.value.length}</strong> pagos</p>
      <p class="text-warning mb-0">Los adeudos serán restaurados</p>
    `,
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  })

  if (result.isConfirmed) {
    let eliminados = 0
    let errores = 0

    for (const pago of pagosSeleccionados.value) {
      try {
        const response = await executeStoredProcedure('SP_MERCADOS_DELETE_PAGOS_LOCALES_BATCH', {
          p_id_pago_local: pago.id_pago_local
        })

        if (response.success && response.data && response.data.length > 0) {
          const deleteResult = response.data[0]
          if (deleteResult.resultado === 1) {
            eliminados++
          } else {
            errores++
          }
        }
      } catch (error) {
        errores++
      }
    }

    toast.success(`${eliminados} pagos eliminados correctamente`)
    if (errores > 0) {
      toast.warning(`${errores} pagos no pudieron eliminarse`)
    }

    await buscarPagos()
  }
}

// Limpiar filtros
const limpiarFiltros = () => {
  filtros.value = {
    oficina: '',
    caja: '',
    operacion: '',
    fecha_desde: '',
    fecha_hasta: ''
  }
  pagos.value = []
  cajas.value = []
}

// Formatear moneda
const formatCurrency = (value) => {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value || 0)
}

// Formatear fecha
const formatDate = (date) => {
  if (!date) return ''
  return new Date(date).toLocaleDateString('es-MX')
}

// Lifecycle
onMounted(() => {
  loadCatalogos()
})
</script>



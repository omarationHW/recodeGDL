<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="store" />
      </div>
      <div class="module-view-info">
        <h1>Consulta de Captura por Mercado</h1>
        <p>MÃ³dulo de Mercados - Consulta de pagos capturados por mercado</p>
      </div>
        </div>

    <div class="module-view-content">
      <!-- Card de Filtros -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h5 class="mb-0">
          <i class="fas fa-filter me-2"></i>
          Filtros de Búsqueda
        </h5>
        </div>
        <div class="municipal-card-body">
        <div class="row g-3">
          <!-- Oficina -->
          <div class="form-group">
            <label class="municipal-form-label">Oficina</label>
            <select v-model="filtros.oficina" class="municipal-form-control" @change="onOficinaChange">
              <option value="">Todas</option>
              <option v-for="o in oficinas" :key="o.oficina" :value="o.oficina">
                {{ o.oficina }}
              </option>
            </select>
          </div>

          <!-- Mercado -->
          <div class="form-group">
            <label class="municipal-form-label">Mercado</label>
            <select v-model="filtros.mercado" class="municipal-form-control" @change="onMercadoChange">
              <option value="">Todos</option>
              <option v-for="m in mercados" :key="m.mercado" :value="m.mercado">
                {{ m.nombre }}
              </option>
            </select>
          </div>

          <!-- Categoría -->
          <div class="form-group">
            <label class="municipal-form-label">Categoría</label>
            <select v-model="filtros.categoria" class="municipal-form-control">
              <option :value="0">Todas</option>
              <option v-for="c in categorias" :key="c.categoria" :value="c.categoria">
                {{ c.descripcion }}
              </option>
            </select>
          </div>

          <!-- Sección -->
          <div class="form-group">
            <label class="municipal-form-label">Sección</label>
            <select v-model="filtros.seccion" class="municipal-form-control">
              <option value="">Todas</option>
              <option v-for="s in secciones" :key="s.seccion" :value="s.seccion">
                {{ s.seccion }}
              </option>
            </select>
          </div>

          <!-- Fecha Desde -->
          <div class="form-group">
            <label class="municipal-form-label">Fecha Desde</label>
            <input
              v-model="filtros.fecha_desde"
              type="date"
              class="municipal-form-control"
            />
          </div>

          <!-- Fecha Hasta -->
          <div class="form-group">
            <label class="municipal-form-label">Fecha Hasta</label>
            <input
              v-model="filtros.fecha_hasta"
              type="date"
              class="municipal-form-control"
            />
          </div>

          <!-- Tipo de Pago -->
          <div class="form-group">
            <label class="municipal-form-label">Tipo de Pago</label>
            <select v-model="filtros.tipo" class="municipal-form-control">
              <option value="locales">Pagos de Locales</option>
              <option value="energia">Pagos de Energía</option>
            </select>
          </div>

          <!-- Botones -->
          <div class="form-group">
            <button
              class="btn-municipal-primary flex-fill"
              @click="buscarPagos"
              :disabled="loading"
            >
              <i class="fas fa-search me-2"></i>
              Buscar
            </button>
            <button
              class="btn-municipal-secondary"
              @click="limpiarFiltros"
            >
              <i class="fas fa-eraser me-2"></i>
              Limpiar
            </button>
          </div>
        </div>
      </div>
        </div>

    <!-- Card de Estadísticas -->
    <div v-if="estadisticas" class="row mb-4">
      <div class="form-group">
        <div class="stat-card stat-locales">
          <div class="stat-icon">
            <i class="fas fa-store"></i>
          </div>
          <div class="stat-content">
            <h6>Pagos Locales</h6>
            <h3>{{ estadisticas.total_pagos_locales }}</h3>
            <p>{{ formatCurrency(estadisticas.importe_locales) }}</p>
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="stat-card stat-energia">
          <div class="stat-icon">
            <i class="fas fa-bolt"></i>
          </div>
          <div class="stat-content">
            <h6>Pagos Energía</h6>
            <h3>{{ estadisticas.total_pagos_energia }}</h3>
            <p>{{ formatCurrency(estadisticas.importe_energia) }}</p>
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="stat-card stat-locales-distintos">
          <div class="stat-icon">
            <i class="fas fa-building"></i>
          </div>
          <div class="stat-content">
            <h6>Locales Distintos</h6>
            <h3>{{ estadisticas.total_locales_distintos }}</h3>
            <p>Con pagos capturados</p>
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="stat-card stat-total">
          <div class="stat-icon">
            <i class="fas fa-calculator"></i>
          </div>
          <div class="stat-content">
            <h6>Total General</h6>
            <h3>{{ estadisticas.total_pagos_locales + estadisticas.total_pagos_energia }}</h3>
            <p>{{ formatCurrency(estadisticas.importe_locales + estadisticas.importe_energia) }}</p>
          </div>
        </div>
      </div>
        </div>

    <!-- Card de Resultados -->
      <div class="municipal-card">
        <div class="municipal-card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="fas fa-shopping-cart me-2"></i>
            Pagos Capturados por Mercado
            <span v-if="filtros.tipo === 'locales'" class="badge bg-success ms-2">Locales</span>
            <span v-else class="badge bg-warning ms-2">Energía</span>
          </h4>
          <span class="badge bg-primary fs-6">
            {{ pagos.length }} registros
          </span>
        </div>
        </div>

      <div class="municipal-card-body">
        <!-- Loading State -->
        <div v-if="loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-3 text-muted">Buscando pagos...</p>
        </div>

        <!-- Tabla de Pagos -->
        <div v-else class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table">
              <tr>
                <th>ID Pago</th>
                <th>Mercado</th>
                <th>Local</th>
                <th>Titular</th>
                <th>Año</th>
                <th>Periodo</th>
                <th class="text-end">Importe</th>
                <th>Partida</th>
                <th>Fecha Pago</th>
                <th>Fecha Captura</th>
                <th>Usuario</th>
              </tr>
            </thead>
            <tbody>
              <tr v-if="pagos.length === 0 && !loading">
                <td colspan="11" class="text-center text-muted py-4">
                  <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                  No se encontraron pagos con los filtros especificados
                </td>
              </tr>
              <tr v-for="pago in pagos" :key="getPagoKey(pago)">
                <td>{{ getPagoId(pago) }}</td>
                <td>
                  <div class="fw-bold">{{ pago.nombre_mercado }}</div>
                  <small class="text-muted">{{ pago.mercado }}</small>
                </td>
                <td>
                  <div>{{ pago.local }}</div>
                  <small class="text-muted">
                    Cat: {{ pago.categoria }} | Sec: {{ pago.seccion }}
                  </small>
                </td>
                <td>
                  <small>{{ pago.nombre_titular }}</small>
                </td>
                <td>{{ pago.anio }}</td>
                <td>{{ pago.periodo }}</td>
                <td class="text-end fw-bold">{{ formatCurrency(pago.importe) }}</td>
                <td>{{ pago.partida }}</td>
                <td>{{ formatDate(pago.fecha_pago) }}</td>
                <td>{{ formatDate(pago.fecha_captura) }}</td>
                <td>
                  <small>{{ pago.usuario_captura }}</small>
                </td>
              </tr>
            </tbody>
            <tfoot v-if="pagos.length > 0" class="municipal-table">
              <tr>
                <th colspan="6" class="text-end">TOTAL:</th>
                <th class="text-end fw-bold">{{ formatCurrency(totalImporte) }}</th>
                <th colspan="4"></th>
              </tr>
            </tfoot>
          </table>
        </div>
        </div>
    </div>
        </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

// State
const pagos = ref([])
const oficinas = ref([])
const mercados = ref([])
const categorias = ref([])
const secciones = ref([])
const estadisticas = ref(null)
const loading = ref(false)

const filtros = ref({
  oficina: '',
  mercado: '',
  categoria: 0,
  seccion: '',
  fecha_desde: '',
  fecha_hasta: '',
  tipo: 'locales'
})

// Computed
const totalImporte = computed(() => {
  return pagos.value.reduce((sum, pago) => sum + parseFloat(pago.importe || 0), 0)
})

// Cargar catálogos
const loadCatalogos = async () => {
  try {
    // Oficinas
    const oficinasResponse = await executeStoredProcedure('SP_MERCADOS_GET_RECAUDADORAS', {})
    if (oficinasResponse.success && oficinasResponse.data) {
      oficinas.value = oficinasResponse.data
    }

    // Categorías
    const categoriasResponse = await executeStoredProcedure('SP_MERCADOS_CATEGORIA_LIST', {})
    if (categoriasResponse.success && categoriasResponse.data) {
      categorias.value = categoriasResponse.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar catálogos')
  }
}

// Cambio de oficina
const onOficinaChange = async () => {
  if (filtros.value.oficina) {
    try {
      const response = await executeStoredProcedure('SP_MERCADOS_GET_MERCADOS_BY_RECAUDADORA', {
        p_oficina: filtros.value.oficina
      })
      if (response.success && response.data) {
        mercados.value = response.data
      }
    } catch (error) {
      handleError(error, 'Error al cargar mercados')
    }
  } else {
    mercados.value = []
  }
  filtros.value.mercado = ''
  secciones.value = []
  filtros.value.seccion = ''
}

// Cambio de mercado
const onMercadoChange = async () => {
  if (filtros.value.mercado) {
    try {
      const response = await executeStoredProcedure('SP_MERCADOS_GET_SECCIONES_BY_MERCADO_PAGOS', {
        p_mercado: filtros.value.mercado
      })
      if (response.success && response.data) {
        secciones.value = response.data
      }
    } catch (error) {
      handleError(error, 'Error al cargar secciones')
    }
  } else {
    secciones.value = []
  }
  filtros.value.seccion = ''
}

// Buscar pagos
const buscarPagos = async () => {
  loading.value = true
  try {
    // Buscar pagos según el tipo
    const spName = filtros.value.tipo === 'locales'
      ? 'SP_MERCADOS_GET_PAGOS_BY_MERCADO'
      : 'SP_MERCADOS_GET_PAGOS_ENERGIA_BY_MERCADO'

    const response = await executeStoredProcedure(spName, {
      p_oficina: filtros.value.oficina || null,
      p_mercado: filtros.value.mercado || null,
      p_categoria: filtros.value.categoria || null,
      p_seccion: filtros.value.seccion || null,
      p_fecha_desde: filtros.value.fecha_desde || null,
      p_fecha_hasta: filtros.value.fecha_hasta || null
    })

    if (response.success && response.data) {
      pagos.value = response.data
      toast.success(`${response.data.length} pagos encontrados`)
    }

    // Cargar estadísticas si se seleccionó un mercado
    if (filtros.value.mercado) {
      await loadEstadisticas()
    }
  } catch (error) {
    handleError(error, 'Error al buscar pagos')
  } finally {
    loading.value = false
  }
}

// Cargar estadísticas
const loadEstadisticas = async () => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_ESTADISTICAS_MERCADO', {
      p_mercado: filtros.value.mercado || null,
      p_fecha_desde: filtros.value.fecha_desde || null,
      p_fecha_hasta: filtros.value.fecha_hasta || null
    })

    if (response.success && response.data && response.data.length > 0) {
      estadisticas.value = response.data[0]
    }
  } catch (error) {
    console.error('Error al cargar estadísticas:', error)
  }
}

// Limpiar filtros
const limpiarFiltros = () => {
  filtros.value = {
    oficina: '',
    mercado: '',
    categoria: 0,
    seccion: '',
    fecha_desde: '',
    fecha_hasta: '',
    tipo: 'locales'
  }
  pagos.value = []
  mercados.value = []
  secciones.value = []
  estadisticas.value = null
}

// Obtener ID del pago
const getPagoId = (pago) => {
  return pago.id_pago_local || pago.id_pago_energia
}

// Obtener key única para el pago
const getPagoKey = (pago) => {
  return `${filtros.value.tipo}-${getPagoId(pago)}`
}

// Formatear moneda
const formatCurrency = (value) => {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value || 0)
}

// Formatear fecha
const formatDate = (date) => {
  if (!date) return ''
  return new Date(date).toLocaleDateString('es-MX')
}

// Lifecycle
onMounted(() => {
  loadCatalogos()
})
</script>



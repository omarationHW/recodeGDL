<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="bolt" />
      </div>
      <div class="module-view-info">
        <h1>Consulta de Condonaciones de EnergÃ­a</h1>
        <p>MÃ³dulo de Mercados - Consulta de condonaciones de energÃ­a elÃ©ctrica</p>
      </div>
        </div>

    <div class="module-view-content">
      <!-- Card de Búsqueda -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h4 class="mb-0">
          <i class="fas fa-bolt me-2"></i>
          Consulta de Condonaciones de Energía
        </h4>
        </div>
        <div class="municipal-card-body">
        <!-- Selector de Tipo de Búsqueda -->
        <div class="search-type-selector mb-4">
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              id="searchByLocal"
              value="local"
              v-model="searchType"
            />
            <label class="form-check-label" for="searchByLocal">
              <i class="fas fa-plug me-1"></i>
              Por Local
            </label>
          </div>
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              id="searchByFecha"
              value="fecha"
              v-model="searchType"
            />
            <label class="form-check-label" for="searchByFecha">
              <i class="fas fa-calendar-range me-1"></i>
              Por Rango de Fechas
            </label>
          </div>
        </div>

        <!-- Formulario: Por Local -->
        <div v-if="searchType === 'local'" class="search-form">
          <div class="row g-3">
            <div class="form-group">
              <label class="municipal-form-label">Oficina</label>
              <select v-model="formLocal.oficina" class="municipal-form-control">
                <option value="">Seleccione...</option>
                <option v-for="ofi in oficinas" :key="ofi.oficina" :value="ofi.oficina">
                  {{ ofi.oficina }} - {{ ofi.descripcion }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Mercado</label>
              <input
                v-model.number="formLocal.num_mercado"
                type="number"
                class="municipal-form-control"
                placeholder="Número"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Categoría</label>
              <input
                v-model.number="formLocal.categoria"
                type="number"
                class="municipal-form-control"
                min="1"
                max="12"
                placeholder="1-12"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Sección</label>
              <select v-model="formLocal.seccion" class="municipal-form-control">
                <option value="">Todas</option>
                <option v-for="sec in secciones" :key="sec.seccion" :value="sec.seccion">
                  {{ sec.seccion }} - {{ sec.descripcion }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Local</label>
              <input
                v-model.number="formLocal.local"
                type="number"
                class="municipal-form-control"
                placeholder="Local"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Letra</label>
              <input
                v-model="formLocal.letra_local"
                type="text"
                class="municipal-form-control text-uppercase"
                maxlength="1"
                placeholder="A"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Bloque</label>
              <input
                v-model="formLocal.bloque"
                type="text"
                class="municipal-form-control text-uppercase"
                maxlength="1"
                placeholder="1"
              />
            </div>
        </div>
        </div>

        <!-- Formulario: Por Rango de Fechas -->
        <div v-if="searchType === 'fecha'" class="search-form">
          <div class="row g-3">
            <div class="form-group">
              <label class="municipal-form-label">Fecha Desde <span class="text-danger">*</span></label>
              <input
                v-model="formFecha.fecha_desde"
                type="date"
                class="municipal-form-control"
                required
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Fecha Hasta <span class="text-danger">*</span></label>
              <input
                v-model="formFecha.fecha_hasta"
                type="date"
                class="municipal-form-control"
                required
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Mercado</label>
              <select v-model="formFecha.num_mercado" class="municipal-form-control">
                <option value="">Todos</option>
                <option v-for="merc in mercados" :key="merc.num_mercado" :value="merc.num_mercado">
                  {{ merc.num_mercado }} - {{ merc.descripcion }}
                </option>
              </select>
            </div>
        </div>
        </div>

        <!-- Botones de Acción -->
        <div class="d-flex gap-2 mt-4">
          <button @click="buscar" class="btn-municipal-primary" :disabled="loading">
            <span v-if="loading">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Buscando...
            </span>
            <span v-else>
              <i class="fas fa-search me-2"></i>
              Buscar
            </span>
          </button>
          <button @click="limpiar" class="btn-municipal-secondary">
            <i class="fas fa-eraser me-2"></i>
            Limpiar
          </button>
        </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div v-if="searchPerformed && condonaciones.length > 0" class="row mb-4">
      <div class="form-group">
        <div class="stat-card stat-total">
          <div class="stat-icon">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
          <div class="stat-content">
            <h6>Total Condonaciones</h6>
            <h3>{{ estadisticas?.total_condonaciones || 0 }}</h3>
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="stat-card stat-original">
          <div class="stat-icon">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="stat-content">
            <h6>Importe Original</h6>
            <h3>{{ formatCurrency(estadisticas?.total_importe_original || 0) }}</h3>
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="stat-card stat-condonado">
          <div class="stat-icon">
            <i class="fas fa-hand-holding-usd"></i>
          </div>
          <div class="stat-content">
            <h6>Importe Condonado</h6>
            <h3>{{ formatCurrency(estadisticas?.total_importe_condonado || 0) }}</h3>
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="stat-card stat-final">
          <div class="stat-icon">
            <i class="fas fa-bolt"></i>
          </div>
          <div class="stat-content">
            <h6>Total kWh</h6>
            <h3>{{ formatNumber(estadisticas?.total_kwh_consumidos || 0) }}</h3>
          </div>
        </div>
      </div>
        </div>

    <!-- Resultados -->
    <div v-if="condonaciones.length > 0" class="municipal-card">
      <div class="municipal-card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Resultados: {{ condonaciones.length }} condonación(es) de energía encontrada(s)
          </h5>
          <h5 class="mb-0">
            <i class="fas fa-percentage me-2"></i>
            Promedio: {{ estadisticas?.porcentaje_promedio?.toFixed(2) || 0 }}%
          </h5>
        </div>
        </div>

      <div class="municipal-card-body p-0">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table">
              <tr>
                <th>ID</th>
                <th>Oficina</th>
                <th>Mercado</th>
                <th>Cat</th>
                <th>Sec</th>
                <th>Local</th>
                <th>L</th>
                <th>B</th>
                <th>Fecha Cond.</th>
                <th>Periodo</th>
                <th>kWh</th>
                <th>Imp. Original</th>
                <th>Imp. Cond.</th>
                <th>%</th>
                <th>Imp. Final</th>
                <th>Autorizó</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="cond in condonaciones" :key="cond.id_condonacion_energia">
                <td class="fw-bold">{{ cond.id_condonacion_energia }}</td>
                <td>{{ cond.oficina }}</td>
                <td>{{ cond.num_mercado }}</td>
                <td>{{ cond.categoria }}</td>
                <td>{{ cond.seccion }}</td>
                <td>{{ cond.local }}</td>
                <td>{{ cond.letra_local || '-' }}</td>
                <td>{{ cond.bloque || '-' }}</td>
                <td>{{ formatDate(cond.fecha_condonacion) }}</td>
                <td class="small">{{ formatDate(cond.periodo_desde) }} al {{ formatDate(cond.periodo_hasta) }}</td>
                <td class="text-end small">{{ formatNumber(cond.kwh_consumidos || 0) }}</td>
                <td class="text-end">{{ formatCurrency(cond.importe_original) }}</td>
                <td class="text-end fw-bold text-success">{{ formatCurrency(cond.importe_condonado) }}</td>
                <td class="text-center fw-bold text-warning">{{ cond.porcentaje_condonacion?.toFixed(2) }}%</td>
                <td class="text-end text-primary fw-bold">{{ formatCurrency(cond.importe_final) }}</td>
                <td class="small">{{ cond.autorizo }}</td>
                <td class="small text-truncate" style="max-width: 150px;" :title="cond.motivo">{{ cond.motivo }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        </div>
    </div>

    <!-- Empty State -->
    <div v-else-if="searchPerformed && !loading" class="municipal-card">
      <div class="municipal-card-body text-center py-5">
        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
        <h5 class="text-muted">No se encontraron condonaciones de energía</h5>
        <p class="text-muted mb-0">Intente con otros criterios de búsqueda</p>
      </div>
        </div>
      </div>
        </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

// State
const loading = ref(false)
const searchPerformed = ref(false)
const searchType = ref('local')
const oficinas = ref([])
const mercados = ref([])
const secciones = ref([])
const condonaciones = ref([])
const estadisticas = ref(null)

const formLocal = ref({
  oficina: '',
  num_mercado: null,
  categoria: null,
  seccion: '',
  local: null,
  letra_local: '',
  bloque: ''
})

const formFecha = ref({
  fecha_desde: '',
  fecha_hasta: '',
  num_mercado: ''
})

// Methods
const loadOficinas = async () => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_OFICINAS', {})
    if (response.success && response.data) {
      oficinas.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar oficinas')
  }
}

const loadSecciones = async () => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_SECCIONES', {})
    if (response.success && response.data) {
      secciones.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar secciones')
  }
}

const loadMercados = async () => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_MERCADOS', {})
    if (response.success && response.data) {
      mercados.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar mercados')
  }
}

const buscar = async () => {
  // Validaciones
  if (!searchType.value) {
    toast.error('Seleccione un tipo de búsqueda')
    return
  }

  if (searchType.value === 'local') {
    if (!formLocal.value.oficina || !formLocal.value.num_mercado || !formLocal.value.categoria ||
        !formLocal.value.seccion || !formLocal.value.local) {
      toast.error('Complete todos los campos requeridos para búsqueda por local')
      return
    }
  } else {
    if (!formFecha.value.fecha_desde || !formFecha.value.fecha_hasta) {
      toast.error('Las fechas desde y hasta son requeridas')
      return
    }
  }

  loading.value = true
  searchPerformed.value = true
  condonaciones.value = []
  estadisticas.value = null

  try {
    let spName = ''
    let params = {}

    if (searchType.value === 'local') {
      spName = 'SP_MERCADOS_GET_CONDONACIONES_ENERGIA_LOCAL'
      params = {
        p_oficina: formLocal.value.oficina,
        p_num_mercado: formLocal.value.num_mercado,
        p_categoria: formLocal.value.categoria,
        p_seccion: formLocal.value.seccion,
        p_local: formLocal.value.local,
        p_letra_local: formLocal.value.letra_local || null,
        p_bloque: formLocal.value.bloque || null
      }
    } else {
      spName = 'SP_MERCADOS_GET_CONDONACIONES_ENERGIA_BY_FECHA'
      params = {
        p_fecha_desde: formFecha.value.fecha_desde,
        p_fecha_hasta: formFecha.value.fecha_hasta,
        p_num_mercado: formFecha.value.num_mercado || null
      }
    }

    const response = await executeStoredProcedure(spName, params)

    if (response.success && response.data) {
      condonaciones.value = response.data

      if (condonaciones.value.length > 0) {
        // Cargar estadísticas
        await loadEstadisticas()
        toast.success(`${condonaciones.value.length} condonación(es) de energía encontrada(s)`)
      } else {
        toast.info('No se encontraron condonaciones de energía con los criterios especificados')
      }
    }
  } catch (error) {
    handleError(error, 'Error al buscar condonaciones de energía')
  } finally {
    loading.value = false
  }
}

const loadEstadisticas = async () => {
  if (searchType.value !== 'fecha' || !formFecha.value.fecha_desde || !formFecha.value.fecha_hasta) {
    return
  }

  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_ESTADISTICAS_CONDONACIONES_ENERGIA', {
      p_fecha_desde: formFecha.value.fecha_desde,
      p_fecha_hasta: formFecha.value.fecha_hasta,
      p_num_mercado: formFecha.value.num_mercado || null
    })

    if (response.success && response.data && response.data.length > 0) {
      estadisticas.value = response.data[0]
    }
  } catch (error) {
    handleError(error, 'Error al cargar estadísticas')
  }
}

const limpiar = () => {
  condonaciones.value = []
  estadisticas.value = null
  searchPerformed.value = false
  searchType.value = 'local'
  formLocal.value = {
    oficina: '',
    num_mercado: null,
    categoria: null,
    seccion: '',
    local: null,
    letra_local: '',
    bloque: ''
  }
  formFecha.value = {
    fecha_desde: '',
    fecha_hasta: '',
    num_mercado: ''
  }
  toast.info('Formulario limpiado')
}

const formatCurrency = (value) => {
  if (!value) return '$0.00'
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value)
}

const formatNumber = (value) => {
  if (!value) return '0'
  return new Intl.NumberFormat('es-MX').format(value)
}

const formatDate = (dateString) => {
  if (!dateString) return ''
  const date = new Date(dateString)
  return date.toLocaleDateString('es-MX')
}

// Lifecycle
onMounted(() => {
  loadOficinas()
  loadSecciones()
  loadMercados()
})
</script>



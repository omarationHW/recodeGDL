<template>
    <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="cog" />
      </div>
      <div class="module-view-info">
        <h1>Consulta de Requerimientos</h1>
        <p>Módulo de Mercados</p>
      </div>
        </div>

    <div class="module-view-content">
    <div class="municipal-card">
      <div class="municipal-card-header"><i class="fas fa-search"></i> Búsqueda de Local</div>
      <div class="municipal-card-body">
        <form @submit.prevent="buscarLocales" class="row g-3">
          <div class="form-group">
            <label class="municipal-form-label">Mercado *</label>
            <select v-model="form.mercado" class="municipal-form-control" required>
              <option v-for="m in mercados" :key="`${m.oficina}-${m.num_mercado_nvo}-${m.categoria}`" :value="`${m.oficina}-${m.num_mercado_nvo}-${m.categoria}`">
                {{ m.oficina }} - {{ m.num_mercado_nvo }} - {{ m.descripcion }}
              </option>
            </select>
          </div>
          <div class="form-group"><label class="municipal-form-label">Sección *</label><input v-model="form.seccion" class="municipal-form-control" maxlength="2" required /></div>
          <div class="form-group"><label class="municipal-form-label">Local *</label><input v-model="form.local" class="municipal-form-control" maxlength="7" required /></div>
          <div class="form-group"><label class="municipal-form-label">Letra</label><input v-model="form.letra_local" class="municipal-form-control" maxlength="1" /></div>
          <div class="form-group"><button type="submit" class="btn-municipal-primary w-100"><i class="fas fa-search"></i> Buscar</button></div>
        </form>
      </div>
        </div>
    <div v-if="locales.length" class="municipal-card">
      <div class="municipal-card-header"><i class="fas fa-building"></i> Locales Encontrados</div>
      <div class="municipal-card-body">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table-header"><tr><th>ID</th><th>Oficina</th><th>Mercado</th><th>Cat</th><th>Sec</th><th>Local</th><th>Letra</th><th>Acción</th></tr></thead>
            <tbody>
              <tr v-for="l in locales" :key="l.id_local">
                <td>{{ l.calcregistro }}</td><td>{{ l.oficina }}</td><td>{{ l.num_mercado }}</td><td>{{ l.categoria }}</td><td>{{ l.seccion }}</td><td>{{ l.local }}</td><td>{{ l.letra_local }}</td>
                <td><button class="btn-action btn-info" @click="seleccionarLocal(l)"><i class="fas fa-eye"></i> Ver Req.</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        </div>
    </div>
    <div v-if="requerimientos.length" class="municipal-card">
      <div class="municipal-card-header bg-danger text-white"><i class="fas fa-exclamation-triangle"></i> Requerimientos</div>
      <div class="municipal-card-body">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table-header">
              <tr><th>Folio</th><th>Fecha</th><th>Vigencia</th><th>Diligencia</th><th>Imp. Global</th><th>Multa</th><th>Recargo</th><th>Gastos</th><th>Acción</th></tr>
            </thead>
            <tbody>
              <tr v-for="r in requerimientos" :key="r.id_control">
                <td>{{ r.folio }}</td><td>{{ formatDate(r.fecha_emision) }}</td><td>{{ r.vigencia }}</td><td>{{ r.diligencia }}</td>
                <td class="text-end">{{ formatCurrency(r.importe_global) }}</td><td class="text-end">{{ formatCurrency(r.importe_multa) }}</td>
                <td class="text-end">{{ formatCurrency(r.importe_recargo) }}</td><td class="text-end">{{ formatCurrency(r.importe_gastos) }}</td>
                <td><button class="btn-action btn-warning" @click="verPeriodos(r)"><i class="fas fa-calendar"></i> Periodos</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        </div>
    </div>
    <div v-if="periodos.length" class="municipal-card">
      <div class="municipal-card-header bg-warning"><i class="fas fa-calendar-alt"></i> Periodos del Requerimiento</div>
      <div class="municipal-card-body">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table-header"><tr><th>Año</th><th>Mes</th><th>Importe</th><th>Recargos</th></tr></thead>
            <tbody>
              <tr v-for="p in periodos" :key="`${p.id_control}-${p.ayo}-${p.periodo}`">
                <td>{{ p.ayo }}</td><td>{{ p.periodo }}</td><td class="text-end">{{ formatCurrency(p.importe) }}</td><td class="text-end">{{ formatCurrency(p.recargos) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        </div>
    </div>
        </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const mercados = ref([])
const locales = ref([])
const requerimientos = ref([])
const periodos = ref([])
const form = ref({ mercado: '', seccion: '', local: '', letra_local: '', bloque: '' })

const cargarMercados = async () => {
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_MERCADOS_ALL', [])
    mercados.value = result || []
  } catch (error) {
    handleError(error)
  }
}

const buscarLocales = async () => {
  locales.value = []
  requerimientos.value = []
  periodos.value = []
  if (!form.value.mercado) { toast.warning('Seleccione un mercado'); return }
  const [oficina, num_mercado, categoria] = form.value.mercado.split('-')
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_LOCALES_BY_MERCADO', [
      parseInt(oficina), parseInt(num_mercado), parseInt(categoria),
      form.value.seccion, form.value.local, form.value.letra_local, form.value.bloque
    ])
    locales.value = result || []
    if (locales.value.length === 0) toast.info('No se encontraron locales')
  } catch (error) {
    handleError(error)
    toast.error('Error al buscar locales')
  }
}

const seleccionarLocal = async (local) => {
  requerimientos.value = []
  periodos.value = []
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_REQ_BY_LOCAL', [11, local.id_local])
    requerimientos.value = result || []
    if (requerimientos.value.length === 0) toast.info('No hay requerimientos para este local')
  } catch (error) {
    handleError(error)
    toast.error('Error al cargar requerimientos')
  }
}

const verPeriodos = async (req) => {
  periodos.value = []
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_PERIODOS_REQ', [req.control_otr])
    periodos.value = result || []
  } catch (error) {
    handleError(error)
    toast.error('Error al cargar periodos')
  }
}

const formatCurrency = (value) => {
  if (value == null) return ''
  return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value)
}

const formatDate = (value) => {
  if (!value) return ''
  return new Date(value).toLocaleDateString('es-MX')
}

onMounted(() => { cargarMercados() })
</script>



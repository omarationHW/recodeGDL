<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="search" />
      </div>
      <div class="module-view-info">
        <h1>Consulta General</h1>
        <p>MÃ³dulo de Mercados - Consulta general de locales</p>
      </div>
        </div>

    <div class="module-view-content">
      <!-- Card de Búsqueda -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h4 class="mb-0">
          <i class="fas fa-search me-2"></i>
          Consulta General de Locales
        </h4>
        </div>
        <div class="municipal-card-body">
        <form @submit.prevent="buscarLocal">
          <div class="row g-3">
            <div class="form-group">
              <label class="municipal-form-label">Oficina <span class="text-danger">*</span></label>
              <select v-model="formBusqueda.oficina" class="municipal-form-control" required>
                <option value="">Seleccione...</option>
                <option v-for="ofi in oficinas" :key="ofi.oficina" :value="ofi.oficina">
                  {{ ofi.oficina }} - {{ ofi.descripcion }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Mercado <span class="text-danger">*</span></label>
              <input
                v-model.number="formBusqueda.num_mercado"
                type="number"
                class="municipal-form-control"
                required
                placeholder="Número"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Categoría <span class="text-danger">*</span></label>
              <input
                v-model.number="formBusqueda.categoria"
                type="number"
                class="municipal-form-control"
                min="1"
                max="12"
                required
                placeholder="1-12"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Sección <span class="text-danger">*</span></label>
              <select v-model="formBusqueda.seccion" class="municipal-form-control" required>
                <option value="">Seleccione...</option>
                <option v-for="sec in secciones" :key="sec.seccion" :value="sec.seccion">
                  {{ sec.seccion }} - {{ sec.descripcion }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Local <span class="text-danger">*</span></label>
              <input
                v-model.number="formBusqueda.local"
                type="number"
                class="municipal-form-control"
                required
                placeholder="Local"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Letra</label>
              <input
                v-model="formBusqueda.letra_local"
                type="text"
                class="municipal-form-control text-uppercase"
                maxlength="1"
                placeholder="A"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Bloque</label>
              <input
                v-model="formBusqueda.bloque"
                type="text"
                class="municipal-form-control text-uppercase"
                maxlength="1"
                placeholder="1"
              />
            </div>
        </div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn-municipal-primary" :disabled="loading">
              <span v-if="loading">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Buscando...
              </span>
              <span v-else>
                <i class="fas fa-search me-2"></i>
                Buscar Local
              </span>
            </button>
            <button type="button" @click="limpiar" class="btn-municipal-secondary">
              <i class="fas fa-eraser me-2"></i>
              Limpiar
            </button>
          </div>
        </form>
      </div>
        </div>

    <!-- Detalle del Local -->
    <div v-if="localDetalle" class="municipal-card">
      <div class="municipal-card-header bg-info text-white">
        <h5 class="mb-0">
          <i class="fas fa-store me-2"></i>
          Detalle del Local
        </h5>
      </div>
      <div class="municipal-card-body">
        <div class="row g-3">
          <div class="form-group">
            <strong>ID Local:</strong> {{ localDetalle.id_local }}
          </div>
          <div class="form-group">
            <strong>Oficina:</strong> {{ localDetalle.oficina }}
          </div>
          <div class="form-group">
            <strong>Mercado:</strong> {{ localDetalle.num_mercado }} - {{ localDetalle.descripcion_mercado }}
          </div>
          <div class="form-group">
            <strong>Categoría:</strong> {{ localDetalle.categoria }} - {{ localDetalle.descripcion_categoria }}
          </div>
          <div class="form-group">
            <strong>Sección:</strong> {{ localDetalle.seccion }} - {{ localDetalle.descripcion_seccion }}
          </div>
          <div class="form-group">
            <strong>Local:</strong> {{ localDetalle.local }}{{ localDetalle.letra_local || '' }}{{ localDetalle.bloque || '' }}
          </div>
          <div class="form-group">
            <strong>Contribuyente:</strong> {{ localDetalle.nombre_contribuyente || 'N/A' }}
          </div>
          <div class="form-group">
            <strong>RFC:</strong> {{ localDetalle.rfc || 'N/A' }}
          </div>
          <div class="form-group">
            <strong>Domicilio:</strong> {{ localDetalle.domicilio || 'N/A' }}
          </div>
          <div class="form-group">
            <strong>Teléfono:</strong> {{ localDetalle.telefono || 'N/A' }}
          </div>
          <div class="form-group">
            <strong>Área (m²):</strong> {{ localDetalle.area_metros || 'N/A' }}
          </div>
          <div class="form-group">
            <strong>Tipo:</strong> {{ localDetalle.tipo_local || 'N/A' }}
          </div>
          <div class="form-group">
            <strong>Status:</strong>
            <span :class="localDetalle.status === 'A' ? 'badge bg-success' : 'badge bg-danger'">
              {{ localDetalle.status === 'A' ? 'Activo' : 'Inactivo' }}
            </span>
          </div>
        </div>
      </div>
        </div>

    <!-- Tabs con información relacionada -->
    <div v-if="localDetalle" class="municipal-card">
      <div class="municipal-card-header">
        <ul class="nav nav-tabs card-header-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ active: activeTab === 'adeudos' }"
              @click="activeTab = 'adeudos'"
              type="button"
            >
              <i class="fas fa-exclamation-circle me-1"></i>
              Adeudos
              <span class="badge bg-danger ms-2">{{ adeudos.length }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ active: activeTab === 'pagos' }"
              @click="activeTab = 'pagos'"
              type="button"
            >
              <i class="fas fa-money-bill-wave me-1"></i>
              Pagos
              <span class="badge bg-success ms-2">{{ pagos.length }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ active: activeTab === 'requerimientos' }"
              @click="activeTab = 'requerimientos'"
              type="button"
            >
              <i class="fas fa-file-alt me-1"></i>
              Requerimientos
              <span class="badge bg-warning ms-2">{{ requerimientos.length }}</span>
            </button>
          </li>
        </ul>
      </div>

      <div class="municipal-card-body p-0">
        <div class="tab-content">
          <!-- Tab: Adeudos -->
          <div v-if="activeTab === 'adeudos'" class="tab-pane active p-3">
            <div v-if="adeudos.length > 0" class="municipal-table">
              <table class="municipal-table">
                <thead class="municipal-table">
                  <tr>
                    <th>ID</th>
                    <th>Fecha Desde</th>
                    <th>Fecha Hasta</th>
                    <th>Importe</th>
                    <th>Días</th>
                    <th>Status</th>
                    <th>Usuario</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="adeudo in adeudos" :key="adeudo.id_adeudo">
                    <td>{{ adeudo.id_adeudo }}</td>
                    <td>{{ formatDate(adeudo.fecha_desde) }}</td>
                    <td>{{ formatDate(adeudo.fecha_hasta) }}</td>
                    <td class="text-end fw-bold text-danger">{{ formatCurrency(adeudo.importe_adeudo) }}</td>
                    <td>{{ adeudo.dias_adeudo }}</td>
                    <td>
                      <span class="badge" :class="{
                        'bg-warning': adeudo.status === 'P',
                        'bg-success': adeudo.status === 'L',
                        'bg-secondary': adeudo.status === 'C'
                      }">
                        {{ adeudo.descripcion_status }}
                      </span>
                    </td>
                    <td class="small">{{ adeudo.usuario_registro }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div v-else class="text-center py-5 text-muted">
              <i class="fas fa-check-circle fa-3x mb-3"></i>
              <p>No hay adeudos registrados</p>
            </div>
        </div>

          <!-- Tab: Pagos -->
          <div v-if="activeTab === 'pagos'" class="tab-pane active p-3">
            <div v-if="pagos.length > 0" class="municipal-table">
              <table class="municipal-table">
                <thead class="municipal-table">
                  <tr>
                    <th>ID</th>
                    <th>Fecha Pago</th>
                    <th>Importe</th>
                    <th>Oficina</th>
                    <th>Caja</th>
                    <th>Operación</th>
                    <th>Periodo Cubierto</th>
                    <th>Usuario</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="pago in pagos" :key="pago.id_pago_local">
                    <td>{{ pago.id_pago_local }}</td>
                    <td>{{ formatDate(pago.fecha_pago) }}</td>
                    <td class="text-end fw-bold text-success">{{ formatCurrency(pago.importe_pago) }}</td>
                    <td>{{ pago.oficina_pago }}</td>
                    <td>{{ pago.caja_pago }}</td>
                    <td>{{ pago.operacion_pago }}</td>
                    <td class="small">{{ formatDate(pago.fecha_desde) }} al {{ formatDate(pago.fecha_hasta) }}</td>
                    <td class="small">{{ pago.usuario_registro }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div v-else class="text-center py-5 text-muted">
              <i class="fas fa-inbox fa-3x mb-3"></i>
              <p>No hay pagos registrados</p>
            </div>
        </div>

          <!-- Tab: Requerimientos -->
          <div v-if="activeTab === 'requerimientos'" class="tab-pane active p-3">
            <div v-if="requerimientos.length > 0" class="municipal-table">
              <table class="municipal-table">
                <thead class="municipal-table">
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Descripción</th>
                    <th>Status</th>
                    <th>Fecha Resolución</th>
                    <th>Usuario</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="req in requerimientos" :key="req.id_requerimiento">
                    <td>{{ req.id_requerimiento }}</td>
                    <td>{{ formatDate(req.fecha_requerimiento) }}</td>
                    <td>
                      <span class="badge bg-info">{{ req.descripcion_tipo }}</span>
                    </td>
                    <td class="text-truncate" style="max-width: 200px;" :title="req.descripcion">
                      {{ req.descripcion }}
                    </td>
                    <td>
                      <span class="badge" :class="{
                        'bg-warning': req.status === 'P',
                        'bg-success': req.status === 'A',
                        'bg-secondary': req.status === 'C'
                      }">
                        {{ req.descripcion_status }}
                      </span>
                    </td>
                    <td>{{ req.fecha_resolucion ? formatDate(req.fecha_resolucion) : '-' }}</td>
                    <td class="small">{{ req.usuario_registro }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div v-else class="text-center py-5 text-muted">
              <i class="fas fa-inbox fa-3x mb-3"></i>
              <p>No hay requerimientos registrados</p>
            </div>
        </div>
        </div>
        </div>
    </div>

    <!-- Resumen estadístico -->
    <div v-if="localDetalle && resumen" class="card shadow mt-4">
      <div class="municipal-card-header bg-secondary text-white">
        <h5 class="mb-0">
          <i class="fas fa-chart-bar me-2"></i>
          Resumen Estadístico
        </h5>
      </div>
      <div class="municipal-card-body">
        <div class="row text-center">
          <div class="form-group">
            <div class="stat-box bg-danger-subtle">
              <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
              <h4>{{ resumen.adeudos_pendientes }}</h4>
              <p class="mb-0">Adeudos Pendientes</p>
              <small class="text-muted">{{ formatCurrency(resumen.importe_pendiente) }}</small>
            </div>
        </div>
          <div class="form-group">
            <div class="stat-box bg-success-subtle">
              <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
              <h4>{{ resumen.adeudos_liquidados }}</h4>
              <p class="mb-0">Adeudos Liquidados</p>
              <small class="text-muted">{{ resumen.total_adeudos }} total</small>
            </div>
        </div>
          <div class="form-group">
            <div class="stat-box bg-primary-subtle">
              <i class="fas fa-money-bill-wave fa-2x text-primary mb-2"></i>
              <h4>{{ resumen.total_pagos }}</h4>
              <p class="mb-0">Total Pagos</p>
              <small class="text-muted">{{ formatCurrency(resumen.importe_total_pagos) }}</small>
            </div>
        </div>
          <div class="form-group">
            <div class="stat-box bg-warning-subtle">
              <i class="fas fa-file-alt fa-2x text-warning mb-2"></i>
              <h4>{{ resumen.requerimientos_pendientes }}</h4>
              <p class="mb-0">Req. Pendientes</p>
              <small class="text-muted">{{ resumen.total_requerimientos }} total</small>
            </div>
        </div>
        </div>
        </div>
    </div>
        </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

// State
const loading = ref(false)
const oficinas = ref([])
const secciones = ref([])
const localDetalle = ref(null)
const adeudos = ref([])
const pagos = ref([])
const requerimientos = ref([])
const resumen = ref(null)
const activeTab = ref('adeudos')

const formBusqueda = ref({
  oficina: '',
  num_mercado: null,
  categoria: null,
  seccion: '',
  local: null,
  letra_local: '',
  bloque: ''
})

// Methods
const loadOficinas = async () => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_OFICINAS', {})
    if (response.success && response.data) {
      oficinas.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar oficinas')
  }
}

const loadSecciones = async () => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_SECCIONES', {})
    if (response.success && response.data) {
      secciones.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar secciones')
  }
}

const buscarLocal = async () => {
  loading.value = true
  localDetalle.value = null
  adeudos.value = []
  pagos.value = []
  requerimientos.value = []
  resumen.value = null

  try {
    // Obtener detalle del local
    const detalleResponse = await executeStoredProcedure('SP_MERCADOS_GET_LOCAL_DETALLE', {
      p_oficina: formBusqueda.value.oficina,
      p_num_mercado: formBusqueda.value.num_mercado,
      p_categoria: formBusqueda.value.categoria,
      p_seccion: formBusqueda.value.seccion,
      p_local: formBusqueda.value.local,
      p_letra_local: formBusqueda.value.letra_local || null,
      p_bloque: formBusqueda.value.bloque || null
    })

    if (detalleResponse.success && detalleResponse.data && detalleResponse.data.length > 0) {
      localDetalle.value = detalleResponse.data[0]

      // Cargar adeudos, pagos y requerimientos
      await Promise.all([
        loadAdeudos(localDetalle.value.id_local),
        loadPagos(localDetalle.value.id_local),
        loadRequerimientos(localDetalle.value.id_local),
        loadResumen(localDetalle.value.id_local)
      ])

      toast.success('Local encontrado')
    } else {
      toast.warning('No se encontró el local con los datos especificados')
    }
  } catch (error) {
    handleError(error, 'Error al buscar local')
  } finally {
    loading.value = false
  }
}

const loadAdeudos = async (idLocal) => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_ADEUDOS_LOCAL', {
      p_id_local: idLocal
    })
    if (response.success && response.data) {
      adeudos.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar adeudos')
  }
}

const loadPagos = async (idLocal) => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_PAGOS_LOCAL', {
      p_id_local: idLocal
    })
    if (response.success && response.data) {
      pagos.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar pagos')
  }
}

const loadRequerimientos = async (idLocal) => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_REQUERIMIENTOS_LOCAL', {
      p_id_local: idLocal
    })
    if (response.success && response.data) {
      requerimientos.value = response.data
    }
  } catch (error) {
    handleError(error, 'Error al cargar requerimientos')
  }
}

const loadResumen = async (idLocal) => {
  try {
    const response = await executeStoredProcedure('SP_MERCADOS_GET_RESUMEN_LOCAL', {
      p_id_local: idLocal
    })
    if (response.success && response.data && response.data.length > 0) {
      resumen.value = response.data[0]
    }
  } catch (error) {
    handleError(error, 'Error al cargar resumen')
  }
}

const limpiar = () => {
  formBusqueda.value = {
    oficina: '',
    num_mercado: null,
    categoria: null,
    seccion: '',
    local: null,
    letra_local: '',
    bloque: ''
  }
  localDetalle.value = null
  adeudos.value = []
  pagos.value = []
  requerimientos.value = []
  resumen.value = null
  toast.info('Formulario limpiado')
}

const formatCurrency = (value) => {
  if (!value) return '$0.00'
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value)
}

const formatDate = (dateString) => {
  if (!dateString) return ''
  const date = new Date(dateString)
  return date.toLocaleDateString('es-MX')
}

// Lifecycle
onMounted(() => {
  loadOficinas()
  loadSecciones()
})
</script>



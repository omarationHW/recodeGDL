<template>
    <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="database" />
      </div>
      <div class="module-view-info">
        <h1>Consulta Individual de Datos Generales</h1>
        <p>M�dulo de Mercados</p>
      </div>
        </div>

    <div class="module-view-content">

    <div class="municipal-card">
      <div class="municipal-card-header">
        <i class="fas fa-search"></i> Buscar Local
      </div>
      <div class="municipal-card-body">
        <div class="form-row">
          <div class="form-group">
            <label class="municipal-form-label">ID Local *</label>
            <input
              type="number"
              v-model.number="idLocal"
              class="municipal-form-control"
              @keyup.enter="loadDatos"
            />
          </div>
          <div class="form-group">
            <button class="btn-municipal-primary" @click="loadDatos">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div v-if="loading" class="text-center p-4">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Cargando datos...</p>
    </div>

    <div v-else-if="datos">
      <div class="municipal-card">
        <div class="municipal-card-header bg-primary text-white">
          <i class="fas fa-store"></i> Datos del Mercado
        </div>
        <div class="municipal-card-body">
          <div class="form-row">
            <div class="form-group">
              <div class="data-row">
                <label class="municipal-form-label">Control:</label>
                <span>{{ datos.id_local }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Mercado:</label>
                <span>{{ mercadoDesc }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Nombre:</label>
                <span>{{ datos.nombre }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Arrendatario:</label>
                <span>{{ datos.arrendatario }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Domicilio:</label>
                <span>{{ datos.domicilio }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Sector:</label>
                <span>{{ datos.sector }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Zona:</label>
                <span>{{ datos.zona }}</span>
              </div>
        </div>
            <div class="form-group">
              <div class="data-row">
                <label class="municipal-form-label">Descripci�n:</label>
                <span>{{ datos.descripcion_local }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Superficie:</label>
                <span>{{ datos.superficie }} m�</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Giro:</label>
                <span>{{ datos.giro }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Fecha Alta:</label>
                <span>{{ formatDate(datos.fecha_alta) }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Fecha Baja:</label>
                <span>{{ formatDate(datos.fecha_baja) }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Actualizaci�n:</label>
                <span>{{ formatDateTime(datos.fecha_modificacion) }}</span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Vigencia:</label>
                <span :class="datos.vigencia === 'VIGENTE' ? 'text-success' : 'text-danger'">
                  {{ datos.vigencia }}
                </span>
              </div>
              <div class="data-row">
                <label class="municipal-form-label">Renta:</label>
                <span class="font-weight-bold">{{ formatCurrency(renta) }}</span>
              </div>
        </div>
    </div>
        </div>

      <div class="municipal-card">
        <div class="municipal-card-header bg-danger text-white">
          <i class="fas fa-exclamation-triangle"></i> Adeudos
          <span class="badge badge-light ml-2">{{ adeudos.length }} periodos</span>
        </div>
        <div class="municipal-card-body">
          <div v-if="adeudos.length > 0" class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th>A�o</th>
                  <th>Mes</th>
                  <th>Importe</th>
                  <th>Recargos</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="a in adeudos" :key="`${a.axo}-${a.periodo}`">
                  <td>{{ a.axo }}</td>
                  <td>{{ a.periodo }}</td>
                  <td class="text-end">{{ formatCurrency(a.importe) }}</td>
                  <td class="text-end">{{ formatCurrency(a.recargos) }}</td>
                  <td class="text-right font-weight-bold">
                    {{ formatCurrency(a.importe + a.recargos) }}
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="municipal-table">
                  <td colspan="2" class="text-end">TOTALES:</td>
                  <td class="text-end">{{ formatCurrency(totales.importe) }}</td>
                  <td class="text-end">{{ formatCurrency(totales.recargos) }}</td>
                  <td class="text-end">{{ formatCurrency(totales.total) }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div v-else class="alert alert-success">
            No hay adeudos registrados
          </div>
        </div>
      </div>

      <div class="municipal-card">
        <div class="municipal-card-header bg-warning">
          <i class="fas fa-file-alt"></i> Requerimientos
          <span class="badge badge-light ml-2">{{ requerimientos.length }}</span>
        </div>
        <div class="municipal-card-body">
          <div v-if="requerimientos.length > 0" class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th>Folio</th>
                  <th>Fecha Emisi�n</th>
                  <th>Importe Multa</th>
                  <th>Importe Gastos</th>
                  <th>Vigencia</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="r in requerimientos" :key="r.folio">
                  <td>{{ r.folio }}</td>
                  <td>{{ formatDate(r.fecha_emision) }}</td>
                  <td class="text-end">{{ formatCurrency(r.importe_multa) }}</td>
                  <td class="text-end">{{ formatCurrency(r.importe_gastos) }}</td>
                  <td :class="r.vigencia === 'VIGENTE' ? 'text-success' : 'text-muted'">
                    {{ r.vigencia }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div v-else class="alert alert-info">
            No hay requerimientos registrados
          </div>
        </div>
      </div>

      <div class="municipal-card">
        <div class="municipal-card-header bg-info text-white">
          <i class="fas fa-exchange-alt"></i> Movimientos
          <span class="badge badge-light ml-2">{{ movimientos.length }}</span>
        </div>
        <div class="municipal-card-body">
          <div v-if="movimientos.length > 0" class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th>A�o Memo</th>
                  <th>N�mero Memo</th>
                  <th>Nombre</th>
                  <th>Tipo Movimiento</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="m in movimientos" :key="m.id_movimiento">
                  <td>{{ m.axo_memo }}</td>
                  <td>{{ m.numero_memo }}</td>
                  <td>{{ m.nombre }}</td>
                  <td>{{ m.tipo_movimiento }}</td>
                  <td>{{ formatDate(m.fecha) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div v-else class="alert alert-info">
            No hay movimientos registrados
          </div>
        </div>
      </div>
    </div>
    </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, computed } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const idLocal = ref(null)
const datos = ref(null)
const mercadoDesc = ref('')
const renta = ref(0)
const adeudos = ref([])
const requerimientos = ref([])
const movimientos = ref([])
const loading = ref(false)

const totales = computed(() => {
  return {
    importe: adeudos.value.reduce((sum, a) => sum + (a.importe || 0), 0),
    recargos: adeudos.value.reduce((sum, a) => sum + (a.recargos || 0), 0),
    total: adeudos.value.reduce((sum, a) => sum + (a.importe || 0) + (a.recargos || 0), 0)
  }
})

const loadDatos = async () => {
  if (!idLocal.value) {
    toast.warning('Ingrese el ID del local')
    return
  }

  loading.value = true
  datos.value = null
  mercadoDesc.value = ''
  renta.value = 0
  adeudos.value = []
  requerimientos.value = []
  movimientos.value = []

  try {
    // 1. Datos principales
    const result1 = await executeStoredProcedure('SP_MERCADOS_GET_DATOS_INDIVIDUALES', [
      idLocal.value
    ])
    if (result1 && result1.length > 0) {
      datos.value = result1[0]

      // 2. Mercado
      const result2 = await executeStoredProcedure('SP_MERCADOS_GET_MERCADO_INFO', [
        datos.value.oficina,
        datos.value.num_mercado
      ])
      if (result2 && result2.length > 0) {
        mercadoDesc.value = result2[0].descripcion
      }

      // 3. Cuota actual
      const result3 = await executeStoredProcedure('SP_MERCADOS_GET_CUOTA_ACTUAL', [
        new Date().getFullYear(),
        datos.value.categoria,
        datos.value.seccion,
        datos.value.clave_cuota
      ])
      if (result3 && result3.length > 0) {
        renta.value = result3[0].renta
      }

      // 4. Adeudos
      const result4 = await executeStoredProcedure('SP_MERCADOS_GET_ADEUDOS', [idLocal.value])
      adeudos.value = result4 || []

      // 5. Requerimientos
      const result5 = await executeStoredProcedure('SP_MERCADOS_GET_REQUERIMIENTOS', [
        idLocal.value
      ])
      requerimientos.value = result5 || []

      // 6. Movimientos
      const result6 = await executeStoredProcedure('SP_MERCADOS_GET_MOVIMIENTOS', [idLocal.value])
      movimientos.value = result6 || []

      toast.success('Datos cargados correctamente')
    } else {
      toast.error('No se encontr� el local especificado')
    }
  } catch (error) {
    handleError(error)
    toast.error('Error al cargar datos')
  } finally {
    loading.value = false
  }
}

const formatCurrency = (value) => {
  if (value == null) return ''
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value)
}

const formatDate = (value) => {
  if (!value) return ''
  return new Date(value).toLocaleDateString('es-MX')
}

const formatDateTime = (value) => {
  if (!value) return ''
  return new Date(value).toLocaleString('es-MX')
}
</script>



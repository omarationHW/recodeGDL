<template>
  <div class="module-view">
    <!-- Header del m�dulo -->
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="history" />
      </div>
      <div class="module-view-info">
        <h1>Datos de Movimientos</h1>
        <p>Consulta del Historial de Movimientos por Local</p>
      </div>
        </div>

    <div class="module-view-content">
      <!-- B�squeda de local -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h5>
            <font-awesome-icon icon="search" />
            B�squeda de Local
          </h5>
        </div>
        <div class="municipal-card-body">
          <div class="form-row">
            <div class="form-group">
              <label class="municipal-form-label">ID Local *</label>
              <input
                type="number"
                class="municipal-form-control"
                v-model.number="idLocal"
                placeholder="Ingrese el ID del local"
                @keyup.enter="fetchMovimientos"
              />
            </div>
        </div>
          <div class="button-group">
            <button
              class="btn-municipal-primary"
              @click="fetchMovimientos"
              :disabled="loading || !idLocal"
            >
              <font-awesome-icon icon="search" />
              Buscar Movimientos
            </button>
          </div>
        </div>
      </div>

      <!-- Tabla de movimientos -->
      <div class="municipal-card" v-if="movimientos.length > 0">
        <div class="municipal-card-header">
          <h5>
            <font-awesome-icon icon="list" />
            Historial de Movimientos
            <span class="badge-info">{{ movimientos.length }} registros</span>
          </h5>
        </div>
        <div class="municipal-card-body table-container">
          <div class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th>Control</th>
                  <th>A�o</th>
                  <th>N�mero</th>
                  <th>Fecha</th>
                  <th>Nombre</th>
                  <th>Sector</th>
                  <th>Zona</th>
                  <th>Descripci�n</th>
                  <th>Superficie</th>
                  <th>Giro</th>
                  <th>Fecha Alta</th>
                  <th>Fecha Baja</th>
                  <th>Vigencia</th>
                  <th>Usuario</th>
                  <th>Clave Cuota</th>
                  <th class="text-end">Renta</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="mov in movimientos" :key="`${mov.id_local}-${mov.numero_memo}`" class="row-hover">
                  <td><span class="badge-secondary">{{ mov.id_local }}</span></td>
                  <td>{{ mov.axo_memo }}</td>
                  <td>{{ mov.numero_memo }}</td>
                  <td><small class="text-muted">{{ formatDateTime(mov.fecha) }}</small></td>
                  <td><strong>{{ mov.nombre }}</strong></td>
                  <td>{{ mov.sector }}</td>
                  <td>{{ mov.zona }}</td>
                  <td>{{ mov.drescripcion_local }}</td>
                  <td class="text-end">{{ mov.superficie }}</td>
                  <td>{{ mov.giro }}</td>
                  <td><small class="text-muted">{{ formatDate(mov.fecha_alta) }}</small></td>
                  <td><small class="text-muted">{{ formatDate(mov.fecha_baja) }}</small></td>
                  <td>
                    <span :class="getVigenciaClass(mov.vigencia)">
                      {{ getVigenciaText(mov.vigencia) }}
                    </span>
                  </td>
                  <td><small>{{ mov.usuario }}</small></td>
                  <td>{{ mov.clave_cuota }}</td>
                  <td class="text-end">
                    <strong class="text-success">{{ formatCurrency(mov.renta) }}</strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      <!-- Cat�logos de referencia -->
      <div class="row" v-if="movimientos.length > 0">
        <div class="form-group">
          <div class="municipal-card">
            <div class="municipal-card-header">
              <h5>
                <font-awesome-icon icon="tags" />
                Claves de Movimiento
              </h5>
            </div>
            <div class="municipal-card-body">
              <ul class="catalog-list">
                <li v-for="clave in clavesMov" :key="clave.clave_movimiento">
                  <span class="badge-primary">{{ clave.clave_movimiento }}</span>
                  {{ clave.descripcion }}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="form-group">
          <div class="municipal-card">
            <div class="municipal-card-header">
              <h5>
                <font-awesome-icon icon="dollar-sign" />
                Claves de Cuota
              </h5>
            </div>
            <div class="municipal-card-body">
              <ul class="catalog-list">
                <li v-for="clave in cveCuotas" :key="clave.clave_cuota">
                  <span class="badge-primary">{{ clave.clave_cuota }}</span>
                  {{ clave.descripcion }}
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading spinner -->
      <div v-if="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando movimientos...</p>
      </div>

      <!-- No hay datos -->
      <div v-if="!loading && searched && movimientos.length === 0" class="municipal-card">
        <div class="municipal-card-body text-center py-5">
          <font-awesome-icon icon="inbox" size="3x" class="text-muted mb-3" />
          <p class="text-muted">No se encontraron movimientos para el local {{ idLocal }}</p>
        </div>
      </div>
    </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

// State
const loading = ref(false)
const searched = ref(false)
const idLocal = ref(null)
const movimientos = ref([])
const clavesMov = ref([])
const cveCuotas = ref([])

// Methods
const formatCurrency = (value) => {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value || 0)
}

const formatDate = (date) => {
  if (!date) return 'N/A'
  return new Date(date).toLocaleDateString('es-MX')
}

const formatDateTime = (date) => {
  if (!date) return 'N/A'
  return new Date(date).toLocaleString('es-MX')
}

const getVigenciaText = (vigencia) => {
  const vigencias = {
    'B': 'BAJA',
    'C': 'BAJA POR ACUERDO',
    'D': 'BAJA ADMINISTRATIVA',
    'A': 'VIGENTE'
  }
  return vigencias[vigencia] || 'VIGENTE'
}

const getVigenciaClass = (vigencia) => {
  const classes = {
    'B': 'badge-danger',
    'C': 'badge-warning',
    'D': 'badge-warning',
    'A': 'badge-success'
  }
  return classes[vigencia] || 'badge-success'
}

const calcRenta = (mov, cuota) => {
  if (!cuota) return 0

  const superficie = parseFloat(mov.superficie) || 0
  const importeCuota = parseFloat(cuota.importe_cuota) || 0

  if (mov.seccion === 'PS') {
    if (mov.clave_cuota === 4) {
      return superficie * importeCuota
    } else {
      return (importeCuota * superficie) * 30
    }
  } else {
    return superficie * importeCuota
  }
}

const fetchMovimientos = async () => {
  if (!idLocal.value) {
    toast.warning('Debe ingresar un ID de local')
    return
  }

  try {
    loading.value = true
    searched.value = true

    // 1. Obtener movimientos
    const result = await executeStoredProcedure('sp_get_movimientos_by_local', {
      p_id_local: idLocal.value
    })

    if (result.success) {
      const movs = result.data || []

      // 2. Para cada movimiento, calcular la renta
      for (let mov of movs) {
        // Obtener cuota
        const cuotaResult = await executeStoredProcedure('sp_get_cuota_by_params', {
          p_vaxo: mov.axo_memo,
          p_vcat: mov.categoria,
          p_vsec: mov.seccion,
          p_vcuo: mov.clave_cuota
        })

        if (cuotaResult.success && cuotaResult.data && cuotaResult.data.length > 0) {
          const cuota = cuotaResult.data[0]
          mov.renta = calcRenta(mov, cuota)
        } else {
          mov.renta = 0
        }
      }

      movimientos.value = movs

      if (movs.length === 0) {
        toast.info('No se encontraron movimientos')
      } else {
        toast.success(`Se encontraron ${movs.length} movimientos`)
      }
    } else {
      handleError(result)
      movimientos.value = []
    }
  } catch (error) {
    handleError(error)
  } finally {
    loading.value = false
  }
}

const loadCatalogs = async () => {
  try {
    const [clavesResult, cuotasResult] = await Promise.all([
      executeStoredProcedure('sp_get_clave_movimientos', {}),
      executeStoredProcedure('sp_get_cve_cuotas', {})
    ])

    if (clavesResult.success) clavesMov.value = clavesResult.data || []
    if (cuotasResult.success) cveCuotas.value = cuotasResult.data || []
  } catch (error) {
    handleError(error)
  }
}

// Lifecycle
onMounted(() => {
  loadCatalogs()
})
</script>



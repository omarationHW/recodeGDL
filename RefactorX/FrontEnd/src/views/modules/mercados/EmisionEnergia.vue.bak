<template>
    <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="print" />
      </div>
      <div class="module-view-info">
        <h1>Emisión de Recibos de Energía Eléctrica</h1>
        <p>Módulo de Mercados</p>
      </div>
    </div>

    <div class="module-view-content">

    <div class="municipal-card">
      <div class="municipal-card-header">
        <i class="fas fa-bolt"></i> Emisión de Recibos de Energía Eléctrica
      </div>
      <div class="municipal-card-body">
        <div class="row g-3">
          <div class="form-group">
            <label class="municipal-form-label">Recaudadora *</label>
            <select v-model="form.oficina" @change="onRecaudadoraChange" class="municipal-form-control" required>
              <option value="">Seleccione...</option>
              <option v-for="rec in recaudadoras" :key="rec.id_rec" :value="rec.id_rec">
                {{ rec.id_rec }} - {{ rec.recaudadora }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="municipal-form-label">Mercado *</label>
            <select v-model="form.mercado" class="municipal-form-control" :disabled="!mercados.length" required>
              <option value="">Seleccione...</option>
              <option v-for="merc in mercados" :key="merc.num_mercado_nvo" :value="merc.num_mercado_nvo">
                {{ merc.num_mercado_nvo }} - {{ merc.descripcion }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="municipal-form-label">Año *</label>
            <input type="number" v-model.number="form.axo" class="municipal-form-control" min="2003" max="2999" required />
          </div>
          <div class="form-group">
            <label class="municipal-form-label">Periodo (Mes) *</label>
            <input type="number" v-model.number="form.periodo" class="municipal-form-control" min="1" max="12" required />
          </div>
          <div class="form-group">
            <button class="btn-municipal-primary" @click="onEjecutar" :disabled="loading">
              <i class="fas fa-play"></i> Emisión
            </button>
            <button class="btn-municipal-success" @click="onGrabar" :disabled="!emision.length || saving">
              <i class="fas fa-save"></i> Grabar
            </button>
            <button class="btn-municipal-info" @click="onFacturacion" :disabled="!emision.length">
              <i class="fas fa-file-invoice"></i> Facturación
            </button>
          </div>
        </div>
      </div>
    </div>

    <div v-if="loading" class="text-center p-4">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Cargando emisión...</p>
    </div>

    <div v-else-if="emision.length > 0" class="municipal-card">
      <div class="municipal-card-header d-flex justify-content-between align-items-center">
        <span>
          <i class="fas fa-list"></i> Detalle de Emisión
          <span class="badge badge-info ml-2">{{ emision.length }} registros</span>
        </span>
      </div>
      <div class="municipal-card-body">
        <div class="municipal-table">
          <table class="municipal-table">
            <thead class="municipal-table-header">
              <tr>
                <th>Local</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Importe</th>
                <th>Consumo</th>
                <th>Cantidad</th>
                <th>Importe Energía</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="row in emision" :key="row.id_energia">
                <td>{{ row.local }}</td>
                <td>{{ row.nombre }}</td>
                <td>{{ row.descripcion }}</td>
                <td class="text-end">{{ formatCurrency(row.importe) }}</td>
                <td>{{ row.cve_consumo }}</td>
                <td class="text-end">{{ formatNumber(row.cantidad) }}</td>
                <td class="text-end">{{ formatCurrency(row.importe_energia) }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="municipal-table">
                <td colspan="6" class="text-end">TOTAL:</td>
                <td class="text-end">{{ formatCurrency(totales.importe_energia) }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, computed, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'
import Swal from 'sweetalert2'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const recaudadoras = ref([])
const mercados = ref([])
const emision = ref([])
const loading = ref(false)
const saving = ref(false)

const form = ref({
  oficina: '',
  mercado: '',
  axo: new Date().getFullYear(),
  periodo: new Date().getMonth() + 1
})

const totales = computed(() => {
  return {
    importe_energia: emision.value.reduce((sum, row) => sum + (row.importe_energia || 0), 0)
  }
})

const loadRecaudadoras = async () => {
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_RECAUDADORAS', [])
    recaudadoras.value = result || []
  } catch (error) {
    handleError(error)
    toast.error('Error al cargar recaudadoras')
  }
}

const onRecaudadoraChange = async () => {
  form.value.mercado = ''
  mercados.value = []
  emision.value = []

  if (form.value.oficina) {
    try {
      const result = await executeStoredProcedure('SP_MERCADOS_GET_MERCADOS_BY_RECAUDADORA', [
        form.value.oficina
      ])
      mercados.value = result || []
    } catch (error) {
      handleError(error)
      toast.error('Error al cargar mercados')
    }
  }
}

const onEjecutar = async () => {
  if (!form.value.oficina || !form.value.mercado) {
    toast.warning('Debe seleccionar recaudadora y mercado')
    return
  }

  loading.value = true
  try {
    const result = await executeStoredProcedure('SP_MERCADOS_GET_EMISION_ENERGIA', [
      form.value.oficina,
      form.value.mercado,
      form.value.axo,
      form.value.periodo
    ])
    emision.value = result || []

    if (emision.value.length === 0) {
      toast.info('No hay datos para la emisión')
    } else {
      toast.success(`Se cargaron ${emision.value.length} registros`)
    }
  } catch (error) {
    handleError(error)
    toast.error('Error al ejecutar la emisión')
  } finally {
    loading.value = false
  }
}

const onGrabar = async () => {
  if (!form.value.oficina || !form.value.mercado) {
    toast.warning('Debe seleccionar recaudadora y mercado')
    return
  }

  const result = await Swal.fire({
    title: '¿Grabar emisión?',
    text: '¿Está seguro de grabar la emisión de energía eléctrica?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sí, grabar',
    cancelButtonText: 'Cancelar'
  })

  if (result.isConfirmed) {
    saving.value = true
    try {
      await executeStoredProcedure('SP_MERCADOS_GRABAR_EMISION_ENERGIA', [
        form.value.oficina,
        form.value.mercado,
        form.value.axo,
        form.value.periodo,
        1 // id_usuario
      ])
      toast.success('Emisión grabada correctamente')
      await onEjecutar() // Recargar datos
    } catch (error) {
      handleError(error)
      toast.error('Error al grabar la emisión')
    } finally {
      saving.value = false
    }
  }
}

const onFacturacion = async () => {
  if (!form.value.oficina || !form.value.mercado) {
    toast.warning('Debe seleccionar recaudadora y mercado')
    return
  }

  try {
    const result = await executeStoredProcedure('SP_MERCADOS_FACTURACION_ENERGIA', [
      form.value.oficina,
      form.value.mercado,
      form.value.axo,
      form.value.periodo
    ])

    if (result && result.length > 0) {
      toast.success('Facturación generada correctamente')
      // Aquí se podría generar un PDF o mostrar los datos
    } else {
      toast.warning('No hay facturación para mostrar')
    }
  } catch (error) {
    handleError(error)
    toast.error('Error al generar facturación')
  }
}

const formatCurrency = (value) => {
  if (value == null) return ''
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value)
}

const formatNumber = (value) => {
  if (value == null) return ''
  return new Intl.NumberFormat('es-MX', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value)
}

onMounted(() => {
  loadRecaudadoras()
})
</script>



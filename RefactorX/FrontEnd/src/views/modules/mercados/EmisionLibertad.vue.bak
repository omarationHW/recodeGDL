<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="file-invoice-dollar" />
      </div>
      <div class="module-view-info">
        <h1>Emisi�n Libertad</h1>
        <p>Generaci�n de Recibos para Mercados con Caja de Cobro</p>
      </div>
        </div>

    <div class="module-view-content">
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h5><font-awesome-icon icon="filter" /> Par�metros de Emisi�n</h5>
        </div>
        <div class="municipal-card-body">
          <div class="form-row">
            <div class="form-group">
              <label class="municipal-form-label">Recaudadora *</label>
              <select class="municipal-form-control" v-model.number="filters.oficina" @change="loadMercados">
                <option value="">Seleccione</option>
                <option v-for="rec in recaudadoras" :key="rec.id_rec" :value="rec.id_rec">{{ rec.id_rec }} - {{ rec.recaudadora }}</option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">A�o *</label>
              <input type="number" class="municipal-form-control" v-model.number="filters.axo" min="1992" max="2999" />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Per�odo *</label>
              <select class="municipal-form-control" v-model.number="filters.periodo">
                <option v-for="m in 12" :key="m" :value="m">{{ m }} - {{ getMesNombre(m) }}</option>
              </select>
            </div>
          </div>
          <div class="form-group" v-if="mercados.length > 0">
            <label class="municipal-form-label">Mercados (seleccione uno o m�s) *</label>
            <div class="mercados-selection">
              <label v-for="mdo in mercados" :key="mdo.num_mercado_nvo" class="checkbox-label">
                <input type="checkbox" :value="mdo.num_mercado_nvo" v-model="selectedMercados" />
                {{ mdo.num_mercado_nvo }} - {{ mdo.descripcion }}
              </label>
            </div>
          </div>
          <div class="button-group">
            <button class="btn-municipal-primary" @click="generar" :disabled="loading || selectedMercados.length === 0">
              <font-awesome-icon :icon="loading ? 'spinner' : 'play'" :spin="loading" />
              Generar Emisi�n
            </button>
            <button class="btn-municipal-secondary" @click="exportar" :disabled="loading || emision.length === 0">
              <font-awesome-icon icon="download" />
              Exportar TXT
            </button>
          </div>
        </div>
      </div>

      <div class="municipal-card" v-if="emision.length > 0">
        <div class="municipal-card-header">
          <h5><font-awesome-icon icon="list" /> Detalle de Emisi�n <span class="badge-info">{{ emision.length }} registros</span></h5>
        </div>
        <div class="municipal-card-body table-container">
          <div class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th>Local</th>
                  <th>Nombre</th>
                  <th>Mercado</th>
                  <th>Cat</th>
                  <th>Secc</th>
                  <th class="text-end">Renta</th>
                  <th class="text-end">Desc.</th>
                  <th class="text-end">Adeudos</th>
                  <th class="text-end">Recargos</th>
                  <th class="text-end">Multas</th>
                  <th class="text-end">Gastos</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in emision" :key="item.id_local" class="row-hover">
                  <td>{{ item.id_local }}</td>
                  <td><strong>{{ item.nombre }}</strong></td>
                  <td>{{ item.descripcion }}</td>
                  <td>{{ item.categoria }}</td>
                  <td>{{ item.seccion }}</td>
                  <td class="text-end">{{ formatCurrency(item.renta) }}</td>
                  <td class="text-end">{{ formatCurrency(item.descuento) }}</td>
                  <td class="text-end">{{ formatCurrency(item.adeudos) }}</td>
                  <td class="text-end">{{ formatCurrency(item.recargos) }}</td>
                  <td class="text-end">{{ formatCurrency(item.multas) }}</td>
                  <td class="text-end">{{ formatCurrency(item.gastos) }}</td>
                  <td class="text-end"><strong class="text-success">{{ formatCurrency(calcTotal(item)) }}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const loading = ref(false)
const recaudadoras = ref([])
const mercados = ref([])
const selectedMercados = ref([])
const emision = ref([])
const filters = ref({ oficina: '', axo: new Date().getFullYear(), periodo: new Date().getMonth() + 1 })

const formatCurrency = (value) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value || 0)
const getMesNombre = (m) => ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][m - 1]
const calcTotal = (item) => parseFloat(item.adeudos || 0) + parseFloat(item.recargos || 0) + parseFloat(item.multas || 0) + parseFloat(item.gastos || 0)

const loadRecaudadoras = async () => {
  const result = await executeStoredProcedure('get_recaudadoras', {})
  if (result.success) recaudadoras.value = result.data || []
}

const loadMercados = async () => {
  if (!filters.value.oficina) return
  const result = await executeStoredProcedure('get_mercados_by_recaudadora', { p_oficina: filters.value.oficina })
  if (result.success) {
    mercados.value = result.data || []
    selectedMercados.value = []
  }
}

const generar = async () => {
  try {
    loading.value = true
    const result = await executeStoredProcedure('get_emision_libertad_detalle', {
      p_oficina: filters.value.oficina,
      p_mercados: JSON.stringify(selectedMercados.value),
      p_axo: filters.value.axo,
      p_periodo: filters.value.periodo
    })
    if (result.success) {
      emision.value = result.data || []
      toast.success(`Emisi�n generada: ${emision.value.length} locales`)
    } else handleError(result)
  } catch (error) {
    handleError(error)
  } finally {
    loading.value = false
  }
}

const exportar = async () => {
  try {
    loading.value = true
    const result = await executeStoredProcedure('exportar_emision_libertad', {
      p_oficina: filters.value.oficina,
      p_mercados: JSON.stringify(selectedMercados.value),
      p_axo: filters.value.axo,
      p_periodo: filters.value.periodo,
      p_usuario_id: 1
    })
    if (result.success) toast.success('Archivo exportado correctamente')
    else handleError(result)
  } catch (error) {
    handleError(error)
  } finally {
    loading.value = false
  }
}

onMounted(() => loadRecaudadoras())
</script>



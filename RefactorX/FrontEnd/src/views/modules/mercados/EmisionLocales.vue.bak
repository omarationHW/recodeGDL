<template>
  <div class="module-view">
    <!-- Header -->
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="receipt" />
      </div>
      <div class="module-view-info">
        <h1>Emisión de Recibos de Locales</h1>
        <p>Mercados - Generación de adeudos mensuales para locales comerciales</p>
      </div>
      <div class="module-view-actions">
        <button class="btn-help-icon" @click="mostrarAyuda = true" title="Ayuda">
          <font-awesome-icon icon="question-circle" />
          Ayuda
        </button>
      </div>
        </div>

    <!-- Parámetros de Emisión -->
    <div class="municipal-card">
      <h5 class="municipal-card-header">
        <font-awesome-icon icon="cog" /> Parámetros de Emisión
      </h5>
      <form @submit.prevent="verificarEmision" class="municipal-form">
        <div class="form-row">
          <div class="col-md-3">
            <div class="form-group">
              <label class="municipal-form-label required">Recaudadora/Oficina</label>
              <select v-model.number="parametros.oficina" class="municipal-form-control" required @change="cargarMercados">
                <option value="">Seleccione</option>
                <option
                  v-for="rec in recaudadoras"
                  :key="rec.id_rec"
                  :value="rec.id_rec"
                >
                  {{ rec.id_rec }} - {{ rec.recaudadora }}
                </option>
              </select>
            </div>
          </div>

          <div class="col-md-3">
            <div class="form-group">
              <label class="municipal-form-label required">Mercado</label>
              <select v-model.number="parametros.mercado" class="municipal-form-control" required>
                <option value="">Seleccione</option>
                <option
                  v-for="mercado in mercados"
                  :key="mercado.num_mercado_nvo"
                  :value="mercado.num_mercado_nvo"
                >
                  {{ mercado.num_mercado_nvo }} - {{ mercado.descripcion }}
                </option>
              </select>
            </div>
          </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">Año</label>
              <input
                type="number"
                v-model.number="parametros.axo"
                class="municipal-form-control"
                required
                min="2000"
                :max="new Date().getFullYear()"
              />
            </div>
          </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label required">Periodo (Mes)</label>
              <select v-model.number="parametros.periodo" class="municipal-form-control" required>
                <option v-for="mes in meses" :key="mes.value" :value="mes.value">
                  {{ mes.label }}
                </option>
              </select>
            </div>
          </div>

          <div class="col-md-2">
            <div class="form-group">
              <label class="municipal-form-label">&nbsp;</label>
              <button type="submit" class="btn-municipal-primary w-100" :disabled="cargando">
                <font-awesome-icon :icon="cargando ? 'spinner' : 'search'" :spin="cargando" />
                Verificar
              </button>
            </div>
          </div>
        </div>
      </form>

      <!-- Estado de Verificación -->
      <div v-if="estadoEmision" class="alert" :class="estadoEmision.tipo">
        <font-awesome-icon :icon="estadoEmision.icono" />
        <strong>{{ estadoEmision.mensaje }}</strong>
        <p class="mb-0 mt-2">{{ estadoEmision.detalle }}</p>
      </div>
    </div>

    <!-- Vista Previa de Locales -->
    <div v-if="localesEmision.length > 0" class="municipal-card">
      <div class="card-municipal-header">
        <h5 class="card-municipal-title mb-0">
          <font-awesome-icon icon="list" />
          Vista Previa - Locales a Emitir ({{ localesEmision.length }})
        </h5>
        <div class="d-flex gap-2">
          <button class="btn-municipal-success" @click="confirmarEmision" :disabled="emitiendo">
            <font-awesome-icon :icon="emitiendo ? 'spinner' : 'check'" :spin="emitiendo" />
            {{ emitiendo ? 'Emitiendo...' : 'Emitir Recibos' }}
          </button>
          <button class="btn-municipal-info" @click="exportarExcel">
            <font-awesome-icon icon="file-excel" />
            Exportar
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-dashboard mb-3">
        <div class="stat-item stat-primary">
          <div class="stat-value-mini">{{ localesEmision.length }}</div>
          <div class="stat-label-mini">Total Locales</div>
        </div>
        <div class="stat-item stat-success">
          <div class="stat-value-mini">${{ formatCurrency(totalRenta) }}</div>
          <div class="stat-label-mini">Total a Emitir</div>
        </div>
        <div class="stat-item stat-info">
          <div class="stat-value-mini">${{ formatCurrency(promedioRenta) }}</div>
          <div class="stat-label-mini">Promedio por Local</div>
        </div>
        <div class="stat-item stat-warning">
          <div class="stat-value-mini">{{ parametros.periodo }}/{{ parametros.axo }}</div>
          <div class="stat-label-mini">Periodo</div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="municipal-table">
        <table class="municipal-table">
          <thead>
            <tr>
              <th>Ubicación</th>
              <th>Comerciante</th>
              <th>Descripción Local</th>
              <th class="text-center">Superficie</th>
              <th class="text-center">Clave Cuota</th>
              <th class="text-end">Importe Cuota</th>
              <th class="text-end">Renta a Emitir</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="local in localesEmision" :key="local.id_local">
              <td>
                <strong>{{ formatUbicacion(local) }}</strong>
                <br>
                <small class="text-muted">{{ local.seccion }}</small>
              </td>
              <td>{{ local.nombre }}</td>
              <td>
                <small>{{ local.descripcion_local }}</small>
              </td>
              <td class="text-center">{{ local.superficie ? local.superficie.toFixed(2) : '0.00' }} m²</td>
              <td class="text-center">
                <span class="badge bg-secondary">{{ local.clave_cuota }}</span>
              </td>
              <td class="text-end">${{ formatCurrency(local.importe_cuota) }}</td>
              <td class="text-end">
                <strong class="text-success">${{ formatCurrency(local.renta) }}</strong>
                <br>
                <small v-if="local.seccion === 'PS'" class="badge bg-warning text-dark">
                  PS × 30
                </small>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="municipal-table">
              <td colspan="6" class="text-end"><strong>TOTAL A EMITIR:</strong></td>
              <td class="text-end">
                <strong class="text-success">${{ formatCurrency(totalRenta) }}</strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Mensaje cuando no hay locales -->
    <div v-else-if="consultaRealizada && !cargando" class="municipal-card">
      <div class="alert alert-info mb-0">
        <font-awesome-icon icon="info-circle" />
        No se encontraron locales pendientes de emisión para los parámetros seleccionados.
        <br>
        <small>Todos los locales ya tienen pago o adeudo registrado para este periodo.</small>
      </div>
    </div>

    <!-- Modal: Ayuda -->
    <DocumentationModal
      :show="mostrarAyuda"
      @close="mostrarAyuda = false"
      title="Ayuda - Emisión de Recibos de Locales"
    >
      <h5>Descripción del Módulo</h5>
      <p>
        Este módulo permite generar automáticamente los adeudos mensuales (emisión de recibos)
        para todos los locales activos de un mercado que no tengan pago registrado.
      </p>

      <h5>Proceso de Emisión</h5>
      <ol>
        <li><strong>Seleccionar Parámetros:</strong> Elija la recaudadora, mercado, año y periodo (mes)</li>
        <li><strong>Verificar:</strong> El sistema muestra cuántos adeudos ya existen vs locales activos</li>
        <li><strong>Vista Previa:</strong> Revise la lista de locales que se emitirán y los importes</li>
        <li><strong>Emitir Recibos:</strong> Confirme para crear los adeudos en el sistema</li>
        <li><strong>Confirmación:</strong> Se muestra el resultado con total de recibos emitidos</li>
      </ol>

      <h5>Reglas de Emisión</h5>
      <ul>
        <li><strong>Solo locales activos:</strong> Vigencia = 'A' y sin bloqueo nivel 4+</li>
        <li><strong>Sin pago previo:</strong> No se emite si ya existe pago para el periodo</li>
        <li><strong>Sin adeudo previo:</strong> No se emite si ya existe adeudo para el periodo</li>
        <li><strong>Sin cancelación:</strong> No se emite si el adeudo fue cancelado</li>
      </ul>

      <h5>Cálculo de Renta</h5>
      <p><strong>Reglas de negocio:</strong></p>
      <ul>
        <li><strong>Sección PS con clave 4:</strong> Superficie × Cuota</li>
        <li><strong>Sección PS (otros):</strong> (Cuota × Superficie) × 30 días</li>
        <li><strong>Otras secciones:</strong> Superficie × Cuota</li>
      </ul>

      <h5>Verificación Previa</h5>
      <p>
        Antes de emitir, el sistema verifica:
      </p>
      <ul>
        <li>Total de adeudos ya existentes para el periodo</li>
        <li>Total de locales activos en el mercado</li>
        <li>Si ya hay emisión completa, muestra advertencia</li>
      </ul>

      <h5>Estadísticas Mostradas</h5>
      <ul>
        <li><strong>Total Locales:</strong> Cantidad de locales a emitir</li>
        <li><strong>Total a Emitir:</strong> Suma de todas las rentas</li>
        <li><strong>Promedio por Local:</strong> Renta promedio</li>
        <li><strong>Periodo:</strong> Mes/Año de la emisión</li>
      </ul>

      <h5>Exportación</h5>
      <p>
        Puede exportar la vista previa a Excel para revisión o archivo antes de confirmar la emisión.
      </p>

      <h5>Notas Importantes</h5>
      <ul>
        <li>La emisión es irreversible - los adeudos se crean en el sistema</li>
        <li>Verifique siempre la vista previa antes de emitir</li>
        <li>Si un local ya tiene adeudo, aparecerá como "ya existe" en el resultado</li>
        <li>La emisión debe hacerse al inicio de cada mes</li>
        <li>Los adeudos generados quedan pendientes hasta que se registre el pago</li>
      </ul>
    </DocumentationModal>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from '@/composables/useToast'
import Swal from 'sweetalert2'
import DocumentationModal from '@/components/common/DocumentationModal.vue'

const { execute } = useApi()
const { handleApiError } = useLicenciasErrorHandler()
const { showToast } = useToast()

// Estado
const cargando = ref(false)
const emitiendo = ref(false)
const consultaRealizada = ref(false)
const mostrarAyuda = ref(false)

// Datos
const recaudadoras = ref([])
const mercados = ref([])
const localesEmision = ref([])
const estadoEmision = ref(null)

// Parámetros
const parametros = ref({
  oficina: '',
  mercado: '',
  axo: new Date().getFullYear(),
  periodo: new Date().getMonth() + 1
})

// Catálogos
const meses = [
  { value: 1, label: 'Enero' },
  { value: 2, label: 'Febrero' },
  { value: 3, label: 'Marzo' },
  { value: 4, label: 'Abril' },
  { value: 5, label: 'Mayo' },
  { value: 6, label: 'Junio' },
  { value: 7, label: 'Julio' },
  { value: 8, label: 'Agosto' },
  { value: 9, label: 'Septiembre' },
  { value: 10, label: 'Octubre' },
  { value: 11, label: 'Noviembre' },
  { value: 12, label: 'Diciembre' }
]

// Computed
const totalRenta = computed(() => {
  return localesEmision.value.reduce((sum, local) =>
    sum + (parseFloat(local.renta) || 0), 0)
})

const promedioRenta = computed(() => {
  if (localesEmision.value.length === 0) return 0
  return totalRenta.value / localesEmision.value.length
})

// Watchers
watch(() => parametros.value.oficina, () => {
  if (parametros.value.oficina) {
    cargarMercados()
  } else {
    mercados.value = []
  }
})

// Métodos
const cargarRecaudadoras = async () => {
  try {
    const response = await execute('SP_MERCADOS_RECAUDADORAS_LIST', 'mercados', {})
    recaudadoras.value = response || []
  } catch (error) {
    handleApiError(error, 'Error al cargar recaudadoras')
  }
}

const cargarMercados = async () => {
  if (!parametros.value.oficina) return

  try {
    const response = await execute('SP_MERCADOS_EMISION_MERCADOS_LIST', 'mercados', {
      p_oficina: parseInt(parametros.value.oficina)
    })
    mercados.value = response || []
  } catch (error) {
    handleApiError(error, 'Error al cargar mercados')
  }
}

const verificarEmision = async () => {
  if (!parametros.value.oficina || !parametros.value.mercado) {
    showToast('Debe seleccionar oficina y mercado', 'error')
    return
  }

  cargando.value = true
  consultaRealizada.value = false
  estadoEmision.value = null
  localesEmision.value = []

  try {
    // Primero verificar estado
    const verificacion = await execute('SP_MERCADOS_EMISION_VERIFICAR', 'mercados', {
      p_oficina: parseInt(parametros.value.oficina),
      p_mercado: parseInt(parametros.value.mercado),
      p_axo: parametros.value.axo,
      p_periodo: parametros.value.periodo
    })

    if (verificacion && verificacion.length > 0) {
      const estado = verificacion[0]
      const totalAdeudos = parseInt(estado.total_adeudos) || 0
      const totalLocales = parseInt(estado.total_locales_activos) || 0

      if (totalAdeudos >= totalLocales && totalLocales > 0) {
        estadoEmision.value = {
          tipo: 'alert-warning',
          icono: 'exclamation-triangle',
          mensaje: 'Emisión ya realizada',
          detalle: `Ya existen ${totalAdeudos} adeudos de ${totalLocales} locales activos. La emisión podría estar completa.`
        }
      } else if (totalAdeudos > 0) {
        estadoEmision.value = {
          tipo: 'alert-info',
          icono: 'info-circle',
          mensaje: 'Emisión parcial detectada',
          detalle: `Existen ${totalAdeudos} adeudos de ${totalLocales} locales activos. Se emitirán los faltantes.`
        }
      } else {
        estadoEmision.value = {
          tipo: 'alert-success',
          icono: 'check-circle',
          mensaje: 'Sin emisión previa',
          detalle: `No hay adeudos para este periodo. Se pueden emitir hasta ${totalLocales} recibos.`
        }
      }
    }

    // Luego cargar locales pendientes
    const response = await execute('SP_MERCADOS_EMISION_EMITIR_RECIBOS', 'mercados', {
      p_oficina: parseInt(parametros.value.oficina),
      p_mercado: parseInt(parametros.value.mercado),
      p_axo: parametros.value.axo,
      p_periodo: parametros.value.periodo
    })

    localesEmision.value = response || []
    consultaRealizada.value = true

    if (localesEmision.value.length === 0) {
      showToast('No hay locales pendientes de emisión', 'info')
    } else {
      showToast(`${localesEmision.value.length} locales listos para emitir`, 'success')
    }
  } catch (error) {
    handleApiError(error, 'Error al verificar emisión')
  } finally {
    cargando.value = false
  }
}

const confirmarEmision = async () => {
  if (localesEmision.value.length === 0) {
    showToast('No hay locales para emitir', 'warning')
    return
  }

  const result = await Swal.fire({
    title: '¿Confirmar Emisión?',
    html: `
      Se emitirán <strong>${localesEmision.value.length} recibos</strong><br>
      por un total de <strong>$${formatCurrency(totalRenta.value)}</strong><br><br>
      <small>Esta acción creará adeudos en el sistema</small>
    `,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sí, emitir recibos',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#28a745',
    cancelButtonColor: '#6c757d'
  })

  if (result.isConfirmed) {
    emitiendo.value = true

    try {
      const response = await execute('SP_MERCADOS_EMISION_GRABAR', 'mercados', {
        p_oficina: parseInt(parametros.value.oficina),
        p_mercado: parseInt(parametros.value.mercado),
        p_axo: parametros.value.axo,
        p_periodo: parametros.value.periodo,
        p_id_usuario: 1 // TODO: Obtener del contexto de usuario
      })

      if (response && response.length > 0) {
        const resultado = response[0]

        await Swal.fire({
          title: 'Emisión Completada',
          html: `
            <div class="text-start">
              <p><strong>Recibos insertados:</strong> ${resultado.total_insertados}</p>
              <p><strong>Ya existían:</strong> ${resultado.total_ya_existentes}</p>
              <p class="mb-0"><small>${resultado.mensaje}</small></p>
            </div>
          `,
          icon: 'success',
          confirmButtonText: 'Aceptar'
        })

        // Limpiar y recargar
        localesEmision.value = []
        estadoEmision.value = null
        consultaRealizada.value = false
      }
    } catch (error) {
      handleApiError(error, 'Error al emitir recibos')
    } finally {
      emitiendo.value = false
    }
  }
}

const formatUbicacion = (local) => {
  let ubicacion = `${local.oficina}-${local.num_mercado}-${local.categoria}-${local.seccion}-${local.num_local}`
  if (local.letra_local) {
    ubicacion += `-${local.letra_local}`
  }
  if (local.bloque) {
    ubicacion += `-${local.bloque}`
  }
  return ubicacion
}

const formatCurrency = (value) => {
  if (!value) return '0.00'
  return parseFloat(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
}

const exportarExcel = () => {
  const data = localesEmision.value.map(local => ({
    'Oficina': local.oficina,
    'Mercado': local.num_mercado,
    'Categoría': local.categoria,
    'Sección': local.seccion,
    'Local': local.num_local,
    'Letra': local.letra_local || '',
    'Bloque': local.bloque || '',
    'Comerciante': local.nombre,
    'Descripción': local.descripcion_local,
    'Superficie': local.superficie,
    'Clave Cuota': local.clave_cuota,
    'Importe Cuota': local.importe_cuota,
    'Renta': local.renta
  }))

  const headers = Object.keys(data[0])
  const csv = [
    headers.join(','),
    ...data.map(row => headers.map(header => {
      const value = row[header]
      return typeof value === 'string' && value.includes(',') ? `"${value}"` : value
    }).join(','))
  ].join('\n')

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  const url = URL.createObjectURL(blob)

  link.setAttribute('href', url)
  link.setAttribute('download', `emision_locales_${parametros.value.axo}_${parametros.value.periodo}.csv`)
  link.style.visibility = 'hidden'

  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)

  showToast('Archivo exportado exitosamente', 'success')
}

// Lifecycle
onMounted(() => {
  cargarRecaudadoras()
})
</script>



<template>
  <div class="module-view">
    <!-- HEADER -->
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="list-alt" />
      </div>
      <div class="module-view-info">
        <h1>Listados de Locales</h1>
        <p>Mercados - Reportes y listados diversos</p>
      </div>
      <button class="btn-help-icon" @click="mostrarAyuda" type="button">
        <font-awesome-icon icon="question-circle" /> Ayuda
      </button>
    </div>

    <!-- TABS -->
    <div class="municipal-card">
      <div class="module-view">
        <button
          v-for="tab in tabs"
          :key="tab.id"
          :class="['tab-button', { active: tabActual === tab.id }]"
          @click="tabActual = tab.id"
        >
          <font-awesome-icon :icon="tab.icon" /> {{ tab.label }}
        </button>
      </div>
    </div>

    <!-- TAB 1: PADRÓN DE LOCALES -->
    <div v-show="tabActual === 'padron'" class="municipal-card">
      <div class="municipal-card-header"><h5>
        <font-awesome-icon icon="building" /> Padrón de Locales
      </h5></div>
      <div class="municipal-card-body"><form @submit.prevent="consultarPadron" >
        <div class="form-row">
          <div class="form-group">
            <label for="padron_oficina" class="municipal-form-label required">Recaudadora:</label>
            <select
              v-model.number="padron.oficina"
              id="padron_oficina"
              class="municipal-form-control"
              required
              :disabled="cargando"
              @change="cargarMercadosPadron"
            >
              <option value="">Seleccione...</option>
              <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                {{ rec.recaudadora }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="padron_mercado" class="municipal-form-label required">Mercado:</label>
            <select
              v-model.number="padron.mercado"
              id="padron_mercado"
              class="municipal-form-control"
              required
              :disabled="cargando || !padron.oficina"
            >
              <option value="">Seleccione...</option>
              <option v-for="mer in mercadosPadron" :key="mer.num_mercado_nvo" :value="mer.num_mercado_nvo">
                {{ mer.num_mercado_nvo }} - {{ mer.descripcion }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <button type="submit" class="btn-municipal-primary" :disabled="cargando">
            <font-awesome-icon icon="search" /> Consultar
          </button>
          <button
            type="button"
            class="btn-municipal-success"
            @click="exportarPadron"
            :disabled="cargando || localesPadron.length === 0"
          >
            <font-awesome-icon icon="file-excel" /> Exportar Excel
          </button>
        </div>
      </form>

      <div v-if="localesPadron.length > 0" class="municipal-table">
        <table class="municipal-table">
          <thead>
            <tr>
              <th>Ubicación</th>
              <th>Nombre</th>
              <th class="text-end">Superficie</th>
              <th class="text-end">Renta</th>
              <th class="text-center">Vigencia</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="loc in localesPadron" :key="loc.id_local">
              <td>
                <strong>Cat{{ loc.categoria }}-{{ loc.seccion }}-{{ loc.local }}</strong>
                {{ loc.letra_local }} {{ loc.bloque }}
              </td>
              <td>{{ loc.nombre }}</td>
              <td class="text-end">{{ formatNumber(loc.superficie) }} m²</td>
              <td class="text-end">
                <strong class="text-success">${{ formatCurrency(loc.renta) }}</strong>
              </td>
              <td class="text-center">
                <span :class="['badge', loc.vigencia === 'A' ? 'badge-success' : 'badge-danger']">
                  {{ loc.vigencia === 'A' ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      </div>
    </div>

    <!-- TAB 2: MOVIMIENTOS -->
    <div v-show="tabActual === 'movimientos'" class="municipal-card">
      <div class="municipal-card-header"><h5>
        <font-awesome-icon icon="exchange-alt" /> Movimientos de Locales
      </h5></div>
      <div class="municipal-card-body"><form @submit.prevent="consultarMovimientos" >
        <div class="form-row">
          <div class="form-group">
            <label for="mov_fecha_desde" class="municipal-form-label required">Fecha Desde:</label>
            <input
              type="date"
              v-model="movimientos.fecha_desde"
              id="mov_fecha_desde"
              class="municipal-form-control"
              required
              :disabled="cargando"
            />
          </div>

          <div class="form-group">
            <label for="mov_fecha_hasta" class="municipal-form-label required">Fecha Hasta:</label>
            <input
              type="date"
              v-model="movimientos.fecha_hasta"
              id="mov_fecha_hasta"
              class="municipal-form-control"
              required
              :disabled="cargando"
            />
          </div>

          <div class="form-group">
            <label for="mov_oficina" class="municipal-form-label required">Recaudadora:</label>
            <select
              v-model.number="movimientos.oficina"
              id="mov_oficina"
              class="municipal-form-control"
              required
              :disabled="cargando"
            >
              <option value="">Seleccione...</option>
              <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                {{ rec.recaudadora }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <button type="submit" class="btn-municipal-primary" :disabled="cargando">
            <font-awesome-icon icon="search" /> Consultar
          </button>
          <button
            type="button"
            class="btn-municipal-success"
            @click="exportarMovimientos"
            :disabled="cargando || listaMovimientos.length === 0"
          >
            <font-awesome-icon icon="file-excel" /> Exportar Excel
          </button>
        </div>
      </form>

      <div v-if="listaMovimientos.length > 0" class="municipal-table">
        <table class="municipal-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Ubicación</th>
              <th>Nombre</th>
              <th>Tipo Movimiento</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="mov in listaMovimientos" :key="mov.id_movimiento">
              <td>{{ formatFecha(mov.fecha) }}</td>
              <td>
                <strong>Merc{{ mov.num_mercado }}-Cat{{ mov.categoria }}-{{ mov.seccion }}-{{ mov.local }}</strong>
              </td>
              <td>{{ mov.nombre }}</td>
              <td>
                <span class="badge-info">{{ mov.tipo_descripcion }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      </div>
    </div>

    <!-- TAB 3: PAGOS -->
    <div v-show="tabActual === 'pagos'" class="municipal-card">
      <div class="municipal-card-header"><h5>
        <font-awesome-icon icon="dollar-sign" /> Pagos de Locales
      </h5></div>
      <div class="municipal-card-body"><form @submit.prevent="consultarPagos" >
        <div class="form-row">
          <div class="form-group">
            <label for="pag_fecha_desde" class="municipal-form-label required">Fecha Desde:</label>
            <input
              type="date"
              v-model="pagos.fecha_desde"
              id="pag_fecha_desde"
              class="municipal-form-control"
              required
              :disabled="cargando"
            />
          </div>

          <div class="form-group">
            <label for="pag_fecha_hasta" class="municipal-form-label required">Fecha Hasta:</label>
            <input
              type="date"
              v-model="pagos.fecha_hasta"
              id="pag_fecha_hasta"
              class="municipal-form-control"
              required
              :disabled="cargando"
            />
          </div>

          <div class="form-group">
            <label for="pag_oficina" class="municipal-form-label required">Recaudadora:</label>
            <select
              v-model.number="pagos.oficina"
              id="pag_oficina"
              class="municipal-form-control"
              required
              :disabled="cargando"
            >
              <option value="">Seleccione...</option>
              <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                {{ rec.recaudadora }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <button type="submit" class="btn-municipal-primary" :disabled="cargando">
            <font-awesome-icon icon="search" /> Consultar
          </button>
          <button
            type="button"
            class="btn-municipal-success"
            @click="exportarPagos"
            :disabled="cargando || listaPagos.length === 0"
          >
            <font-awesome-icon icon="file-excel" /> Exportar Excel
          </button>
        </div>
      </form>

      <div v-if="listaPagos.length > 0">
        <div class="stats-dashboard mb-3">
          <div class="stat-item stat-success">
            <div class="stat-value">${{ formatCurrency(totalPagos) }}</div>
            <div class="stat-label">Total Pagado</div>
            <div class="stat-sublabel">{{ listaPagos.length }} pagos</div>
          </div>
        </div>

        <div class="municipal-table">
          <table class="municipal-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Ubicación</th>
                <th>Nombre</th>
                <th>Periodo</th>
                <th class="text-end">Importe</th>
                <th>Folio</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="pag in listaPagos" :key="pag.id_pago_local">
                <td>{{ formatFecha(pag.fecha_pago) }}</td>
                <td>
                  <strong>Merc{{ pag.num_mercado }}-Cat{{ pag.categoria }}-{{ pag.seccion }}-{{ pag.local }}</strong>
                </td>
                <td>{{ pag.nombre }}</td>
                <td>{{ pag.axo }}/{{ String(pag.periodo).padStart(2, '0') }}</td>
                <td class="text-end">
                  <strong class="text-success">${{ formatCurrency(pag.importe_pago) }}</strong>
                </td>
                <td>{{ pag.folio }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      </div>
    </div>

    <!-- TAB 4: INGRESO ZONIFICADO -->
    <div v-show="tabActual === 'zonificado'" class="municipal-card">
      <div class="municipal-card-header"><h5>
        <font-awesome-icon icon="map-marked-alt" /> Ingreso Zonificado
      </h5></div>
      <div class="municipal-card-body">
        <form @submit.prevent="consultarZonificado" >
        <div class="form-row">
          <div class="form-group">
            <label for="zon_fecha_desde" class="municipal-form-label required">Fecha Desde:</label>
            <input
              type="date"
              v-model="zonificado.fecha_desde"
              id="zon_fecha_desde"
              class="municipal-form-control"
              required
              :disabled="cargando"
            />
          </div>

          <div class="form-group">
            <label for="zon_fecha_hasta" class="municipal-form-label required">Fecha Hasta:</label>
            <input
              type="date"
              v-model="zonificado.fecha_hasta"
              id="zon_fecha_hasta"
              class="municipal-form-control"
              required
              :disabled="cargando"
            />
          </div>
        </div>

        <div class="form-row">
          <button type="submit" class="btn-municipal-primary" :disabled="cargando">
            <font-awesome-icon icon="search" /> Consultar
          </button>
          <button
            type="button"
            class="btn-municipal-success"
            @click="exportarZonificado"
            :disabled="cargando || listaZonificado.length === 0"
          >
            <font-awesome-icon icon="file-excel" /> Exportar Excel
          </button>
        </div>
      </form>
      </div>

      <div v-if="listaZonificado.length > 0">
        <div class="stats-dashboard mb-3">
          <div class="stat-item stat-primary">
            <div class="stat-value">${{ formatCurrency(totalZonificado) }}</div>
            <div class="stat-label">Total Global</div>
            <div class="stat-sublabel">{{ listaZonificado.length }} zonas</div>
          </div>
        </div>

        <div class="municipal-table">
          <table class="municipal-table">
            <thead>
              <tr>
                <th class="text-center">ID Zona</th>
                <th>Zona</th>
                <th class="text-end">Ingreso</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="zon in listaZonificado" :key="zon.id_zona">
                <td class="text-center">{{ zon.id_zona }}</td>
                <td><strong>{{ zon.zona }}</strong></td>
                <td class="text-end">
                  <strong class="text-success">${{ formatCurrency(zon.pagado) }}</strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, computed, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from '@/composables/useToast'
import Swal from 'sweetalert2'
import * as XLSX from 'xlsx'

const { execute } = useApi()
const { handleError } = useLicenciasErrorHandler()
const { showToast } = useToast()

// Estado
const cargando = ref(false)
const tabActual = ref('padron')

// Catálogos
const recaudadoras = ref([])
const mercadosPadron = ref([])

// Tabs
const tabs = [
  { id: 'padron', label: 'Padrón', icon: 'building' },
  { id: 'movimientos', label: 'Movimientos', icon: 'exchange-alt' },
  { id: 'pagos', label: 'Pagos', icon: 'dollar-sign' },
  { id: 'zonificado', label: 'Ingreso Zonificado', icon: 'map-marked-alt' }
]

// Padrón
const padron = ref({
  oficina: '',
  mercado: ''
})
const localesPadron = ref([])

// Movimientos
const movimientos = ref({
  fecha_desde: obtenerPrimerDiaMes(),
  fecha_hasta: obtenerUltimoDiaMes(),
  oficina: ''
})
const listaMovimientos = ref([])

// Pagos
const pagos = ref({
  fecha_desde: obtenerPrimerDiaMes(),
  fecha_hasta: obtenerUltimoDiaMes(),
  oficina: ''
})
const listaPagos = ref([])

// Zonificado
const zonificado = ref({
  fecha_desde: obtenerPrimerDiaMes(),
  fecha_hasta: obtenerUltimoDiaMes()
})
const listaZonificado = ref([])

// Computed
const totalPagos = computed(() => {
  return listaPagos.value.reduce((sum, pag) => sum + (pag.importe_pago || 0), 0)
})

const totalZonificado = computed(() => {
  return listaZonificado.value.reduce((sum, zon) => sum + (zon.pagado || 0), 0)
})

// Funciones auxiliares
function obtenerPrimerDiaMes() {
  const fecha = new Date()
  return `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-01`
}

function obtenerUltimoDiaMes() {
  const fecha = new Date()
  const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0).getDate()
  return `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(ultimoDia).padStart(2, '0')}`
}

function formatCurrency(valor) {
  if (!valor && valor !== 0) return '0.00'
  return parseFloat(valor).toLocaleString('es-MX', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  })
}

function formatNumber(valor) {
  if (!valor && valor !== 0) return '0.00'
  return parseFloat(valor).toLocaleString('es-MX', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  })
}

function formatFecha(fecha) {
  if (!fecha) return ''
  const d = new Date(fecha)
  return d.toLocaleDateString('es-MX')
}

// Cargar catálogos iniciales
onMounted(async () => {
  try {
    cargando.value = true
    const response = await execute('SP_MERCADOS_RECAUDADORAS_LIST', 'mercados', {})
    recaudadoras.value = response || []

    if (recaudadoras.value.length > 0) {
      padron.value.oficina = recaudadoras.value[0].oficina
      movimientos.value.oficina = recaudadoras.value[0].oficina
      pagos.value.oficina = recaudadoras.value[0].oficina
      await cargarMercadosPadron()
    }
  } catch (error) {
    handleError(error)
  } finally {
    cargando.value = false
  }
})

// Cargar mercados para padrón
async function cargarMercadosPadron() {
  if (!padron.value.oficina) return

  try {
    const response = await execute('SP_MERCADOS_MERCADOS_LIST', 'mercados', {
      p_oficina: parseInt(padron.value.oficina)
    })
    mercadosPadron.value = response || []
  } catch (error) {
    handleError(error)
  }
}

// Consultar padrón
async function consultarPadron() {
  try {
    cargando.value = true
    const response = await execute('SP_MERCADOS_LISTADO_PADRON_LOCALES', 'mercados', {
      p_oficina: parseInt(padron.value.oficina),
      p_mercado: parseInt(padron.value.mercado)
    })

    localesPadron.value = response || []
    showToast(`Se encontraron ${localesPadron.value.length} locales`, 'success')
  } catch (error) {
    handleError(error)
  } finally {
    cargando.value = false
  }
}

// Consultar movimientos
async function consultarMovimientos() {
  try {
    cargando.value = true
    const response = await execute('SP_MERCADOS_LISTADO_MOVIMIENTOS', 'mercados', {
      p_fecha_desde: movimientos.value.fecha_desde,
      p_fecha_hasta: movimientos.value.fecha_hasta,
      p_oficina: parseInt(movimientos.value.oficina)
    })

    listaMovimientos.value = response || []
    showToast(`Se encontraron ${listaMovimientos.value.length} movimientos`, 'success')
  } catch (error) {
    handleError(error)
  } finally {
    cargando.value = false
  }
}

// Consultar pagos
async function consultarPagos() {
  try {
    cargando.value = true
    const response = await execute('SP_MERCADOS_LISTADO_PAGOS', 'mercados', {
      p_fecha_desde: pagos.value.fecha_desde,
      p_fecha_hasta: pagos.value.fecha_hasta,
      p_oficina: parseInt(pagos.value.oficina)
    })

    listaPagos.value = response || []
    showToast(`Se encontraron ${listaPagos.value.length} pagos por $${formatCurrency(totalPagos.value)}`, 'success')
  } catch (error) {
    handleError(error)
  } finally {
    cargando.value = false
  }
}

// Consultar zonificado
async function consultarZonificado() {
  try {
    cargando.value = true
    const response = await execute('SP_MERCADOS_LISTADO_INGRESO_ZONIFICADO', 'mercados', {
      p_fecha_desde: zonificado.value.fecha_desde,
      p_fecha_hasta: zonificado.value.fecha_hasta
    })

    listaZonificado.value = response || []
    showToast(`Se encontraron ${listaZonificado.value.length} zonas con ingreso total de $${formatCurrency(totalZonificado.value)}`, 'success')
  } catch (error) {
    handleError(error)
  } finally {
    cargando.value = false
  }
}

// Exportar Excel - Padrón
function exportarPadron() {
  const datos = localesPadron.value.map((loc, idx) => ({
    '#': idx + 1,
    'Categoría': loc.categoria,
    'Sección': loc.seccion,
    'Local': loc.local,
    'Letra': loc.letra_local,
    'Bloque': loc.bloque,
    'Nombre': loc.nombre,
    'Superficie': loc.superficie,
    'Renta': loc.renta,
    'Vigencia': loc.vigencia
  }))

  const ws = XLSX.utils.json_to_sheet(datos)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Padrón')
  XLSX.writeFile(wb, `Padron_Locales_${padron.value.mercado}.xlsx`)
  showToast('Excel generado correctamente', 'success')
}

// Exportar Excel - Movimientos
function exportarMovimientos() {
  const datos = listaMovimientos.value.map((mov, idx) => ({
    '#': idx + 1,
    'Fecha': formatFecha(mov.fecha),
    'Mercado': mov.num_mercado,
    'Categoría': mov.categoria,
    'Sección': mov.seccion,
    'Local': mov.local,
    'Nombre': mov.nombre,
    'Tipo Movimiento': mov.tipo_descripcion
  }))

  const ws = XLSX.utils.json_to_sheet(datos)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Movimientos')
  XLSX.writeFile(wb, `Movimientos_Locales.xlsx`)
  showToast('Excel generado correctamente', 'success')
}

// Exportar Excel - Pagos
function exportarPagos() {
  const datos = listaPagos.value.map((pag, idx) => ({
    '#': idx + 1,
    'Fecha': formatFecha(pag.fecha_pago),
    'Mercado': pag.num_mercado,
    'Local': `${pag.categoria}-${pag.seccion}-${pag.local}`,
    'Nombre': pag.nombre,
    'Año': pag.axo,
    'Periodo': pag.periodo,
    'Importe': pag.importe_pago,
    'Folio': pag.folio
  }))

  const ws = XLSX.utils.json_to_sheet(datos)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Pagos')
  XLSX.writeFile(wb, `Pagos_Locales.xlsx`)
  showToast('Excel generado correctamente', 'success')
}

// Exportar Excel - Zonificado
function exportarZonificado() {
  const datos = listaZonificado.value.map((zon, idx) => ({
    '#': idx + 1,
    'ID Zona': zon.id_zona,
    'Zona': zon.zona,
    'Ingreso': zon.pagado
  }))

  const ws = XLSX.utils.json_to_sheet(datos)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Zonificado')
  XLSX.writeFile(wb, `Ingreso_Zonificado.xlsx`)
  showToast('Excel generado correctamente', 'success')
}

// Mostrar ayuda
function mostrarAyuda() {
  Swal.fire({
    title: 'Ayuda - Listados de Locales',
    html: `
      <div class="help-content" style="text-align: left;">
        <h3>Descripción</h3>
        <p>Este módulo proporciona diversos listados y reportes sobre locales comerciales en mercados.</p>

        <h3>Listados Disponibles</h3>
        <ul>
          <li><strong>Padrón:</strong> Listado completo de locales con cálculo de renta mensual</li>
          <li><strong>Movimientos:</strong> Histórico de altas, bajas y modificaciones</li>
          <li><strong>Pagos:</strong> Detalle de pagos realizados en un periodo</li>
          <li><strong>Ingreso Zonificado:</strong> Ingreso agrupado por zonas geográficas</li>
        </ul>

        <h3>Funcionalidades</h3>
        <ul>
          <li>Consulta con filtros específicos para cada listado</li>
          <li>Exportación a Excel de todos los listados</li>
          <li>Totales y estadísticas consolidadas</li>
          <li>Formato profesional para impresión</li>
        </ul>
      </div>
    `,
    icon: 'info',
    width: 700,
    confirmButtonText: 'Entendido'
  })
}
</script>



<template>
  <div class="module-view">
    <!-- Header del módulo -->
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="store-alt" />
      </div>
      <div class="module-view-info">
        <h1>Mantenimiento de Locales</h1>
        <p>Mercados - Alta, modificación y baja de locales comerciales</p>
      </div>
      <button
        type="button"
        class="btn-help-icon"
        @click="mostrarAyuda = true"
        title="Ayuda"
      >
        <font-awesome-icon icon="question-circle" />
      </button>
      <div class="module-view-actions">
        <button
          class="btn-municipal-primary"
          @click="abrirModalNuevo"
          :disabled="cargando"
        >
          <font-awesome-icon icon="plus" />
          Nuevo Local
        </button>
      </div>
        </div>

    <div class="module-view-content">
      <!-- Filtros de búsqueda -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h5><font-awesome-icon icon="filter" /> Filtros de Búsqueda</h5>
        </div>
        <div class="municipal-card-body">
          <div class="form-row">
            <div class="form-group">
              <label class="municipal-form-label">Recaudadora</label>
              <select
                class="municipal-form-control"
                v-model="filtrosBusqueda.oficina"
                @change="cargarMercadosPorOficina"
              >
                <option value="">Todas</option>
                <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                  {{ rec.oficina }} - {{ rec.nombre_oficina }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Mercado</label>
              <select class="municipal-form-control" v-model="filtrosBusqueda.num_mercado">
                <option value="">Todos</option>
                <option v-for="merc in mercadosFiltro" :key="merc.num_mercado" :value="merc.num_mercado">
                  {{ merc.num_mercado }} - {{ merc.descripcion }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Sección</label>
              <select class="municipal-form-control" v-model="filtrosBusqueda.seccion">
                <option value="">Todas</option>
                <option v-for="sec in secciones" :key="sec.seccion" :value="sec.seccion">
                  {{ sec.seccion }} - {{ sec.descripcion }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Zona</label>
              <select class="municipal-form-control" v-model="filtrosBusqueda.zona">
                <option value="">Todas</option>
                <option v-for="zona in zonas" :key="zona.zona" :value="zona.zona">
                  Zona {{ zona.zona }} - {{ zona.descripcion }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Nombre Comerciante</label>
              <input
                type="text"
                class="municipal-form-control"
                v-model="filtrosBusqueda.nombre"
                placeholder="Buscar por nombre..."
                @keyup.enter="buscarLocales"
              />
            </div>
            <div class="form-group">
              <label class="municipal-form-label">Estado</label>
              <select class="municipal-form-control" v-model="filtrosBusqueda.vigencia">
                <option value="">Todos</option>
                <option value="A">Activos</option>
                <option value="I">Inactivos</option>
              </select>
            </div>
          </div>
          <div class="button-group">
            <button class="btn-municipal-primary" @click="buscarLocales" :disabled="cargando">
              <font-awesome-icon :icon="cargando ? 'spinner' : 'search'" :spin="cargando" />
              Buscar
            </button>
            <button class="btn-municipal-secondary" @click="limpiarFiltros">
              <font-awesome-icon icon="eraser" />
              Limpiar
            </button>
          </div>
        </div>
      </div>

      <!-- Tabla de resultados -->
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h5>
            <font-awesome-icon icon="list" />
            Locales Registrados
            <span class="badge bg-primary" v-if="locales.length > 0">{{ locales.length }} registros</span>
          </h5>
        </div>

        <div class="municipal-card-body" v-if="!cargando">
          <div v-if="locales.length === 0" class="empty-state">
            <div class="empty-state-icon">
              <font-awesome-icon icon="inbox" />
            </div>
            <h4>No hay locales registrados</h4>
            <p>Utilice los filtros para buscar locales o haga clic en "Nuevo Local" para registrar uno.</p>
          </div>

          <div v-else class="municipal-table">
            <table class="municipal-table">
              <thead>
                <tr>
                  <th>Oficina</th>
                  <th>Mercado</th>
                  <th>Cat.</th>
                  <th>Secc.</th>
                  <th>Local</th>
                  <th>Comerciante</th>
                  <th>Superficie</th>
                  <th>Giro</th>
                  <th>Zona</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="local in locales" :key="local.id_local" class="row-hover">
                  <td>{{ local.oficina }}</td>
                  <td>
                    <strong>{{ local.num_mercado }}</strong><br>
                    <small class="text-muted">{{ local.nombre_mercado }}</small>
                  </td>
                  <td class="text-center">
                    <span class="badge-secondary">{{ local.categoria }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge-info">{{ local.seccion }}</span>
                  </td>
                  <td class="text-center">
                    <strong>{{ local.num_local }}</strong>
                    {{ local.letra_local }}
                    {{ local.bloque }}
                  </td>
                  <td>{{ local.nombre_comerciante }}</td>
                  <td class="text-end">{{ formatNumber(local.superficie) }} m²</td>
                  <td>{{ local.giro }}</td>
                  <td class="text-center">{{ local.zona || '-' }}</td>
                  <td>
                    <span class="badge" :class="local.vigencia === 'A' ? 'bg-success' : 'bg-danger'">
                      {{ local.vigencia === 'A' ? 'Activo' : 'Inactivo' }}
                    </span>
                  </td>
                  <td>
                    <div class="button-group gap-1">
                      <button
                        class="btn-action btn-primary"
                        @click="abrirModalEditar(local)"
                        title="Editar"
                      >
                        <font-awesome-icon icon="edit" />
                      </button>
                      <button
                        class="btn btn-sm"
                        :class="local.vigencia === 'A' ? 'btn-danger' : 'btn-success'"
                        @click="cambiarVigencia(local)"
                        :title="local.vigencia === 'A' ? 'Dar de baja' : 'Activar'"
                      >
                        <font-awesome-icon :icon="local.vigencia === 'A' ? 'ban' : 'check'" />
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div v-if="cargando" class="municipal-card-body text-center py-5">
          <div class="spinner-border text-primary"></div>
          <p class="mt-3">Cargando locales...</p>
        </div>
      </div>
    </div>

    <!-- Modal Crear/Editar Local -->
    <Modal
      :show="mostrarModalLocal"
      @close="cerrarModalLocal"
      :title="modoEdicion ? 'Editar Local' : 'Nuevo Local'"
      size="large"
    >
      <form @submit.prevent="guardarLocal">
        <div class="row">
          <!-- Columna Izquierda -->
          <div class="col-md-6">
            <h6 class="text-primary mb-3"><font-awesome-icon icon="map-marker-alt" /> Ubicación del Local</h6>

            <div class="form-group">
              <label class="municipal-form-label required">Recaudadora/Oficina</label>
              <select
                class="municipal-form-control"
                v-model="formLocal.oficina"
                :disabled="modoEdicion"
                required
                @change="cargarMercadosFormulario"
              >
                <option value="">Seleccione...</option>
                <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                  {{ rec.oficina }} - {{ rec.nombre_oficina }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label class="municipal-form-label required">Mercado</label>
              <select
                class="municipal-form-control"
                v-model="formLocal.num_mercado"
                :disabled="modoEdicion || !formLocal.oficina"
                required
                @change="cargarCategoriasFormulario"
              >
                <option value="">Seleccione...</option>
                <option v-for="merc in mercadosForm" :key="merc.num_mercado" :value="merc.num_mercado">
                  {{ merc.num_mercado }} - {{ merc.descripcion }}
                </option>
              </select>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label class="municipal-form-label required">Categoría</label>
                  <input
                    type="number"
                    class="municipal-form-control"
                    v-model.number="formLocal.categoria"
                    :disabled="modoEdicion"
                    required
                  />
                </div>
        </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="municipal-form-label required">Sección</label>
                  <select
                    class="municipal-form-control"
                    v-model="formLocal.seccion"
                    :disabled="modoEdicion"
                    required
                    @change="cargarCuotasFormulario"
                  >
                    <option value="">Sel...</option>
                    <option v-for="sec in secciones" :key="sec.seccion" :value="sec.seccion">
                      {{ sec.seccion }}
                    </option>
                  </select>
                </div>
        </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label class="municipal-form-label required">Local</label>
                  <input
                    type="number"
                    class="municipal-form-control"
                    v-model.number="formLocal.local"
                    :disabled="modoEdicion"
                    required
                  />
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="municipal-form-label">Letra</label>
                  <input
                    type="text"
                    class="municipal-form-control"
                    v-model="formLocal.letra_local"
                    :disabled="modoEdicion"
                    maxlength="1"
                  />
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="municipal-form-label">Bloque</label>
                  <input
                    type="text"
                    class="municipal-form-control"
                    v-model="formLocal.bloque"
                    :disabled="modoEdicion"
                    maxlength="1"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Columna Derecha -->
          <div class="col-md-6">
            <h6 class="text-primary mb-3"><font-awesome-icon icon="user" /> Datos del Comerciante</h6>

            <div class="form-group">
              <label class="municipal-form-label required">Nombre del Comerciante</label>
              <input
                type="text"
                class="municipal-form-control"
                v-model="formLocal.nombre"
                required
                maxlength="30"
              />
            </div>

            <div class="form-group">
              <label class="municipal-form-label">Arrendatario</label>
              <input
                type="text"
                class="municipal-form-control"
                v-model="formLocal.arrendatario"
                maxlength="30"
              />
            </div>

            <div class="form-group">
              <label class="municipal-form-label">Domicilio</label>
              <input
                type="text"
                class="municipal-form-control"
                v-model="formLocal.domicilio"
                maxlength="100"
              />
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="municipal-form-label required">Sector</label>
                  <input
                    type="text"
                    class="municipal-form-control"
                    v-model="formLocal.sector"
                    required
                    maxlength="2"
                  />
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="municipal-form-label">Zona</label>
                  <select class="municipal-form-control" v-model="formLocal.zona">
                    <option :value="null">Ninguna</option>
                    <option v-for="zona in zonas" :key="zona.zona" :value="zona.zona">
                      {{ zona.zona }} - {{ zona.descripcion }}
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <div class="row">
          <div class="col-md-12">
            <h6 class="text-primary mb-3"><font-awesome-icon icon="store" /> Características del Local</h6>
          </div>

          <div class="col-md-6">
            <div class="form-group">
              <label class="municipal-form-label">Descripción del Local</label>
              <textarea
                class="municipal-form-control"
                v-model="formLocal.descripcion_local"
                rows="2"
                maxlength="100"
              ></textarea>
            </div>
        </div>

          <div class="col-md-6">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="municipal-form-label required">Superficie (m²)</label>
                  <input
                    type="number"
                    step="0.01"
                    class="municipal-form-control"
                    v-model.number="formLocal.superficie"
                    required
                  />
                </div>
        </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label class="municipal-form-label required">Giro</label>
                  <select class="municipal-form-control" v-model="formLocal.giro" required>
                    <option value="">Seleccione...</option>
                    <option v-for="giro in giros" :key="giro.id_giro" :value="giro.id_giro">
                      {{ giro.descripcion }}
                    </option>
                  </select>
                </div>
        </div>
            </div>

            <div class="form-group">
              <label class="municipal-form-label required">Clave de Cuota</label>
              <select class="municipal-form-control" v-model="formLocal.clave_cuota" required>
                <option value="">Seleccione...</option>
                <option v-for="cuota in cuotasForm" :key="cuota.clave_cuota" :value="cuota.clave_cuota">
                  {{ cuota.clave_cuota }} - {{ cuota.descripcion }} (${formatCurrency(cuota.importe_cuota)})
                </option>
              </select>
            </div>
          </div>
        </div>

        <div class="row" v-if="modoEdicion">
          <div class="col-md-6">
            <div class="form-group">
              <label class="municipal-form-label">Fecha Alta</label>
              <input type="date" class="municipal-form-control" v-model="formLocal.fecha_alta" disabled />
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="municipal-form-label">Fecha Baja</label>
              <input
                type="date"
                class="municipal-form-control"
                v-model="formLocal.fecha_baja"
                :disabled="formLocal.vigencia === 'A'"
              />
            </div>
          </div>
        </div>
      </form>

      <template #footer>
        <button type="button" class="btn-municipal-secondary" @click="cerrarModalLocal">
          <font-awesome-icon icon="times" />
          Cancelar
        </button>
        <button
          type="button"
          class="btn-municipal-primary"
          @click="guardarLocal"
          :disabled="guardando"
        >
          <font-awesome-icon :icon="guardando ? 'spinner' : 'save'" :spin="guardando" />
          {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
        </button>
      </template>
    </Modal>

    <!-- Modal de Ayuda -->
    <DocumentationModal
      v-if="mostrarAyuda"
      :show="mostrarAyuda"
      @close="mostrarAyuda = false"
      title="Ayuda - Mantenimiento de Locales"
    >
      <h6>Descripción</h6>
      <p>
        Este módulo permite realizar el alta, modificación y baja de locales comerciales en los mercados municipales.
      </p>

      <h6>Funciones Disponibles</h6>
      <ul>
        <li><strong>Nuevo Local:</strong> Registra un nuevo local con todos sus datos</li>
        <li><strong>Editar:</strong> Modifica la información de un local existente</li>
        <li><strong>Dar de Baja/Activar:</strong> Cambia el estado de vigencia del local</li>
        <li><strong>Buscar:</strong> Localiza locales usando múltiples filtros</li>
      </ul>

      <h6>Campos Obligatorios</h6>
      <ul>
        <li>Recaudadora/Oficina</li>
        <li>Mercado y Categoría</li>
        <li>Sección y Número de Local</li>
        <li>Nombre del Comerciante</li>
        <li>Sector</li>
        <li>Superficie</li>
        <li>Giro Comercial</li>
        <li>Clave de Cuota</li>
      </ul>

      <h6>Validaciones</h6>
      <p>El sistema valida que no existan locales duplicados con la misma ubicación (Oficina, Mercado, Categoría, Sección, Local, Letra, Bloque).</p>

      <h6>Notas Importantes</h6>
      <ul>
        <li>Los campos de ubicación (Oficina, Mercado, Categoría, Sección, Local) no pueden modificarse una vez creado el registro</li>
        <li>La superficie se expresa en metros cuadrados</li>
        <li>La clave de cuota determina el cálculo de renta mensual</li>
        <li>Un local inactivo no genera adeudos pero mantiene su historial</li>
      </ul>
    </DocumentationModal>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import Swal from 'sweetalert2'
import Modal from '@/components/common/Modal.vue'
import DocumentationModal from '@/components/common/DocumentationModal.vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from '@/composables/useToast'

const { execute } = useApi()
const { handleError } = useLicenciasErrorHandler()
const { showToast } = useToast()

// Estado
const cargando = ref(false)
const guardando = ref(false)
const mostrarAyuda = ref(false)
const mostrarModalLocal = ref(false)
const modoEdicion = ref(false)

// Datos
const locales = ref([])
const recaudadoras = ref([])
const secciones = ref([])
const zonas = ref([])
const giros = ref([])
const mercadosFiltro = ref([])
const mercadosForm = ref([])
const cuotasForm = ref([])

// Filtros de búsqueda
const filtrosBusqueda = ref({
  oficina: '',
  num_mercado: '',
  categoria: null,
  seccion: '',
  local: null,
  zona: null,
  clave_cuota: null,
  nombre: '',
  vigencia: 'A'
})

// Formulario de local
const formLocal = ref({
  id_local: null,
  oficina: '',
  num_mercado: '',
  categoria: null,
  seccion: '',
  local: null,
  letra_local: '',
  bloque: '',
  nombre: '',
  arrendatario: '',
  domicilio: '',
  sector: '',
  zona: null,
  descripcion_local: '',
  superficie: null,
  giro: '',
  clave_cuota: '',
  fecha_alta: new Date().toISOString().split('T')[0],
  fecha_baja: null,
  vigencia: 'A'
})

// Métodos - Cargar datos iniciales
const cargarDatosIniciales = async () => {
  try {
    const [recsResp, secsResp, zonasResp, girosResp] = await Promise.all([
      execute('SP_MERCADOS_RECAUDADORAS_LIST', 'mercados', {}),
      execute('SP_MERCADOS_SECCIONES_LIST', 'mercados', {}),
      execute('SP_MERCADOS_ZONAS_LIST', 'mercados', {}),
      execute('SP_MERCADOS_GIROS_LIST', 'mercados', {})
    ])

    recaudadoras.value = recsResp || []
    secciones.value = secsResp || []
    zonas.value = zonasResp || []
    giros.value = girosResp || []
  } catch (error) {
    handleError(error, 'Error al cargar datos iniciales')
  }
}

const cargarMercadosPorOficina = async () => {
  if (!filtrosBusqueda.value.oficina) {
    mercadosFiltro.value = []
    return
  }

  try {
    const response = await execute('SP_MERCADOS_MERCADOS_LIST', 'mercados', {
      p_oficina: parseInt(filtrosBusqueda.value.oficina)
    })
    mercadosFiltro.value = response || []
  } catch (error) {
    handleError(error, 'Error al cargar mercados')
  }
}

const cargarMercadosFormulario = async () => {
  if (!formLocal.value.oficina) {
    mercadosForm.value = []
    return
  }

  try {
    const response = await execute('SP_MERCADOS_MERCADOS_LIST', 'mercados', {
      p_oficina: parseInt(formLocal.value.oficina)
    })
    mercadosForm.value = response || []
  } catch (error) {
    handleError(error, 'Error al cargar mercados')
  }
}

const cargarCategoriasFormulario = async () => {
  // Aquí se pueden cargar categorías específicas si es necesario
}

const cargarCuotasFormulario = async () => {
  if (!formLocal.value.categoria || !formLocal.value.seccion) {
    cuotasForm.value = []
    return
  }

  try {
    const anioActual = new Date().getFullYear()
    const response = await execute('SP_MERCADOS_CUOTAS_LIST', 'mercados', {
      p_anio: anioActual,
      p_categoria: parseInt(formLocal.value.categoria),
      p_seccion: formLocal.value.seccion
    })
    cuotasForm.value = response || []
  } catch (error) {
    handleError(error, 'Error al cargar cuotas')
  }
}

// Métodos - Búsqueda
const buscarLocales = async () => {
  cargando.value = true

  try {
    const response = await execute('SP_MERCADOS_LOCAL_BUSCAR', 'mercados', {
      p_oficina: filtrosBusqueda.value.oficina || null,
      p_num_mercado: filtrosBusqueda.value.num_mercado || null,
      p_categoria: filtrosBusqueda.value.categoria,
      p_seccion: filtrosBusqueda.value.seccion || null,
      p_local: filtrosBusqueda.value.local,
      p_zona: filtrosBusqueda.value.zona,
      p_clave_cuota: filtrosBusqueda.value.clave_cuota,
      p_nombre: filtrosBusqueda.value.nombre || null,
      p_vigencia: filtrosBusqueda.value.vigencia || null
    })

    locales.value = response || []
    showToast(`${locales.value.length} local(es) encontrado(s)`, 'success')
  } catch (error) {
    handleError(error, 'Error al buscar locales')
  } finally {
    cargando.value = false
  }
}

const limpiarFiltros = () => {
  filtrosBusqueda.value = {
    oficina: '',
    num_mercado: '',
    categoria: null,
    seccion: '',
    local: null,
    zona: null,
    clave_cuota: null,
    nombre: '',
    vigencia: 'A'
  }
  locales.value = []
  mercadosFiltro.value = []
}

// Métodos - Modal
const abrirModalNuevo = () => {
  modoEdicion.value = false
  formLocal.value = {
    id_local: null,
    oficina: '',
    num_mercado: '',
    categoria: null,
    seccion: '',
    local: null,
    letra_local: '',
    bloque: '',
    nombre: '',
    arrendatario: '',
    domicilio: '',
    sector: '',
    zona: null,
    descripcion_local: '',
    superficie: null,
    giro: '',
    clave_cuota: '',
    fecha_alta: new Date().toISOString().split('T')[0],
    fecha_baja: null,
    vigencia: 'A'
  }
  mercadosForm.value = []
  cuotasForm.value = []
  mostrarModalLocal.value = true
}

const abrirModalEditar = (local) => {
  modoEdicion.value = true
  formLocal.value = {
    id_local: local.id_local,
    oficina: local.oficina,
    num_mercado: local.num_mercado,
    categoria: local.categoria,
    seccion: local.seccion,
    local: local.num_local,
    letra_local: local.letra_local || '',
    bloque: local.bloque || '',
    nombre: local.nombre_comerciante,
    arrendatario: local.arrendatario || '',
    domicilio: local.domicilio || '',
    sector: local.sector || '',
    zona: local.zona,
    descripcion_local: local.descripcion_local || '',
    superficie: local.superficie,
    giro: local.giro,
    clave_cuota: local.clave_cuota,
    fecha_alta: local.fecha_alta,
    fecha_baja: local.fecha_baja,
    vigencia: local.vigencia
  }
  cargarMercadosFormulario()
  cargarCuotasFormulario()
  mostrarModalLocal.value = true
}

const cerrarModalLocal = () => {
  mostrarModalLocal.value = false
  formLocal.value = {}
}

// Métodos - Guardar
const guardarLocal = async () => {
  // Validar campos requeridos
  if (!formLocal.value.nombre) {
    showToast('El nombre del comerciante es requerido', 'warning')
    return
  }

  if (!formLocal.value.giro) {
    showToast('El giro es requerido', 'warning')
    return
  }

  if (!formLocal.value.sector) {
    showToast('El sector es requerido', 'warning')
    return
  }

  if (!formLocal.value.superficie || formLocal.value.superficie <= 0) {
    showToast('La superficie debe ser mayor a 0', 'warning')
    return
  }

  if (!formLocal.value.clave_cuota) {
    showToast('La clave de cuota es requerida', 'warning')
    return
  }

  guardando.value = true

  try {
    if (modoEdicion.value) {
      // Actualizar
      await execute('SP_MERCADOS_LOCAL_ACTUALIZAR', 'mercados', {
        p_id_local: formLocal.value.id_local,
        p_nombre: formLocal.value.nombre,
        p_arrendatario: formLocal.value.arrendatario || null,
        p_domicilio: formLocal.value.domicilio || null,
        p_sector: formLocal.value.sector,
        p_zona: formLocal.value.zona,
        p_descripcion_local: formLocal.value.descripcion_local || null,
        p_superficie: formLocal.value.superficie,
        p_giro: formLocal.value.giro,
        p_clave_cuota: formLocal.value.clave_cuota,
        p_fecha_baja: formLocal.value.fecha_baja || null,
        p_vigencia: formLocal.value.vigencia,
        p_id_usuario: 1 // TODO: Obtener del usuario actual
      })

      showToast('Local actualizado correctamente', 'success')
    } else {
      // Validar duplicado
      const duplicado = await execute('SP_MERCADOS_LOCAL_VALIDAR_DUPLICADO', 'mercados', {
        p_oficina: formLocal.value.oficina,
        p_num_mercado: formLocal.value.num_mercado,
        p_categoria: formLocal.value.categoria,
        p_seccion: formLocal.value.seccion,
        p_local: formLocal.value.local,
        p_letra_local: formLocal.value.letra_local || null,
        p_bloque: formLocal.value.bloque || null,
        p_id_local: null
      })

      if (duplicado && duplicado[0]?.existe > 0) {
        showToast('Ya existe un local con la misma ubicación', 'error')
        guardando.value = false
        return
      }

      // Insertar
      await execute('SP_MERCADOS_LOCAL_INSERTAR', 'mercados', {
        p_oficina: formLocal.value.oficina,
        p_num_mercado: formLocal.value.num_mercado,
        p_categoria: formLocal.value.categoria,
        p_seccion: formLocal.value.seccion,
        p_local: formLocal.value.local,
        p_letra_local: formLocal.value.letra_local || null,
        p_bloque: formLocal.value.bloque || null,
        p_nombre: formLocal.value.nombre,
        p_arrendatario: formLocal.value.arrendatario || null,
        p_domicilio: formLocal.value.domicilio || null,
        p_sector: formLocal.value.sector,
        p_zona: formLocal.value.zona,
        p_descripcion_local: formLocal.value.descripcion_local || null,
        p_superficie: formLocal.value.superficie,
        p_giro: formLocal.value.giro,
        p_clave_cuota: formLocal.value.clave_cuota,
        p_fecha_alta: formLocal.value.fecha_alta,
        p_vigencia: formLocal.value.vigencia,
        p_id_usuario: 1 // TODO: Obtener del usuario actual
      })

      showToast('Local registrado correctamente', 'success')
    }

    cerrarModalLocal()
    buscarLocales()
  } catch (error) {
    handleError(error, modoEdicion.value ? 'Error al actualizar local' : 'Error al registrar local')
  } finally {
    guardando.value = false
  }
}

// Métodos - Cambiar vigencia
const cambiarVigencia = async (local) => {
  const accion = local.vigencia === 'A' ? 'dar de baja' : 'activar'

  const result = await Swal.fire({
    title: `¿${accion} este local?`,
    text: local.vigencia === 'A'
      ? 'El local dejará de estar activo y no generará nuevos adeudos.'
      : 'El local se reactivará y comenzará a generar adeudos.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: local.vigencia === 'A' ? '#dc3545' : '#28a745',
    cancelButtonColor: '#6c757d',
    confirmButtonText: `Sí, ${accion}`,
    cancelButtonText: 'Cancelar'
  })

  if (result.isConfirmed) {
    try {
      const nuevaVigencia = local.vigencia === 'A' ? 'I' : 'A'
      const fechaBaja = nuevaVigencia === 'I' ? new Date().toISOString().split('T')[0] : null

      await execute('SP_MERCADOS_LOCAL_CAMBIAR_VIGENCIA', 'mercados', {
        p_id_local: local.id_local,
        p_vigencia: nuevaVigencia,
        p_fecha_baja: fechaBaja,
        p_id_usuario: 1 // TODO: Obtener del usuario actual
      })

      showToast(`Local ${accion === 'dar de baja' ? 'dado de baja' : 'activado'} correctamente`, 'success')
      buscarLocales()
    } catch (error) {
      handleError(error, `Error al ${accion} el local`)
    }
  }
}

// Métodos - Formato
const formatCurrency = (value) => {
  return new Intl.NumberFormat('es-MX', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value || 0)
}

const formatNumber = (value) => {
  return new Intl.NumberFormat('es-MX', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value || 0)
}

// Lifecycle
onMounted(async () => {
  await cargarDatosIniciales()
})
</script>


<template>
  <div class="module-view">
    <!-- HEADER -->
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="bolt" />
      </div>
      <div class="module-view-info">
        <h1>Padr�n de Energ�a El�ctrica</h1>
        <p>Mercados - Consulta de locales con servicio de energ�a</p>
      </div>
      <button class="btn-help-icon" @click="mostrarAyuda" type="button">
        <font-awesome-icon icon="question-circle" /> Ayuda
      </button>
    </div>

    <!-- FILTROS -->
    <div class="municipal-card">
      <div class="municipal-card-header"><h5>
        <font-awesome-icon icon="filter" /> Par�metros de B�squeda
      </h5></div>
      <div class="municipal-card-body">
        <form @submit.prevent="buscarPadron" >
        <div class="form-row">
          <div class="form-group">
            <label for="recaudadora" class="municipal-form-label required">Recaudadora:</label>
            <select
              v-model.number="filtros.recaudadora"
              id="recaudadora"
              class="municipal-form-control"
              required
              :disabled="cargando"
              @change="onRecaudadoraChange"
            >
              <option value="">Seleccione...</option>
              <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                {{ rec.oficina }} - {{ rec.recaudadora }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="mercado" class="municipal-form-label required">Mercado:</label>
            <select
              v-model.number="filtros.mercado"
              id="mercado"
              class="municipal-form-control"
              required
              :disabled="cargando || !filtros.recaudadora"
            >
              <option value="">Seleccione...</option>
              <option v-for="merc in mercados" :key="merc.num_mercado_nvo" :value="merc.num_mercado_nvo">
                {{ merc.num_mercado_nvo }} - {{ merc.descripcion }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <button type="submit" class="btn-municipal-primary" :disabled="cargando">
            <font-awesome-icon icon="search" /> Buscar Padr�n
          </button>

          <button
            type="button"
            class="btn-municipal-success"
            @click="exportarExcel"
            :disabled="cargando || padron.length === 0"
          >
            <font-awesome-icon icon="file-excel" /> Exportar Excel
          </button>

          <button
            type="button"
            class="btn-municipal-secondary"
            @click="imprimirReporte"
            :disabled="cargando || padron.length === 0"
          >
            <font-awesome-icon icon="print" /> Imprimir
          </button>
        </div>
      </form>
      </div>
      </div>
    </div>

    <!-- ESTAD�STICAS -->
    <div v-if="padron.length > 0" class="municipal-card">
      <div class="stats-dashboard">
        <div class="stat-item stat-primary">
          <div class="stat-value">{{ padron.length }}</div>
          <div class="stat-label">Total Locales</div>
          <div class="stat-sublabel">Con energ�a</div>
        </div>

        <div class="stat-item stat-success">
          <div class="stat-value">{{ localesVigentes }}</div>
          <div class="stat-label">Locales Vigentes</div>
          <div class="stat-sublabel">Activos</div>
        </div>

        <div class="stat-item stat-info">
          <div class="stat-value">{{ formatNumber(totalKilowatts) }}</div>
          <div class="stat-label">Total Kilowatts</div>
          <div class="stat-sublabel">Suma acumulada</div>
        </div>

        <div class="stat-item stat-warning">
          <div class="stat-value">{{ formatNumber(promedioKilowatts) }}</div>
          <div class="stat-label">Promedio Kilowatts</div>
          <div class="stat-sublabel">Por local</div>
        </div>
        </div>
    </div>

    <!-- TABLA DE RESULTADOS -->
    <div v-if="padron.length > 0" class="municipal-card">
      <div class="municipal-card-header"><h5>
        <font-awesome-icon icon="table" /> Padr�n de Energ�a El�ctrica
      </h5></div>

      <div class="municipal-table">
        <table class="municipal-table">
          <thead>
            <tr>
              <th class="text-center">#</th>
              <th>Recaudadora</th>
              <th>Mercado</th>
              <th>Ubicaci�n</th>
              <th>Comerciante</th>
              <th>Locales Adicionales</th>
              <th>Consumo</th>
              <th class="text-end">Kilowatts/Cuota</th>
              <th class="text-center">Vigencia</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(item, index) in padron" :key="item.id_local">
              <td class="text-center">{{ index + 1 }}</td>
              <td>{{ item.oficina }}</td>
              <td>
                <small class="text-muted">Merc {{ item.num_mercado }}</small><br>
                <strong>{{ mercadoNombre }}</strong>
              </td>
              <td>
                <strong>{{ item.categoria }}-{{ item.seccion }}-{{ item.local }}</strong>
                {{ item.letra_local }} {{ item.bloque }}
              </td>
              <td>{{ item.nombre }}</td>
              <td>{{ item.local_adicional || '-' }}</td>
              <td class="text-center">
                <span class="badge" :class="getBadgeConsumo(item.cve_consumo)">
                  {{ getDescripcionConsumo(item.cve_consumo) }}
                </span>
              </td>
              <td class="text-end">
                <strong>{{ formatNumber(item.cantidad) }}</strong>
              </td>
              <td class="text-center">
                <span class="badge" :class="getBadgeVigencia(item.vigencia)">
                  {{ getDescripcionVigencia(item.vigencia) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SIN DATOS -->
    <div v-else-if="!cargando && consultaRealizada" class="municipal-card">
      <div class="alert alert-info">
        <font-awesome-icon icon="info-circle" />
        No se encontraron locales con energ�a para los criterios especificados.
      </div>
    </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from '@/composables/useToast'
import Swal from 'sweetalert2'
import * as XLSX from 'xlsx'

const { execute } = useApi()
const { handleError } = useLicenciasErrorHandler()
const { showToast } = useToast()

// Estado
const cargando = ref(false)
const consultaRealizada = ref(false)
const recaudadoras = ref([])
const mercados = ref([])
const padron = ref([])
const mercadoNombre = ref('')

// Filtros
const filtros = ref({
  recaudadora: '',
  mercado: ''
})

// Computed
const localesVigentes = computed(() => {
  return padron.value.filter(p => p.vigencia === 'V').length
})

const totalKilowatts = computed(() => {
  return padron.value.reduce((sum, item) => sum + (item.cantidad || 0), 0)
})

const promedioKilowatts = computed(() => {
  if (padron.value.length === 0) return 0
  return totalKilowatts.value / padron.value.length
})

// Funciones auxiliares
function formatNumber(valor) {
  if (!valor && valor !== 0) return '0.00'
  return parseFloat(valor).toLocaleString('es-MX', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  })
}

function getDescripcionConsumo(cve) {
  const consumos = {
    'K': 'Kilowatts',
    'C': 'Cuota Fija',
    'M': 'Mixto'
  }
  return consumos[cve] || cve || 'N/A'
}

function getBadgeConsumo(cve) {
  const badges = {
    'K': 'badge-primary',
    'C': 'badge-success',
    'M': 'badge-warning'
  }
  return badges[cve] || 'badge-secondary'
}

function getDescripcionVigencia(vigencia) {
  return vigencia === 'V' ? 'Vigente' : 'Baja'
}

function getBadgeVigencia(vigencia) {
  return vigencia === 'V' ? 'badge-success' : 'badge-danger'
}

// Cargar recaudadoras al montar
onMounted(async () => {
  try {
    cargando.value = true
    const response = await execute('SP_MERCADOS_RECAUDADORAS_LIST', 'mercados', {})
    recaudadoras.value = response || []

    if (recaudadoras.value.length > 0) {
      filtros.value.recaudadora = recaudadoras.value[0].oficina
      await onRecaudadoraChange()
    }
  } catch (error) {
    handleError(error)
  } finally {
    cargando.value = false
  }
})

// Cambio de recaudadora
async function onRecaudadoraChange() {
  filtros.value.mercado = ''
  mercados.value = []

  if (!filtros.value.recaudadora) return

  try {
    cargando.value = true
    const response = await execute('SP_MERCADOS_MERCADOS_BY_RECAUDADORA', 'mercados', {
      p_id_rec: filtros.value.recaudadora
    })
    mercados.value = response || []

    if (mercados.value.length > 0) {
      filtros.value.mercado = mercados.value[0].num_mercado_nvo
    }
  } catch (error) {
    handleError(error)
  } finally {
    cargando.value = false
  }
}

// Buscar padr�n
async function buscarPadron() {
  try {
    cargando.value = true
    consultaRealizada.value = true

    const response = await execute('SP_MERCADOS_PADRON_ENERGIA', 'mercados', {
      p_id_rec: filtros.value.recaudadora,
      p_num_mercado_nvo: filtros.value.mercado
    })

    padron.value = response || []

    if (padron.value.length > 0) {
      mercadoNombre.value = padron.value[0].descripcion
      showToast(`Se encontraron ${padron.value.length} locales con energ�a`, 'success')
    } else {
      showToast('No se encontraron locales con energ�a para los criterios especificados', 'info')
    }

  } catch (error) {
    handleError(error)
    padron.value = []
  } finally {
    cargando.value = false
  }
}

// Exportar a Excel
function exportarExcel() {
  try {
    const datos = padron.value.map((item, idx) => ({
      '#': idx + 1,
      'Recaudadora': item.oficina,
      'Mercado': item.num_mercado,
      'Nombre Mercado': mercadoNombre.value,
      'Categor�a': item.categoria,
      'Secci�n': item.seccion,
      'Local': item.local,
      'Letra': item.letra_local,
      'Bloque': item.bloque,
      'Comerciante': item.nombre,
      'Locales Adicionales': item.local_adicional,
      'Consumo': getDescripcionConsumo(item.cve_consumo),
      'Kilowatts/Cuota': item.cantidad,
      'Vigencia': getDescripcionVigencia(item.vigencia)
    }))

    const ws = XLSX.utils.json_to_sheet(datos)
    const wb = XLSX.utils.book_new()
    XLSX.utils.book_append_sheet(wb, ws, 'Padr�n Energ�a')

    const recaudadoraNombre = recaudadoras.value.find(r => r.oficina === filtros.value.recaudadora)?.recaudadora || 'Recaudadora'
    const nombreArchivo = `Padron_Energia_${recaudadoraNombre}_Merc${filtros.value.mercado}.xlsx`

    XLSX.writeFile(wb, nombreArchivo)
    showToast('Archivo Excel generado correctamente', 'success')
  } catch (error) {
    handleError(error)
  }
}

// Imprimir reporte
function imprimirReporte() {
  window.print()
}

// Mostrar ayuda
function mostrarAyuda() {
  Swal.fire({
    title: 'Ayuda - Padr�n de Energ�a El�ctrica',
    html: `
      <div class="help-content" style="text-align: left;">
        <h3>Descripci�n</h3>
        <p>Este m�dulo permite consultar el padr�n de locales comerciales que cuentan con servicio de energ�a el�ctrica.</p>

        <h3>Par�metros</h3>
        <ul>
          <li><strong>Recaudadora:</strong> Oficina recaudadora responsable de los locales</li>
          <li><strong>Mercado:</strong> Mercado espec�fico a consultar (solo se muestran mercados con energ�a)</li>
        </ul>

        <h3>Informaci�n del Padr�n</h3>
        <ul>
          <li>Ubicaci�n completa del local (categor�a, secci�n, n�mero)</li>
          <li>Nombre del comerciante</li>
          <li>Locales adicionales asociados</li>
          <li>Tipo de consumo (Kilowatts, Cuota Fija o Mixto)</li>
          <li>Cantidad de kilowatts o cuota aplicable</li>
          <li>Estado de vigencia del local</li>
        </ul>

        <h3>Tipos de Consumo</h3>
        <ul>
          <li><strong>K (Kilowatts):</strong> Cobro basado en consumo de kilowatts</li>
          <li><strong>C (Cuota Fija):</strong> Cobro de cuota fija mensual</li>
          <li><strong>M (Mixto):</strong> Combinaci�n de kilowatts y cuota</li>
        </ul>

        <h3>Estad�sticas</h3>
        <ul>
          <li><strong>Total Locales:</strong> Cantidad total de locales con energ�a</li>
          <li><strong>Locales Vigentes:</strong> Locales activos en el mercado</li>
          <li><strong>Total Kilowatts:</strong> Suma de kilowatts de todos los locales</li>
          <li><strong>Promedio Kilowatts:</strong> Promedio de kilowatts por local</li>
        </ul>

        <h3>Funcionalidades</h3>
        <ul>
          <li><strong>Exportar Excel:</strong> Descarga el padr�n completo en formato Excel</li>
          <li><strong>Imprimir:</strong> Imprime el padr�n en formato profesional</li>
        </ul>
      </div>
    `,
    icon: 'info',
    width: 800,
    confirmButtonText: 'Entendido'
  })
}
</script>



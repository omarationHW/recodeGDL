<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon"><font-awesome-icon icon="bolt" /></div>
      <div class="module-view-info">
        <h1>Pagos de Energ�a - Consulta</h1>
        <p>Gesti�n de Pagos de Energ�a El�ctrica por Local</p>
      </div>
        </div>

    <div class="module-view-content">
      <div class="municipal-card">
        <div class="municipal-card-header"><h5><font-awesome-icon icon="search" /> B�squeda por ID Energ�a</h5></div>
        <div class="municipal-card-body">
          <div class="form-row">
            <div class="form-group"><label class="municipal-form-label">ID Energ�a *</label><input type="number" class="municipal-form-control" v-model.number="idEnergia" /></div>
        </div>
          <div class="button-group">
            <button class="btn-municipal-primary" @click="buscar" :disabled="loading"><font-awesome-icon :icon="loading ? 'spinner' : 'search'" :spin="loading" /> Consultar</button>
            <button class="btn-municipal-success" @click="openModal" :disabled="!idEnergia"><font-awesome-icon icon="plus" /> Nuevo Pago</button>
          </div>
        </div>
      </div>

      <div class="municipal-card" v-if="pagos.length > 0">
        <div class="municipal-card-header"><h5><font-awesome-icon icon="list" /> Pagos Registrados <span class="badge-info">{{ pagos.length }}</span></h5></div>
        <div class="municipal-card-body table-container">
          <div class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr><th>ID</th><th>A�o</th><th>Periodo</th><th>Fecha Pago</th><th>Oficina</th><th>Caja</th><th>Operaci�n</th><th class="text-end">Importe</th><th>Consumo</th><th class="text-end">Cantidad</th><th>Folio</th><th>Usuario</th><th>Acciones</th></tr>
              </thead>
              <tbody>
                <tr v-for="pago in pagos" :key="pago.id_pago_energia" class="row-hover">
                  <td><span class="badge-primary">{{ pago.id_pago_energia }}</span></td>
                  <td>{{ pago.axo }}</td>
                  <td>{{ pago.periodo }}</td>
                  <td>{{ formatDate(pago.fecha_pago) }}</td>
                  <td>{{ pago.oficina_pago }}</td>
                  <td>{{ pago.caja_pago }}</td>
                  <td>{{ pago.operacion_pago }}</td>
                  <td class="text-end"><strong class="text-success">{{ formatCurrency(pago.importe_pago) }}</strong></td>
                  <td>{{ pago.cve_consumo }}</td>
                  <td class="text-end">{{ pago.cantidad }}</td>
                  <td>{{ pago.folio }}</td>
                  <td><small>{{ pago.usuario }}</small></td>
                  <td>
                    <button class="btn-action-delete" @click="eliminar(pago.id_pago_energia)"><font-awesome-icon icon="trash" /></button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    <div v-if="showModal" class="modal-overlay" @click.self="closeModal">
      <div class="modal-content">
        <div class="modal-header"><h5>Nuevo Pago de Energ�a</h5><button class="btn-close" @click="closeModal"><font-awesome-icon icon="times" /></button></div>
        <div class="modal-body">
          <form @submit.prevent="save">
            <div class="form-row">
              <div class="form-group"><label class="municipal-form-label">A�o *</label><input type="number" class="municipal-form-control" v-model.number="form.axo" required /></div>
              <div class="form-group"><label class="municipal-form-label">Periodo *</label><input type="number" class="municipal-form-control" v-model.number="form.periodo" min="1" max="12" required /></div>
              <div class="form-group"><label class="municipal-form-label">Fecha Pago *</label><input type="date" class="municipal-form-control" v-model="form.fecha_pago" required /></div>
              <div class="form-group"><label class="municipal-form-label">Oficina *</label><input type="number" class="municipal-form-control" v-model.number="form.oficina_pago" required /></div>
              <div class="form-group"><label class="municipal-form-label">Caja *</label><input type="text" class="municipal-form-control" v-model="form.caja_pago" maxlength="1" required /></div>
              <div class="form-group"><label class="municipal-form-label">Operaci�n *</label><input type="number" class="municipal-form-control" v-model.number="form.operacion_pago" required /></div>
              <div class="form-group"><label class="municipal-form-label">Importe *</label><input type="number" step="0.01" class="municipal-form-control" v-model.number="form.importe_pago" required /></div>
              <div class="form-group"><label class="municipal-form-label">Consumo *</label><input type="text" class="municipal-form-control" v-model="form.cve_consumo" maxlength="1" required /></div>
              <div class="form-group"><label class="municipal-form-label">Cantidad *</label><input type="number" step="0.01" class="municipal-form-control" v-model.number="form.cantidad" required /></div>
              <div class="form-group"><label class="municipal-form-label">Folio</label><input type="text" class="municipal-form-control" v-model="form.folio" maxlength="18" /></div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn-municipal-primary" :disabled="saving"><font-awesome-icon :icon="saving ? 'spinner' : 'save'" :spin="saving" /> Guardar</button>
              <button type="button" class="btn-municipal-secondary" @click="closeModal">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'
import Swal from 'sweetalert2'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const loading = ref(false)
const saving = ref(false)
const showModal = ref(false)
const idEnergia = ref(null)
const pagos = ref([])
const form = ref({ axo: new Date().getFullYear(), periodo: new Date().getMonth() + 1, fecha_pago: '', oficina_pago: null, caja_pago: '', operacion_pago: null, importe_pago: 0, cve_consumo: '', cantidad: 0, folio: '' })

const formatCurrency = (value) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value || 0)
const formatDate = (date) => date ? new Date(date).toLocaleDateString('es-MX') : 'N/A'

const buscar = async () => {
  try {
    loading.value = true
    const result = await executeStoredProcedure('sp_get_pagos_energia', { p_id_energia: idEnergia.value })
    if (result.success) {
      pagos.value = result.data || []
      toast.success(`${pagos.value.length} pagos encontrados`)
    } else handleError(result)
  } catch (error) {
    handleError(error)
  } finally {
    loading.value = false
  }
}

const openModal = () => {
  form.value = { axo: new Date().getFullYear(), periodo: new Date().getMonth() + 1, fecha_pago: '', oficina_pago: null, caja_pago: '', operacion_pago: null, importe_pago: 0, cve_consumo: '', cantidad: 0, folio: '' }
  showModal.value = true
}

const closeModal = () => {
  showModal.value = false
}

const save = async () => {
  try {
    saving.value = true
    const result = await executeStoredProcedure('sp_add_pago_energia', {
      p_id_energia: idEnergia.value,
      p_axo: form.value.axo,
      p_periodo: form.value.periodo,
      p_fecha_pago: form.value.fecha_pago,
      p_oficina_pago: form.value.oficina_pago,
      p_caja_pago: form.value.caja_pago,
      p_operacion_pago: form.value.operacion_pago,
      p_importe_pago: form.value.importe_pago,
      p_cve_consumo: form.value.cve_consumo,
      p_cantidad: form.value.cantidad,
      p_folio: form.value.folio,
      p_id_usuario: 1
    })
    if (result.success) {
      toast.success('Pago agregado correctamente')
      closeModal()
      buscar()
    } else handleError(result)
  } catch (error) {
    handleError(error)
  } finally {
    saving.value = false
  }
}

const eliminar = async (id) => {
  const confirm = await Swal.fire({ title: '�Eliminar pago?', text: 'Esta acci�n no se puede deshacer', icon: 'warning', showCancelButton: true, confirmButtonText: 'Eliminar', cancelButtonText: 'Cancelar' })
  if (!confirm.isConfirmed) return
  try {
    const result = await executeStoredProcedure('sp_delete_pago_energia', { p_id_pago_energia: id, p_id_usuario: 1 })
    if (result.success) {
      toast.success('Pago eliminado')
      buscar()
    } else handleError(result)
  } catch (error) {
    handleError(error)
  }
}
</script>


<template>
    <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="dollar-sign" />
      </div>
      <div class="module-view-info">
        <h1>Consulta Individual de Pagos</h1>
        <p>M�dulo de Mercados</p>
      </div>
    </div>

    <div class="module-view-content">

    <div class="municipal-card">
      <div class="municipal-card-header">
        <i class="fas fa-file-invoice-dollar"></i> Consulta Individual de Pagos del Local
      </div>
      <div class="municipal-card-body">
        <form @submit.prevent="buscarPago" class="row g-3">
          <div class="form-group">
            <label class="municipal-form-label">ID Local *</label>
            <input
              type="number"
              v-model.number="form.id_local"
              class="municipal-form-control"
              required
            />
          </div>
          <div class="form-group">
            <label class="municipal-form-label">A�o *</label>
            <input
              type="number"
              v-model.number="form.axo"
              class="municipal-form-control"
              required
            />
          </div>
          <div class="form-group">
            <label class="municipal-form-label">Mes *</label>
            <input
              type="number"
              v-model.number="form.periodo"
              class="municipal-form-control"
              min="1"
              max="12"
              required
            />
          </div>
          <div class="form-group">
            <button type="submit" class="btn-municipal-primary w-100">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </form>
      </div>
        </div>

    <div v-if="loading" class="text-center p-4">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Cargando datos...</p>
    </div>

    <div v-else-if="pago">
      <div class="municipal-card">
        <div class="municipal-card-header bg-primary text-white">
          <i class="fas fa-store"></i> Datos del Mercado
        </div>
        <div class="municipal-card-body">
          <table class="municipal-table">
            <tr>
              <th width="30%">Oficina</th>
              <td>{{ pago.oficina }}</td>
            </tr>
            <tr>
              <th>Mercado</th>
              <td>{{ pago.num_mercado }}</td>
            </tr>
            <tr>
              <th>Categor�a</th>
              <td>{{ pago.categoria }}</td>
            </tr>
            <tr>
              <th>Secci�n</th>
              <td>{{ pago.seccion }}</td>
            </tr>
            <tr>
              <th>Local</th>
              <td>{{ pago.local }}</td>
            </tr>
            <tr>
              <th>Letra</th>
              <td>{{ pago.letra_local }}</td>
            </tr>
            <tr>
              <th>Bloque</th>
              <td>{{ pago.bloque }}</td>
            </tr>
            <tr>
              <th>Descripci�n</th>
              <td>{{ pago.descripcion_local }}</td>
            </tr>
          </table>
        </div>
        </div>

      <div class="municipal-card">
        <div class="municipal-card-header bg-success text-white">
          <i class="fas fa-money-check-alt"></i> Datos del Pago
        </div>
        <div class="municipal-card-body">
          <table class="municipal-table">
            <tr>
              <th width="30%">Control</th>
              <td>{{ pago.id_local }}</td>
            </tr>
            <tr>
              <th>A�o</th>
              <td>{{ pago.axo }}</td>
            </tr>
            <tr>
              <th>Mes</th>
              <td>{{ pago.periodo }}</td>
            </tr>
            <tr>
              <th>Fecha de Pago</th>
              <td>{{ formatDate(pago.fecha_pago) }}</td>
            </tr>
            <tr>
              <th>Oficina de Pago</th>
              <td>{{ pago.oficina_pago }}</td>
            </tr>
            <tr>
              <th>Caja de Pago</th>
              <td>{{ pago.caja_pago }}</td>
            </tr>
            <tr>
              <th>Operaci�n de Pago</th>
              <td>{{ pago.operacion_pago }}</td>
            </tr>
            <tr>
              <th>Importe Pagado</th>
              <td class="text-success font-weight-bold">{{ formatCurrency(pago.importe_pago) }}</td>
            </tr>
            <tr>
              <th>Partida</th>
              <td>{{ pago.folio }}</td>
            </tr>
            <tr>
              <th>Actualizaci�n</th>
              <td>{{ formatDateTime(pago.fecha_modificacion_1) }}</td>
            </tr>
            <tr>
              <th>Usuario</th>
              <td>{{ pago.usuario }}</td>
            </tr>
          </table>
        </div>
        </div>
    </div>

    <div v-else-if="error" class="alert alert-danger">
      {{ error }}
    </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const now = new Date()
const form = ref({
  id_local: null,
  axo: now.getFullYear(),
  periodo: now.getMonth() + 1
})

const pago = ref(null)
const loading = ref(false)
const error = ref('')

const buscarPago = async () => {
  loading.value = true
  error.value = ''
  pago.value = null

  try {
    const result = await executeStoredProcedure(
      'SP_MERCADOS_PAGO_INDIVIDUAL',
      [form.value.id_local, form.value.axo, form.value.periodo]
    )

    if (result && result.length > 0) {
      pago.value = result[0]
    } else {
      error.value = 'No se encontr� el pago especificado'
    }
  } catch (err) {
    handleError(err)
    error.value = 'Error al consultar el pago'
    toast.error('Error al consultar el pago')
  } finally {
    loading.value = false
  }
}

const formatCurrency = (value) => {
  if (value == null) return ''
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(value)
}

const formatDate = (value) => {
  if (!value) return ''
  return new Date(value).toLocaleDateString('es-MX')
}

const formatDateTime = (value) => {
  if (!value) return ''
  return new Date(value).toLocaleString('es-MX')
}
</script>



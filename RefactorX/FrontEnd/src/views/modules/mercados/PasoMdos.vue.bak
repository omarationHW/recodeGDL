<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon"><font-awesome-icon icon="exchange-alt" /></div>
      <div class="module-view-info">
        <h1>Paso de Tianguis a Padrón</h1>
        <p>Traspaso de Registros del Tianguis al Padrón de Locales (Mercado 214)</p>
      </div>
        </div>

    <div class="module-view-content">
      <div class="municipal-card">
        <div class="municipal-card-header"><h5><font-awesome-icon icon="database" /> Carga de Datos</h5></div>
        <div class="municipal-card-body">
          <div class="alert-info">
            <font-awesome-icon icon="info-circle" />
            <span>Este módulo carga los registros del Tianguis y los traspasa al padrón de locales del Mercado 214 (sección SS).</span>
          </div>
          <div class="button-group">
            <button class="btn-municipal-primary" @click="cargarTianguis" :disabled="loading">
              <font-awesome-icon :icon="loading ? 'spinner' : 'file-import'" :spin="loading" /> Cargar Datos del Tianguis
            </button>
            <button class="btn-municipal-success" @click="procesarRegistros" :disabled="loading || registros.length === 0">
              <font-awesome-icon icon="check-circle" /> Procesar Registros
            </button>
          </div>
        </div>

      <div class="municipal-card" v-if="registros.length > 0">
        <div class="municipal-card-header">
          <h5><font-awesome-icon icon="list" /> Registros del Tianguis <span class="badge-info">{{ registros.length }}</span></h5>
        </div>
        <div class="municipal-card-body table-container">
          <div class="municipal-table">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th>#</th>
                  <th>Folio</th>
                  <th>Nombre</th>
                  <th>Domicilio</th>
                  <th>Sector</th>
                  <th>Zona</th>
                  <th>Superficie</th>
                  <th>Giro</th>
                  <th>Fecha Alta</th>
                  <th>Estado</th>
                  <th class="text-end">Descuento</th>
                  <th>Motivo Desc.</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(reg, idx) in registros" :key="idx" class="row-hover">
                  <td>{{ idx + 1 }}</td>
                  <td><strong>{{ reg.folio }}</strong></td>
                  <td>{{ reg.nombre }}</td>
                  <td>{{ reg.domicilio }}</td>
                  <td>{{ reg.sector }}</td>
                  <td>{{ reg.zona }}</td>
                  <td class="text-end">{{ reg.superficie }}</td>
                  <td>{{ reg.giro }}</td>
                  <td>{{ reg.fecha_alta }}</td>
                  <td>
                    <span :class="reg.vigencia === 'A' ? 'badge-success' : 'badge-danger'">
                      {{ reg.vigencia === 'A' ? 'ACTIVO' : 'BAJA' }}
                    </span>
                  </td>
                  <td class="text-end">{{ reg.descuento }}</td>
                  <td>{{ reg.motivo_descuento }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      <div class="municipal-card" v-if="resultado.mostrar">
        <div class="municipal-card-header"><h5><font-awesome-icon icon="chart-bar" /> Resultado del Procesamiento</h5></div>
        <div class="municipal-card-body">
          <div class="stats-grid">
            <div class="stat-card gradient-success">
              <div class="stat-icon"><font-awesome-icon icon="check" /></div>
              <div class="stat-info">
                <div class="stat-value">{{ resultado.procesados }}</div>
                <div class="stat-label">Registros Insertados</div>
        </div>
            </div>
            <div class="stat-card gradient-info">
              <div class="stat-icon"><font-awesome-icon icon="ban" /></div>
              <div class="stat-info">
                <div class="stat-value">{{ resultado.existentes }}</div>
                <div class="stat-label">Ya Existían</div>
        </div>
            </div>
            <div class="stat-card gradient-danger">
              <div class="stat-icon"><font-awesome-icon icon="exclamation-triangle" /></div>
              <div class="stat-info">
                <div class="stat-value">{{ resultado.errores }}</div>
                <div class="stat-label">Errores</div>
        </div>
            </div>
            <div class="stat-card gradient-primary">
              <div class="stat-icon"><font-awesome-icon icon="list-ol" /></div>
              <div class="stat-info">
                <div class="stat-value">{{ resultado.total }}</div>
                <div class="stat-label">Total Procesado</div>
        </div>
      </div>
        </div>
        </div>
        </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const loading = ref(false)
const registros = ref([])
const resultado = ref({
  mostrar: false,
  procesados: 0,
  existentes: 0,
  errores: 0,
  total: 0
})

const cargarTianguis = async () => {
  try {
    loading.value = true
    const result = await executeStoredProcedure('sp_get_tianguis_data', {})
    if (result.success) {
      // Procesar cada registro para determinar vigencia
      registros.value = (result.data || []).map(reg => {
        const nombreTrim = (reg.nombre || '').trim()
        const esVacante = nombreTrim === 'P U E S T O   V A C A N T E _ _'
        return {
          folio: reg.folio,
          nombre: reg.nombre,
          domicilio: reg.domicilio,
          superficie: reg.superficie,
          giro: reg.giro || '1',
          descuento: reg.descuento || 0,
          motivo_descuento: reg.motivo_descuento || '',
          sector: 'J',
          zona: 5,
          fecha_alta: '2009-01-01',
          vigencia: esVacante ? 'B' : 'A'
        }
      })
      toast.success(`${registros.value.length} registros cargados del Tianguis`)
      resultado.value.mostrar = false
    } else {
      handleError(result)
    }
  } catch (error) {
    handleError(error)
  } finally {
    loading.value = false
  }
}

const procesarRegistros = async () => {
  try {
    loading.value = true
    let procesados = 0
    let existentes = 0
    let errores = 0

    for (const reg of registros.value) {
      try {
        // Verificar si el local ya existe
        const checkResult = await executeStoredProcedure('sp_check_local_tianguis_exists', {
          p_folio: reg.folio
        })

        if (checkResult.success && checkResult.data && checkResult.data.length > 0) {
          existentes++
        } else {
          // Insertar nuevo registro
          const insertResult = await executeStoredProcedure('sp_insert_tianguis_padron', {
            p_folio: reg.folio,
            p_nombre: reg.nombre,
            p_domicilio: reg.domicilio,
            p_superficie: reg.superficie,
            p_giro: reg.giro,
            p_descuento: reg.descuento,
            p_motivo_descuento: reg.motivo_descuento,
            p_id_usuario: 1,
            p_fecha_modificacion: new Date().toISOString(),
            p_vigencia: reg.vigencia
          })

          if (insertResult.success) {
            procesados++
          } else {
            errores++
          }
        }
      } catch (error) {
        errores++
      }
    }

    resultado.value = {
      mostrar: true,
      procesados,
      existentes,
      errores,
      total: registros.value.length
    }

    if (errores === 0) {
      toast.success(`Proceso completado: ${procesados} insertados, ${existentes} ya existían`)
    } else {
      toast.warning(`Proceso con errores: ${procesados} insertados, ${existentes} existentes, ${errores} errores`)
    }
  } catch (error) {
    handleError(error)
  } finally {
    loading.value = false
  }
}
</script>



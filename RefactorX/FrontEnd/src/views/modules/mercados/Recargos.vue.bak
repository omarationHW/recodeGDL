<template>
  <div class="module-view">
    <div class="module-view-header">
      <div class="module-view-icon"><font-awesome-icon icon="percentage" /></div>
      <div class="module-view-info">
        <h1>Recargos</h1>
        <p>Cat�logo de Porcentajes de Recargos por A�o y Periodo</p>
      </div>
        </div>

    <div class="module-view-content">
      <div class="municipal-card">
        <div class="municipal-card-header">
          <h5><font-awesome-icon icon="list" /> Recargos Registrados <span class="badge-info">{{ recargos.length }}</span></h5>
        </div>
        <div class="municipal-card-body">
          <div class="button-group">
            <button class="btn-municipal-primary" @click="openModalNuevo">
              <font-awesome-icon icon="plus" /> Nuevo Recargo
            </button>
            <button class="btn-municipal-warning" @click="openModalModificar" :disabled="!selectedRecargo">
              <font-awesome-icon icon="edit" /> Modificar Seleccionado
            </button>
            <button class="btn-municipal-danger" @click="eliminar" :disabled="!selectedRecargo">
              <font-awesome-icon icon="trash" /> Eliminar
            </button>
          </div>

          <div class="municipal-table" style="margin-top: 20px;">
            <table class="municipal-table">
              <thead class="municipal-table-header">
                <tr>
                  <th width="50"></th>
                  <th>A�o</th>
                  <th>Periodo</th>
                  <th class="text-end">Porcentaje (%)</th>
                  <th>Fecha Alta</th>
                  <th>Usuario</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="rec in recargos" :key="`${rec.axo}-${rec.periodo}`"
                    :class="{'selected-row': selectedRecargo && selectedRecargo.axo === rec.axo && selectedRecargo.periodo === rec.periodo}"
                    @click="selectRecargo(rec)" class="row-hover selectable-row">
                  <td>
                    <input type="radio" :checked="selectedRecargo && selectedRecargo.axo === rec.axo && selectedRecargo.periodo === rec.periodo" />
                  </td>
                  <td><strong>{{ rec.axo }}</strong></td>
                  <td>{{ getMesNombre(rec.periodo) }}</td>
                  <td class="text-end"><strong class="text-primary">{{ rec.porcentaje }}%</strong></td>
                  <td>{{ formatDate(rec.fecha_alta) }}</td>
                  <td><small>{{ rec.usuario }}</small></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
    </div>

    <!-- Modal para Nuevo/Modificar -->
    <div v-if="showModal" class="modal-overlay" @click.self="closeModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5>{{ modalMode === 'I' ? 'Nuevo Recargo' : 'Modificar Recargo' }}</h5>
          <button class="btn-close" @click="closeModal"><font-awesome-icon icon="times" /></button>
        </div>
        <div class="modal-body">
          <form @submit.prevent="save">
            <div class="form-row">
              <div class="form-group">
                <label class="municipal-form-label">A�o *</label>
                <input type="number" class="municipal-form-control" v-model.number="form.axo" :readonly="modalMode === 'M'" required min="1992" max="2999" />
              </div>
              <div class="form-group">
                <label class="municipal-form-label">Periodo *</label>
                <select class="municipal-form-control" v-model.number="form.periodo" :disabled="modalMode === 'M'" required>
                  <option v-for="m in 12" :key="m" :value="m">{{ getMesNombre(m) }}</option>
                </select>
              </div>
              <div class="form-group">
                <label class="municipal-form-label">Porcentaje (%) *</label>
                <input type="number" step="0.01" class="municipal-form-control" v-model.number="form.porcentaje" required min="0" max="100" />
              </div>
        </div>
            <div class="modal-footer">
              <button type="submit" class="btn-municipal-primary" :disabled="saving">
                <font-awesome-icon :icon="saving ? 'spinner' : 'save'" :spin="saving" /> Guardar
              </button>
              <button type="button" class="btn-municipal-secondary" @click="closeModal">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    </div>
  </div>
</template>

<script setup>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import { ref, onMounted } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from 'vue-toastification'
import Swal from 'sweetalert2'

const { executeStoredProcedure } = useApi()
const { handleError } = useLicenciasErrorHandler()
const toast = useToast()

const loading = ref(false)
const saving = ref(false)
const showModal = ref(false)
const modalMode = ref('I')
const recargos = ref([])
const selectedRecargo = ref(null)
const form = ref({
  axo: new Date().getFullYear(),
  periodo: new Date().getMonth() + 1,
  porcentaje: 0
})

const getMesNombre = (m) => {
  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
  return meses[m - 1] || m
}

const formatDate = (date) => date ? new Date(date).toLocaleDateString('es-MX') : 'N/A'

const loadRecargos = async () => {
  try {
    loading.value = true
    const result = await executeStoredProcedure('sp_recargos_list', {})
    if (result.success) {
      recargos.value = result.data || []
    } else {
      handleError(result)
    }
  } catch (error) {
    handleError(error)
  } finally {
    loading.value = false
  }
}

const selectRecargo = (rec) => {
  selectedRecargo.value = rec
}

const openModalNuevo = () => {
  modalMode.value = 'I'

  // Calcular el siguiente periodo/a�o basado en el �ltimo registro
  if (recargos.value.length > 0) {
    const ultimo = recargos.value[0] // Ya viene ordenado DESC
    if (ultimo.periodo <= 11) {
      form.value = {
        axo: ultimo.axo,
        periodo: ultimo.periodo + 1,
        porcentaje: 0
      }
    } else {
      form.value = {
        axo: ultimo.axo + 1,
        periodo: 1,
        porcentaje: 0
      }
    }
  } else {
    form.value = {
      axo: new Date().getFullYear(),
      periodo: new Date().getMonth() + 1,
      porcentaje: 0
    }
  }

  showModal.value = true
}

const openModalModificar = () => {
  if (!selectedRecargo.value) {
    toast.warning('Debe seleccionar un recargo')
    return
  }

  modalMode.value = 'M'
  form.value = {
    axo: selectedRecargo.value.axo,
    periodo: selectedRecargo.value.periodo,
    porcentaje: selectedRecargo.value.porcentaje
  }
  showModal.value = true
}

const closeModal = () => {
  showModal.value = false
  form.value = {
    axo: new Date().getFullYear(),
    periodo: new Date().getMonth() + 1,
    porcentaje: 0
  }
}

const save = async () => {
  try {
    saving.value = true

    if (modalMode.value === 'I') {
      const result = await executeStoredProcedure('sp_recargos_create', {
        p_axo: form.value.axo,
        p_periodo: form.value.periodo,
        p_porcentaje: form.value.porcentaje,
        p_usuario_id: 1
      })

      if (result.success) {
        toast.success('Recargo creado correctamente')
        closeModal()
        await loadRecargos()
      } else {
        handleError(result)
      }
    } else {
      const result = await executeStoredProcedure('sp_recargos_update', {
        p_axo: form.value.axo,
        p_periodo: form.value.periodo,
        p_porcentaje: form.value.porcentaje,
        p_usuario_id: 1
      })

      if (result.success) {
        toast.success('Recargo actualizado correctamente')
        closeModal()
        await loadRecargos()
      } else {
        handleError(result)
      }
    }
  } catch (error) {
    handleError(error)
  } finally {
    saving.value = false
  }
}

const eliminar = async () => {
  if (!selectedRecargo.value) {
    toast.warning('Debe seleccionar un recargo')
    return
  }

  const confirm = await Swal.fire({
    title: '�Eliminar recargo?',
    text: `Recargo de ${getMesNombre(selectedRecargo.value.periodo)} ${selectedRecargo.value.axo}`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Eliminar',
    cancelButtonText: 'Cancelar'
  })

  if (!confirm.isConfirmed) return

  try {
    const result = await executeStoredProcedure('sp_recargos_delete', {
      p_axo: selectedRecargo.value.axo,
      p_periodo: selectedRecargo.value.periodo
    })

    if (result.success) {
      toast.success('Recargo eliminado correctamente')
      selectedRecargo.value = null
      await loadRecargos()
    } else {
      handleError(result)
    }
  } catch (error) {
    handleError(error)
  }
}

onMounted(() => {
  loadRecargos()
})
</script>



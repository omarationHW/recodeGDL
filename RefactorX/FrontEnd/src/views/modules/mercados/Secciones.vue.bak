<template>
  <div class="module-view">
    <!-- HEADER -->
    <div class="module-view-header">
      <div class="module-view-icon">
        <font-awesome-icon icon="th-large" />
      </div>
      <div class="module-view-info">
        <h1>Cat�logo de Secciones</h1>
        <p>Mercados - Gesti�n de secciones por mercado</p>
      </div>
      <button class="btn-help-icon" @click="mostrarAyuda" type="button">
        <font-awesome-icon icon="question-circle" /> Ayuda
      </button>
    </div>

    <!-- FILTROS Y ACCIONES -->
    <div class="municipal-card">
      <div class="municipal-card-header">
        <h5><font-awesome-icon icon="filter" /> Filtros y Acciones</h5>
      </div>

      <div >
        <div class="form-row">
          <div class="form-group">
            <label for="filtro-oficina" class="municipal-form-label">Recaudadora:</label>
            <select
              v-model.number="filtros.oficina"
              id="filtro-oficina"
              class="municipal-form-control"
              :disabled="cargando"
            >
              <option :value="null">Todas</option>
              <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                {{ rec.oficina }} - {{ rec.recaudadora }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="filtro-mercado" class="municipal-form-label">Mercado:</label>
            <select
              v-model.number="filtros.num_mercado"
              id="filtro-mercado"
              class="municipal-form-control"
              :disabled="cargando || !filtros.oficina"
            >
              <option :value="null">Todos</option>
              <option v-for="mer in mercados" :key="mer.num_mercado_nvo" :value="mer.num_mercado_nvo">
                {{ mer.num_mercado_nvo }} - {{ mer.descripcion }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <button
            type="button"
            class="btn-municipal-primary"
            @click="buscarSecciones"
            :disabled="cargando"
          >
            <font-awesome-icon icon="search" /> Buscar
          </button>

          <button
            type="button"
            class="btn-municipal-secondary"
            @click="limpiarFiltros"
            :disabled="cargando"
          >
            <font-awesome-icon icon="eraser" /> Limpiar
          </button>

          <button
            type="button"
            class="btn-municipal-success"
            @click="nuevaSeccion"
            :disabled="cargando"
          >
            <font-awesome-icon icon="plus" /> Nueva Secci�n
          </button>

          <button
            type="button"
            class="btn-municipal-info"
            @click="exportarExcel"
            :disabled="cargando || secciones.length === 0"
          >
            <font-awesome-icon icon="file-excel" /> Exportar
          </button>
        </div>
        </div>
    </div>

    <!-- TABLA DE SECCIONES -->
    <div v-if="secciones.length > 0" class="municipal-card">
      <div class="municipal-card-header">
        <h5><font-awesome-icon icon="table" /> Listado de Secciones</h5>
      </div>

      <div class="municipal-table">
        <table class="municipal-table">
          <thead>
            <tr>
              <th class="text-center">#</th>
              <th>Recaudadora</th>
              <th>Mercado</th>
              <th class="text-center">N�m. Secci�n</th>
              <th>Descripci�n</th>
              <th class="text-center">Vigencia</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(item, index) in secciones" :key="item.id_seccion">
              <td class="text-center">{{ index + 1 }}</td>
              <td>{{ item.oficina }}</td>
              <td>{{ item.num_mercado }} - {{ item.desc_mercado }}</td>
              <td class="text-center">
                <span class="badge-primary">{{ item.num_seccion }}</span>
              </td>
              <td>{{ item.descripcion }}</td>
              <td class="text-center">
                <span class="badge" :class="item.vigencia === 'V' ? 'badge-success' : 'badge-danger'">
                  {{ item.vigencia === 'V' ? 'Vigente' : 'Baja' }}
                </span>
              </td>
              <td class="text-center">
                <button
                  type="button"
                  class="btn-icon btn-warning"
                  @click="editarSeccion(item)"
                  title="Editar"
                >
                  <font-awesome-icon icon="edit" />
                </button>
                <button
                  type="button"
                  class="btn-icon btn-danger"
                  @click="eliminarSeccion(item)"
                  title="Eliminar"
                >
                  <font-awesome-icon icon="trash" />
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SIN DATOS -->
    <div v-else-if="!cargando && consultaRealizada" class="municipal-card">
      <div class="alert alert-info">
        <font-awesome-icon icon="info-circle" />
        No se encontraron secciones con los criterios especificados.
      </div>
    </div>

    <!-- MODAL FORMULARIO -->
    <div v-if="mostrarFormulario" class="modal-overlay" @click.self="cerrarFormulario">
      <div class="modal-content">
        <div class="modal-header">
          <h2>
            <font-awesome-icon :icon="modoEdicion ? 'edit' : 'plus'" />
            {{ modoEdicion ? 'Editar' : 'Nueva' }} Secci�n
          </h2>
          <button type="button" class="btn-close" @click="cerrarFormulario">&times;</button>
        </div>

        <form @submit.prevent="guardarSeccion" >
          <div class="modal-body">
            <div class="form-row">
              <div class="form-group">
                <label for="oficina" class="municipal-form-label required">Recaudadora:</label>
                <select
                  v-model.number="formulario.oficina"
                  id="oficina"
                  class="municipal-form-control"
                  required
                  :disabled="guardando || modoEdicion"
                >
                  <option value="">Seleccione...</option>
                  <option v-for="rec in recaudadoras" :key="rec.oficina" :value="rec.oficina">
                    {{ rec.oficina }} - {{ rec.recaudadora }}
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label for="mercado" class="municipal-form-label required">Mercado:</label>
                <select
                  v-model.number="formulario.num_mercado"
                  id="mercado"
                  class="municipal-form-control"
                  required
                  :disabled="guardando || !formulario.oficina || modoEdicion"
                >
                  <option value="">Seleccione...</option>
                  <option v-for="mer in mercadosForm" :key="mer.num_mercado_nvo" :value="mer.num_mercado_nvo">
                    {{ mer.num_mercado_nvo }} - {{ mer.descripcion }}
                  </option>
                </select>
              </div>
        </div>

            <div class="form-row">
              <div class="form-group">
                <label for="num-seccion" class="municipal-form-label required">N�mero de Secci�n:</label>
                <input
                  type="number"
                  v-model.number="formulario.num_seccion"
                  id="num-seccion"
                  class="municipal-form-control"
                  required
                  :disabled="guardando || modoEdicion"
                  min="1"
                  placeholder="Ej: 1"
                />
                <small v-if="modoEdicion" class="form-text text-muted">
                  El n�mero de secci�n no se puede modificar
                </small>
              </div>
        </div>

            <div class="form-row">
              <div class="form-group">
                <label for="descripcion" class="municipal-form-label required">Descripci�n:</label>
                <input
                  type="text"
                  v-model="formulario.descripcion"
                  id="descripcion"
                  class="municipal-form-control"
                  required
                  :disabled="guardando"
                  maxlength="100"
                  placeholder="Descripci�n de la secci�n"
                />
              </div>
        </div>

            <div class="form-row">
              <div class="form-group">
                <label for="vigencia" class="municipal-form-label required">Vigencia:</label>
                <select
                  v-model="formulario.vigencia"
                  id="vigencia"
                  class="municipal-form-control"
                  required
                  :disabled="guardando"
                >
                  <option value="">Seleccione...</option>
                  <option value="V">Vigente</option>
                  <option value="B">Baja</option>
                </select>
              </div>
        </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn-municipal-secondary"
              @click="cerrarFormulario"
              :disabled="guardando"
            >
              <font-awesome-icon icon="times" /> Cancelar
            </button>
            <button
              type="submit"
              class="btn-municipal-success"
              :disabled="guardando"
            >
              <font-awesome-icon icon="save" /> Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, watch } from 'vue'
import { useApi } from '@/composables/useApi'
import { useLicenciasErrorHandler } from '@/composables/useLicenciasErrorHandler'
import { useToast } from '@/composables/useToast'
import Swal from 'sweetalert2'
import * as XLSX from 'xlsx'

const { execute } = useApi()
const { handleError } = useLicenciasErrorHandler()
const { showToast } = useToast()

// Estado
const cargando = ref(false)
const guardando = ref(false)
const consultaRealizada = ref(false)
const mostrarFormulario = ref(false)
const modoEdicion = ref(false)
const recaudadoras = ref([])
const mercados = ref([])
const mercadosForm = ref([])
const secciones = ref([])

// Filtros
const filtros = ref({
  oficina: null,
  num_mercado: null
})

// Formulario
const formulario = ref({
  id_seccion: null,
  oficina: '',
  num_mercado: '',
  num_seccion: '',
  descripcion: '',
  vigencia: 'V'
})

// Watch para cargar mercados de filtros
watch(() => filtros.value.oficina, async (newOficina) => {
  if (newOficina) {
    await cargarMercados(newOficina, 'filtro')
    filtros.value.num_mercado = null
  } else {
    mercados.value = []
    filtros.value.num_mercado = null
  }
})

// Watch para cargar mercados de formulario
watch(() => formulario.value.oficina, async (newOficina) => {
  if (newOficina) {
    await cargarMercados(newOficina, 'form')
    formulario.value.num_mercado = ''
  } else {
    mercadosForm.value = []
    formulario.value.num_mercado = ''
  }
})

// Cargar recaudadoras
async function cargarRecaudadoras() {
  try {
    const response = await execute('SP_MERCADOS_RECAUDADORAS_LIST', 'mercados', {})
    recaudadoras.value = response || []
  } catch (error) {
    handleError(error)
  }
}

// Cargar mercados
async function cargarMercados(oficina, tipo) {
  try {
    const response = await execute('SP_MERCADOS_BY_RECAUDADORA', 'mercados', {
      p_id_rec: oficina
    })
    if (tipo === 'filtro') {
      mercados.value = response || []
    } else {
      mercadosForm.value = response || []
    }
  } catch (error) {
    handleError(error)
  }
}

// Cargar datos iniciales
cargarRecaudadoras()

// Buscar secciones
async function buscarSecciones() {
  try {
    cargando.value = true
    consultaRealizada.value = true

    const response = await execute('SP_MERCADOS_SECCIONES_BY_MERCADO', 'mercados', {
      p_oficina: filtros.value.oficina,
      p_num_mercado: filtros.value.num_mercado
    })

    secciones.value = response || []

    if (secciones.value.length > 0) {
      showToast(`Se encontraron ${secciones.value.length} secciones`, 'success')
    }

  } catch (error) {
    handleError(error)
    secciones.value = []
  } finally {
    cargando.value = false
  }
}

// Limpiar filtros
function limpiarFiltros() {
  filtros.value = {
    oficina: null,
    num_mercado: null
  }
  secciones.value = []
  consultaRealizada.value = false
}

// Nueva secci�n
function nuevaSeccion() {
  modoEdicion.value = false
  formulario.value = {
    id_seccion: null,
    oficina: '',
    num_mercado: '',
    num_seccion: '',
    descripcion: '',
    vigencia: 'V'
  }
  mostrarFormulario.value = true
}

// Editar secci�n
function editarSeccion(seccion) {
  modoEdicion.value = true
  formulario.value = {
    id_seccion: seccion.id_seccion,
    oficina: seccion.oficina,
    num_mercado: seccion.num_mercado,
    num_seccion: seccion.num_seccion,
    descripcion: seccion.descripcion,
    vigencia: seccion.vigencia
  }
  mostrarFormulario.value = true
}

// Guardar secci�n
async function guardarSeccion() {
  try {
    guardando.value = true

    if (modoEdicion.value) {
      await execute('SP_MERCADOS_SECCIONES_UPDATE', 'mercados', {
        p_id_seccion: formulario.value.id_seccion,
        p_descripcion: formulario.value.descripcion,
        p_vigencia: formulario.value.vigencia
      })
      showToast('Secci�n actualizada correctamente', 'success')
    } else {
      await execute('SP_MERCADOS_SECCIONES_CREATE', 'mercados', {
        p_oficina: formulario.value.oficina,
        p_num_mercado: formulario.value.num_mercado,
        p_num_seccion: formulario.value.num_seccion,
        p_descripcion: formulario.value.descripcion,
        p_vigencia: formulario.value.vigencia
      })
      showToast('Secci�n creada correctamente', 'success')
    }

    cerrarFormulario()
    await buscarSecciones()

  } catch (error) {
    handleError(error)
  } finally {
    guardando.value = false
  }
}

// Eliminar secci�n
async function eliminarSeccion(seccion) {
  const result = await Swal.fire({
    title: '�Eliminar secci�n?',
    html: `�Est� seguro de eliminar la secci�n:<br>
           <strong>Secci�n ${seccion.num_seccion} - ${seccion.descripcion}</strong><br>
           del mercado <strong>${seccion.desc_mercado}</strong>?<br><br>
           <small class="text-danger">Esta acci�n no se puede deshacer y fallar� si hay locales asociados.</small>`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S�, eliminar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#d33'
  })

  if (result.isConfirmed) {
    try {
      await execute('SP_MERCADOS_SECCIONES_DELETE', 'mercados', {
        p_id_seccion: seccion.id_seccion
      })
      showToast('Secci�n eliminada correctamente', 'success')
      await buscarSecciones()
    } catch (error) {
      handleError(error)
    }
  }
}

// Cerrar formulario
function cerrarFormulario() {
  mostrarFormulario.value = false
  modoEdicion.value = false
}

// Exportar a Excel
function exportarExcel() {
  try {
    const datos = secciones.value.map((item, idx) => ({
      '#': idx + 1,
      'Recaudadora': item.oficina,
      'Mercado': `${item.num_mercado} - ${item.desc_mercado}`,
      'N�m. Secci�n': item.num_seccion,
      'Descripci�n': item.descripcion,
      'Vigencia': item.vigencia === 'V' ? 'Vigente' : 'Baja'
    }))

    const ws = XLSX.utils.json_to_sheet(datos)
    const wb = XLSX.utils.book_new()
    XLSX.utils.book_append_sheet(wb, ws, 'Secciones')

    const nombreArchivo = `Secciones_Mercados_${new Date().toISOString().split('T')[0]}.xlsx`

    XLSX.writeFile(wb, nombreArchivo)
    showToast('Archivo Excel generado correctamente', 'success')
  } catch (error) {
    handleError(error)
  }
}

// Mostrar ayuda
function mostrarAyuda() {
  Swal.fire({
    title: 'Ayuda - Cat�logo de Secciones',
    html: `
      <div class="help-content" style="text-align: left;">
        <h3>Descripci�n</h3>
        <p>Este m�dulo permite gestionar el cat�logo de secciones dentro de cada mercado.</p>

        <h3>�Qu� son las Secciones?</h3>
        <p>Las secciones son subdivisiones f�sicas o administrativas dentro de un mercado que agrupan locales por �rea geogr�fica, tipo de productos o criterios de organizaci�n.</p>

        <h3>Filtros de B�squeda</h3>
        <ul>
          <li><strong>Recaudadora:</strong> Filtra por oficina recaudadora</li>
          <li><strong>Mercado:</strong> Filtra por mercado espec�fico</li>
        </ul>

        <h3>Gesti�n de Secciones</h3>
        <ul>
          <li><strong>Nueva Secci�n:</strong> Permite registrar una nueva secci�n para un mercado</li>
          <li><strong>Editar:</strong> Modifica la descripci�n y vigencia de una secci�n</li>
          <li><strong>Eliminar:</strong> Elimina una secci�n (solo si no tiene locales asociados)</li>
        </ul>

        <h3>Campos de la Secci�n</h3>
        <ul>
          <li><strong>Recaudadora:</strong> Oficina a la que pertenece</li>
          <li><strong>Mercado:</strong> Mercado al que pertenece la secci�n</li>
          <li><strong>N�mero de Secci�n:</strong> Identificador num�rico �nico dentro del mercado</li>
          <li><strong>Descripci�n:</strong> Nombre o descripci�n de la secci�n</li>
          <li><strong>Vigencia:</strong> Estado de la secci�n (Vigente/Baja)</li>
        </ul>

        <h3>Validaciones</h3>
        <ul>
          <li>No se pueden crear secciones duplicadas en el mismo mercado</li>
          <li>Al editar, no se puede modificar la recaudadora, mercado ni n�mero de secci�n</li>
          <li>No se puede eliminar una secci�n que tenga locales asociados</li>
        </ul>

        <h3>Uso en el Sistema</h3>
        <ul>
          <li>Organizaci�n f�sica de los mercados</li>
          <li>Facilita la ubicaci�n de locales</li>
          <li>Permite generar reportes por secci�n</li>
          <li>Ayuda en la asignaci�n y distribuci�n de espacios</li>
        </ul>

        <h3>Funcionalidades</h3>
        <ul>
          <li><strong>Buscar:</strong> Aplica los filtros seleccionados</li>
          <li><strong>Limpiar:</strong> Reinicia todos los filtros</li>
          <li><strong>Exportar Excel:</strong> Descarga el listado en formato Excel</li>
        </ul>
      </div>
    `,
    icon: 'info',
    width: 800,
    confirmButtonText: 'Entendido'
  })
}
</script>



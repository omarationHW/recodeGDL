=== EJEMPLOS PARA PROBAR multasfrmcalif.vue ===

El stored procedure ha sido actualizado para usar las tablas existentes:
- publico.multas (416,928 multas con calificación)
- publico.tipo_calificacion_multa (12,326 registros con tipo de calificación)

IMPORTANTE:
- 416,928 multas disponibles
- 414,917 multas con calificación asignada
- 12,326 multas con tipo de calificación (2.96%)
- Búsqueda por: clave cuenta, folio, contribuyente
- Paginación con offset y limit
- Estados: Activa (409,177), Cancelada (7,751)

--- PROBLEMA ORIGINAL ---

Error: relation "publico.multas_calificacion" does not exist

--- SOLUCIÓN ---

Ahora usa las tablas:
- publico.multas (tabla principal con campo calificacion)
- publico.tipo_calificacion_multa (LEFT JOIN para tipo de calificación)

--- FUNCIÓN DISPONIBLE ---

**recaudadora_multasfrmcalif**: Busca multas con calificación y paginación

--- PARÁMETROS ---

La función recibe:
- p_clave_cuenta: VARCHAR (búsqueda general, puede estar vacío)
- p_offset: INTEGER (inicio de página, default 0)
- p_limit: INTEGER (cantidad de registros, default 50)

Búsqueda en:
- Clave cuenta (num_acta/axo_acta)
- Número de acta (folio)
- Contribuyente (nombre)

--- EJEMPLO 1: Búsqueda sin filtro (primera página) ---

Parámetros:
- p_clave_cuenta: '' (vacío)
- p_offset: 0
- p_limit: 50

Resultado esperado:
✓ Total encontrados en página: 50
✓ Total en base de datos: 416,928
✓ Campos retornados:
  - id_multa: 412441
  - clave_cuenta: 652/2025
  - folio: 652
  - ejercicio: 2025
  - contribuyente: PROMOTORA NAACE, S. DE R.L. DE C.V.
  - domicilio: TURIN
  - fecha_acta: (fecha del acta)
  - fecha_recepcion: (fecha de recepción)
  - multa: $45,000.00
  - gastos: $0.00
  - total: $45,000.00
  - calificacion: $45,000.00
  - tipo_calificacion: O (Oficial)
  - estado: Activa
  - observacion: (texto de observaciones)
  - total_count: 416,928 (para paginación)

--- EJEMPLO 2: Búsqueda por contribuyente ---

Parámetros:
- p_clave_cuenta: 'GARCIA'
- p_offset: 0
- p_limit: 50

Resultado esperado:
✓ Total encontrados en página: 50
✓ Total coincidencias: 15,883 multas con "GARCIA" en el nombre
✓ Ejemplos:
  - Folio: 10390/2013 - DE LA O GARCIA IRMA MARISSA - Total: $2,000.00 - Calificación: $2,000.00
  - Folio: 15781/2012 - HERNANDEZ GARCIA ERIKA - Total: $3,000.00 - Calificación: $3,000.00
  - Folio: 2511/2012 - GARCIA SALINAS RODRIGO - Total: $410.00 - Calificación: $410.00

--- EJEMPLO 3: Búsqueda por folio ---

Parámetros:
- p_clave_cuenta: '1234'
- p_offset: 0
- p_limit: 50

Resultado esperado:
✓ Total encontrados en página: 50
✓ Total coincidencias: 239 multas con "1234" en el folio
✓ Ejemplos:
  - Folio: 11234/2008 - S/C - Total: $0.00
  - Folio: 1234/2025 - SALGADO RAMIREZ UZIEL - Total: $0.00
  - Folio: 1234/2025 - INMOBILIARIA RINCONADA DEL ARROYO - Total: $2,450.00

--- CAMPOS RETORNADOS ---

| Campo             | Tipo    | Descripción                                    |
|-------------------|---------|------------------------------------------------|
| id_multa          | INTEGER | Identificador único de la multa                |
| clave_cuenta      | VARCHAR | Clave compuesta: num_acta/axo_acta             |
| folio             | VARCHAR | Número de acta                                 |
| ejercicio         | VARCHAR | Año de acta                                    |
| contribuyente     | VARCHAR | Nombre del contribuyente                       |
| domicilio         | VARCHAR | Domicilio del contribuyente                    |
| multa             | NUMERIC | Importe de la multa                            |
| gastos            | NUMERIC | Gastos de ejecución                            |
| total             | NUMERIC | Total = multa + gastos                         |
| calificacion      | NUMERIC | Valor de calificación de la multa             |
| tipo_calificacion | VARCHAR | Tipo: O (Oficial), M (Manual), N/A (Sin tipo) |
| estado            | VARCHAR | Activa o Cancelada                             |
| fecha_acta        | DATE    | Fecha del acta                                 |
| fecha_recepcion   | DATE    | Fecha de recepción                             |
| observacion       | TEXT    | Observaciones adicionales                      |
| total_count       | BIGINT  | Total de registros que cumplen el filtro       |

--- MAPEO DE TIPOS DE CALIFICACIÓN ---

| Tipo | Descripción | Total   | Porcentaje |
|------|-------------|---------|------------|
| O    | Oficial     | 7,744   | 62.8%      |
| M    | Manual      | 4,582   | 37.2%      |
| N/A  | Sin tipo    | 404,602 | 97.04%     |

--- MAPEO DE ESTADOS ---

| Estado    | Criterio                            | Total    | Porcentaje |
|-----------|-------------------------------------|----------|------------|
| Activa    | fecha_cancelacion IS NULL           | 409,177  | 98.1%      |
| Cancelada | fecha_cancelacion IS NOT NULL       | 7,751    | 1.9%       |

--- NOTAS CRÍTICAS ---

⚠️ **IMPORTANTE: LEFT JOIN con tipo_calificacion_multa**
   Solo el 2.96% de las multas tienen tipo de calificación asignado
   La mayoría mostrará "N/A" en tipo_calificacion

⚠️ Paginación obligatoria
   El stored procedure espera parámetros de paginación (offset, limit)
   Default: 50 registros por página

⚠️ Campo total_count
   Incluye el total de registros que cumplen el filtro
   Útil para calcular el número total de páginas en el frontend

⚠️ Búsqueda multi-campo
   El filtro p_clave_cuenta busca en:
   - Clave cuenta completa (num_acta/axo_acta)
   - Solo número de acta
   - Nombre del contribuyente

⚠️ Calificación vs Tipo de Calificación
   - calificacion: Valor numérico (NUMERIC) presente en mayoría de multas
   - tipo_calificacion: Código de tipo (O/M) solo en 2.96% de multas

⚠️ Estado derivado de fecha_cancelacion
   - Si fecha_cancelacion IS NULL → Activa
   - Si fecha_cancelacion IS NOT NULL → Cancelada

--- TABLA USADA ---

Base de datos: multas_reglamentos
Esquema: publico

Tablas:
1. publico.multas (416,928 registros) - Tabla principal
   - id_multa: Identificador único
   - num_acta: Número de acta
   - axo_acta: Año de acta
   - contribuyente: Nombre del contribuyente
   - domicilio: Domicilio
   - calificacion: Valor de calificación (NUMERIC)
   - multa: Importe de multa
   - gastos: Gastos de ejecución
   - total: Total
   - fecha_cancelacion: Fecha de cancelación (NULL = activa)

2. publico.tipo_calificacion_multa (12,326 registros) - LEFT JOIN
   - id_control: Identificador único
   - id_multa: FK a multas
   - tipo_calificacion: O (Oficial) o M (Manual)
   - usuario: Usuario que asignó el tipo
   - fecha_actual: Fecha de asignación

--- LÓGICA DE BÚSQUEDA ---

La función ejecuta:
```sql
SELECT
    m.id_multa,
    (m.num_acta || '/' || m.axo_acta) AS clave_cuenta,
    m.num_acta AS folio,
    (campos...)
FROM publico.multas m
LEFT JOIN publico.tipo_calificacion_multa tc ON m.id_multa = tc.id_multa
WHERE
    CASE
        WHEN p_clave_cuenta = '' OR p_clave_cuenta IS NULL THEN TRUE
        ELSE (
            (m.num_acta || '/' || m.axo_acta) ILIKE '%' || p_clave_cuenta || '%'
            OR m.num_acta::TEXT ILIKE '%' || p_clave_cuenta || '%'
            OR m.contribuyente ILIKE '%' || p_clave_cuenta || '%'
        )
    END
ORDER BY m.fecha_acta DESC, m.id_multa DESC
OFFSET p_offset
LIMIT p_limit
```

Criterios:
1. Si filtro vacío: retorna todas (con paginación)
2. Si hay filtro: busca en clave_cuenta, folio, contribuyente
3. LEFT JOIN para incluir tipo_calificacion cuando existe
4. Ordenamiento: fecha más reciente primero
5. Paginación: OFFSET y LIMIT

--- PRUEBAS REALIZADAS ---

✅ Test sin filtro, página 1: 50 multas (de 416,928 totales)
✅ Test con contribuyente 'GARCIA': 50 multas (de 15,883 coincidencias)
✅ Test con folio '1234': 50 multas (de 239 coincidencias)
✅ Test paginación página 2 (offset 50): 50 multas
✅ Test filtro por tipo de calificación: 3 multas con tipo O
✅ Stored procedure actualizado exitosamente
✅ LEFT JOIN funcional con tipo_calificacion_multa
✅ Campo total_count correcto para paginación

--- ESTADÍSTICAS ---

Total de multas: 416,928

Por estado:
- Activa: 409,177 (98.1%)
- Cancelada: 7,751 (1.9%)

Por calificación:
- Con calificación: 414,917 (99.5%)
- Sin calificación: 7 (0.02%)

Distribución de calificaciones:
- Baja (<= $50,000): 410,419 multas
- Media ($50,001-$100,000): 2,593 multas
- Alta (> $100,000): 1,905 multas
- Cero: 2,004 multas

Tipos de calificación:
- Oficial (O): 7,744 (62.8% de las que tienen tipo)
- Manual (M): 4,582 (37.2% de las que tienen tipo)
- Sin tipo (N/A): 404,602 (97.04% del total)

Rangos de valores:
- Calificación mínima: $0.01
- Calificación máxima: $35,000,000.00
- Calificación promedio: $5,813.68

--- CASOS DE USO ---

**Caso 1: Listar todas las multas con calificación (primera página)**
1. Llamar recaudadora_multasfrmcalif('', 0, 50)
2. Retorna las 50 primeras multas más recientes
3. Usar total_count para calcular total de páginas

**Caso 2: Buscar multas de un contribuyente**
1. Llamar recaudadora_multasfrmcalif('NOMBRE', 0, 50)
2. Retorna hasta 50 multas del contribuyente
3. Puede haber múltiples páginas

**Caso 3: Buscar multa por folio**
1. Llamar recaudadora_multasfrmcalif('1234', 0, 50)
2. Retorna multas que contengan '1234' en el folio
3. Búsqueda parcial

**Caso 4: Navegar a siguiente página**
1. Llamar recaudadora_multasfrmcalif('', 50, 50) para página 2
2. Llamar recaudadora_multasfrmcalif('', 100, 50) para página 3
3. Incrementar offset en 50 por cada página

**Caso 5: Filtrar solo multas con tipo de calificación**
1. Llamar recaudadora_multasfrmcalif('', 0, 50)
2. En frontend, filtrar WHERE tipo_calificacion != 'N/A'
3. Solo mostrará multas con tipo O o M

--- FLUJO RECOMENDADO ---

1. **Primera carga**
   ```
   recaudadora_multasfrmcalif('', 0, 50)
   → Retorna: primeras 50 multas + total_count
   ```

2. **Calcular total de páginas**
   ```
   total_pages = CEIL(total_count / limit)
   ```

3. **Buscar con filtro**
   ```
   recaudadora_multasfrmcalif('criterio', 0, 50)
   → Retorna: hasta 50 multas que coincidan + total_count
   ```

4. **Cambiar de página**
   ```
   recaudadora_multasfrmcalif(filtro_actual, page * 50, 50)
   → Retorna: multas de la página solicitada
   ```

--- RESUMEN ---

Problema: Tabla publico.multas_calificacion no existe

Solución: Usa publico.multas + publico.tipo_calificacion_multa (LEFT JOIN)

Diferencias clave:
- Campo calificacion (NUMERIC) está en tabla principal multas
- Campo tipo_calificacion solo en 2.96% de registros (via LEFT JOIN)
- Estado derivado de fecha_cancelacion (NULL = Activa)

Resultado: Sistema funcional para consulta de multas con calificación y paginación

Características:
- Búsqueda multi-campo (clave_cuenta, folio, contribuyente)
- Paginación con OFFSET y LIMIT
- Campo total_count para frontend
- LEFT JOIN para tipo de calificación opcional
- 416,928 multas disponibles
- 414,917 multas con calificación asignada
- Estados: Activa (98.1%), Cancelada (1.9%)
- Tipos: O (Oficial), M (Manual), N/A (Sin tipo)

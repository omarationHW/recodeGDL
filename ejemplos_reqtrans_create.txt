=== DOCUMENTACIÃ“N: recaudadora_reqtrans_create ===

Fecha: 2025-12-18
Stored Procedure: publico.recaudadora_reqtrans_create(JSON)
Base de Datos: multas_reglamentos
Tabla: public.reqdiftransmision

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA ORIGINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Error al crear registro: relation "catastro_gdl.reqdiftransmision" does not exist
La funciÃ³n intentaba insertar en una tabla del esquema incorrecto.

SOLUCIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El stored procedure ha sido actualizado para usar public.reqdiftransmision
que es la tabla correcta en la BD multas_reglamentos.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FUNCIÃ“N DISPONIBLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**recaudadora_reqtrans_create**: Crear nuevo requerimiento de diferencias de transmisiÃ³n

PARÃMETRO:
- p_registro: JSON con los datos del nuevo requerimiento

CAMPOS DEL JSON (parÃ¡metro):

| Campo        | Tipo    | Requerido | Default      | DescripciÃ³n                    |
|--------------|---------|-----------|--------------|--------------------------------|
| clave_cuenta | TEXT    | SÃ        | -            | Cuenta del contribuyente       |
| folio        | INTEGER | No        | 0            | Folio de transmisiÃ³n           |
| ejercicio    | INTEGER | No        | AÃ±o actual   | AÃ±o del requerimiento          |
| estatus      | TEXT    | No        | 'Vigente'    | Estatus (Vigente/Cancelado/etc)|
| recaud       | INTEGER | No        | 1            | RecaudaciÃ³n                    |
| impuesto     | NUMERIC | No        | 0            | Importe del impuesto           |
| recargos     | NUMERIC | No        | 0            | Importe de recargos            |
| multa        | NUMERIC | No        | 0            | Importe de multa               |
| gastos       | NUMERIC | No        | 0            | Importe de gastos              |

VALORES RETORNADOS (JSON):

| Campo   | Tipo    | DescripciÃ³n                                |
|---------|---------|--------------------------------------------|
| success | BOOLEAN | true si se creÃ³ correctamente, false si no |
| message | TEXT    | Mensaje descriptivo del resultado          |
| cvereq  | INTEGER | ID del nuevo requerimiento (si success)    |

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VALIDACIONES IMPLEMENTADAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. **Campo requerido: clave_cuenta**
   - Si estÃ¡ vacÃ­o o NULL, retorna error
   - Mensaje: "La cuenta es requerida"

2. **Duplicado: cuenta + ejercicio**
   - Verifica si ya existe un requerimiento para esa cuenta en ese aÃ±o
   - Mensaje: "Ya existe un requerimiento para esta cuenta en el aÃ±o XXXX"

3. **GeneraciÃ³n automÃ¡tica de ID**
   - cvereq se genera automÃ¡ticamente (MAX + 1)
   - No se puede especificar manualmente

4. **CÃ¡lculo automÃ¡tico de total**
   - total = impuesto + recargos + multa + gastos
   - Se calcula automÃ¡ticamente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EJEMPLO 1: CREACIÃ“N SIMPLE (SOLO CAMPOS REQUERIDOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ OBJETIVO: Crear requerimiento con datos mÃ­nimos

ğŸ”§ JSON DE ENTRADA:

```json
{
  "clave_cuenta": "999888777",
  "folio": 12345,
  "ejercicio": 2025,
  "estatus": "Vigente"
}
```

ğŸ“Š RESPUESTA ESPERADA:

```json
{
  "success": true,
  "message": "Registro creado correctamente",
  "cvereq": 6
}
```

âœ… VALIDACIONES:

- Registro creado exitosamente
- cvereq generado automÃ¡ticamente (6)
- folioreq = cvereq (6)
- vigencia = 'V' (Vigente)
- fecemi = Fecha actual
- capturista = 'SYSTEM'
- Todos los importes en 0
- Total = 0

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EJEMPLO 2: CREACIÃ“N CON IMPORTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ OBJETIVO: Crear requerimiento con desglose de importes

ğŸ”§ JSON DE ENTRADA:

```json
{
  "clave_cuenta": "888777666",
  "folio": 0,
  "ejercicio": 2025,
  "estatus": "Vigente",
  "impuesto": 1500.50,
  "recargos": 150.00,
  "multa": 300.00,
  "gastos": 50.00
}
```

ğŸ“Š RESPUESTA ESPERADA:

```json
{
  "success": true,
  "message": "Registro creado correctamente",
  "cvereq": 7
}
```

âœ… VALIDACIONES:

- Registro creado exitosamente
- cvereq generado automÃ¡ticamente (7)
- Importes guardados correctamente:
  * Impuesto: $1,500.50
  * Recargos: $150.00
  * Multa: $300.00
  * Gastos: $50.00
  * **Total calculado: $2,000.50**
- folio = 0 (sin asignar)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EJEMPLO 3: ERROR - CUENTA DUPLICADA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ OBJETIVO: Intentar crear requerimiento duplicado

ğŸ”§ JSON DE ENTRADA:

```json
{
  "clave_cuenta": "999888777",
  "ejercicio": 2025,
  "estatus": "Vigente"
}
```

Nota: Ya existe un requerimiento para esta cuenta en 2025

ğŸ“Š RESPUESTA ESPERADA:

```json
{
  "success": false,
  "message": "Ya existe un requerimiento para esta cuenta en el aÃ±o 2025"
}
```

âœ… VALIDACIONES:

- No se crea el registro
- ValidaciÃ³n funcionando correctamente
- Previene duplicados

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EJEMPLO 4: ERROR - CAMPO REQUERIDO FALTANTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ OBJETIVO: Intentar crear sin cuenta

ğŸ”§ JSON DE ENTRADA:

```json
{
  "ejercicio": 2025
}
```

Nota: Falta el campo clave_cuenta

ğŸ“Š RESPUESTA ESPERADA:

```json
{
  "success": false,
  "message": "La cuenta es requerida"
}
```

âœ… VALIDACIONES:

- No se crea el registro
- ValidaciÃ³n de campo requerido funcionando
- Mensaje claro y descriptivo

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

COMPORTAMIENTO AUTOMÃTICO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

La funciÃ³n realiza las siguientes operaciones automÃ¡ticamente:

1. **GeneraciÃ³n de cvereq**
   - Obtiene MAX(cvereq) + 1
   - No se puede especificar manualmente

2. **AsignaciÃ³n de folioreq**
   - folioreq = cvereq
   - Se asigna automÃ¡ticamente

3. **ConversiÃ³n de estatus**
   - 'Vigente' â†’ 'V'
   - 'Cancelado' â†’ 'C'
   - 'Pendiente' â†’ 'P'
   - 'Activo' â†’ '1'
   - 'Inactivo' â†’ '0'
   - Otro â†’ 'V' (default)

4. **CÃ¡lculo de total**
   - total = impuesto + recargos + multa + gastos
   - Se calcula automÃ¡ticamente

5. **Valores por defecto**
   - cveproceso = 'N' (Nuevo)
   - zona = 0
   - subzona = 0
   - fecemi = CURRENT_DATE
   - feccap = CURRENT_DATE
   - capturista = 'SYSTEM'
   - recaud = 1 (si no se especifica)

6. **Campos opcionales con 0**
   - multa_imp = 0
   - multa_ext = 0
   - actualizacion = 0
   - gastos_req = gastos

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USO DESDE VUE.JS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```javascript
// Ejemplo de llamada desde Vue
async function crearRequerimiento() {
  const registro = {
    clave_cuenta: '999888777',
    folio: 12345,
    ejercicio: 2025,
    estatus: 'Vigente',
    impuesto: 1500.50,
    recargos: 150.00,
    multa: 300.00,
    gastos: 50.00
  };

  try {
    const data = await execute('RECAUDADORA_REQTRANS_CREATE', BASE_DB, [
      {
        nombre: 'p_registro',
        tipo: 'json',
        valor: JSON.stringify(registro)
      }
    ]);

    // Parsear respuesta
    const response = typeof data === 'string' ? JSON.parse(data) : data;

    if (response.success) {
      console.log('Registro creado:', response.cvereq);
      alert('Registro creado correctamente');
      // Recargar lista
      buscarGeneral();
    } else {
      console.error('Error:', response.message);
      alert('Error: ' + response.message);
    }
  } catch (e) {
    console.error('Error al crear:', e);
    alert('Error al crear el registro');
  }
}
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CASOS DE USO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Caso 1: Crear requerimiento simple**
- Usuario ingresa cuenta y ejercicio
- Sistema genera ID automÃ¡ticamente
- Se crea con valores por defecto

**Caso 2: Crear requerimiento con importes**
- Usuario ingresa cuenta, ejercicio e importes
- Sistema calcula total automÃ¡ticamente
- Se guarda con desglose completo

**Caso 3: ValidaciÃ³n de duplicado**
- Usuario intenta crear requerimiento que ya existe
- Sistema detecta duplicado (cuenta + aÃ±o)
- Muestra mensaje de error descriptivo

**Caso 4: ValidaciÃ³n de campos**
- Usuario olvida ingresar cuenta
- Sistema valida campo requerido
- Muestra mensaje de error claro

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PRUEBAS REALIZADAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… CreaciÃ³n con campos mÃ­nimos
âœ… CreaciÃ³n con importes completos
âœ… ValidaciÃ³n de duplicado
âœ… ValidaciÃ³n de campo requerido
âœ… GeneraciÃ³n automÃ¡tica de cvereq
âœ… CÃ¡lculo automÃ¡tico de total
âœ… ConversiÃ³n de estatus a vigencia
âœ… AsignaciÃ³n de valores por defecto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

NOTAS IMPORTANTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ **Tabla correcta**
   La funciÃ³n ahora usa public.reqdiftransmision en lugar de
   catastro_gdl.reqdiftransmision.

âš ï¸ **Campo clave_cuenta es requerido**
   La funciÃ³n valida que este campo no estÃ© vacÃ­o ni sea NULL.

âš ï¸ **ValidaciÃ³n de duplicado**
   No se permite crear dos requerimientos para la misma cuenta
   en el mismo aÃ±o (ejercicio).

âš ï¸ **cvereq autogenerado**
   No se puede especificar el cvereq manualmente. Se genera
   automÃ¡ticamente como MAX + 1.

âš ï¸ **Total calculado automÃ¡ticamente**
   No es necesario enviar el campo "total" en el JSON, se
   calcula sumando todos los importes.

âš ï¸ **Formato JSON estricto**
   El parÃ¡metro debe ser un JSON vÃ¡lido. Los nÃºmeros deben ser
   nÃºmeros, no strings.

âš ï¸ **Manejo de errores**
   La funciÃ³n captura todas las excepciones y retorna un JSON
   con success: false y el mensaje de error.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CAMPOS DE LA TABLA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Campos que se insertan automÃ¡ticamente:

| Campo          | Valor automÃ¡tico                  | DescripciÃ³n                    |
|----------------|-----------------------------------|--------------------------------|
| cvereq         | MAX(cvereq) + 1                   | ID Ãºnico autogenerado          |
| recaud         | p_registro->>'recaud' o 1         | RecaudaciÃ³n                    |
| axoreq         | p_registro->>'ejercicio' o aÃ±o    | AÃ±o del requerimiento          |
| folioreq       | cvereq                            | Mismo que cvereq               |
| cveproceso     | 'N'                               | Nuevo                          |
| cvecuenta      | p_registro->>'clave_cuenta'       | Cuenta del contribuyente       |
| foliotransm    | p_registro->>'folio' o 0          | Folio de transmisiÃ³n           |
| impuesto       | p_registro->>'impuesto' o 0       | Importe impuesto               |
| recargos       | p_registro->>'recargos' o 0       | Importe recargos               |
| multa_imp      | 0                                 | Multa impuesto                 |
| multa_ext      | 0                                 | Multa extemporÃ¡nea             |
| actualizacion  | 0                                 | ActualizaciÃ³n                  |
| gastos         | p_registro->>'gastos' o 0         | Gastos de ejecuciÃ³n            |
| multa          | p_registro->>'multa' o 0          | Multa                          |
| gastos_req     | gastos                            | Gastos de requerimiento        |
| total          | suma de todos los importes        | Total a pagar                  |
| zona           | 0                                 | Zona                           |
| subzona        | 0                                 | Subzona                        |
| vigencia       | SegÃºn estatus                     | V/C/P/1/0                      |
| fecemi         | CURRENT_DATE                      | Fecha de emisiÃ³n               |
| feccap         | CURRENT_DATE                      | Fecha de captura               |
| capturista     | 'SYSTEM'                          | Usuario que captura            |

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RESUMEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FunciÃ³n: publico.recaudadora_reqtrans_create(JSON)
Tabla: public.reqdiftransmision
Base de datos: multas_reglamentos

CaracterÃ­sticas:
âœ… ValidaciÃ³n de campos requeridos
âœ… ValidaciÃ³n de duplicados
âœ… GeneraciÃ³n automÃ¡tica de ID
âœ… CÃ¡lculo automÃ¡tico de totales
âœ… Valores por defecto inteligentes
âœ… Manejo de errores completo
âœ… Retorno en formato JSON
âœ… Compatibilidad con Vue.js

Uso:
- Enviar JSON con los datos del requerimiento
- Recibir JSON con resultado (success, message, cvereq)
- Manejar errores de validaciÃ³n apropiadamente
- Actualizar lista despuÃ©s de crear

Pruebas:
- Todas las pruebas pasadas exitosamente
- FunciÃ³n lista para producciÃ³n

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Fin del documento - Generado el 2025-12-18
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
